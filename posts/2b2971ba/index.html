<!DOCTYPE html><html lang="default"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="OAuth的中文名称是开放式授权协议，这个名字大家仔细品，它是一个授权协议，任何实现这个协议的网站都可以在用户同意的条件下给某些在自己这里注册的应用授予对应用户在本网站某些资源的权限，而这个权限一般用token来表示。"><meta property="og:type" content="article"><meta property="og:title" content="OAuth的发展与设计"><meta property="og:url" content="https://sunra.top/posts/2b2971ba/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="OAuth的中文名称是开放式授权协议，这个名字大家仔细品，它是一个授权协议，任何实现这个协议的网站都可以在用户同意的条件下给某些在自己这里注册的应用授予对应用户在本网站某些资源的权限，而这个权限一般用token来表示。"><meta property="og:locale"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586583310/Cloud/微信截图_20200411133437_kt05s5.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586584078/Cloud/微信截图_20200411134737_w5ftzj.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586587044/Cloud/微信截图_20200411143642_a7kkr8.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608117974/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201216192144_wzrlgz.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608118806/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201216193951_hiq7je.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608119884/origin-of-ray/微信截图_20201216195014_gz6sjt.png"><meta property="article:published_time" content="2020-04-11T05:26:14.000Z"><meta property="article:modified_time" content="2023-06-04T11:50:51.056Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="技术分享 使用教程 原理 前端 计算机图形学"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586583310/Cloud/微信截图_20200411133437_kt05s5.png"><link rel="canonical" href="https://sunra.top/posts/2b2971ba/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"default","comments":true,"permalink":"https://sunra.top/posts/2b2971ba/","path":"posts/2b2971ba/","title":"OAuth的发展与设计"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>OAuth的发展与设计 | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E7%9A%84%E4%B8%BE%E4%BE%8B"><span class="nav-number">1.</span> <span class="nav-text">实际应用的举例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E9%99%86%E6%96%B9%E5%BC%8F%E7%9A%84%E5%8F%91%E5%B1%95%E8%BF%87%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">登陆方式的发展过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">用户名密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Session%E5%92%8CCookie"><span class="nav-number">2.2.</span> <span class="nav-text">Session和Cookie</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Token"><span class="nav-number">2.3.</span> <span class="nav-text">Token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSO-%E5%92%8C-OAuth"><span class="nav-number">2.4.</span> <span class="nav-text">SSO 和 OAuth</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E7%9C%8B%E4%B8%80%E4%B8%8BSSO%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%85%B3%E4%BA%8EOAuth%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="nav-number">3.</span> <span class="nav-text">实际看一下SSO过程中关于OAuth的请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A5%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F%E8%AF%B4%E6%98%8E%E4%B8%80%E4%B8%8BOAuth2-0%E8%AE%BE%E8%AE%A1%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%86%E8%8A%82"><span class="nav-number">4.</span> <span class="nav-text">以授权码模式说明一下OAuth2.0设计中的一些细节</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%99%E4%BA%9B%E5%8F%82%E6%95%B0%E9%83%BD%E8%A1%A8%E7%A4%BA%E4%BB%80%E4%B9%88%EF%BC%9A"><span class="nav-number">4.1.</span> <span class="nav-text">这些参数都表示什么：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%BC%80%E5%A7%8B%E5%B0%B1%E8%A6%81%E5%8F%91%E9%80%81%E4%B8%AAredirect-uri%E7%BB%99IDP%EF%BC%9F"><span class="nav-number">4.2.</span> <span class="nav-text">为什么一开始就要发送个redirect_uri给IDP？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%BB%95%E8%BF%99%E4%B9%88%E4%B8%80%E5%A4%A7%E5%9C%88%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A4%9A%E4%B8%80%E6%AD%A5code%E6%8D%A2access-token%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">为什么要绕这么一大圈，为什么要多一步code换access_token？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Secret%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="nav-number">4.4.</span> <span class="nav-text">Secret有什么用？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#State%E5%8F%88%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8%E5%91%A2%EF%BC%9F"><span class="nav-number">4.5.</span> <span class="nav-text">State又有什么用呢？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%80%E5%90%8E%E4%BC%9A%E8%BF%94%E5%9B%9E%E4%B8%A4%E4%B8%AAtoken%EF%BC%9F"><span class="nav-number">4.6.</span> <span class="nav-text">为什么最后会返回两个token？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth2-0%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">OAuth2.0中的其他模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.1.</span> <span class="nav-text">简化模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">密码模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">客户端模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth1-0"><span class="nav-number">6.</span> <span class="nav-text">OAuth1.0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-0a"><span class="nav-number">6.1.</span> <span class="nav-text">1.0a</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">拨开互联网的迷雾</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">267</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <img src="/images/wechat_channel.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="default"><link itemprop="mainEntityOfPage" href="https://sunra.top/posts/2b2971ba/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="拨开互联网的迷雾"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="OAuth的发展与设计 | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> OAuth的发展与设计</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-04-11 13:26:14" itemprop="dateCreated datePublished" datetime="2020-04-11T13:26:14+08:00">2020-04-11</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-06-04 19:50:51" itemprop="dateModified" datetime="2023-06-04T19:50:51+08:00">2023-06-04</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/posts/2b2971ba/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/2b2971ba/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>OAuth的中文名称是开放式授权协议，这个名字大家仔细品，它是一个授权协议，<strong>任何实现这个协议的网站都可以在用户同意的条件下给某些在自己这里注册的应用授予对应用户在本网站某些资源的权限</strong>，而这个权限一般用token来表示。</p><span id="more"></span><h2 id="实际应用的举例"><a href="#实际应用的举例" class="headerlink" title="实际应用的举例"></a>实际应用的举例</h2><p>大家去leetcode登陆的时候，会弹出如下页面</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586583310/Cloud/微信截图_20200411133437_kt05s5.png" alt="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586583310/Cloud/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200411133437_kt05s5.png"></p><p>在这里我们有两个选项，一个是直接注册一个账号，另一个就是选择第三方登陆，比如QQ登陆，这个第三方登陆中就使用了OAuth。</p><p>对于这第二种方式，这里要强调几点：</p><ul><li><strong>你的账号的数量根本没有减少，你还是同时拥有了leetcode以及qq两个账号</strong>，只不过qq提供了OAuth协议，你授权leetcode去获取你在qq的信息，leetcode利用这信息去创建了你在leetcode的账号，你在leetcode的账号也根本不会存储在qq，这就有点类似于实际生活中你在有关机构注册账户时都需要拿着身份证去，这个机构用你的身份证去公安局系统查找你的信息，然后用这些信息创建你在本机构的账户。你给这些机构身份证就类似于一个授权它去公安局操作你的信息的过程。</li><li>OAuth协议只是一个授权协议，而上述的过程叫做<strong>第三方授权登录，登陆这个动作不是OAuth协议中规定的，也就是说仅凭OAuth无法完成授权登录这一套动作</strong>，OAuth也不仅仅是用来做第三方登录的。虽然我们大部分时间用第三方授权登陆讲OAuth，但是要打破这局限思维。</li></ul><h2 id="登陆方式的发展过程"><a href="#登陆方式的发展过程" class="headerlink" title="登陆方式的发展过程"></a>登陆方式的发展过程</h2><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586584078/Cloud/微信截图_20200411134737_w5ftzj.png" alt="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586584078/Cloud/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200411134737_w5ftzj.png"></p><h3 id="用户名密码"><a href="#用户名密码" class="headerlink" title="用户名密码"></a>用户名密码</h3><p>在一开始我们是服务端渲染以及静态页面的时候，我们仅仅通过用户名和密码进行身份验证，这也是所有身份验证的基础，以后的各种认证方式，大部分还是要基于这种方法的。</p><p>这种方法在一开始很管用，网站先给你一个登陆页面，你登录成功就给从服务器返回另外一个页面，你拿到了这个页面就表明你已经登陆过了，而且你的身份信息已经在返回之前写入了页面中，只是你看不到。</p><p>但是这样做<strong>最大的问题就是一旦你将这个页面关掉，你下一次再打开你就要重新登陆</strong>，这样就会有很差的用户体验。于是我们就开始想办法能不能将用户的登录态保存下来呢？于是就产生了第二种方式，Session和Cookie。</p><h3 id="Session和Cookie"><a href="#Session和Cookie" class="headerlink" title="Session和Cookie"></a>Session和Cookie</h3><p>在这种方式中，用户在第一次登陆成功之后就会把用户的信息保存在session中存储在服务器中，然后生成一个sessionId标志该session并将其通过set-cookie头部返回给前端。这样一来，由于浏览器的实现决定，每次发起的同源请求都会自动带上该源之下的cookie，也就带上了sessionId，这样一来每次服务器只需要检查cookie中的sessionId，验证其有效性就可以找到用户信息。</p><p>但是这样又有了一个问题，浏览器是很不可靠的，基本上浏览器知道很有可能全世界都知道了，这里推荐仔细看一下同源策略，这东西没有想象中那么严格，最近我对它又多了几点认知：</p><ul><li>同源策略一般只限制XMLHttpRequest之类的请求，比如Ajax。对于地址栏直接发出的请求是不加限制的，置于对这个请求重定向的请求是否限制还在探索中。</li><li>跨域写操作，如表单提交，重定向等一般是不限制的</li><li>跨域资源嵌入一般是不限制的。</li><li>跨域的读操作一般是不被允许的，但是可以通过上一条进行打破，比如利用script标签跨域加载脚本</li><li>不同域的脚本无法操作dom。</li></ul><p>通过上述这些认知，我们可以发现一个比较关键的事情，<strong>浏览器的同源策略对于src中的直接发起的请求不怎么限制，而且只要是你请求的链接同个域名下的cookie都会被自动带上</strong>。</p><p>这里有个经典的例子，就是如果你去银行网站登录了之后，将sessionid存储在cookie中，在cookie过期之前，你打开了个攻击者的网站，里面有一个img标签，它的src属性是bank.com/tran/1000，也就是转账1000元的意思，由于它是src，所以浏览器会自动发起这个请求，虽然肯定是不会有图片返回，但是请求已经发出了，而且会自动带上未过期的该银行的cookie，因为浏览器看到你请求的地址是该银行，就自动帮你带上了。</p><p>上面这个例子就是比较简单的CSRF攻击。</p><p>上面这个例子的主要目的就是为了说明<strong>cookie是不安全的，即使有同源策略</strong>。</p><p>而且随着分布式系统的发展，如果通过这种方式来存储身份，你势必就要在每个服务器上维护一份身份的副本，而且要保证其一致性。</p><p>基于以上两点原因，我们又在想了，<strong>有没有什么办法可以既能将身份信息丢回给前端，这样每次前端带着身份信息过来，我验证一下是不是我授予他的就好，又能让这种方式比较安全</strong>呢？于是，我们就搞出了一个Token。这也是token的两个特点吧，一个是存储在前端，另一个就是服务器生成的，它一般不存储在cookie中。</p><h3 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h3><p>刚才我们说了Token是服务器生成的我们身份的证明，存储在前端，那我们又怎么保证其安全呢？一种比较古老的做法是如果你的页面是服务端渲染，那就在返回之前在每个需要提交请求的地方插入你的token，这样这个token就可以不存储在cookie中了，而跨域的脚本又无法操作dom也就无法获取你的token。</p><p>但是这样一来貌似又回到了一开始，页面一关闭，token就没了，而且这样消耗比较大。</p><p>另一种方法就是把这个token可以放在http头部中，也就是x-csrf头部。</p><p>还有许多token的使用方式，不是这次的重点，就不详细解释了。</p><h3 id="SSO-和-OAuth"><a href="#SSO-和-OAuth" class="headerlink" title="SSO 和 OAuth"></a>SSO 和 OAuth</h3><p>当我们身份认证的所有问题都得到比较好的解决之后，又出现了一个新的问题，那就是随着应用的增多，我们需要记住越来越多的账号，我们需要一个方法来帮我们记住所有账号或者只记一个账号，第二种方式就是SSO，它有多种实现基础，其中一种就是今天的主题OAuth。</p><p>在聊这个主题之前我们先定义几个关键字：</p><p>User：用户</p><p>User Agent：用户代理，如浏览器</p><p>Consumer：信息消费者，如Leetcode</p><p>Service Provider：分为两个，分别是身份认证提供者（Identity Provider， IDP）,如QQ，以及资源提供者（Resource Provider），不过这二者一般是相同的。</p><p>所以：</p><ul><li>SSO的出现并不是为了解决一些登录上的安全或者流程问题，它是为了帮我们少记一些账号，OAuth只是它一种实现方式的基础。</li><li>OAuth只负责user授权consumer去SP操纵一些属于user的资源，只不过在SSO中是用于在SP获取用户信息之后在consumer创建一个账号，这样下次只要user在SP通过了身份验证就等于在consumer通过了身份验证。</li><li>User在consumer的身份和权限与OAuth没有关系，这是它们二者之间的事情，与OAuth无关，与SSO也无关，他们之间的认证又会退回前三种方式。SP不会关心也不会存储User在consumer的身份或者权限。</li><li>单凭OAuth，是无法完成授权登录整个流程的。</li></ul><h2 id="实际看一下SSO过程中关于OAuth的请求"><a href="#实际看一下SSO过程中关于OAuth的请求" class="headerlink" title="实际看一下SSO过程中关于OAuth的请求"></a>实际看一下SSO过程中关于OAuth的请求</h2><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586587044/Cloud/微信截图_20200411143642_a7kkr8.png" alt="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1586587044/Cloud/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20200411143642_a7kkr8.png"></p><p>这张图是我截取的用qq去登陆leetcode中前端所涉及的请求，它大致分为以下几步：</p><ul><li>去qq认证服务器拉取授权页面，参数中带有一些leetcode服务器生成的一些用于接下来授权请求的参数，只有带上这些参数，才可能通过qq认证服务器的验证并返回授权页面，同时授权页面接下来的请求需要用到这些参数</li><li>选择授权之后会发送第二个请求，请求中包括一些OAuth协议中定义的参数以及qq自身需要的参数。</li><li>第二个请求到达qq之后通过验证，返回一个302，location就是第二个请求参数中的redirect_uri，然后在参数中拼接qq为其生成的code和state。</li><li>浏览器收到302返回后，重新拿出location去发送请求，所以这个location一般是自身后台。</li><li>自身后台收到请求后，拿出code去qq换取token</li></ul><p><strong>OAuth协议就干了这些事情，那现在我们在leetcode有账号了吗？没有</strong>，接下来leetcode拿token去qq换回身份信息后才会进行leetcode账号的创建</p><h2 id="以授权码模式说明一下OAuth2-0设计中的一些细节"><a href="#以授权码模式说明一下OAuth2-0设计中的一些细节" class="headerlink" title="以授权码模式说明一下OAuth2.0设计中的一些细节"></a>以授权码模式说明一下OAuth2.0设计中的一些细节</h2><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608117974/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201216192144_wzrlgz.png" alt></p><p>这里的A请求就是刚才的第一个请求，B就是第二个授权请求，C是B的返回，状态码是302，location就是redirect_uri?code=XXX&amp;state=XXX，浏览器收到后重新请求C的location，请求就到了leetcode后台，后台拿到code之后结合一些参数去qq换回了token。</p><p>这里大家可能会有很多疑问：</p><h3 id="这些参数都表示什么："><a href="#这些参数都表示什么：" class="headerlink" title="这些参数都表示什么："></a>这些参数都表示什么：</h3><p>redirect_uri：consumer在SP申请第三方授权登陆服务时填写的域名，一般是自身服务器的域名。</p><p>client_id：consumer在SP申请第三方授权登陆服务后，SP生成的该consumer的唯一id。</p><p>client_secret：consumer在SP申请第三方授权登陆服务后，SP生成的该consumer的唯一凭证，只有id与secret同时给出才能证明你是consumer</p><p>scope：你要申请的权限，一般都是由SP规定的。</p><p>state：一个随机字符串，consumer自身生成</p><p>code：用户授权后，SP返回给浏览器的code，consumer可以用这个code换token</p><p>access_token：最终目的。</p><h3 id="为什么一开始就要发送个redirect-uri给IDP？"><a href="#为什么一开始就要发送个redirect-uri给IDP？" class="headerlink" title="为什么一开始就要发送个redirect_uri给IDP？"></a>为什么一开始就要发送个redirect_uri给IDP？</h3><p>第一次是为了IDP设置返回地302中的Location，可以不验证是不是consumer设置好的，第二次就是验证这个redirect_uri是不是你当初在IDP这里设置的，与第一次过来的是否一样，这一步必须要验证，因为这一步是最关键的，这一步才会返回token。</p><h3 id="为什么要绕这么一大圈，为什么要多一步code换access-token？"><a href="#为什么要绕这么一大圈，为什么要多一步code换access-token？" class="headerlink" title="为什么要绕这么一大圈，为什么要多一步code换access_token？"></a>为什么要绕这么一大圈，为什么要多一步code换access_token？</h3><p>说到底还是信不过浏览器同志，让他当个工具人，让它帮自己地后台去第三方申请一个授权码，然后把这个授权码给自己的后台，再然后自己的后台用这个code去第三方申请token，完事还不告诉浏览器这个token是什么，自己留下了，也就是说浏览器同志从头到尾都没见过token。</p><h3 id="Secret有什么用？"><a href="#Secret有什么用？" class="headerlink" title="Secret有什么用？"></a>Secret有什么用？</h3><p>原因是IDP不信任何人，就信自己给出去的secret。因为redirect_uri是域名，最终到哪里还是要靠IP地址，如果域名是对的，但是域名被攻击者指向了自己的IP，攻击者就会收到token。怎么修改这个DNS指向就涉及DNS污染了，因为DNS会层层缓存，但是又有时间，如果你一直广播告诉路由器或者主机我是leetcode，我是leetcode，时间长了你在这一片局域网中就被认为是leetcode了。但是如果有了secret，就算你带着code过来了IDP，没有我给你的secret，IDP也不会给出token。所以client_id表明自己是谁，只有给了client_secret，IDP才会相信你说的话，并给你token，所以这个secret非常重要，我们的后台又不会相信浏览器同志了，所以我们的浏览器同志从头到尾也没摸过secret。</p><h3 id="State又有什么用呢？"><a href="#State又有什么用呢？" class="headerlink" title="State又有什么用呢？"></a>State又有什么用呢？</h3><p>类似于防御CSRF，保证请求设备的一致性，不过不像CSRF是伪造受害者的请求，而是让受害者登录自己的账号，如果受害者在里面存个比特币账号岂不美哉？具体实现就是攻击者登录之后，正常申请，但是到了IDP返回302以后把请求拦下，不让浏览器发送请求给自己的后台，然后把这个带code的请求链接给受害人，受害人点进去之后就可以拿到access_token成功登录，如果不注意这个账号是不是自己的就上传敏感信息，就很happy。如果有了state，不同的设备我后台都生成一个随机的字符串给前端，攻击者就算把请求发给受害者，他也不知道受害者设备中的state，后台一看你的state和刚开始说好的不一样，就会直接把这个请求丢掉，当然硬要说攻击者把你的state从庞大的互联网的某个请求中给偷到了，那也是绝了，这就属于定点爆破了，就是要搞你，那这个人多半已经混在你的身边了。</p><h3 id="为什么最后会返回两个token？"><a href="#为什么最后会返回两个token？" class="headerlink" title="为什么最后会返回两个token？"></a>为什么最后会返回两个token？</h3><p>因为一个代表你是谁，一个代表你能做什么，你能做的事情随时可以被管理员改变，但是你是谁是固定的，而且一般access_token过期时间都比较短，如果我用着用着就过期了，总不能让用户重新登陆吧，那岂不是回到了起点？</p><h2 id="OAuth2-0中的其他模式"><a href="#OAuth2-0中的其他模式" class="headerlink" title="OAuth2.0中的其他模式"></a>OAuth2.0中的其他模式</h2><h3 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h3><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608118806/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201216193951_hiq7je.png" alt=" "></p><p>这种方式与授权码模式不同，它适用于没有服务端的情况，比如手机应用，前端直接就从SP拿到了token，但是要注意，这个token并不是像授权码模式中的code一样，拼在“？”后面，而是“#”后面，所以可以有效降低泄密的危险。</p><h3 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h3><p>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向”服务商提供商”索要授权。</p><p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p><h3 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h3><p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向”服务提供商”进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求”服务提供商”提供服务，其实不存在授权问题。</p><h2 id="OAuth1-0"><a href="#OAuth1-0" class="headerlink" title="OAuth1.0"></a>OAuth1.0</h2><p>在简单介绍一下1.0以及它为什么发展出了2.0</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608119884/origin-of-ray/微信截图_20201216195014_gz6sjt.png" alt="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1608119884/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20201216195014_gz6sjt.png"></p><p>最大的不同就是多了AB两步，也就是1.0会先去SP申请一个未认证状态的request_token（可以类比为2.0的code），接下来的目的是为了把这个request_token变为认证状态，然后就可以拿这个request_token去换access_token了。</p><p>多了这一步就会出现问题，比如<a href="https://sunra.top/posts/44fbc7d1/">会话固定</a></p><p>还有就是对于手机或者客户端应用来说，重定向这一步是无法实现的，只能丢出一个连接来，让用户自己打开浏览器粘贴进去进行接下来的步骤。这样就会给攻击者很大的机会。</p><p>由此可以看出，1.0版本安全有很大的问题，而且对于非web应用来说体验比较差，所以就推出了2.0,。</p><p>比如2.0的简化模式就是为了适配客户端应用的，有兴趣的可以自己去了解一下。</p><h3 id="1-0a"><a href="#1-0a" class="headerlink" title="1.0a"></a>1.0a</h3><p>为了修复1.0中的安全问题，又提出了1.0a，他主要做了如下改变：</p><ul><li><p>Consumer申请Request Token时，必须传递<strong>oauth</strong>_callback，而Consumer申请Access Token时，不需要传递<strong>oauth</strong>_callback。通过前置<strong>oauth</strong>_callback的传递时机，让<strong>oauth</strong>_callback参与签名，从而避免攻击者假冒<strong>oauth</strong>_callback。</p></li><li><p>Service Provider获得User授权后重定向User到Consumer时，返回<strong>oauth</strong>_verifier，它会被用在Consumer申请Access Token的过程中。攻击者无法猜测它的值。</p></li></ul><p>参考资料：</p><p><a href="https://sunra.top/posts/46cef286/">https://sunra.top/2019/11/16/OAuth%20and%20OIDC/</a> ：OAuth，OIDC简介</p><p><a href="https://sunra.top/posts/74ee5df7/">https://sunra.top/posts/74ee5df7/</a> ：路由协议</p><p><a href="https://sunra.top/posts/dfdf7442/">https://sunra.top/posts/dfdf7442/</a> ：ARP原理与防御</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/0db71eb445c8">https://www.jianshu.com/p/0db71eb445c8</a> ：OAuth认证流程举例</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.chrisyue.com/security-issue-about-oauth-2-0-you-should-know.html">https://www.chrisyue.com/security-issue-about-oauth-2-0-you-should-know.html</a> ：OAuth2.0中的安全考虑</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/linianhui/p/openid-connect-core.html">https://www.cnblogs.com/linianhui/p/openid-connect-core.html</a> ：OIDC文档</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.com/question/19851243">https://www.zhihu.com/question/19851243</a> ：OAuth1.0与2.0区别</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.azure.cn/zh-cn/active-directory/azuread-dev/v1-protocols-openid-connect-code">https://docs.azure.cn/zh-cn/active-directory/azuread-dev/v1-protocols-openid-connect-code</a> ：OIDC + AAD</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.sciencedirect.com/science/article/pii/S2215098617316750">https://www.sciencedirect.com/science/article/pii/S2215098617316750</a> ：云服务中面临的安全问题</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy">https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy</a> ：同源策略</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/posts/2b2971ba/" title="OAuth的发展与设计">https://sunra.top/posts/2b2971ba/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="/images/wechat_channel.png"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/9fba193f/" rel="prev" title="双指针算法"><i class="fa fa-chevron-left"></i> 双指针算法</a></div><div class="post-nav-item"> <a href="/posts/4f2bae2e/" rel="next" title="TCP协议简介">TCP协议简介<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/posts/2b2971ba/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>