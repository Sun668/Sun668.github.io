<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="为了保证数据的可靠，我们一般会对数据醉一次主从复制，最近我也进行了一点实践，踩了几个坑，在这里总结下。"><meta property="og:type" content="article"><meta property="og:title" content="如何在两台Centos机器上部署主从复制的mysql"><meta property="og:url" content="https://sunra.top/posts/547eb08f/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="为了保证数据的可靠，我们一般会对数据醉一次主从复制，最近我也进行了一点实践，踩了几个坑，在这里总结下。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-07-22T06:16:34.000Z"><meta property="article:modified_time" content="2025-01-06T09:30:06.420Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="技术分享 使用教程 原理 前端 计算机图形学"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/posts/547eb08f/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sunra.top/posts/547eb08f/","path":"posts/547eb08f/","title":"如何在两台Centos机器上部署主从复制的mysql"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>如何在两台Centos机器上部署主从复制的mysql | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">主从备份的流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8657%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8D%87%E7%BA%A7"><span class="nav-number">2.1.</span> <span class="nav-text">将5.7的数据库升级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">2.1.1.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.2.</span> <span class="nav-text">升级流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tips"><span class="nav-number">2.1.3.</span> <span class="nav-text">Tips</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%B3%95%E7%94%A8systemctl%E6%9D%A5%E6%8E%A7%E5%88%B6mysql%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">如果没法用systemctl来控制mysql怎么办</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD"><span class="nav-number">2.2.</span> <span class="nav-text">设置主从备份</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%88%AB%E5%9C%A8%E4%B8%A4%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8F%AF%E4%BB%A5%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE%E7%9A%84%E8%B4%A6%E5%8F%B7"><span class="nav-number">2.2.1.</span> <span class="nav-text">分别在两个数据库上创建一个可以远程访问的账号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.2.</span> <span class="nav-text">认主流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BB%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">主服务数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">从服务器设置：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%A4%E4%B8%BB"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">配置从服务器认主</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">一起探索互联网的秘密</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">324</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sunra.top/posts/547eb08f/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="一起探索互联网的秘密"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="如何在两台Centos机器上部署主从复制的mysql | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 如何在两台Centos机器上部署主从复制的mysql</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-07-22 14:16:34" itemprop="dateCreated datePublished" datetime="2023-07-22T14:16:34+08:00">2023-07-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-01-06 17:30:06" itemprop="dateModified" datetime="2025-01-06T17:30:06+08:00">2025-01-06</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline：</span><a title="waline" href="/posts/547eb08f/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/547eb08f/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>为了保证数据的可靠，我们一般会对数据醉一次主从复制，最近我也进行了一点实践，踩了几个坑，在这里总结下。</p><span id="more"></span><h1 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h1><p>我自身有两台centos的云服务器，一台已经装过mysql了，不过是5.7版本，一台是我刚装的mysql，是8.0版本。</p><h1 id="主从备份的流程"><a class="markdownIt-Anchor" href="#主从备份的流程"></a> 主从备份的流程</h1><h2 id="将57的数据库升级"><a class="markdownIt-Anchor" href="#将57的数据库升级"></a> 将5.7的数据库升级</h2><p>因为我是打算用5.7所在的服务器作为从库的服务器，而mysql的主从备份有要求，从库的版本不能低于主库的，所以第一步就是升级</p><h3 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h3><p>首先，我们要大概了解下MySQL5.7和8.0有哪些不同，参考官方文档和其他网友文章，概括总结出MySQL8.0以下几点新特性：</p><ul><li>默认字符集由latin1变为utf8mb4。</li><li>MyISAM系统表全部换成InnoDB表。</li><li>JSON特性增强。</li><li>支持不可见索引，支持直方图。</li><li>sql_mode参数默认值变化。</li><li>默认密码策略变更。</li><li>新增角色管理。</li><li>支持窗口函数，支持Hash join。</li></ul><p>根据版本变化及官方升级教程，列举出以下几点注意事项：</p><ul><li>注意字符集设置。为了避免新旧对象字符集不一致的情况，可以在配置文件将字符集和校验规则设置为旧版本的字符集和比较规则。</li><li>密码认证插件变更。为了避免连接问题，可以仍采用5.7的mysql_native_password认证插件。</li><li>sql_mode支持问题。8.0版本sql_mode不支持NO_AUTO_CREATE_USER，要避免配置的sql_mode中带有NO_AUTO_CREATE_USER。</li><li>是否需要手动升级系统表。在MySQL 8.0.16版本之前，需要手动的执行mysql_upgrade来完成该步骤的升级，在MySQL 8.0.16版本及之后是由mysqld来完成该步骤的升级。</li></ul><h3 id="升级流程"><a class="markdownIt-Anchor" href="#升级流程"></a> 升级流程</h3><p>官网下载对应版本的tar包，可通过wget下载或者本地下载后上传。</p><blockquote><p>下载地址：<br> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://downloads.mysql.com/archives/community/">https://downloads.mysql.com/archives/community/</a><br> 选择mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz<br> 注意，如果你下载速度很慢，可以考虑使用淘宝的镜像地址：<a target="_blank" rel="external nofollow noopener noreferrer" href="https://mirrors.aliyun.com/mysql">https://mirrors.aliyun.com/mysql</a></p></blockquote><p>行以下步骤解压tar包：</p><ol><li><p>安装包上传至原安装包目录下 我的是/usr/local/<br> cd /usr/local/</p></li><li><p>解压安装包<br> xz -d mysql-8.0.19-linux-glibc2.12-x86_64.tar.xz<br> tar -xvf mysql-8.0.19-linux-glibc2.12-x86_64.tar</p></li><li><p>文件夹重命名为mysql8<br> mv mysql-8.0.19-linux-glibc2.12-x86_64 mysql8</p></li><li><p>更改文件夹所属<br> chown -R mysql.mysql /usr/local/mysql8/</p></li><li><p>更改配置文件my.cnf</p></li></ol><p>因5.7版本与8.0版本参数有所不同，为了能顺利升级，我们需要更改部分配置参数。主要注意sql_mode、basedir、密码认证插件及字符集设置，其他参数最好还是按照原5.7的来，不需要做调整。下面展示下更改后的配置文件：</p><blockquote><p>最后几个for8.0的参数要格外注意</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">mysqld</span>]</span><br><span class="line"><span class="string">user</span> <span class="string">=</span> <span class="string">mysql</span>        </span><br><span class="line"><span class="string">datadir</span> <span class="string">=</span> <span class="string">/data/mysql/data</span>  </span><br><span class="line"><span class="string">port</span> <span class="string">=</span> <span class="number">3306</span>               </span><br><span class="line"></span><br><span class="line"><span class="string">socket</span> <span class="string">=</span> <span class="string">/data/mysql/tmp/mysql.sock</span></span><br><span class="line"><span class="string">pid-file</span>  <span class="string">=</span> <span class="string">/data/mysql/tmp/mysqld.pid</span></span><br><span class="line"><span class="string">tmpdir</span> <span class="string">=</span> <span class="string">/data/mysql/tmp</span>    </span><br><span class="line"><span class="string">skip_name_resolve</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">max_connections</span> <span class="string">=</span> <span class="number">2000</span></span><br><span class="line"><span class="string">group_concat_max_len</span> <span class="string">=</span> <span class="number">1024000</span></span><br><span class="line"><span class="string">lower_case_table_names</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">log_timestamps=SYSTEM</span></span><br><span class="line"><span class="string">max_allowed_packet</span> <span class="string">=</span> <span class="string">32M</span></span><br><span class="line"><span class="string">binlog_cache_size</span> <span class="string">=</span> <span class="string">4M</span></span><br><span class="line"><span class="string">sort_buffer_size</span> <span class="string">=</span> <span class="string">2M</span></span><br><span class="line"><span class="string">read_buffer_size</span> <span class="string">=</span> <span class="string">4M</span></span><br><span class="line"><span class="string">join_buffer_size</span> <span class="string">=</span> <span class="string">4M</span></span><br><span class="line"><span class="string">tmp_table_size</span> <span class="string">=</span> <span class="string">96M</span></span><br><span class="line"><span class="string">max_heap_table_size</span> <span class="string">=</span> <span class="string">96M</span></span><br><span class="line"><span class="string">max_length_for_sort_data</span> <span class="string">=</span> <span class="number">8096</span></span><br><span class="line"><span class="string">default_time_zone</span> <span class="string">=</span> <span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#logs</span></span><br><span class="line"><span class="string">server-id</span> <span class="string">=</span> <span class="number">1003306</span></span><br><span class="line"><span class="string">log-error</span> <span class="string">=</span> <span class="string">/data/mysql/logs/error.log</span></span><br><span class="line"><span class="string">slow_query_log</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">slow_query_log_file</span> <span class="string">=</span> <span class="string">/data/mysql/logs/slow.log</span></span><br><span class="line"><span class="string">long_query_time</span> <span class="string">=</span> <span class="number">3</span></span><br><span class="line"><span class="string">log-bin</span> <span class="string">=</span> <span class="string">/data/mysql/logs/binlog</span></span><br><span class="line"><span class="string">binlog_format</span> <span class="string">=</span> <span class="string">row</span></span><br><span class="line"><span class="string">log_bin_trust_function_creators</span> <span class="string">=</span> <span class="number">1</span></span><br><span class="line"><span class="string">gtid_mode</span> <span class="string">=</span> <span class="string">ON</span></span><br><span class="line"><span class="string">enforce_gtid_consistency</span> <span class="string">=</span> <span class="string">ON</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#for8.0</span></span><br><span class="line"><span class="string">sql_mode</span> <span class="string">=</span> <span class="string">STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span></span><br><span class="line"><span class="string">character-set-server</span> <span class="string">=</span> <span class="string">utf8</span></span><br><span class="line"><span class="string">collation_server</span> <span class="string">=</span> <span class="string">utf8_general_ci</span></span><br><span class="line"><span class="string">basedir</span> <span class="string">=</span> <span class="string">/usr/local/mysql8</span></span><br><span class="line"><span class="string">skip_ssl</span></span><br><span class="line"><span class="string">default_authentication_plugin=mysql_native_password</span></span><br></pre></td></tr></table></figure><ol start="6"><li>执行升级动作</li></ol><p>所有前置工作准备好后就可以开始正式升级了，不过升级前还是建议先全库备份下。万事俱备后，按照如下指示进行正式升级。</p><p>进入原5.7 mysql命令行 正确关闭数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> version();</span></span><br><span class="line">+------------+</span><br><span class="line">| version()  |</span><br><span class="line">+------------+</span><br><span class="line">| 5.7.23-log |</span><br><span class="line">+------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="string">&#x27;innodb_fast_shutdown&#x27;</span>;</span></span><br><span class="line">+----------------------+-------+</span><br><span class="line">| Variable_name        | Value |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">| innodb_fast_shutdown | 1     |</span><br><span class="line">+----------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">确保数据都刷到硬盘上，更改成0</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">set</span> global innodb_fast_shutdown=0;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">shutdown;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="built_in">exit</span></span></span><br><span class="line">Bye</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出至终端 用mysql8.0.19客户端直接启动</span></span><br><span class="line">[root@centos ~]# /usr/local/mysql8/bin/mysqld_safe --defaults-file=/etc/my.cnf --user=mysql &amp; </span><br><span class="line">[1] 23333</span><br><span class="line">[root@centos ~]# 2020-05-20T07:07:02.337626Z mysqld_safe Logging to &#x27;/data/mysql/logs/error.log&#x27;.</span><br><span class="line">2020-05-20T07:07:02.366244Z mysqld_safe Starting mysqld daemon with databases from /data/mysql/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可观察下错误日志看是否报错 然后重新登录测试</span></span><br><span class="line">[root@centos ~]# mysql -uroot -p123456 </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 17</span><br><span class="line">Server version: 8.0.19 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> version();</span></span><br><span class="line">+-----------+</span><br><span class="line">| version() |</span><br><span class="line">+-----------+</span><br><span class="line">| 8.0.19    |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><ol start="7"><li>修改环境变量</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">因basedir由/usr/local/mysql变成了/usr/local/mysql8，故相关环境变量推荐修改下。可按照以下步骤来操作验证：</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改mysql服务启动项配置</span></span><br><span class="line">vi /etc/init.d/mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改basedir目录</span></span><br><span class="line">basedir=/usr/local/mysql8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改PATH变量</span></span><br><span class="line">vi /etc/profile </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将PATH中的/usr/local/mysql/bin改为/usr/local/mysql8/bin</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生效验证</span></span><br><span class="line">[root@centos ~]# source /etc/profile</span><br><span class="line">[root@centos ~]# which mysql</span><br><span class="line">/usr/local/mysql8/bin/mysql</span><br><span class="line">[root@centos ~]# mysql -V</span><br><span class="line">mysql  Ver 8.0.19 for linux-glibc2.12 on x86_64 (MySQL Community Server - GPL)</span><br></pre></td></tr></table></figure><h3 id="tips"><a class="markdownIt-Anchor" href="#tips"></a> Tips</h3><h4 id="如果没法用systemctl来控制mysql怎么办"><a class="markdownIt-Anchor" href="#如果没法用systemctl来控制mysql怎么办"></a> 如果没法用systemctl来控制mysql怎么办</h4><p>操作流程：</p><p>1.进入/etc/systemd/system</p><p>cd /etc/systemd/system</p><p>2.创建mysql.service</p><p>vi mysql.service</p><p>3.mysql.service中添加配置信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/mysql8/bin/mysqld_safe --defaults-file=/etc/my.cnf --datadir=/usr/local/mysql/data</span><br><span class="line">ExecStop=/usr/local/mysql8/bin/mysqladmin --defaults-file=/etc/my.cnf shutdown</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>注意，这里的路径要改成你自己的实际路径</p><h2 id="设置主从备份"><a class="markdownIt-Anchor" href="#设置主从备份"></a> 设置主从备份</h2><h3 id="分别在两个数据库上创建一个可以远程访问的账号"><a class="markdownIt-Anchor" href="#分别在两个数据库上创建一个可以远程访问的账号"></a> 分别在两个数据库上创建一个可以远程访问的账号</h3><h3 id="认主流程"><a class="markdownIt-Anchor" href="#认主流程"></a> 认主流程</h3><h4 id="主服务数据库"><a class="markdownIt-Anchor" href="#主服务数据库"></a> 主服务数据库</h4><ol><li>登陆到主服务器的mysql，并执行如下语句创建用户，授予权限：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sql复制代码CREATE USER &#x27;slave&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO slave@&quot;%&quot; IDENTIFIED BY &quot;123456&quot;;</span><br></pre></td></tr></table></figure><p>修改my.cnf配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log-bin=mysql-bin</span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure><p>说明：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">log-bin:开启二进制日志，该日志是在事务提交时写日志文件的。默认大小是1G，后面加001,002这样的后缀顺加。</span><br><span class="line"></span><br><span class="line">server-id，唯一标识主机，mysql主从每个mysql实例配置都不一样就行。这个值默认是0，如果是0，主服务器拒绝任何从服务器的连接。</span><br><span class="line"></span><br><span class="line">其他配置（不是必须配置的）：</span><br><span class="line"></span><br><span class="line">1、binlog-do-db=db_001（主数据库配置）       #指定mysql的binlog日志记录哪个db，配置需要同步的数据库，可以配置多个，如果没有此配置项则同步全部。</span><br><span class="line"></span><br><span class="line">2、binlog-ignore-db=mysql（主数据库配置）    #配置不同步的数据库，可以配置多个。</span><br><span class="line"></span><br><span class="line">3、binlog_format = mixed     #配置binlog的格式</span><br><span class="line"></span><br><span class="line">4、read-only = 0                   #配置是否只读  0代表不只读，1代表只读</span><br><span class="line"></span><br><span class="line">5、auto-increament-increment = 10    #用于设定双主情况下自增列的ID冲突使用的，主要用来设置自增步长</span><br><span class="line"></span><br><span class="line">6、auto-increment-offset = 1               #表示这台服务器的序号，从1开始，不超过auto-increament-increment</span><br></pre></td></tr></table></figure><p>重启数据库</p><h4 id="从服务器设置"><a class="markdownIt-Anchor" href="#从服务器设置"></a> 从服务器设置：</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server-id=2</span><br><span class="line">replicate-do-db=test</span><br><span class="line">skip-slave-start=true</span><br></pre></td></tr></table></figure><p>重启数据库</p><h4 id="配置从服务器认主"><a class="markdownIt-Anchor" href="#配置从服务器认主"></a> 配置从服务器认主</h4><p>获取binlog的信息<br> 我们先到主（master）服务器上获取binlog的信息，在mysql的命令界面输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure><p>这里展示的就是我们当前主服务器使用的binlog的文件名，其中position是文件中偏移量，我们之后配置slave需要用到这些信息，这个文件在每次服务器状态变化后都不同<br> 进入最关键的一步了，在进入从服务器mysql操作界面后，输入如下指令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stop slave;          //先停步slave服务线程，这个是很重要的，如果不这样做会造成以下操作不成功，第一次设计主从的话忽略。</span><br><span class="line"></span><br><span class="line">change master to </span><br><span class="line">master_host=&#x27;192.0.0.131&#x27;,</span><br><span class="line">master_user=&#x27;slave&#x27;,</span><br><span class="line">master_password=&#x27;123456&#x27;,</span><br><span class="line">master_log_file=&#x27;mysql-bin.000002&#x27;, </span><br><span class="line">master_log_pos=1472;</span><br></pre></td></tr></table></figure><p>这里user和password就是我们第一步在主服务器上创建的用户名和密码，然后MASTER_LOG_FILE 就是我们上一步查看到的master在使用的binlog文件（这个文件在每次主服务器状态变化后都不同），MASTER_LOG_POS   就是binlog的偏移量，用于同步扫描使用。master_log_file对应File, master_log_pos对应Position。Mysql 5.x以上版本已经不支持在配置文件中指定主服务器相关选项。<br> 执行完抛警告的话没关系，没有异常就可以。<br> 开启从服务器slave线程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看（Slave）状态</span></span><br><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Ray Sun</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://sunra.top/posts/547eb08f/" title="如何在两台Centos机器上部署主从复制的mysql">https://sunra.top/posts/547eb08f/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/ad8a980c/" rel="prev" title="用JS实现一个3D模型渲染器"><i class="fa fa-chevron-left"></i> 用JS实现一个3D模型渲染器</a></div><div class="post-nav-item"> <a href="/posts/eea95eb1/" rel="next" title="技术人的管理方法论（七）—— 管理沟通上篇">技术人的管理方法论（七）—— 管理沟通上篇<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/posts/547eb08f/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>