<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="ECS 架构简单来说就是用实体来组合组件，用组件来保存数据，用系统来进行运算。单一的实体没有任何意义，只有在组合组件之后这个实体才有意义。组件只能用于保存数据，不能自己进行任何的运算。系统只负责运算，不会持久化保存任何数据。这样就把数据和逻辑分离开来，通过组合的方式实现特定的功能，实现数据和逻辑的解耦，以及逻辑与逻辑之间的解耦。"><meta property="og:type" content="article"><meta property="og:title" content="Eva框架的ECS架构解析"><meta property="og:url" content="https://sunra.top/posts/f0899875/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="ECS 架构简单来说就是用实体来组合组件，用组件来保存数据，用系统来进行运算。单一的实体没有任何意义，只有在组合组件之后这个实体才有意义。组件只能用于保存数据，不能自己进行任何的运算。系统只负责运算，不会持久化保存任何数据。这样就把数据和逻辑分离开来，通过组合的方式实现特定的功能，实现数据和逻辑的解耦，以及逻辑与逻辑之间的解耦。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/112356814/1731653458317-2fc4377d-aa57-4372-90c6-c9efb7c91b35.jpeg"><meta property="article:published_time" content="2024-11-15T10:27:39.000Z"><meta property="article:modified_time" content="2025-09-10T13:58:23.442Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="技术分享 使用教程 原理 前端 计算机图形学"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/112356814/1731653458317-2fc4377d-aa57-4372-90c6-c9efb7c91b35.jpeg"><link rel="canonical" href="https://sunra.top/posts/f0899875/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sunra.top/posts/f0899875/","path":"posts/f0899875/","title":"Eva框架的ECS架构解析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Eva框架的ECS架构解析 | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ecs-%E6%9E%B6%E6%9E%84entity-component-system%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">ECS 架构（Entity - Component - System）简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ecs-%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">1.2.</span> <span class="nav-text">ECS 架构的优点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-number">2.</span> <span class="nav-text">架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eva%E7%9A%84ecs%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">Eva的ECS实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ticker"><span class="nav-number">3.1.</span> <span class="nav-text">Ticker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#entitygameobject"><span class="nav-number">3.2.</span> <span class="nav-text">Entity&#x2F;GameObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#component"><span class="nav-number">3.3.</span> <span class="nav-text">Component</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#system"><span class="nav-number">3.4.</span> <span class="nav-text">System</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#game"><span class="nav-number">3.5.</span> <span class="nav-text">Game</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%94%A8%E9%80%94"><span class="nav-number">4.</span> <span class="nav-text">其他用途</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">一起探索互联网的秘密</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">333</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sunra.top/posts/f0899875/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="一起探索互联网的秘密"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Eva框架的ECS架构解析 | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Eva框架的ECS架构解析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-11-15 18:27:39" itemprop="dateCreated datePublished" datetime="2024-11-15T18:27:39+08:00">2024-11-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-09-10 21:58:23" itemprop="dateModified" datetime="2025-09-10T21:58:23+08:00">2025-09-10</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline：</span><a title="waline" href="/posts/f0899875/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/posts/f0899875/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>ECS 架构简单来说就是用实体来组合组件，用组件来保存数据，用系统来进行运算。单一的实体没有任何意义，只有在组合组件之后这个实体才有意义。组件只能用于保存数据，不能自己进行任何的运算。系统只负责运算，不会持久化保存任何数据。这样就把数据和逻辑分离开来，通过组合的方式实现特定的功能，实现数据和逻辑的解耦，以及逻辑与逻辑之间的解耦。</p><span id="more"></span><h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2><h3 id="ecs-架构entity-component-system简介"><a class="markdownIt-Anchor" href="#ecs-架构entity-component-system简介"></a> ECS 架构（Entity - Component - System）简介</h3><ul><li><strong>Entity（实体）</strong><ul><li>实体是游戏对象或者模拟世界中的一个对象。它可以是一个角色、一个道具、一个建筑等。例如在一个角色扮演游戏中，玩家角色、怪物、宝箱等都是实体。实体本身没有太多的行为和属性定义，它主要是一个 “容器”，用来挂载各种组件。</li><li>实体通常通过一个唯一的标识符来进行区分，这样在系统处理大量实体时可以准确地定位和操作特定的实体。</li></ul></li><li><strong>Component（组件）</strong><ul><li>组件是用来存储数据的。比如位置组件可以存储实体在三维空间中的坐标（x,y,z）；速度组件可以存储实体的移动速度大小和方向；渲染组件可以存储实体的外观信息，如模型、纹理等。</li><li>一个实体可以挂载多个组件。例如一个游戏中的汽车实体，它可能挂载有位置组件（用于记录汽车在场景中的位置）、速度组件（用于控制汽车的行驶速度）、模型组件（用于渲染汽车的外观）、碰撞组件（用于检测汽车与其他物体的碰撞）等。</li></ul></li><li><strong>System（系统）</strong><ul><li>系统负责处理组件中的数据，实现游戏的逻辑。例如，一个移动系统会读取实体的速度组件和位置组件，根据速度和时间间隔来更新位置组件中的坐标，从而实现实体的移动。</li><li>渲染系统会读取实体的渲染组件，将实体的模型和纹理等信息绘制到屏幕上。系统通常是在游戏的主循环中被调用，按照一定的顺序处理所有相关的实体和组件。</li></ul></li></ul><h3 id="ecs-架构的优点"><a class="markdownIt-Anchor" href="#ecs-架构的优点"></a> ECS 架构的优点</h3><ul><li><strong>高度解耦</strong><ul><li><strong>组件与实体解耦</strong>：实体只作为组件的容器，组件之间相互独立。这样在开发过程中，可以方便地添加、删除和修改组件，而不会对实体本身的结构产生太大影响。例如，要给一个游戏角色添加一个新的技能，只需要添加一个技能组件到该角色实体上，而不需要修改角色实体的其他部分。</li><li><strong>系统与组件解耦</strong>：系统只关心它所处理的组件类型，而不依赖于具体的实体。一个系统可以处理所有挂载了特定类型组件的实体。比如，移动系统只需要处理挂载了速度组件和位置组件的实体，不管这个实体是玩家角色、怪物还是道具。这种解耦方式使得代码的可维护性和可扩展性大大提高。</li></ul></li><li><strong>性能优化优势</strong><ul><li><strong>数据局部性好</strong>：由于相同类型的组件数据存储在一起，在系统处理这些数据时，可以利用缓存的高效性。例如，在处理位置组件时，由于所有位置组件的数据在内存中是连续存储的，CPU 可以更快地读取和处理这些数据，减少了内存访问的开销。</li><li><strong>并行处理能力强</strong>：系统之间相对独立，在多核处理器环境下，可以将不同的系统分配到不同的核心上进行并行处理。例如，渲染系统可以在一个核心上处理实体的渲染，同时物理系统可以在另一个核心上处理实体的碰撞检测等物理行为，从而提高了游戏的整体性能。</li></ul></li><li><strong>代码复用性高</strong><ul><li>组件和系统都可以被复用。一旦开发了一个通用的组件，如基本的物理碰撞组件，就可以在多个不同的实体上使用。同样，一个系统，如简单的 AI 行为系统，也可以被应用到各种不同类型的实体上，只要这些实体挂载了该系统所需的组件。</li></ul></li></ul><h2 id="架构图"><a class="markdownIt-Anchor" href="#架构图"></a> 架构图</h2><p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/112356814/1731653458317-2fc4377d-aa57-4372-90c6-c9efb7c91b35.jpeg" alt="画板"></p><p>简单来说，就是Ticker会在每一帧调用每个system的更新函数，每个system的更新函数只会执行指定的component的更新逻辑</p><h2 id="eva的ecs实现"><a class="markdownIt-Anchor" href="#eva的ecs实现"></a> Eva的ECS实现</h2><p>Eva的ECS实现和正统的不太一样</p><p>Eva是自己实现的tikcer，通过requestFrameIdleCallback，然后把pixi的ticker停掉了</p><p>每次ticker就会遍历所有system的update和lateUpdate</p><p>每次ticker也会调用gameObjectLoop，调用所有gameObject的所有component的update方法</p><h3 id="ticker"><a class="markdownIt-Anchor" href="#ticker"></a> Ticker</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../core/Component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Timeline</span> <span class="keyword">from</span> <span class="string">&#x27;../timeline/index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TickerOptions</span> &#123;</span><br><span class="line">  <span class="attr">autoStart</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">frameRate</span>?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Default Ticker Options */</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaultOptions</span>: <span class="title class_">Partial</span>&lt;<span class="title class_">TickerOptions</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">autoStart</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">frameRate</span>: <span class="number">60</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Timeline tool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ticker</span> &#123;</span><br><span class="line">  <span class="comment">/** Whether or not ticker should auto start */</span></span><br><span class="line">  <span class="attr">autoStart</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** FPS, The number of times that raf method is called per second */</span></span><br><span class="line">  <span class="attr">frameRate</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Global Timeline **/</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">timeline</span>: <span class="title class_">Timeline</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Time between two frame */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_frameDuration</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Ticker is a function will called in each raf */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_tickers</span>: <span class="title class_">Set</span>&lt;<span class="built_in">unknown</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** raf handle id */</span></span><br><span class="line">  <span class="attr">_requestId</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Last frame render time */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_lastFrameTime</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Frame count since from ticker beigning */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_frameCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// private _activeWithPause: boolean;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Main ticker method handle */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_ticker</span>: <span class="function">(<span class="params"><span class="attr">time</span>?: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Represents the status of the Ticker, If ticker has started, the value is true */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_started</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">autoStart</span> - auto start game</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">frameRate</span> - game frame rate</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">options</span>?: <span class="title class_">TickerOptions</span></span>) &#123;</span><br><span class="line">    options = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, defaultOptions, options);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_frameCount</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_frameDuration</span> = <span class="number">1000</span> / options.<span class="property">frameRate</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">autoStart</span> = options.<span class="property">autoStart</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">frameRate</span> = options.<span class="property">frameRate</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeline</span> = <span class="keyword">new</span> <span class="title class_">Timeline</span>(&#123; <span class="attr">originTime</span>: <span class="number">0</span>, <span class="attr">playbackRate</span>: <span class="number">1.0</span> &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_lastFrameTime</span> = <span class="variable language_">this</span>.<span class="property">timeline</span>.<span class="property">currentTime</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_tickers</span> = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_requestId</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_ticker</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_started</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_requestId</span> = <span class="title function_">requestAnimationFrame</span>(<span class="variable language_">this</span>.<span class="property">_ticker</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">autoStart</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Main loop, all _tickers will called in this method */</span></span><br><span class="line">  <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentTime = <span class="variable language_">this</span>.<span class="property">timeline</span>.<span class="property">currentTime</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> durationTime = currentTime - <span class="variable language_">this</span>.<span class="property">_lastFrameTime</span>;</span><br><span class="line">    <span class="keyword">if</span> (durationTime &gt;= <span class="variable language_">this</span>.<span class="property">_frameDuration</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> frameTime = currentTime - (durationTime % <span class="variable language_">this</span>.<span class="property">_frameDuration</span>);</span><br><span class="line">      <span class="keyword">const</span> deltaTime = frameTime - <span class="variable language_">this</span>.<span class="property">_lastFrameTime</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_lastFrameTime</span> = frameTime;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">options</span>: <span class="title class_">UpdateParams</span> = &#123;</span><br><span class="line">        deltaTime,</span><br><span class="line">        <span class="attr">time</span>: frameTime,</span><br><span class="line">        <span class="attr">currentTime</span>: frameTime,</span><br><span class="line">        <span class="attr">frameCount</span>: ++<span class="variable language_">this</span>.<span class="property">_frameCount</span>,</span><br><span class="line">        <span class="attr">fps</span>: <span class="title class_">Math</span>.<span class="title function_">round</span>(<span class="number">1000</span> / deltaTime),</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_tickers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">func</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> func === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">func</span>(options);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Add ticker function */</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_tickers</span>.<span class="title function_">add</span>(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Remove ticker function */</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_tickers</span>.<span class="title function_">delete</span>(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Start main loop */</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_started</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_started</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeline</span>.<span class="property">playbackRate</span> = <span class="number">1.0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_requestId</span> = <span class="title function_">requestAnimationFrame</span>(<span class="variable language_">this</span>.<span class="property">_ticker</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Pause main loop */</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_started</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeline</span>.<span class="property">playbackRate</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">setPlaybackRate</span>(<span class="params"><span class="attr">rate</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timeline</span>.<span class="property">playbackRate</span> = rate;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="entitygameobject"><a class="markdownIt-Anchor" href="#entitygameobject"></a> Entity/GameObject</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Scene</span> <span class="keyword">from</span> <span class="string">&#x27;../game/Scene&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Transform</span>, &#123; <span class="title class_">TransformParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Transform&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Component</span>, &#123; <span class="title class_">ComponentConstructor</span>, <span class="title class_">ComponentParams</span>, getComponentName &#125; <span class="keyword">from</span> <span class="string">&#x27;./Component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; observer, observerAdded, observerRemoved &#125; <span class="keyword">from</span> <span class="string">&#x27;./observer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _id = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** Generate unique id for gameObject */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getId</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> ++_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GameObject is a general purpose object. It consists of a unique id and components.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@public</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GameObject</span> &#123;</span><br><span class="line">  <span class="comment">/** Name of this gameObject */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Scene is an abstraction, represent a canvas layer */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_scene</span>: <span class="title class_">Scene</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** A key-value map for components on this gameObject */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_componentCache</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Identifier of this gameObject */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Components apply to this gameObject */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="attr">components</span>: <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** GameObject has been destroyed */</span></span><br><span class="line">  <span class="keyword">public</span> destroyed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Static GameObject will not run update and lateUpdate */</span></span><br><span class="line">  <span class="keyword">public</span> isStatic = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Consruct a new gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">name</span> - the name of this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">obj</span> - optional transform parameters for default Transform component</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">obj</span>?: <span class="title class_">TransformParams</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = <span class="title function_">getId</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">addComponent</span>(<span class="keyword">new</span> <span class="title class_">Transform</span>(obj));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get default transform component</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> transform component on this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@readonly</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">transform</span>(): <span class="title class_">Transform</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getComponent</span>(<span class="title class_">Transform</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get parent gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> parent gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@readonly</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">parent</span>(): <span class="title class_">GameObject</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">transform</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">transform</span>.<span class="property">parent</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">transform</span>.<span class="property">parent</span>.<span class="property">gameObject</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get the name of this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@readonly</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">name</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_name</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">scene</span>(<span class="params"><span class="attr">val</span>: <span class="title class_">Scene</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_scene</span> === val) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">const</span> scene = <span class="variable language_">this</span>.<span class="property">_scene</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_scene</span> = val;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">transform</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">transform</span>.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> child <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">transform</span>.<span class="property">children</span>) &#123;</span><br><span class="line">        child.<span class="property">gameObject</span>.<span class="property">scene</span> = val;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (val) &#123;</span><br><span class="line">      val.<span class="title function_">addGameObject</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      scene &amp;&amp; scene.<span class="title function_">removeGameObject</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get the scene which this gameObject added on</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> <span class="variable">scene</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@readonly</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">scene</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_scene</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add child gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">gameObject</span> - child gameobject</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">addChild</span>(<span class="params"><span class="attr">gameObject</span>: <span class="title class_">GameObject</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!gameObject || !gameObject.<span class="property">transform</span> || gameObject === <span class="variable language_">this</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(gameObject <span class="keyword">instanceof</span> <span class="title class_">GameObject</span>)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;addChild only receive GameObject&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">transform</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`gameObject &#x27;<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>&#x27; has been destroy`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    gameObject.<span class="property">transform</span>.<span class="property">parent</span> = <span class="variable language_">this</span>.<span class="property">transform</span>;</span><br><span class="line">    gameObject.<span class="property">scene</span> = <span class="variable language_">this</span>.<span class="property">scene</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove child gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">gameObject</span> - child gameobject</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">removeChild</span>(<span class="attr">gameObject</span>: <span class="title class_">GameObject</span>): <span class="title class_">GameObject</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(gameObject <span class="keyword">instanceof</span> <span class="title class_">GameObject</span>) || !gameObject.<span class="property">parent</span> || gameObject.<span class="property">parent</span> !== <span class="variable language_">this</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> gameObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gameObject.<span class="property">transform</span>.<span class="property">parent</span> = <span class="literal">null</span>;</span><br><span class="line">    gameObject.<span class="property">scene</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> gameObject;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add component to this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * If component has already been added on a gameObject, it will throw an error</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">C</span> - component instance or Component class</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(<span class="attr">C</span>: T): T;</span><br><span class="line">  addComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(</span><br><span class="line">    <span class="attr">C</span>: <span class="title class_">ComponentConstructor</span>&lt;T&gt;,</span><br><span class="line">    <span class="attr">obj</span>?: <span class="title class_">ComponentParams</span>,</span><br><span class="line">  ): T;</span><br><span class="line">  addComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(</span><br><span class="line">    <span class="attr">C</span>: T | <span class="title class_">ComponentConstructor</span>&lt;T&gt;,</span><br><span class="line">    <span class="attr">obj</span>?: <span class="title class_">ComponentParams</span>,</span><br><span class="line">  ): T &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">destroyed</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">const</span> componentName = <span class="title function_">getComponentName</span>(C);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_componentCache</span>[componentName]) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> component;</span><br><span class="line">    <span class="keyword">if</span> (C <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">      component = <span class="keyword">new</span> <span class="title function_">C</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (C <span class="keyword">instanceof</span> <span class="title class_">Component</span>) &#123;</span><br><span class="line">      component = C;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;addComponent recieve Component and Component Constructor&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (component.<span class="property">gameObject</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`component has been added on gameObject <span class="subst">$&#123;component.gameObject.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    component.<span class="property">gameObject</span> = <span class="variable language_">this</span>;</span><br><span class="line">    component.<span class="property">init</span> &amp;&amp; component.<span class="title function_">init</span>(component.<span class="property">__componentDefaultParams</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里不用在意，与ECS无关，是Eva的另外一套机制</span></span><br><span class="line">    <span class="title function_">observerAdded</span>(component, component.<span class="property">name</span>);</span><br><span class="line">    <span class="title function_">observer</span>(component, component.<span class="property">name</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">components</span>.<span class="title function_">push</span>(component);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_componentCache</span>[componentName] = component;</span><br><span class="line"></span><br><span class="line">    component.<span class="property">awake</span> &amp;&amp; component.<span class="title function_">awake</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove component on this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * default Transform component can not be removed, if the paramter represent a transform component, an error will be thrown.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">c</span> - one of the compnoentName, component instance, component Class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  removeComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(<span class="attr">c</span>: <span class="built_in">string</span>): T;</span><br><span class="line">  removeComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(<span class="attr">c</span>: T): T;</span><br><span class="line">  removeComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(<span class="attr">c</span>: <span class="title class_">ComponentConstructor</span>&lt;T&gt;): T;</span><br><span class="line">  removeComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(</span><br><span class="line">    <span class="attr">c</span>: <span class="built_in">string</span> | T | <span class="title class_">ComponentConstructor</span>&lt;T&gt;,</span><br><span class="line">  ): T &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">componentName</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      componentName = c;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c <span class="keyword">instanceof</span> <span class="title class_">Component</span>) &#123;</span><br><span class="line">      componentName = c.<span class="property">name</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.<span class="property">componentName</span>) &#123;</span><br><span class="line">      componentName = c.<span class="property">componentName</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (componentName === <span class="string">&#x27;Transform&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Transform can&#x27;t be removed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_removeComponent</span>(componentName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> _removeComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&gt;(<span class="attr">componentName</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">components</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span> name === componentName);</span><br><span class="line">    <span class="keyword">if</span> (index === -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> component = <span class="variable language_">this</span>.<span class="property">components</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)[<span class="number">0</span>] <span class="keyword">as</span> T;</span><br><span class="line">    <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">_componentCache</span>[componentName];</span><br><span class="line">    <span class="keyword">delete</span> component.<span class="property">__componentDefaultParams</span>;</span><br><span class="line">    component.<span class="property">onDestroy</span> &amp;&amp; component.<span class="title function_">onDestroy</span>();</span><br><span class="line">    <span class="comment">// 这里不用在意，与ECS无关，是Eva的另外一套机制</span></span><br><span class="line">    <span class="title function_">observerRemoved</span>(component, componentName);</span><br><span class="line">    component.<span class="property">gameObject</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">return</span> component;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get component on this gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">c</span> - one of the compnoentName, component instance, component Class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(<span class="attr">c</span>: <span class="title class_">ComponentConstructor</span>&lt;T&gt;): T;</span><br><span class="line">  getComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&gt;(<span class="attr">c</span>: <span class="built_in">string</span>): T;</span><br><span class="line">  getComponent&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&gt;(<span class="attr">c</span>: <span class="built_in">string</span> | <span class="title class_">ComponentConstructor</span>&lt;T&gt;): T &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">componentName</span>: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      componentName = c;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c <span class="keyword">instanceof</span> <span class="title class_">Component</span>) &#123;</span><br><span class="line">      componentName = c.<span class="property">name</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c.<span class="property">componentName</span>) &#123;</span><br><span class="line">      componentName = c.<span class="property">componentName</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">_componentCache</span>[componentName] !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_componentCache</span>[componentName] <span class="keyword">as</span> T;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove this gameObject on its parent</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> return this gameObject</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">remove</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">parent</span>) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">parent</span>.<span class="title function_">removeChild</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Destory this gameObject */</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">transform</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Cannot destroy gameObject that have already been destroyed.&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">transform</span>.<span class="property">children</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; gameObject &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      gameObject.<span class="title function_">destroy</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">remove</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">transform</span>.<span class="title function_">clearChildren</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">_componentCache</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_removeComponent</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">components</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">destroyed</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">GameObject</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="component"><a class="markdownIt-Anchor" href="#component"></a> Component</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">EventEmitter</span> <span class="keyword">from</span> <span class="string">&#x27;eventemitter3&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">GameObject</span> <span class="keyword">from</span> <span class="string">&#x27;./GameObject&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** frame info pass to `Component.update` method */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">UpdateParams</span> &#123;</span><br><span class="line">  <span class="comment">/** delta time from last frame */</span></span><br><span class="line">  <span class="attr">deltaTime</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** frame count since game begining */</span></span><br><span class="line">  <span class="attr">frameCount</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** current timestamp */</span></span><br><span class="line">  <span class="attr">time</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** current timestamp */</span></span><br><span class="line">  <span class="attr">currentTime</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** fps at current frame */</span></span><br><span class="line">  <span class="attr">fps</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** type of Component is function */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ComponentType</span> = <span class="keyword">typeof</span> <span class="title class_">Component</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get component name from component instance or Component class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">component</span> - component instance or Component class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> component&#x27; name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * ```typescript</span></span><br><span class="line"><span class="comment"> * import &#123; Transform &#125; from &#x27;eva.js&#x27;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * assert(getComponentName(Transform) === &#x27;Transform&#x27;)</span></span><br><span class="line"><span class="comment"> * assert(getComponentName(new Transform()) === &#x27;Transform&#x27;)</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> getComponentName&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt;(</span><br><span class="line">  <span class="attr">component</span>: T | <span class="title class_">ComponentConstructor</span>&lt;T&gt;,</span><br><span class="line">): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (component <span class="keyword">instanceof</span> <span class="title class_">Component</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> component.<span class="property">name</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (component <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> component.<span class="property">componentName</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// eslint-disable-next-line @typescript-eslint/no-empty-interface</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ComponentParams</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ComponentConstructor</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Component</span>&lt;<span class="title class_">ComponentParams</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="attr">componentName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="title function_">new</span> (<span class="attr">params</span>?: <span class="title class_">ComponentParams</span>): T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Component contain raw data apply to gameObject and how it interacts with the world</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@public</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Component</span>&lt;T <span class="keyword">extends</span> <span class="title class_">ComponentParams</span> = <span class="built_in">object</span>&gt; <span class="keyword">extends</span> <span class="title class_">EventEmitter</span> &#123;</span><br><span class="line">  <span class="comment">/** Name of this component */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="attr">componentName</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Name of this component */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">readonly</span> <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Represents the status of the component, If component has started, the value is true</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@defaultValue</span> <span class="variable">false</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  started = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * gameObject which this component had added on</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * Component can only be added on one gameObject, otherwise an error will be thrown,</span></span><br><span class="line"><span class="comment">   * see &#123;<span class="doctag">@link</span> https://eva.js.org/#/tutorials/gameObject&#125; for more details</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">gameObject</span>: <span class="title class_">GameObject</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Default paramaters for this component */</span></span><br><span class="line">  <span class="attr">__componentDefaultParams</span>: T;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">params</span>?: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line">    <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="variable language_">this</span>.<span class="property">constructor</span>.<span class="property">componentName</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">__componentDefaultParams</span> = params;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called during component construction</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">params</span> - optional initial parameters</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  init?(<span class="attr">params</span>?: T): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called when component is added to a gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  awake?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called after all component&#x27;s `awake` method has been called</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  start?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called in every tick, change self property or other component property</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">frame</span> - frame info about this tick</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  update?(<span class="attr">frame</span>: <span class="title class_">UpdateParams</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called after all gameObject&#x27;s `update` method has been called</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">frame</span> - frame info about this tick</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  lateUpdate?(<span class="attr">frame</span>: <span class="title class_">UpdateParams</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called before game runing or every time game paused</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@virtual</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onResume?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called while the game paused.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onPause?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called while component be destroyed.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onDestroy?(): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Component</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="system"><a class="markdownIt-Anchor" href="#system"></a> System</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PureObserverInfo</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./observer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">UpdateParams</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentObserver</span> <span class="keyword">from</span> <span class="string">&#x27;./ComponentObserver&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Game</span> <span class="keyword">from</span> <span class="string">&#x27;../game/Game&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">SystemConstructor</span>&lt;T <span class="keyword">extends</span> <span class="title class_">System</span> = <span class="title class_">System</span>&gt; &#123;</span><br><span class="line">  <span class="attr">systemName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">observerInfo</span>: <span class="title class_">PureObserverInfo</span>;</span><br><span class="line">  <span class="title function_">new</span> (<span class="attr">params</span>?: <span class="built_in">any</span>): T;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Each System runs continuously and performs global actions on every Entity that possesses a Component of the same aspect as that System.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@public</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">System</span>&lt;T <span class="keyword">extends</span> <span class="built_in">object</span> = <span class="built_in">object</span>&gt; &#123;</span><br><span class="line">  <span class="comment">/** System name */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="attr">systemName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The collection of component properties observed by the System. System will respond to these changes</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * // TestSystem will respond to changes of `size` and `position` property of the Transform component</span></span><br><span class="line"><span class="comment">   * class TestSystem extends System &#123;</span></span><br><span class="line"><span class="comment">   *   static observerInfo = &#123;</span></span><br><span class="line"><span class="comment">   *     Transform: [&#123; prop: &#x27;size&#x27;, deep: true &#125;, &#123; prop: &#x27;position&#x27;, deep: true &#125;]</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="attr">observerInfo</span>: <span class="title class_">PureObserverInfo</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Component Observer */</span></span><br><span class="line">  <span class="attr">componentObserver</span>: <span class="title class_">ComponentObserver</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Game instance */</span></span><br><span class="line">  <span class="attr">game</span>: <span class="title class_">Game</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Represents the status of the component, if component has started, the value is true */</span></span><br><span class="line">  started = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Default paramaters for this system */</span></span><br><span class="line">  <span class="attr">__systemDefaultParams</span>: T;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="attr">params</span>?: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentObserver</span> = <span class="keyword">new</span> <span class="title class_">ComponentObserver</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">__systemDefaultParams</span> = params;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="variable language_">this</span>.<span class="property">constructor</span>.<span class="property">systemName</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called when system is added to a gameObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * The difference between init and awake is that `init` method recieves params.</span></span><br><span class="line"><span class="comment">   * Both of those methods are called early than `start` method.</span></span><br><span class="line"><span class="comment">   * Use this method to prepare data, ect.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">param</span> - optional params</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  init?(<span class="attr">param</span>?: T): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Calleen system installed</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  awake?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called after all system `awake` method has been called</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  start?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called in each tick</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * // run TWEEN `update` method in main requestAnimationFrame loop</span></span><br><span class="line"><span class="comment">   * class TransitionSystem extends System &#123;</span></span><br><span class="line"><span class="comment">   *   update() &#123;</span></span><br><span class="line"><span class="comment">   *     TWEEN.update()</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">e</span> - info about this tick</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  update?(<span class="attr">e</span>: <span class="title class_">UpdateParams</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called after all system have called the `update` method</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">e</span> - info about this tick</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  lateUpdate?(<span class="attr">e</span>: <span class="title class_">UpdateParams</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called before game runing or every time game paused</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onResume?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called while the game paused</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onPause?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called while the system be destroyed.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@override</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onDestroy?(): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Default destory method */</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentObserver</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">__systemDefaultParams</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">onDestroy</span>?.();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">System</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="game"><a class="markdownIt-Anchor" href="#game"></a> Game</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Game</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span> &#123;</span><br><span class="line">  <span class="attr">_scene</span>: <span class="title class_">Scene</span>;</span><br><span class="line">  <span class="attr">canvas</span>: <span class="title class_">HTMLCanvasElement</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * State of game</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@defaultValue</span> <span class="variable">false</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  playing = <span class="literal">false</span>;</span><br><span class="line">  started = <span class="literal">false</span>;</span><br><span class="line">  <span class="attr">multiScenes</span>: <span class="title class_">Scene</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Ticker</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">ticker</span>: <span class="title class_">Ticker</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Systems alled to this game */</span></span><br><span class="line">  <span class="attr">systems</span>: <span class="title class_">System</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">    systems,</span></span><br><span class="line"><span class="params">    onInit,</span></span><br><span class="line"><span class="params">    frameRate = <span class="number">60</span>,</span></span><br><span class="line"><span class="params">    autoStart = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">    needScene = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">  &#125;: <span class="title class_">GameParams</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line">    <span class="comment">// if (window.__EVA_INSPECTOR_ENV__) &#123;</span></span><br><span class="line">    <span class="comment">//   window.__EVA_GAME_INSTANCE__ = this;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span> = <span class="keyword">new</span> <span class="title class_">Ticker</span>(&#123; <span class="attr">autoStart</span>: <span class="literal">false</span>, frameRate &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initTicker</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">init</span>(systems).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (needScene) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">loadScene</span>(<span class="keyword">new</span> <span class="title class_">Scene</span>(<span class="string">&#x27;scene&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (autoStart) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">start</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      onInit?.();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"><span class="attr">systems</span>: <span class="title class_">System</span>[]</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> systems) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">addSystem</span>(system);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get scene on this game</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">scene</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_scene</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">scene</span>(<span class="params"><span class="attr">scene</span>: <span class="title class_">Scene</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_scene</span> = scene;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">gameObjects</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getAllGameObjects</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">nonStaticGameObject</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">gameObjects</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">g</span>) =&gt;</span> !g.<span class="property">isStatic</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> addSystem&lt;T <span class="keyword">extends</span> <span class="title class_">System</span>&gt;(<span class="attr">S</span>: T): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">  <span class="keyword">async</span> addSystem&lt;T <span class="keyword">extends</span> <span class="title class_">System</span>&gt;(</span><br><span class="line">    <span class="attr">S</span>: <span class="title class_">SystemConstructor</span>&lt;T&gt;,</span><br><span class="line">    <span class="attr">obj</span>?: <span class="title class_">ConstructorParameters</span>&lt;<span class="title class_">SystemConstructor</span>&lt;T&gt;&gt;,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Add system</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">S</span> - system instance or system Class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@typeParam</span> <span class="variable">T</span> - system which extends base `System` class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@typeparam</span> <span class="variable">U</span> - type of system class</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> addSystem&lt;T <span class="keyword">extends</span> <span class="title class_">System</span>&gt;(</span><br><span class="line">    <span class="attr">S</span>: T | <span class="title class_">SystemConstructor</span>&lt;T&gt;,</span><br><span class="line">    <span class="attr">obj</span>?: <span class="title class_">ConstructorParameters</span>&lt;<span class="title class_">SystemConstructor</span>&lt;T&gt;&gt;,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> system;</span><br><span class="line">    <span class="keyword">if</span> (S <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">      system = <span class="keyword">new</span> <span class="title function_">S</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S <span class="keyword">instanceof</span> <span class="title class_">System</span>) &#123;</span><br><span class="line">      system = S;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;can only add System&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasTheSystem = <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> item.<span class="property">constructor</span> === system.<span class="property">constructor</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (hasTheSystem) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span> System has been added`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    system.<span class="property">game</span> = <span class="variable language_">this</span>;</span><br><span class="line">    system.<span class="property">init</span> &amp;&amp; (<span class="keyword">await</span> system.<span class="title function_">init</span>(system.<span class="property">__systemDefaultParams</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setSystemObserver</span>(system, system.<span class="property">constructor</span>);</span><br><span class="line">    <span class="title function_">initObserver</span>(system.<span class="property">constructor</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      system.<span class="property">awake</span> &amp;&amp; (<span class="keyword">await</span> system.<span class="title function_">awake</span>());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span> awake error`</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">push</span>(system);</span><br><span class="line">    <span class="keyword">return</span> system;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Remove system from this game</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">system</span> - one of system instance / system Class or system name</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  removeSystem&lt;S <span class="keyword">extends</span> <span class="title class_">System</span>&gt;(<span class="attr">system</span>: S | <span class="title class_">SystemConstructor</span>&lt;S&gt; | <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!system) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> index = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> system === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      index = <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> s.<span class="property">name</span> === system);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (system <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">      index = <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> s.<span class="property">constructor</span> === system);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (system <span class="keyword">instanceof</span> <span class="title class_">System</span>) &#123;</span><br><span class="line">      index = <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">findIndex</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> s === system);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">systems</span>[index].<span class="property">destroy</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">systems</span>[index].<span class="title function_">destroy</span>();</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Get system</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">S</span> - system class or system name</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> system instance</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getSystem&lt;T <span class="keyword">extends</span> <span class="title class_">System</span>&gt;(<span class="attr">S</span>: <span class="title class_">SystemConstructor</span>&lt;T&gt; | <span class="built_in">string</span>): T &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">system</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> S === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> system.<span class="property">name</span> === S;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> system <span class="keyword">instanceof</span> S;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;) <span class="keyword">as</span> T;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Pause game */</span></span><br><span class="line">  <span class="title function_">pause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">playing</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">playing</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span>.<span class="title function_">pause</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">triggerPause</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Start game */</span></span><br><span class="line">  <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">playing</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">playing</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">started</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span>.<span class="title function_">start</span>();</span><br><span class="line">    <span class="title class_">PIXITicker</span>.<span class="property">shared</span>.<span class="property">maxFPS</span> = <span class="number">60</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Resume game */</span></span><br><span class="line">  <span class="title function_">resume</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">playing</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">playing</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span>.<span class="title function_">start</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">triggerResume</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * add main render method to ticker</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * the method added to ticker will called in each requestAnimationFrame,</span></span><br><span class="line"><span class="comment">   * 1. call update method on all gameObject</span></span><br><span class="line"><span class="comment">   * 2. call lastUpdate method on all gameObject</span></span><br><span class="line"><span class="comment">   * 3. call update method on all system</span></span><br><span class="line"><span class="comment">   * 4. call lastUpdate method on all system</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initTicker</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span>.<span class="title function_">add</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scene</span> &amp;&amp; <span class="title function_">gameObjectLoop</span>(e, <span class="variable language_">this</span>.<span class="property">nonStaticGameObject</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">systems</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="title function_">triggerStart</span>(system);</span><br><span class="line">          system.<span class="property">update</span> &amp;&amp; system.<span class="title function_">update</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">          <span class="comment">// @ts-ignore</span></span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span> update error`</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">systems</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          system.<span class="property">lateUpdate</span> &amp;&amp; system.<span class="title function_">lateUpdate</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">          <span class="comment">// @ts-ignore</span></span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span> lateUpdate error`</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Call onResume method on all gameObject&#x27;s, and then call onResume method on all system */</span></span><br><span class="line">  <span class="title function_">triggerResume</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">gameObjectResume</span>(<span class="variable language_">this</span>.<span class="property">gameObjects</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">systems</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        system.<span class="property">onResume</span> &amp;&amp; system.<span class="title function_">onResume</span>();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">        <span class="comment">// @ts-ignore</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span>, onResume error`</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Call onPause method on all gameObject */</span></span><br><span class="line">  <span class="title function_">triggerPause</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">gameObjectPause</span>(<span class="variable language_">this</span>.<span class="property">gameObjects</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">systems</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        system.<span class="property">onPause</span> &amp;&amp; system.<span class="title function_">onPause</span>();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="comment">// eslint-disable-next-line @typescript-eslint/ban-ts-comment</span></span><br><span class="line">        <span class="comment">// @ts-ignore</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;system.constructor.systemName&#125;</span>, onPause error`</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> call system destroy method</span></span><br><span class="line">  <span class="comment">/** remove all system on this game */</span></span><br><span class="line">  <span class="title function_">destroySystems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> system <span class="keyword">of</span> [...<span class="variable language_">this</span>.<span class="property">systems</span>]) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">removeSystem</span>(system);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">systems</span>.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Destroy game instance */</span></span><br><span class="line">  <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">removeAllListeners</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">pause</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span>.<span class="title function_">destroy</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">destroySystems</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ticker</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scene</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">canvas</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">multiScenes</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loadScene</span>(<span class="params">&#123; scene, mode = LOAD_SCENE_MODE.SINGLE, params = &#123;&#125; &#125;: <span class="title class_">LoadSceneParams</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!scene) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">LOAD_SCENE_MODE</span>.<span class="property">SINGLE</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scene</span> = scene;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="variable constant_">LOAD_SCENE_MODE</span>.<span class="property">MULTI_CANVAS</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">multiScenes</span>.<span class="title function_">push</span>(scene);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;sceneChanged&#x27;</span>, &#123; scene, mode, params &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他用途"><a class="markdownIt-Anchor" href="#其他用途"></a> 其他用途</h2><p>ECS架构也可以用于消息通信，比如把消息体封装进一个Component中，这样其对应的System就会在下一个Ticker获得该Component并进行处理</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Ray Sun</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://sunra.top/posts/f0899875/" title="Eva框架的ECS架构解析">https://sunra.top/posts/f0899875/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/a7f13cc8/" rel="prev" title="零基础学习机器学习（四）模型的评估与选择的数学原理下篇"><i class="fa fa-chevron-left"></i> 零基础学习机器学习（四）模型的评估与选择的数学原理下篇</a></div><div class="post-nav-item"> <a href="/posts/d2fb22d7/" rel="next" title="如何使用矩阵表达和简化二元关系">如何使用矩阵表达和简化二元关系<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/posts/f0899875/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>