<!DOCTYPE html>
<html lang>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunra.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这个周在引入新的插件进入项目后，本地调试是正常的，但是一大包出来就会丢失一些文件，查了半天，发现是因为该文件没有被直接引用，是通过ScriptableObject.CreateInstance(typeName)这种形式动态创建的，所以最后打包之后被代码裁剪的过程去掉了。 解决方案也比较简单，在Assets目录下加一个link.xml，然后声明该程序集不可被裁减就好。 但是回过头来，我们还是要看一">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity 托管代码剥离与Linker">
<meta property="og:url" content="https://sunra.top/2022/07/27/unity-code-strip-and-linker/index.html">
<meta property="og:site_name" content="Origin of Ray">
<meta property="og:description" content="这个周在引入新的插件进入项目后，本地调试是正常的，但是一大包出来就会丢失一些文件，查了半天，发现是因为该文件没有被直接引用，是通过ScriptableObject.CreateInstance(typeName)这种形式动态创建的，所以最后打包之后被代码裁剪的过程去掉了。 解决方案也比较简单，在Assets目录下加一个link.xml，然后声明该程序集不可被裁减就好。 但是回过头来，我们还是要看一">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2023-04-18T06:48:39.790Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity 托管代码剥离与Linker">
<meta name="twitter:description" content="这个周在引入新的插件进入项目后，本地调试是正常的，但是一大包出来就会丢失一些文件，查了半天，发现是因为该文件没有被直接引用，是通过ScriptableObject.CreateInstance(typeName)这种形式动态创建的，所以最后打包之后被代码裁剪的过程去掉了。 解决方案也比较简单，在Assets目录下加一个link.xml，然后声明该程序集不可被裁减就好。 但是回过头来，我们还是要看一">

<link rel="canonical" href="https://sunra.top/2022/07/27/unity-code-strip-and-linker/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>Unity 托管代码剥离与Linker | Origin of Ray</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KEJ1L66CKC');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Origin of Ray</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://sunra.top/2022/07/27/unity-code-strip-and-linker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
      <meta itemprop="name" content="Ray Sun">
      <meta itemprop="description" content="拨开互联网的迷雾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Origin of Ray">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Unity 托管代码剥离与Linker
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-27 15:27:13" itemprop="dateCreated datePublished" datetime="2022-07-27T15:27:13+08:00">2022-07-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-18 14:48:39" itemprop="dateModified" datetime="2023-04-18T14:48:39+08:00">2023-04-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>这个周在引入新的插件进入项目后，本地调试是正常的，但是一大包出来就会丢失一些文件，查了半天，发现是因为该文件没有被直接引用，是通过<code>ScriptableObject.CreateInstance(typeName)</code>这种形式动态创建的，所以最后打包之后被代码裁剪的过程去掉了。</p>
<p>解决方案也比较简单，在Assets目录下加一个link.xml，然后声明该程序集不可被裁减就好。</p>
<p>但是回过头来，我们还是要看一下，这个代码裁剪的逻辑以及为什么link.xml可以避免代码被裁减。</p>
<a id="more"></a>
<h2 id="托管代码剥离"><a href="#托管代码剥离" class="headerlink" title="托管代码剥离"></a>托管代码剥离</h2><p>在构建过程中，Unity会通过托管代码剥离移除没有使用或者无法访问的代码，这样可以显著降低最终产物的大小。托管代码剥离会从托管程序集中进行代码移除，这个包括项目中C#代码所在程序集，插件或者第三方包所在程序集以及.NET Framework所在程序集。</p>
<p>Unity使用一个叫做Unity Linker的工具去进行静态的代码检测，静态分析能够识别任何类、类的部分、函数的部分或者在执行过程中无法到达的函数的部分。这个检测只会对构建时就存在的代码进行，运行时动态生成的代码并不会被检测到。</p>
<h3 id="配置代码裁剪"><a href="#配置代码裁剪" class="headerlink" title="配置代码裁剪"></a>配置代码裁剪</h3><p>我们可以通过使用<code>Managed Stripping Level</code>来控制Unity执行代码裁剪的程度，为了避免Unity移除我们特别指定的某些部分代码，我们可以使用某种注释的方式来声明哪一部分应该被Unity Linker保留。</p>
<p>我们可以在Player Settings中修改代码裁剪的级别，可选的值有以下几种：</p>
<ul>
<li>Disabled：Unity不做任何的代码裁剪。这个配置只在我们使用Mono的时候可以选择，并且是默认配置</li>
<li>Minimal：Unity只会检测UnityEngine和.NET的代码。并不会移除任何用户代码。这个配置最不可能会导致意料之外的运行时表现，此配置多用于可用性优先级高于包体积的产品中。此配置是IL2CPP的默认配置</li>
<li>Low：Unity搜索部分用户程序集以及所有的UnityEngine和.NET代码。此设置应用一组规则，删除一些未使用的代码，但最大限度地减少出现意外后果的可能性，例如使用反射的运行时代码的行为变化。</li>
<li>Medium：Unity 部分地搜索所有程序集以查找无法访问的代码。此设置应用一组规则，该规则去除更多类型的代码模式，以减少生成大小。尽管 Unity 不会去掉所有可能的无法访问的代码，但此设置确实增加了不希望或意外行为更改的风险。</li>
<li>High：Unity对所有的程序集进行最广泛的检测，Unity 优先考虑缩小代码的大小，而不是代码的稳定性，并且尽可能多地删除代码。</li>
</ul>
<h3 id="通过注解的方式保留代码"><a href="#通过注解的方式保留代码" class="headerlink" title="通过注解的方式保留代码"></a>通过注解的方式保留代码</h3><p>我们可以通过注解的方式避免Unity Linker去裁剪我们制定的部分代码。这在我们的应用会产生运行时代码的时候是有用的，例如我们的代码里用到了reflection。注释要么为 Unity 链接器提供一般指导，告诉它不应该去掉哪些代码模式，要么告诉它不要去掉特定的、已定义的代码段</p>
<p>可以使用两种主要方法对代码进行注释，以便在托管代码剥离过程中保存代码：</p>
<ul>
<li>根注释（Root annotations）将代码的某些部分标识为根。Unity 链接器不会去掉任何标记为根的代码。根注释使用起来不那么复杂，但是也会导致 Unity 链接器保留一些应该去掉的代码</li>
<li>注释定义了代码元素之间的连接。与根注释相比，依赖项注释可以减少代码过度保存的数量</li>
</ul>
<p>这些技术中的每一个都提供了对 Unity 链接器在更高剥离级别剥离的代码量的更多控制，并减少了重要代码被剥离的机会。当您的代码通过反射引用其他代码时，注释特别有用，因为 Unity 链接器不能总是检测反射的使用。</p>
<h3 id="Root-Annotations"><a href="#Root-Annotations" class="headerlink" title="Root Annotations"></a>Root Annotations</h3><p>根注释强制Unity Linker把代码元素当作根元素，这样改代码就不会被裁减。</p>
<p>我们有两种方式将一段代码标记为根元素，两种方式的选择取决于你是否想要保留程序集的构造函数或者单个类型</p>
<ul>
<li>Preserve Attribute : 将单个类型作为根元素进行保留</li>
<li>Link.xml : 将单整个程序集以及被改程序集引用的其他程序集都作为根来进行保留</li>
</ul>
<h4 id="使用Preserve属性来标记根"><a href="#使用Preserve属性来标记根" class="headerlink" title="使用Preserve属性来标记根"></a>使用Preserve属性来标记根</h4><p>使用 Preserve 属性从 Unity 链接器的静态分析中单独排除代码的特定部分。若要使用此属性对代码段进行注释，请在要保留的代码的第一部分之前立即添加[ Preserve ]。下面的列表描述了当您使用[ Preserve ]属性注释不同的代码元素时，Unity 链接器保留的实体</p>
<ul>
<li>Assembly: Preserves all types that are used and defined in the assembly. To assign the [Preserve] attribute to an assembly, place the attribute declaration in any C# file included in the assembly, before any namespace declarations.</li>
<li>Type: Preserves a class or type and its default constructor.</li>
<li>Method: Preserves the method, the type that declares the method, the type the method returns, and the types of all of its arguments.</li>
<li>Property: Preserves the property, the type that declares the property, the value type of the property, and methods that get and set the property value.</li>
<li>Field: Preserves the field, the field type, and the type that declares the field.</li>
<li>Event: Preserves the event, the type that declares the event, type, the type the event returns, the [add] accessor, and the [remove] accessor.</li>
<li>Delegate: Preserves the delegate type and all methods that the delegate invokes.</li>
</ul>
<p>如果你想同时保留一个类型和它的缺省构造函数，可以使用[ Preserve ]属性。如果希望保留其中一个，但不希望同时保留两个，请使用 link.xml 文件</p>
<h4 id="使用XML文件来标记"><a href="#使用XML文件来标记" class="headerlink" title="使用XML文件来标记"></a>使用XML文件来标记</h4><p>在项目中可以使用名称为 link.xml 的 xml 文件，以保留特定程序集或程序集部分的列表。Xml 文件必须出现在项目中的 Assets 文件夹或 Assets 文件夹的子目录中，并且必须在文件中包含 <code>&lt; linker &gt;</code> 标记。Unity 链接器将 link.xml 文件中保存的任何程序集、类型或成员视为根类型。</p>
<p>您可以在项目中使用任意数量的 link.xml 文件。因此，您可以为每个插件提供单独的保存声明。不能在Package中包含 link.xml 文件，但是可以从非Package的 link.xml 文件中引用Package程序集。</p>
<p>下面贴一个官方的例子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">linker</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--Preserve types and members in an assembly--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Preserve an entire type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span> <span class="attr">preserve</span>=<span class="string">"all"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--No "preserve" attribute and no members specified means preserve all members--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve all fields on a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span> <span class="attr">preserve</span>=<span class="string">"fields"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve all fields on a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span> <span class="attr">preserve</span>=<span class="string">"methods"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve the type only--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span> <span class="attr">preserve</span>=<span class="string">"nothing"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserving only specific members of a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"AssemblyName.MethodName"</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">&lt;!--Fields--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">signature</span>=<span class="string">"System.Int32 FieldName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a field by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">"FieldName"</span> /&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">&lt;!--Methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">"System.Void MethodName()"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a method with parameters--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">"System.Void MethodName(System.Int32,System.String)"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a method by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>=<span class="string">"MethodName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Properties--&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it's backing field (if present), </span></span><br><span class="line"><span class="comment">          getter, and setter methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">"System.Int32 PropertyName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">"System.Int32 PropertyName"</span> <span class="attr">accessors</span>=<span class="string">"all"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it's backing field (if present), and getter method--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">"System.Int32 PropertyName"</span> <span class="attr">accessors</span>=<span class="string">"get"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it's backing field (if present), and setter method--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">"System.Int32 PropertyName"</span> <span class="attr">accessors</span>=<span class="string">"set"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"PropertyName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Events--&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve an event, it's backing field (if present), add, and remove methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">event</span> <span class="attr">signature</span>=<span class="string">"System.EventHandler EventName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve an event by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">"EventName"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">linker</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="XML的属性"><a href="#XML的属性" class="headerlink" title="XML的属性"></a>XML的属性</h4><p>link.xml文件的<code>&lt;assembly&gt;</code>标签有三个属性可以让我们更加精细的控制代码裁剪</p>
<ul>
<li>ignoreIfMissing: Use this attribute if you need to declare preservations for an assembly that doesn’t exist during all Player builds.</li>
<li>ignoreIfUnreferenced: In some cases, you might want to preserve entities in an assembly only when that assembly is referenced by another assembly. Use this attribute to preserve the entities in an assembly only when at least one type is referenced in an assembly.</li>
<li>windowsruntime: When you define preservations for a Windows Runtime Metadata (.winmd) assembly, you must add the windowsruntime attribute to the <code>&lt;assembly&gt;</code>element in the link.xml file:</li>
</ul>
<h3 id="Dependency-Annotations"><a href="#Dependency-Annotations" class="headerlink" title="Dependency Annotations"></a>Dependency Annotations</h3><p>依赖项注释定义了不同代码元素之间的依赖关系。这些注释对于保留 Unity 链接器不能静态分析的代码模式(比如反射)很有用。这些注释还确保当没有根元素使用这些代码元素时，不会错误地保留这些代码元素。有两种方法可以用来改变 Unity 链接器处理代码元素的方式:</p>
<ul>
<li>Annotation attributes: 这些属性表明 Unity 链接器应该保留特定的代码模式，例如从注释类型派生的任何类型。</li>
<li>AlwaysLinkAssemblyAttribute: 使用此属性指示 Unity 链接器应处理程序集，即使该程序集没有被项目中的任何其他程序集引用。</li>
</ul>
<h4 id="Annotation-attributes"><a href="#Annotation-attributes" class="headerlink" title="Annotation attributes"></a>Annotation attributes</h4><p>[ Preserve ]属性对于总是需要 API 的情况非常有用。其他属性可以用于更一般的保存。例如，您可以通过使用 RequreComplementorsAttribute 对接口进行注释来保留实现特定接口的所有类型。</p>
<p>要注释特定的编码模式，请使用下列一个或多个属性:</p>
<ul>
<li>RequireImplementorsAttribute: marks all types that implement this interface as dependencies.</li>
<li>RequireDerivedAttribute: marks all types that derive from this type as dependencies.</li>
<li>RequiredInterfaceAttribute: marks interface implementations on types as dependencies.</li>
<li>RequiredMemberAttribute: marks all members of a type as dependencies.</li>
<li>RequireAttributeUsagesAttribute: marks custom attributes as dependencies.</li>
</ul>
<h4 id="AlwaysLinkAssembly-Attribute"><a href="#AlwaysLinkAssembly-Attribute" class="headerlink" title="AlwaysLinkAssembly Attribute"></a>AlwaysLinkAssembly Attribute</h4><p>[ AlwaysLinkAssembly ]属性强制 Unity 链接器搜索程序集，而不管该程序集是否被生成中包含的另一个程序集引用。只能将 AlwaysLinkAssembly 属性应用于程序集。</p>
<p>该属性不直接保存程序集内的代码。相反，此属性指示 Unity 链接器将根标记规则应用于程序集。<strong>如果没有代码元素匹配程序集的根标记规则，Unity 链接器仍然会从生成中删除程序集</strong>。</p>
<p>对包含一个或多个具有[ RuntimeInitializeOnLoadMethod ]属性但可能不包含在任何场景中直接或间接使用的类型的预编译或包程序集使用此属性</p>
<h2 id="Unity-Linker-Unity-链接器"><a href="#Unity-Linker-Unity-链接器" class="headerlink" title="Unity Linker (Unity 链接器)"></a>Unity Linker (Unity 链接器)</h2><p>Unity 构建过程使用一个名为 Unity 链接器的工具来剥离托管代码。Unity 链接器是定制的用于 Unity 的 IL 链接器的一个版本。自定义 Unity 引擎的 Unity 链接器的特定部分不公开可用。</p>
<p>Unity 链接器负责托管代码剥离和引擎代码剥离过程的一部分，后者是通过 IL2CPP 提供的一个独立过程。</p>
<h3 id="链接器是如何工作的"><a href="#链接器是如何工作的" class="headerlink" title="链接器是如何工作的"></a>链接器是如何工作的</h3><p>Unity 链接器分析项目中的所有程序集。首先，它标记根类型、方法、属性和字段。例如，添加到 GameObjects 中的 MonoBehavior 派生类在一个场景中是根类型。然后 Unity 链接器分析它标记的根以标识，并标记这些根所依赖的任何托管代码。在完成这个静态分析后，任何剩余的未标记代码都不能通过应用程序代码的任何执行路径访问，Unity 链接器会从程序集中删除它。</p>
<p>Unity 编辑器创建一个程序集列表，其中包含在 Unity 项目的任何场景中使用的类型，并将该列表传递给 Unity 链接器。然后 Unity 链接器处理这些程序集、这些程序集的任何引用、在 link.xml 文件中声明的任何程序集以及具有 AlwaysLinkAssembly 属性的任何程序集。通常，Unity 链接器不会处理项目中包含的不属于这些类别的程序集，并将它们排除在播放器构建之外。</p>
<p>对于 Unity 链接器处理的每个程序集，它都遵循一组基于程序集分类、程序集是否包含场景中使用的类型以及为生成选择的托管剥离级别的规则。</p>
<p>就本规则而言，程序集分为以下类别:</p>
<ul>
<li>.NET Class Library assemblies — Includes the Mono class libraries such as mscorlib.dll and System.dll, as well as .NET class library facade assemblies like netstandard.dll.</li>
<li>Platform SDK assemblies — Includes the managed assemblies specific to a platform SDK. For example, the windows.winmd assembly that is part of the Universal Windows Platform SDK.</li>
<li>Unity Engine Module assemblies — Includes the managed assemblies that make up the Unity Engine, such as UnityEngine.Core.dll.</li>
<li>Project assemblies — Includes the assemblies specific to a project such as:<ul>
<li>Script assemblies such as Assembly-CSharp.dll</li>
<li>Precompiled assemblies</li>
<li>Assembly Definition Assemblies</li>
<li>Package assemblies</li>
</ul>
</li>
</ul>
<p>当您在 Unity 中构建项目时，构建过程将您的 C # 代码编译为。NET 字节码格式，称为通用中间语言(CIL)。Unity 将这个 CIL 字节码打包成称为程序集的文件。那个。NET 框架库和项目中使用的插件中的任何 C # 库也被预先打包为 CIL 字节码的程序集。</p>
<p>当Unity链接器执行其静态分析时，它遵循一组规则来确定 CIL 字节码的哪些部分被 Unity 链接器标记为构建所必需的。根标记（Root Annotations）规则确定 Unity 链接器如何标识和保留构建中的顶级程序集。依赖性标记(Dependency Annotations)规则确定 Unity 链接器如何标识和保留根程序集所依赖的任何代码。</p>
<p>具体的那些代码会被作为根，哪些代码会被作为依赖可以看一下官方文档：<a href="https://docs.unity3d.com/Manual/unity-linker.html" rel="external nofollow noopener noreferrer" target="_blank">https://docs.unity3d.com/Manual/unity-linker.html</a></p>
<h3 id="Link-xml文件的feature-tag"><a href="#Link-xml文件的feature-tag" class="headerlink" title="Link.xml文件的feature tag"></a>Link.xml文件的feature tag</h3><p>XML 文件支持一个不常用的“特性”XML 属性。在本例中，嵌入在 mscolib.dll 中的 mscolib.xml 文件使用了这个属性，但是您可以在适当的时候在任何 link.xml 文件中使用它。</p>
<p>当你使用高级剥离级别时，Unity 链接器会排除那些基于当前版本设置不支持的特性的保留:</p>
<ul>
<li>Remoting ー在针对 IL2CPP 脚本后端时排除</li>
<li>Sre ー在针对 IL2CPP 脚本后端时排除。</li>
<li>COM ー在瞄准不支持 COM 的平台时排除。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">linker</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">"Foo"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">"Type1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--Preserve FeatureOne on platforms that support COM--&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">"System.Void FeatureOne()"</span> <span class="attr">feature</span>=<span class="string">"com"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--Preserve FeatureTwo on all platforms--&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">"System.Void FeatureTwo()"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">linker</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="修改Method的代码"><a href="#修改Method的代码" class="headerlink" title="修改Method的代码"></a>修改Method的代码</h3><p>当您使用 High 剥离级别时，Unity 链接器编辑方法体以进一步减少代码大小。本节总结了 Unity 链接器对方法主体所做的一些值得注意的编辑。</p>
<p>Unity Linker只会对.NET 类库程序集中的方法主体进行编辑。方法体编辑后，程序集的源代码不再与程序集中已编译的代码匹配，这会增加调试的难度。</p>
<p>下面的列表描述 Unity 链接器可以执行的编辑方法主体的操作:</p>
<ul>
<li>删除不可到达的分支-Unity 链接器删除检查 System 的 If 语句块。环境。平台，并且当前目标平台无法访问。</li>
<li>只访问字段的内联方法—— Unity 链接器替换对获取或设置字段的方法的调用，这些方法可以直接访问字段。这通常使得完全去除该方法成为可能。当您使用 Mono 后端时，Unity 链接器仅在允许方法的调用方根据字段的可见性直接访问该字段时才进行此更改。对于 IL2CPP，可见性规则不适用，因此 Unity 链接器会在适当的地方进行此更改。</li>
<li>返回常量值的内联方法-Unity 链接器内联调用只返回常量值的方法。</li>
<li>删除空的不返回调用—— Unity 链接器删除对空的并且返回类型为 void 的方法的调用。</li>
<li>删除空作用域-Unity 链接器在 Last 块为空时删除 Try/Finally 块。删除空调用可以创建空的 Finally 块。如果在方法编辑期间发生这种情况，Unity 链接器将删除整个 Try/Finally 块。可能发生这种情况的一个场景是，编译器为了调用 Dispose ()而在 foreach 循环中生成 Try/Finally 块。</li>
</ul>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Ray Sun
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sunra.top/2022/07/27/unity-code-strip-and-linker/" title="Unity 托管代码剥离与Linker">https://sunra.top/2022/07/27/unity-code-strip-and-linker/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/07/24/unity-render-pipeline-12/" rel="prev" title="Unity 渲染原理（十二）透明效果与渲染队列">
      <i class="fa fa-chevron-left"></i> Unity 渲染原理（十二）透明效果与渲染队列
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/07/30/git-shell/" rel="next" title="Git 命令行踩坑笔记">
      Git 命令行踩坑笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#托管代码剥离"><span class="nav-number">1.</span> <span class="nav-text">托管代码剥离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置代码裁剪"><span class="nav-number">1.1.</span> <span class="nav-text">配置代码裁剪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过注解的方式保留代码"><span class="nav-number">1.2.</span> <span class="nav-text">通过注解的方式保留代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Root-Annotations"><span class="nav-number">1.3.</span> <span class="nav-text">Root Annotations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Preserve属性来标记根"><span class="nav-number">1.3.1.</span> <span class="nav-text">使用Preserve属性来标记根</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用XML文件来标记"><span class="nav-number">1.3.2.</span> <span class="nav-text">使用XML文件来标记</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XML的属性"><span class="nav-number">1.3.3.</span> <span class="nav-text">XML的属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dependency-Annotations"><span class="nav-number">1.4.</span> <span class="nav-text">Dependency Annotations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Annotation-attributes"><span class="nav-number">1.4.1.</span> <span class="nav-text">Annotation attributes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AlwaysLinkAssembly-Attribute"><span class="nav-number">1.4.2.</span> <span class="nav-text">AlwaysLinkAssembly Attribute</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unity-Linker-Unity-链接器"><span class="nav-number">2.</span> <span class="nav-text">Unity Linker (Unity 链接器)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#链接器是如何工作的"><span class="nav-number">2.1.</span> <span class="nav-text">链接器是如何工作的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Link-xml文件的feature-tag"><span class="nav-number">2.2.</span> <span class="nav-text">Link.xml文件的feature tag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改Method的代码"><span class="nav-number">2.3.</span> <span class="nav-text">修改Method的代码</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
  <p class="site-author-name" itemprop="name">Ray Sun</p>
  <div class="site-description" itemprop="description">拨开互联网的迷雾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">259</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sun668" title="GitHub → https://github.com/Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <div class="wechat_channel" style="width: 50%;margin-left: 25%;">
        <br>
        <!-- 这里添加你的二维码图片 -->
        <img src="/images/wechat_channel.png">
        <!-- <span>公众号</span> -->
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray Sun</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  

  

</body>
</html>
