<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="最近在开发一个Unity人物形象的SDK，目标是该SDK可以动态下载最新的人物和服装的模型而不用让提前内置在SDK中。 一开始我打算采用的方案是传统的比较成熟的Addressables去打包bundle的方式，但是bundle的划分是个问题，而且这种方式需要每次把模型导入unity然后再出包，再更新catalog，整个流程比较繁琐。 所以我就在想，能不能直接从远程加载FBX和贴图，然后直接使用FB"><meta property="og:type" content="article"><meta property="og:title" content="Unity下TriLib远程加载FBX的使用与源码解析"><meta property="og:url" content="https://sunra.top/2022/06/03/unity-trilib-import-fbx/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="最近在开发一个Unity人物形象的SDK，目标是该SDK可以动态下载最新的人物和服装的模型而不用让提前内置在SDK中。 一开始我打算采用的方案是传统的比较成熟的Addressables去打包bundle的方式，但是bundle的划分是个问题，而且这种方式需要每次把模型导入unity然后再出包，再更新catalog，整个流程比较繁琐。 所以我就在想，能不能直接从远程加载FBX和贴图，然后直接使用FB"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png"><meta property="article:published_time" content="2022-06-02T22:31:34.000Z"><meta property="article:modified_time" content="2025-10-25T12:22:48.385Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="技术分享 使用教程 原理 前端 计算机图形学"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png"><link rel="canonical" href="https://sunra.top/2022/06/03/unity-trilib-import-fbx/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sunra.top/2022/06/03/unity-trilib-import-fbx/","path":"2022/06/03/unity-trilib-import-fbx/","title":"Unity下TriLib远程加载FBX的使用与源码解析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Unity下TriLib远程加载FBX的使用与源码解析 | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%B3%95"><span class="nav-number">1.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F"><span class="nav-number">2.</span> <span class="nav-text">使用注意</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%BE%E4%B8%8D%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84materailmapperv206"><span class="nav-number">2.1.</span> <span class="nav-text">找不到对应的MaterailMapper(v2.0.6)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%90%E8%B4%A8%E4%B8%8D%E5%AF%B9%E8%80%8C%E4%B8%94%E5%A4%9A%E4%B8%80%E4%B8%AA%E6%9D%90%E8%B4%A8v206"><span class="nav-number">2.2.</span> <span class="nav-text">材质不对，而且多一个材质(v2.0.6)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createdefaultloaderoptions"><span class="nav-number">2.2.1.</span> <span class="nav-text">CreateDefaultLoaderOptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createwebrequestmodelurl"><span class="nav-number">2.2.2.</span> <span class="nav-text">CreateWebRequest(modelUrl);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loadmodelfromuri"><span class="nav-number">2.2.3.</span> <span class="nav-text">LoadModelFromUri</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">2.2.4.</span> <span class="nav-text">总结与解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loadfbxfromzipfile%E4%B8%A2%E5%A4%B1%E8%B4%B4%E5%9B%BEv216"><span class="nav-number">2.3.</span> <span class="nav-text">loadFbxFromZipFile丢失贴图（v2.1.6）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%B4%E5%9B%BE%E7%9A%84isreadable%E4%B8%BAfalsev216"><span class="nav-number">2.4.</span> <span class="nav-text">贴图的isReadable为false（v2.1.6）</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">一起探索互联网的秘密</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">338</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sunra.top/2022/06/03/unity-trilib-import-fbx/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="一起探索互联网的秘密"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Unity下TriLib远程加载FBX的使用与源码解析 | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Unity下TriLib远程加载FBX的使用与源码解析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-06-03 06:31:34" itemprop="dateCreated datePublished" datetime="2022-06-03T06:31:34+08:00">2022-06-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-10-25 20:22:48" itemprop="dateModified" datetime="2025-10-25T20:22:48+08:00">2025-10-25</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline：</span><a title="waline" href="/2022/06/03/unity-trilib-import-fbx/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/2022/06/03/unity-trilib-import-fbx/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>最近在开发一个Unity人物形象的SDK，目标是该SDK可以动态下载最新的人物和服装的模型而不用让提前内置在SDK中。</p><p>一开始我打算采用的方案是传统的比较成熟的Addressables去打包bundle的方式，但是bundle的划分是个问题，而且这种方式需要每次把模型导入unity然后再出包，再更新catalog，整个流程比较繁琐。</p><p>所以我就在想，能不能直接从远程加载FBX和贴图，然后直接使用FBX进行加载就好，这样整个发版流程会简单很多。</p><p>经过一番查找，找到了TriLib这个仓库，他可以很方便的从远程加载模型。但是也有一些问题，为了定位这些问题，特意阅读了下源码，这里总结下，其实感觉整个仓库的逻辑是比较简单清晰的。</p><span id="more"></span><h2 id="用法"><a class="markdownIt-Anchor" href="#用法"></a> 用法</h2><p>其实TriLib的用法很简单，它一共就没给开放多少配置的能力，你导入之后，看一眼它的例子就很清晰了，但是还是简单放在这里展示下</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> TriLibCore.General;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TriLibCore.Samples</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Represents a sample that loads a compressed (Zipped) Model.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoadModelFromURLSample</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> modelUrl;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Creates the AssetLoaderOptions instance, configures the Web Request, and downloads the Model.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> You can create the AssetLoaderOptions by right clicking on the Assets Explorer and selecting &quot;TriLib-&gt;Create-&gt;AssetLoaderOptions-&gt;Pre-Built AssetLoaderOptions&quot;.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assetLoaderOptions = AssetLoader.CreateDefaultLoaderOptions();</span><br><span class="line">            <span class="keyword">var</span> webRequest = AssetDownloader.CreateWebRequest(modelUrl);</span><br><span class="line">            AssetDownloader.LoadModelFromUri(webRequest, OnLoad, OnMaterialsLoad, OnProgress, OnError, <span class="literal">null</span>, assetLoaderOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when any error occurs.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>The contextualized error, containing the original exception and the context passed to the method where the error was thrown.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnError</span>(<span class="params">IContextualizedError obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;An error ocurred while loading your Model: <span class="subst">&#123;obj.GetInnerException()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model loading progress changes.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;progress&quot;&gt;</span>The loading progress.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnProgress</span>(<span class="params">AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;Loading Model. Progress: <span class="subst">&#123;progress:P&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model (including Textures and Materials) has been fully loaded, or after any error occurs.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span>The loaded GameObject is available on the assetLoaderContext.RootGameObject field.<span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnMaterialsLoad</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Materials loaded. Model fully loaded.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model Meshes and hierarchy are loaded.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span>The loaded GameObject is available on the assetLoaderContext.RootGameObject field.<span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLoad</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Model loaded. Loading materials.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码很简单，需要注意的是，对应的下载链接下载的内容需要是一个zip文件，内部包含该模型以及模型引用的材质，贴图等等。</p><h2 id="使用注意"><a class="markdownIt-Anchor" href="#使用注意"></a> 使用注意</h2><p>上面代码是不是看起来很简单，但是你可能会发现并没有用，我就遇到了两个问题</p><h3 id="找不到对应的materailmapperv206"><a class="markdownIt-Anchor" href="#找不到对应的materailmapperv206"></a> 找不到对应的MaterailMapper(v2.0.6)</h3><p>如果你的Console里面出现了一个waring，大概意思就是找不到MaterialMapper，不要忽略这个错误，因为找不到这个东西，结果就是模型没法正确加载。</p><p>我出现这个问题是因为，我的项目是URP渲染管线的。</p><p>然后代码里面会判断你是普通渲染管线，URP还是HDRP，然后根据这个找到合适的Material去渲染模型。</p><p>其中的URP的判断逻辑如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsCompatible</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> GraphicsSettingsUtils.IsUsingUniversalPipeline;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> IsUsingUniversalPipeline =&gt; GraphicsSettings.renderPipelineAsset != <span class="literal">null</span> &amp;&amp; GraphicsSettings.renderPipelineAsset.name.StartsWith(<span class="string">&quot;UniversalRP&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>所以这个东西判断成功，你配置的URP Setting使用的文件名字必须是“UniversalRP”，而URP默认生成的叫做“UniversalRenderPipeline”，然后他就没法识别了，就没法给你的FBX添加材质</p><h3 id="材质不对而且多一个材质v206"><a class="markdownIt-Anchor" href="#材质不对而且多一个材质v206"></a> 材质不对，而且多一个材质(v2.0.6)</h3><p>到目前为止，笔者还是遇到了一个问题，就是材质除了名字，其他都是不对的，不仅属性不对，还会多一个材质，为此，笔者特地去研究了下源码是怎么回事，发现这东西是故意的。</p><p>先来解释下为什么会这样：</p><h4 id="createdefaultloaderoptions"><a class="markdownIt-Anchor" href="#createdefaultloaderoptions"></a> CreateDefaultLoaderOptions</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderOptions <span class="title">CreateDefaultLoaderOptions</span>(<span class="params"><span class="built_in">bool</span> generateAssets = <span class="literal">false</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> assetLoaderOptions = ScriptableObject.CreateInstance&lt;AssetLoaderOptions&gt;();</span><br><span class="line">    ByNameRootBoneMapper byNameRootBoneMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="keyword">if</span> (generateAssets) &#123;</span><br><span class="line">        byNameRootBoneMapper = (ByNameRootBoneMapper)LoadOrCreateScriptableObject(<span class="string">&quot;ByNameRootBoneMapper&quot;</span>, <span class="string">&quot;RootBone&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        byNameRootBoneMapper = ScriptableObject.CreateInstance&lt;ByNameRootBoneMapper&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    byNameRootBoneMapper = ScriptableObject.CreateInstance&lt;ByNameRootBoneMapper&gt;();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    byNameRootBoneMapper.name = <span class="string">&quot;ByNameRootBoneMapper&quot;</span>;</span><br><span class="line">    assetLoaderOptions.RootBoneMapper = byNameRootBoneMapper;</span><br><span class="line">    <span class="keyword">if</span> (MaterialMapper.RegisteredMappers.Count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Please add at least one MaterialMapper name to the MaterialMapper.RegisteredMappers static field to create the right MaterialMapper for the Render Pipeline you are using.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> materialMappers = <span class="keyword">new</span> List&lt;MaterialMapper&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> materialMapperName <span class="keyword">in</span> MaterialMapper.RegisteredMappers)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (materialMapperName == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            MaterialMapper materialMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">            <span class="keyword">if</span> (generateAssets)</span><br><span class="line">            &#123;</span><br><span class="line">                materialMapper = (MaterialMapper)LoadOrCreateScriptableObject(materialMapperName, <span class="string">&quot;Material&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                materialMapper = (MaterialMapper)ScriptableObject.CreateInstance(materialMapperName);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            materialMapper = ScriptableObject.CreateInstance(materialMapperName) <span class="keyword">as</span> MaterialMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">if</span> (materialMapper != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                materialMapper.name = materialMapperName;</span><br><span class="line">                <span class="keyword">if</span> (materialMapper.IsCompatible(<span class="literal">null</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    materialMappers.Add(materialMapper);</span><br><span class="line">                    assetLoaderOptions.FixedAllocations.Add(materialMapper);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">                    <span class="keyword">var</span> assetPath = AssetDatabase.GetAssetPath(materialMapper);</span><br><span class="line">                    <span class="keyword">if</span> (assetPath == <span class="literal">null</span>) &#123;</span><br><span class="line">                        Object.DestroyImmediate(materialMapper);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">                    Object.Destroy(materialMapper);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (materialMappers.Count == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="string">&quot;TriLib could not find any suitable MaterialMapper on the project.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderOptions.MaterialMappers = materialMappers.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//These two animation clip mappers are used to convert legacy to humanoid animations and add a simple generic animation playback component to the model, which will be disabled by default.</span></span><br><span class="line">    LegacyToHumanoidAnimationClipMapper legacyToHumanoidAnimationClipMapper;</span><br><span class="line">    SimpleAnimationPlayerAnimationClipMapper simpleAnimationPlayerAnimationClipMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="keyword">if</span> (generateAssets)</span><br><span class="line">    &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper = (LegacyToHumanoidAnimationClipMapper)LoadOrCreateScriptableObject(<span class="string">&quot;LegacyToHumanoidAnimationClipMapper&quot;</span>, <span class="string">&quot;AnimationClip&quot;</span>);</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper = (SimpleAnimationPlayerAnimationClipMapper)LoadOrCreateScriptableObject(<span class="string">&quot;SimpleAnimationPlayerAnimationClipMapper&quot;</span>, <span class="string">&quot;AnimationClip&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper = ScriptableObject.CreateInstance&lt;LegacyToHumanoidAnimationClipMapper&gt;();</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper = ScriptableObject.CreateInstance&lt;SimpleAnimationPlayerAnimationClipMapper&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    legacyToHumanoidAnimationClipMapper = ScriptableObject.CreateInstance&lt;LegacyToHumanoidAnimationClipMapper&gt;();</span><br><span class="line">    simpleAnimationPlayerAnimationClipMapper = ScriptableObject.CreateInstance&lt;SimpleAnimationPlayerAnimationClipMapper&gt;();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    legacyToHumanoidAnimationClipMapper.name = <span class="string">&quot;LegacyToHumanoidAnimationClipMapper&quot;</span>;</span><br><span class="line">    simpleAnimationPlayerAnimationClipMapper.name = <span class="string">&quot;SimpleAnimationPlayerAnimationClipMapper&quot;</span>;</span><br><span class="line">    assetLoaderOptions.AnimationClipMappers = <span class="keyword">new</span> AnimationClipMapper[]</span><br><span class="line">    &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper,</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper</span><br><span class="line">    &#125;;</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(assetLoaderOptions);</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(legacyToHumanoidAnimationClipMapper);</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(simpleAnimationPlayerAnimationClipMapper);</span><br><span class="line">    <span class="keyword">return</span> assetLoaderOptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码首先主要干了三件事，分别是找到合适的<code>RootBoneMapper</code>,<code>MaterialMapper</code>,<code>AnimationPlayerAninamtionClipMapper</code>。</p><p>我们以其中MaterialMapper举例，这个工具导入的模型的时候，是不会导入Material的，那就需要工具帮忙创建一个Material，那么Trilib如何确定使用什么样的Material呢？这就是刚才那个问题上说的。</p><p>比如我们使用的是URP，最终选择的MaterialMapper就是<code>UniversalRPMaterialMapper</code>。</p><p>其代码如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UniversalRPMaterialMapper</span> : <span class="title">MaterialMapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">UniversalRPMaterialMapper</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AddToRegisteredMappers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">RuntimeInitializeOnLoadMethod</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddToRegisteredMappers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (RegisteredMappers.Contains(<span class="string">&quot;UniversalRPMaterialMapper&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RegisteredMappers.Add(<span class="string">&quot;UniversalRPMaterialMapper&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material MaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material AlphaMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaCutout&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material AlphaMaterialPreset2 =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlpha&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularAlphaMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaCutoutSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularAlphaMaterialPreset2 =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material LoadingMaterial =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPLoading&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsCompatible</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GraphicsSettingsUtils.IsUsingUniversalPipeline;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Map</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial = <span class="keyword">new</span> VirtualMaterial();</span><br><span class="line">        CheckDiffuseMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckDiffuseMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> diffuseTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.DiffuseTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(diffuseTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Diffuse, materialMapperContext.Material.GetTextureValue(diffuseTexturePropertyName), ApplyDiffuseMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyDiffuseMapTexture(materialMapperContext, TextureType.Diffuse, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyDiffuseMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseMap&quot;</span>, texture);</span><br><span class="line">        CheckGlossinessValue(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckGlossinessValue</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.Glossiness, materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.Glossiness));</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_Glossiness&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        CheckMetallicValue(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckMetallicValue</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.Metallic);</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_Metallic&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        CheckEmissionMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckEmissionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> emissionTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.EmissionTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(emissionTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Emission, materialMapperContext.Material.GetTextureValue(emissionTexturePropertyName), ApplyEmissionMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyEmissionMapTexture(materialMapperContext, TextureType.Emission, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyEmissionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_EmissionMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.RealtimeEmissive;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.EmissiveIsBlack;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckNormalMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckNormalMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> normalMapTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.NormalTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(normalMapTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.NormalMap, materialMapperContext.Material.GetTextureValue(normalMapTexturePropertyName), ApplyNormalMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyNormalMapTexture(materialMapperContext, TextureType.NormalMap, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyNormalMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BumpMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_NORMALMAP&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_NormalScale&quot;</span>, materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.NormalTexture, <span class="number">1f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_NORMALMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSpecularTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckSpecularTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> specularTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.SpecularTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(specularTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Specular, materialMapperContext.Material.GetTextureValue(specularTexturePropertyName), ApplySpecGlossMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpecGlossMapTexture(materialMapperContext, TextureType.Specular, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplySpecGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_SpecGlossMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_METALLICSPECGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_METALLICSPECGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckOcclusionMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckOcclusionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> occlusionMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.OcclusionTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(occlusionMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Occlusion, materialMapperContext.Material.GetTextureValue(occlusionMapTextureName), ApplyOcclusionMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyOcclusionMapTexture(materialMapperContext, TextureType.Occlusion, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyOcclusionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_OcclusionMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_OCCLUSIONMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_OCCLUSIONMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckParallaxMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckParallaxMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> parallaxMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.ParallaxMap);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(parallaxMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Parallax, materialMapperContext.Material.GetTextureValue(parallaxMapTextureName), ApplyParallaxMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyParallaxMapTexture(materialMapperContext, TextureType.Parallax, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyParallaxMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_ParallaxMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_PARALLAXMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_PARALLAXMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckMetallicGlossMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckMetallicGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> metallicGlossMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.MetallicGlossMap);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(metallicGlossMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Metalness, materialMapperContext.Material.GetTextureValue(metallicGlossMapTextureName), ApplyMetallicGlossMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyMetallicGlossMapTexture(materialMapperContext, TextureType.Metalness, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyMetallicGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_MetallicGlossMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_METALLICGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_METALLICGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckEmissionColor(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckEmissionColor</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericColorValue(GenericMaterialProperty.EmissionColor) * materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.EmissionColor, <span class="number">1f</span>);</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_EmissionColor&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">value</span> != Color.black)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.RealtimeEmissive;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.EmissiveIsBlack;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckDiffuseColor(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckDiffuseColor</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericColorValue(GenericMaterialProperty.DiffuseColor) * materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.DiffuseColor, <span class="number">1f</span>);</span><br><span class="line">        <span class="keyword">value</span>.a *= materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.AlphaValue);</span><br><span class="line">        <span class="keyword">if</span> (!materialMapperContext.VirtualMaterial.HasAlpha &amp;&amp; <span class="keyword">value</span>.a &lt; <span class="number">1f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.HasAlpha = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseColor&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        BuildMaterial(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码中对应的那些预设我们可以直接在文件夹中看到：</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png" alt></p><p>而每个Mapper首先构造函数中会将自己的加入到<code>MaterialMapper.RegisteredMappers</code>中，只有在这个变量中，才会进入待选择的列表</p><p>而每个Mapper对外暴露的方法只有两个，一个是<code>IsCompatible</code>，也就是使用注意第一个问题中涉及到的变量，另外一个就是<code>Map</code>，在该函数中，会顺序调用所有的私有函数，每个函数分别去检查FBX文件中的某个属性，然后去设置最终使用的Material的属性。</p><p>最终会调用到<code>BuildMaterial</code>方法，这个方法的定义很简单：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildMaterial</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span> =&gt; materialMapperContext.UnityMaterial = <span class="keyword">this</span>.InstantiateSuitableMaterial(materialMapperContext);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Material <span class="title">InstantiateSuitableMaterial</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Material material;</span><br><span class="line">    <span class="keyword">if</span> (!materialMapperContext.Context.LoadedMaterials.TryGetValue(materialMapperContext.Material, <span class="keyword">out</span> material))</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">bool</span> flag = materialMapperContext.Context.Options.UseAlphaMaterials &amp;&amp; materialMapperContext.VirtualMaterial.HasAlpha &amp;&amp; !<span class="keyword">this</span>.ForceStandardMaterial;</span><br><span class="line">    <span class="keyword">if</span> (materialMapperContext.Material.MaterialShadingSetup == MaterialShadingSetup.Specular)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((UnityEngine.Object) <span class="keyword">this</span>.SpecularAlphaMaterialPreset != (UnityEngine.Object) <span class="literal">null</span> &amp; flag)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(<span class="keyword">this</span>.SpecularAlphaMaterialPreset);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((UnityEngine.Object) <span class="keyword">this</span>.SpecularMaterialPreset != (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(<span class="keyword">this</span>.SpecularMaterialPreset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((UnityEngine.Object) material == (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(flag ? <span class="keyword">this</span>.AlphaMaterialPreset : <span class="keyword">this</span>.MaterialPreset);</span><br><span class="line">    MaterialMapper.ApplyMaterialProperties(materialMapperContext, material);</span><br><span class="line">    materialMapperContext.Context.LoadedMaterials.Add(materialMapperContext.Material, material);</span><br><span class="line">    materialMapperContext.Context.Allocations.Add((UnityEngine.Object) material);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> material;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们加载FBX的时候，也加载进了material，也就是能直接从<code>LoadedMaterials</code>变量中获取到，那就直接使用，如果不行，那就从预设选择一个创建Material。</p><p>我们最终模型中的第一个材质就是这么来的，至于该方法何时调用下面再讲。</p><h4 id="createwebrequestmodelurl"><a class="markdownIt-Anchor" href="#createwebrequestmodelurl"></a> CreateWebRequest(modelUrl);</h4><p>这个方法没啥好讲的，就是创建UnityWebRequest</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UnityWebRequest <span class="title">CreateWebRequest</span>(<span class="params"><span class="built_in">string</span> uri, HttpRequestMethod httpRequestMethod = HttpRequestMethod.Get, <span class="built_in">string</span> data = <span class="literal">null</span>, <span class="built_in">int</span> timeout = <span class="number">2000</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    UnityWebRequest unityWebRequest;</span><br><span class="line">    <span class="keyword">switch</span> (httpRequestMethod)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Post:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Post(uri, data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Put:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Put(uri, data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Delete:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Delete(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Head:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Head(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Get(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    unityWebRequest.timeout = timeout;</span><br><span class="line">    <span class="keyword">return</span> unityWebRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="loadmodelfromuri"><a class="markdownIt-Anchor" href="#loadmodelfromuri"></a> LoadModelFromUri</h4><p>该方法是核心，其定义为：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Coroutine <span class="title">LoadModelFromUri</span>(<span class="params">UnityWebRequest unityWebRequest, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span>, <span class="built_in">bool</span>? isZipFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> assetDownloader = <span class="keyword">new</span> GameObject(<span class="string">&quot;Asset Downloader&quot;</span>).AddComponent&lt;AssetDownloaderBehaviour&gt;();</span><br><span class="line">    <span class="keyword">return</span> assetDownloader.StartCoroutine(assetDownloader.DownloadAsset(unityWebRequest, onLoad, onMaterialsLoad, onProgress, wrapperGameObject, onError, assetLoaderOptions, customContextData, fileExtension, isZipFile));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>该方法主要是调用了DownloadAsset：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IEnumerator <span class="title">DownloadAsset</span>(<span class="params">UnityWebRequest unityWebRequest, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, GameObject wrapperGameObject, Action&lt;IContextualizedError&gt; onError, AssetLoaderOptions assetLoaderOptions, <span class="built_in">object</span> customContextData, <span class="built_in">string</span> fileExtension, <span class="built_in">bool</span>? isZipFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _unityWebRequest = unityWebRequest;</span><br><span class="line">    _onProgress = onProgress;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> unityWebRequest.SendWebRequest();</span><br><span class="line">    <span class="keyword">if</span> (unityWebRequest.responseCode &lt; <span class="number">400</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream(_unityWebRequest.downloadHandler.data);</span><br><span class="line">        <span class="keyword">var</span> uriLoadCustomContextData = <span class="keyword">new</span> UriLoadCustomContextData</span><br><span class="line">        &#123;</span><br><span class="line">            UnityWebRequest = _unityWebRequest,</span><br><span class="line">            CustomData = customContextData</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> contentType = unityWebRequest.GetResponseHeader(<span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (contentType != <span class="literal">null</span> &amp;&amp; isZipFile == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            isZipFile = contentType.Contains(<span class="string">&quot;application/zip&quot;</span>) || contentType.Contains(<span class="string">&quot;application/x-zip-compressed&quot;</span>) || contentType.Contains(<span class="string">&quot;multipart/x-zip&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isZipFile.GetValueOrDefault())</span><br><span class="line">        &#123;</span><br><span class="line">            _assetLoaderContext = AssetLoaderZip.LoadModelFromZipStream(memoryStream, onLoad, onMaterialsLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress) &#123; onProgress?.Invoke(assetLoaderContext, <span class="number">0.5f</span> + progress * <span class="number">0.5f</span>); &#125;, onError, wrapperGameObject, assetLoaderOptions, uriLoadCustomContextData, fileExtension);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _assetLoaderContext = AssetLoader.LoadModelFromStream(memoryStream, <span class="literal">null</span>, fileExtension, onLoad, onMaterialsLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress) &#123; onProgress?.Invoke(assetLoaderContext, <span class="number">0.5f</span> + progress * <span class="number">0.5f</span>); &#125;, onError, wrapperGameObject, assetLoaderOptions, uriLoadCustomContextData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> exception = <span class="keyword">new</span> Exception(<span class="string">$&quot;UnityWebRequest error:<span class="subst">&#123;unityWebRequest.error&#125;</span>, code:<span class="subst">&#123;unityWebRequest.responseCode&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (onError != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> contextualizedError = exception <span class="keyword">as</span> IContextualizedError;</span><br><span class="line">            onError(contextualizedError ?? <span class="keyword">new</span> ContextualizedError&lt;AssetLoaderContext&gt;(exception, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Destroy(gameObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为我们的是zip文件，所以走进逻辑：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderContext <span class="title">LoadModelFromZipStream</span>(<span class="params">Stream stream, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> memoryStream = SetupZipModelLoading(<span class="keyword">ref</span> stream, <span class="literal">null</span>, onError, assetLoaderOptions, <span class="keyword">ref</span> fileExtension, <span class="keyword">out</span> <span class="keyword">var</span> zipFile);</span><br><span class="line">    <span class="keyword">return</span> AssetLoader.LoadModelFromStream(memoryStream, <span class="literal">null</span>, fileExtension, onLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> zipLoadCustomContextData = assetLoaderContext.CustomData <span class="keyword">as</span> ZipLoadCustomContextData;</span><br><span class="line">        zipLoadCustomContextData?.Stream.Close();</span><br><span class="line">        onMaterialsLoad?.Invoke(assetLoaderContext);</span><br><span class="line">    &#125;, onProgress, OnError, wrapperGameObject, assetLoaderOptions, <span class="keyword">new</span> ZipLoadCustomContextData</span><br><span class="line">    &#123;</span><br><span class="line">        ZipFile = zipFile,</span><br><span class="line">        Stream = stream,</span><br><span class="line">        CustomData = customContextData</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续调用<code>LoadModelFromStream</code>:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderContext <span class="title">LoadModelFromStream</span>(<span class="params">Stream stream, <span class="built_in">string</span> filename = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span>, Action&lt;AssetLoaderContext&gt; onLoad = <span class="literal">null</span>, Action&lt;AssetLoaderContext&gt; onMaterialsLoad = <span class="literal">null</span>, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress = <span class="literal">null</span>, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_WEBGL || UNITY_UWP</span></span><br><span class="line">    AssetLoaderContext assetLoaderContext = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        assetLoaderContext = LoadModelFromStreamNoThread(stream, filename, fileExtension, onError, wrapperGameObject, assetLoaderOptions, customContextData);</span><br><span class="line">        onLoad(assetLoaderContext);</span><br><span class="line">        onMaterialsLoad(assetLoaderContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (exception <span class="keyword">is</span> IContextualizedError contextualizedError)</span><br><span class="line">        &#123;</span><br><span class="line">            HandleError(contextualizedError);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            HandleError(<span class="keyword">new</span> ContextualizedError&lt;AssetLoaderContext&gt;(exception, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> assetLoaderContext;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">var</span> assetLoaderContext = <span class="keyword">new</span> AssetLoaderContext</span><br><span class="line">    &#123;</span><br><span class="line">        Options = assetLoaderOptions == <span class="literal">null</span> ? CreateDefaultLoaderOptions() : assetLoaderOptions,</span><br><span class="line">        Stream = stream,</span><br><span class="line">        FileExtension = fileExtension ?? FileUtils.GetFileExtension(filename, <span class="literal">false</span>),</span><br><span class="line">        BasePath = FileUtils.GetFileDirectory(filename),</span><br><span class="line">        WrapperGameObject = wrapperGameObject,</span><br><span class="line">        OnMaterialsLoad = onMaterialsLoad,</span><br><span class="line">        OnLoad = onLoad,</span><br><span class="line">        HandleError = HandleError,</span><br><span class="line">        OnError = onError,</span><br><span class="line">        CustomData = customContextData</span><br><span class="line">    &#125;;</span><br><span class="line">    assetLoaderContext.Tasks.Add(ThreadUtils.RunThread(assetLoaderContext, <span class="keyword">ref</span> assetLoaderContext.CancellationToken, LoadModel, ProcessRootModel, HandleError, assetLoaderContext.Options.Timeout));</span><br><span class="line">    <span class="keyword">return</span> assetLoaderContext;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里主要是开了个Thread去分别调用LoadModel以及ProcessRootModel</p><p>LoadModel内容比较容易理解，就是读取FBX内容，不过这一步读出的很多属性对后续的处理有很大的影响，也是为什么我会有第二个材质，并且决定了我的第二个材质是怎么选择的</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadModel</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Options.MaterialMappers != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Array.Sort(assetLoaderContext.Options.MaterialMappers, (a, b) =&gt; a.CheckingOrder &gt; b.CheckingOrder ? <span class="number">-1</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (assetLoaderContext.Options.ShowLoadingWarnings)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Your AssetLoaderOptions instance has no MaterialMappers. TriLib can&#x27;t process materials without them.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRILIB_DRACO</span></span><br><span class="line">    GltfReader.DracoDecompressorCallback = DracoMeshLoader.DracoDecompressorCallback;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">var</span> fileExtension = assetLoaderContext.FileExtension ?? FileUtils.GetFileExtension(assetLoaderContext.Filename, <span class="literal">false</span>).ToLowerInvariant();</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Stream == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> fileStream = <span class="keyword">new</span> FileStream(assetLoaderContext.Filename, FileMode.Open);</span><br><span class="line">        assetLoaderContext.Stream = fileStream;</span><br><span class="line">        <span class="keyword">var</span> reader = Readers.FindReaderForExtension(fileExtension);</span><br><span class="line">        <span class="keyword">if</span> (reader != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderContext.RootModel = reader.ReadStream(fileStream, assetLoaderContext, assetLoaderContext.Filename, assetLoaderContext.OnProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> reader = Readers.FindReaderForExtension(fileExtension);</span><br><span class="line">        <span class="keyword">if</span> (reader != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderContext.RootModel = reader.ReadStream(assetLoaderContext.Stream, assetLoaderContext, <span class="literal">null</span>, assetLoaderContext.OnProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后是ProcessRootModel，该函数首先是调用ProcessModel递归引入Model，然后ProcessTextures再处理贴图</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessRootModel</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ProcessModel(assetLoaderContext);</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Async)</span><br><span class="line">    &#123;</span><br><span class="line">        ThreadUtils.RunThread(assetLoaderContext, <span class="keyword">ref</span> assetLoaderContext.CancellationToken, ProcessTextures, <span class="literal">null</span>, assetLoaderContext.HandleError ?? assetLoaderContext.OnError, assetLoaderContext.Options.Timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ProcessTextures(assetLoaderContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessTextures的最后一步是ProcessMaterial，在这里就调用了我们之前选择出来的MaterialMapper的Map方法：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessMaterials</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Options.MaterialMappers != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> material <span class="keyword">in</span> assetLoaderContext.RootModel.AllMaterials)</span><br><span class="line">        &#123;</span><br><span class="line">            MaterialMapper usedMaterialMapper = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> materialMapperContext = <span class="keyword">new</span> MaterialMapperContext</span><br><span class="line">            &#123;</span><br><span class="line">                Context = assetLoaderContext,</span><br><span class="line">                Material = material</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> materialMapper <span class="keyword">in</span> assetLoaderContext.Options.MaterialMappers)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (materialMapper == <span class="literal">null</span> || !materialMapper.IsCompatible(materialMapperContext))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                materialMapper.Map(materialMapperContext);</span><br><span class="line">                usedMaterialMapper = materialMapper;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (usedMaterialMapper != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (assetLoaderContext.MaterialRenderers.TryGetValue(material, <span class="keyword">out</span> <span class="keyword">var</span> materialRendererList))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> materialRendererContext <span class="keyword">in</span> materialRendererList)</span><br><span class="line">                    &#123;</span><br><span class="line">                        usedMaterialMapper.ApplyMaterialToRenderer(materialRendererContext, materialMapperContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (assetLoaderContext.Options.ShowLoadingWarnings)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;The given AssetLoaderOptions contains no MaterialMapper. Materials will not be created.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时注意这里还调用了<code>ApplyMaterialToRenderer</code>方法，这个方法又创建了一个新的Material出来：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ApplyMaterialToRenderer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      MaterialRendererContext materialRendererContext,</span></span></span><br><span class="line"><span class="params"><span class="function">      MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Material[] sharedMaterials = materialRendererContext.Renderer.sharedMaterials;</span><br><span class="line">    sharedMaterials[materialRendererContext.MaterialIndex] = materialMapperContext.UnityMaterial;</span><br><span class="line">    materialRendererContext.Renderer.sharedMaterials = sharedMaterials;</span><br><span class="line">    <span class="keyword">if</span> ((!materialMapperContext.Context.Options.UseAlphaMaterials || !materialMapperContext.VirtualMaterial.HasAlpha ? <span class="number">0</span> : (!<span class="keyword">this</span>.ForceStandardMaterial ? <span class="number">1</span> : <span class="number">0</span>)) == <span class="number">0</span> || !materialMapperContext.Context.Options.AddSecondAlphaMaterial)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    MeshFilter componentInChildren1 = materialRendererContext.Renderer.GetComponentInChildren&lt;MeshFilter&gt;();</span><br><span class="line">    SkinnedMeshRenderer componentInChildren2 = materialRendererContext.Renderer.GetComponentInChildren&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">    Mesh mesh = (UnityEngine.Object) componentInChildren1 != (UnityEngine.Object) <span class="literal">null</span> ? componentInChildren1.sharedMesh : componentInChildren2?.sharedMesh;</span><br><span class="line">    <span class="keyword">if</span> (!((UnityEngine.Object) mesh != (UnityEngine.Object) <span class="literal">null</span>))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    Material material = <span class="keyword">this</span>.InstantiateSuitableSecondPassMaterial(materialMapperContext);</span><br><span class="line">    <span class="keyword">if</span> ((UnityEngine.Object) material == (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">int</span>[] triangles = mesh.GetTriangles(materialRendererContext.MaterialIndex);</span><br><span class="line">    ++mesh.subMeshCount;</span><br><span class="line">    mesh.SetTriangles(triangles, mesh.subMeshCount - <span class="number">1</span>);</span><br><span class="line">    List&lt;Material&gt; m = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line">    materialRendererContext.Renderer.GetSharedMaterials(m);</span><br><span class="line">    m.Add(material);</span><br><span class="line">    materialRendererContext.Renderer.materials = m.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后三行，先为m添加了sharedMaterilas，然后又Add了一个创建的Material，最终一起赋值给Render.materials</p><h4 id="总结与解决方案"><a class="markdownIt-Anchor" href="#总结与解决方案"></a> 总结与解决方案</h4><p>两个材质出现的简单调用流程可以这样总结：</p><ul><li>CreateDefaultLoaderOptions的时候选择了一个MaterialMapper</li><li>模型下载成功后，通过LoadModel方法导入</li><li>LoadModel成功后，ProcessRootModel调用ProcessModel来处理Model的属性，使用ProcessTexture来处理贴图</li><li>ProcessTextures最终会调用ProcessMaterial</li><li>ProcessMaterial首先会调用第一步选择出来的MaterialMapper的Map方法，创建一个材质出来，然后会调用MaterialMapper的ApplyMaterialToRenderer又创建处一个材质。这两步创建的材质都是根据从事先设置好的模版中选择了一个，而选择的依据是LoadModel导入时自带的那些配置。</li></ul><p>解决方案是，在第一步创建assetOptions的时候，把useAlpha那个属性设置为false（默认为true）</p><h3 id="loadfbxfromzipfile丢失贴图v216"><a class="markdownIt-Anchor" href="#loadfbxfromzipfile丢失贴图v216"></a> loadFbxFromZipFile丢失贴图（v2.1.6）</h3><p>当你成功将fbx导入后，你会发现，你的材质中可能没有贴图，这个时候需要检查zip包中的贴图名称是否正确，即你的fbx中指定的贴图名称是什么，你的实际的贴图名称就要是什么，trilib是通过文件名进行映射的。</p><h3 id="贴图的isreadable为falsev216"><a class="markdownIt-Anchor" href="#贴图的isreadable为falsev216"></a> 贴图的isReadable为false（v2.1.6）</h3><p>在升级成2.1.6版本之后，trilib的导入的材质中的贴图是无法读取的，也就是说<code>Read/Write Enable</code>是没有勾选的那种。</p><p>这个可以看到官方文档上说，这个是故意的，而且没有选项可以修改这个配置，那么我们就只能去修改它的底层代码了。</p><p>最后我选择的是改变MaterialMapper中的<code>ApplyDiffuseMapTexture</code>方法，因为我的项目时URP项目，所以修改的是UniversalUniversalRPMaterialMapper</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyDiffuseMapTexture</span>(<span class="params">TextureLoadingContext textureLoadingContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (textureLoadingContext.UnityTexture != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Texture2D unityTexture = <span class="keyword">new</span> Texture2D(textureLoadingContext.UnityTexture.width, textureLoadingContext.UnityTexture.height, textureLoadingContext.UnityTexture.graphicsFormat, textureLoadingContext.UnityTexture.mipmapCount, TextureCreationFlags.None);</span><br><span class="line"></span><br><span class="line">        Graphics.CopyTexture(textureLoadingContext.UnityTexture, unityTexture);</span><br><span class="line">        DestroyImmediate(textureLoadingContext.UnityTexture);</span><br><span class="line">        textureLoadingContext.UnityTexture = unityTexture;</span><br><span class="line">        textureLoadingContext.Context.AddUsedTexture(textureLoadingContext.UnityTexture);</span><br><span class="line">    &#125;</span><br><span class="line">    textureLoadingContext.MaterialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseMap&quot;</span>, textureLoadingContext.UnityTexture, GenericMaterialProperty.DiffuseMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Ray Sun</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://sunra.top/2022/06/03/unity-trilib-import-fbx/" title="Unity下TriLib远程加载FBX的使用与源码解析">https://sunra.top/2022/06/03/unity-trilib-import-fbx/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/05/21/unity-render-pipeline-9/" rel="prev" title="Unity 渲染原理（九）Unity光照模型"><i class="fa fa-chevron-left"></i> Unity 渲染原理（九）Unity光照模型</a></div><div class="post-nav-item"> <a href="/2022/06/11/operating-system-note-9-process-dispatch/" rel="next" title="操作系统学习笔记（三）进程的调度，同步/互斥与死锁">操作系统学习笔记（三）进程的调度，同步/互斥与死锁<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2022/06/03/unity-trilib-import-fbx/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>