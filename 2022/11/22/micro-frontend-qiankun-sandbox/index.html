<!DOCTYPE html>
<html lang>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunra.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="为什么需要微前端微前端其实诞生两个大的背景下，在提倡拥抱变化的前端社区可以看到新的框架、技术、概念层出不穷，并且随着WEB标准的演进，前端应用已经具备更好的性能、更快的开发效率。但随着而来的是应用的复杂程度更高、涉及的团队规模更广、更高的性能要求，应用复杂度已经成为阻塞业务发展的重要瓶颈。如何让现有系统拥抱最新技术提高生产力、并且解耦单体应用，是现在前端工程不得不面临的挑战。">
<meta property="og:type" content="article">
<meta property="og:title" content="微前端框架 Qiankun 沙箱原理">
<meta property="og:url" content="https://sunra.top/2022/11/22/micro-frontend-qiankun-sandbox/index.html">
<meta property="og:site_name" content="Origin of Ray">
<meta property="og:description" content="为什么需要微前端微前端其实诞生两个大的背景下，在提倡拥抱变化的前端社区可以看到新的框架、技术、概念层出不穷，并且随着WEB标准的演进，前端应用已经具备更好的性能、更快的开发效率。但随着而来的是应用的复杂程度更高、涉及的团队规模更广、更高的性能要求，应用复杂度已经成为阻塞业务发展的重要瓶颈。如何让现有系统拥抱最新技术提高生产力、并且解耦单体应用，是现在前端工程不得不面临的挑战。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2023-05-16T06:22:36.896Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微前端框架 Qiankun 沙箱原理">
<meta name="twitter:description" content="为什么需要微前端微前端其实诞生两个大的背景下，在提倡拥抱变化的前端社区可以看到新的框架、技术、概念层出不穷，并且随着WEB标准的演进，前端应用已经具备更好的性能、更快的开发效率。但随着而来的是应用的复杂程度更高、涉及的团队规模更广、更高的性能要求，应用复杂度已经成为阻塞业务发展的重要瓶颈。如何让现有系统拥抱最新技术提高生产力、并且解耦单体应用，是现在前端工程不得不面临的挑战。">

<link rel="canonical" href="https://sunra.top/2022/11/22/micro-frontend-qiankun-sandbox/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>微前端框架 Qiankun 沙箱原理 | Origin of Ray</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KEJ1L66CKC');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Origin of Ray</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://sunra.top/2022/11/22/micro-frontend-qiankun-sandbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
      <meta itemprop="name" content="Ray Sun">
      <meta itemprop="description" content="拨开互联网的迷雾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Origin of Ray">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微前端框架 Qiankun 沙箱原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-22 10:20:26" itemprop="dateCreated datePublished" datetime="2022-11-22T10:20:26+08:00">2022-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-16 14:22:36" itemprop="dateModified" datetime="2023-05-16T14:22:36+08:00">2023-05-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="为什么需要微前端"><a href="#为什么需要微前端" class="headerlink" title="为什么需要微前端"></a>为什么需要微前端</h2><p>微前端其实诞生两个大的背景下，在提倡拥抱变化的前端社区可以看到新的框架、技术、概念层出不穷，并且随着WEB标准的演进，前端应用已经具备更好的性能、更快的开发效率。但随着而来的是应用的复杂程度更高、涉及的团队规模更广、更高的性能要求，应用复杂度已经成为阻塞业务发展的重要瓶颈。如何让现有系统拥抱最新技术提高生产力、并且解耦单体应用，是现在前端工程不得不面临的挑战。</p>
<a id="more"></a>
<p>如果你遇到以下的情况，可能你需要微前端：</p>
<ul>
<li>你的单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用后，随之而来的应用不可维护的问题</li>
<li>作为一个门户网站，需要集成很多的系统，这些系统由不同的团队维护、有风格各异的代码、有形形色色的技术栈，为了聚合只能采取iframe或者使用MPA的形式进行聚合</li>
</ul>
<h2 id="为什么需要沙箱"><a href="#为什么需要沙箱" class="headerlink" title="为什么需要沙箱"></a>为什么需要沙箱</h2><p>在微前端的场景，由于多个独立的应用被组织到了一起，在没有类似iframe的原生隔离下，势必会出现冲突，如全局变量冲突、样式冲突，这些冲突可能会导致应用样式异常，甚至功能不可用。所以想让微前端达到生产可用的程度，让每个子应用之间达到一定程度隔离的沙箱机制是必不可少的。</p>
<h2 id="如何实现一个沙箱"><a href="#如何实现一个沙箱" class="headerlink" title="如何实现一个沙箱"></a>如何实现一个沙箱</h2><h3 id="手动执行代码"><a href="#手动执行代码" class="headerlink" title="手动执行代码"></a>手动执行代码</h3><p>常规的脚本加载，是通过script标签去执行的，要实现沙箱，因为需要控制沙箱的开启和关闭，我们就需要精确掌握脚本的执行时机，所以我们需要寻找一种合适的能手动执行代码的方法</p>
<p>首先我们想到的是eval，由于eval有安全、性能等问题，同时也不利于调试，所以在以前我们听到的都是不推荐使用eval这个api。</p>
<p>但是在微前端的沙箱场景，eval确实是一个比较好的解决方案，比如qiankun就采用了eval作为代码执行器。</p>
<p>new Function通过传入一个string作为函数的的主体同时返回一个新函数，可以作为eval的一个替代品</p>
<p>对比eval，有两点比较重要的不同：</p>
<ul>
<li>不能访问当前环境的变量，但是可以访问全局变量，安全性更高</li>
<li>仅需要处理传入的字符串一次，后面重复执行都是同一个函数，而eval需要每次都处理，性能更高</li>
</ul>
<h3 id="快照沙箱"><a href="#快照沙箱" class="headerlink" title="快照沙箱"></a>快照沙箱</h3><p>顾名思义，即在某个阶段给当前的运行环境打一个快照，再在需要的时候把快照恢复，从而实现隔离。</p>
<p>这个东西的原理和操作系统中的CPU进程切换很像，每个进程获得CPU使用权时把PCB（进程控制块）中的上下文装载到对应的寄存器中，然后CPU开始继续执行，等到失去使用权时再将当前寄存器中的信息重新保存回PCB中。快照沙箱也是这样，对于每一个子应用，运行时将其内部保存的上下文加载到对应的变量上，销毁时再将当前浏览器环境中各个变量的值保存到快照中。</p>
<p>我们来看一下qiankun中快照沙箱的源码，源码上添加了我的注释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author <span class="variable">Hydrogen</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since </span>2020-3-8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> type &#123; SandBox &#125; <span class="keyword">from</span> <span class="string">'../interfaces'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SandBoxType &#125; <span class="keyword">from</span> <span class="string">'../interfaces'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span>(<span class="params">obj: typeof window, callbackFn: (prop: any</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// eslint-disable-next-line guard-for-in, no-restricted-syntax</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// patch for clearInterval for compatible reason, see #1490</span></span><br><span class="line">    <span class="keyword">if</span> (obj.hasOwnProperty(prop) || prop === <span class="string">'clearInterval'</span>) &#123;</span><br><span class="line">      callbackFn(prop);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 diff 方式实现的沙箱，用于不支持 Proxy 的低版本浏览器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">SnapshotSandbox</span> <span class="title">implements</span> <span class="title">SandBox</span> </span>&#123;</span><br><span class="line">  proxy: WindowProxy;</span><br><span class="line"></span><br><span class="line">  name: string;</span><br><span class="line"></span><br><span class="line">  type: SandBoxType;</span><br><span class="line"></span><br><span class="line">  sandboxRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// windows对象的快照，用于保存当前沙盒active之前的window对象的状态</span></span><br><span class="line">  private windowSnapshot!: Window;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当前沙盒在active和inactive之间window对象上修改过的值</span></span><br><span class="line">  private modifyPropsMap: Record&lt;any, any&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(name: string) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.proxy = <span class="built_in">window</span>;</span><br><span class="line">    <span class="keyword">this</span>.type = SandBoxType.Snapshot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  active() &#123;</span><br><span class="line">    <span class="comment">// 记录当前快照，用于在inactive时比较哪些属性发生了变化</span></span><br><span class="line">    <span class="keyword">this</span>.windowSnapshot = &#123;&#125; <span class="keyword">as</span> Window;</span><br><span class="line">    iter(<span class="built_in">window</span>, (prop) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.windowSnapshot[prop] = <span class="built_in">window</span>[prop];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复之前的变更，也就是上一次active和inactive之间修改过的变量</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.modifyPropsMap).forEach(<span class="function">(<span class="params">p: any</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>[p] = <span class="keyword">this</span>.modifyPropsMap[p];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.sandboxRunning = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  inactive() &#123;</span><br><span class="line">    <span class="keyword">this</span>.modifyPropsMap = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 比较当前window对象上的属性和active之前的window对象上的属性，如果有不同，记录进modifyPropsMap中，下次在active时重新赋值回window</span></span><br><span class="line">    iter(<span class="built_in">window</span>, (prop) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">window</span>[prop] !== <span class="keyword">this</span>.windowSnapshot[prop]) &#123;</span><br><span class="line">        <span class="comment">// 记录变更，恢复环境</span></span><br><span class="line">        <span class="keyword">this</span>.modifyPropsMap[prop] = <span class="built_in">window</span>[prop];</span><br><span class="line">        <span class="built_in">window</span>[prop] = <span class="keyword">this</span>.windowSnapshot[prop];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.info(<span class="string">`[qiankun:sandbox] <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> origin window restore...`</span>, <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.modifyPropsMap));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.sandboxRunning = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代理沙箱"><a href="#代理沙箱" class="headerlink" title="代理沙箱"></a>代理沙箱</h3><p>代理沙箱主要是通过为每个沙盒创建一个fakeWindow，然后为这个fakeWindow设置代理，通过代理来访问这个fakeWindow，所以它的源码主要分为两部分：</p>
<ul>
<li>通过<code>createFakeWindow</code>函数创建一个fakeWindow，这个fakeWindow上只会克隆window对象上可以修改的属性</li>
<li>创建ProxySandbox类，内部使用<code>createFakeWindow</code>创建的fakeWindow</li>
</ul>
<p>我们先看一下<code>createFakeWindow</code>，说起来这个函数做的事情就是它注释上说的：<code>copy the non-configurable property of global to fakeWindow</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFakeWindow</span>(<span class="params">globalContext: Window</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// map always has the fastest performance in has check scenario</span></span><br><span class="line">  <span class="comment">// see https://jsperf.com/array-indexof-vs-set-has/23</span></span><br><span class="line">  <span class="keyword">const</span> propertiesWithGetter = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;PropertyKey, boolean&gt;();</span><br><span class="line">  <span class="keyword">const</span> fakeWindow = &#123;&#125; <span class="keyword">as</span> FakeWindow;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   copy the non-configurable property of global to fakeWindow</span></span><br><span class="line"><span class="comment">   see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor</span></span><br><span class="line"><span class="comment">   &gt; A property cannot be reported as non-configurable, if it does not exist as an own property of the target object or if it exists as a configurable own property of the target object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">Object</span>.getOwnPropertyNames(globalContext)</span><br><span class="line">    .filter(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(globalContext, p);</span><br><span class="line">      <span class="keyword">return</span> !descriptor?.configurable;</span><br><span class="line">    &#125;)</span><br><span class="line">    .forEach(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(globalContext, p);</span><br><span class="line">      <span class="keyword">if</span> (descriptor) &#123;</span><br><span class="line">        <span class="keyword">const</span> hasGetter = <span class="built_in">Object</span>.prototype.hasOwnProperty.call(descriptor, <span class="string">'get'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         make top/self/window property configurable and writable, otherwise it will cause TypeError while get trap return.</span></span><br><span class="line"><span class="comment">         see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/get</span></span><br><span class="line"><span class="comment">         &gt; The value reported for a property must be the same as the value of the corresponding target object property if the target object property is a non-writable, non-configurable data property.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          p === <span class="string">'top'</span> ||</span><br><span class="line">          p === <span class="string">'parent'</span> ||</span><br><span class="line">          p === <span class="string">'self'</span> ||</span><br><span class="line">          p === <span class="string">'window'</span> ||</span><br><span class="line">          (process.env.NODE_ENV === <span class="string">'test'</span> &amp;&amp; (p === <span class="string">'mockTop'</span> || p === <span class="string">'mockSafariTop'</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">          descriptor.configurable = <span class="literal">true</span>;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           The descriptor of window.window/window.top/window.self in Safari/FF are accessor descriptors, we need to avoid adding a data descriptor while it was</span></span><br><span class="line"><span class="comment">           Example:</span></span><br><span class="line"><span class="comment">            Safari/FF: Object.getOwnPropertyDescriptor(window, 'top') -&gt; &#123;get: function, set: undefined, enumerable: true, configurable: false&#125;</span></span><br><span class="line"><span class="comment">            Chrome: Object.getOwnPropertyDescriptor(window, 'top') -&gt; &#123;value: Window, writable: false, enumerable: true, configurable: false&#125;</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (!hasGetter) &#123;</span><br><span class="line">            descriptor.writable = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasGetter) propertiesWithGetter.set(p, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// freeze the descriptor to avoid being modified by zone.js</span></span><br><span class="line">        <span class="comment">// see https://github.com/angular/zone.js/blob/a5fe09b0fac27ac5df1fa746042f96f05ccb6a00/lib/browser/define-property.ts#L71</span></span><br><span class="line">        rawObjectDefineProperty(fakeWindow, p, <span class="built_in">Object</span>.freeze(descriptor));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    fakeWindow,</span><br><span class="line">    propertiesWithGetter,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是ProxySandbox的实现了，比较关键的就是它的构造函数中通过proxy劫持了对fakeWindow的set方法，然后通过这种方式去统计有那些属性发生了改变，同时如果是<code>globalVariableWhiteList</code>中的成员，那么就将其descriptor存储到<code>globalWhitelistPrevDescriptor</code>中，在inactive的时候恢复</p>
<p>我们首先看下这个<code>globalVariableWhiteList</code>是什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> variableWhiteListInDev =</span><br><span class="line">  process.env.NODE_ENV === <span class="string">'test'</span> || process.env.NODE_ENV === <span class="string">'development'</span> || <span class="built_in">window</span>.__QIANKUN_DEVELOPMENT__</span><br><span class="line">    ? [</span><br><span class="line">        <span class="comment">// for react hot reload</span></span><br><span class="line">        <span class="comment">// see https://github.com/facebook/create-react-app/blob/66bf7dfc43350249e2f09d138a20840dae8a0a4a/packages/react-error-overlay/src/index.js#L180</span></span><br><span class="line">        <span class="string">'__REACT_ERROR_OVERLAY_GLOBAL_HOOK__'</span>,</span><br><span class="line">      ]</span><br><span class="line">    : [];</span><br><span class="line"><span class="comment">// who could escape the sandbox</span></span><br><span class="line"><span class="keyword">const</span> globalVariableWhiteList: string[] = [</span><br><span class="line">  <span class="comment">// FIXME System.js used a indirect call with eval, which would make it scope escape to global</span></span><br><span class="line">  <span class="comment">// To make System.js works well, we write it back to global window temporary</span></span><br><span class="line">  <span class="comment">// see https://github.com/systemjs/systemjs/blob/457f5b7e8af6bd120a279540477552a07d5de086/src/evaluate.js#L106</span></span><br><span class="line">  <span class="string">'System'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// see https://github.com/systemjs/systemjs/blob/457f5b7e8af6bd120a279540477552a07d5de086/src/instantiate.js#L357</span></span><br><span class="line">  <span class="string">'__cjsWrapper'</span>,</span><br><span class="line">  ...variableWhiteListInDev,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>然后看一下ProxySandbox的大致结构，这里我先把Proxy隐藏，后面再一个个介绍：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> ProxySandbox <span class="keyword">implements</span> SandBox &#123;</span><br><span class="line">  <span class="comment">/** window 值变更记录 */</span></span><br><span class="line">  <span class="keyword">private</span> updatedValueSet = <span class="keyword">new</span> Set&lt;PropertyKey&gt;();</span><br><span class="line"></span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">type</span>: SandBoxType;</span><br><span class="line"></span><br><span class="line">  proxy: WindowProxy;</span><br><span class="line">  sandboxRunning = <span class="literal">true</span>;</span><br><span class="line">  latestSetProp: PropertyKey | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  active() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.sandboxRunning) activeSandboxCount++;</span><br><span class="line">    <span class="keyword">this</span>.sandboxRunning = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  inactive() &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.info(<span class="string">`[qiankun:sandbox] <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> modified global properties restore...`</span>, [</span><br><span class="line">        ...this.updatedValueSet.keys(),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'test'</span> || --activeSandboxCount === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// reset the global value to the prev value</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.globalWhitelistPrevDescriptor).forEach(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> descriptor = <span class="keyword">this</span>.globalWhitelistPrevDescriptor[p];</span><br><span class="line">        <span class="keyword">if</span> (descriptor) &#123;</span><br><span class="line">          <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>.globalContext, p, descriptor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// @ts-ignore</span></span><br><span class="line">          <span class="keyword">delete</span> <span class="keyword">this</span>.globalContext[p];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.sandboxRunning = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the descriptor of global variables in whitelist before it been modified</span></span><br><span class="line">  globalWhitelistPrevDescriptor: &#123; [p <span class="keyword">in</span> <span class="keyword">typeof</span> globalVariableWhiteList[<span class="built_in">number</span>]]: PropertyDescriptor | <span class="literal">undefined</span> &#125; = &#123;&#125;;</span><br><span class="line">  globalContext: <span class="keyword">typeof</span> <span class="built_in">window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">name: <span class="built_in">string</span>, globalContext = <span class="built_in">window</span></span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.globalContext = globalContext;</span><br><span class="line">    <span class="keyword">this</span>.type = SandBoxType.Proxy;</span><br><span class="line">    <span class="keyword">const</span> &#123; updatedValueSet &#125; = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; fakeWindow, propertiesWithGetter &#125; = createFakeWindow(globalContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> descriptorTargetMap = <span class="keyword">new</span> Map&lt;PropertyKey, SymbolTarget&gt;();</span><br><span class="line">    <span class="keyword">const</span> hasOwnProperty = <span class="function">(<span class="params">key: PropertyKey</span>) =&gt;</span> fakeWindow.hasOwnProperty(key) || globalContext.hasOwnProperty(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">new</span> Proxy(fakeWindow, &#123;</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.proxy = proxy;</span><br><span class="line"></span><br><span class="line">    activeSandboxCount++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> registerRunningApp(name: <span class="built_in">string</span>, proxy: Window) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.sandboxRunning) &#123;</span><br><span class="line">      <span class="keyword">const</span> currentRunningApp = getCurrentRunningApp();</span><br><span class="line">      <span class="keyword">if</span> (!currentRunningApp || currentRunningApp.name !== name) &#123;</span><br><span class="line">        setCurrentRunningApp(&#123; name, <span class="built_in">window</span>: proxy &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// FIXME if you have any other good ideas</span></span><br><span class="line">      <span class="comment">// remove the mark in next tick, thus we can identify whether it in micro app or not</span></span><br><span class="line">      <span class="comment">// this approach is just a workaround, it could not cover all complex cases, such as the micro app runs in the same task context with master in some case</span></span><br><span class="line">      nextTask(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        setCurrentRunningApp(<span class="literal">null</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们暂时看不出这<code>latestSetProp, globalWhitelistPrevDescriptor</code>几个变量的作用，我们继续看一下Proxy中的各个配置：</p>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>set拦截其中会检测fakeWindow和globalContext是否都有当前要修改的属性，如果有，那么直接给fakeWindow上的该属性赋值，如果没有，只有globalContext上有，看一下这个属性是否是writable或者有set方法，只有这两个有其一，才表明这个属性本身是可以修改的，我们给fakeWindow上添加这个属性并修改才是有意义的</p>
<p>同时set方法中也会查看当前修改的属性是否是globalVariableWhiteList中的一个，如果是，将其descriptor添加到globalWhitelistPrevDescriptor中</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>: (target: FakeWindow, p: PropertyKey, value: <span class="built_in">any</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.sandboxRunning) &#123;</span><br><span class="line">		<span class="keyword">this</span>.registerRunningApp(name, proxy);</span><br><span class="line">		<span class="comment">// We must keep its description while the property existed in globalContext before</span></span><br><span class="line">		<span class="keyword">if</span> (!target.hasOwnProperty(p) &amp;&amp; globalContext.hasOwnProperty(p)) &#123;</span><br><span class="line">			<span class="keyword">const</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(globalContext, p);</span><br><span class="line">			<span class="keyword">const</span> &#123; writable, configurable, enumerable, <span class="keyword">set</span> &#125; = descriptor!;</span><br><span class="line">			<span class="comment">// only writable property can be overwritten</span></span><br><span class="line">			<span class="comment">// here we ignored accessor descriptor of globalContext as it makes no sense to trigger its logic(which might make sandbox escaping instead)</span></span><br><span class="line">			<span class="comment">// we force to set value by data descriptor</span></span><br><span class="line">			<span class="keyword">if</span> (writable || <span class="keyword">set</span>) &#123;</span><br><span class="line">				<span class="built_in">Object</span>.defineProperty(target, p, &#123; configurable, enumerable, writable: <span class="literal">true</span>, value &#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			target[p] = value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// sync the property to globalContext</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> p === <span class="string">'string'</span> &amp;&amp; globalVariableWhiteList.indexOf(p) !== <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">this</span>.globalWhitelistPrevDescriptor[p] = <span class="built_in">Object</span>.getOwnPropertyDescriptor(globalContext, p);</span><br><span class="line">			<span class="comment">// @ts-ignore</span></span><br><span class="line">			globalContext[p] = value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		updatedValueSet.add(p);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.latestSetProp = p;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">		<span class="built_in">console</span>.warn(<span class="string">`[qiankun] Set window.<span class="subst">$&#123;p.toString()&#125;</span> while sandbox destroyed or inactive in <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在 strict-mode 下，Proxy 的 handler.set 返回 false 会抛出 TypeError，在沙箱卸载的情况下应该忽略错误</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>这个get其实就是做了很多的检测，比如如果要获取的属性是window或者self，这种，返回proxy本身这种，具体很多分支大家可以看一下下面的代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>: (target: FakeWindow, p: PropertyKey): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">this</span>.registerRunningApp(name, proxy);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p === Symbol.unscopables) <span class="keyword">return</span> unscopables;</span><br><span class="line">	<span class="comment">// avoid who using window.window or window.self to escape the sandbox environment to touch the really window</span></span><br><span class="line">	<span class="comment">// see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13</span></span><br><span class="line">	<span class="keyword">if</span> (p === <span class="string">'window'</span> || p === <span class="string">'self'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// hijack globalWindow accessing with globalThis keyword</span></span><br><span class="line">	<span class="keyword">if</span> (p === <span class="string">'globalThis'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (</span><br><span class="line">		p === <span class="string">'top'</span> ||</span><br><span class="line">		p === <span class="string">'parent'</span> ||</span><br><span class="line">		(process.env.NODE_ENV === <span class="string">'test'</span> &amp;&amp; (p === <span class="string">'mockTop'</span> || p === <span class="string">'mockSafariTop'</span>))</span><br><span class="line">	) &#123;</span><br><span class="line">		<span class="comment">// if your master app in an iframe context, allow these props escape the sandbox</span></span><br><span class="line">		<span class="keyword">if</span> (globalContext === globalContext.parent) &#123;</span><br><span class="line">			<span class="keyword">return</span> proxy;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (globalContext <span class="keyword">as</span> <span class="built_in">any</span>)[p];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proxy.hasOwnProperty would invoke getter firstly, then its value represented as globalContext.hasOwnProperty</span></span><br><span class="line">	<span class="keyword">if</span> (p === <span class="string">'hasOwnProperty'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> hasOwnProperty;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p === <span class="string">'document'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">document</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p === <span class="string">'eval'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">eval</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> actualTarget = propertiesWithGetter.has(p) ? globalContext : p <span class="keyword">in</span> target ? target : globalContext;</span><br><span class="line">	<span class="keyword">const</span> value = actualTarget[p];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// frozen value should return directly, see https://github.com/umijs/qiankun/issues/2015</span></span><br><span class="line">	<span class="keyword">if</span> (isPropertyFrozen(actualTarget, p)) &#123;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Some dom api must be bound to native window, otherwise it would cause exception like 'TypeError: Failed to execute 'fetch' on 'Window': Illegal invocation'</span></span><br><span class="line"><span class="comment">			See this code:</span></span><br><span class="line"><span class="comment">				const proxy = new Proxy(window, &#123;&#125;);</span></span><br><span class="line"><span class="comment">				const proxyFetch = fetch.bind(proxy);</span></span><br><span class="line"><span class="comment">				proxyFetch('https://qiankun.com');</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">const</span> boundTarget = useNativeWindowForBindingsProps.get(p) ? nativeGlobal : globalContext;</span><br><span class="line">	<span class="keyword">return</span> getTargetValue(boundTarget, value);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">has(target: FakeWindow, p: <span class="built_in">string</span> | <span class="built_in">number</span> | symbol): <span class="built_in">boolean</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> p <span class="keyword">in</span> unscopables || p <span class="keyword">in</span> target || p <span class="keyword">in</span> globalContext;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">getOwnPropertyDescriptor(target: FakeWindow, p: <span class="built_in">string</span> | <span class="built_in">number</span> | symbol): PropertyDescriptor | <span class="literal">undefined</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		as the descriptor of top/self/window/mockTop in raw window are configurable but not in proxy target, we need to get it from target to avoid TypeError</span></span><br><span class="line"><span class="comment">		see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor</span></span><br><span class="line"><span class="comment">		&gt; A property cannot be reported as non-configurable, if it does not exists as an own property of the target object or if it exists as a configurable own property of the target object.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">if</span> (target.hasOwnProperty(p)) &#123;</span><br><span class="line">		<span class="keyword">const</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, p);</span><br><span class="line">		descriptorTargetMap.set(p, <span class="string">'target'</span>);</span><br><span class="line">		<span class="keyword">return</span> descriptor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (globalContext.hasOwnProperty(p)) &#123;</span><br><span class="line">		<span class="keyword">const</span> descriptor = <span class="built_in">Object</span>.getOwnPropertyDescriptor(globalContext, p);</span><br><span class="line">		descriptorTargetMap.set(p, <span class="string">'globalContext'</span>);</span><br><span class="line">		<span class="comment">// A property cannot be reported as non-configurable, if it does not exists as an own property of the target object</span></span><br><span class="line">		<span class="keyword">if</span> (descriptor &amp;&amp; !descriptor.configurable) &#123;</span><br><span class="line">			descriptor.configurable = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> descriptor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// trap to support iterator with sandbox</span></span><br><span class="line">ownKeys(target: FakeWindow): ArrayLike&lt;<span class="built_in">string</span> | symbol&gt; &#123;</span><br><span class="line">	<span class="keyword">return</span> uniq(Reflect.ownKeys(globalContext).concat(Reflect.ownKeys(target)));</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">defineProperty(target: Window, p: PropertyKey, attributes: PropertyDescriptor): <span class="built_in">boolean</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">from</span> = descriptorTargetMap.get(p);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		Descriptor must be defined to native window while it comes from native window via Object.getOwnPropertyDescriptor(window, p),</span></span><br><span class="line"><span class="comment">		otherwise it would cause a TypeError with illegal invocation.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">switch</span> (<span class="keyword">from</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">'globalContext'</span>:</span><br><span class="line">			<span class="keyword">return</span> Reflect.defineProperty(globalContext, p, attributes);</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> Reflect.defineProperty(target, p, attributes);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">deleteProperty: (target: FakeWindow, p: <span class="built_in">string</span> | <span class="built_in">number</span> | symbol): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">this</span>.registerRunningApp(name, proxy);</span><br><span class="line">	<span class="keyword">if</span> (target.hasOwnProperty(p)) &#123;</span><br><span class="line">		<span class="comment">// @ts-ignore</span></span><br><span class="line">		<span class="keyword">delete</span> target[p];</span><br><span class="line">		updatedValueSet.delete(p);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// makes sure `window instanceof Window` returns truthy in micro app</span></span><br><span class="line">getPrototypeOf() &#123;</span><br><span class="line">	<span class="keyword">return</span> Reflect.getPrototypeOf(globalContext);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="patchers"><a href="#patchers" class="headerlink" title="patchers"></a>patchers</h3><h4 id="劫持interval"><a href="#劫持interval" class="headerlink" title="劫持interval"></a>劫持interval</h4><p>这部分功能主要是用于拦截sandbox运行期间的定时器，收集有哪些定时器，并能够在sandbox退出事把所有定时器清空</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rawWindowInterval = <span class="built_in">window</span>.setInterval;</span><br><span class="line"><span class="keyword">const</span> rawWindowClearInterval = <span class="built_in">window</span>.clearInterval;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">global: Window</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> intervals: <span class="built_in">number</span>[] = [];</span><br><span class="line"></span><br><span class="line">  global.clearInterval = <span class="function">(<span class="params">intervalId: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    intervals = intervals.filter(<span class="function">(<span class="params">id</span>) =&gt;</span> id !== intervalId);</span><br><span class="line">    <span class="keyword">return</span> rawWindowClearInterval.call(<span class="built_in">window</span>, intervalId <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  global.setInterval = <span class="function">(<span class="params">handler: CallableFunction, timeout?: <span class="built_in">number</span>, ...args: <span class="built_in">any</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> intervalId = rawWindowInterval(handler, timeout, ...args);</span><br><span class="line">    intervals = [...intervals, intervalId];</span><br><span class="line">    <span class="keyword">return</span> intervalId;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    intervals.forEach(<span class="function">(<span class="params">id</span>) =&gt;</span> global.clearInterval(id));</span><br><span class="line">    global.setInterval = rawWindowInterval;</span><br><span class="line">    global.clearInterval = rawWindowClearInterval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> noop;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="劫持eventListener"><a href="#劫持eventListener" class="headerlink" title="劫持eventListener"></a>劫持eventListener</h4><p>这个的功能与劫持interval相同，这里是劫持所有的eventListener，收集所有的事件监听器，并提供函数能在sandbox退出时清空所有的事件监听器</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rawAddEventListener = <span class="built_in">window</span>.addEventListener;</span><br><span class="line"><span class="keyword">const</span> rawRemoveEventListener = <span class="built_in">window</span>.removeEventListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">global: WindowProxy</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> listenerMap = <span class="keyword">new</span> Map&lt;<span class="built_in">string</span>, EventListenerOrEventListenerObject[]&gt;();</span><br><span class="line"></span><br><span class="line">  global.addEventListener = (</span><br><span class="line">    <span class="keyword">type</span>: <span class="built_in">string</span>,</span><br><span class="line">    listener: EventListenerOrEventListenerObject,</span><br><span class="line">    options?: <span class="built_in">boolean</span> | AddEventListenerOptions,</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = listenerMap.get(<span class="keyword">type</span>) || [];</span><br><span class="line">    listenerMap.set(<span class="keyword">type</span>, [...listeners, listener]);</span><br><span class="line">    <span class="keyword">return</span> rawAddEventListener.call(<span class="built_in">window</span>, <span class="keyword">type</span>, listener, options);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  global.removeEventListener = (</span><br><span class="line">    <span class="keyword">type</span>: <span class="built_in">string</span>,</span><br><span class="line">    listener: EventListenerOrEventListenerObject,</span><br><span class="line">    options?: <span class="built_in">boolean</span> | AddEventListenerOptions,</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> storedTypeListeners = listenerMap.get(<span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">if</span> (storedTypeListeners &amp;&amp; storedTypeListeners.length &amp;&amp; storedTypeListeners.indexOf(listener) !== <span class="number">-1</span>) &#123;</span><br><span class="line">      storedTypeListeners.splice(storedTypeListeners.indexOf(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rawRemoveEventListener.call(<span class="built_in">window</span>, <span class="keyword">type</span>, listener, options);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    listenerMap.forEach(<span class="function">(<span class="params">listeners, <span class="keyword">type</span></span>) =&gt;</span></span><br><span class="line">      [...listeners].forEach(<span class="function">(<span class="params">listener</span>) =&gt;</span> global.removeEventListener(<span class="keyword">type</span>, listener)),</span><br><span class="line">    );</span><br><span class="line">    global.addEventListener = rawAddEventListener;</span><br><span class="line">    global.removeEventListener = rawRemoveEventListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> noop;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="劫持historyListener（针对umi框架）"><a href="#劫持historyListener（针对umi框架）" class="headerlink" title="劫持historyListener（针对umi框架）"></a>劫持historyListener（针对umi框架）</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isFunction, noop &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// FIXME umi unmount feature request</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span></span><br><span class="line">  <span class="keyword">let</span> rawHistoryListen = <span class="function">(<span class="params">_: <span class="built_in">any</span></span>) =&gt;</span> noop;</span><br><span class="line">  <span class="keyword">const</span> historyListeners: <span class="built_in">Array</span>&lt;<span class="keyword">typeof</span> noop&gt; = [];</span><br><span class="line">  <span class="keyword">const</span> historyUnListens: <span class="built_in">Array</span>&lt;<span class="keyword">typeof</span> noop&gt; = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history &amp;&amp; isFunction((<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen)) &#123;</span><br><span class="line">    rawHistoryListen = (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen.bind((<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history);</span><br><span class="line"></span><br><span class="line">    (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen = <span class="function">(<span class="params">listener: <span class="keyword">typeof</span> noop</span>) =&gt;</span> &#123;</span><br><span class="line">      historyListeners.push(listener);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> unListen = rawHistoryListen(listener);</span><br><span class="line">      historyUnListens.push(unListen);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        unListen();</span><br><span class="line">        historyUnListens.splice(historyUnListens.indexOf(unListen), <span class="number">1</span>);</span><br><span class="line">        historyListeners.splice(historyListeners.indexOf(listener), <span class="number">1</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> rebuild = noop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     还存在余量 listener 表明未被卸载，存在两种情况</span></span><br><span class="line"><span class="comment">     1. 应用在 unmout 时未正确卸载 listener</span></span><br><span class="line"><span class="comment">     2. listener 是应用 mount 之前绑定的，</span></span><br><span class="line"><span class="comment">     第二种情况下应用在下次 mount 之前需重新绑定该 listener</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (historyListeners.length) &#123;</span><br><span class="line">      rebuild = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 必须使用 window.g_history.listen 的方式重新绑定 listener，从而能保证 rebuild 这部分也能被捕获到，否则在应用卸载后无法正确的移除这部分副作用</span></span><br><span class="line">        historyListeners.forEach(<span class="function">(<span class="params">listener</span>) =&gt;</span> (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen(listener));</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卸载余下的 listener</span></span><br><span class="line">    historyUnListens.forEach(<span class="function">(<span class="params">unListen</span>) =&gt;</span> unListen());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history &amp;&amp; isFunction((<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen)) &#123;</span><br><span class="line">      (<span class="built_in">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).g_history.listen = rawHistoryListen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rebuild;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="patch-sandbox"><a href="#patch-sandbox" class="headerlink" title="patch sandbox"></a>patch sandbox</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchLooseSandbox</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  appWrapperGetter: () =&gt; HTMLElement | ShadowRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  proxy: Window,</span></span></span><br><span class="line"><span class="function"><span class="params">  mounting = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  scopedCSS = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Freer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dynamicStyleSheetElements: <span class="built_in">Array</span>&lt;HTMLLinkElement | HTMLStyleElement&gt; = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      check if the currently specified application is active</span></span><br><span class="line"><span class="comment">      While we switch page from qiankun app to a normal react routing page, the normal one may load stylesheet dynamically while page rendering,</span></span><br><span class="line"><span class="comment">      but the url change listener must to wait until the current call stack is flushed.</span></span><br><span class="line"><span class="comment">      This scenario may cause we record the stylesheet from react routing page dynamic injection,</span></span><br><span class="line"><span class="comment">      and remove them after the url change triggered and qiankun app is unmouting</span></span><br><span class="line"><span class="comment">      see https://github.com/ReactTraining/history/blob/master/modules/createHashHistory.js#L222-L230</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    () =&gt; checkActivityFunctions(<span class="built_in">window</span>.location).some(<span class="function">(<span class="params">name</span>) =&gt;</span> name === appName),</span><br><span class="line">    () =&gt; (&#123;</span><br><span class="line">      appName,</span><br><span class="line">      appWrapperGetter,</span><br><span class="line">      proxy,</span><br><span class="line">      strictGlobal: <span class="literal">false</span>,</span><br><span class="line">      speedySandbox: <span class="literal">false</span>,</span><br><span class="line">      scopedCSS,</span><br><span class="line">      dynamicStyleSheetElements,</span><br><span class="line">      excludeAssetFilter,</span><br><span class="line">    &#125;),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mounting) calcAppCount(appName, <span class="string">'increase'</span>, <span class="string">'bootstrapping'</span>);</span><br><span class="line">  <span class="keyword">if</span> (mounting) calcAppCount(appName, <span class="string">'increase'</span>, <span class="string">'mounting'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mounting) calcAppCount(appName, <span class="string">'decrease'</span>, <span class="string">'bootstrapping'</span>);</span><br><span class="line">    <span class="keyword">if</span> (mounting) calcAppCount(appName, <span class="string">'decrease'</span>, <span class="string">'mounting'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the overwrite prototype after all the micro apps unmounted</span></span><br><span class="line">    <span class="keyword">if</span> (isAllAppsUnmounted()) unpatchDynamicAppendPrototypeFunctions();</span><br><span class="line"></span><br><span class="line">    recordStyledComponentsCSSRules(dynamicStyleSheetElements);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// As now the sub app content all wrapped with a special id container,</span></span><br><span class="line">    <span class="comment">// the dynamic style sheet would be removed automatically while unmoutting</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">rebuild</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      rebuildCSSRules(dynamicStyleSheetElements, <span class="function">(<span class="params">stylesheetElement</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> appWrapper = appWrapperGetter();</span><br><span class="line">        <span class="keyword">if</span> (!appWrapper.contains(stylesheetElement)) &#123;</span><br><span class="line">          <span class="comment">// Using document.head.appendChild ensures that appendChild invocation can also directly use the HTMLHeadElement.prototype.appendChild method which is overwritten at mounting phase</span></span><br><span class="line">          <span class="built_in">document</span>.head.appendChild.call(appWrapper, stylesheetElement);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// As the patcher will be invoked every mounting phase, we could release the cache for gc after rebuilding</span></span><br><span class="line">      <span class="keyword">if</span> (mounting) &#123;</span><br><span class="line">        dynamicStyleSheetElements = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get native global window with a sandbox disgusted way, thus we could share it between qiankun instances🤪</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(nativeGlobal, <span class="string">'__proxyAttachContainerConfigMap__'</span>, &#123; enumerable: <span class="literal">false</span>, writable: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Share proxyAttachContainerConfigMap between multiple qiankun instance, thus they could access the same record</span></span><br><span class="line">nativeGlobal.__proxyAttachContainerConfigMap__ =</span><br><span class="line">  nativeGlobal.__proxyAttachContainerConfigMap__ || <span class="keyword">new</span> WeakMap&lt;WindowProxy, ContainerConfig&gt;();</span><br><span class="line"><span class="keyword">const</span> proxyAttachContainerConfigMap: WeakMap&lt;WindowProxy, ContainerConfig&gt; =</span><br><span class="line">  nativeGlobal.__proxyAttachContainerConfigMap__;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> elementAttachContainerConfigMap = <span class="keyword">new</span> WeakMap&lt;HTMLElement, ContainerConfig&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> docCreatePatchedMap = <span class="keyword">new</span> WeakMap&lt;<span class="keyword">typeof</span> <span class="built_in">document</span>.createElement, <span class="keyword">typeof</span> <span class="built_in">document</span>.createElement&gt;();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchDocumentCreateElement</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> docCreateElementFnBeforeOverwrite = docCreatePatchedMap.get(<span class="built_in">document</span>.createElement);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!docCreateElementFnBeforeOverwrite) &#123;</span><br><span class="line">    <span class="keyword">const</span> rawDocumentCreateElement = <span class="built_in">document</span>.createElement;</span><br><span class="line">    Document.prototype.createElement = <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>&lt;<span class="title">K</span> <span class="title">extends</span> <span class="title">keyof</span> <span class="title">HTMLElementTagNameMap</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">this</span>: Document,</span></span></span><br><span class="line"><span class="function"><span class="params">      tagName: K,</span></span></span><br><span class="line"><span class="function"><span class="params">      options?: ElementCreationOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>): <span class="title">HTMLElement</span> </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> element = rawDocumentCreateElement.call(<span class="keyword">this</span>, tagName, options);</span><br><span class="line">      <span class="keyword">if</span> (isHijackingTag(tagName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="built_in">window</span>: currentRunningSandboxProxy &#125; = getCurrentRunningApp() || &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span> (currentRunningSandboxProxy) &#123;</span><br><span class="line">          <span class="keyword">const</span> proxyContainerConfig = proxyAttachContainerConfigMap.get(currentRunningSandboxProxy);</span><br><span class="line">          <span class="keyword">if</span> (proxyContainerConfig) &#123;</span><br><span class="line">            elementAttachContainerConfigMap.set(element, proxyContainerConfig);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> element;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It means it have been overwritten while createElement is an own property of document</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.hasOwnProperty(<span class="string">'createElement'</span>)) &#123;</span><br><span class="line">      <span class="built_in">document</span>.createElement = Document.prototype.createElement;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    docCreatePatchedMap.set(Document.prototype.createElement, rawDocumentCreateElement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unpatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (docCreateElementFnBeforeOverwrite) &#123;</span><br><span class="line">      Document.prototype.createElement = docCreateElementFnBeforeOverwrite;</span><br><span class="line">      <span class="built_in">document</span>.createElement = docCreateElementFnBeforeOverwrite;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchStrictSandbox</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  appWrapperGetter: () =&gt; HTMLElement | ShadowRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  proxy: Window,</span></span></span><br><span class="line"><span class="function"><span class="params">  mounting = <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  scopedCSS = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  speedySandbox = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Freer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> containerConfig = proxyAttachContainerConfigMap.get(proxy);</span><br><span class="line">  <span class="keyword">if</span> (!containerConfig) &#123;</span><br><span class="line">    containerConfig = &#123;</span><br><span class="line">      appName,</span><br><span class="line">      proxy,</span><br><span class="line">      appWrapperGetter,</span><br><span class="line">      dynamicStyleSheetElements: [],</span><br><span class="line">      strictGlobal: <span class="literal">true</span>,</span><br><span class="line">      speedySandbox,</span><br><span class="line">      excludeAssetFilter,</span><br><span class="line">      scopedCSS,</span><br><span class="line">    &#125;;</span><br><span class="line">    proxyAttachContainerConfigMap.set(proxy, containerConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// all dynamic style sheets are stored in proxy container</span></span><br><span class="line">  <span class="keyword">const</span> &#123; dynamicStyleSheetElements &#125; = containerConfig;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDocumentCreate = patchDocumentCreateElement();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(</span><br><span class="line">    (element) =&gt; elementAttachContainerConfigMap.has(element),</span><br><span class="line">    (element) =&gt; elementAttachContainerConfigMap.get(element)!,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mounting) calcAppCount(appName, <span class="string">'increase'</span>, <span class="string">'bootstrapping'</span>);</span><br><span class="line">  <span class="keyword">if</span> (mounting) calcAppCount(appName, <span class="string">'increase'</span>, <span class="string">'mounting'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mounting) calcAppCount(appName, <span class="string">'decrease'</span>, <span class="string">'bootstrapping'</span>);</span><br><span class="line">    <span class="keyword">if</span> (mounting) calcAppCount(appName, <span class="string">'decrease'</span>, <span class="string">'mounting'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the overwritten prototype after all the micro apps unmounted</span></span><br><span class="line">    <span class="keyword">if</span> (isAllAppsUnmounted()) &#123;</span><br><span class="line">      unpatchDynamicAppendPrototypeFunctions();</span><br><span class="line">      unpatchDocumentCreate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    recordStyledComponentsCSSRules(dynamicStyleSheetElements);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// As now the sub app content all wrapped with a special id container,</span></span><br><span class="line">    <span class="comment">// the dynamic style sheet would be removed automatically while unmoutting</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">rebuild</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      rebuildCSSRules(dynamicStyleSheetElements, <span class="function">(<span class="params">stylesheetElement</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> appWrapper = appWrapperGetter();</span><br><span class="line">        <span class="keyword">if</span> (!appWrapper.contains(stylesheetElement)) &#123;</span><br><span class="line">          <span class="keyword">const</span> mountDom =</span><br><span class="line">            stylesheetElement[styleElementTargetSymbol] === <span class="string">'head'</span> ? getAppWrapperHeadElement(appWrapper) : appWrapper;</span><br><span class="line">          rawHeadAppendChild.call(mountDom, stylesheetElement);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="patchers-集成导出"><a href="#patchers-集成导出" class="headerlink" title="patchers 集成导出"></a>patchers 集成导出</h4><p>简单总结下patcher是做什么的：</p>
<ul>
<li>执行过程中会对一些全局的定时器或者监听器或者某些全局变量进行拦截统计，我们统称为副作用，然后返回free函数用于子应用卸载时（即unmount）调用</li>
<li>free函数内部会对上一部统计到的副作用进行清空，同时如果有部分副作用是需要下次子应用重新激活时重新启动的，放到free函数最终返回的rebuild中，最终会在mount时调用rebuild</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; Freer, SandBox &#125; <span class="keyword">from</span> <span class="string">'../../interfaces'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; SandBoxType &#125; <span class="keyword">from</span> <span class="string">'../../interfaces'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> css <span class="keyword">from</span> <span class="string">'./css'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; patchLooseSandbox, patchStrictSandbox &#125; <span class="keyword">from</span> <span class="string">'./dynamicAppend'</span>;</span><br><span class="line"><span class="keyword">import</span> patchHistoryListener <span class="keyword">from</span> <span class="string">'./historyListener'</span>;</span><br><span class="line"><span class="keyword">import</span> patchInterval <span class="keyword">from</span> <span class="string">'./interval'</span>;</span><br><span class="line"><span class="keyword">import</span> patchWindowListener <span class="keyword">from</span> <span class="string">'./windowListener'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchAtMounting</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  sandbox: SandBox,</span></span></span><br><span class="line"><span class="function"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Freer</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> basePatchers = [</span><br><span class="line">    () =&gt; patchInterval(sandbox.proxy),</span><br><span class="line">    () =&gt; patchWindowListener(sandbox.proxy),</span><br><span class="line">    () =&gt; patchHistoryListener(),</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> patchersInSandbox = &#123;</span><br><span class="line">    [SandBoxType.LegacyProxy]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      () =&gt; patchLooseSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">true</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">    [SandBoxType.Proxy]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      () =&gt;</span><br><span class="line">        patchStrictSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">true</span>, scopedCSS, excludeAssetFilter, speedySandBox),</span><br><span class="line">    ],</span><br><span class="line">    [SandBoxType.Snapshot]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      () =&gt; patchLooseSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">true</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> patchersInSandbox[sandbox.type]?.map(<span class="function">(<span class="params">patch</span>) =&gt;</span> patch());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">patchAtBootstrapping</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  sandbox: SandBox,</span></span></span><br><span class="line"><span class="function"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Freer</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> patchersInSandbox = &#123;</span><br><span class="line">    [SandBoxType.LegacyProxy]: [</span><br><span class="line">      () =&gt; patchLooseSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">false</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">    [SandBoxType.Proxy]: [</span><br><span class="line">      () =&gt;</span><br><span class="line">        patchStrictSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">false</span>, scopedCSS, excludeAssetFilter, speedySandBox),</span><br><span class="line">    ],</span><br><span class="line">    [SandBoxType.Snapshot]: [</span><br><span class="line">      () =&gt; patchLooseSandbox(appName, elementGetter, sandbox.proxy, <span class="literal">false</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> patchersInSandbox[sandbox.type]?.map(<span class="function">(<span class="params">patch</span>) =&gt;</span> patch());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; css &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Sandbox集合"><a href="#Sandbox集合" class="headerlink" title="Sandbox集合"></a>Sandbox集合</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; Freer, Rebuilder, SandBox &#125; <span class="keyword">from</span> <span class="string">'../interfaces'</span>;</span><br><span class="line"><span class="keyword">import</span> LegacySandbox <span class="keyword">from</span> <span class="string">'./legacy/sandbox'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; patchAtBootstrapping, patchAtMounting &#125; <span class="keyword">from</span> <span class="string">'./patchers'</span>;</span><br><span class="line"><span class="keyword">import</span> ProxySandbox <span class="keyword">from</span> <span class="string">'./proxySandbox'</span>;</span><br><span class="line"><span class="keyword">import</span> SnapshotSandbox <span class="keyword">from</span> <span class="string">'./snapshotSandbox'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; getCurrentRunningApp &#125; <span class="keyword">from</span> <span class="string">'./common'</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">'./patchers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成应用运行时沙箱</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 沙箱分两个类型：</span></span><br><span class="line"><span class="comment"> * 1. app 环境沙箱</span></span><br><span class="line"><span class="comment"> *  app 环境沙箱是指应用初始化过之后，应用会在什么样的上下文环境运行。每个应用的环境沙箱只会初始化一次，因为子应用只会触发一次 bootstrap 。</span></span><br><span class="line"><span class="comment"> *  子应用在切换时，实际上切换的是 app 环境沙箱。</span></span><br><span class="line"><span class="comment"> * 2. render 沙箱</span></span><br><span class="line"><span class="comment"> *  子应用在 app mount 开始前生成好的的沙箱。每次子应用切换过后，render 沙箱都会重现初始化。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 这么设计的目的是为了保证每个子应用切换回来之后，还能运行在应用 bootstrap 之后的环境下。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param appName</span></span><br><span class="line"><span class="comment"> * @param elementGetter</span></span><br><span class="line"><span class="comment"> * @param scopedCSS</span></span><br><span class="line"><span class="comment"> * @param useLooseSandbox</span></span><br><span class="line"><span class="comment"> * @param excludeAssetFilter</span></span><br><span class="line"><span class="comment"> * @param globalContext</span></span><br><span class="line"><span class="comment"> * @param speedySandBox</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createSandboxContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appName: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  useLooseSandbox?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  excludeAssetFilter?: (url: <span class="built_in">string</span>) =&gt; <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  globalContext?: <span class="keyword">typeof</span> <span class="built_in">window</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sandbox: SandBox;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.Proxy) &#123;</span><br><span class="line">    sandbox = useLooseSandbox ? <span class="keyword">new</span> LegacySandbox(appName, globalContext) : <span class="keyword">new</span> ProxySandbox(appName, globalContext);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sandbox = <span class="keyword">new</span> SnapshotSandbox(appName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// some side effect could be be invoked while bootstrapping, such as dynamic stylesheet injection with style-loader, especially during the development phase</span></span><br><span class="line">  <span class="keyword">const</span> bootstrappingFreers = patchAtBootstrapping(</span><br><span class="line">    appName,</span><br><span class="line">    elementGetter,</span><br><span class="line">    sandbox,</span><br><span class="line">    scopedCSS,</span><br><span class="line">    excludeAssetFilter,</span><br><span class="line">    speedySandBox,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// mounting freers are one-off and should be re-init at every mounting time</span></span><br><span class="line">  <span class="keyword">let</span> mountingFreers: Freer[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> sideEffectsRebuilders: Rebuilder[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    instance: sandbox,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 沙箱被 mount</span></span><br><span class="line"><span class="comment">     * 可能是从 bootstrap 状态进入的 mount</span></span><br><span class="line"><span class="comment">     * 也可能是从 unmount 之后再次唤醒进入 mount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> mount() &#123;</span><br><span class="line">      <span class="comment">/* ------------------------------------------ 因为有上下文依赖（window），以下代码执行顺序不能变 ------------------------------------------ */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 1. 启动/恢复 沙箱------------------------------------------ */</span></span><br><span class="line">      sandbox.active();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtBootstrapping = sideEffectsRebuilders.slice(<span class="number">0</span>, bootstrappingFreers.length);</span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtMounting = sideEffectsRebuilders.slice(bootstrappingFreers.length);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// must rebuild the side effects which added at bootstrapping firstly to recovery to nature state</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtBootstrapping.length) &#123;</span><br><span class="line">        sideEffectsRebuildersAtBootstrapping.forEach(<span class="function">(<span class="params">rebuild</span>) =&gt;</span> rebuild());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 2. 开启全局变量补丁 ------------------------------------------*/</span></span><br><span class="line">      <span class="comment">// render 沙箱启动时开始劫持各类全局监听，尽量不要在应用初始化阶段有 事件监听/定时器 等副作用</span></span><br><span class="line">      mountingFreers = patchAtMounting(appName, elementGetter, sandbox, scopedCSS, excludeAssetFilter, speedySandBox);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 3. 重置一些初始化时的副作用 ------------------------------------------*/</span></span><br><span class="line">      <span class="comment">// 存在 rebuilder 则表明有些副作用需要重建</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtMounting.length) &#123;</span><br><span class="line">        sideEffectsRebuildersAtMounting.forEach(<span class="function">(<span class="params">rebuild</span>) =&gt;</span> rebuild());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// clean up rebuilders</span></span><br><span class="line">      sideEffectsRebuilders = [];</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 恢复 global 状态，使其能回到应用加载之前的状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> unmount() &#123;</span><br><span class="line">      <span class="comment">// record the rebuilders of window side effects (event listeners or timers)</span></span><br><span class="line">      <span class="comment">// note that the frees of mounting phase are one-off as it will be re-init at next mounting</span></span><br><span class="line">      sideEffectsRebuilders = [...bootstrappingFreers, ...mountingFreers].map(<span class="function">(<span class="params">free</span>) =&gt;</span> free());</span><br><span class="line"></span><br><span class="line">      sandbox.inactive();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Ray Sun
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sunra.top/2022/11/22/micro-frontend-qiankun-sandbox/" title="微前端框架 Qiankun 沙箱原理">https://sunra.top/2022/11/22/micro-frontend-qiankun-sandbox/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/11/19/javascript-design-parttern-1/" rel="prev" title="JavaScript 设计模式学习与实践（一）">
      <i class="fa fa-chevron-left"></i> JavaScript 设计模式学习与实践（一）
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/11/24/micro-frontend-qiankun-code/" rel="next" title="微前端框架 Qiankun 源码解析">
      微前端框架 Qiankun 源码解析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要微前端"><span class="nav-number">1.</span> <span class="nav-text">为什么需要微前端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要沙箱"><span class="nav-number">2.</span> <span class="nav-text">为什么需要沙箱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何实现一个沙箱"><span class="nav-number">3.</span> <span class="nav-text">如何实现一个沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#手动执行代码"><span class="nav-number">3.1.</span> <span class="nav-text">手动执行代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快照沙箱"><span class="nav-number">3.2.</span> <span class="nav-text">快照沙箱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代理沙箱"><span class="nav-number">3.3.</span> <span class="nav-text">代理沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#set"><span class="nav-number">3.3.1.</span> <span class="nav-text">set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get"><span class="nav-number">3.3.2.</span> <span class="nav-text">get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">3.3.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patchers"><span class="nav-number">3.4.</span> <span class="nav-text">patchers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#劫持interval"><span class="nav-number">3.4.1.</span> <span class="nav-text">劫持interval</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#劫持eventListener"><span class="nav-number">3.4.2.</span> <span class="nav-text">劫持eventListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#劫持historyListener（针对umi框架）"><span class="nav-number">3.4.3.</span> <span class="nav-text">劫持historyListener（针对umi框架）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#patch-sandbox"><span class="nav-number">3.4.4.</span> <span class="nav-text">patch sandbox</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#patchers-集成导出"><span class="nav-number">3.4.5.</span> <span class="nav-text">patchers 集成导出</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sandbox集合"><span class="nav-number">3.5.</span> <span class="nav-text">Sandbox集合</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
  <p class="site-author-name" itemprop="name">Ray Sun</p>
  <div class="site-description" itemprop="description">拨开互联网的迷雾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">264</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sun668" title="GitHub → https://github.com/Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <div class="wechat_channel" style="width: 50%;margin-left: 25%;">
        <br>
        <!-- 这里添加你的二维码图片 -->
        <img src="/images/wechat_channel.png">
        <!-- <span>公众号</span> -->
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray Sun</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  

  

</body>
</html>
