<!DOCTYPE html>
<html lang>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunra.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script>
  <meta name="description" content="我们继续看一下Unity光照的最后一部分，衰减">
<meta name="keywords" content="Unity 光照 光照衰减 不透明物体 阴影">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity 渲染原理（十五）Unity的光照衰减与不透明物体阴影">
<meta property="og:url" content="https://sunra.top/2022/08/25/unity-render-pipeline-15/index.html">
<meta property="og:site_name" content="Origin of Ray">
<meta property="og:description" content="我们继续看一下Unity光照的最后一部分，衰减">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2023-05-26T04:00:11.688Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity 渲染原理（十五）Unity的光照衰减与不透明物体阴影">
<meta name="twitter:description" content="我们继续看一下Unity光照的最后一部分，衰减">

<link rel="canonical" href="https://sunra.top/2022/08/25/unity-render-pipeline-15/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>Unity 渲染原理（十五）Unity的光照衰减与不透明物体阴影 | Origin of Ray</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KEJ1L66CKC');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Origin of Ray</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://sunra.top/2022/08/25/unity-render-pipeline-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
      <meta itemprop="name" content="Ray Sun">
      <meta itemprop="description" content="拨开互联网的迷雾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Origin of Ray">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Unity 渲染原理（十五）Unity的光照衰减与不透明物体阴影
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-25 17:15:51" itemprop="dateCreated datePublished" datetime="2022-08-25T17:15:51+08:00">2022-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-26 12:00:11" itemprop="dateModified" datetime="2023-05-26T12:00:11+08:00">2023-05-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>我们继续看一下Unity光照的最后一部分，衰减</p>
<a id="more"></a>
<h2 id="光照衰减"><a href="#光照衰减" class="headerlink" title="光照衰减"></a>光照衰减</h2><p>之前的博客我们提到，Unity使用一张纹理作为查找表来在片元着色器中计算逐像素的光照衰减。这样的好处在于，计算衰减可以不依赖于数学公式的复杂性，我们只要使用一个参数值去纹理中采样即可。但使用纹理查找来计算衰减也有一些弊端：</p>
<ul>
<li>需要预处理来得到采样纹理，而且纹理的大小也会影响衰减的精度</li>
<li>不直观，同时也不方便，因此一旦把数据存储到查找表中，我们就无法使用其他数学公式来计算衰减</li>
</ul>
<p>但是由于这种方法可以在一定程度上提高性能，而且得到的效果在大部分情况下都是良好的，因此Unity默认使用这种纹理查找的方式来计算逐像素的点光源和聚光灯的衰减。</p>
<h3 id="用于光照衰减的纹理"><a href="#用于光照衰减的纹理" class="headerlink" title="用于光照衰减的纹理"></a>用于光照衰减的纹理</h3><p>Unity在内部使用一张名为_LightTexture0的纹理来计算光源衰减。需要注意的是，如果我们对该光源使用了cookie，那么衰减查找纹理是_LigthTextureB0,但这里不讨论这种情况。我们通常只关心_LightTexture0对角线上的纹理颜色值，这些值表明了在光源空间中不同位置的点的衰减值，如(0,0)点表明了与光源位置重合的点的衰减值，而(1,1)点则表明了在光源空间中所关心的距离最远的点的衰减。</p>
<p>为了对_LightTexture0纹理采样得到给定点到光源的衰减值，我们首先需要得到该点在光源空间中的位置，这是通过_LightMatrix0变换矩阵得到的，我们只需要把_LightMatrix0和世界空间中的顶点坐标相乘即可得到光源空间中的相应位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flaot3 lightCoord = mul(_LightMatrix0, float4(i.worldPostion, 1)).xyz</span><br></pre></td></tr></table></figure>
<p>然后我们可以使用这个坐标的模的平方对衰减纹理进行采样，得到衰减值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed atten = tex2D(_LightTexture0, dot(lightCoord, lightCoord).rr).UNITY_ATTEN_CHANNEL</span><br></pre></td></tr></table></figure>
<p>上面代码中，我们使用了光源空间中顶点距离的平方来对纹理进行采样，之所以没有使用距离值是因为这种方法可以避免开方操作，然后我们使用宏UNITY_ATTEN_CHANNEL来得到衰减纹理中衰减值所在的分量，得到最终的衰减值。</p>
<h3 id="使用数学公式计算衰减"><a href="#使用数学公式计算衰减" class="headerlink" title="使用数学公式计算衰减"></a>使用数学公式计算衰减</h3><p>尽管纹理采样的方法可以减少计算衰减的复杂度，但有时候我们希望可以在代码中利用公式来计算光源的衰减，例如，我们我们可以利用代码计算光源的线性衰减</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float distance = length(_WorldSpaceLightPos0.xyz - i.worldPosition.xyz);</span><br><span class="line">atten = 1.0 / distance;</span><br></pre></td></tr></table></figure>
<p>但是，Unity没有给出内置衰减计算的相关说明。尽管我们仍然可以再片元着色器中利用一些数学公式来计算衰减，但是由于我们无法在Shader中通过内置变量得到光源的范围，聚光灯的朝向，张开角度等信息，因此得到的效果往往有些不尽如人意，尤其是在物体离开光源的照明范围会发生突变（因为物体不在光源范围，Unity就不会为物体执行一个Additional Pass）。当然，我们可以利用脚本讲光源的相关信息传递给Shader，但是灵活度比较低。</p>
<h2 id="Unity-的阴影"><a href="#Unity-的阴影" class="headerlink" title="Unity 的阴影"></a>Unity 的阴影</h2><p>为了使场景看起来更贱真实，具有深度信息，我们通常希望光源可以把一些物体的阴影投射到其他物体上。</p>
<p>我们一起来看一下如何让一个物体向其他物体投射阴影，以及如何让一个物体接收来自其他物体的阴影。</p>
<h3 id="阴影是如何实现的"><a href="#阴影是如何实现的" class="headerlink" title="阴影是如何实现的"></a>阴影是如何实现的</h3><p>我们可以先考虑真实生活中的阴影是如何产生的，当一个光源发射的一条光线遇到一个不透明物体时，这条光线就不可以继续再照亮其他物体（先不考虑反射）。因此这个物体就会向它旁边的物体投射阴影，那些阴影区域的产生时因为光线无法到达这些区域。</p>
<p>在实时渲染中，我们最常使用的是一种名为Shadow Map的技术。这种技术理解起来比较简单，首先会把摄像机的位置放在与光源重合的位置，那么场景中该光源的阴影区域就是该摄像机看不到的地方。而Unity就是采用这种技术。</p>
<p>在前向渲染路径中，如果场景中最重要的平行光开启了阴影，Unity就会为该光源计算它的阴影映射纹理（shadowmap）。这样阴影映射纹理本质上也是一张深度图，它记录了从该光源的位置出发，能看到的场景中距离它最近的表面位置（深度信息）。</p>
<p>那么在计算阴影映射纹理时，我们如何判定距离它最近的表面位置呢？一种方法是，先把摄像机放到光源位置，然后按照正常的渲染流程，即调用Base Pass和Additional Pass来更新深度信息，得到阴影映射纹理。但这种方法会对性能造成一定的浪费，因为我们实际上只需要深度信息而已，而Base Pass和Additional Pass中往往涉及很多复杂的光照模型计算。</p>
<p>因此，<strong>Unity选择使用一个额外的Pass来专门更新光源的，这个Pass就是LightMode标签被设置为ShadowCaster的Pass。这个Pass的渲染目标不是为了帧缓存，而是阴影映射纹理（深度纹理）</strong>。Unity首先吧摄像机放置到光源位置上，然后调用该Pass，通过对顶点变换得到光源空间下的位置，并据此来输出深度信息到阴影映射纹理中。</p>
<p>因此，<strong>当开启了光源的阴影效果后，底层渲染引擎首先会在当前渲染物体的Unity Shader中找到LightMode为ShadowCaster的Pass，如果没有，它就会在Fallback指定的Unity Shader中继续寻找，如果仍然没有找到，该物体就无法向其他物体投射阴影</strong>（但它仍然可以接收其他物体的阴影）。当找到了一个LightMode为ShdowCaster的Pass后，Unity会使用该Pass来更新光源的阴影映射纹理。</p>
<p>在传统的阴影映射纹理视线中，我们会在正常渲染的Pass中把顶点位置变换到光源空间下，以得到它在光源空间中三维位置信息。然后，我们使用xy分量对阴影映射纹理进行采样，得到阴影映射纹理中该位置的深度信息。如果该深度值小于该顶点的深度值（通常是由z分量得到），那么说明该点位于阴影中。</p>
<p>在Unity5中，Unity使用了不同于这种传统的阴影采样技术，即屏幕空间的阴影映射技术（Screenspace Shadow Map）。该技术原本是延迟渲染中产生阴影的方法。需要注意的是，并不是所有的平台Unity都会使用这种技术。这是因为，该技术需要显卡支持MRT，而有些移动平台不支持这种特性。</p>
<p>当使用了屏幕空间的阴影映射技术时，Unity首先会通过调用LightMode为ShadowCaster的Pass来得到可投射阴影的光源的阴影映射纹理以及摄像机的深度纹理。然后根据光源的阴影映射纹理和摄像机深度纹理来得到屏幕空间阴影图。如果摄像机的深度图中记录的表面深度大于转换得到的阴影映射纹理中的深度值，就说明该表面是可见的，但是出于该光源的阴影中。通过这种方式，阴影图中就包含了屏幕空间中所有硬硬的区域。如果我们想要一个物体接受来自其他物体的阴影，只需要在Shader中对阴影图进行采样。由于阴影图是屏幕空间下的，因此我们首先需要吧表面坐标从模型空间变换到屏幕空间中，然后使用这个坐标对阴影图进行采样即可</p>
<p>总计一下，一个物体接受来自其他物体的阴影，以及它向其他物体投射阴影是两个过程。</p>
<ul>
<li>如果我们想要一个物体接受来自其他物体的阴影，就必须在Shader中对阴影映射纹理（包括屏幕空间的阴影图）进行采样，把采样结果和最后的光照结果相乘来产生阴影效果。</li>
<li>如果我们想要一个物体向其他物体投射阴影，就必须把该物体加入到光源的阴影映射纹理的计算中，从而让其他物体在对阴影映射纹理采样时可以得到该物体的相关信息。在Unity中，这个过程是通过为该物体执行LightMode为ShadowCaster的Pass来实现的。如果使用了屏幕空间的投影映射技术，Unity还会使用这个Pass产生一张摄像机的深度纹理</li>
</ul>
<h3 id="不透明物体的阴影"><a href="#不透明物体的阴影" class="headerlink" title="不透明物体的阴影"></a>不透明物体的阴影</h3><p>我们首先创建两个平面，一个正方体，然后创建新材质，材质Shader为我们上一篇博客的ForwardRendering，并把新材质赋给正方体。</p>
<h4 id="让物体投射阴影"><a href="#让物体投射阴影" class="headerlink" title="让物体投射阴影"></a>让物体投射阴影</h4><p>在Unity中，我们可以选择是否让一个物体投射或接受阴影。这是通过设置Mesh Render组件中的Cast Shadows和Receive Shadows属性来实现的。</p>
<p>Cast Shadows可以被设置为开启或者关闭。如果开启了Cast Shadows属性，那么Unity就会把该物体加入到光源的阴影映射纹理的计算中，从而让其他物体在对阴影映射纹理采样时可以得到该物体的相关信息。正如之前所说，这个过程是通过为该物体执行LightMode为ShadowCaster的Pass来实现的。Receive Shadows则可以选择是否让物体接受来自其他物体的阴影。如果没有开启Receive Shadows，那么当我们调用Unity得内置宏和变量计算阴影时，这些宏通过判断该物体没有开启接受阴影的功能，就不会在内部为我们计算阴影。</p>
<p>当我们在正方体上开启Cast Shadows，在两个平面上开启Receive Shadows时，可以发现正方体在平面上产生了阴影。这是因为虽然我们的ForwardRendering没有LightMode为ShaderCaster的Pass，但是它的Fallback为Specular，而Specular的Fallback为VertexLit，在VertexLit中包含LightMode为ShaderCaster的Pass。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">    Name &quot;ShadowCaster&quot;</span><br><span class="line">    Tags &#123; &quot;LightMode&quot; = &quot;ShadowCaster&quot; &#125;</span><br><span class="line"></span><br><span class="line">    CFPROGRAM</span><br><span class="line">    #pragma vertex vert</span><br><span class="line">    #pragma fragment frag</span><br><span class="line">    #pragma multi_compile_shadowcaster</span><br><span class="line">    #include &quot;UnityCG.cginc&quot;</span><br><span class="line"></span><br><span class="line">    struct v2f &#123;</span><br><span class="line">        V2F_SHADOW_CASTER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v2f vert(appdata_base v) &#123;</span><br><span class="line">        v2f o;</span><br><span class="line">        TRANSFER_SHADOW_CASTER_NORMALOFFSET(o);</span><br><span class="line">        return o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    float4 frag(v2f i): SV_Target &#123;</span><br><span class="line">        SHADOW_CASTER_FRAGMENT(i);</span><br><span class="line">    &#125;</span><br><span class="line">    ENDCG</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码中有很多的宏定义，但是实际用处就是把深度信息写入渲染目标中。</p>
<blockquote>
<p>这里还有一点需要注意，默认情况下，我们在计算光源的阴影映射纹理时会剔除掉物体的背面。但对于内置的平面来说，它只有一个面，如果在计算阴影映射纹理时，物体在光源空间中没有任何正面（frontface），就不会添加到阴影映射纹理。我们可以设置Cast Shadows为Two Sided来允许对物体的所有面都计算阴影信息。</p>
</blockquote>
<h4 id="让物体接收阴影"><a href="#让物体接收阴影" class="headerlink" title="让物体接收阴影"></a>让物体接收阴影</h4><p>我们的平面之所以能够产生阴影是因为使用了内置的Standard Shader，二者内置的Shader进行了接收阴影的相关操作。</p>
<p>而为了让正方体可以接受阴影，我们需要改造我们的Shader代码，我们创建一个新的Shader，命名为Shadow，然后将ForwardRendering代码复制给它再改造</p>
<p>首先需要在Base Pass中包含一个新的内置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;AutoLight.cgnic&quot;</span><br></pre></td></tr></table></figure>
<p>这是因为我们计算阴影时所用到的宏定义都在这个文件中</p>
<p>然后我们需要在我们的输出结构体系v2f中添加一个内置的宏<code>SHADOW_COORDS</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct v2f &#123;</span><br><span class="line">    float4 pos:SV_POSITION;</span><br><span class="line">    float3 worldNormal: TEXCOORD0;</span><br><span class="line">    float3 worldPos: TEXCOORD1;</span><br><span class="line">    SHADOW_COORDS(2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏的作用很简单，就声明命一个用于对阴影纹理采样的坐标。需要注意的是，这个宏的参数需要是下一个可用的插值寄存器的索引值。</p>
<p>然后我们在顶点着色器返回之前添加一个内置宏<code>TRANSFER_SHADOW</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">v2f vert(a2v v) &#123;</span><br><span class="line">    v2f o;</span><br><span class="line">    ...</span><br><span class="line">    TRANSFER_SHADOW_CASTER_NORMALOFFSET(o);</span><br><span class="line">    ...</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个宏用于在顶点着色器中计算上一步中声明的阴影纹理坐标</p>
<p>接着，我们在片元着色器中计算阴影值，同样适用一个宏定义<code>SHADOW_ATTENUATION</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fixed shadow = SHADOW_ATTENUATION(i);</span><br></pre></td></tr></table></figure>
<p>SHADOW_COORDS, TRANSFER_SHADOW和SHADOW_ATTENUATION是计算阴影时的三剑客，这些内置宏帮助我们在必要时计算光源的阴影，我们可以在AutoLight.cgnic中找到它们的声明</p>
<p>SHADOW_COORDS实际上就是声明了一个名为_ShadowCoord的阴影纹理坐标变量。而TRANSFER_SHADOW的实现会根据平台不同二有所差异。如果当前平台可以使用屏幕空间的阴影映射技术（通过判断是否定义了UNITY_NO_SCREENSPACE_SHADOWS），TRANSFER_SHADOW会调用内置的 ComputeScreenPos 函数来计算_ShadowCoord。如果该平台不支持屏幕空间的阴影映射技术，就会使用传统的阴影映射技术。TRANSFER_SHADOW会把顶点坐标从模型空间变换到光源空间后存储到_ShadowCoord中。然后，SHADOW_ATTENUATION负责使用_ShadowCoord对相关纹理进行采样，得到阴影信息。</p>
<p>需要注意的是，这些宏会使用上下文变量来进行相关的计算，例如TRANSFER_SHADOW会使用v.vertex和a.pos等来计算坐标，因此为了能让这些宏正确工作，我们需要保证我们自定义的变量名和这些宏使用的变量名相匹配</p>
<h3 id="统一管理关照衰减和阴影"><a href="#统一管理关照衰减和阴影" class="headerlink" title="统一管理关照衰减和阴影"></a>统一管理关照衰减和阴影</h3><p>我们之前已经讲过如何在Unity Shader的前向渲染路径中计算光照衰减——在Base Pass中，平行光的衰减因子总是等于1，而在Additional Pass中，我们需要判断该Pass处理光源类型，再使用内置的变量和宏计算衰减因子。实际上，光照衰减和阴影对物体最终的渲染结果的影响本质上是相通的——我们都是把光照衰减因子和阴影值及光照结果相乘得到最终的渲染结果。那么，是不是有一个方法可以同时计算两个信息呢？</p>
<p>Unity在Shader中确实提供了这样的功能，主要是通过内置的UNITY_LIGHT_ATTENUATION宏来实现的</p>
<p>我们再讲上一步的Shadow Shader复制并重命名为AttenuationAndShadowUseBuildInFunctions</p>
<p>尽管Shdow Shader中的代码可以让我们得到正确的阴影，但在实践中我们通常会使用Unity得内置宏和函数来计算衰减和阴影，从而隐藏一些细节。</p>
<p>（1）首先需要包含进需要的头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;Lighting.cgnic&quot;</span><br><span class="line">#include &quot;AutoLight.cgnic&quot;</span><br></pre></td></tr></table></figure>
<p>（2）在v2f结构体中使用宏定义SHADOW_COORD声明阴影坐标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct v2f &#123;</span><br><span class="line">    float4 pos : SV_Target;</span><br><span class="line">    float3 worldNormal : TEXCOORD0;</span><br><span class="line">    float3 worldPos : TEXCOORD1;</span><br><span class="line">    SHADOW_COORDS(2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）在顶点着色器中使用内置宏TRANSFER_SHADOW计算并向片元着色器传递阴影坐标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v2f vert(a2v v) &#123;</span><br><span class="line">    v2f o;</span><br><span class="line">    ...</span><br><span class="line">    TRANSDER_SHADOW(o);</span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）片元着色器中我们使用内置宏 UNITY_LIGHT_ATTENUATION 来计算光照衰减和阴影</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fixed4 frag(v2f i) : SV_Target &#123;</span><br><span class="line">    ...</span><br><span class="line">    UNITY_LIGHT_ATTENUATION(attne, i, i.worldPos);</span><br><span class="line">    return fixed4(ambient + (diffuse + specular) * atten, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UNITY_LIGHT_ATTENUATION 是内置的用于计算光照衰减和阴影的宏，我们可以在内置的AutoLight.cgnic里找到他的声明，它接受三个参数，它会将光照衰减和阴影值相乘后的结果存储到第一个参数中。注意到，我们并没有声明第一个参数atten，因为 UNITY_LIGHT_ATTENUATION 会帮我声明这个变量。第二个参数是结构体 v2f，这个参数会传递给 SHADOW_ATTENUATION 用来计算阴影值。而第三个参数是世界空间的坐标，这个参数会用于计算光源空间下的坐标，再对光照衰减纹理采样得到光照衰减。</p>
<p>由于使用了 UNITY_LIGHT_ATTENUATION，我们Base Pass和Additional Pass的代码得以统一，我们不需要在Base Pass里单独处理阴影，也不需要在Additional Pass中判断光源类型来处理光照衰减。如果我们希望在Additional Pass中添加阴影效果，就需要使用 <code>#pragma multi_compile_fwdadd_fullshadows</code>编译指令来代替Additional Pass中的<code>#pragma multi_compile_fwadd</code></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Ray Sun
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sunra.top/2022/08/25/unity-render-pipeline-15/" title="Unity 渲染原理（十五）Unity的光照衰减与不透明物体阴影">https://sunra.top/2022/08/25/unity-render-pipeline-15/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/20/unity-physics-introduction/" rel="prev" title="Unity 物理系统入门文档梳理">
      <i class="fa fa-chevron-left"></i> Unity 物理系统入门文档梳理
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/03/unity-render-pipeline-16/" rel="next" title="Unity 渲染原理（十六）Unity立方体纹理">
      Unity 渲染原理（十六）Unity立方体纹理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#光照衰减"><span class="nav-number">1.</span> <span class="nav-text">光照衰减</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用于光照衰减的纹理"><span class="nav-number">1.1.</span> <span class="nav-text">用于光照衰减的纹理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用数学公式计算衰减"><span class="nav-number">1.2.</span> <span class="nav-text">使用数学公式计算衰减</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unity-的阴影"><span class="nav-number">2.</span> <span class="nav-text">Unity 的阴影</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#阴影是如何实现的"><span class="nav-number">2.1.</span> <span class="nav-text">阴影是如何实现的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不透明物体的阴影"><span class="nav-number">2.2.</span> <span class="nav-text">不透明物体的阴影</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#让物体投射阴影"><span class="nav-number">2.2.1.</span> <span class="nav-text">让物体投射阴影</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#让物体接收阴影"><span class="nav-number">2.2.2.</span> <span class="nav-text">让物体接收阴影</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统一管理关照衰减和阴影"><span class="nav-number">2.3.</span> <span class="nav-text">统一管理关照衰减和阴影</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
  <p class="site-author-name" itemprop="name">Ray Sun</p>
  <div class="site-description" itemprop="description">拨开互联网的迷雾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">266</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sun668" title="GitHub → https://github.com/Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <div class="wechat_channel" style="width: 50%;margin-left: 25%;">
        <br>
        <!-- 这里添加你的二维码图片 -->
        <img src="/images/wechat_channel.png">
        <!-- <span>公众号</span> -->
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray Sun</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  

  

</body>
</html>
