<!DOCTYPE html>
<html lang>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunra.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="最近在想着飞书文档的关系图是怎么实现的，于是想起了之前用的G6，于是简单实现了一版。 最终效果主要功能如下：  节点分为两部分，上半部分是图标，下半部分是文字 鼠标放到图标上时，会产生水波纹的扩散特效，同时出现一圈边框 文字需要有下划线以及白色背景，且水波纹特效不能被白色背景挡住 文字的下划线需要是方格   连线要有渐变色，且渐变色要从箭头起点到箭头终点，且如果支持双向关系，如何实现两条边 连线上">
<meta name="keywords" content="G6 关系图谱 特效">
<meta property="og:type" content="article">
<meta property="og:title" content="如何用G6开发一个关系图谱">
<meta property="og:url" content="https://sunra.top/2023/03/10/g6-relationship-graph/index.html">
<meta property="og:site_name" content="Origin of Ray">
<meta property="og:description" content="最近在想着飞书文档的关系图是怎么实现的，于是想起了之前用的G6，于是简单实现了一版。 最终效果主要功能如下：  节点分为两部分，上半部分是图标，下半部分是文字 鼠标放到图标上时，会产生水波纹的扩散特效，同时出现一圈边框 文字需要有下划线以及白色背景，且水波纹特效不能被白色背景挡住 文字的下划线需要是方格   连线要有渐变色，且渐变色要从箭头起点到箭头终点，且如果支持双向关系，如何实现两条边 连线上">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2023-04-18T08:47:27.358Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何用G6开发一个关系图谱">
<meta name="twitter:description" content="最近在想着飞书文档的关系图是怎么实现的，于是想起了之前用的G6，于是简单实现了一版。 最终效果主要功能如下：  节点分为两部分，上半部分是图标，下半部分是文字 鼠标放到图标上时，会产生水波纹的扩散特效，同时出现一圈边框 文字需要有下划线以及白色背景，且水波纹特效不能被白色背景挡住 文字的下划线需要是方格   连线要有渐变色，且渐变色要从箭头起点到箭头终点，且如果支持双向关系，如何实现两条边 连线上">

<link rel="canonical" href="https://sunra.top/2023/03/10/g6-relationship-graph/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>如何用G6开发一个关系图谱 | Origin of Ray</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KEJ1L66CKC');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Origin of Ray</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://sunra.top/2023/03/10/g6-relationship-graph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
      <meta itemprop="name" content="Ray Sun">
      <meta itemprop="description" content="拨开互联网的迷雾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Origin of Ray">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何用G6开发一个关系图谱
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-10 14:28:01" itemprop="dateCreated datePublished" datetime="2023-03-10T14:28:01+08:00">2023-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-18 16:47:27" itemprop="dateModified" datetime="2023-04-18T16:47:27+08:00">2023-04-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近在想着飞书文档的关系图是怎么实现的，于是想起了之前用的G6，于是简单实现了一版。</p>
<h1 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h1><p>主要功能如下：</p>
<ul>
<li>节点分为两部分，上半部分是图标，下半部分是文字<ul>
<li>鼠标放到图标上时，会产生水波纹的扩散特效，同时出现一圈边框</li>
<li>文字需要有下划线以及白色背景，且水波纹特效不能被白色背景挡住</li>
<li>文字的下划线需要是方格</li>
</ul>
</li>
<li>连线要有渐变色，且渐变色要从箭头起点到箭头终点，且如果支持双向关系，如何实现两条边</li>
<li>连线上中间位置要有一个Label</li>
<li>节点和连线要支持半透明</li>
<li>整体布局要是力导向布局，且支持节点拖拽，拖拽时不能让节点之间产生重叠，但是也不能因为连线拖动其他节点（单独提出这一点是因为G6自带的力导向布局节点会被拖拽）</li>
</ul>
<a id="more"></a>
<h1 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h1><h2 id="自定义节点"><a href="#自定义节点" class="headerlink" title="自定义节点"></a>自定义节点</h2><p>这个功能点的第一个难点在于：</p>
<ul>
<li>G6只有keyShapre能够响应事件，且连线是连到keyShape伤的，而keyShape就是每个group的第一个shape</li>
<li>所以我们如果想要鼠标Hover到image产生水波纹，应该让image节点当keyShape</li>
<li>但是如果让image当keyShape，即使我们的图片是圆的，keyShape的框也是方的，连线如果连接到image的四个角上，就会出现连线和图片之间有一点空白，所以我们又需要让circle当作keyShape，然后image在后面添加，但这样又会导致我们的keyShapre，也就是circle被image盖在上面，导致无法触发hover事件</li>
</ul>
<p>解决方案有两种，取决于你用的renderer是svg还是canvas</p>
<ul>
<li><p>如果是canvas，那么还是让circle当keyShape，不过给circle和image都添加zIndex，然后调用group.sort()</p>
</li>
<li><p>如果是svg，group.sort是无效的，我们需要自己在afterDraw方法里通过js的方法改变层级，把后面的circle移动到最前面（越早添加越在后面）</p>
</li>
</ul>
<p>第二个难点在于，如何添加水波纹特效以及，如何在Hover circle的时候开启水波纹</p>
<p>解决方案分为两个步骤：</p>
<ul>
<li>使用官方示例的水波纹代码，不过记住先把visible设置为false，同时注意层级，要让文字在最上方</li>
<li>然后监听<code>node:mousemove</code>事件，如果Hover的target是circle，调用setItemState，然后在注册节点时，设置setState的回调，再通过shape.attr方法设置visible为true就好，然后监听<code>node:mouseleave</code>，将状态设置为另一个，同时setState回调中设置visible为false</li>
</ul>
<blockquote>
<p>设置并监听state变化的方案也可以用来实现边框，当然这种简单的样式也可以通过stateStyle解决</p>
</blockquote>
<p>第三个难点在于，如何添加文字下划线，以及文字过长如何折行，因为G6的text不支持我需要的下划线</p>
<p>解决方案是：</p>
<ul>
<li>自己算文字长度，超过一定长度就打断，超过两行后面的删除并添加省略号</li>
<li>然后在文字下方添加path shape作为下划线，长度用文字长度即可</li>
</ul>
<blockquote>
<p>注意，自定义节点要记得继承某个内置节点，最起码继承single-node，不然很多特性是没有的</p>
</blockquote>
<p>这里只展示canvas代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> ItemStatus &#123;</span><br><span class="line">  OPACITY = <span class="string">'opacity'</span>,</span><br><span class="line">  NORMAL = <span class="string">'normal'</span>,</span><br><span class="line">  ACTIVE = <span class="string">'active'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLetterWidth</span>(<span class="params">letter: <span class="built_in">string</span>, fontSize: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> pattern = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'[\u4E00-\u9FA5]+'</span>);</span><br><span class="line">  <span class="keyword">if</span> (pattern.test(letter)) &#123;</span><br><span class="line">    <span class="comment">// Chinese charactors</span></span><br><span class="line">    <span class="keyword">return</span> fontSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// get the width of single letter according to the fontSize</span></span><br><span class="line">    <span class="keyword">return</span> G6.Util.getLetterWidth(letter, fontSize);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getStringWidth</span>(<span class="params">str: <span class="built_in">string</span>, fontSize: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> currentWidth = <span class="number">0</span>;</span><br><span class="line">  str.split(<span class="string">''</span>).forEach(<span class="function"><span class="params">letter</span> =&gt;</span> &#123;</span><br><span class="line">    currentWidth += getLetterWidth(letter, fontSize);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> currentWidth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceTooLongStringWithEllipsis</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  strs: <span class="built_in">string</span>[],</span></span></span><br><span class="line"><span class="function"><span class="params">  maxWidth: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  fontSize: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ellipsis = <span class="string">'...'</span>;</span><br><span class="line">  <span class="keyword">const</span> ellipsisLength = getStringWidth(ellipsis, fontSize);</span><br><span class="line">  <span class="keyword">if</span> (strs.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> secondLine = strs[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> currentWidth = ellipsisLength;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; secondLine.length; i++) &#123;</span><br><span class="line">      currentWidth += getLetterWidth(secondLine[i], fontSize);</span><br><span class="line">      <span class="keyword">if</span> (currentWidth &gt;= maxWidth) &#123;</span><br><span class="line">        strs[<span class="number">1</span>] = <span class="string">`<span class="subst">$&#123;secondLine.slice(<span class="number">0</span>, i)&#125;</span><span class="subst">$&#123;ellipsis&#125;</span>`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [strs[<span class="number">0</span>], strs[<span class="number">1</span>]];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> strs;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NODE_ICON_SIZE = <span class="number">48</span>;</span><br><span class="line"><span class="keyword">const</span> NODE_ICON_RADIUS = NODE_ICON_SIZE / <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> NODE_NAME_FONT_SIZE = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">const</span> NODE_NAME_HEIGHT = <span class="number">18</span></span><br><span class="line"></span><br><span class="line">G6.registerNode(</span><br><span class="line">    <span class="string">'test-node'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      draw(cfg, group) &#123;</span><br><span class="line">        <span class="keyword">const</span> keyShape = group?.addShape(<span class="string">'circle'</span>, &#123;</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            x: <span class="number">0</span>,</span><br><span class="line">            y: <span class="number">0</span>,</span><br><span class="line">            r: NODE_ICON_RADIUS,</span><br><span class="line">            fill: <span class="string">'rgba(255,255,255,0)'</span>,</span><br><span class="line">            opacity: <span class="number">0</span>,</span><br><span class="line">            lineWidth: <span class="number">1</span>,</span><br><span class="line">            cursor: <span class="string">'pointer'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          name: <span class="string">'test-node-dummy'</span>,</span><br><span class="line">          draggle: <span class="literal">true</span>,</span><br><span class="line">          zIndex: <span class="number">10</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        group?.addShape(<span class="string">'image'</span>, &#123;</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            x: -NODE_ICON_SIZE / <span class="number">2</span>,</span><br><span class="line">            y: -NODE_ICON_SIZE / <span class="number">2</span>,</span><br><span class="line">            width: NODE_ICON_SIZE,</span><br><span class="line">            height: NODE_ICON_SIZE,</span><br><span class="line">            img: <span class="string">''</span>,</span><br><span class="line">            cursor: <span class="string">'pointer'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          name: <span class="string">'test-node-icon'</span>,</span><br><span class="line">          draggle: <span class="literal">true</span>,</span><br><span class="line">          zIndex: <span class="number">9</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> lableSplit = fittingString(</span><br><span class="line">          cfg?.supName <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">          <span class="number">200</span>,</span><br><span class="line">          NODE_NAME_FONT_SIZE,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; lableSplit.length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> label = lableSplit[i];</span><br><span class="line">            <span class="keyword">const</span> labelWidth = getStringWidth(</span><br><span class="line">                label,</span><br><span class="line">                NODE_NAME_FONT_SIZE,</span><br><span class="line">            );</span><br><span class="line">            group?.addShape(<span class="string">'rect'</span>, &#123;</span><br><span class="line">                attrs: &#123;</span><br><span class="line">                x: -labelWidth / <span class="number">2</span>,</span><br><span class="line">                y:</span><br><span class="line">                    NODE_ICON_SIZE -</span><br><span class="line">                    NODE_NAME_HEIGHT +</span><br><span class="line">                    i * NODE_NAME_HEIGHT +</span><br><span class="line">                    <span class="number">4</span>,</span><br><span class="line">                width: labelWidth,</span><br><span class="line">                height: NODE_NAME_HEIGHT,</span><br><span class="line">                fill: <span class="string">'#FFFFFF'</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                name: <span class="string">`test-node-name-background-<span class="subst">$&#123;i&#125;</span>`</span>,</span><br><span class="line">                zIndex: <span class="number">3</span>,</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            group?.addShape(<span class="string">'text'</span>, &#123;</span><br><span class="line">                attrs: &#123;</span><br><span class="line">                text: label,</span><br><span class="line">                fill: <span class="string">'#646A73'</span>,</span><br><span class="line">                fontSize: <span class="number">14</span>,</span><br><span class="line">                textAlign: <span class="string">'center'</span>,</span><br><span class="line">                x: <span class="number">0</span>,</span><br><span class="line">                y: NODE_ICON_SIZE + i * NODE_NAME_HEIGHT,</span><br><span class="line">                width: labelWidth,</span><br><span class="line">                height: NODE_NAME_HEIGHT,</span><br><span class="line">                cursor: <span class="string">'pointer'</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                name: <span class="string">`test-node-name-<span class="subst">$&#123;i&#125;</span>`</span>,</span><br><span class="line">                zIndex: <span class="number">3</span>,</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            group?.addShape(<span class="string">'path'</span>, &#123;</span><br><span class="line">                attrs: &#123;</span><br><span class="line">                path: [</span><br><span class="line">                    [</span><br><span class="line">                    <span class="string">'M'</span>,</span><br><span class="line">                    -labelWidth / <span class="number">2</span>,</span><br><span class="line">                    NODE_ICON_SIZE + i * NODE_NAME_HEIGHT + <span class="number">2</span>,</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                    <span class="string">'L'</span>,</span><br><span class="line">                    labelWidth / <span class="number">2</span>,</span><br><span class="line">                    NODE_ICON_SIZE + i * NODE_NAME_HEIGHT + <span class="number">2</span>,</span><br><span class="line">                    ],</span><br><span class="line">                ],</span><br><span class="line">                stroke: <span class="string">'#000000'</span>,</span><br><span class="line">                lineWidth: <span class="number">1</span>,</span><br><span class="line">                lineDash: [<span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">                &#125;,</span><br><span class="line">                name: <span class="string">`test-node-name-underline-<span class="subst">$&#123;i&#125;</span>`</span>,</span><br><span class="line">                zIndex: <span class="number">3</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> back1 = group?.addShape(<span class="string">'circle'</span>, &#123;</span><br><span class="line">          zIndex: <span class="number">5</span>,</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            x: <span class="number">0</span>,</span><br><span class="line">            y: <span class="number">0</span>,</span><br><span class="line">            r: <span class="number">0</span>,</span><br><span class="line">            fill: <span class="string">'rgba(255,255,255,0)'</span>,</span><br><span class="line">            opacity: <span class="number">0</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          name: <span class="string">'test-node-wave1'</span>,</span><br><span class="line">          draggle: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">const</span> back2 = group?.addShape(<span class="string">'circle'</span>, &#123;</span><br><span class="line">          zIndex: <span class="number">6</span>,</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            x: <span class="number">0</span>,</span><br><span class="line">            y: <span class="number">0</span>,</span><br><span class="line">            r: <span class="number">0</span>,</span><br><span class="line">            fill: <span class="string">'rgba(255,255,255,0)'</span>,</span><br><span class="line">            opacity: <span class="number">0</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          name: <span class="string">'test-node-wave2'</span>,</span><br><span class="line">          draggle: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">const</span> back3 = group?.addShape(<span class="string">'circle'</span>, &#123;</span><br><span class="line">          zIndex: <span class="number">7</span>,</span><br><span class="line">          attrs: &#123;</span><br><span class="line">            x: <span class="number">0</span>,</span><br><span class="line">            y: <span class="number">0</span>,</span><br><span class="line">            r: <span class="number">0</span>,</span><br><span class="line">            fill: <span class="string">'rgba(255,255,255,0)'</span>,</span><br><span class="line">            opacity: <span class="number">0</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          name: <span class="string">'test-node-wave3'</span>,</span><br><span class="line">          draggle: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        back1?.animate(</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// Magnifying and disappearing</span></span><br><span class="line">            r: NODE_ICON_RADIUS + <span class="number">16</span>,</span><br><span class="line">            opacity: <span class="number">0.1</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            duration: <span class="number">3000</span>,</span><br><span class="line">            easing: <span class="string">'easeCubic'</span>,</span><br><span class="line">            delay: <span class="number">100</span>,</span><br><span class="line">            repeat: <span class="literal">true</span>, <span class="comment">// repeat</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ); <span class="comment">// no delay</span></span><br><span class="line">        back2?.animate(</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// Magnifying and disappearing</span></span><br><span class="line">            r: NODE_ICON_RADIUS + <span class="number">16</span>,</span><br><span class="line">            opacity: <span class="number">0.1</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            duration: <span class="number">3000</span>,</span><br><span class="line">            easing: <span class="string">'easeCubic'</span>,</span><br><span class="line">            delay: <span class="number">1000</span>,</span><br><span class="line">            repeat: <span class="literal">true</span>, <span class="comment">// repeat</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ); <span class="comment">// 1s delay</span></span><br><span class="line">        back3?.animate(</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">// Magnifying and disappearing</span></span><br><span class="line">            r: NODE_ICON_RADIUS + <span class="number">16</span>,</span><br><span class="line">            opacity: <span class="number">0.1</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            duration: <span class="number">3000</span>,</span><br><span class="line">            easing: <span class="string">'easeCubic'</span>,</span><br><span class="line">            delay: <span class="number">2000</span>,</span><br><span class="line">            repeat: <span class="literal">true</span>, <span class="comment">// repeat</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ); <span class="comment">// 3s delay</span></span><br><span class="line"></span><br><span class="line">        back1?.hide();</span><br><span class="line">        back2?.hide();</span><br><span class="line">        back3?.hide();</span><br><span class="line"></span><br><span class="line">        group?.sort();</span><br><span class="line">        <span class="keyword">return</span> keyShape <span class="keyword">as</span> IShape;</span><br><span class="line">      &#125;,</span><br><span class="line">      setState(name, value, item) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name === <span class="string">'status'</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (value === ItemStatus.ACTIVE) &#123;</span><br><span class="line">            <span class="keyword">const</span> group = item?.getContainer();</span><br><span class="line">            <span class="keyword">const</span> shapes = group?.getChildren() ?? [];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> shape of shapes) &#123;</span><br><span class="line">              <span class="keyword">if</span> (shape.cfg.name?.includes(<span class="string">'test-node-wave'</span>)) &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, <span class="number">0.6</span>);</span><br><span class="line">                shape.attr(<span class="string">'fill'</span>, <span class="string">'#4E83FD'</span>);</span><br><span class="line">                shape.show();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shape.cfg.name?.includes(<span class="string">'test-node-dummy'</span>)) &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, <span class="number">1</span>);</span><br><span class="line">                shape.attr(<span class="string">'stroke'</span>, <span class="string">'#4E83FD'</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, <span class="number">1</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> group = item?.getContainer();</span><br><span class="line">            <span class="keyword">const</span> shapes = group?.getChildren() ?? [];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> shape of shapes) &#123;</span><br><span class="line">              <span class="keyword">if</span> (shape.cfg.name?.includes(<span class="string">'test-node-wave'</span>)) &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, <span class="number">0</span>);</span><br><span class="line">                shape.attr(<span class="string">'fill'</span>, <span class="string">'#FFFFFF'</span>);</span><br><span class="line">                shape.hide();</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shape.cfg.name?.includes(<span class="string">'test-node-dummy'</span>)) &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, <span class="number">0</span>);</span><br><span class="line">                shape.attr(<span class="string">'stroke'</span>, <span class="string">'#FFFFFF'</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                shape.attr(<span class="string">'opacity'</span>, value === ItemStatus.OPACITY ? <span class="number">0.2</span> : <span class="number">1</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'single-node'</span>,</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<h2 id="连线"><a href="#连线" class="headerlink" title="连线"></a>连线</h2><p>第一个难点在于，不能简单的在draw或者afterdraw中添加一个lable就可以了，这种只适用于文字和连线的起点相对位置不变的情况，而我们的需求时，节点可以拖拽，那就意味着连线长度可以变，而我们要求的是文字在连线中间。</p>
<p>解决方案是：</p>
<ul>
<li>在afterUpdate中每次都删除上一个添加的text shape并添加新的text shape</li>
<li>afterUpdate中其实是没有group的，可以在draw之后，把group强行挂载到cfg上</li>
</ul>
<p>第二个难点在于，如何保持渐变色一定是从连线起点到终点，因为G6只支持某个固定角度的设置，比如设置0度的渐变，就一定是从左到右渐变，如果某条线是从右到左，那这个渐变色就反了</p>
<p>解决方案是：</p>
<ul>
<li>还是在afterUpdate中，不断计算新的startPoint和endPoint的位置，算出角度来</li>
<li>通过计算出来的角度，再通过shape.attr设置stroke的渐变色属性</li>
</ul>
<p>第三个难点在于，如何支持双线曲线，因为默认的是直线，双向直线会重合</p>
<p>解决方案在于：</p>
<ul>
<li>定义另一个自定义类型，基于贝塞尔曲线扩展</li>
</ul>
<p>具体代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EDGE_LABEL_HEIGHT = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">const</span> EDGE_LABEL_FONT_SIZE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addLabelToEdge</span>(<span class="params">cfg: ModelConfig | <span class="literal">undefined</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> config = cfg <span class="keyword">as</span> ModelConfig;</span><br><span class="line">  <span class="keyword">const</span> group = cfg?.group <span class="keyword">as</span> IGroup;</span><br><span class="line">  <span class="keyword">const</span> shape = group?.get(<span class="string">'children'</span>)[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// get the coordinate of the mid point on the path</span></span><br><span class="line">  <span class="comment">// 获取路径图形的中点坐标</span></span><br><span class="line">  <span class="keyword">const</span> midPoint = shape.getPoint(<span class="number">0.5</span>);</span><br><span class="line">  <span class="keyword">const</span> startPoint = cfg?.startPoint;</span><br><span class="line">  <span class="keyword">const</span> endPoint = cfg?.endPoint;</span><br><span class="line">  <span class="keyword">if</span> (startPoint &amp;&amp; endPoint) &#123;</span><br><span class="line">    <span class="keyword">const</span> angle =</span><br><span class="line">      <span class="built_in">Math</span>.atan2(endPoint.y - startPoint.y, endPoint.x - startPoint.x) * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (angle &gt; -<span class="built_in">Math</span>.PI &amp;&amp; angle &lt; <span class="built_in">Math</span>.PI) &#123;</span><br><span class="line">      shape.attr(<span class="string">'stroke'</span>, <span class="string">`l(0) 0:#4E83FD 1:#B6CBFE`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      shape.attr(<span class="string">'stroke'</span>, <span class="string">`l(0) 0:#B6CBFE 1:#4E83FD`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (midPoint) &#123;</span><br><span class="line">    <span class="keyword">const</span> labelWidth = getStringWidth(</span><br><span class="line">      config.text <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">      EDGE_LABEL_FONT_SIZE,</span><br><span class="line">    );</span><br><span class="line">    group?.removeChild(config.preEdgeText <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">    group?.removeChild(config.preEdgeTextBackground <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">    config.preEdgeTextBackground = group.addShape(<span class="string">'rect'</span>, &#123;</span><br><span class="line">      attrs: &#123;</span><br><span class="line">        x: midPoint.x - (labelWidth + <span class="number">12</span>) / <span class="number">2</span>,</span><br><span class="line">        y: midPoint.y - EDGE_LABEL_HEIGHT + <span class="number">4</span>,</span><br><span class="line">        width: labelWidth + <span class="number">12</span>,</span><br><span class="line">        height: EDGE_LABEL_HEIGHT,</span><br><span class="line">        fill: <span class="string">'#E1EAFF'</span>,</span><br><span class="line">        radius: EDGE_LABEL_HEIGHT / <span class="number">2</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      name: <span class="string">'test-edge-background'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    config.preEdgeText = group.addShape(<span class="string">'text'</span>, &#123;</span><br><span class="line">      attrs: &#123;</span><br><span class="line">        text: cfg?.text,</span><br><span class="line">        fill: <span class="string">'#3370FF'</span>,</span><br><span class="line">        fontWeight: <span class="number">500</span>,</span><br><span class="line">        fontSize: <span class="number">10</span>,</span><br><span class="line">        lineHeight: <span class="number">16</span>,</span><br><span class="line">        textAlign: <span class="string">'center'</span>,</span><br><span class="line">        x: midPoint.x,</span><br><span class="line">        y: midPoint.y,</span><br><span class="line">        width: labelWidth + <span class="number">12</span>,</span><br><span class="line">        height: EDGE_LABEL_HEIGHT,</span><br><span class="line">      &#125;,</span><br><span class="line">      name: <span class="string">'test-edge-text'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">G6.registerEdge(</span><br><span class="line"><span class="string">'test-edge-single'</span>,</span><br><span class="line">&#123;</span><br><span class="line">    afterDraw(cfg, group) &#123;</span><br><span class="line">    <span class="keyword">const</span> config = cfg <span class="keyword">as</span> ModelConfig;</span><br><span class="line">    config.group = group;</span><br><span class="line">    addLabelToEdge(cfg);</span><br><span class="line">    &#125;,</span><br><span class="line">    afterUpdate(cfg) &#123;</span><br><span class="line">    addLabelToEdge(cfg);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">'line'</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">G6.registerEdge(</span><br><span class="line"><span class="string">'test-edge-double'</span>,</span><br><span class="line">&#123;</span><br><span class="line">    afterDraw(cfg, group) &#123;</span><br><span class="line">    <span class="keyword">const</span> config = cfg <span class="keyword">as</span> ModelConfig;</span><br><span class="line">    config.group = group;</span><br><span class="line">    addLabelToEdge(cfg);</span><br><span class="line">    &#125;,</span><br><span class="line">    afterUpdate(cfg) &#123;</span><br><span class="line">    addLabelToEdge(cfg);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">'quadratic'</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="事件监听改变节点和连线样式"><a href="#事件监听改变节点和连线样式" class="headerlink" title="事件监听改变节点和连线样式"></a>事件监听改变节点和连线样式</h2><p>事件监听的代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">highlightLocalNodesAndEdges</span>(<span class="params">graphInstance: IGraph, e: IG6GraphEvent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; localEdges, localNodesId, otherNodesId, otherEdges &#125; =</span><br><span class="line">    getAllLocalNodesAndEdges(graphInstance, e.item?.getModel().id <span class="keyword">as</span> <span class="built_in">string</span>);</span><br><span class="line"></span><br><span class="line">  localEdges.forEach(<span class="function"><span class="params">edge</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(</span><br><span class="line">      edge.getModel().id <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">      <span class="string">'status'</span>,</span><br><span class="line">      ItemStatus.NORMAL,</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  otherEdges.forEach(<span class="function"><span class="params">edge</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(</span><br><span class="line">      edge.getModel().id <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">      <span class="string">'status'</span>,</span><br><span class="line">      ItemStatus.OPACITY,</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  localNodesId.forEach(<span class="function"><span class="params">nodeId</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(nodeId <span class="keyword">as</span> <span class="built_in">string</span>, <span class="string">'status'</span>, ItemStatus.NORMAL);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  otherNodesId.forEach(<span class="function"><span class="params">nodeId</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(nodeId <span class="keyword">as</span> <span class="built_in">string</span>, <span class="string">'status'</span>, ItemStatus.OPACITY);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">highlightAllNodesAndGraph</span>(<span class="params">graphInstance: IGraph</span>) </span>&#123;</span><br><span class="line">  graphInstance.findAll(<span class="string">'edge'</span>, <span class="function"><span class="params">edge</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(edge, <span class="string">'status'</span>, ItemStatus.NORMAL);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  graphInstance.findAll(<span class="string">'node'</span>, <span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">    graphInstance.setItemState(node, <span class="string">'status'</span>, ItemStatus.NORMAL);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useInternalEventListener</span>(<span class="params">graphInstance: IGraph | <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onMouseMoveOnNode</span>(<span class="params">e: IG6GraphEvent</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !e.target.cfg.name?.includes(<span class="string">'test-node--name-'</span>) &amp;&amp;</span><br><span class="line">        graphInstance</span><br><span class="line">      ) &#123;</span><br><span class="line">        highlightLocalNodesAndEdges(graphInstance, e);</span><br><span class="line">        graphInstance.setItemState(e.item <span class="keyword">as</span> Item, <span class="string">'status'</span>, ItemStatus.ACTIVE);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onMouseLeaveNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (graphInstance) &#123;</span><br><span class="line">        highlightAllNodesAndGraph(graphInstance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    graphInstance?.on(<span class="string">'node:mousemove'</span>, onMouseMoveOnNode);</span><br><span class="line"></span><br><span class="line">    graphInstance?.on(<span class="string">'node:mouseleave'</span>, onMouseLeaveNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      graphInstance?.off(<span class="string">'node:mousemove'</span>, onMouseMoveOnNode);</span><br><span class="line"></span><br><span class="line">      graphInstance?.off(<span class="string">'node:mouseleave'</span>, onMouseLeaveNode);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [graphInstance]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="布局算法和拖拽节点"><a href="#布局算法和拖拽节点" class="headerlink" title="布局算法和拖拽节点"></a>布局算法和拖拽节点</h2><p>G6其实自带了一个力导向布局，不过很怪，其效果和d3的不一样，且拖拽时不支持只有碰撞检测</p>
<p>这里有几个难点：</p>
<ul>
<li>如何使用d3的力导向布局，这里主要是d3会改变点的数据结构，导致G6执行异常</li>
<li>如果自己实现碰撞检测</li>
<li>拖拽节点的时候，如何平滑一点</li>
</ul>
<p>解决方案如下：</p>
<ul>
<li>用Promise封装d3的布局算法，在监听到end事件之后再把数据处理成G6支持的格式，不然没等所有tick都完成就让G6渲染，到一半的时候，d3又把数据格式改了，就会报错</li>
<li>自己实现的碰撞检测其实简单判断下节点之间的距离，如果小于一定值，就把其他节点推开，然后记录被推开的节点，算一被推开的节点和所有节点之间的距离，如果还是有接近的，再修改位置并继续递归这一轮修改位置的节点，为了防止栈溢出，可以设置最大递归30层</li>
<li>如果每次计算完成节点后调用refreshPosition方法，其实会导致线条抖动，解决方案是开启force布局，于是可以用layout来实现平滑的重新渲染，但是所有节点的位置使用fx和fy来设置，防止力导向布局修改位置</li>
</ul>
<p>代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> REFRESH_NODE_POSITION_RECURSION_COUNT = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">const</span> REFRESH_NODE_COLLIDE_RADIUS = <span class="number">150</span>;</span><br><span class="line"><span class="keyword">const</span> REFRESH_NODE_COLLIDE_RADIUS_SEQUARE = <span class="built_in">Math</span>.pow(</span><br><span class="line">  REFRESH_NODE_COLLIDE_RADIUS,</span><br><span class="line">  <span class="number">2</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTwoNodeDistance</span>(<span class="params">node1: NodeConfig, node2: NodeConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> distance =</span><br><span class="line">    <span class="built_in">Math</span>.pow((node1.x <span class="keyword">as</span> <span class="built_in">number</span>) - (node2.x <span class="keyword">as</span> <span class="built_in">number</span>), <span class="number">2</span>) +</span><br><span class="line">    <span class="built_in">Math</span>.pow((node1.y <span class="keyword">as</span> <span class="built_in">number</span>) - (node2.y <span class="keyword">as</span> <span class="built_in">number</span>), <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(distance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">refreshNodesPositionHelper</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dragedNode: NodeConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">  positionChangedNodes: NodeConfig[],</span></span></span><br><span class="line"><span class="function"><span class="params">  allNodes: NodeConfig[],</span></span></span><br><span class="line"><span class="function"><span class="params">  deep = 0,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (deep &gt; REFRESH_NODE_POSITION_RECURSION_COUNT) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextPositionChangedNodesSet = <span class="keyword">new</span> Set&lt;NodeConfig&gt;();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> positionChangedNode of positionChangedNodes) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> everyNode of allNodes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (positionChangedNode.id === everyNode.id) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> distance = getTwoNodeDistance(positionChangedNode, everyNode);</span><br><span class="line">      <span class="keyword">if</span> (distance &lt; REFRESH_NODE_COLLIDE_RADIUS) &#123;</span><br><span class="line">        nextPositionChangedNodesSet.add(everyNode);</span><br><span class="line">        <span class="keyword">const</span> detaX = <span class="built_in">Math</span>.abs(</span><br><span class="line">          (positionChangedNode.x <span class="keyword">as</span> <span class="built_in">number</span>) - (everyNode.x <span class="keyword">as</span> <span class="built_in">number</span>),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> detaY = <span class="built_in">Math</span>.abs(</span><br><span class="line">          (positionChangedNode.y <span class="keyword">as</span> <span class="built_in">number</span>) - (everyNode.y <span class="keyword">as</span> <span class="built_in">number</span>),</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一元二次方程组求根公式 2 * moveDistance^2 + 2(detaX + detaY)*moveDistance = REFRESH_NODE_COLLIDE_RADIUS_SEQUARE - (detaX^2 + detaY^2)</span></span><br><span class="line">        <span class="keyword">const</span> a = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">const</span> b = <span class="number">2</span> * (detaX + detaY);</span><br><span class="line">        <span class="keyword">const</span> c =</span><br><span class="line">          detaX * detaX + detaY * detaY - REFRESH_NODE_COLLIDE_RADIUS_SEQUARE;</span><br><span class="line">        <span class="keyword">const</span> moveDistance = (<span class="built_in">Math</span>.sqrt(b * b - <span class="number">4</span> * a * c) - b) / (<span class="number">2</span> * a);</span><br><span class="line"></span><br><span class="line">        everyNode.x =</span><br><span class="line">          (everyNode.x <span class="keyword">as</span> <span class="built_in">number</span>) +</span><br><span class="line">          ((everyNode.x <span class="keyword">as</span> <span class="built_in">number</span>) - (positionChangedNode.x <span class="keyword">as</span> <span class="built_in">number</span>) &gt; <span class="number">0</span></span><br><span class="line">            ? <span class="number">1</span></span><br><span class="line">            : <span class="number">-1</span>) *</span><br><span class="line">            moveDistance;</span><br><span class="line"></span><br><span class="line">        everyNode.y =</span><br><span class="line">          (everyNode.y <span class="keyword">as</span> <span class="built_in">number</span>) +</span><br><span class="line">          ((everyNode.y <span class="keyword">as</span> <span class="built_in">number</span>) - (positionChangedNode.y <span class="keyword">as</span> <span class="built_in">number</span>) &gt; <span class="number">0</span></span><br><span class="line">            ? <span class="number">1</span></span><br><span class="line">            : <span class="number">-1</span>) *</span><br><span class="line">            moveDistance;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextPositionChangedNodesSet.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> nextPositionChangedNodes: NodeConfig[] = [];</span><br><span class="line">    nextPositionChangedNodesSet.forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">      nextPositionChangedNodes.push(value);</span><br><span class="line">    &#125;);</span><br><span class="line">    refreshNodesPositionHelper(</span><br><span class="line">      dragedNode,</span><br><span class="line">      nextPositionChangedNodes,</span><br><span class="line">      allNodes,</span><br><span class="line">      deep + <span class="number">1</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    allNodes.forEach(<span class="function"><span class="params">node</span> =&gt;</span> &#123;</span><br><span class="line">      node.fx = node.x;</span><br><span class="line">      node.fy = node.y;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onNodeDrag</span>(<span class="params">e: IG6GraphEvent</span>) </span>&#123;</span><br><span class="line">    graphInstance?.layout();</span><br><span class="line">    <span class="keyword">const</span> model = e.item?.get(<span class="string">'model'</span>);</span><br><span class="line">    model.x = e.x;</span><br><span class="line">    model.y = e.y;</span><br><span class="line">    model.fx = e.x;</span><br><span class="line">    model.fy = e.y;</span><br><span class="line">    <span class="keyword">const</span> allNodes = graphInstance</span><br><span class="line">    ?.findAll(<span class="string">'node'</span>, <span class="function"><span class="params">node</span> =&gt;</span> node.getID() !== e.item?.getID())</span><br><span class="line">    .map(<span class="function"><span class="params">node</span> =&gt;</span> node.getModel()) <span class="keyword">as</span> NodeConfig[];</span><br><span class="line"></span><br><span class="line">    refreshNodesPositionHelper(model, [model], allNodes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onMouseMoveOnNode</span>(<span class="params">e: IG6GraphEvent</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">    !e.target.cfg.name?.includes(<span class="string">'test-node--name-'</span>) &amp;&amp;</span><br><span class="line">    graphInstance</span><br><span class="line">    ) &#123;</span><br><span class="line">    highlightLocalNodesAndEdges(graphInstance, e);</span><br><span class="line">    graphInstance.setItemState(e.item <span class="keyword">as</span> Item, <span class="string">'status'</span>, ItemStatus.ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onMouseLeaveNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (graphInstance) &#123;</span><br><span class="line">    highlightAllNodesAndGraph(graphInstance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graphInstance?.on(<span class="string">'node:drag'</span>, onNodeDrag);</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Ray Sun
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sunra.top/2023/03/10/g6-relationship-graph/" title="如何用G6开发一个关系图谱">https://sunra.top/2023/03/10/g6-relationship-graph/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/03/05/management-methods-of-technical-people/" rel="prev" title="技术人的管理方法论（一）—— 管理的基本框架">
      <i class="fa fa-chevron-left"></i> 技术人的管理方法论（一）—— 管理的基本框架
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/03/18/tailwindcss-introduction-md/" rel="next" title="Tailwind CSS 入门">
      Tailwind CSS 入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#最终效果"><span class="nav-number">1.</span> <span class="nav-text">最终效果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#具体实现"><span class="nav-number">2.</span> <span class="nav-text">具体实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义节点"><span class="nav-number">2.1.</span> <span class="nav-text">自定义节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连线"><span class="nav-number">2.2.</span> <span class="nav-text">连线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件监听改变节点和连线样式"><span class="nav-number">2.3.</span> <span class="nav-text">事件监听改变节点和连线样式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#布局算法和拖拽节点"><span class="nav-number">2.4.</span> <span class="nav-text">布局算法和拖拽节点</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
  <p class="site-author-name" itemprop="name">Ray Sun</p>
  <div class="site-description" itemprop="description">拨开互联网的迷雾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">259</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sun668" title="GitHub → https://github.com/Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <div class="wechat_channel" style="width: 50%;margin-left: 25%;">
        <br>
        <!-- 这里添加你的二维码图片 -->
        <img src="/images/wechat_channel.png">
        <!-- <span>公众号</span> -->
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray Sun</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  

  

</body>
</html>
