<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="本次博客正式进入源码的解析部分，我们主要分析源码中的以下几个部分：  如何进行配置合并与生成，即resolveConfig部分 插件的调用机制，即pluginContainer 模块之间的引用图谱部分，即moduleGraph vite的热更新模块内，即hmr vite的依赖打包优化部分，即optimizeDeps"><meta property="og:type" content="article"><meta property="og:title" content="Vite学习笔记（四）Vite源码分析"><meta property="og:url" content="https://sunra.top/2023/11/04/vite-4-origin-code/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="本次博客正式进入源码的解析部分，我们主要分析源码中的以下几个部分：  如何进行配置合并与生成，即resolveConfig部分 插件的调用机制，即pluginContainer 模块之间的引用图谱部分，即moduleGraph vite的热更新模块内，即hmr vite的依赖打包优化部分，即optimizeDeps"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-11-03T23:01:43.000Z"><meta property="article:modified_time" content="2024-06-08T06:48:39.730Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="技术分享 使用教程 原理 前端 计算机图形学"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/2023/11/04/vite-4-origin-code/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://sunra.top/2023/11/04/vite-4-origin-code/","path":"2023/11/04/vite-4-origin-code/","title":"Vite学习笔记（四）Vite源码分析"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Vite学习笔记（四）Vite源码分析 | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3%E5%92%8C%E5%9F%BA%E6%9C%AC%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">入口和基本逻辑分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">入口分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">主流程分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Vite%E7%9A%84%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90"><span class="nav-number">2.</span> <span class="nav-text">Vite的配置生成</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%BC%95%E7%94%A8%E5%9B%BE%E8%B0%B1"><span class="nav-number">3.</span> <span class="nav-text">模块引用图谱</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%AF%B4%E6%98%8E"><span class="nav-number">3.1.</span> <span class="nav-text">变量说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%9B%B4%E6%94%B9%E6%97%B6%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="nav-number">3.2.</span> <span class="nav-text">文件更改时的处理逻辑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%9D%97%E4%BF%A1%E6%81%AF"><span class="nav-number">3.3.</span> <span class="nav-text">更新模块信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E7%94%9F%E6%88%90%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">3.4.</span> <span class="nav-text">启动时生成内部变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">插件调用机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#resolveId"><span class="nav-number">4.1.</span> <span class="nav-text">resolveId</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load"><span class="nav-number">4.2.</span> <span class="nav-text">load</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#transform"><span class="nav-number">4.3.</span> <span class="nav-text">transform</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-number">5.</span> <span class="nav-text">热更新</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#vite%E4%BB%A3%E7%A0%81%E6%9C%AC%E8%BA%AB%E6%94%B9%E5%8F%98%E9%9C%80%E8%A6%81full-reload"><span class="nav-number">5.1.</span> <span class="nav-text">vite代码本身改变需要full-reload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#html%E6%96%87%E4%BB%B6%E9%9C%80%E8%A6%81full-reload"><span class="nav-number">5.2.</span> <span class="nav-text">html文件需要full-reload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E9%9C%80%E8%A6%81full-reload"><span class="nav-number">5.3.</span> <span class="nav-text">有循环引用需要full-reload</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">一起探索互联网的秘密</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">303</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sunra.top/2023/11/04/vite-4-origin-code/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="一起探索互联网的秘密"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Vite学习笔记（四）Vite源码分析 | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Vite学习笔记（四）Vite源码分析</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-11-04 07:01:43" itemprop="dateCreated datePublished" datetime="2023-11-04T07:01:43+08:00">2023-11-04</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-08 14:48:39" itemprop="dateModified" datetime="2024-06-08T14:48:39+08:00">2024-06-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Packing/" itemprop="url" rel="index"><span itemprop="name">Packing</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline：</span><a title="waline" href="/2023/11/04/vite-4-origin-code/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/2023/11/04/vite-4-origin-code/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>本次博客正式进入源码的解析部分，我们主要分析源码中的以下几个部分：</p><ul><li>如何进行配置合并与生成，即resolveConfig部分</li><li>插件的调用机制，即pluginContainer</li><li>模块之间的引用图谱部分，即moduleGraph</li><li>vite的热更新模块内，即hmr</li><li>vite的依赖打包优化部分，即optimizeDeps</li></ul><span id="more"></span><h1 id="入口和基本逻辑分析"><a href="#入口和基本逻辑分析" class="headerlink" title="入口和基本逻辑分析"></a>入口和基本逻辑分析</h1><p>我们分析的源码版本是4.5.0版本，想要结合源码阅读本博客的可以自己下载对应版本的源码。</p><p>仓库地址是<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/vitejs/vite.git，这是一个monorepo，我们主要关注packages目录下的vite部分。">https://github.com/vitejs/vite.git，这是一个monorepo，我们主要关注packages目录下的vite部分。</a></p><p>vite的源码部分主要分三块，client，node和types，其中types部分主要是定义了一些vite所依赖的一些第三方库的类型的补充，如http的类型，client部分是vite在浏览器端运行的代码，主要是负责处理vite的一些更新逻辑，如服务端发来新的代码更新，如何进行热更新，不是我们这次的重点。</p><p>我们本次的博客的重点是node部分，也就是vite devserver的代码</p><h2 id="入口分析"><a href="#入口分析" class="headerlink" title="入口分析"></a>入口分析</h2><p>那么我们如何找到vite node部分的入口呢？</p><p>我们平时使用vite的时候都是通过命令行的方式，也就是node cli，那么我们就可以去package.json中找到bin配置，里面制定了vite启动执行的代码，我们可以发现它的值是<code>bin/vite.js</code>,我们再去看这个文件，这个文件中的代码不多，大部分是处理命令行参数的，最终运行的代码是下面这一段：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">import</span>(<span class="string">&#x27;../dist/node/cli.js&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也就是引入dist/node下面的cli文件，这个cli.js是的打包出来的，如果查看rollup.config.js就会发现，它对应的就是src/node/cli.ts，那么这个时候我们就找到入口了。</p><p>在cli文件中，使用了<code>cac</code>这个库去生成命令行，我们主要看vite如何启动本地开发服务器的，所以我们找到其中声明vite命令的对应代码，如下：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dev</span></span><br><span class="line">cli</span><br><span class="line">  .<span class="title function_">command</span>(<span class="string">&#x27;[root]&#x27;</span>, <span class="string">&#x27;start dev server&#x27;</span>) <span class="comment">// default command</span></span><br><span class="line">  .<span class="title function_">alias</span>(<span class="string">&#x27;serve&#x27;</span>) <span class="comment">// the command is called &#x27;serve&#x27; in Vite&#x27;s API</span></span><br><span class="line">  .<span class="title function_">alias</span>(<span class="string">&#x27;dev&#x27;</span>) <span class="comment">// alias to align with the script name</span></span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&#x27;--host [host]&#x27;</span>, <span class="string">`[string] specify hostname`</span>, &#123; <span class="attr">type</span>: [convertHost] &#125;)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&#x27;--port &lt;port&gt;&#x27;</span>, <span class="string">`[number] specify port`</span>)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&#x27;--open [path]&#x27;</span>, <span class="string">`[boolean | string] open browser on startup`</span>)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&#x27;--cors&#x27;</span>, <span class="string">`[boolean] enable CORS`</span>)</span><br><span class="line">  .<span class="title function_">option</span>(<span class="string">&#x27;--strictPort&#x27;</span>, <span class="string">`[boolean] exit if specified port is already in use`</span>)</span><br><span class="line">  .<span class="title function_">option</span>(</span><br><span class="line">    <span class="string">&#x27;--force&#x27;</span>,</span><br><span class="line">    <span class="string">`[boolean] force the optimizer to ignore the cache and re-bundle`</span>,</span><br><span class="line">  )</span><br><span class="line">  .<span class="title function_">action</span>(<span class="keyword">async</span> (<span class="attr">root</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">ServerOptions</span> &amp; <span class="title class_">GlobalCLIOptions</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">filterDuplicateOptions</span>(options)</span><br><span class="line">    <span class="comment">// output structure is preserved even after bundling so require()</span></span><br><span class="line">    <span class="comment">// is ok here</span></span><br><span class="line">    <span class="keyword">const</span> &#123; createServer &#125; = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;./server&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> server = <span class="keyword">await</span> <span class="title function_">createServer</span>(&#123;</span><br><span class="line">        root,</span><br><span class="line">        <span class="attr">base</span>: options.<span class="property">base</span>,</span><br><span class="line">        <span class="attr">mode</span>: options.<span class="property">mode</span>,</span><br><span class="line">        <span class="attr">configFile</span>: options.<span class="property">config</span>,</span><br><span class="line">        <span class="attr">logLevel</span>: options.<span class="property">logLevel</span>,</span><br><span class="line">        <span class="attr">clearScreen</span>: options.<span class="property">clearScreen</span>,</span><br><span class="line">        <span class="attr">optimizeDeps</span>: &#123; <span class="attr">force</span>: options.<span class="property">force</span> &#125;,</span><br><span class="line">        <span class="attr">server</span>: <span class="title function_">cleanOptions</span>(options),</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!server.<span class="property">httpServer</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;HTTP server not available&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> server.<span class="title function_">listen</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> info = server.<span class="property">config</span>.<span class="property">logger</span>.<span class="property">info</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> viteStartTime = <span class="variable language_">global</span>.<span class="property">__vite_start_time</span> ?? <span class="literal">false</span></span><br><span class="line">      <span class="keyword">const</span> startupDurationString = viteStartTime</span><br><span class="line">        ? colors.<span class="title function_">dim</span>(</span><br><span class="line">            <span class="string">`ready in <span class="subst">$&#123;colors.reset(</span></span></span><br><span class="line"><span class="subst"><span class="string">              colors.bold(<span class="built_in">Math</span>.ceil(performance.now() - viteStartTime)),</span></span></span><br><span class="line"><span class="subst"><span class="string">            )&#125;</span> ms`</span>,</span><br><span class="line">          )</span><br><span class="line">        : <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">info</span>(</span><br><span class="line">        <span class="string">`\n  <span class="subst">$&#123;colors.green(</span></span></span><br><span class="line"><span class="subst"><span class="string">          <span class="string">`<span class="subst">$&#123;colors.bold(<span class="string">&#x27;VITE&#x27;</span>)&#125;</span> v<span class="subst">$&#123;VERSION&#125;</span>`</span>,</span></span></span><br><span class="line"><span class="subst"><span class="string">        )&#125;</span>  <span class="subst">$&#123;startupDurationString&#125;</span>\n`</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">clear</span>:</span><br><span class="line">            !server.<span class="property">config</span>.<span class="property">logger</span>.<span class="property">hasWarned</span> &amp;&amp;</span><br><span class="line">            !(globalThis <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__vite_cjs_skip_clear_screen</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      server.<span class="title function_">printUrls</span>()</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">customShortcuts</span>: <span class="title class_">CLIShortcut</span>&lt;<span class="keyword">typeof</span> server&gt;[] = []</span><br><span class="line">      <span class="keyword">if</span> (profileSession) &#123;</span><br><span class="line">        customShortcuts.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">          <span class="attr">description</span>: <span class="string">&#x27;start/stop the profiler&#x27;</span>,</span><br><span class="line">          <span class="keyword">async</span> <span class="title function_">action</span>(<span class="params">server</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (profileSession) &#123;</span><br><span class="line">              <span class="keyword">await</span> <span class="title function_">stopProfiler</span>(server.<span class="property">config</span>.<span class="property">logger</span>.<span class="property">info</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> inspector = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="string">&#x27;node:inspector&#x27;</span>).<span class="title function_">then</span>(</span><br><span class="line">                <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">default</span>,</span><br><span class="line">              )</span><br><span class="line">              <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                profileSession = <span class="keyword">new</span> inspector.<span class="title class_">Session</span>()</span><br><span class="line">                profileSession.<span class="title function_">connect</span>()</span><br><span class="line">                profileSession.<span class="title function_">post</span>(<span class="string">&#x27;Profiler.enable&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  profileSession!.<span class="title function_">post</span>(<span class="string">&#x27;Profiler.start&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    server.<span class="property">config</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&#x27;Profiler started&#x27;</span>)</span><br><span class="line">                    <span class="title function_">res</span>()</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      server.<span class="title function_">bindCLIShortcuts</span>(&#123; <span class="attr">print</span>: <span class="literal">true</span>, customShortcuts &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">const</span> logger = <span class="title function_">createLogger</span>(options.<span class="property">logLevel</span>)</span><br><span class="line">      logger.<span class="title function_">error</span>(colors.<span class="title function_">red</span>(<span class="string">`error when starting dev server:\n<span class="subst">$&#123;e.stack&#125;</span>`</span>), &#123;</span><br><span class="line">        <span class="attr">error</span>: e,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="title function_">stopProfiler</span>(logger.<span class="property">info</span>)</span><br><span class="line">      process.<span class="title function_">exit</span>(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>这段代码中最主要的就是action函数，其中就是调用了<code>createServer</code>方法，这个时候我们就找到了本地服务器启动的真正代码，即createServer函数</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createServer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  inlineConfig: InlineConfig = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ViteDevServer</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_createServer</span>(inlineConfig, &#123; <span class="attr">ws</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="主流程分析"><a href="#主流程分析" class="headerlink" title="主流程分析"></a>主流程分析</h2><p>接下来我们简单分析下这个createServer的主流程，我先把完整的代码贴在这里，有兴趣的可以读一下，也可以直接跳过看后面的分析</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">_createServer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  inlineConfig: InlineConfig = &#123;&#125;,</span></span><br><span class="line"><span class="params">  options: &#123; ws: <span class="built_in">boolean</span> &#125;,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ViteDevServer</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> config = <span class="keyword">await</span> <span class="title function_">resolveConfig</span>(inlineConfig, <span class="string">&#x27;serve&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; root, <span class="attr">server</span>: serverConfig &#125; = config</span><br><span class="line">  <span class="keyword">const</span> httpsOptions = <span class="keyword">await</span> <span class="title function_">resolveHttpsConfig</span>(config.<span class="property">server</span>.<span class="property">https</span>)</span><br><span class="line">  <span class="keyword">const</span> &#123; middlewareMode &#125; = serverConfig</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> resolvedWatchOptions = <span class="title function_">resolveChokidarOptions</span>(config, &#123;</span><br><span class="line">    <span class="attr">disableGlobbing</span>: <span class="literal">true</span>,</span><br><span class="line">    ...serverConfig.<span class="property">watch</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> middlewares = <span class="title function_">connect</span>() <span class="keyword">as</span> <span class="title class_">Connect</span>.<span class="property">Server</span></span><br><span class="line">  <span class="keyword">const</span> httpServer = middlewareMode</span><br><span class="line">    ? <span class="literal">null</span></span><br><span class="line">    : <span class="keyword">await</span> <span class="title function_">resolveHttpServer</span>(serverConfig, middlewares, httpsOptions)</span><br><span class="line">  <span class="keyword">const</span> ws = <span class="title function_">createWebSocketServer</span>(httpServer, config, httpsOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (httpServer) &#123;</span><br><span class="line">    <span class="title function_">setClientErrorHandler</span>(httpServer, config.<span class="property">logger</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// eslint-disable-next-line eqeqeq</span></span><br><span class="line">  <span class="keyword">const</span> watchEnabled = serverConfig.<span class="property">watch</span> !== <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> watcher = watchEnabled</span><br><span class="line">    ? (chokidar.<span class="title function_">watch</span>(</span><br><span class="line">        <span class="comment">// config file dependencies and env file might be outside of root</span></span><br><span class="line">        [root, ...config.<span class="property">configFileDependencies</span>, config.<span class="property">envDir</span>],</span><br><span class="line">        resolvedWatchOptions,</span><br><span class="line">      ) <span class="keyword">as</span> <span class="title class_">FSWatcher</span>)</span><br><span class="line">    : <span class="title function_">createNoopWatcher</span>(resolvedWatchOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">moduleGraph</span>: <span class="title class_">ModuleGraph</span> = <span class="keyword">new</span> <span class="title class_">ModuleGraph</span>(<span class="function">(<span class="params">url, ssr</span>) =&gt;</span></span><br><span class="line">    container.<span class="title function_">resolveId</span>(url, <span class="literal">undefined</span>, &#123; ssr &#125;),</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> container = <span class="keyword">await</span> <span class="title function_">createPluginContainer</span>(config, moduleGraph, watcher)</span><br><span class="line">  <span class="keyword">const</span> closeHttpServer = <span class="title function_">createServerCloseFn</span>(httpServer)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">exitProcess</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">server</span>: <span class="title class_">ViteDevServer</span> = &#123;</span><br><span class="line">    config,</span><br><span class="line">    middlewares,</span><br><span class="line">    httpServer,</span><br><span class="line">    watcher,</span><br><span class="line">    <span class="attr">pluginContainer</span>: container,</span><br><span class="line">    ws,</span><br><span class="line">    moduleGraph,</span><br><span class="line">    <span class="attr">resolvedUrls</span>: <span class="literal">null</span>, <span class="comment">// will be set on listen</span></span><br><span class="line">    <span class="title function_">ssrTransform</span>(<span class="params"></span></span><br><span class="line"><span class="params">      code: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      inMap: SourceMap | &#123; mappings: <span class="string">&#x27;&#x27;</span> &#125; | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">      url: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      originalCode = code,</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">ssrTransform</span>(code, inMap, url, originalCode, server.<span class="property">config</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">transformRequest</span>(<span class="params">url, options</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">transformRequest</span>(url, server, options)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">warmupRequest</span>(<span class="params">url, options</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">transformRequest</span>(url, server, options).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          e?.<span class="property">code</span> === <span class="variable constant_">ERR_OUTDATED_OPTIMIZED_DEP</span> ||</span><br><span class="line">          e?.<span class="property">code</span> === <span class="variable constant_">ERR_CLOSED_SERVER</span></span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// these are expected errors</span></span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Unexpected error, log the issue but avoid an unhandled exception</span></span><br><span class="line">        server.<span class="property">config</span>.<span class="property">logger</span>.<span class="title function_">error</span>(<span class="string">`Pre-transform error: <span class="subst">$&#123;e.message&#125;</span>`</span>, &#123;</span><br><span class="line">          <span class="attr">error</span>: e,</span><br><span class="line">          <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">transformIndexHtml</span>: <span class="literal">null</span>!, <span class="comment">// to be immediately set</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">ssrLoadModule</span>(<span class="params">url, opts?: &#123; fixStacktrace?: <span class="built_in">boolean</span> &#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDepsOptimizerEnabled</span>(config, <span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">initDevSsrDepsOptimizer</span>(config, server)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">ssrLoadModule</span>(</span><br><span class="line">        url,</span><br><span class="line">        server,</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        opts?.<span class="property">fixStacktrace</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">ssrFixStacktrace</span>(<span class="params">e</span>) &#123;</span><br><span class="line">      <span class="title function_">ssrFixStacktrace</span>(e, moduleGraph)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">ssrRewriteStacktrace</span>(<span class="params">stack: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">ssrRewriteStacktrace</span>(stack, moduleGraph)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">reloadModule</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (serverConfig.<span class="property">hmr</span> !== <span class="literal">false</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">file</span>) &#123;</span><br><span class="line">        <span class="title function_">updateModules</span>(<span class="variable language_">module</span>.<span class="property">file</span>, [<span class="variable language_">module</span>], <span class="title class_">Date</span>.<span class="title function_">now</span>(), server)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">listen</span>(<span class="params">port?: <span class="built_in">number</span>, isRestart?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">startServer</span>(server, port)</span><br><span class="line">      <span class="keyword">if</span> (httpServer) &#123;</span><br><span class="line">        server.<span class="property">resolvedUrls</span> = <span class="keyword">await</span> <span class="title function_">resolveServerUrls</span>(</span><br><span class="line">          httpServer,</span><br><span class="line">          config.<span class="property">server</span>,</span><br><span class="line">          config,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (!isRestart &amp;&amp; config.<span class="property">server</span>.<span class="property">open</span>) server.<span class="title function_">openBrowser</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> server</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">openBrowser</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> options = server.<span class="property">config</span>.<span class="property">server</span></span><br><span class="line">      <span class="keyword">const</span> url =</span><br><span class="line">        server.<span class="property">resolvedUrls</span>?.<span class="property">local</span>[<span class="number">0</span>] ?? server.<span class="property">resolvedUrls</span>?.<span class="property">network</span>[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (url) &#123;</span><br><span class="line">        <span class="keyword">const</span> path =</span><br><span class="line">          <span class="keyword">typeof</span> options.<span class="property">open</span> === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">            ? <span class="keyword">new</span> <span class="title function_">URL</span>(options.<span class="property">open</span>, url).<span class="property">href</span></span><br><span class="line">            : url</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We know the url that the browser would be opened to, so we can</span></span><br><span class="line">        <span class="comment">// start the request while we are awaiting the browser. This will</span></span><br><span class="line">        <span class="comment">// start the crawling of static imports ~500ms before.</span></span><br><span class="line">        <span class="comment">// preTransformRequests needs to be enabled for this optimization.</span></span><br><span class="line">        <span class="keyword">if</span> (server.<span class="property">config</span>.<span class="property">server</span>.<span class="property">preTransformRequests</span>) &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">httpGet</span>(</span><br><span class="line">              path,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                  <span class="comment">// Allow the history middleware to redirect to /index.html</span></span><br><span class="line">                  <span class="title class_">Accept</span>: <span class="string">&#x27;text/html&#x27;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                res.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                  <span class="comment">// Ignore response, scripts discovered while processing the entry</span></span><br><span class="line">                  <span class="comment">// will be preprocessed (server.config.server.preTransformRequests)</span></span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;,</span><br><span class="line">            )</span><br><span class="line">              .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// Ignore errors</span></span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">end</span>()</span><br><span class="line">          &#125;, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">_openBrowser</span>(path, <span class="literal">true</span>, server.<span class="property">config</span>.<span class="property">logger</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.<span class="property">config</span>.<span class="property">logger</span>.<span class="title function_">warn</span>(<span class="string">&#x27;No URL available to open in browser&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!middlewareMode) &#123;</span><br><span class="line">        process.<span class="title function_">off</span>(<span class="string">&#x27;SIGTERM&#x27;</span>, exitProcess)</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">CI</span> !== <span class="string">&#x27;true&#x27;</span>) &#123;</span><br><span class="line">          process.<span class="property">stdin</span>.<span class="title function_">off</span>(<span class="string">&#x27;end&#x27;</span>, exitProcess)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([</span><br><span class="line">        watcher.<span class="title function_">close</span>(),</span><br><span class="line">        ws.<span class="title function_">close</span>(),</span><br><span class="line">        container.<span class="title function_">close</span>(),</span><br><span class="line">        <span class="title function_">getDepsOptimizer</span>(server.<span class="property">config</span>)?.<span class="title function_">close</span>(),</span><br><span class="line">        <span class="title function_">getDepsOptimizer</span>(server.<span class="property">config</span>, <span class="literal">true</span>)?.<span class="title function_">close</span>(),</span><br><span class="line">        <span class="title function_">closeHttpServer</span>(),</span><br><span class="line">      ])</span><br><span class="line">      <span class="comment">// Await pending requests. We throw early in transformRequest</span></span><br><span class="line">      <span class="comment">// and in hooks if the server is closing for non-ssr requests,</span></span><br><span class="line">      <span class="comment">// so the import analysis plugin stops pre-transforming static</span></span><br><span class="line">      <span class="comment">// imports and this block is resolved sooner.</span></span><br><span class="line">      <span class="comment">// During SSR, we let pending requests finish to avoid exposing</span></span><br><span class="line">      <span class="comment">// the server closed error to the users.</span></span><br><span class="line">      <span class="keyword">while</span> (server.<span class="property">_pendingRequests</span>.<span class="property">size</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(</span><br><span class="line">          [...server.<span class="property">_pendingRequests</span>.<span class="title function_">values</span>()].<span class="title function_">map</span>(</span><br><span class="line">            <span class="function">(<span class="params">pending</span>) =&gt;</span> pending.<span class="property">request</span>,</span><br><span class="line">          ),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      server.<span class="property">resolvedUrls</span> = <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="variable constant_">ASYNC_DISPOSE</span>]() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">close</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">printUrls</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (server.<span class="property">resolvedUrls</span>) &#123;</span><br><span class="line">        <span class="title function_">printServerUrls</span>(</span><br><span class="line">          server.<span class="property">resolvedUrls</span>,</span><br><span class="line">          serverConfig.<span class="property">host</span>,</span><br><span class="line">          config.<span class="property">logger</span>.<span class="property">info</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (middlewareMode) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;cannot print server URLs in middleware mode.&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">          <span class="string">&#x27;cannot print server URLs before server.listen is called.&#x27;</span>,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">bindCLIShortcuts</span>(<span class="params">options</span>) &#123;</span><br><span class="line">      <span class="title function_">bindCLIShortcuts</span>(server, options)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">restart</span>(<span class="params">forceOptimize?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!server.<span class="property">_restartPromise</span>) &#123;</span><br><span class="line">        server.<span class="property">_forceOptimizeOnRestart</span> = !!forceOptimize</span><br><span class="line">        server.<span class="property">_restartPromise</span> = <span class="title function_">restartServer</span>(server).<span class="title function_">finally</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          server.<span class="property">_restartPromise</span> = <span class="literal">null</span></span><br><span class="line">          server.<span class="property">_forceOptimizeOnRestart</span> = <span class="literal">false</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> server.<span class="property">_restartPromise</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">_restartPromise</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">_importGlobMap</span>: <span class="keyword">new</span> <span class="title class_">Map</span>(),</span><br><span class="line">    <span class="attr">_forceOptimizeOnRestart</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">_pendingRequests</span>: <span class="keyword">new</span> <span class="title class_">Map</span>(),</span><br><span class="line">    <span class="attr">_fsDenyGlob</span>: <span class="title function_">picomatch</span>(config.<span class="property">server</span>.<span class="property">fs</span>.<span class="property">deny</span>, &#123; <span class="attr">matchBase</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">    <span class="attr">_shortcutsOptions</span>: <span class="literal">undefined</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server.<span class="property">transformIndexHtml</span> = <span class="title function_">createDevHtmlTransformFn</span>(server)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!middlewareMode) &#123;</span><br><span class="line">    exitProcess = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> server.<span class="title function_">close</span>()</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        process.<span class="title function_">exit</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    process.<span class="title function_">once</span>(<span class="string">&#x27;SIGTERM&#x27;</span>, exitProcess)</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">CI</span> !== <span class="string">&#x27;true&#x27;</span>) &#123;</span><br><span class="line">      process.<span class="property">stdin</span>.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, exitProcess)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onHMRUpdate</span> = <span class="keyword">async</span> (<span class="params">file: <span class="built_in">string</span>, configOnly: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (serverConfig.<span class="property">hmr</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">handleHMRUpdate</span>(file, server, configOnly)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">          <span class="attr">err</span>: <span class="title function_">prepareError</span>(err),</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">onFileAddUnlink</span> = <span class="keyword">async</span> (<span class="params">file: <span class="built_in">string</span>, isUnlink: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">    file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">    <span class="keyword">await</span> container.<span class="title function_">watchChange</span>(file, &#123; <span class="attr">event</span>: isUnlink ? <span class="string">&#x27;delete&#x27;</span> : <span class="string">&#x27;create&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">handleFileAddUnlink</span>(file, server, isUnlink)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  watcher.<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">async</span> (file) =&gt; &#123;</span><br><span class="line">    file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">    <span class="keyword">await</span> container.<span class="title function_">watchChange</span>(file, &#123; <span class="attr">event</span>: <span class="string">&#x27;update&#x27;</span> &#125;)</span><br><span class="line">    <span class="comment">// invalidate module graph cache on file change</span></span><br><span class="line">    moduleGraph.<span class="title function_">onFileChange</span>(file)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">false</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  watcher.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, <span class="function">(<span class="params">file</span>) =&gt;</span> <span class="title function_">onFileAddUnlink</span>(file, <span class="literal">false</span>))</span><br><span class="line">  watcher.<span class="title function_">on</span>(<span class="string">&#x27;unlink&#x27;</span>, <span class="function">(<span class="params">file</span>) =&gt;</span> <span class="title function_">onFileAddUnlink</span>(file, <span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&#x27;vite:invalidate&#x27;</span>, <span class="keyword">async</span> (&#123; path, message &#125;: <span class="title class_">InvalidatePayload</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> mod = moduleGraph.<span class="property">urlToModuleMap</span>.<span class="title function_">get</span>(path)</span><br><span class="line">    <span class="keyword">if</span> (mod &amp;&amp; mod.<span class="property">isSelfAccepting</span> &amp;&amp; mod.<span class="property">lastHMRTimestamp</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      config.<span class="property">logger</span>.<span class="title function_">info</span>(</span><br><span class="line">        colors.<span class="title function_">yellow</span>(<span class="string">`hmr invalidate `</span>) +</span><br><span class="line">          colors.<span class="title function_">dim</span>(path) +</span><br><span class="line">          (message ? <span class="string">` <span class="subst">$&#123;message&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">        &#123; <span class="attr">timestamp</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">const</span> file = <span class="title function_">getShortName</span>(mod.<span class="property">file</span>!, config.<span class="property">root</span>)</span><br><span class="line">      <span class="title function_">updateModules</span>(</span><br><span class="line">        file,</span><br><span class="line">        [...mod.<span class="property">importers</span>],</span><br><span class="line">        mod.<span class="property">lastHMRTimestamp</span>,</span><br><span class="line">        server,</span><br><span class="line">        <span class="literal">true</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!middlewareMode &amp;&amp; httpServer) &#123;</span><br><span class="line">    httpServer.<span class="title function_">once</span>(<span class="string">&#x27;listening&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// update actual port since this may be different from initial value</span></span><br><span class="line">      serverConfig.<span class="property">port</span> = (httpServer.<span class="title function_">address</span>() <span class="keyword">as</span> net.<span class="property">AddressInfo</span>).<span class="property">port</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply server configuration hooks from plugins</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">postHooks</span>: ((<span class="function">() =&gt;</span> <span class="built_in">void</span>) | <span class="built_in">void</span>)[] = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> config.<span class="title function_">getSortedPluginHooks</span>(<span class="string">&#x27;configureServer&#x27;</span>)) &#123;</span><br><span class="line">    postHooks.<span class="title function_">push</span>(<span class="keyword">await</span> <span class="title function_">hook</span>(server))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Internal middlewares ------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// request timer</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">DEBUG</span>) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">timeMiddleware</span>(root))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cors (enabled by default)</span></span><br><span class="line">  <span class="keyword">const</span> &#123; cors &#125; = serverConfig</span><br><span class="line">  <span class="keyword">if</span> (cors !== <span class="literal">false</span>) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">corsMiddleware</span>(<span class="keyword">typeof</span> cors === <span class="string">&#x27;boolean&#x27;</span> ? &#123;&#125; : cors))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// proxy</span></span><br><span class="line">  <span class="keyword">const</span> &#123; proxy &#125; = serverConfig</span><br><span class="line">  <span class="keyword">if</span> (proxy) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">proxyMiddleware</span>(httpServer, proxy, config))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// base</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">base</span> !== <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">baseMiddleware</span>(config.<span class="property">rawBase</span>, middlewareMode))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// open in editor support</span></span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="string">&#x27;/__open-in-editor&#x27;</span>, <span class="title function_">launchEditorMiddleware</span>())</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ping request handler</span></span><br><span class="line">  <span class="comment">// Keep the named function. The name is visible in debug logs via `DEBUG=connect:dispatcher ...`</span></span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="keyword">function</span> <span class="title function_">viteHMRPingMiddleware</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">headers</span>[<span class="string">&#x27;accept&#x27;</span>] === <span class="string">&#x27;text/x-vite-ping&#x27;</span>) &#123;</span><br><span class="line">      res.<span class="title function_">writeHead</span>(<span class="number">204</span>).<span class="title function_">end</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// serve static files under /public</span></span><br><span class="line">  <span class="comment">// this applies before the transform middleware so that these files are served</span></span><br><span class="line">  <span class="comment">// as-is without transforms.</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">publicDir</span>) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(</span><br><span class="line">      <span class="title function_">servePublicMiddleware</span>(config.<span class="property">publicDir</span>, config.<span class="property">server</span>.<span class="property">headers</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// main transform middleware</span></span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="title function_">transformMiddleware</span>(server))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// serve static files</span></span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="title function_">serveRawFsMiddleware</span>(server))</span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="title function_">serveStaticMiddleware</span>(root, server))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// html fallback</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">appType</span> === <span class="string">&#x27;spa&#x27;</span> || config.<span class="property">appType</span> === <span class="string">&#x27;mpa&#x27;</span>) &#123;</span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">htmlFallbackMiddleware</span>(root, config.<span class="property">appType</span> === <span class="string">&#x27;spa&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// run post config hooks</span></span><br><span class="line">  <span class="comment">// This is applied before the html middleware so that user middleware can</span></span><br><span class="line">  <span class="comment">// serve custom content instead of index.html.</span></span><br><span class="line">  postHooks.<span class="title function_">forEach</span>(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn &amp;&amp; <span class="title function_">fn</span>())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">appType</span> === <span class="string">&#x27;spa&#x27;</span> || config.<span class="property">appType</span> === <span class="string">&#x27;mpa&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// transform index.html</span></span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">indexHtmlMiddleware</span>(root, server))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handle 404s</span></span><br><span class="line">    middlewares.<span class="title function_">use</span>(<span class="title function_">notFoundMiddleware</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// error handler</span></span><br><span class="line">  middlewares.<span class="title function_">use</span>(<span class="title function_">errorMiddleware</span>(server, middlewareMode))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// httpServer.listen can be called multiple times</span></span><br><span class="line">  <span class="comment">// when port when using next port number</span></span><br><span class="line">  <span class="comment">// this code is to avoid calling buildStart multiple times</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">initingServer</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> serverInited = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">initServer</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (serverInited) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> (initingServer) <span class="keyword">return</span> initingServer</span><br><span class="line"></span><br><span class="line">    initingServer = (<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> container.<span class="title function_">buildStart</span>(&#123;&#125;)</span><br><span class="line">      <span class="comment">// start deps optimizer after all container plugins are ready</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDepsOptimizerEnabled</span>(config, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">initDepsOptimizer</span>(config, server)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">warmupFiles</span>(server)</span><br><span class="line">      initingServer = <span class="literal">undefined</span></span><br><span class="line">      serverInited = <span class="literal">true</span></span><br><span class="line">    &#125;)()</span><br><span class="line">    <span class="keyword">return</span> initingServer</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!middlewareMode &amp;&amp; httpServer) &#123;</span><br><span class="line">    <span class="comment">// overwrite listen to init optimizer before server start</span></span><br><span class="line">    <span class="keyword">const</span> listen = httpServer.<span class="property">listen</span>.<span class="title function_">bind</span>(httpServer)</span><br><span class="line">    httpServer.<span class="property">listen</span> = (<span class="keyword">async</span> (<span class="attr">port</span>: <span class="built_in">number</span>, ...<span class="attr">args</span>: <span class="built_in">any</span>[]) =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ensure ws server started</span></span><br><span class="line">        ws.<span class="title function_">listen</span>()</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">initServer</span>()</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        httpServer.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, e)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">listen</span>(port, ...args)</span><br><span class="line">    &#125;) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">ws</span>) &#123;</span><br><span class="line">      ws.<span class="title function_">listen</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">initServer</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> server</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码按照功能主要可以分为以下几个部分：</p><ol><li>运行配置的生成，即<code>resolveConfig</code>部分</li><li>定义httpServer及其middleware，后续使用</li><li>定义watcher，用于监听文件变化</li><li>定义moduleGraph，用于存储和分析模块之间的依赖关系</li><li>定义pluginContainer，用于合并所有插件的hook，并对外暴露调用方法</li><li>给watcher监听文件变化的方法添加回调函数，其中会更新moduleGraph，并处理HMR</li><li>给middleware添加需要的中间件，比如进行文件处理的<code>middlewares.use(transformMiddleware(server))</code>，在这个中间件中，会调用pluginContianer的经过聚合之后的transform，具体如何聚合的后面我们专门分析</li><li>返回创建的http服务器，其中有listen，close等函数，可以用来启动服务器。</li></ol><h1 id="Vite的配置生成"><a href="#Vite的配置生成" class="headerlink" title="Vite的配置生成"></a>Vite的配置生成</h1><p>这段的逻辑在我们的resolveConfig中，其中包含了vite是如何进行配置生成与合并的，内容比较多，我们挑选其中几个讲，如果有需要，可以自己去阅读下源码。</p><ol><li>加载配置文件的逻辑</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; configFile &#125; = config</span><br><span class="line"><span class="keyword">if</span> (configFile !== <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> loadResult = <span class="keyword">await</span> <span class="title function_">loadConfigFromFile</span>(</span><br><span class="line">    configEnv,</span><br><span class="line">    configFile,</span><br><span class="line">    config.<span class="property">root</span>,</span><br><span class="line">    config.<span class="property">logLevel</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> (loadResult) &#123;</span><br><span class="line">    config = <span class="title function_">mergeConfig</span>(loadResult.<span class="property">config</span>, config)</span><br><span class="line">    configFile = loadResult.<span class="property">path</span></span><br><span class="line">    configFileDependencies = loadResult.<span class="property">dependencies</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码就是说，是否有指定配置文件，如果指定了，那就从文件中加载，如果加载到了，进行配置的合并</p><ol><li>插件的过滤机制，即在插件配置中可以定义apply是serve还是build，指定该插件是在vite dev还是vite build时使用</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">filterPlugin</span> = (<span class="params">p: Plugin</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!p) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!p.<span class="property">apply</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> p.<span class="property">apply</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> p.<span class="title function_">apply</span>(&#123; ...config, mode &#125;, configEnv)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> p.<span class="property">apply</span> === command <span class="comment">// command 就是 serve 或者 build，通过解析命令行参数传递进来的</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// resolve plugins</span></span><br><span class="line"><span class="keyword">const</span> rawUserPlugins = (</span><br><span class="line">  (<span class="keyword">await</span> <span class="title function_">asyncFlatten</span>(config.<span class="property">plugins</span> || [])) <span class="keyword">as</span> <span class="title class_">Plugin</span>[]</span><br><span class="line">).<span class="title function_">filter</span>(filterPlugin)</span><br></pre></td></tr></table></figure><ol><li>根据enforce进行插件排序</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [prePlugins, normalPlugins, postPlugins] =</span><br><span class="line">    <span class="title function_">sortUserPlugins</span>(rawUserPlugins)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">sortUserPlugins</span>(<span class="params"></span></span><br><span class="line"><span class="params">  plugins: (Plugin | Plugin[])[] | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params"></span>): [<span class="title class_">Plugin</span>[], <span class="title class_">Plugin</span>[], <span class="title class_">Plugin</span>[]] &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">prePlugins</span>: <span class="title class_">Plugin</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">postPlugins</span>: <span class="title class_">Plugin</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">normalPlugins</span>: <span class="title class_">Plugin</span>[] = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (plugins) &#123;</span><br><span class="line">    plugins.<span class="title function_">flat</span>().<span class="title function_">forEach</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (p.<span class="property">enforce</span> === <span class="string">&#x27;pre&#x27;</span>) prePlugins.<span class="title function_">push</span>(p)</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (p.<span class="property">enforce</span> === <span class="string">&#x27;post&#x27;</span>) postPlugins.<span class="title function_">push</span>(p)</span><br><span class="line">      <span class="keyword">else</span> normalPlugins.<span class="title function_">push</span>(p)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [prePlugins, normalPlugins, postPlugins]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>运行所有插件中的config hook，生成配置</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// run config hooks</span></span><br><span class="line"><span class="keyword">const</span> userPlugins = [...prePlugins, ...normalPlugins, ...postPlugins]</span><br><span class="line">config = <span class="keyword">await</span> <span class="title function_">runConfigHook</span>(config, userPlugins, configEnv)</span><br></pre></td></tr></table></figure><h1 id="模块引用图谱"><a href="#模块引用图谱" class="headerlink" title="模块引用图谱"></a>模块引用图谱</h1><p>这段代码的入口：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">moduleGraph</span>: <span class="title class_">ModuleGraph</span> = <span class="keyword">new</span> <span class="title class_">ModuleGraph</span>(<span class="function">(<span class="params">url, ssr</span>) =&gt;</span></span><br><span class="line">  container.<span class="title function_">resolveId</span>(url, <span class="literal">undefined</span>, &#123; ssr &#125;),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>还是先把ModuleGraph的所有代码放在这里，然后进行主要的流程分析：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ModuleGraph</span> &#123;</span><br><span class="line">  urlToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">  idToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">  <span class="comment">// a single file may corresponds to multiple modules with different queries</span></span><br><span class="line">  fileToModulesMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;&gt;()</span><br><span class="line">  safeModulesPath = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _unresolvedUrlToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;</span><br><span class="line">    <span class="built_in">string</span>,</span><br><span class="line">    <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="title class_">ModuleNode</span></span><br><span class="line">  &gt;()</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _ssrUnresolvedUrlToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;</span><br><span class="line">    <span class="built_in">string</span>,</span><br><span class="line">    <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="title class_">ModuleNode</span></span><br><span class="line">  &gt;()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> resolveId: (</span></span><br><span class="line"><span class="params">      url: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      ssr: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">    ) =&gt; <span class="built_in">Promise</span>&lt;PartialResolvedId | <span class="literal">null</span>&gt;,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getModuleByUrl</span>(</span><br><span class="line">    <span class="attr">rawUrl</span>: <span class="built_in">string</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span> | <span class="literal">undefined</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// Quick path, if we already have a module for this rawUrl (even without extension)</span></span><br><span class="line">    rawUrl = <span class="title function_">removeImportQuery</span>(<span class="title function_">removeTimestampQuery</span>(rawUrl))</span><br><span class="line">    <span class="keyword">const</span> mod = <span class="variable language_">this</span>.<span class="title function_">_getUnresolvedUrlToModule</span>(rawUrl, ssr)</span><br><span class="line">    <span class="keyword">if</span> (mod) &#123;</span><br><span class="line">      <span class="keyword">return</span> mod</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> [url] = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_resolveUrl</span>(rawUrl, ssr)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">urlToModuleMap</span>.<span class="title function_">get</span>(url)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getModuleById</span>(<span class="attr">id</span>: <span class="built_in">string</span>): <span class="title class_">ModuleNode</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">idToModuleMap</span>.<span class="title function_">get</span>(<span class="title function_">removeTimestampQuery</span>(id))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getModulesByFile</span>(<span class="attr">file</span>: <span class="built_in">string</span>): <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">get</span>(file)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onFileChange</span>(<span class="attr">file</span>: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> mods = <span class="variable language_">this</span>.<span class="title function_">getModulesByFile</span>(file)</span><br><span class="line">    <span class="keyword">if</span> (mods) &#123;</span><br><span class="line">      <span class="keyword">const</span> seen = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">      mods.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mod</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">invalidateModule</span>(mod, seen)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invalidateModule</span>(</span><br><span class="line">    <span class="attr">mod</span>: <span class="title class_">ModuleNode</span>,</span><br><span class="line">    <span class="attr">seen</span>: <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>(),</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="built_in">number</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">    <span class="attr">isHmr</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">hmrBoundaries</span>: <span class="title class_">ModuleNode</span>[] = [],</span><br><span class="line">    softInvalidate = <span class="literal">false</span>,</span><br><span class="line">  ): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prevInvalidationState = mod.<span class="property">invalidationState</span></span><br><span class="line">    <span class="keyword">const</span> prevSsrInvalidationState = mod.<span class="property">ssrInvalidationState</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle soft invalidation before the `seen` check, as consecutive soft/hard invalidations can</span></span><br><span class="line">    <span class="comment">// cause the final soft invalidation state to be different.</span></span><br><span class="line">    <span class="comment">// If soft invalidated, save the previous `transformResult` so that we can reuse and transform the</span></span><br><span class="line">    <span class="comment">// import timestamps only in `transformRequest`. If there&#x27;s no previous `transformResult`, hard invalidate it.</span></span><br><span class="line">    <span class="keyword">if</span> (softInvalidate) &#123;</span><br><span class="line">      mod.<span class="property">invalidationState</span> ??= mod.<span class="property">transformResult</span> ?? <span class="string">&#x27;HARD_INVALIDATED&#x27;</span></span><br><span class="line">      mod.<span class="property">ssrInvalidationState</span> ??= mod.<span class="property">ssrTransformResult</span> ?? <span class="string">&#x27;HARD_INVALIDATED&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If hard invalidated, further soft invalidations have no effect until it&#x27;s reset to `undefined`</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      mod.<span class="property">invalidationState</span> = <span class="string">&#x27;HARD_INVALIDATED&#x27;</span></span><br><span class="line">      mod.<span class="property">ssrInvalidationState</span> = <span class="string">&#x27;HARD_INVALIDATED&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Skip updating the module if it was already invalidated before and the invalidation state has not changed</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      seen.<span class="title function_">has</span>(mod) &amp;&amp;</span><br><span class="line">      prevInvalidationState === mod.<span class="property">invalidationState</span> &amp;&amp;</span><br><span class="line">      prevSsrInvalidationState === mod.<span class="property">ssrInvalidationState</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    seen.<span class="title function_">add</span>(mod)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isHmr) &#123;</span><br><span class="line">      mod.<span class="property">lastHMRTimestamp</span> = timestamp</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Save the timestamp for this invalidation, so we can avoid caching the result of possible already started</span></span><br><span class="line">      <span class="comment">// processing being done for this module</span></span><br><span class="line">      mod.<span class="property">lastInvalidationTimestamp</span> = timestamp</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Don&#x27;t invalidate mod.info and mod.meta, as they are part of the processing pipeline</span></span><br><span class="line">    <span class="comment">// Invalidating the transform result is enough to ensure this module is re-processed next time it is requested</span></span><br><span class="line">    mod.<span class="property">transformResult</span> = <span class="literal">null</span></span><br><span class="line">    mod.<span class="property">ssrTransformResult</span> = <span class="literal">null</span></span><br><span class="line">    mod.<span class="property">ssrModule</span> = <span class="literal">null</span></span><br><span class="line">    mod.<span class="property">ssrError</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// https://github.com/vitejs/vite/issues/3033</span></span><br><span class="line">    <span class="comment">// Given b.js -&gt; c.js -&gt; b.js (arrow means top-level import), if c.js self-accepts</span></span><br><span class="line">    <span class="comment">// and refetches itself, the execution order becomes c.js -&gt; b.js -&gt; c.js. The import</span></span><br><span class="line">    <span class="comment">// order matters here as it will fail. The workaround for now is to not hmr invalidate</span></span><br><span class="line">    <span class="comment">// b.js so that c.js refetches the already cached b.js, skipping the import loop.</span></span><br><span class="line">    <span class="keyword">if</span> (hmrBoundaries.<span class="title function_">includes</span>(mod)) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    mod.<span class="property">importers</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">importer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!importer.<span class="property">acceptedHmrDeps</span>.<span class="title function_">has</span>(mod)) &#123;</span><br><span class="line">        <span class="comment">// If the importer statically imports the current module, we can soft-invalidate the importer</span></span><br><span class="line">        <span class="comment">// to only update the import timestamps. If it&#x27;s not statically imported, e.g. watched/glob file,</span></span><br><span class="line">        <span class="comment">// we can only soft invalidate if the current module was also soft-invalidated. A soft-invalidation</span></span><br><span class="line">        <span class="comment">// doesn&#x27;t need to trigger a re-load and re-transform of the importer.</span></span><br><span class="line">        <span class="keyword">const</span> shouldSoftInvalidateImporter =</span><br><span class="line">          importer.<span class="property">staticImportedUrls</span>?.<span class="title function_">has</span>(mod.<span class="property">url</span>) || softInvalidate</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">invalidateModule</span>(</span><br><span class="line">          importer,</span><br><span class="line">          seen,</span><br><span class="line">          timestamp,</span><br><span class="line">          isHmr,</span><br><span class="line">          <span class="literal">undefined</span>,</span><br><span class="line">          shouldSoftInvalidateImporter,</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invalidateAll</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> timestamp = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">const</span> seen = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">idToModuleMap</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mod</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">invalidateModule</span>(mod, seen, timestamp)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Update the module graph based on a module&#x27;s updated imports information</span></span><br><span class="line"><span class="comment">   * If there are dependencies that no longer have any importers, they are</span></span><br><span class="line"><span class="comment">   * returned as a Set.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> staticImportedUrls Subset of `importedModules` where they&#x27;re statically imported in code.</span></span><br><span class="line"><span class="comment">   *   This is only used for soft invalidations so `undefined` is fine but may cause more runtime processing.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">updateModuleInfo</span>(</span><br><span class="line">    <span class="attr">mod</span>: <span class="title class_">ModuleNode</span>,</span><br><span class="line">    <span class="attr">importedModules</span>: <span class="title class_">Set</span>&lt;<span class="built_in">string</span> | <span class="title class_">ModuleNode</span>&gt;,</span><br><span class="line">    <span class="attr">importedBindings</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt;&gt; | <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">acceptedModules</span>: <span class="title class_">Set</span>&lt;<span class="built_in">string</span> | <span class="title class_">ModuleNode</span>&gt;,</span><br><span class="line">    <span class="attr">acceptedExports</span>: <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt; | <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">isSelfAccepting</span>: <span class="built_in">boolean</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">    staticImportedUrls?: <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt;,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="literal">undefined</span>&gt; &#123;</span><br><span class="line">    mod.<span class="property">isSelfAccepting</span> = isSelfAccepting</span><br><span class="line">    <span class="keyword">const</span> prevImports = ssr ? mod.<span class="property">ssrImportedModules</span> : mod.<span class="property">clientImportedModules</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">noLongerImported</span>: <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> resolvePromises = []</span><br><span class="line">    <span class="keyword">let</span> resolveResults = <span class="keyword">new</span> <span class="title class_">Array</span>(importedModules.<span class="property">size</span>)</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">    <span class="comment">// update import graph</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> imported <span class="keyword">of</span> importedModules) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextIndex = index++</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> imported === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        resolvePromises.<span class="title function_">push</span>(</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">ensureEntryFromUrl</span>(imported, ssr).<span class="title function_">then</span>(<span class="function">(<span class="params">dep</span>) =&gt;</span> &#123;</span><br><span class="line">            dep.<span class="property">importers</span>.<span class="title function_">add</span>(mod)</span><br><span class="line">            resolveResults[nextIndex] = dep</span><br><span class="line">          &#125;),</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        imported.<span class="property">importers</span>.<span class="title function_">add</span>(mod)</span><br><span class="line">        resolveResults[nextIndex] = imported</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resolvePromises.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(resolvePromises)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> nextImports = <span class="keyword">new</span> <span class="title class_">Set</span>(resolveResults)</span><br><span class="line">    <span class="keyword">if</span> (ssr) &#123;</span><br><span class="line">      mod.<span class="property">ssrImportedModules</span> = nextImports</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mod.<span class="property">clientImportedModules</span> = nextImports</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// remove the importer from deps that were imported but no longer are.</span></span><br><span class="line">    prevImports.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !mod.<span class="property">clientImportedModules</span>.<span class="title function_">has</span>(dep) &amp;&amp;</span><br><span class="line">        !mod.<span class="property">ssrImportedModules</span>.<span class="title function_">has</span>(dep)</span><br><span class="line">      ) &#123;</span><br><span class="line">        dep.<span class="property">importers</span>.<span class="title function_">delete</span>(mod)</span><br><span class="line">        <span class="keyword">if</span> (!dep.<span class="property">importers</span>.<span class="property">size</span>) &#123;</span><br><span class="line">          <span class="comment">// dependency no longer imported</span></span><br><span class="line">          ;(noLongerImported || (noLongerImported = <span class="keyword">new</span> <span class="title class_">Set</span>())).<span class="title function_">add</span>(dep)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update accepted hmr deps</span></span><br><span class="line">    resolvePromises = []</span><br><span class="line">    resolveResults = <span class="keyword">new</span> <span class="title class_">Array</span>(acceptedModules.<span class="property">size</span>)</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> accepted <span class="keyword">of</span> acceptedModules) &#123;</span><br><span class="line">      <span class="keyword">const</span> nextIndex = index++</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> accepted === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        resolvePromises.<span class="title function_">push</span>(</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">ensureEntryFromUrl</span>(accepted, ssr).<span class="title function_">then</span>(<span class="function">(<span class="params">dep</span>) =&gt;</span> &#123;</span><br><span class="line">            resolveResults[nextIndex] = dep</span><br><span class="line">          &#125;),</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolveResults[nextIndex] = accepted</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resolvePromises.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(resolvePromises)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mod.<span class="property">acceptedHmrDeps</span> = <span class="keyword">new</span> <span class="title class_">Set</span>(resolveResults)</span><br><span class="line">    mod.<span class="property">staticImportedUrls</span> = staticImportedUrls</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update accepted hmr exports</span></span><br><span class="line">    mod.<span class="property">acceptedHmrExports</span> = acceptedExports</span><br><span class="line">    mod.<span class="property">importedBindings</span> = importedBindings</span><br><span class="line">    <span class="keyword">return</span> noLongerImported</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">ensureEntryFromUrl</span>(</span><br><span class="line">    <span class="attr">rawUrl</span>: <span class="built_in">string</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">    setIsSelfAccepting = <span class="literal">true</span>,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_ensureEntryFromUrl</span>(rawUrl, ssr, setIsSelfAccepting)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">_ensureEntryFromUrl</span>(</span><br><span class="line">    <span class="attr">rawUrl</span>: <span class="built_in">string</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">    setIsSelfAccepting = <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// Optimization, avoid resolving the same url twice if the caller already did it</span></span><br><span class="line">    resolved?: <span class="title class_">PartialResolvedId</span>,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// Quick path, if we already have a module for this rawUrl (even without extension)</span></span><br><span class="line">    rawUrl = <span class="title function_">removeImportQuery</span>(<span class="title function_">removeTimestampQuery</span>(rawUrl))</span><br><span class="line">    <span class="keyword">let</span> mod = <span class="variable language_">this</span>.<span class="title function_">_getUnresolvedUrlToModule</span>(rawUrl, ssr)</span><br><span class="line">    <span class="keyword">if</span> (mod) &#123;</span><br><span class="line">      <span class="keyword">return</span> mod</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> modPromise = (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> [url, resolvedId, meta] = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_resolveUrl</span>(</span><br><span class="line">        rawUrl,</span><br><span class="line">        ssr,</span><br><span class="line">        resolved,</span><br><span class="line">      )</span><br><span class="line">      mod = <span class="variable language_">this</span>.<span class="property">idToModuleMap</span>.<span class="title function_">get</span>(resolvedId)</span><br><span class="line">      <span class="keyword">if</span> (!mod) &#123;</span><br><span class="line">        mod = <span class="keyword">new</span> <span class="title class_">ModuleNode</span>(url, setIsSelfAccepting)</span><br><span class="line">        <span class="keyword">if</span> (meta) mod.<span class="property">meta</span> = meta</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">urlToModuleMap</span>.<span class="title function_">set</span>(url, mod)</span><br><span class="line">        mod.<span class="property">id</span> = resolvedId</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">idToModuleMap</span>.<span class="title function_">set</span>(resolvedId, mod)</span><br><span class="line">        <span class="keyword">const</span> file = (mod.<span class="property">file</span> = <span class="title function_">cleanUrl</span>(resolvedId))</span><br><span class="line">        <span class="keyword">let</span> fileMappedModules = <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">get</span>(file)</span><br><span class="line">        <span class="keyword">if</span> (!fileMappedModules) &#123;</span><br><span class="line">          fileMappedModules = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">set</span>(file, fileMappedModules)</span><br><span class="line">        &#125;</span><br><span class="line">        fileMappedModules.<span class="title function_">add</span>(mod)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// multiple urls can map to the same module and id, make sure we register</span></span><br><span class="line">      <span class="comment">// the url to the existing module in that case</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">urlToModuleMap</span>.<span class="title function_">has</span>(url)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">urlToModuleMap</span>.<span class="title function_">set</span>(url, mod)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_setUnresolvedUrlToModule</span>(rawUrl, mod, ssr)</span><br><span class="line">      <span class="keyword">return</span> mod</span><br><span class="line">    &#125;)()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Also register the clean url to the module, so that we can short-circuit</span></span><br><span class="line">    <span class="comment">// resolving the same url twice</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_setUnresolvedUrlToModule</span>(rawUrl, modPromise, ssr)</span><br><span class="line">    <span class="keyword">return</span> modPromise</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// some deps, like a css file referenced via @import, don&#x27;t have its own</span></span><br><span class="line">  <span class="comment">// url because they are inlined into the main css import. But they still</span></span><br><span class="line">  <span class="comment">// need to be represented in the module graph so that they can trigger</span></span><br><span class="line">  <span class="comment">// hmr in the importing css file.</span></span><br><span class="line">  <span class="title function_">createFileOnlyEntry</span>(<span class="attr">file</span>: <span class="built_in">string</span>): <span class="title class_">ModuleNode</span> &#123;</span><br><span class="line">    file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">    <span class="keyword">let</span> fileMappedModules = <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">get</span>(file)</span><br><span class="line">    <span class="keyword">if</span> (!fileMappedModules) &#123;</span><br><span class="line">      fileMappedModules = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">set</span>(file, fileMappedModules)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`<span class="subst">$&#123;FS_PREFIX&#125;</span><span class="subst">$&#123;file&#125;</span>`</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> m <span class="keyword">of</span> fileMappedModules) &#123;</span><br><span class="line">      <span class="keyword">if</span> (m.<span class="property">url</span> === url || m.<span class="property">id</span> === file) &#123;</span><br><span class="line">        <span class="keyword">return</span> m</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mod = <span class="keyword">new</span> <span class="title class_">ModuleNode</span>(url)</span><br><span class="line">    mod.<span class="property">file</span> = file</span><br><span class="line">    fileMappedModules.<span class="title function_">add</span>(mod)</span><br><span class="line">    <span class="keyword">return</span> mod</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for incoming urls, it is important to:</span></span><br><span class="line">  <span class="comment">// 1. remove the HMR timestamp query (?t=xxxx) and the ?import query</span></span><br><span class="line">  <span class="comment">// 2. resolve its extension so that urls with or without extension all map to</span></span><br><span class="line">  <span class="comment">// the same module</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">resolveUrl</span>(<span class="attr">url</span>: <span class="built_in">string</span>, ssr?: <span class="built_in">boolean</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">ResolvedUrl</span>&gt; &#123;</span><br><span class="line">    url = <span class="title function_">removeImportQuery</span>(<span class="title function_">removeTimestampQuery</span>(url))</span><br><span class="line">    <span class="keyword">const</span> mod = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_getUnresolvedUrlToModule</span>(url, ssr)</span><br><span class="line">    <span class="keyword">if</span> (mod?.<span class="property">id</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [mod.<span class="property">url</span>, mod.<span class="property">id</span>, mod.<span class="property">meta</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_resolveUrl</span>(url, ssr)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">_getUnresolvedUrlToModule</span>(</span><br><span class="line">    <span class="attr">url</span>: <span class="built_in">string</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="title class_">ModuleNode</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      ssr ? <span class="variable language_">this</span>.<span class="property">_ssrUnresolvedUrlToModuleMap</span> : <span class="variable language_">this</span>.<span class="property">_unresolvedUrlToModuleMap</span></span><br><span class="line">    ).<span class="title function_">get</span>(url)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">_setUnresolvedUrlToModule</span>(</span><br><span class="line">    <span class="attr">url</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">mod</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="title class_">ModuleNode</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">  ): <span class="built_in">void</span> &#123;</span><br><span class="line">    ;(ssr</span><br><span class="line">      ? <span class="variable language_">this</span>.<span class="property">_ssrUnresolvedUrlToModuleMap</span></span><br><span class="line">      : <span class="variable language_">this</span>.<span class="property">_unresolvedUrlToModuleMap</span></span><br><span class="line">    ).<span class="title function_">set</span>(url, mod)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@internal</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">_resolveUrl</span>(</span><br><span class="line">    <span class="attr">url</span>: <span class="built_in">string</span>,</span><br><span class="line">    ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">    alreadyResolved?: <span class="title class_">PartialResolvedId</span>,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">ResolvedUrl</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> resolved = alreadyResolved ?? (<span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">resolveId</span>(url, !!ssr))</span><br><span class="line">    <span class="keyword">const</span> resolvedId = resolved?.<span class="property">id</span> || url</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      url !== resolvedId &amp;&amp;</span><br><span class="line">      !url.<span class="title function_">includes</span>(<span class="string">&#x27;\0&#x27;</span>) &amp;&amp;</span><br><span class="line">      !url.<span class="title function_">startsWith</span>(<span class="string">`virtual:`</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> ext = <span class="title function_">extname</span>(<span class="title function_">cleanUrl</span>(resolvedId))</span><br><span class="line">      <span class="keyword">if</span> (ext) &#123;</span><br><span class="line">        <span class="keyword">const</span> pathname = <span class="title function_">cleanUrl</span>(url)</span><br><span class="line">        <span class="keyword">if</span> (!pathname.<span class="title function_">endsWith</span>(ext)) &#123;</span><br><span class="line">          url = pathname + ext + url.<span class="title function_">slice</span>(pathname.<span class="property">length</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [url, resolvedId, resolved?.<span class="property">meta</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="变量说明"><a href="#变量说明" class="headerlink" title="变量说明"></a>变量说明</h2><p>首先，ModuleGraph中有几个私有变量，存储了模块之间的映射关系，即：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">idToModuleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line"><span class="comment">// a single file may corresponds to multiple modules with different queries</span></span><br><span class="line">fileToModulesMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;&gt;()</span><br></pre></td></tr></table></figure><p>这几个变量分别是url，文件id和文件路径与module之间的映射关系，其中fileToModulesMap比较特殊，因为一个文件可能编译出来不止一个模块。</p><p>获取这几个变量中的数据，也是通过对外暴露的方法：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">getModuleByUrl</span>(</span><br><span class="line">  <span class="attr">rawUrl</span>: <span class="built_in">string</span>,</span><br><span class="line">  ssr?: <span class="built_in">boolean</span>,</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleNode</span> | <span class="literal">undefined</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Quick path, if we already have a module for this rawUrl (even without extension)</span></span><br><span class="line">  rawUrl = <span class="title function_">removeImportQuery</span>(<span class="title function_">removeTimestampQuery</span>(rawUrl))</span><br><span class="line">  <span class="keyword">const</span> mod = <span class="variable language_">this</span>.<span class="title function_">_getUnresolvedUrlToModule</span>(rawUrl, ssr)</span><br><span class="line">  <span class="keyword">if</span> (mod) &#123;</span><br><span class="line">    <span class="keyword">return</span> mod</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [url] = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_resolveUrl</span>(rawUrl, ssr)</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">urlToModuleMap</span>.<span class="title function_">get</span>(url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getModuleById</span>(<span class="attr">id</span>: <span class="built_in">string</span>): <span class="title class_">ModuleNode</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">idToModuleMap</span>.<span class="title function_">get</span>(<span class="title function_">removeTimestampQuery</span>(id))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getModulesByFile</span>(<span class="attr">file</span>: <span class="built_in">string</span>): <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt; | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">fileToModulesMap</span>.<span class="title function_">get</span>(file)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="文件更改时的处理逻辑"><a href="#文件更改时的处理逻辑" class="headerlink" title="文件更改时的处理逻辑"></a>文件更改时的处理逻辑</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onFileChange</span>(<span class="attr">file</span>: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> mods = <span class="variable language_">this</span>.<span class="title function_">getModulesByFile</span>(file)</span><br><span class="line">  <span class="keyword">if</span> (mods) &#123;</span><br><span class="line">    <span class="keyword">const</span> seen = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">    mods.<span class="title function_">forEach</span>(<span class="function">(<span class="params">mod</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">invalidateModule</span>(mod, seen)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码简单来说，就是找到更改文件对应的module，然后将其变为invalid状态，其中的seen参数是为了防止重复处理</p><h2 id="更新模块信息"><a href="#更新模块信息" class="headerlink" title="更新模块信息"></a>更新模块信息</h2><p>即<code>updateModuleInfo</code>函数，当模块更新时，需要重新更新它的引用和被引用关系</p><h2 id="启动时生成内部变量"><a href="#启动时生成内部变量" class="headerlink" title="启动时生成内部变量"></a>启动时生成内部变量</h2><p>即<code>ensureEntryFromUrl</code>函数，主要作用就是在项目启动时分析以来，并为内部的三个主要变量进行赋值。</p><h1 id="插件调用机制"><a href="#插件调用机制" class="headerlink" title="插件调用机制"></a>插件调用机制</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> container = <span class="keyword">await</span> <span class="title function_">createPluginContainer</span>(config, moduleGraph, watcher)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createPluginContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  config: ResolvedConfig,</span></span><br><span class="line"><span class="params">  moduleGraph?: ModuleGraph,</span></span><br><span class="line"><span class="params">  watcher?: FSWatcher,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">PluginContainer</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    plugins,</span><br><span class="line">    logger,</span><br><span class="line">    root,</span><br><span class="line">    <span class="attr">build</span>: &#123; rollupOptions &#125;,</span><br><span class="line">  &#125; = config</span><br><span class="line">  <span class="keyword">const</span> &#123; getSortedPluginHooks, getSortedPlugins &#125; =</span><br><span class="line">    <span class="title function_">createPluginHookUtils</span>(plugins)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">seenResolves</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="literal">true</span> | <span class="literal">undefined</span>&gt; = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> debugResolve = <span class="title function_">createDebugger</span>(<span class="string">&#x27;vite:resolve&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> debugPluginResolve = <span class="title function_">createDebugger</span>(<span class="string">&#x27;vite:plugin-resolve&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">onlyWhenFocused</span>: <span class="string">&#x27;vite:plugin&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> debugPluginTransform = <span class="title function_">createDebugger</span>(<span class="string">&#x27;vite:plugin-transform&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">onlyWhenFocused</span>: <span class="string">&#x27;vite:plugin&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> debugSourcemapCombineFilter =</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">DEBUG_VITE_SOURCEMAP_COMBINE_FILTER</span></span><br><span class="line">  <span class="keyword">const</span> debugSourcemapCombine = <span class="title function_">createDebugger</span>(<span class="string">&#x27;vite:sourcemap-combine&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">onlyWhenFocused</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> watchFiles = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">minimalContext</span>: <span class="title class_">MinimalPluginContext</span> = &#123;</span><br><span class="line">    <span class="attr">meta</span>: &#123;</span><br><span class="line">      rollupVersion,</span><br><span class="line">      <span class="attr">watchMode</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">debug</span>: noop,</span><br><span class="line">    <span class="attr">info</span>: noop,</span><br><span class="line">    <span class="attr">warn</span>: noop,</span><br><span class="line">    <span class="comment">// @ts-expect-error noop</span></span><br><span class="line">    <span class="attr">error</span>: noop,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">warnIncompatibleMethod</span>(<span class="params">method: <span class="built_in">string</span>, plugin: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(</span><br><span class="line">      colors.<span class="title function_">cyan</span>(<span class="string">`[plugin:<span class="subst">$&#123;plugin&#125;</span>] `</span>) +</span><br><span class="line">        colors.<span class="title function_">yellow</span>(</span><br><span class="line">          <span class="string">`context method <span class="subst">$&#123;colors.bold(</span></span></span><br><span class="line"><span class="subst"><span class="string">            <span class="string">`<span class="subst">$&#123;method&#125;</span>()`</span>,</span></span></span><br><span class="line"><span class="subst"><span class="string">          )&#125;</span> is not supported in serve mode. This plugin is likely not vite-compatible.`</span>,</span><br><span class="line">        ),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// parallel, ignores returns</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> hookParallel&lt;H <span class="keyword">extends</span> <span class="title class_">AsyncPluginHooks</span> &amp; <span class="title class_">ParallelPluginHooks</span>&gt;(</span><br><span class="line">    <span class="attr">hookName</span>: H,</span><br><span class="line">    <span class="attr">context</span>: <span class="function">(<span class="params">plugin: Plugin</span>) =&gt;</span> <span class="title class_">ThisType</span>&lt;<span class="title class_">FunctionPluginHooks</span>[H]&gt;,</span><br><span class="line">    <span class="attr">args</span>: <span class="function">(<span class="params">plugin: Plugin</span>) =&gt;</span> <span class="title class_">Parameters</span>&lt;<span class="title class_">FunctionPluginHooks</span>[H]&gt;,</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">parallelPromises</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">unknown</span>&gt;[] = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="title function_">getSortedPlugins</span>(hookName)) &#123;</span><br><span class="line">      <span class="comment">// Don&#x27;t throw here if closed, so buildEnd and closeBundle hooks can finish running</span></span><br><span class="line">      <span class="keyword">const</span> hook = plugin[hookName]</span><br><span class="line">      <span class="keyword">if</span> (!hook) <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">handler</span>: <span class="title class_">Function</span> = <span class="title function_">getHookHandler</span>(hook)</span><br><span class="line">      <span class="keyword">if</span> ((hook <span class="keyword">as</span> &#123; sequential?: <span class="built_in">boolean</span> &#125;).<span class="property">sequential</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(parallelPromises)</span><br><span class="line">        parallelPromises.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">await</span> handler.<span class="title function_">apply</span>(<span class="title function_">context</span>(plugin), <span class="title function_">args</span>(plugin))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        parallelPromises.<span class="title function_">push</span>(handler.<span class="title function_">apply</span>(<span class="title function_">context</span>(plugin), <span class="title function_">args</span>(plugin)))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(parallelPromises)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// throw when an unsupported ModuleInfo property is accessed,</span></span><br><span class="line">  <span class="comment">// so that incompatible plugins fail in a non-cryptic way.</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">ModuleInfoProxy</span>: <span class="title class_">ProxyHandler</span>&lt;<span class="title class_">ModuleInfo</span>&gt; = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">info: <span class="built_in">any</span>, key: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> info) &#123;</span><br><span class="line">        <span class="keyword">return</span> info[key]</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Don&#x27;t throw an error when returning from an async function</span></span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;then&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`[vite] The &quot;<span class="subst">$&#123;key&#125;</span>&quot; property of ModuleInfo is not supported.`</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// same default value of &quot;moduleInfo.meta&quot; as in Rollup</span></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">EMPTY_OBJECT</span> = <span class="title class_">Object</span>.<span class="title function_">freeze</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getModuleInfo</span>(<span class="params">id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable language_">module</span> = moduleGraph?.<span class="title function_">getModuleById</span>(id)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">module</span>.<span class="property">info</span>) &#123;</span><br><span class="line">      <span class="variable language_">module</span>.<span class="property">info</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">        &#123; id, <span class="attr">meta</span>: <span class="variable language_">module</span>.<span class="property">meta</span> || <span class="variable constant_">EMPTY_OBJECT</span> &#125; <span class="keyword">as</span> <span class="title class_">ModuleInfo</span>,</span><br><span class="line">        <span class="title class_">ModuleInfoProxy</span>,</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">info</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">updateModuleInfo</span>(<span class="params">id: <span class="built_in">string</span>, &#123; meta &#125;: &#123; meta?: <span class="built_in">object</span> | <span class="literal">null</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (meta) &#123;</span><br><span class="line">      <span class="keyword">const</span> moduleInfo = <span class="title function_">getModuleInfo</span>(id)</span><br><span class="line">      <span class="keyword">if</span> (moduleInfo) &#123;</span><br><span class="line">        moduleInfo.<span class="property">meta</span> = &#123; ...moduleInfo.<span class="property">meta</span>, ...meta &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we should create a new context for each async hook pipeline so that the</span></span><br><span class="line">  <span class="comment">// active plugin in that pipeline can be tracked in a concurrency-safe manner.</span></span><br><span class="line">  <span class="comment">// using a class to make creating new contexts more efficient</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Context</span> <span class="keyword">implements</span> <span class="title class_">PluginContext</span> &#123;</span><br><span class="line">    meta = minimalContext.<span class="property">meta</span></span><br><span class="line">    ssr = <span class="literal">false</span></span><br><span class="line">    _scan = <span class="literal">false</span></span><br><span class="line">    <span class="attr">_activePlugin</span>: <span class="title class_">Plugin</span> | <span class="literal">null</span></span><br><span class="line">    <span class="attr">_activeId</span>: <span class="built_in">string</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">    <span class="attr">_activeCode</span>: <span class="built_in">string</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">    _resolveSkips?: <span class="title class_">Set</span>&lt;<span class="title class_">Plugin</span>&gt;</span><br><span class="line">    <span class="attr">_addedImports</span>: <span class="title class_">Set</span>&lt;<span class="built_in">string</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">initialPlugin?: Plugin</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_activePlugin</span> = initialPlugin || <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">parse</span>(<span class="params">code: <span class="built_in">string</span>, opts: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">rollupParseAst</span>(code, opts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">resolve</span>(<span class="params"></span></span><br><span class="line"><span class="params">      id: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      importer?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      options?: &#123;</span></span><br><span class="line"><span class="params">        attributes?: Record&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;</span></span><br><span class="line"><span class="params">        custom?: CustomPluginOptions</span></span><br><span class="line"><span class="params">        isEntry?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params">        skipSelf?: <span class="built_in">boolean</span></span></span><br><span class="line"><span class="params">      &#125;,</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">skip</span>: <span class="title class_">Set</span>&lt;<span class="title class_">Plugin</span>&gt; | <span class="literal">undefined</span></span><br><span class="line">      <span class="keyword">if</span> (options?.<span class="property">skipSelf</span> !== <span class="literal">false</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">_activePlugin</span>) &#123;</span><br><span class="line">        skip = <span class="keyword">new</span> <span class="title class_">Set</span>(<span class="variable language_">this</span>.<span class="property">_resolveSkips</span>)</span><br><span class="line">        skip.<span class="title function_">add</span>(<span class="variable language_">this</span>.<span class="property">_activePlugin</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> out = <span class="keyword">await</span> container.<span class="title function_">resolveId</span>(id, importer, &#123;</span><br><span class="line">        <span class="attr">attributes</span>: options?.<span class="property">attributes</span>,</span><br><span class="line">        <span class="attr">custom</span>: options?.<span class="property">custom</span>,</span><br><span class="line">        <span class="attr">isEntry</span>: !!options?.<span class="property">isEntry</span>,</span><br><span class="line">        skip,</span><br><span class="line">        <span class="attr">ssr</span>: <span class="variable language_">this</span>.<span class="property">ssr</span>,</span><br><span class="line">        <span class="attr">scan</span>: <span class="variable language_">this</span>.<span class="property">_scan</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> out === <span class="string">&#x27;string&#x27;</span>) out = &#123; <span class="attr">id</span>: out &#125;</span><br><span class="line">      <span class="keyword">return</span> out <span class="keyword">as</span> <span class="title class_">ResolvedId</span> | <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">load</span>(</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="built_in">string</span></span><br><span class="line">        resolveDependencies?: <span class="built_in">boolean</span></span><br><span class="line">      &#125; &amp; <span class="title class_">Partial</span>&lt;<span class="title class_">PartialNull</span>&lt;<span class="title class_">ModuleOptions</span>&gt;&gt;,</span><br><span class="line">    ): <span class="title class_">Promise</span>&lt;<span class="title class_">ModuleInfo</span>&gt; &#123;</span><br><span class="line">      <span class="comment">// We may not have added this to our module graph yet, so ensure it exists</span></span><br><span class="line">      <span class="keyword">await</span> moduleGraph?.<span class="title function_">ensureEntryFromUrl</span>(<span class="title function_">unwrapId</span>(options.<span class="property">id</span>), <span class="variable language_">this</span>.<span class="property">ssr</span>)</span><br><span class="line">      <span class="comment">// Not all options passed to this function make sense in the context of loading individual files,</span></span><br><span class="line">      <span class="comment">// but we can at least update the module info properties we support</span></span><br><span class="line">      <span class="title function_">updateModuleInfo</span>(options.<span class="property">id</span>, options)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> container.<span class="title function_">load</span>(options.<span class="property">id</span>, &#123; <span class="attr">ssr</span>: <span class="variable language_">this</span>.<span class="property">ssr</span> &#125;)</span><br><span class="line">      <span class="keyword">const</span> moduleInfo = <span class="variable language_">this</span>.<span class="title function_">getModuleInfo</span>(options.<span class="property">id</span>)</span><br><span class="line">      <span class="comment">// This shouldn&#x27;t happen due to calling ensureEntryFromUrl, but 1) our types can&#x27;t ensure that</span></span><br><span class="line">      <span class="comment">// and 2) moduleGraph may not have been provided (though in the situations where that happens,</span></span><br><span class="line">      <span class="comment">// we should never have plugins calling this.load)</span></span><br><span class="line">      <span class="keyword">if</span> (!moduleInfo)</span><br><span class="line">        <span class="keyword">throw</span> <span class="title class_">Error</span>(<span class="string">`Failed to load module with id <span class="subst">$&#123;options.id&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> moduleInfo</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getModuleInfo</span>(<span class="params">id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getModuleInfo</span>(id)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getModuleIds</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> moduleGraph</span><br><span class="line">        ? moduleGraph.<span class="property">idToModuleMap</span>.<span class="title function_">keys</span>()</span><br><span class="line">        : <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">addWatchFile</span>(<span class="params">id: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      watchFiles.<span class="title function_">add</span>(id)</span><br><span class="line">      ;(<span class="variable language_">this</span>.<span class="property">_addedImports</span> || (<span class="variable language_">this</span>.<span class="property">_addedImports</span> = <span class="keyword">new</span> <span class="title class_">Set</span>())).<span class="title function_">add</span>(id)</span><br><span class="line">      <span class="keyword">if</span> (watcher) <span class="title function_">ensureWatchedFile</span>(watcher, id, root)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getWatchFiles</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [...watchFiles]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">emitFile</span>(<span class="params">assetOrFile: EmittedFile</span>) &#123;</span><br><span class="line">      <span class="title function_">warnIncompatibleMethod</span>(<span class="string">`emitFile`</span>, <span class="variable language_">this</span>.<span class="property">_activePlugin</span>!.<span class="property">name</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setAssetSource</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warnIncompatibleMethod</span>(<span class="string">`setAssetSource`</span>, <span class="variable language_">this</span>.<span class="property">_activePlugin</span>!.<span class="property">name</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getFileName</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">warnIncompatibleMethod</span>(<span class="string">`getFileName`</span>, <span class="variable language_">this</span>.<span class="property">_activePlugin</span>!.<span class="property">name</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">warn</span>(<span class="params"></span></span><br><span class="line"><span class="params">      e: <span class="built_in">string</span> | RollupLog | (() =&gt; <span class="built_in">string</span> | RollupLog),</span></span><br><span class="line"><span class="params">      position?: <span class="built_in">number</span> | &#123; column: <span class="built_in">number</span>; line: <span class="built_in">number</span> &#125;,</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> err = <span class="title function_">formatError</span>(<span class="keyword">typeof</span> e === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">e</span>() : e, position, <span class="variable language_">this</span>)</span><br><span class="line">      <span class="keyword">const</span> msg = <span class="title function_">buildErrorMessage</span>(</span><br><span class="line">        err,</span><br><span class="line">        [colors.<span class="title function_">yellow</span>(<span class="string">`warning: <span class="subst">$&#123;err.message&#125;</span>`</span>)],</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">      )</span><br><span class="line">      logger.<span class="title function_">warn</span>(msg, &#123;</span><br><span class="line">        <span class="attr">clear</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">error</span>(</span><br><span class="line">      <span class="attr">e</span>: <span class="built_in">string</span> | <span class="title class_">RollupError</span>,</span><br><span class="line">      position?: <span class="built_in">number</span> | &#123; <span class="attr">column</span>: <span class="built_in">number</span>; <span class="attr">line</span>: <span class="built_in">number</span> &#125;,</span><br><span class="line">    ): <span class="built_in">never</span> &#123;</span><br><span class="line">      <span class="comment">// error thrown here is caught by the transform middleware and passed on</span></span><br><span class="line">      <span class="comment">// the the error middleware.</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="title function_">formatError</span>(e, position, <span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debug = noop</span><br><span class="line">    info = noop</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">formatError</span>(<span class="params"></span></span><br><span class="line"><span class="params">    e: <span class="built_in">string</span> | RollupError,</span></span><br><span class="line"><span class="params">    position: <span class="built_in">number</span> | &#123; column: <span class="built_in">number</span>; line: <span class="built_in">number</span> &#125; | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">    ctx: Context,</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">TransformContext</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Context</span> &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">originalCode</span>: <span class="built_in">string</span></span><br><span class="line">    <span class="attr">originalSourcemap</span>: <span class="title class_">SourceMap</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">    <span class="attr">sourcemapChain</span>: <span class="title class_">NonNullable</span>&lt;<span class="title class_">SourceDescription</span>[<span class="string">&#x27;map&#x27;</span>]&gt;[] = []</span><br><span class="line">    <span class="attr">combinedMap</span>: <span class="title class_">SourceMap</span> | &#123; <span class="attr">mappings</span>: <span class="string">&#x27;&#x27;</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">filename: <span class="built_in">string</span>, code: <span class="built_in">string</span>, inMap?: SourceMap | <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">super</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">filename</span> = filename</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">originalCode</span> = code</span><br><span class="line">      <span class="keyword">if</span> (inMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debugSourcemapCombine) &#123;</span><br><span class="line">          <span class="comment">// @ts-expect-error inject name for debug purpose</span></span><br><span class="line">          inMap.<span class="property">name</span> = <span class="string">&#x27;$inMap&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sourcemapChain</span>.<span class="title function_">push</span>(inMap)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_getCombinedSourcemap</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        debugSourcemapCombine &amp;&amp;</span><br><span class="line">        debugSourcemapCombineFilter &amp;&amp;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">filename</span>.<span class="title function_">includes</span>(debugSourcemapCombineFilter)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">debugSourcemapCombine</span>(<span class="string">&#x27;----------&#x27;</span>, <span class="variable language_">this</span>.<span class="property">filename</span>)</span><br><span class="line">        <span class="title function_">debugSourcemapCombine</span>(<span class="variable language_">this</span>.<span class="property">combinedMap</span>)</span><br><span class="line">        <span class="title function_">debugSourcemapCombine</span>(<span class="variable language_">this</span>.<span class="property">sourcemapChain</span>)</span><br><span class="line">        <span class="title function_">debugSourcemapCombine</span>(<span class="string">&#x27;----------&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> combinedMap = <span class="variable language_">this</span>.<span class="property">combinedMap</span></span><br><span class="line">      <span class="comment">// &#123; mappings: &#x27;&#x27; &#125;</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        combinedMap &amp;&amp;</span><br><span class="line">        !(<span class="string">&#x27;version&#x27;</span> <span class="keyword">in</span> combinedMap) &amp;&amp;</span><br><span class="line">        combinedMap.<span class="property">mappings</span> === <span class="string">&#x27;&#x27;</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sourcemapChain</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> combinedMap</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> m <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">sourcemapChain</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> m === <span class="string">&#x27;string&#x27;</span>) m = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(m)</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="string">&#x27;version&#x27;</span> <span class="keyword">in</span> (m <span class="keyword">as</span> <span class="title class_">SourceMap</span>))) &#123;</span><br><span class="line">          <span class="comment">// &#123; mappings: &#x27;&#x27; &#125;</span></span><br><span class="line">          <span class="keyword">if</span> ((m <span class="keyword">as</span> <span class="title class_">SourceMap</span>).<span class="property">mappings</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            combinedMap = &#123; <span class="attr">mappings</span>: <span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// empty, nullified source map</span></span><br><span class="line">          combinedMap = <span class="literal">null</span></span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!combinedMap) &#123;</span><br><span class="line">          combinedMap = m <span class="keyword">as</span> <span class="title class_">SourceMap</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          combinedMap = <span class="title function_">combineSourcemaps</span>(<span class="title function_">cleanUrl</span>(<span class="variable language_">this</span>.<span class="property">filename</span>), [</span><br><span class="line">            m <span class="keyword">as</span> <span class="title class_">RawSourceMap</span>,</span><br><span class="line">            combinedMap <span class="keyword">as</span> <span class="title class_">RawSourceMap</span>,</span><br><span class="line">          ]) <span class="keyword">as</span> <span class="title class_">SourceMap</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (combinedMap !== <span class="variable language_">this</span>.<span class="property">combinedMap</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">combinedMap</span> = combinedMap</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sourcemapChain</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">combinedMap</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">getCombinedSourcemap</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> map = <span class="variable language_">this</span>.<span class="title function_">_getCombinedSourcemap</span>()</span><br><span class="line">      <span class="keyword">if</span> (!map || (!(<span class="string">&#x27;version&#x27;</span> <span class="keyword">in</span> map) &amp;&amp; map.<span class="property">mappings</span> === <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MagicString</span>(<span class="variable language_">this</span>.<span class="property">originalCode</span>).<span class="title function_">generateMap</span>(&#123;</span><br><span class="line">          <span class="attr">includeContent</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">hires</span>: <span class="string">&#x27;boundary&#x27;</span>,</span><br><span class="line">          <span class="attr">source</span>: <span class="title function_">cleanUrl</span>(<span class="variable language_">this</span>.<span class="property">filename</span>),</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> map</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> closed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> processesing = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;&gt;()</span><br><span class="line">  <span class="comment">// keeps track of hook promises so that we can wait for them all to finish upon closing the server</span></span><br><span class="line">  <span class="keyword">function</span> handleHookPromise&lt;T&gt;(<span class="attr">maybePromise</span>: <span class="literal">undefined</span> | T | <span class="title class_">Promise</span>&lt;T&gt;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(maybePromise <span class="keyword">as</span> <span class="built_in">any</span>)?.<span class="property">then</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> maybePromise</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> promise = maybePromise <span class="keyword">as</span> <span class="title class_">Promise</span>&lt;T&gt;</span><br><span class="line">    processesing.<span class="title function_">add</span>(promise)</span><br><span class="line">    <span class="keyword">return</span> promise.<span class="title function_">finally</span>(<span class="function">() =&gt;</span> processesing.<span class="title function_">delete</span>(promise))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">container</span>: <span class="title class_">PluginContainer</span> = &#123;</span><br><span class="line">    <span class="attr">options</span>: <span class="keyword">await</span> (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> options = rollupOptions</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> optionsHook <span class="keyword">of</span> <span class="title function_">getSortedPluginHooks</span>(<span class="string">&#x27;options&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (closed) <span class="title function_">throwClosedServerError</span>()</span><br><span class="line">        options =</span><br><span class="line">          (<span class="keyword">await</span> <span class="title function_">handleHookPromise</span>(</span><br><span class="line">            optionsHook.<span class="title function_">call</span>(minimalContext, options),</span><br><span class="line">          )) || options</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> options</span><br><span class="line">    &#125;)(),</span><br><span class="line"></span><br><span class="line">    getModuleInfo,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">buildStart</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">handleHookPromise</span>(</span><br><span class="line">        <span class="title function_">hookParallel</span>(</span><br><span class="line">          <span class="string">&#x27;buildStart&#x27;</span>,</span><br><span class="line">          <span class="function">(<span class="params">plugin</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Context</span>(plugin),</span><br><span class="line">          <span class="function">() =&gt;</span> [container.<span class="property">options</span> <span class="keyword">as</span> <span class="title class_">NormalizedInputOptions</span>],</span><br><span class="line">        ),</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">resolveId</span>(<span class="params">rawId, importer = join(root, <span class="string">&#x27;index.html&#x27;</span>), options</span>) &#123;</span><br><span class="line">      <span class="comment">// 见后续分析</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">load</span>(<span class="params">id, options</span>) &#123;</span><br><span class="line">      <span class="comment">// 见后续分析</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">transform</span>(<span class="params">code, id, options</span>) &#123;</span><br><span class="line">      <span class="comment">// 见后续分析</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">watchChange</span>(<span class="params">id, change</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">new</span> <span class="title class_">Context</span>()</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">hookParallel</span>(</span><br><span class="line">        <span class="string">&#x27;watchChange&#x27;</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> ctx,</span><br><span class="line">        <span class="function">() =&gt;</span> [id, change],</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (closed) <span class="keyword">return</span></span><br><span class="line">      closed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(processesing))</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">new</span> <span class="title class_">Context</span>()</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">hookParallel</span>(</span><br><span class="line">        <span class="string">&#x27;buildEnd&#x27;</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> ctx,</span><br><span class="line">        <span class="function">() =&gt;</span> [],</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">hookParallel</span>(</span><br><span class="line">        <span class="string">&#x27;closeBundle&#x27;</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> ctx,</span><br><span class="line">        <span class="function">() =&gt;</span> [],</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="variable constant_">ASYNC_DISPOSE</span>]() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">close</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> container</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="resolveId"><a href="#resolveId" class="headerlink" title="resolveId"></a>resolveId</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> skip = options?.<span class="property">skip</span></span><br><span class="line"><span class="keyword">const</span> ssr = options?.<span class="property">ssr</span></span><br><span class="line"><span class="keyword">const</span> scan = !!options?.<span class="property">scan</span></span><br><span class="line"><span class="keyword">const</span> ctx = <span class="keyword">new</span> <span class="title class_">Context</span>()</span><br><span class="line">ctx.<span class="property">ssr</span> = !!ssr</span><br><span class="line">ctx.<span class="property">_scan</span> = scan</span><br><span class="line">ctx.<span class="property">_resolveSkips</span> = skip</span><br><span class="line"><span class="keyword">const</span> resolveStart = debugResolve ? performance.<span class="title function_">now</span>() : <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">id</span>: <span class="built_in">string</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">partial</span>: <span class="title class_">Partial</span>&lt;<span class="title class_">PartialResolvedId</span>&gt; = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="title function_">getSortedPlugins</span>(<span class="string">&#x27;resolveId&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (closed &amp;&amp; !ssr) <span class="title function_">throwClosedServerError</span>()</span><br><span class="line">  <span class="keyword">if</span> (!plugin.<span class="property">resolveId</span>) <span class="keyword">continue</span></span><br><span class="line">  <span class="keyword">if</span> (skip?.<span class="title function_">has</span>(plugin)) <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">_activePlugin</span> = plugin</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pluginResolveStart = debugPluginResolve ? performance.<span class="title function_">now</span>() : <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> handler = <span class="title function_">getHookHandler</span>(plugin.<span class="property">resolveId</span>)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">handleHookPromise</span>(</span><br><span class="line">    handler.<span class="title function_">call</span>(ctx <span class="keyword">as</span> <span class="built_in">any</span>, rawId, importer, &#123;</span><br><span class="line">      <span class="attr">attributes</span>: options?.<span class="property">attributes</span> ?? &#123;&#125;,</span><br><span class="line">      <span class="attr">custom</span>: options?.<span class="property">custom</span>,</span><br><span class="line">      <span class="attr">isEntry</span>: !!options?.<span class="property">isEntry</span>,</span><br><span class="line">      ssr,</span><br><span class="line">      scan,</span><br><span class="line">    &#125;),</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> (!result) <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    id = result</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    id = result.<span class="property">id</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(partial, result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debugPluginResolve?.(</span><br><span class="line">    <span class="title function_">timeFrom</span>(pluginResolveStart),</span><br><span class="line">    plugin.<span class="property">name</span>,</span><br><span class="line">    <span class="title function_">prettifyUrl</span>(id, root),</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// resolveId() is hookFirst - first non-null result is returned.</span></span><br><span class="line">  <span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (debugResolve &amp;&amp; rawId !== id &amp;&amp; !rawId.<span class="title function_">startsWith</span>(<span class="variable constant_">FS_PREFIX</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = rawId + id</span><br><span class="line">  <span class="comment">// avoid spamming</span></span><br><span class="line">  <span class="keyword">if</span> (!seenResolves[key]) &#123;</span><br><span class="line">    seenResolves[key] = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">debugResolve</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;timeFrom(resolveStart)&#125;</span> <span class="subst">$&#123;colors.cyan(rawId)&#125;</span> -&gt; <span class="subst">$&#123;colors.dim(</span></span></span><br><span class="line"><span class="subst"><span class="string">        id,</span></span></span><br><span class="line"><span class="subst"><span class="string">      )&#125;</span>`</span>,</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (id) &#123;</span><br><span class="line">  partial.<span class="property">id</span> = <span class="title function_">isExternalUrl</span>(id) ? id : <span class="title function_">normalizePath</span>(id)</span><br><span class="line">  <span class="keyword">return</span> partial <span class="keyword">as</span> <span class="title class_">PartialResolvedId</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从这段代码中我们可以看出，resolveId这个hook只要有一个插件中执行成功了，就不会再执行之后的其他插件的resolveId。</p><h2 id="load"><a href="#load" class="headerlink" title="load"></a>load</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ssr = options?.<span class="property">ssr</span></span><br><span class="line"><span class="keyword">const</span> ctx = <span class="keyword">new</span> <span class="title class_">Context</span>()</span><br><span class="line">ctx.<span class="property">ssr</span> = !!ssr</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="title function_">getSortedPlugins</span>(<span class="string">&#x27;load&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (closed &amp;&amp; !ssr) <span class="title function_">throwClosedServerError</span>()</span><br><span class="line">  <span class="keyword">if</span> (!plugin.<span class="property">load</span>) <span class="keyword">continue</span></span><br><span class="line">  ctx.<span class="property">_activePlugin</span> = plugin</span><br><span class="line">  <span class="keyword">const</span> handler = <span class="title function_">getHookHandler</span>(plugin.<span class="property">load</span>)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">handleHookPromise</span>(</span><br><span class="line">    handler.<span class="title function_">call</span>(ctx <span class="keyword">as</span> <span class="built_in">any</span>, id, &#123; ssr &#125;),</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">      <span class="title function_">updateModuleInfo</span>(id, result)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><p>可以看出，每次load除了调用hook，还会调用<code>updateModuleInfo</code>更新模块的引用关系和信息</p><h2 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inMap = options?.<span class="property">inMap</span></span><br><span class="line"><span class="keyword">const</span> ssr = options?.<span class="property">ssr</span></span><br><span class="line"><span class="keyword">const</span> ctx = <span class="keyword">new</span> <span class="title class_">TransformContext</span>(id, code, inMap <span class="keyword">as</span> <span class="title class_">SourceMap</span>)</span><br><span class="line">ctx.<span class="property">ssr</span> = !!ssr</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> <span class="title function_">getSortedPlugins</span>(<span class="string">&#x27;transform&#x27;</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (closed &amp;&amp; !ssr) <span class="title function_">throwClosedServerError</span>()</span><br><span class="line">  <span class="keyword">if</span> (!plugin.<span class="property">transform</span>) <span class="keyword">continue</span></span><br><span class="line">  ctx.<span class="property">_activePlugin</span> = plugin</span><br><span class="line">  ctx.<span class="property">_activeId</span> = id</span><br><span class="line">  ctx.<span class="property">_activeCode</span> = code</span><br><span class="line">  <span class="keyword">const</span> start = debugPluginTransform ? performance.<span class="title function_">now</span>() : <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">result</span>: <span class="title class_">TransformResult</span> | <span class="built_in">string</span> | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">const</span> handler = <span class="title function_">getHookHandler</span>(plugin.<span class="property">transform</span>)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = <span class="keyword">await</span> <span class="title function_">handleHookPromise</span>(</span><br><span class="line">      handler.<span class="title function_">call</span>(ctx <span class="keyword">as</span> <span class="built_in">any</span>, code, id, &#123; ssr &#125;),</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    ctx.<span class="title function_">error</span>(e)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!result) <span class="keyword">continue</span></span><br><span class="line">  debugPluginTransform?.(</span><br><span class="line">    <span class="title function_">timeFrom</span>(start),</span><br><span class="line">    plugin.<span class="property">name</span>,</span><br><span class="line">    <span class="title function_">prettifyUrl</span>(id, root),</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">code</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      code = result.<span class="property">code</span></span><br><span class="line">      <span class="keyword">if</span> (result.<span class="property">map</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debugSourcemapCombine) &#123;</span><br><span class="line">          <span class="comment">// @ts-expect-error inject plugin name for debug purpose</span></span><br><span class="line">          result.<span class="property">map</span>.<span class="property">name</span> = plugin.<span class="property">name</span></span><br><span class="line">        &#125;</span><br><span class="line">        ctx.<span class="property">sourcemapChain</span>.<span class="title function_">push</span>(result.<span class="property">map</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">updateModuleInfo</span>(id, result)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    code = result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  code,</span><br><span class="line">  <span class="attr">map</span>: ctx.<span class="title function_">_getCombinedSourcemap</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里可以看出，transform方法是全部都会顺序执行的，这一点和resolveId不同</p><h1 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h1><p>热更新的代码分为两部分，一部分是服务端检测文件的变化，判断哪些模块需要更新，然后发送ws消息给客户端，客户端代码重新拉取新的模块进行更新逻辑。</p><p>我们这次主要看服务端的代码，客户端代码的更新逻辑更多的是和框架本身的关系。</p><p>服务端热更新的入口代码在watcher的回调函数中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">onHMRUpdate</span> = <span class="keyword">async</span> (<span class="params">file: <span class="built_in">string</span>, configOnly: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (serverConfig.<span class="property">hmr</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">handleHMRUpdate</span>(file, server, configOnly)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">        <span class="attr">err</span>: <span class="title function_">prepareError</span>(err),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onFileAddUnlink</span> = <span class="keyword">async</span> (<span class="params">file: <span class="built_in">string</span>, isUnlink: <span class="built_in">boolean</span></span>) =&gt; &#123;</span><br><span class="line">  file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">  <span class="keyword">await</span> container.<span class="title function_">watchChange</span>(file, &#123; <span class="attr">event</span>: isUnlink ? <span class="string">&#x27;delete&#x27;</span> : <span class="string">&#x27;create&#x27;</span> &#125;)</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">handleFileAddUnlink</span>(file, server, isUnlink)</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">async</span> (file) =&gt; &#123;</span><br><span class="line">  file = <span class="title function_">normalizePath</span>(file)</span><br><span class="line">  <span class="keyword">await</span> container.<span class="title function_">watchChange</span>(file, &#123; <span class="attr">event</span>: <span class="string">&#x27;update&#x27;</span> &#125;)</span><br><span class="line">  <span class="comment">// invalidate module graph cache on file change</span></span><br><span class="line">  moduleGraph.<span class="title function_">onFileChange</span>(file)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">onHMRUpdate</span>(file, <span class="literal">false</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;add&#x27;</span>, <span class="function">(<span class="params">file</span>) =&gt;</span> <span class="title function_">onFileAddUnlink</span>(file, <span class="literal">false</span>))</span><br><span class="line">watcher.<span class="title function_">on</span>(<span class="string">&#x27;unlink&#x27;</span>, <span class="function">(<span class="params">file</span>) =&gt;</span> <span class="title function_">onFileAddUnlink</span>(file, <span class="literal">true</span>))</span><br></pre></td></tr></table></figure><p>主要的处理函数，是handleHMRUpdate，我们就看一下其中的源码</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">handleHMRUpdate</span>(<span class="params"></span></span><br><span class="line"><span class="params">  file: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  server: ViteDevServer,</span></span><br><span class="line"><span class="params">  configOnly: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; ws, config, moduleGraph &#125; = server</span><br><span class="line">  <span class="keyword">const</span> shortFile = <span class="title function_">getShortName</span>(file, config.<span class="property">root</span>)</span><br><span class="line">  <span class="keyword">const</span> fileName = path.<span class="title function_">basename</span>(file)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isConfig = file === config.<span class="property">configFile</span></span><br><span class="line">  <span class="keyword">const</span> isConfigDependency = config.<span class="property">configFileDependencies</span>.<span class="title function_">some</span>(</span><br><span class="line">    <span class="function">(<span class="params">name</span>) =&gt;</span> file === name,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isEnv =</span><br><span class="line">    config.<span class="property">inlineConfig</span>.<span class="property">envFile</span> !== <span class="literal">false</span> &amp;&amp;</span><br><span class="line">    <span class="title function_">getEnvFilesForMode</span>(config.<span class="property">mode</span>).<span class="title function_">includes</span>(fileName)</span><br><span class="line">  <span class="keyword">if</span> (isConfig || isConfigDependency || isEnv) &#123;</span><br><span class="line">    <span class="comment">// auto restart server</span></span><br><span class="line">    debugHmr?.(<span class="string">`[config change] <span class="subst">$&#123;colors.dim(shortFile)&#125;</span>`</span>)</span><br><span class="line">    config.<span class="property">logger</span>.<span class="title function_">info</span>(</span><br><span class="line">      colors.<span class="title function_">green</span>(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;path.relative(process.cwd(), file)&#125;</span> changed, restarting server...`</span>,</span><br><span class="line">      ),</span><br><span class="line">      &#123; <span class="attr">clear</span>: <span class="literal">true</span>, <span class="attr">timestamp</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">restartServerWithUrls</span>(server)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      config.<span class="property">logger</span>.<span class="title function_">error</span>(colors.<span class="title function_">red</span>(e))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (configOnly) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debugHmr?.(<span class="string">`[file change] <span class="subst">$&#123;colors.dim(shortFile)&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (dev only) the client itself cannot be hot updated.</span></span><br><span class="line">  <span class="keyword">if</span> (file.<span class="title function_">startsWith</span>(<span class="title function_">withTrailingSlash</span>(normalizedClientDir))) &#123;</span><br><span class="line">    ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> mods = moduleGraph.<span class="title function_">getModulesByFile</span>(file)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if any plugin wants to perform custom HMR handling</span></span><br><span class="line">  <span class="keyword">const</span> timestamp = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">hmrContext</span>: <span class="title class_">HmrContext</span> = &#123;</span><br><span class="line">    file,</span><br><span class="line">    timestamp,</span><br><span class="line">    <span class="attr">modules</span>: mods ? [...mods] : [],</span><br><span class="line">    <span class="attr">read</span>: <span class="function">() =&gt;</span> <span class="title function_">readModifiedFile</span>(file),</span><br><span class="line">    server,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> config.<span class="title function_">getSortedPluginHooks</span>(<span class="string">&#x27;handleHotUpdate&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> filteredModules = <span class="keyword">await</span> <span class="title function_">hook</span>(hmrContext)</span><br><span class="line">    <span class="keyword">if</span> (filteredModules) &#123;</span><br><span class="line">      hmrContext.<span class="property">modules</span> = filteredModules</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!hmrContext.<span class="property">modules</span>.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="comment">// html file cannot be hot updated</span></span><br><span class="line">    <span class="keyword">if</span> (file.<span class="title function_">endsWith</span>(<span class="string">&#x27;.html&#x27;</span>)) &#123;</span><br><span class="line">      config.<span class="property">logger</span>.<span class="title function_">info</span>(colors.<span class="title function_">green</span>(<span class="string">`page reload `</span>) + colors.<span class="title function_">dim</span>(shortFile), &#123;</span><br><span class="line">        <span class="attr">clear</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: config.<span class="property">server</span>.<span class="property">middlewareMode</span></span><br><span class="line">          ? <span class="string">&#x27;*&#x27;</span></span><br><span class="line">          : <span class="string">&#x27;/&#x27;</span> + <span class="title function_">normalizePath</span>(path.<span class="title function_">relative</span>(config.<span class="property">root</span>, file)),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// loaded but not in the module graph, probably not js</span></span><br><span class="line">      debugHmr?.(<span class="string">`[no modules matched] <span class="subst">$&#123;colors.dim(shortFile)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateModules</span>(shortFile, hmrContext.<span class="property">modules</span>, timestamp, server)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateModules</span>(<span class="params"></span></span><br><span class="line"><span class="params">  file: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  modules: ModuleNode[],</span></span><br><span class="line"><span class="params">  timestamp: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  &#123; config, ws, moduleGraph &#125;: ViteDevServer,</span></span><br><span class="line"><span class="params">  afterInvalidation?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">updates</span>: <span class="title class_">Update</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> invalidatedModules = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> traversedModules = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">ModuleNode</span>&gt;()</span><br><span class="line">  <span class="keyword">let</span> needFullReload = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> mod <span class="keyword">of</span> modules) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">boundaries</span>: &#123; <span class="attr">boundary</span>: <span class="title class_">ModuleNode</span>; <span class="attr">acceptedVia</span>: <span class="title class_">ModuleNode</span> &#125;[] = []</span><br><span class="line">    <span class="keyword">const</span> hasDeadEnd = <span class="title function_">propagateUpdate</span>(mod, traversedModules, boundaries)</span><br><span class="line"></span><br><span class="line">    moduleGraph.<span class="title function_">invalidateModule</span>(</span><br><span class="line">      mod,</span><br><span class="line">      invalidatedModules,</span><br><span class="line">      timestamp,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      boundaries.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="property">boundary</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needFullReload) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDeadEnd) &#123;</span><br><span class="line">      needFullReload = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    updates.<span class="title function_">push</span>(</span><br><span class="line">      ...boundaries.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; boundary, acceptedVia &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;boundary.<span class="keyword">type</span>&#125;</span>-update`</span> <span class="keyword">as</span> <span class="keyword">const</span>,</span><br><span class="line">        timestamp,</span><br><span class="line">        <span class="attr">path</span>: <span class="title function_">normalizeHmrUrl</span>(boundary.<span class="property">url</span>),</span><br><span class="line">        <span class="attr">explicitImportRequired</span>:</span><br><span class="line">          boundary.<span class="property">type</span> === <span class="string">&#x27;js&#x27;</span></span><br><span class="line">            ? <span class="title function_">isExplicitImportRequired</span>(acceptedVia.<span class="property">url</span>)</span><br><span class="line">            : <span class="literal">undefined</span>,</span><br><span class="line">        <span class="attr">acceptedPath</span>: <span class="title function_">normalizeHmrUrl</span>(acceptedVia.<span class="property">url</span>),</span><br><span class="line">      &#125;)),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (needFullReload) &#123;</span><br><span class="line">    config.<span class="property">logger</span>.<span class="title function_">info</span>(colors.<span class="title function_">green</span>(<span class="string">`page reload `</span>) + colors.<span class="title function_">dim</span>(file), &#123;</span><br><span class="line">      <span class="attr">clear</span>: !afterInvalidation,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (updates.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    debugHmr?.(colors.<span class="title function_">yellow</span>(<span class="string">`no update happened `</span>) + colors.<span class="title function_">dim</span>(file))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  config.<span class="property">logger</span>.<span class="title function_">info</span>(</span><br><span class="line">    colors.<span class="title function_">green</span>(<span class="string">`hmr update `</span>) +</span><br><span class="line">      colors.<span class="title function_">dim</span>([...<span class="keyword">new</span> <span class="title class_">Set</span>(updates.<span class="title function_">map</span>(<span class="function">(<span class="params">u</span>) =&gt;</span> u.<span class="property">path</span>))].<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>)),</span><br><span class="line">    &#123; <span class="attr">clear</span>: !afterInvalidation, <span class="attr">timestamp</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  )</span><br><span class="line">  ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">    updates,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们简单分析一下其中几种情况：</p><h2 id="vite代码本身改变需要full-reload"><a href="#vite代码本身改变需要full-reload" class="headerlink" title="vite代码本身改变需要full-reload"></a>vite代码本身改变需要full-reload</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (dev only) the client itself cannot be hot updated.</span></span><br><span class="line"><span class="keyword">if</span> (file.<span class="title function_">startsWith</span>(<span class="title function_">withTrailingSlash</span>(normalizedClientDir))) &#123;</span><br><span class="line">  ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">withTrailingSlash</span>(<span class="params">path: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (path[path.<span class="property">length</span> - <span class="number">1</span>] !== <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;path&#125;</span>/`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> path</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> normalizedClientDir = <span class="title function_">normalizePath</span>(<span class="variable constant_">CLIENT_DIR</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">CLIENT_ENTRY</span> = <span class="title function_">resolve</span>(<span class="variable constant_">VITE_PACKAGE_DIR</span>, <span class="string">&#x27;dist/client/client.mjs&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">CLIENT_DIR</span> = path.<span class="title function_">dirname</span>(<span class="variable constant_">CLIENT_ENTRY</span>)</span><br></pre></td></tr></table></figure><h2 id="html文件需要full-reload"><a href="#html文件需要full-reload" class="headerlink" title="html文件需要full-reload"></a>html文件需要full-reload</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// html file cannot be hot updated</span></span><br><span class="line"><span class="keyword">if</span> (file.<span class="title function_">endsWith</span>(<span class="string">&#x27;.html&#x27;</span>)) &#123;</span><br><span class="line">  config.<span class="property">logger</span>.<span class="title function_">info</span>(colors.<span class="title function_">green</span>(<span class="string">`page reload `</span>) + colors.<span class="title function_">dim</span>(shortFile), &#123;</span><br><span class="line">    <span class="attr">clear</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">timestamp</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">  ws.<span class="title function_">send</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;full-reload&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: config.<span class="property">server</span>.<span class="property">middlewareMode</span></span><br><span class="line">      ? <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      : <span class="string">&#x27;/&#x27;</span> + <span class="title function_">normalizePath</span>(path.<span class="title function_">relative</span>(config.<span class="property">root</span>, file)),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="有循环引用需要full-reload"><a href="#有循环引用需要full-reload" class="headerlink" title="有循环引用需要full-reload"></a>有循环引用需要full-reload</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasDeadEnd = <span class="title function_">propagateUpdate</span>(mod, traversedModules, boundaries)</span><br><span class="line"></span><br><span class="line">moduleGraph.<span class="title function_">invalidateModule</span>(</span><br><span class="line">  mod,</span><br><span class="line">  invalidatedModules,</span><br><span class="line">  timestamp,</span><br><span class="line">  <span class="literal">true</span>,</span><br><span class="line">  boundaries.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="property">boundary</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (needFullReload) &#123;</span><br><span class="line">  <span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasDeadEnd) &#123;</span><br><span class="line">  needFullReload = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">propagateUpdate</span>(<span class="params"></span></span><br><span class="line"><span class="params">  node: ModuleNode,</span></span><br><span class="line"><span class="params">  traversedModules: <span class="built_in">Set</span>&lt;ModuleNode&gt;,</span></span><br><span class="line"><span class="params">  boundaries: &#123; boundary: ModuleNode; acceptedVia: ModuleNode &#125;[],</span></span><br><span class="line"><span class="params">  currentChain: ModuleNode[] = [node],</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">boolean</span> <span class="comment">/* hasDeadEnd */</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (traversedModules.<span class="title function_">has</span>(node)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  traversedModules.<span class="title function_">add</span>(node)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// #7561</span></span><br><span class="line">  <span class="comment">// if the imports of `node` have not been analyzed, then `node` has not</span></span><br><span class="line">  <span class="comment">// been loaded in the browser and we should stop propagation.</span></span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">id</span> &amp;&amp; node.<span class="property">isSelfAccepting</span> === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    debugHmr?.(</span><br><span class="line">      <span class="string">`[propagate update] stop propagation because not analyzed: <span class="subst">$&#123;colors.dim(</span></span></span><br><span class="line"><span class="subst"><span class="string">        node.id,</span></span></span><br><span class="line"><span class="subst"><span class="string">      )&#125;</span>`</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">isSelfAccepting</span>) &#123;</span><br><span class="line">    boundaries.<span class="title function_">push</span>(&#123; <span class="attr">boundary</span>: node, <span class="attr">acceptedVia</span>: node &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// additionally check for CSS importers, since a PostCSS plugin like</span></span><br><span class="line">    <span class="comment">// Tailwind JIT may register any file as a dependency to a CSS file.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> importer <span class="keyword">of</span> node.<span class="property">importers</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isCSSRequest</span>(importer.<span class="property">url</span>) &amp;&amp; !currentChain.<span class="title function_">includes</span>(importer)) &#123;</span><br><span class="line">        <span class="title function_">propagateUpdate</span>(</span><br><span class="line">          importer,</span><br><span class="line">          traversedModules,</span><br><span class="line">          boundaries,</span><br><span class="line">          currentChain.<span class="title function_">concat</span>(importer),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A partially accepted module with no importers is considered self accepting,</span></span><br><span class="line">  <span class="comment">// because the deal is &quot;there are parts of myself I can&#x27;t self accept if they</span></span><br><span class="line">  <span class="comment">// are used outside of me&quot;.</span></span><br><span class="line">  <span class="comment">// Also, the imported module (this one) must be updated before the importers,</span></span><br><span class="line">  <span class="comment">// so that they do get the fresh imported module when/if they are reloaded.</span></span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">acceptedHmrExports</span>) &#123;</span><br><span class="line">    boundaries.<span class="title function_">push</span>(&#123; <span class="attr">boundary</span>: node, <span class="attr">acceptedVia</span>: node &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!node.<span class="property">importers</span>.<span class="property">size</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #3716, #3913</span></span><br><span class="line">    <span class="comment">// For a non-CSS file, if all of its importers are CSS files (registered via</span></span><br><span class="line">    <span class="comment">// PostCSS plugins) it should be considered a dead end and force full reload.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !<span class="title function_">isCSSRequest</span>(node.<span class="property">url</span>) &amp;&amp;</span><br><span class="line">      [...node.<span class="property">importers</span>].<span class="title function_">every</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> <span class="title function_">isCSSRequest</span>(i.<span class="property">url</span>))</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> importer <span class="keyword">of</span> node.<span class="property">importers</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> subChain = currentChain.<span class="title function_">concat</span>(importer)</span><br><span class="line">    <span class="keyword">if</span> (importer.<span class="property">acceptedHmrDeps</span>.<span class="title function_">has</span>(node)) &#123;</span><br><span class="line">      boundaries.<span class="title function_">push</span>(&#123; <span class="attr">boundary</span>: importer, <span class="attr">acceptedVia</span>: node &#125;)</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">id</span> &amp;&amp; node.<span class="property">acceptedHmrExports</span> &amp;&amp; importer.<span class="property">importedBindings</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> importedBindingsFromNode = importer.<span class="property">importedBindings</span>.<span class="title function_">get</span>(node.<span class="property">id</span>)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        importedBindingsFromNode &amp;&amp;</span><br><span class="line">        <span class="title function_">areAllImportsAccepted</span>(importedBindingsFromNode, node.<span class="property">acceptedHmrExports</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentChain.<span class="title function_">includes</span>(importer)) &#123;</span><br><span class="line">      <span class="comment">// circular deps is considered dead end</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">propagateUpdate</span>(importer, traversedModules, boundaries, subChain)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实这里的判断逻辑就会解释我们上一篇博客<a href="https://sunra.top/posts/6b29912b/">Vite学习笔记（三）如何兼容旧项目中的react-css-module并实现热更新</a>中说的为什么不添加<code>__CSS_TO_MODULE_FLAG__=1</code>会让每次css更新都让页面full-reload</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>本文作者：</strong> Ray Sun</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="https://sunra.top/2023/11/04/vite-4-origin-code/" title="Vite学习笔记（四）Vite源码分析">https://sunra.top/2023/11/04/vite-4-origin-code/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="followme"> <span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/2023/10/29/vite-3-css-to-module/" rel="prev" title="Vite学习笔记（三）如何兼容旧项目中的react-css-module并实现热更新"><i class="fa fa-chevron-left"></i> Vite学习笔记（三）如何兼容旧项目中的react-css-module并实现热更新</a></div><div class="post-nav-item"> <a href="/2023/11/12/retryable-async-function-hook/" rel="next" title="在react中实现一个可以进行异步函数重试的状态机hook">在react中实现一个可以进行异步函数重试的状态机hook<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a> 强力驱动</div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2023/11/04/vite-4-origin-code/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>