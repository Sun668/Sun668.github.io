<!DOCTYPE html>
<html lang>
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sunra.top","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前段时间做了个油猴插件，把项目组常用的项目在不同环境的url给整理一下，方便使用。最近又被各个项目在各个环境的db配置搞得有点烦，就想着把db的配置也放进脚本里，但是这些db配置中还有些敏感的信息，贸然放进去可能会有安全的问题，为了研究一下TamperMonkey的安全性，就研究了下TamperMonkey的文档以及它的一点原理。">
<meta property="og:type" content="article">
<meta property="og:title" content="TamperMonkey 对于内容的保护">
<meta property="og:url" content="https://sunra.top/2020/07/31/tamper-monkey-security/index.html">
<meta property="og:site_name" content="Origin of Ray">
<meta property="og:description" content="前段时间做了个油猴插件，把项目组常用的项目在不同环境的url给整理一下，方便使用。最近又被各个项目在各个环境的db配置搞得有点烦，就想着把db的配置也放进脚本里，但是这些db配置中还有些敏感的信息，贸然放进去可能会有安全的问题，为了研究一下TamperMonkey的安全性，就研究了下TamperMonkey的文档以及它的一点原理。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2021-09-03T00:51:55.416Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TamperMonkey 对于内容的保护">
<meta name="twitter:description" content="前段时间做了个油猴插件，把项目组常用的项目在不同环境的url给整理一下，方便使用。最近又被各个项目在各个环境的db配置搞得有点烦，就想着把db的配置也放进脚本里，但是这些db配置中还有些敏感的信息，贸然放进去可能会有安全的问题，为了研究一下TamperMonkey的安全性，就研究了下TamperMonkey的文档以及它的一点原理。">

<link rel="canonical" href="https://sunra.top/2020/07/31/tamper-monkey-security/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>TamperMonkey 对于内容的保护 | Origin of Ray</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Origin of Ray" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Origin of Ray</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一起探索互联网的秘密</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://sunra.top/2020/07/31/tamper-monkey-security/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
      <meta itemprop="name" content="Ray Sun">
      <meta itemprop="description" content="拨开互联网的迷雾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Origin of Ray">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          TamperMonkey 对于内容的保护
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-31 18:32:31" itemprop="dateCreated datePublished" datetime="2020-07-31T18:32:31+08:00">2020-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-03 08:51:55" itemprop="dateModified" datetime="2021-09-03T08:51:55+08:00">2021-09-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>前段时间做了个油猴插件，把项目组常用的项目在不同环境的url给整理一下，方便使用。<br>最近又被各个项目在各个环境的db配置搞得有点烦，就想着把db的配置也放进脚本里，但是这些db配置中还有些敏感的信息，贸然放进去可能会有安全的问题，为了研究一下TamperMonkey的安全性，就研究了下TamperMonkey的文档以及它的一点原理。<br><a id="more"></a></p>
<h2 id="独立的运行环境"><a href="#独立的运行环境" class="headerlink" title="独立的运行环境"></a>独立的运行环境</h2><p>首先粘一段国外论坛上的结论：</p>
<p>See <a href="https://stackoverflow.com/q/6617361/331508" rel="external nofollow noopener noreferrer" target="_blank">“Are Chrome user-scripts separated from the global namespace like Greasemonkey scripts?”</a>. Both Chrome userscripts/content-scripts and Greasemonkey scripts are isolated from the page’s javascript. This is done to help keep you from being hacked, but it also reduces conflicts and unexpected side-effects.</p>
<p>However, the methods are different for each browser…</p>
<p><strong>Firefox:</strong></p>
<ol>
<li>Runs scripts in <a href="https://developer.mozilla.org/en/XPCNativeWrapper" rel="external nofollow noopener noreferrer" target="_blank">an XPCNativeWrapper sandbox</a>, unless <a href="http://wiki.greasespot.net/@grant" rel="external nofollow noopener noreferrer" target="_blank">@grant none</a> is in effect (as of GM 1.0).</li>
<li>Wraps the script in an anonymous function by default.</li>
<li>Provides unsafeWindow to access the target page’s javascript. But beware that it is <em>possible</em> for hostile webmasters to follow unsafeWindow usage back to the script’s context and thus gain elevated privileges to pwn you with.</li>
</ol>
<p><strong>Chrome:</strong></p>
<ol>
<li><p>Runs scripts in <a href="https://developer.chrome.com/extensions/content_scripts.html#execution-environment" rel="external nofollow noopener noreferrer" target="_blank">an “isolated world”</a>.</p>
</li>
<li><p>Wraps the script in an anonymous function.</p>
</li>
<li><p><strong>Strictly</strong> blocks any access to the page’s JS by the script and vice-versa.</p>
<p>Recent versions of Chrome now provide an object named unsafeWindow, for very-limited compatibility, but this object does not provide any access to the target page’s JS. It is the same as window in the script scope (which is not window in the page scope).</p>
</li>
</ol>
<p>上面这段结论大致可以总结为，TamperMonkey的运行环境与页面的JS脚本不是一个，TamperMonkey中的脚本运行在一个沙箱环境中，但是二者都可以操作页面。</p>
<p>沙箱的环境也是有所不同的，如果你的@grant的值是none，那么如果你向window对象上挂载了一些属性，其他脚本理论上也是可以访问到的。</p>
<p>但如果你的@grant不是none，那么就连window对象都是分开的，你在脚本中挂载的属性在其他脚本中是无法访问的。</p>
<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>我们看一下TamperMonkey脚本的基本格式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         New Userscript</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  try to take over the world!</span></span><br><span class="line"><span class="comment">// @author       You</span></span><br><span class="line"><span class="comment">// @match        https://developer.mozilla.org/en-US/docs/Mozilla/Tech/Xray_vision</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">    'use strict'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Your code here...</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>我们可以一眼就看出，这是个闭包，而且是个立即执行函数，所以定义在其中所有变量，除非我们有意识地挂载到window上，否则在外部是无法访问地。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>综上所述，TamperMonkey中的脚本是运行在完全独立于page的JS的另一个环境中，各个脚本之间不会相互影响，同时由于脚本的实际内容都是在一个闭包中，只有在grant是none且我们有意识地向window对象上挂载一个属性，不然这个属性是不会被外部访问到的。</p>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><h3 id="Chrome-Xray"><a href="#Chrome-Xray" class="headerlink" title="Chrome Xray"></a>Chrome Xray</h3><p>Gecko从各种不同的来源并以各种不同的特权级别运行JavaScript：</p>
<ul>
<li><p>与C ++核心一起实现浏览器本身的JavaScript代码称为chrome代码，并使用系统特权运行。 如果chrome特权代码遭到破坏，则攻击者可以接管用户的计算机。</p>
</li>
<li><p>从普通网页加载的JavaScript称为内容代码。 因为此代码是从任意网页加载的，所以对于其他网站和用户而言，它均被视为不受信任且可能具有敌意。</p>
</li>
<li><p>除了这两个特权级别，chrome代码还可以创建沙箱。 为沙箱定义的安全主体确定其特权级别。 如果使用扩展主体，则沙箱将获得对内容代码的某些特权，并且受到内容代码的直接访问保护。</p>
</li>
</ul>
<p>Gecko中的安全机制可确保不同特权级别的代码之间存在非对称访问：例如，内容代码无法访问由chrome代码创建的对象，但是chrome代码可以访问由内容创建的对象。</p>
<p>但是，即使访问内容对象的能力也可能会对chrome代码造成安全风险。 JavaScript是一种高度可扩展的语言。 在网页中运行的脚本可以为DOM对象添加额外的属性（也称为expando属性），甚至可以重新定义标准的DOM对象以执行意外的操作。 如果chrome代码依赖于此类修改后的对象，则可以欺骗它做不应做的事情。</p>
<p>例如：window.confirm（）是一个DOM API，应该让用户确认一个动作，并根据他们单击“确定”还是“取消”返回一个布尔值。 网页可以重新定义它以返回true：</p>
<p>任何调用此函数并期望其结果代表用户确认的特权代码都会被欺骗。 当然，这是非常幼稚的，但是从chrome访问内容对象会导致安全问题的方法更细微。</p>
<p>这是Xray旨在解决的问题。 当脚本使用Xray访问对象时，它只会看到该对象的本机版本。 任何expandos都是不可见的，并且如果已重新定义对象的任何属性，它将看到原始的实现，而不是重新定义的版本。</p>
<p>因此，在上面的示例中，调用内容的window.confirm（）的chrome代码将获得Confirm（）的原始版本，而不是重新定义的版本。</p>
<p>特权代码在访问属于特权较少的代码的对象时自动获得Xray。 因此，当chrome代码访问内容对象时，它会通过Xray看到它们：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome code</span></span><br><span class="line"><span class="keyword">var</span> transfer = gBrowser.contentWindow.confirm(<span class="string">"Transfer all my money?"</span>);</span><br><span class="line"><span class="comment">// calls the native implementation</span></span><br></pre></td></tr></table></figure>
<h4 id="禁止Xray"><a href="#禁止Xray" class="headerlink" title="禁止Xray"></a>禁止Xray</h4><p>Xray是一种安全启发式设计，旨在使对不受信任的对象的最常见操作变得简单和安全。 但是，有些操作对它们的限制过于严格：例如，如果需要查看DOM对象上的expandos。 在这种情况下，您可以放弃Xray防护，但随后您将不再依赖于正在或正在执行的任何属性或功能。 其中的任何一个，甚至是setter和getter，都可能已被不受信任的代码重新定义。</p>
<p>要放弃对象的Xray，可以使用Components.utils.waiveXrays（object），也可以使用对象的wrappedJSObject属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chrome code</span></span><br><span class="line"><span class="keyword">var</span> waivedWindow = Components.utils.waiveXrays(gBrowser.contentWindow);</span><br><span class="line"><span class="keyword">var</span> transfer = waivedWindow.confirm(<span class="string">"Transfer all my money?"</span>);</span><br><span class="line"><span class="comment">// calls the redefined implementation</span></span><br><span class="line"><span class="comment">// chrome code</span></span><br><span class="line"><span class="keyword">var</span> waivedWindow = gBrowser.contentWindow.wrappedJSObject;</span><br><span class="line"><span class="keyword">var</span> transfer = waivedWindow.confirm(<span class="string">"Transfer all my money?"</span>);</span><br><span class="line"><span class="comment">// calls the redefined implementation</span></span><br></pre></td></tr></table></figure>
<p>豁免是可传递的：因此，如果您放弃某个对象的Xray，则将自动放弃其所有对象属性。 例如，window.wrappedJSObject.document可让您放弃文档版本。</p>
<p>要再次撤消放弃，请调用Components.utils.unwaiveXrays（waivedObject）：</p>
<h4 id="Xray-For-DOM"><a href="#Xray-For-DOM" class="headerlink" title="Xray For DOM"></a>Xray For DOM</h4><p>Xray的主要用途是用于DOM对象：即代表网页各部分的对象。</p>
<p>在Gecko中，DOM对象具有双重表示形式：规范表示形式采用C ++，并且为了体现JavaScript代码的优势，这被反映到JavaScript中。 对这些对象的任何修改（例如添加expandos或重新定义标准属性）都保留在JavaScript反射中，并且不影响C ++表示形式。</p>
<p>双重表示形式实现了Xrays的优雅实现：Xray只是直接访问原始对象的C ++表示形式，而根本不涉及内容的JavaScript反射。 Xray不会完全过滤出内容所做的修改，而是将内容完全短路。</p>
<p>这也使Xrays对DOM对象的语义更加清晰：它们与DOM规范相同，因为它是使用WebIDL定义的，并且WebIDL还定义了C ++表示形式。</p>
<h4 id="Xray-For-JavaScript-Object"><a href="#Xray-For-JavaScript-Object" class="headerlink" title="Xray For JavaScript Object"></a>Xray For JavaScript Object</h4><p>直到最近，通过特权更高的代码访问时，不属于DOM的内置JavaScript对象（例如Date，Error和Object）都无法获得Xray。</p>
<p>在大多数情况下，这不是问题：Xrays解决的主要问题是处理不受信任的Web内容操纵对象，并且Web内容通常与DOM对象一起工作。 例如，如果内容代码创建一个新的Date对象，则通常将其创建为DOM对象的属性，然后由DOM Xray过滤掉：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content code</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// redefine Date.getFullYear()</span></span><br><span class="line"><span class="built_in">Date</span>.prototype.getFullYear = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="number">1000</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"><span class="comment">// chrome code</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// contentWindow is an Xray, and date is an expando on contentWindow</span></span><br><span class="line"><span class="comment">// so date is filtered out</span></span><br><span class="line">gBrowser.contentWindow.date.getFullYear()</span><br><span class="line"><span class="comment">// -&gt; TypeError: gBrowser.contentWindow.date is undefined</span></span><br></pre></td></tr></table></figure>
<h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3><p>Extensions are made of different, but cohesive, components. Components can include <a href="https://developer.chrome.com/background_pages.html" rel="external nofollow noopener noreferrer" target="_blank">background scripts</a>, <a href="https://developer.chrome.com/content_scripts.html" rel="external nofollow noopener noreferrer" target="_blank">content scripts</a>, an <a href="https://developer.chrome.com/options" rel="external nofollow noopener noreferrer" target="_blank">options page</a>, <a href="https://developer.chrome.com/user_interface.html" rel="external nofollow noopener noreferrer" target="_blank">UI elements</a> and various logic files. Extension components are created with web development technologies: HTML, CSS, and JavaScript. An extension’s components will depend on its functionality and may not require every option</p>
<h4 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h4><p>An extension’s architecture will depend on its functionality, but many robust extensions will include multiple components:</p>
<ul>
<li><a href="https://developer.chrome.com/extensions/extensions/manifest" rel="external nofollow noopener noreferrer" target="_blank">Manifest</a></li>
<li><a href="https://developer.chrome.com/extensions/overview#background_script" rel="external nofollow noopener noreferrer" target="_blank">Background Script</a></li>
<li><a href="https://developer.chrome.com/extensions/overview#pages" rel="external nofollow noopener noreferrer" target="_blank">UI Elements</a></li>
<li><a href="https://developer.chrome.com/extensions/overview#contentScripts" rel="external nofollow noopener noreferrer" target="_blank">Content Script</a></li>
<li><a href="https://developer.chrome.com/extensions/overview#optionsPage" rel="external nofollow noopener noreferrer" target="_blank">Options Page</a></li>
</ul>
<h4 id="Manifest"><a href="#Manifest" class="headerlink" title="Manifest"></a>Manifest</h4><p><a href="https://developer.chrome.com/extensions/manifest" rel="external nofollow noopener noreferrer" target="_blank">https://developer.chrome.com/extensions/manifest</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Getting Started Example"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"Build an Extension!"</span>,</span><br><span class="line">  <span class="attr">"permissions"</span>: [<span class="string">"activeTab"</span>, <span class="string">"declarativeContent"</span>, <span class="string">"storage"</span>],</span><br><span class="line">  <span class="attr">"options_page"</span>: <span class="string">"options.html"</span>,</span><br><span class="line">  <span class="attr">"background"</span>: &#123;</span><br><span class="line">    <span class="attr">"scripts"</span>: [<span class="string">"background.js"</span>],</span><br><span class="line">    <span class="attr">"persistent"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"content_scripts"</span>: [],</span><br><span class="line">  <span class="attr">"page_action"</span>: &#123;</span><br><span class="line">    <span class="attr">"default_popup"</span>: <span class="string">"popup.html"</span>,</span><br><span class="line">    <span class="attr">"default_icon"</span>: &#123;</span><br><span class="line">      <span class="attr">"16"</span>: <span class="string">"images/get_started16.png"</span>,</span><br><span class="line">      <span class="attr">"32"</span>: <span class="string">"images/get_started32.png"</span>,</span><br><span class="line">      <span class="attr">"48"</span>: <span class="string">"images/get_started48.png"</span>,</span><br><span class="line">      <span class="attr">"128"</span>: <span class="string">"images/get_started128.png"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"icons"</span>: &#123;</span><br><span class="line">    <span class="attr">"16"</span>: <span class="string">"images/get_started16.png"</span>,</span><br><span class="line">    <span class="attr">"32"</span>: <span class="string">"images/get_started32.png"</span>,</span><br><span class="line">    <span class="attr">"48"</span>: <span class="string">"images/get_started48.png"</span>,</span><br><span class="line">    <span class="attr">"128"</span>: <span class="string">"images/get_started128.png"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Content-Script"><a href="#Content-Script" class="headerlink" title="Content Script"></a>Content Script</h4><p><strong>Content script</strong> 是你扩展的一部分，运行于一个特定的网页环境（而<strong>并不是后台脚本</strong>，后台脚本是扩展的一部分，也不是该网页利用<code>&lt;script&gt;</code>加载的一个脚本，<code>&lt;script&gt;</code> 加载的脚本是网页的一部分）。</p>
<p><strong>后台脚本可以访问所有WebExtension JavaScript APIS，但是他们不能直接访问网页的内容</strong>，所以如果你需要Content Scripts来做到这点。</p>
<p>就像通常的网页加载的脚本一样，<strong>Content Scripts 可以使用standard DOM APIS 读取和修改页面内容</strong>。</p>
<p>Content Script 只能访问WebExtension APIS 的一个小的子集，但是它们可以使用通信系统与后台脚本进行通信，从而间接的访问WebExtension APIS。</p>
<h5 id="DOM访问"><a href="#DOM访问" class="headerlink" title="DOM访问"></a>DOM访问</h5><p>Content scripts 可以访问和修改页面的DOM，就像普通的页面脚本一样。他们也可以察觉页面脚本对页面做出的任何修改。</p>
<p>不过，content scripts 得到的是一个“<strong>干净的DOM视图</strong>”，这意味着：</p>
<ul>
<li>content scripts 不能看见页面脚本定义的javascript 变量。</li>
<li>如果一个页面脚本重定义了一个DOM内置属性，content scripts将获取到这个属性的原始版本，而不是重定义版本。</li>
</ul>
<p>在 Gecko, 这种行为被称为<strong>射线视觉(Xray)</strong>。</p>
<p>举个例子，考虑一个网页如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"content-type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"page-scripts/page-script.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>脚本文件“page-script.js”如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// page-script.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// add a new element to the DOM</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.createElement(<span class="string">"p"</span>);</span><br><span class="line">p.textContent = <span class="string">"This paragraph was added by a page script."</span>;</span><br><span class="line">p.setAttribute(<span class="string">"id"</span>, <span class="string">"page-script-para"</span>);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(p);</span><br><span class="line"></span><br><span class="line"><span class="comment">// define a new property on the window</span></span><br><span class="line"><span class="built_in">window</span>.foo = <span class="string">"This global variable was added by a page script"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// redefine the built-in window.confirm() function</span></span><br><span class="line"><span class="built_in">window</span>.confirm = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">"The page script has also redefined 'confirm'"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在一个扩展插入一个content script 如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content-script.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// can access and modify the DOM</span></span><br><span class="line"><span class="keyword">var</span> pageScriptPara = <span class="built_in">document</span>.getElementById(<span class="string">"page-script-para"</span>);</span><br><span class="line">pageScriptPara.style.backgroundColor = <span class="string">"blue"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// can't see page-script-added properties</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">window</span>.foo);  <span class="comment">// undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sees the original form of redefined properties</span></span><br><span class="line"><span class="built_in">window</span>.confirm(<span class="string">"Are you sure?"</span>); <span class="comment">// calls the original window.confirm()</span></span><br></pre></td></tr></table></figure>
<p>相反的情况也是成立的：<strong>页面脚本不能察觉到通过content scripts 添加的JavaScript 属性</strong>。</p>
<p>这意味着content script 可以<strong>依靠DOM属性获取可预期的行为</strong></p>
<p>这种行为造成的一个结果是content script<strong>不能获取任何通过页面加载的Javascript 库</strong>。所以，如果这个页面包含JQuery，content script 将不会在意它。</p>
<p>如果一个content script 想要使用Javascript库，这个库本身就必须像一个content script一样在这个content script旁被插入:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"content_scripts": [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"matches"</span>: [<span class="string">"*://*.mozilla.org/*"</span>],</span><br><span class="line">    <span class="attr">"js"</span>: [<span class="string">"jquery.js"</span>, <span class="string">"content-script.js"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h5 id="WebExtensions-APIs"><a href="#WebExtensions-APIs" class="headerlink" title="WebExtensions APIs"></a>WebExtensions APIs</h5><p>除了standard DOM APIS，content script还能使用以下WebExtension APIS:</p>
<p>From <code>extension</code>:</p>
<ul>
<li><code>getURL()</code></li>
<li><code>inIncognitoContext</code></li>
</ul>
<p>From <code>runtime</code>:</p>
<ul>
<li><code>connect()</code></li>
<li><code>getManifest()</code></li>
<li><code>getURL()</code></li>
<li><code>onConnect</code></li>
<li><code>onMessage</code></li>
<li><code>sendMessage()</code></li>
</ul>
<p>From <code>i18n</code>:</p>
<ul>
<li><code>getMessage()</code></li>
<li><code>getAcceptLanguages()</code></li>
<li><code>getUILanguage()</code></li>
<li><code>detectLanguage()</code></li>
</ul>
<p>所有 <code>storage</code>.</p>
<p>参考链接：</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/Xray_vision" rel="external nofollow noopener noreferrer" target="_blank">https://developer.mozilla.org/en-US/docs/Mozilla/Tech/Xray_vision</a></p>
<p><a href="https://stackoverflow.com/questions/10824697/why-is-window-and-unsafewindow-not-the-same-from-a-userscript-as-from-a-scrip" rel="external nofollow noopener noreferrer" target="_blank">https://stackoverflow.com/questions/10824697/why-is-window-and-unsafewindow-not-the-same-from-a-userscript-as-from-a-scrip</a></p>
<p><a href="https://developer.chrome.com/extensions/content_scripts#execution-environment" rel="external nofollow noopener noreferrer" target="_blank">https://developer.chrome.com/extensions/content_scripts#execution-environment</a></p>
<p><a href="https://developer.chrome.com/extensions" rel="external nofollow noopener noreferrer" target="_blank">https://developer.chrome.com/extensions</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Content_scripts" rel="external nofollow noopener noreferrer" target="_blank">https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions/Content_scripts</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM" rel="external nofollow noopener noreferrer" target="_blank">https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_shadow_DOM</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Ray Sun
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://sunra.top/2020/07/31/tamper-monkey-security/" title="TamperMonkey 对于内容的保护">https://sunra.top/2020/07/31/tamper-monkey-security/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/07/24/blob/" rel="prev" title="Blob 与 大文件分片上传">
      <i class="fa fa-chevron-left"></i> Blob 与 大文件分片上传
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/14/es6-symbol/" rel="next" title="ES6 Symbol">
      ES6 Symbol <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#独立的运行环境"><span class="nav-number">1.</span> <span class="nav-text">独立的运行环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#闭包"><span class="nav-number">2.</span> <span class="nav-text">闭包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结论"><span class="nav-number">3.</span> <span class="nav-text">结论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拓展"><span class="nav-number">4.</span> <span class="nav-text">拓展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chrome-Xray"><span class="nav-number">4.1.</span> <span class="nav-text">Chrome Xray</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#禁止Xray"><span class="nav-number">4.1.1.</span> <span class="nav-text">禁止Xray</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Xray-For-DOM"><span class="nav-number">4.1.2.</span> <span class="nav-text">Xray For DOM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Xray-For-JavaScript-Object"><span class="nav-number">4.1.3.</span> <span class="nav-text">Xray For JavaScript Object</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Extensions"><span class="nav-number">4.2.</span> <span class="nav-text">Extensions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Architecture"><span class="nav-number">4.2.1.</span> <span class="nav-text">Architecture</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Manifest"><span class="nav-number">4.2.2.</span> <span class="nav-text">Manifest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Content-Script"><span class="nav-number">4.2.3.</span> <span class="nav-text">Content Script</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#DOM访问"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">DOM访问</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WebExtensions-APIs"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">WebExtensions APIs</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg">
  <p class="site-author-name" itemprop="name">Ray Sun</p>
  <div class="site-description" itemprop="description">拨开互联网的迷雾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">258</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Sun668" title="GitHub → https://github.com/Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

      <div class="wechat_channel" style="width: 50%;margin-left: 25%;">
        <br>
        <!-- 这里添加你的二维码图片 -->
        <img src="/images/wechat_channel.png">
        <!-- <span>公众号</span> -->
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray Sun</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  

  

</body>
</html>
