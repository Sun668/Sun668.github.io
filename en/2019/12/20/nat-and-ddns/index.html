<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="When IPv4 addresses are not enough, we need to use NAT technology to reduce the consumption of public network IP, so that one local area network on the Internet can consume a public network IP, but th"><meta property="og:type" content="article"><meta property="og:title" content="NAT and Intranet Penetration"><meta property="og:url" content="https://sunra.top/en/2019/12/20/nat-and-ddns/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="When IPv4 addresses are not enough, we need to use NAT technology to reduce the consumption of public network IP, so that one local area network on the Internet can consume a public network IP, but th"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2019-12-20T12:48:47.000Z"><meta property="article:modified_time" content="2024-09-09T04:30:54.810Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/2019/12/20/nat-and-ddns/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2019/12/20/nat-and-ddns/","path":"2019/12/20/nat-and-ddns/","title":"NAT and Intranet Penetration"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>NAT and Intranet Penetration | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#what-is-nat"><span class="nav-number">1.</span> <span class="nav-text">What is NAT?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#why-do-you-need-nat"><span class="nav-number">1.1.</span> <span class="nav-text">Why do you need NAT?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#definition"><span class="nav-number">1.2.</span> <span class="nav-text">Definition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#principle-of-nat"><span class="nav-number">1.3.</span> <span class="nav-text">Principle of NAT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#three-nat-techniques"><span class="nav-number">1.4.</span> <span class="nav-text">Three NAT techniques</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#static-nat"><span class="nav-number">1.4.1.</span> <span class="nav-text">Static NAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dynamic-nat"><span class="nav-number">1.4.2.</span> <span class="nav-text">Dynamic NAT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#npat"><span class="nav-number">1.4.3.</span> <span class="nav-text">NPAT</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#intranet-penetration-technology"><span class="nav-number">2.</span> <span class="nav-text">Intranet penetration technology</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#disadvantages-of-nat"><span class="nav-number">2.1.</span> <span class="nav-text">Disadvantages of NAT</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nat-shortens-the-retention-time-of-ip-sessions"><span class="nav-number">2.1.1.</span> <span class="nav-text">NAT shortens the retention time of IP sessions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mechanism-that-relies-on-ip-for-host-tracking-failed"><span class="nav-number">2.1.2.</span> <span class="nav-text">Mechanism that relies on IP for host tracking failed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#breaking-the-ip-end-to-end-model"><span class="nav-number">2.1.3.</span> <span class="nav-text">Breaking the IP end-to-end model</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#principle-of-intranet-penetration"><span class="nav-number">2.2.</span> <span class="nav-text">Principle of Intranet Penetration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example"><span class="nav-number">2.3.</span> <span class="nav-text">Example</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2019/12/20/nat-and-ddns/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="NAT and Intranet Penetration | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> NAT and Intranet Penetration</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-12-20 20:48:47" itemprop="dateCreated datePublished" datetime="2019-12-20T20:48:47+08:00">2019-12-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-09-09 12:30:54" itemprop="dateModified" datetime="2024-09-09T12:30:54+08:00">2024-09-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2019/12/20/nat-and-ddns/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2019/12/20/nat-and-ddns/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>When IPv4 addresses are not enough, we need to use NAT technology to reduce the consumption of public network IP, so that one local area network on the Internet can consume a public network IP, but the IP address of the device in the local area network is the intranet IP address, which is meaningless for the public network.</p><p>So if we develop an application on our own machine and hope that others can access it, what do we need to do?</p><span id="more"></span><p>If we have a static public IP, it is very simple, just need to do a Port Mapping can be, the public network IP + Port Mapping to our intranet IP + port, but this generally requires our router can set Port Mapping and have a public network IP.</p><p>If we have a dynamic public IP, we need to add DDNS (dynamic domain name resolution) on the basis of Port Mapping, which is to first obtain a domain name, and the intranet machine sends requests to the DDNS server every once in a while., the mapping relationship between its own intranet IP and domain name is constantly refreshed to the DDNS server.</p><p>If your machine is hidden under multiple routers or the NAT type is NAPT, then intranet penetration technology is required.</p><h2 id="what-is-nat"><a class="markdownIt-Anchor" href="#what-is-nat"></a> What is NAT?</h2><h3 id="why-do-you-need-nat"><a class="markdownIt-Anchor" href="#why-do-you-need-nat"></a> Why do you need NAT?</h3><p>Because IPv4 addresses are not enough, we can use NAT to map internal IP addresses in the local area network to public IP addresses.</p><h3 id="definition"><a class="markdownIt-Anchor" href="#definition"></a> Definition</h3><p>The NAT name is accurate, network address translation, which is to replace the address information of the IP message network packet header. NAT is usually deployed at an organization’s network exit location, providing public network accessibility and upper layer protocol connectivity by replacing the internal network IP Address with the exit IP Address. So, what is an internal network IP address?</p><p>RFC 1918 specifies three reserved address paragraphs: 10.0.0.0 - 10.255.255.255; 172.16.0.0 - 172.31.255.255; 192.168.0.0 - 192.168.255.255. These three ranges are in the address segments of classes A, B, and C, respectively. They are not assigned to specific users and are reserved by IANA as private addresses. These addresses can be used within any organization or enterprise. The difference between these and other Internet addresses is that they can only be used internally and cannot be used as global routing addresses. This means that outside the administrative scope of the organization, these addresses no longer make sense, either as source or destination addresses. For a closed organization, if its network is not connected to the Internet, these addresses can be used without submitting a request to IANA, and the internal routing management and messaging network packet delivery methods are no different from other networks.</p><p>For networks that have Internet access requirements and internally use private addresses, it is necessary to deploy NAT Gateway at the egress location of the organization. When the message network packet leaves the private network and enters the Internet, the source IP is replaced by the public network address, usually the interface of the egress device. address. After an external access request reaches the target, it is initiated by the egress device of the organization, so the requested server level can send the response back to the egress gateway from the Internet. The egress gateway then replaces the destination address with the source host address of the private network and sends it back internally. Such a request and response from the private network host to the public network server is completed without awareness on both ends of the communication. According to this model, a large number of intranet hosts no longer need public IP addresses.</p><h3 id="principle-of-nat"><a class="markdownIt-Anchor" href="#principle-of-nat"></a> Principle of NAT</h3><ol><li>The network is divided into two parts: the private network and the public network. The NAT Gateway is set at the routing exit position from the private network to the public network. Bidirectional traffic must go through the NAT Gateway;</li><li>** Network access can only be initiated by the private network side first, and the public network cannot actively access the private network host; **</li><li>NAT Gateway completes the conversion or translation of two addresses in two access directions, the source information is replaced in the outgoing direction, and the destination information is replaced in the incoming direction;</li><li>The existence of NAT Gateway is transparent to both parties;</li><li>In order to realize the function of two-way translation, NAT Gateway needs to maintain an association table to save the information of the conversation.</li></ol><h3 id="three-nat-techniques"><a class="markdownIt-Anchor" href="#three-nat-techniques"></a> Three NAT techniques</h3><h4 id="static-nat"><a class="markdownIt-Anchor" href="#static-nat"></a> Static NAT</h4><p>Static NAT is one-to-one mapping. How many private addresses need to communicate with the outside, how many extranet IP Addresses need to be configured to correspond to it, and it does not save extranet IP, so it is generally not necessary</p><h4 id="dynamic-nat"><a class="markdownIt-Anchor" href="#dynamic-nat"></a> Dynamic NAT</h4><p>Dynamic NAT is to configure an extranet IP Address pool on the router. When an internal computer needs to communicate with the outside world, an extranet IP is dynamically removed from the address pool and their correspondence is bound to the NAT table. After the communication is completed, this extranet IP is released and can be used for other internal IP Address conversions. This DHCP lease IP has similarities.</p><h4 id="npat"><a class="markdownIt-Anchor" href="#npat"></a> NPAT</h4><p>This is the most commonly used NAT technology, and it is also one of the most important reasons why IPv4 can be maintained today. It provides a many-to-one way. For multiple intranet IP Addresses, boundary routing can assign them an extranet IP., using different ports of this extranet IP to communicate with the outside world.</p><h2 id="intranet-penetration-technology"><a class="markdownIt-Anchor" href="#intranet-penetration-technology"></a> Intranet penetration technology</h2><h3 id="disadvantages-of-nat"><a class="markdownIt-Anchor" href="#disadvantages-of-nat"></a> Disadvantages of NAT</h3><h4 id="nat-shortens-the-retention-time-of-ip-sessions"><a class="markdownIt-Anchor" href="#nat-shortens-the-retention-time-of-ip-sessions"></a> NAT shortens the retention time of IP sessions</h4><p>Because an association table will be established on the NAT device after a session is established, the NAT Gateway will perform aging operations during the period of silence of the session. This is something that any NAT Gateway must do, because IP and port resources are limited and communication needs are unlimited, so resources must be recovered after the session ends. Usually TCP sessions actively close the connection through negotiation, and NAT Gateways can track these message network packets, but there are always exceptions and rely on their own timers to recover resources. The UDP-based Communication Protocol is difficult to determine when the communication ends, so the NAT Gateway mainly relies on the timeout mechanism to reclaim the external port. Recycling through timer aging will bring a problem. If the application needs to maintain the connection for longer than the NAT Gateway setting, the communication will be interrupted unexpectedly. Because after the gateway recovers the relevant conversion table resources, the relevant conversion information cannot be found when the new data arrives, and a new connection must be established. When this new data is sent from the public network side to the private network side, it will occur that the new connection establishment cannot be triggered, nor can the host on the private network side be notified to rebuild the connection. At this time, the communication will be interrupted and cannot be automatically restored. Even if new data is sent from the private network side to the public network side, because the reconstructed session table often uses a different public IP and port address than before, the public network side host cannot correspond to the previous communication, resulting in a user-perceptible connection interruption. It is quite difficult for NAT Gateway to set the time to recover idle connections so that no continuous resource loss occurs, and to maintain most connections without accidental interruption. In the era when NAT has become popular, many application protocol designers have taken this situation into account, so a connection keep-alive mechanism is generally set, that is, when there is no data to be sent for a period of time, a keep-alive message that NAT can perceive without actual data is sent. The main purpose of this is to reset the NAT session timer.</p><h4 id="mechanism-that-relies-on-ip-for-host-tracking-failed"><a class="markdownIt-Anchor" href="#mechanism-that-relies-on-ip-for-host-tracking-failed"></a> Mechanism that relies on IP for host tracking failed</h4><p>NAT is implemented by multiplexing connections issued by multiple internal hosts onto a single IP, which invalidates mechanisms that rely on IP for host tracking. For example, applications based on network traffic analysis required in network management cannot track the specific behavior of end users and traffic. Log analysis based on user behavior also becomes difficult because an IP is shared by many users, and if there is malicious user behavior, it is difficult to locate the host that initiated the connection. Even though there are mechanisms that provide a way to track connections on NAT Gateways, it is difficult to continue this transformation relationship. IP-based user authorization is no longer reliable, because owning an IP is not equal to a user or host. A server cannot simply regard access from the same IP as initiated by the same host and cannot be associated. Some servers have connection restrictions and only accept limited access from one IP at a time (sometimes only one access), which will cause service preemption and queuing between different users. Sometimes the server side does this for DOS attack protection considerations, because a user should not make a large number of connection requests under normal circumstances, and excessive use of service resources is understood as an attack. But this cannot be simply judged by the number of connections when NAT exists. In short, because NAT hides one end of the communication, it complicates simple things.</p><h4 id="breaking-the-ip-end-to-end-model"><a class="markdownIt-Anchor" href="#breaking-the-ip-end-to-end-model"></a> Breaking the IP end-to-end model</h4><p>NAT transforms the address of the communication by modifying the information in the IP header. But in this conversion process, it can only be based on one session unit. When an application needs to maintain multiple bidirectional connections, it is very troublesome. NAT cannot understand the correlation between multiple sessions and cannot guarantee that the conversion meets the rules needed by the application. When NAT Gateway has multiple public IP addresses, a set of associated sessions may be assigned to different public network addresses, which is usually unacceptable to the server side. More seriously, when the host on the public network side wants to actively send data to the private network side, the NAT Gateway does not convert the association table required for this connection, and this data packet cannot reach the host on the private network side. These connections that send data in the opposite direction always have the agreement of the application protocol or have been negotiated in the initially established session. However, because NAT works at the network layer and transport layer, it cannot understand the behavior of the application layer protocol and is ignorant of this information.</p><p>The working mechanism of NAT relies on modifying the information in the IP header, which can hinder the work of some security protocols. Because NAT tampered with the IP Address, Transport Layer Port Number, and Checksum, this can cause the authentication protocol to completely fail to work, because the purpose of authentication is to ensure that this information does not change during transmission. For some tunneling protocols, the presence of NAT also causes additional problems, because tunneling protocols usually identify tunnel entities with outer addresses, and tunnels passing through NAT will have IP to reuse relationships, which need to be handled carefully at the other end. ICMP is a network control protocol, its working principle is to transfer error and control messages between two hosts, because the IP correspondence is remapped, ICMP also to reuse and to reuse processing, in many cases because ICMP message network packet load can not provide enough information, the solution to reuse will fail. The IP sharding mechanism is that when the size of the IP message network packet to be sent is larger than the maximum size that the path can actually carry on the information source or network path, the IP protocol layer divides a message network packet into multiple fragments to send, and then reorganizes them at the receiving end. These fragments restore the original message network packet. A sharding mechanism such as IP will cause the information of the transport layer to be only included in the first fragment, and it is difficult for NAT to identify the correspondence between subsequent sharding and the association table, so special treatment is required.</p><h3 id="principle-of-intranet-penetration"><a class="markdownIt-Anchor" href="#principle-of-intranet-penetration"></a> Principle of Intranet Penetration</h3><p>Intranet penetration, also known as NAT (Network Address Translation) penetration. For nodes after NAT, it is not that they cannot actively access the public network port, but that they cannot in turn be effectively accessed by the public network. The main idea of intranet penetration is to take advantage of this, so that nodes after NAT actively access a server with a public IP address, and bridge the intermediate server to open the tunnel from other hosts to nodes behind NAT.</p><p>In addition to accessing nodes hidden behind NAT, this technology can also penetrate firewalls. Since the firewall only intercepts inbound and not outbound, the server within the firewall can actively connect to a public network server to open a tunnel, and ultimately link to other local ports through the tunnel.</p><ul><li><p>Step 1: Open the tunnel<br> For security reasons, unless the host actively sends a connection request to the other party (at this time, a record will be left in the data structure of the host), otherwise, when the host receives a data packet, if it cannot be queried in its data structure The corresponding record, those uninvited data packets will be discarded. Therefore, two hosts located in different LANs, even if they know the IP address and Port Number of the other party, send the data packet “wishfully”, the other party will not receive it, so we first need to open the tunnel. Suppose the public IP is X.X.X.X and the intranet IP is 192.168.1.2. The public network host first listens on port 80, which is used to provide an HTTP service to the outside world, and 80 is the default port of the WEB server. At the same time, any other port (here we assume 7777), listening to this port is used to allow the intranet server to actively connect to open a tunnel. Then the intranet actively initiates a request to the 7777 of the public network host, so that the intranet successfully establishes a connection channel with the public network host. Then, when any client actively connects to port 80 of the public network, the public network forwards the connection request to the intranet host through the previously established tunnel immediately after receiving the connection request.</p></li><li><p>Step 2: Port forwarding (public host port 80, forward to intranet port 80)<br> When any client actively connects to port 80 of the public network, the public network immediately forwards the connection request to the intranet host through the previously established tunnel after receiving the data packet from the tunnel, and then actively connects to the intranet host. The intranet host’s own port 80 forwards the data packet to port 80 intact after the connection is successful.</p></li><li><p>Step 3: Forward the response message network packet in the same way<br> After the intranet host receives the data packet from the tunnel, it actively connects to the intranet host’s own port 80. After the connection is successful, the data packet is forwarded unchanged to port 80. After the HTTP server program finishes processing the data packet, it is generated. After the response message network packet is forwarded back the original way, it finally reaches port 80 of the public network, and then returns to the Client who initially requested port 80 of the public network server.</p></li></ul><p>In general, intranet penetration technology can be applied to all machines that can connect to the public network, providing a universal way to open the intranet.</p><h3 id="example"><a class="markdownIt-Anchor" href="#example"></a> Example</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gist.github.com/WangYihang/e7d36b744557e4673d2157499f6c6b5e">python端口转发</a></p><p>Reference article:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/62028875d53e">https://www.jianshu.com/p/62028875d53e</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.52im.net/article-64-1.html">http://www.52im.net/article-64-1.html</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/deng_xj/article/details/88922690">https://blog.csdn.net/deng_xj/article/details/88922690</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2019/12/20/nat-and-ddns/" title="NAT and Intranet Penetration">https://sunra.top/en/2019/12/20/nat-and-ddns/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2019/12/13/js-arrow-function-context/" rel="prev" title="JavaScript arrow function exploration"><i class="fa fa-chevron-left"></i> JavaScript arrow function exploration</a></div><div class="post-nav-item"> <a href="/en/2019/12/27/three_cache_issues/" rel="next" title="Three Problems with Caching Systems">Three Problems with Caching Systems<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2019/12/20/nat-and-ddns/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>