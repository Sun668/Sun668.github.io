<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="上一篇博客我们介绍了Qiankun的沙盒机制，也就是不同的子应用之间是如何做环境隔离的，这篇博客我们就基于上一篇博客讲一下如何利用沙盒去进行子应用的加载和切换。 Qiankun is based on single-spa implementation, all internal use of part of the single-spa interface, a brief introducti"><meta property="og:type" content="article"><meta property="og:title" content="micro frontend framework Qiankun source code analysis"><meta property="og:url" content="https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="上一篇博客我们介绍了Qiankun的沙盒机制，也就是不同的子应用之间是如何做环境隔离的，这篇博客我们就基于上一篇博客讲一下如何利用沙盒去进行子应用的加载和切换。 Qiankun is based on single-spa implementation, all internal use of part of the single-spa interface, a brief introducti"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-11-24T08:17:34.000Z"><meta property="article:modified_time" content="2024-01-14T08:05:48.534Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/","path":"2022/11/24/micro-frontend-qiankun-code/","title":"micro frontend framework Qiankun source code analysis"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>micro frontend framework Qiankun source code analysis | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#globalState"><span class="nav-number">1.</span> <span class="nav-text">globalState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#prefetch"><span class="nav-number">2.</span> <span class="nav-text">prefetch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loader"><span class="nav-number">3.</span> <span class="nav-text">loader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Loader-internal-tool-function"><span class="nav-number">3.1.</span> <span class="nav-text">Loader internal tool function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createElement"><span class="nav-number">3.2.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getAppWrapperGetter"><span class="nav-number">3.3.</span> <span class="nav-text">getAppWrapperGetter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getRender"><span class="nav-number">3.4.</span> <span class="nav-text">getRender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loadAPP"><span class="nav-number">3.5.</span> <span class="nav-text">loadAPP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Instrumental-approach"><span class="nav-number">4.</span> <span class="nav-text">Instrumental approach</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#error"><span class="nav-number">4.1.</span> <span class="nav-text">error</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#errorHandler"><span class="nav-number">4.2.</span> <span class="nav-text">errorHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#utils"><span class="nav-number">4.3.</span> <span class="nav-text">utils</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Qiankun"><span class="nav-number">5.</span> <span class="nav-text">Qiankun</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tools-to-introduce"><span class="nav-number">5.1.</span> <span class="nav-text">Tools to introduce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#registerMicroApps"><span class="nav-number">5.2.</span> <span class="nav-text">registerMicroApps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loadMicroApp"><span class="nav-number">5.3.</span> <span class="nav-text">loadMicroApp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#start"><span class="nav-number">5.4.</span> <span class="nav-text">start</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">6.</span> <span class="nav-text">Summary</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="micro frontend framework Qiankun source code analysis | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> micro frontend framework Qiankun source code analysis</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-11-24 16:17:34" itemprop="dateCreated datePublished" datetime="2022-11-24T16:17:34+08:00">2022-11-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-01-14 16:05:48" itemprop="dateModified" datetime="2024-01-14T16:05:48+08:00">2024-01-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2022/11/24/micro-frontend-qiankun-code/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2022/11/24/micro-frontend-qiankun-code/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p><a href="https://sunra.top/posts/61809/">上一篇博客</a>我们介绍了Qiankun的沙盒机制，也就是不同的子应用之间是如何做环境隔离的，这篇博客我们就基于上一篇博客讲一下如何利用沙盒去进行子应用的加载和切换。</p><p>Qiankun is based on single-spa implementation, all internal use of part of the single-spa interface, a brief introduction to the difference between single-spa and qiankun, single-spa only do sub-application registration, switching, routing monitoring, etc., has not yet reached a commercial level, and qiankun on top of this js and css sandbox isolation, according to the official doc, qiankun is to meet the commercial requirements.</p><span id="more"></span><h2 id="globalState"><a href="#globalState" class="headerlink" title="globalState"></a>globalState</h2><p>I will add my own comments to the following code, but there are two points to note:</p><ul><li>This global state, i.e. globalState, is unique, meaning that all child applications use the same global state object</li><li>But each sub-application can register its own callback function for the change of global state, and store it in the deps array with appInstanceId as the key. Although all deps will be triggered when the state changes, using appInstanceId as the key can be used in the sub-application. When destroyed, the callback function of the application is correctly cancelled.</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">dbkillerf6</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-04-10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; cloneDeep &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">OnGlobalStateChangeCallback</span>, <span class="title class_">MicroAppStateActions</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Global state, shared by all sub-applications</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">globalState</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Callback function when the state changes, key is the id of the app, value is the callback function</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">deps</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">OnGlobalStateChangeCallback</span>&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Trigger global listening, traverse all deps and trigger one by one</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">emitGlobal</span>(<span class="params">state: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;, prevState: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;</span>) &#123;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(deps).<span class="title function_">forEach</span>(<span class="function">(<span class="params">id: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (deps[id] <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">      deps[id](<span class="title function_">cloneDeep</span>(state), <span class="title function_">cloneDeep</span>(prevState));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Expose</span> an <span class="keyword">interface</span> that provides a means to modify global state independent of sub-applications</span><br><span class="line">export function initGlobalState(state: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[qiankun] globalState tools will be removed in 3.0, pls don&#x27;t use it!`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (state = globalState) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;[qiankun] state has not changed！&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prevGlobalState = <span class="title function_">cloneDeep</span>(globalState);</span><br><span class="line">    globalState = <span class="title function_">cloneDeep</span>(state);</span><br><span class="line">    emitGlobal (globalState, prevGlobalState);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getMicroAppStateActions</span>(<span class="string">`global-<span class="subst">$&#123;+<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;</span>`</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getMicroAppStateActions</span>(<span class="params">id: <span class="built_in">string</span>, isMaster?: <span class="built_in">boolean</span></span>): <span class="title class_">MicroAppStateActions</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * onGlobalStateChange global dependency listening</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     Dependencies that need to be triggered when collecting setState</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Restriction: Each sub-application has only one active global listener, the new listener overwrites the old listener, if only part of the listener properties, please use onGlobalStateChange</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     This design is to reduce memory explosion caused by global monitoring abuse</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     The dependent data structure is:</span></span><br><span class="line"><span class="comment">     * &#123;</span></span><br><span class="line"><span class="comment">     *   &#123;id&#125;: callback</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">callback</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">fireImmediately</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">onGlobalStateChange</span>(<span class="params">callback: OnGlobalStateChangeCallback, fireImmediately?: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(callback <span class="keyword">instanceof</span> <span class="title class_">Function</span>)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;[qiankun] callback must be function!&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (deps[id]) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[qiankun] &#x27;<span class="subst">$&#123;id&#125;</span>&#x27; global listener already exists before this, new listener will overwrite it.`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      deps[id] = callback;</span><br><span class="line">      <span class="keyword">if</span> (fireImmediately) &#123;</span><br><span class="line">        <span class="keyword">const</span> cloneState = <span class="title function_">cloneDeep</span>(globalState);</span><br><span class="line">        <span class="title function_">callback</span>(cloneState, cloneState);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * setGlobalState Update stored data</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1. Verify the first-level properties of the input state. Only the first-level (bucket) properties declared during initialization will be changed</span></span><br><span class="line"><span class="comment">     * 2. Modify the store and trigger global listening</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">state</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">setGlobalState</span>(<span class="params">state: Record&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt; = &#123;&#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (state = globalState) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;[qiankun] state has not changed！&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">changeKeys</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line">      <span class="keyword">const</span> prevGlobalState = <span class="title function_">cloneDeep</span>(globalState);</span><br><span class="line">      globalState = <span class="title function_">cloneDeep</span>(</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">keys</span>(state).<span class="title function_">reduce</span>(<span class="function">(<span class="params">_globalState, changeKey</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (isMaster || _globalState.<span class="title function_">hasOwnProperty</span>(changeKey)) &#123;</span><br><span class="line">            changeKeys.<span class="title function_">push</span>(changeKey);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(_globalState, &#123; [changeKey]: state[changeKey] &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[qiankun] &#x27;<span class="subst">$&#123;changeKey&#125;</span>&#x27; not declared when init state！`</span>);</span><br><span class="line">          <span class="keyword">return</span> _globalState;</span><br><span class="line">        &#125;, globalState),</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (changeKeys.<span class="property">length</span> = <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;[qiankun] state has not changed！&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      emitGlobal (globalState, prevGlobalState);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Log off the dependencies under this app</span></span><br><span class="line">    <span class="title function_">offGlobalStateChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> deps[id];</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="prefetch"><a href="#prefetch" class="headerlink" title="prefetch"></a>prefetch</h2><p>This is mainly to provide strategies and methods for preloading sub-applications</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">Kuitos</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-02-26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Entry</span>, <span class="title class_">ImportEntryOpts</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;import-html-entry&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; importEntry &#125; <span class="keyword">from</span> <span class="string">&#x27;import-html-entry&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; isFunction &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAppStatus, getMountedApps, <span class="variable constant_">NOT_LOADED</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;single-spa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AppMetadata</span>, <span class="title class_">PrefetchStrategy</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">global</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">NetworkInformation</span> &#123;</span><br><span class="line">    <span class="attr">saveData</span>: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="attr">effectiveType</span>: <span class="built_in">string</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//downgrade to setTimeout if the browser does not support requestIdleCallback</span></span><br><span class="line"><span class="comment">// RIC and shim for browsers setTimeout() without it</span></span><br><span class="line"><span class="keyword">const</span> requestIdleCallback =</span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">requestIdleCallback</span> ||</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">requestIdleCallback</span>(<span class="params">cb: CallableFunction</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">cb</span>(&#123;</span><br><span class="line">        <span class="attr">didTimeout</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="title function_">timeRemaining</span>(<span class="params"></span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="number">50</span> - (<span class="title class_">Date</span>.<span class="title function_">now</span>() - start));</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;, <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">global</span> &#123;</span><br><span class="line">  <span class="keyword">interface</span> <span class="title class_">Navigator</span> &#123;</span><br><span class="line">    <span class="attr">connection</span>: &#123;</span><br><span class="line">      <span class="attr">saveData</span>: <span class="built_in">boolean</span>;</span><br><span class="line">      <span class="attr">effectiveType</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;bluetooth&#x27;</span> | <span class="string">&#x27;cellular&#x27;</span> | <span class="string">&#x27;ethernet&#x27;</span> | <span class="string">&#x27;none&#x27;</span> | <span class="string">&#x27;wifi&#x27;</span> | <span class="string">&#x27;wimax&#x27;</span> | <span class="string">&#x27;other&#x27;</span> | <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isSlowNetwork = navigator.<span class="property">connection</span></span><br><span class="line">  ? navigator.<span class="property">connection</span>.<span class="property">saveData</span> ||</span><br><span class="line">    (navigator.<span class="property">connection</span>.<span class="property">type</span> ! <span class="string">&#x27;wifi&#x27;</span> &amp;&amp;</span><br><span class="line">      navigator.<span class="property">connection</span>.<span class="property">type</span> ! <span class="string">&#x27;ethernet&#x27;</span> &amp;&amp;</span><br><span class="line">      <span class="regexp">/([23])g/</span>.<span class="title function_">test</span>(navigator.<span class="property">connection</span>.<span class="property">effectiveType</span>))</span><br><span class="line">  : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * prefetch assets, do nothing while in mobile network</span></span><br><span class="line"><span class="comment"> Load the specified sub-application through the specified entry.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">entry</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">opts</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prefetch</span>(<span class="params">entry: Entry, opts?: ImportEntryOpts</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!navigator.<span class="property">onLine</span> || isSlowNetwork) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t prefetch if in a slow network or offline</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Call the importEntry interface of single-spa to load the sub-application entry, return the function to load js and css, and then use the requestIdleCallback function to load at idle</span></span><br><span class="line">  <span class="title function_">requestIdleCallback</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; getExternalScripts, getExternalStyleSheets &#125; = <span class="keyword">await</span> importEntry(entry, opts);</span><br><span class="line">    <span class="title function_">requestIdleCallback</span>(getExternalStyleSheets);</span><br><span class="line">    <span class="title function_">requestIdleCallback</span>(getExternalScripts);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//When the single-spa first-mount event is triggered, query all apps that have not yet been loaded, and then preload</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">prefetchAfterFirstMounted</span>(<span class="params">apps: AppMetadata[], opts?: ImportEntryOpts</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;single-spa:first-mount&#x27;</span>, <span class="keyword">function</span> <span class="title function_">listener</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> notLoadedApps = apps.<span class="title function_">filter</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> <span class="title function_">getAppStatus</span>(app.<span class="property">name</span>) = <span class="variable constant_">NOT_LOADED</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> mountedApps = <span class="title function_">getMountedApps</span>();</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[qiankun] prefetch starting after <span class="subst">$&#123;mountedApps&#125;</span> mounted...`</span>, notLoadedApps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notLoadedApps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; entry &#125;</span>) =&gt;</span> <span class="title function_">prefetch</span>(entry, opts));</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;single-spa:first-mount&#x27;</span>, listener);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Perform preload immediately and do not filter already loaded ones from apps</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">prefetchImmediately</span>(<span class="params">apps: AppMetadata[], opts?: ImportEntryOpts</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[qiankun] prefetch starting for apps...&#x27;</span>, apps);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  apps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">&#123; entry &#125;</span>) =&gt;</span> <span class="title function_">prefetch</span>(entry, opts));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Select the appropriate preload policy according to the policy configuration of parameter repassing</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">doPrefetchStrategy</span>(<span class="params"></span></span><br><span class="line"><span class="params">  apps: AppMetadata[],</span></span><br><span class="line"><span class="params">  prefetchStrategy: PrefetchStrategy,</span></span><br><span class="line"><span class="params">  importEntryOpts?: ImportEntryOpts,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> appsName2Apps = (<span class="attr">names</span>: <span class="built_in">string</span>[]): <span class="title class_">AppMetadata</span>[] =&gt; apps.<span class="title function_">filter</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> names.<span class="title function_">includes</span>(app.<span class="property">name</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(prefetchStrategy)) &#123;</span><br><span class="line">    <span class="title function_">prefetchAfterFirstMounted</span>(<span class="title function_">appsName2Apps</span>(prefetchStrategy <span class="keyword">as</span> <span class="built_in">string</span>[]), importEntryOpts);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(prefetchStrategy)) &#123;</span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// critical rendering apps would be prefetch as earlier as possible</span></span><br><span class="line">      <span class="keyword">const</span> &#123; criticalAppNames = [], minorAppsName = [] &#125; = <span class="keyword">await</span> <span class="title function_">prefetchStrategy</span>(apps);</span><br><span class="line">      <span class="title function_">prefetchImmediately</span>(<span class="title function_">appsName2Apps</span>(criticalAppNames), importEntryOpts);</span><br><span class="line">      <span class="title function_">prefetchAfterFirstMounted</span>(<span class="title function_">appsName2Apps</span>(minorAppsName), importEntryOpts);</span><br><span class="line">    &#125;)();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (prefetchStrategy) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">true</span>:</span><br><span class="line">        <span class="title function_">prefetchAfterFirstMounted</span>(apps, importEntryOpts);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;all&#x27;</span>:</span><br><span class="line">        <span class="title function_">prefetchImmediately</span>(apps, importEntryOpts);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h2><h3 id="Loader-internal-tool-function"><a href="#Loader-internal-tool-function" class="headerlink" title="Loader internal tool function"></a>Loader internal tool function</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">assertElementExist</span>(<span class="params">element: Element | <span class="literal">null</span> | <span class="literal">undefined</span>, msg?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!element) &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QiankunError</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QiankunError</span>(<span class="string">&#x27;element not existed!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> execHooksChain&lt;T <span class="keyword">extends</span> <span class="title class_">ObjectType</span>&gt;(</span><br><span class="line">  <span class="attr">hooks</span>: <span class="title class_">Array</span>&lt;<span class="title class_">LifeCycleFn</span>&lt;T&gt;&gt;,</span><br><span class="line">  <span class="attr">app</span>: <span class="title class_">LoadableApp</span>&lt;T&gt;,</span><br><span class="line">  <span class="variable language_">global</span> = <span class="variable language_">window</span>,</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (hooks.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> hooks.<span class="title function_">reduce</span>(<span class="function">(<span class="params">chain, hook</span>) =&gt;</span> chain.<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">hook</span>(app, <span class="variable language_">global</span>)), <span class="title class_">Promise</span>.<span class="title function_">resolve</span>());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> validateSingularMode&lt;T <span class="keyword">extends</span> <span class="title class_">ObjectType</span>&gt;(</span><br><span class="line">  <span class="attr">validate</span>: <span class="title class_">FrameworkConfiguration</span>[<span class="string">&#x27;singular&#x27;</span>],</span><br><span class="line">  <span class="attr">app</span>: <span class="title class_">LoadableApp</span>&lt;T&gt;,</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> validate = <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">validate</span>(app) : !!validate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> supportShadowDOM = !!<span class="variable language_">document</span>.<span class="property">head</span>.<span class="property">attachShadow</span> || !!(<span class="variable language_">document</span>.<span class="property">head</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">createShadowRoot</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getLifecyclesFromExports</span>(<span class="params"></span></span><br><span class="line"><span class="params">  scriptExports: LifeCycles&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="variable language_">global</span>: WindowProxy,</span></span><br><span class="line"><span class="params">  globalLatestSetProp?: PropertyKey | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">validateExportLifecycle</span>(scriptExports)) &#123;</span><br><span class="line">    <span class="keyword">return</span> scriptExports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fallback to sandbox latest set property if it had</span></span><br><span class="line">  <span class="keyword">if</span> (globalLatestSetProp) &#123;</span><br><span class="line">    <span class="keyword">const</span> lifecycles = (&lt;<span class="built_in">any</span>&gt;<span class="variable language_">global</span>)[globalLatestSetProp];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">validateExportLifecycle</span>(lifecycles)) &#123;</span><br><span class="line">      <span class="keyword">return</span> lifecycles;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`[qiankun] lifecycle not found from <span class="subst">$&#123;appName&#125;</span> entry exports, fallback to get from window[&#x27;<span class="subst">$&#123;appName&#125;</span>&#x27;]`</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// fallback to global variable who named with $&#123;appName&#125; while module exports not found</span></span><br><span class="line">  <span class="keyword">const</span> globalVariableExports = (<span class="variable language_">global</span> <span class="keyword">as</span> <span class="built_in">any</span>)[appName];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">validateExportLifecycle</span>(globalVariableExports)) &#123;</span><br><span class="line">    <span class="keyword">return</span> globalVariableExports;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QiankunError</span>(<span class="string">`You need to export lifecycle functions in <span class="subst">$&#123;appName&#125;</span> entry`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h3><p>Create a new element with a parameter list of:</p><ul><li>appContent: string type, need to pass in html text</li><li>strictStyleIsolation: Whether to use a separate shadow dom, if true, and the current browser supports shadow dom, then the content in appContent will be inside a shadow dom</li><li>scopedCSS: If true, all the css content in the html created this time will be prefixed. For details, see my other blog, how qiankun does css isolation</li><li>appInstanceId: string type, id of the sub-application</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appContent: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  strictStyleIsolation: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  appInstanceId: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">HTMLElement</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> containerElement = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  containerElement.<span class="property">innerHTML</span> = appContent;</span><br><span class="line">  <span class="comment">// appContent always wrapped with a singular div</span></span><br><span class="line">  <span class="keyword">const</span> appElement = containerElement.<span class="property">firstChild</span> <span class="keyword">as</span> <span class="title class_">HTMLElement</span>;</span><br><span class="line">  <span class="keyword">if</span> (strictStyleIsolation) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!supportShadowDOM) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!&#x27;</span>,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; innerHTML &#125; = appElement;</span><br><span class="line">      appElement.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">let</span> <span class="attr">shadow</span>: <span class="title class_">ShadowRoot</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (appElement.<span class="property">attachShadow</span>) &#123;</span><br><span class="line">        shadow = appElement.<span class="title function_">attachShadow</span>(&#123; <span class="attr">mode</span>: <span class="string">&#x27;open&#x27;</span> &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// createShadowRoot was proposed in initial spec, which has then been deprecated</span></span><br><span class="line">        shadow = (appElement <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">createShadowRoot</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      shadow.<span class="property">innerHTML</span> = innerHTML;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (scopedCSS) &#123;</span><br><span class="line">    <span class="keyword">const</span> attr = appElement.<span class="title function_">getAttribute</span>(css.<span class="property">QiankunCSSRewriteAttr</span>);</span><br><span class="line">    <span class="keyword">if</span> (!attr) &#123;</span><br><span class="line">      appElement.<span class="title function_">setAttribute</span>(css.<span class="property">QiankunCSSRewriteAttr</span>, appInstanceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> styleNodes = appElement.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;style&#x27;</span>) || [];</span><br><span class="line">    <span class="title function_">forEach</span>(styleNodes, <span class="function">(<span class="params">stylesheetElement: HTMLStyleElement</span>) =&gt;</span> &#123;</span><br><span class="line">      css.<span class="title function_">process</span>(appElement!, stylesheetElement, appInstanceId);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> appElement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getAppWrapperGetter"><a href="#getAppWrapperGetter" class="headerlink" title="getAppWrapperGetter"></a>getAppWrapperGetter</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getAppWrapperGetter</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appInstanceId: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  useLegacyRender: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  strictStyleIsolation: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  elementGetter: () =&gt; HTMLElement | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (useLegacyRender) &#123;</span><br><span class="line">      <span class="keyword">if</span> (strictStyleIsolation) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QiankunError</span>(<span class="string">&#x27;strictStyleIsolation can not be used with legacy render!&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (scopedCSS) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">QiankunError</span>(<span class="string">&#x27;experimentalStyleIsolation can not be used with legacy render!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> appWrapper = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="title function_">getWrapperId</span>(appInstanceId));</span><br><span class="line">      <span class="title function_">assertElementExist</span>(appWrapper, <span class="string">`Wrapper element for <span class="subst">$&#123;appInstanceId&#125;</span> is not existed!`</span>);</span><br><span class="line">      <span class="keyword">return</span> appWrapper!;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> element = <span class="title function_">elementGetter</span>();</span><br><span class="line">    <span class="title function_">assertElementExist</span>(element, <span class="string">`Wrapper element for <span class="subst">$&#123;appInstanceId&#125;</span> is not existed!`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strictStyleIsolation &amp;&amp; supportShadowDOM) &#123;</span><br><span class="line">      <span class="keyword">return</span> element!.<span class="property">shadowRoot</span>!;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> element!;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getRender"><a href="#getRender" class="headerlink" title="getRender"></a>getRender</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the render function</span></span><br><span class="line"><span class="comment"> * If the legacy render function is provide, used as it, otherwise we will insert the app element to target container by qiankun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">appInstanceId</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">appContent</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">legacyRender</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRender</span>(<span class="params">appInstanceId: <span class="built_in">string</span>, appContent: <span class="built_in">string</span>, legacyRender?: HTMLContentRender</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">render</span>: <span class="title class_">ElementRender</span> = <span class="function">(<span class="params">&#123; element, loading, container &#125;, phase</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (legacyRender) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">          <span class="string">&#x27;[qiankun] Custom rendering function is deprecated and will be removed in 3.0, you can use the container element setting instead!&#x27;</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">legacyRender</span>(&#123; loading, <span class="attr">appContent</span>: element ? appContent : <span class="string">&#x27;&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> containerElement = <span class="title function_">getContainer</span>(container!);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The container might have be removed after micro app unmounted.</span></span><br><span class="line">    <span class="comment">// Such as the micro app unmount lifecycle called by a react componentWillUnmount lifecycle, after micro app unmounted, the react component might also be removed</span></span><br><span class="line">    <span class="keyword">if</span> (phase ! <span class="string">&#x27;unmounted&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> errorMsg = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (phase) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;loading&#x27;</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;mounting&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`Target container with <span class="subst">$&#123;container&#125;</span> not existed while <span class="subst">$&#123;appInstanceId&#125;</span> <span class="subst">$&#123;phase&#125;</span>!`</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;mounted&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`Target container with <span class="subst">$&#123;container&#125;</span> not existed after <span class="subst">$&#123;appInstanceId&#125;</span> <span class="subst">$&#123;phase&#125;</span>!`</span>;</span><br><span class="line"></span><br><span class="line">          <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`Target container with <span class="subst">$&#123;container&#125;</span> not existed while <span class="subst">$&#123;appInstanceId&#125;</span> rendering!`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)();</span><br><span class="line">      <span class="title function_">assertElementExist</span>(containerElement, errorMsg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (containerElement &amp;&amp; !containerElement.<span class="title function_">contains</span>(element)) &#123;</span><br><span class="line">      <span class="comment">// clear the container</span></span><br><span class="line">      <span class="keyword">while</span> (containerElement!.<span class="property">firstChild</span>) &#123;</span><br><span class="line">        rawRemoveChild.<span class="title function_">call</span>(containerElement, containerElement!.<span class="property">firstChild</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// append the element to container if it exist</span></span><br><span class="line">      <span class="keyword">if</span> (element) &#123;</span><br><span class="line">        rawAppendChild.<span class="title function_">call</span>(containerElement, element);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> render;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="loadAPP"><a href="#loadAPP" class="headerlink" title="loadAPP"></a>loadAPP</h3><p>The code is very long, let’s briefly analyze what they did:</p><ul><li>Call the’importEntry ‘interface of single-spa to get the loading entry of the sub-application and other information</li><li>The html entry parsed in the previous step will be passed to the createElement function as appContent, create a new node, mount the html entry under the node, and then return the new node and assign it to’initialAppWrapperElement’</li><li>call’getRender ‘to get the render function, assign to’render’</li><li>pass initialAppWrapperElement into render function</li><li>Call’getAppWrapperGetter ‘to get the enhanced function’initialAppWrapperGetter’, some judgment will be made internally, if there is no problem, the returned function’initialAppWrapperGetter ‘will return’initialAppWrapperElement’</li><li>If you choose to start the sandbox function, call createSandboxContainer to return the sandboxContainer, and assign the global object to the proxy of the sandboxContainer to start the sandbox function</li><li>Get all lifecycle functions by calling getAddOns</li><li>call execHooksChain to execute the beforeLoad function in the lifecycle obtained in the previous step</li><li>Get the lifecycle hook function of the sub-application through execScripts (the parsing result of the single-spa in the first step) and getLifecyclesFromExports</li><li>Eventually generate the parcelConfigGetter function, which returns the bootstrap, mount, and unmount methods for the child application, which will call the different lifecycle functions obtained earlier in sequence</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> loadApp&lt;T <span class="keyword">extends</span> <span class="title class_">ObjectType</span>&gt;(</span><br><span class="line">  <span class="attr">app</span>: <span class="title class_">LoadableApp</span>&lt;T&gt;,</span><br><span class="line">  <span class="attr">configuration</span>: <span class="title class_">FrameworkConfiguration</span> = &#123;&#125;,</span><br><span class="line">  lifeCycles?: <span class="title class_">FrameworkLifeCycles</span>&lt;T&gt;,</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="title class_">ParcelConfigObjectGetter</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; entry, <span class="attr">name</span>: appName &#125; = app;</span><br><span class="line">  <span class="keyword">const</span> appInstanceId = <span class="title function_">genAppInstanceIdByName</span>(appName);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> markName = <span class="string">`[qiankun] App <span class="subst">$&#123;appInstanceId&#125;</span> Loading`</span>;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">performanceMark</span>(markName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    singular = <span class="literal">false</span>,</span><br><span class="line">    sandbox = <span class="literal">true</span>,</span><br><span class="line">    excludeAssetFilter,</span><br><span class="line">    globalContext = <span class="variable language_">window</span>,</span><br><span class="line">    ...importEntryOpts</span><br><span class="line">  &#125; = configuration;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the entry html content and script executor</span></span><br><span class="line">  <span class="keyword">const</span> &#123; template, execScripts, assetPublicPath &#125; = <span class="keyword">await</span> importEntry(entry, importEntryOpts);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// as single-spa load and bootstrap new app parallel with other apps unmounting</span></span><br><span class="line">  <span class="comment">// (see https://github.com/CanopyTax/single-spa/blob/master/src/navigation/reroute.js#L74)</span></span><br><span class="line">  <span class="comment">// we need wait to load the app until all apps are finishing unmount in singular mode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">await</span> <span class="title function_">validateSingularMode</span>(singular, app)) &#123;</span><br><span class="line">    <span class="keyword">await</span> (prevAppUnmountedDeferred &amp;&amp; prevAppUnmountedDeferred.<span class="property">promise</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> appContent = <span class="title function_">getDefaultTplWrapper</span>(appInstanceId)(template);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> strictStyleIsolation = <span class="keyword">typeof</span> sandbox = <span class="string">&#x27;object&#x27;</span> &amp;&amp; !!sandbox.<span class="property">strictStyleIsolation</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span> &amp;&amp; strictStyleIsolation) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">&quot;[qiankun] strictStyleIsolation configuration will be removed in 3.0, pls don&#x27;t depend on it or use experimentalStyleIsolation instead!&quot;</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> scopedCSS = <span class="title function_">isEnableScopedCSS</span>(sandbox);</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">initialAppWrapperElement</span>: <span class="title class_">HTMLElement</span> | <span class="literal">null</span> = <span class="title function_">createElement</span>(</span><br><span class="line">    appContent,</span><br><span class="line">    strictStyleIsolation,</span><br><span class="line">    scopedCSS,</span><br><span class="line">    appInstanceId,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> initialContainer = <span class="string">&#x27;container&#x27;</span> <span class="keyword">in</span> app ? app.<span class="property">container</span> : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> legacyRender = <span class="string">&#x27;render&#x27;</span> <span class="keyword">in</span> app ? app.<span class="property">render</span> : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> render = <span class="title function_">getRender</span>(appInstanceId, appContent, legacyRender);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//first load settings apply visible region dom structure</span></span><br><span class="line">  <span class="comment">//Make sure the container dom structure is set before each app load</span></span><br><span class="line">  <span class="title function_">render</span>(&#123; <span class="attr">element</span>: initialAppWrapperElement, <span class="attr">loading</span>: <span class="literal">true</span>, <span class="attr">container</span>: initialContainer &#125;, <span class="string">&#x27;loading&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> initialAppWrapperGetter = <span class="title function_">getAppWrapperGetter</span>(</span><br><span class="line">    appInstanceId,</span><br><span class="line">    !!legacyRender,</span><br><span class="line">    strictStyleIsolation,</span><br><span class="line">    scopedCSS,</span><br><span class="line">    <span class="function">() =&gt;</span> initialAppWrapperElement,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="variable language_">global</span> = globalContext;</span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">mountSandbox</span> = (<span class="params"></span>) =&gt; <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">unmountSandbox</span> = (<span class="params"></span>) =&gt; <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">  <span class="keyword">const</span> useLooseSandbox = <span class="keyword">typeof</span> sandbox = <span class="string">&#x27;object&#x27;</span> &amp;&amp; !!sandbox.<span class="property">loose</span>;</span><br><span class="line">  <span class="keyword">const</span> speedySandbox = <span class="keyword">typeof</span> sandbox = <span class="string">&#x27;object&#x27;</span> &amp;&amp; !!sandbox.<span class="property">speedy</span>;</span><br><span class="line">  <span class="keyword">let</span> sandboxContainer;</span><br><span class="line">  <span class="keyword">if</span> (sandbox) &#123;</span><br><span class="line">    sandboxContainer = <span class="title function_">createSandboxContainer</span>(</span><br><span class="line">      appInstanceId,</span><br><span class="line">      <span class="comment">// FIXME should use a strict sandbox logic while remount, see https://github.com/umijs/qiankun/issues/518</span></span><br><span class="line">      initialAppWrapperGetter,</span><br><span class="line">      scopedCSS,</span><br><span class="line">      useLooseSandbox,</span><br><span class="line">      excludeAssetFilter,</span><br><span class="line">      <span class="variable language_">global</span>,</span><br><span class="line">      speedySandbox,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//Use the proxy object of the sandbox as the global object to use next</span></span><br><span class="line">    <span class="variable language_">global</span> = sandboxContainer.<span class="property">instance</span>.<span class="property">proxy</span> <span class="keyword">as</span> <span class="keyword">typeof</span> <span class="variable language_">window</span>;</span><br><span class="line">    mountSandbox = sandboxContainer.<span class="property">mount</span>;</span><br><span class="line">    unmountSandbox = sandboxContainer.<span class="property">unmount</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    beforeUnmount = [],</span><br><span class="line">    afterUnmount = [],</span><br><span class="line">    afterMount = [],</span><br><span class="line">    beforeMount = [],</span><br><span class="line">    beforeLoad = [],</span><br><span class="line">  &#125; = <span class="title function_">mergeWith</span>(&#123;&#125;, <span class="title function_">getAddOns</span>(<span class="variable language_">global</span>, assetPublicPath), lifeCycles, <span class="function">(<span class="params">v1, v2</span>) =&gt;</span> <span class="title function_">concat</span>(v1 ?? [], v2 ?? []));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">execHooksChain</span>(<span class="title function_">toArray</span>(beforeLoad), app, <span class="variable language_">global</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get the lifecycle hooks from module exports</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">scriptExports</span>: <span class="built_in">any</span> = <span class="keyword">await</span> <span class="title function_">execScripts</span>(<span class="variable language_">global</span>, sandbox &amp;&amp; !useLooseSandbox, &#123;</span><br><span class="line">    <span class="attr">scopedGlobalVariables</span>: speedySandbox ? trustedGlobals : [],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> &#123; bootstrap, mount, unmount, update &#125; = <span class="title function_">getLifecyclesFromExports</span>(</span><br><span class="line">    scriptExports,</span><br><span class="line">    appName,</span><br><span class="line">    <span class="variable language_">global</span>,</span><br><span class="line">    sandboxContainer?.<span class="property">instance</span>?.<span class="property">latestSetProp</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; onGlobalStateChange, setGlobalState, offGlobalStateChange &#125;: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="title class_">CallableFunction</span>&gt; =</span><br><span class="line">    <span class="title function_">getMicroAppStateActions</span>(appInstanceId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FIXME temporary way</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">syncAppWrapperElement2Sandbox</span> = (<span class="params">element: HTMLElement | <span class="literal">null</span></span>) =&gt; (initialAppWrapperElement = element);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">parcelConfigGetter</span>: <span class="title class_">ParcelConfigObjectGetter</span> = <span class="function">(<span class="params">remountContainer = initialContainer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">appWrapperElement</span>: <span class="title class_">HTMLElement</span> | <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">appWrapperGetter</span>: <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> getAppWrapperGetter&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">parcelConfig</span>: <span class="title class_">ParcelConfigObject</span> = &#123;</span><br><span class="line">      <span class="attr">name</span>: appInstanceId,</span><br><span class="line">      bootstrap,</span><br><span class="line">      <span class="attr">mount</span>: [</span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> marks = <span class="title function_">performanceGetEntriesByName</span>(markName, <span class="string">&#x27;mark&#x27;</span>);</span><br><span class="line">            <span class="comment">// mark length is zero means the app is remounting</span></span><br><span class="line">            <span class="keyword">if</span> (marks &amp;&amp; !marks.<span class="property">length</span>) &#123;</span><br><span class="line">              <span class="title function_">performanceMark</span>(markName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> ((<span class="keyword">await</span> <span class="title function_">validateSingularMode</span>(singular, app)) &amp;&amp; prevAppUnmountedDeferred) &#123;</span><br><span class="line">            <span class="keyword">return</span> prevAppUnmountedDeferred.<span class="property">promise</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// initial wrapper element before app mount/remount</span></span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          appWrapperElement = initialAppWrapperElement;</span><br><span class="line">          appWrapperGetter = <span class="title function_">getAppWrapperGetter</span>(</span><br><span class="line">            appInstanceId,</span><br><span class="line">            !!legacyRender,</span><br><span class="line">            strictStyleIsolation,</span><br><span class="line">            scopedCSS,</span><br><span class="line">            <span class="function">() =&gt;</span> appWrapperElement,</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//Add mount hook, make sure the container dom structure has been set before each app load</span></span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> useNewContainer = remountContainer ! initialContainer;</span><br><span class="line">          <span class="keyword">if</span> (useNewContainer || !appWrapperElement) &#123;</span><br><span class="line">            <span class="comment">// element will be destroyed after unmounted, we need to recreate it if it not exist</span></span><br><span class="line">            <span class="comment">// or we try to remount into a new container</span></span><br><span class="line">            appWrapperElement = <span class="title function_">createElement</span>(appContent, strictStyleIsolation, scopedCSS, appInstanceId);</span><br><span class="line">            <span class="title function_">syncAppWrapperElement2Sandbox</span>(appWrapperElement);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="title function_">render</span>(&#123; <span class="attr">element</span>: appWrapperElement, <span class="attr">loading</span>: <span class="literal">true</span>, <span class="attr">container</span>: remountContainer &#125;, <span class="string">&#x27;mounting&#x27;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        mountSandbox,</span><br><span class="line">        <span class="comment">// exec the chain after rendering to keep the behavior with beforeLoad</span></span><br><span class="line">        <span class="keyword">async</span> () =&gt; <span class="title function_">execHooksChain</span>(<span class="title function_">toArray</span>(beforeMount), app, <span class="variable language_">global</span>),</span><br><span class="line">        <span class="keyword">async</span> (props) =&gt; <span class="title function_">mount</span>(&#123; ...props, <span class="attr">container</span>: <span class="title function_">appWrapperGetter</span>(), setGlobalState, onGlobalStateChange &#125;),</span><br><span class="line">        <span class="comment">// finish loading after app mounted</span></span><br><span class="line">        <span class="keyword">async</span> () =&gt; <span class="title function_">render</span>(&#123; <span class="attr">element</span>: appWrapperElement, <span class="attr">loading</span>: <span class="literal">false</span>, <span class="attr">container</span>: remountContainer &#125;, <span class="string">&#x27;mounted&#x27;</span>),</span><br><span class="line">        <span class="keyword">async</span> () =&gt; <span class="title function_">execHooksChain</span>(<span class="title function_">toArray</span>(afterMount), app, <span class="variable language_">global</span>),</span><br><span class="line">        <span class="comment">// initialize the unmount defer after app mounted and resolve the defer after it unmounted</span></span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">await</span> <span class="title function_">validateSingularMode</span>(singular, app)) &#123;</span><br><span class="line">            prevAppUnmountedDeferred = <span class="keyword">new</span> <span class="title class_">Deferred</span>&lt;<span class="built_in">void</span>&gt;();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> measureName = <span class="string">`[qiankun] App <span class="subst">$&#123;appInstanceId&#125;</span> Loading Consuming`</span>;</span><br><span class="line">            <span class="title function_">performanceMeasure</span>(measureName, markName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">unmount</span>: [</span><br><span class="line">        <span class="keyword">async</span> () =&gt; <span class="title function_">execHooksChain</span>(<span class="title function_">toArray</span>(beforeUnmount), app, <span class="variable language_">global</span>),</span><br><span class="line">        <span class="keyword">async</span> (props) =&gt; <span class="title function_">unmount</span>(&#123; ...props, <span class="attr">container</span>: <span class="title function_">appWrapperGetter</span>() &#125;),</span><br><span class="line">        unmountSandbox,</span><br><span class="line">        <span class="keyword">async</span> () =&gt; <span class="title function_">execHooksChain</span>(<span class="title function_">toArray</span>(afterUnmount), app, <span class="variable language_">global</span>),</span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="title function_">render</span>(&#123; <span class="attr">element</span>: <span class="literal">null</span>, <span class="attr">loading</span>: <span class="literal">false</span>, <span class="attr">container</span>: remountContainer &#125;, <span class="string">&#x27;unmounted&#x27;</span>);</span><br><span class="line">          <span class="title function_">offGlobalStateChange</span>(appInstanceId);</span><br><span class="line">          <span class="comment">// for gc</span></span><br><span class="line">          appWrapperElement = <span class="literal">null</span>;</span><br><span class="line">          <span class="title function_">syncAppWrapperElement2Sandbox</span>(appWrapperElement);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> ((<span class="keyword">await</span> <span class="title function_">validateSingularMode</span>(singular, app)) &amp;&amp; prevAppUnmountedDeferred) &#123;</span><br><span class="line">            prevAppUnmountedDeferred.<span class="title function_">resolve</span>();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> update = <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      parcelConfig.<span class="property">update</span> = update;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> parcelConfig;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> parcelConfigGetter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Instrumental-approach"><a href="#Instrumental-approach" class="headerlink" title="Instrumental approach"></a>Instrumental approach</h2><h3 id="error"><a href="#error" class="headerlink" title="error"></a>error</h3><p>This is just declaring an Error class</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">QiankunError</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">message: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">`[qiankun]: <span class="subst">$&#123;message&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="errorHandler"><a href="#errorHandler" class="headerlink" title="errorHandler"></a>errorHandler</h3><p>Exposing a method to add a global error handling listening function</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">Kuitos</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-02-21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; addErrorHandler, removeErrorHandler &#125; <span class="keyword">from</span> <span class="string">&#x27;single-spa&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addGlobalUncaughtErrorHandler</span>(<span class="params">errorHandler: OnErrorEventHandlerNonNull</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, errorHandler);</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, errorHandler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">removeGlobalUncaughtErrorHandler</span>(<span class="params">errorHandler: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;error&#x27;</span>, errorHandler);</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;unhandledrejection&#x27;</span>, errorHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="utils"><a href="#utils" class="headerlink" title="utils"></a>utils</h3><p>Here only lists the function signature and its role, the specific code implementation will not be posted here</p><ul><li>function toArray<t>(array: T | T[]): T[]</t></li><li>function sleep(ms: number)</li><li>function nextTask(cb: () =&gt; void): void</li><li>function isConstructable(fn: () =&gt; any | FunctionConstructor)</li><li>function isCallable(fn: any)</li><li>function isPropertyFrozen(target: any, p?: PropertyKey): boolean</li><li>function isBoundedFunction(fn: CallableFunction)</li><li>const qiankunHeadTagName = ‘qiankun-head’;</li><li>function getDefaultTplWrapper(name: string)</li><li>function getWrapperId(name: string)</li><li>const nativeGlobal = new Function(‘return this’)()</li><li>const genAppInstanceIdByName = (appName: string): string</li><li>function validateExportLifecycle(exports: any)</li><li>function performanceGetEntriesByName(markName: string, type?: string)</li><li>function performanceMark(markName: string)</li><li>function performanceMeasure(measureName: string, markName: string)</li><li>function isEnableScopedCSS(sandbox: FrameworkConfiguration[‘sandbox’])</li><li>function getXPathForElement(el: Node, document: Document): string | void</li></ul><h2 id="Qiankun"><a href="#Qiankun" class="headerlink" title="Qiankun"></a>Qiankun</h2><p>This part is the main API that qiankun exposes and uses.</p><h3 id="Tools-to-introduce"><a href="#Tools-to-introduce" class="headerlink" title="Tools to introduce"></a>Tools to introduce</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">ParcelConfigObject</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;single-spa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; mountRootParcel, registerApplication, start <span class="keyword">as</span> startSingleSpa &#125; <span class="keyword">from</span> <span class="string">&#x27;single-spa&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;</span><br><span class="line">  <span class="title class_">FrameworkConfiguration</span>,</span><br><span class="line">  <span class="title class_">FrameworkLifeCycles</span>,</span><br><span class="line">  <span class="title class_">LoadableApp</span>,</span><br><span class="line">  <span class="title class_">MicroApp</span>,</span><br><span class="line">  <span class="title class_">ObjectType</span>,</span><br><span class="line">  <span class="title class_">RegistrableApp</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./interfaces&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">ParcelConfigObjectGetter</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./loader&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; loadApp &#125; <span class="keyword">from</span> <span class="string">&#x27;./loader&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; doPrefetchStrategy &#125; <span class="keyword">from</span> <span class="string">&#x27;./prefetch&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Deferred</span>, getContainerXPath, toArray &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">microApps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RegistrableApp</span>&lt;<span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;&gt;&gt; = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> <span class="attr">frameworkConfiguration</span>: <span class="title class_">FrameworkConfiguration</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> started = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> defaultUrlRerouteOnly = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> frameworkStartedDefer = <span class="keyword">new</span> <span class="title class_">Deferred</span>&lt;<span class="built_in">void</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> autoDowngradeForLowVersionBrowser = (<span class="attr">configuration</span>: <span class="title class_">FrameworkConfiguration</span>): <span class="function"><span class="params">FrameworkConfiguration</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; sandbox, singular &#125; = configuration;</span><br><span class="line">  <span class="keyword">if</span> (sandbox) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">Proxy</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;[qiankun] Miss window.Proxy, proxySandbox will degenerate into snapshotSandbox&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (singular = <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;[qiankun] Setting singular as false may cause unexpected behavior while your browser not support window.Proxy&#x27;</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123; ...configuration, <span class="attr">sandbox</span>: <span class="keyword">typeof</span> sandbox = <span class="string">&#x27;object&#x27;</span> ? &#123; ...sandbox, <span class="attr">loose</span>: <span class="literal">true</span> &#125; : &#123; <span class="attr">loose</span>: <span class="literal">true</span> &#125; &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> configuration;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="registerMicroApps"><a href="#registerMicroApps" class="headerlink" title="registerMicroApps"></a>registerMicroApps</h3><p>Use the single-spa interface’registerApplication ‘to register sub-applications</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> registerMicroApps&lt;T <span class="keyword">extends</span> <span class="title class_">ObjectType</span>&gt;(</span><br><span class="line">  <span class="attr">apps</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RegistrableApp</span>&lt;T&gt;&gt;,</span><br><span class="line">  lifeCycles?: <span class="title class_">FrameworkLifeCycles</span>&lt;T&gt;,</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// Each app only needs to be registered once</span></span><br><span class="line">  <span class="keyword">const</span> unregisteredApps = apps.<span class="title function_">filter</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> !microApps.<span class="title function_">some</span>(<span class="function">(<span class="params">registeredApp</span>) =&gt;</span> registeredApp.<span class="property">name</span> = app.<span class="property">name</span>));</span><br><span class="line"></span><br><span class="line">  microApps = [...microApps, ...unregisteredApps];</span><br><span class="line"></span><br><span class="line">  unregisteredApps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, activeRule, loader = noop, props, ...appConfig &#125; = app;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">registerApplication</span>(&#123;</span><br><span class="line">      name,</span><br><span class="line">      <span class="attr">app</span>: <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="title function_">loader</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">await</span> frameworkStartedDefer.<span class="property">promise</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; mount, ...otherMicroAppConfigs &#125; = (</span><br><span class="line">          <span class="keyword">await</span> <span class="title function_">loadApp</span>(&#123; name, props, ...appConfig &#125;, frameworkConfiguration, lifeCycles)</span><br><span class="line">        )();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="attr">mount</span>: [<span class="keyword">async</span> () =&gt; <span class="title function_">loader</span>(<span class="literal">true</span>), ...<span class="title function_">toArray</span>(mount), <span class="keyword">async</span> () =&gt; <span class="title function_">loader</span>(<span class="literal">false</span>)],</span><br><span class="line">          ...otherMicroAppConfigs,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">activeWhen</span>: activeRule,</span><br><span class="line">      <span class="attr">customProps</span>: props,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="loadMicroApp"><a href="#loadMicroApp" class="headerlink" title="loadMicroApp"></a>loadMicroApp</h3><p>The function of this function is to call the loadApp of the loader, and then use the startSingleSpa of single-spa to start</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> loadMicroApp&lt;T <span class="keyword">extends</span> <span class="title class_">ObjectType</span>&gt;(</span><br><span class="line">  <span class="attr">app</span>: <span class="title class_">LoadableApp</span>&lt;T&gt;,</span><br><span class="line">  configuration?: <span class="title class_">FrameworkConfiguration</span> &amp; &#123; autoStart?: <span class="built_in">boolean</span> &#125;,</span><br><span class="line">  lifeCycles?: <span class="title class_">FrameworkLifeCycles</span>&lt;T&gt;,</span><br><span class="line">): <span class="title class_">MicroApp</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; props, name &#125; = app;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> container = <span class="string">&#x27;container&#x27;</span> <span class="keyword">in</span> app ? app.<span class="property">container</span> : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="comment">// Must compute the container xpath at beginning to keep it consist around app running</span></span><br><span class="line">  <span class="comment">// If we compute it every time, the container dom structure most probably been changed and result in a different xpath value</span></span><br><span class="line">  <span class="keyword">const</span> containerXPath = <span class="title function_">getContainerXPath</span>(container);</span><br><span class="line">  <span class="keyword">const</span> appContainerXPathKey = <span class="string">`<span class="subst">$&#123;name&#125;</span>-<span class="subst">$&#123;containerXPath&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">microApp</span>: <span class="title class_">MicroApp</span>;</span><br><span class="line">  <span class="keyword">const</span> wrapParcelConfigForRemount = (<span class="attr">config</span>: <span class="title class_">ParcelConfigObject</span>): <span class="function"><span class="params">ParcelConfigObject</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> microAppConfig = config;</span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      <span class="keyword">if</span> (containerXPath) &#123;</span><br><span class="line">        <span class="keyword">const</span> containerMicroApps = containerMicroAppsMap.<span class="title function_">get</span>(appContainerXPathKey);</span><br><span class="line">        <span class="keyword">if</span> (containerMicroApps?.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> mount = [</span><br><span class="line">            <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="comment">// While there are multiple micro apps mounted on the same container, we must wait until the prev instances all had unmounted</span></span><br><span class="line">              <span class="comment">// Otherwise it will lead some concurrent issues</span></span><br><span class="line">              <span class="keyword">const</span> prevLoadMicroApps = containerMicroApps.<span class="title function_">slice</span>(<span class="number">0</span>, containerMicroApps.<span class="title function_">indexOf</span>(microApp));</span><br><span class="line">              <span class="keyword">const</span> prevLoadMicroAppsWhichNotBroken = prevLoadMicroApps.<span class="title function_">filter</span>(</span><br><span class="line">                <span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="title function_">getStatus</span>() ! <span class="string">&#x27;LOAD_ERROR&#x27;</span> &amp;&amp; v.<span class="title function_">getStatus</span>() ! <span class="string">&#x27;SKIP_BECAUSE_BROKEN&#x27;</span>,</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(prevLoadMicroAppsWhichNotBroken.<span class="title function_">map</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">unmountPromise</span>));</span><br><span class="line">            &#125;,</span><br><span class="line">            ...<span class="title function_">toArray</span>(microAppConfig.<span class="property">mount</span>),</span><br><span class="line">          ];</span><br><span class="line"></span><br><span class="line">          microAppConfig = &#123;</span><br><span class="line">            ...config,</span><br><span class="line">            mount,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...microAppConfig,</span><br><span class="line">      <span class="comment">// empty bootstrap hook which should not run twice while it calling from cached micro app</span></span><br><span class="line">      <span class="attr">bootstrap</span>: <span class="function">() =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * using name + container xpath as the micro app instance id,</span></span><br><span class="line"><span class="comment">   * it means if you rendering a micro app to a dom which have been rendered before,</span></span><br><span class="line"><span class="comment">   * the micro app would not load and evaluate its lifecycles again</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> memorizedLoadingFn = <span class="keyword">async</span> (): <span class="title class_">Promise</span>&lt;<span class="title class_">ParcelConfigObject</span>&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userConfiguration = <span class="title function_">autoDowngradeForLowVersionBrowser</span>(</span><br><span class="line">      configuration ?? &#123; ...frameworkConfiguration, <span class="attr">singular</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> &#123; $$cacheLifecycleByAppName &#125; = userConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      <span class="comment">// using appName as cache for internal experimental scenario</span></span><br><span class="line">      <span class="keyword">if</span> ($$cacheLifecycleByAppName) &#123;</span><br><span class="line">        <span class="keyword">const</span> parcelConfigGetterPromise = appConfigPromiseGetterMap.<span class="title function_">get</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (parcelConfigGetterPromise) <span class="keyword">return</span> <span class="title function_">wrapParcelConfigForRemount</span>((<span class="keyword">await</span> parcelConfigGetterPromise)(container));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (containerXPath) &#123;</span><br><span class="line">        <span class="keyword">const</span> parcelConfigGetterPromise = appConfigPromiseGetterMap.<span class="title function_">get</span>(appContainerXPathKey);</span><br><span class="line">        <span class="keyword">if</span> (parcelConfigGetterPromise) <span class="keyword">return</span> <span class="title function_">wrapParcelConfigForRemount</span>((<span class="keyword">await</span> parcelConfigGetterPromise)(container));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> parcelConfigObjectGetterPromise = <span class="title function_">loadApp</span>(app, userConfiguration, lifeCycles);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      <span class="keyword">if</span> ($$cacheLifecycleByAppName) &#123;</span><br><span class="line">        appConfigPromiseGetterMap.<span class="title function_">set</span>(name, parcelConfigObjectGetterPromise);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (containerXPath) appConfigPromiseGetterMap.<span class="title function_">set</span>(appContainerXPathKey, parcelConfigObjectGetterPromise);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">await</span> parcelConfigObjectGetterPromise)(container);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!started &amp;&amp; configuration?.<span class="property">autoStart</span> ! <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// We need to invoke start method of single-spa as the popstate event should be dispatched while the main app calling pushState/replaceState automatically,</span></span><br><span class="line">    <span class="comment">// but in single-spa it will check the start status before it dispatch popstate</span></span><br><span class="line">    <span class="comment">// see https://github.com/single-spa/single-spa/blob/f28b5963be1484583a072c8145ac0b5a28d91235/src/navigation/navigation-events.js#L101</span></span><br><span class="line">    <span class="comment">// ref https://github.com/umijs/qiankun/pull/1071</span></span><br><span class="line">    <span class="title function_">startSingleSpa</span>(&#123; <span class="attr">urlRerouteOnly</span>: frameworkConfiguration.<span class="property">urlRerouteOnly</span> ?? defaultUrlRerouteOnly &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  microApp = <span class="title function_">mountRootParcel</span>(memorizedLoadingFn, &#123; <span class="attr">domElement</span>: <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>), ...props &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (container) &#123;</span><br><span class="line">    <span class="keyword">if</span> (containerXPath) &#123;</span><br><span class="line">      <span class="comment">// Store the microApps which they mounted on the same container</span></span><br><span class="line">      <span class="keyword">const</span> microAppsRef = containerMicroAppsMap.<span class="title function_">get</span>(appContainerXPathKey) || [];</span><br><span class="line">      microAppsRef.<span class="title function_">push</span>(microApp);</span><br><span class="line">      containerMicroAppsMap.<span class="title function_">set</span>(appContainerXPathKey, microAppsRef);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">cleanup</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> index = microAppsRef.<span class="title function_">indexOf</span>(microApp);</span><br><span class="line">        microAppsRef.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// @ts-ignore</span></span><br><span class="line">        microApp = <span class="literal">null</span>;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// gc after unmount</span></span><br><span class="line">      microApp.<span class="property">unmountPromise</span>.<span class="title function_">then</span>(cleanup).<span class="title function_">catch</span>(cleanup);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> microApp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">start</span>(<span class="params">opts: FrameworkConfiguration = &#123;&#125;</span>) &#123;</span><br><span class="line">  frameworkConfiguration = &#123; <span class="attr">prefetch</span>: <span class="literal">true</span>, <span class="attr">singular</span>: <span class="literal">true</span>, <span class="attr">sandbox</span>: <span class="literal">true</span>, ...opts &#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    prefetch,</span><br><span class="line">    sandbox,</span><br><span class="line">    singular,</span><br><span class="line">    urlRerouteOnly = defaultUrlRerouteOnly,</span><br><span class="line">    ...importEntryOpts</span><br><span class="line">  &#125; = frameworkConfiguration;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prefetch) &#123;</span><br><span class="line">    <span class="title function_">doPrefetchStrategy</span>(microApps, prefetch, importEntryOpts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  frameworkConfiguration = <span class="title function_">autoDowngradeForLowVersionBrowser</span>(frameworkConfiguration);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">startSingleSpa</span>(&#123; urlRerouteOnly &#125;);</span><br><span class="line">  started = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  frameworkStartedDefer.<span class="title function_">resolve</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>In general, the internal API division of labor is as follows:</p><ul><li>prefetch provides a way to preload all child application resources,</li><li>loader provides the ability to load resources based on the Sub-App entry, execute the entry file, and then mount the resulting html to a newly created div</li><li>Qiankun has two main APIs exposed to the outside world<ul><li>registerMicroApps mainly calls the register interface of sigle-spa to register sub-applications</li><li>loadMicroApp will call the method in the loader to load the sub-application. In fact, the loader eventually calls the load method of single-spa, just doing some sandbox isolation, css isolation, etc.</li></ul></li></ul></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/" title="micro frontend framework Qiankun source code analysis">https://sunra.top/en/2022/11/24/micro-frontend-qiankun-code/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2022/11/22/micro-frontend-qiankun-sandbox/" rel="prev" title="micro frontend Qiankun sandbox principle"><i class="fa fa-chevron-left"></i> micro frontend Qiankun sandbox principle</a></div><div class="post-nav-item"> <a href="/en/2022/11/28/javascript-design-pattern-2/" rel="next" title="JavaScript Design pattern learning and practice (2)">JavaScript Design pattern learning and practice (2)<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2022/11/24/micro-frontend-qiankun-code/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>