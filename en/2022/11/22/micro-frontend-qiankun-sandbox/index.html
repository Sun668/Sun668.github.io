<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Why do you need a micro frontendIn fact, under the two major backgrounds of the birth of micro frontend, in the front-end community that advocates embracing change, new frameworks, technologies, and c"><meta property="og:type" content="article"><meta property="og:title" content="micro frontend Qiankun sandbox principle"><meta property="og:url" content="https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Why do you need a micro frontendIn fact, under the two major backgrounds of the birth of micro frontend, in the front-end community that advocates embracing change, new frameworks, technologies, and c"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-11-22T02:20:26.000Z"><meta property="article:modified_time" content="2023-09-09T02:41:46.327Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/","path":"2022/11/22/micro-frontend-qiankun-sandbox/","title":"micro frontend Qiankun sandbox principle"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>micro frontend Qiankun sandbox principle | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-do-you-need-a-micro-frontend"><span class="nav-number">1.</span> <span class="nav-text">Why do you need a micro frontend</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-do-you-need-a-sandbox"><span class="nav-number">2.</span> <span class="nav-text">Why do you need a sandbox</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-create-a-sandbox"><span class="nav-number">3.</span> <span class="nav-text">How to create a sandbox</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Manual-executable-code"><span class="nav-number">3.1.</span> <span class="nav-text">Manual executable code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Snapshot-Sandbox"><span class="nav-number">3.2.</span> <span class="nav-text">Snapshot Sandbox</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Agent-sandbox"><span class="nav-number">3.3.</span> <span class="nav-text">Agent sandbox</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#set"><span class="nav-number">3.3.1.</span> <span class="nav-text">set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get"><span class="nav-number">3.3.2.</span> <span class="nav-text">get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Other"><span class="nav-number">3.3.3.</span> <span class="nav-text">Other</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patchers"><span class="nav-number">3.4.</span> <span class="nav-text">patchers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hijacking-interval"><span class="nav-number">3.4.1.</span> <span class="nav-text">Hijacking interval</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hijacking-eventListener"><span class="nav-number">3.4.2.</span> <span class="nav-text">Hijacking eventListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hijacking-historyListener-against-umi-framework"><span class="nav-number">3.4.3.</span> <span class="nav-text">Hijacking historyListener (against umi framework)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#patch"><span class="nav-number">3.4.4.</span> <span class="nav-text">patch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#patchers-1"><span class="nav-number">3.4.5.</span> <span class="nav-text">patchers</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sandbox-collection"><span class="nav-number">3.5.</span> <span class="nav-text">Sandbox collection</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="micro frontend Qiankun sandbox principle | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> micro frontend Qiankun sandbox principle</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-11-22 10:20:26" itemprop="dateCreated datePublished" datetime="2022-11-22T10:20:26+08:00">2022-11-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-09-09 10:41:46" itemprop="dateModified" datetime="2023-09-09T10:41:46+08:00">2023-09-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2022/11/22/micro-frontend-qiankun-sandbox/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2022/11/22/micro-frontend-qiankun-sandbox/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="Why-do-you-need-a-micro-frontend"><a href="#Why-do-you-need-a-micro-frontend" class="headerlink" title="Why do you need a micro frontend"></a>Why do you need a micro frontend</h2><p>In fact, under the two major backgrounds of the birth of micro frontend, in the front-end community that advocates embracing change, new frameworks, technologies, and concepts can be seen emerging one after another, and with the evolution of WEB standards, front-end applications have better performance and faster development efficiency. However, with the higher complexity of applications, the wider team size involved, and higher performance requirements, application complexity has become an important bottleneck blocking business development. How to make existing systems embrace the latest technologies to improve productivity and decouple single applications is a challenge that front-end engineering has to face now.</p><span id="more"></span><p>If you encounter the following situations, you may need micro frontend:</p><ul><li>Your monolithic application evolves from an ordinary application to a boulder application over a relatively long period of time due to the increase and change of participating personnel and teams, which leads to the problem of unmaintainable applications</li><li>As a portal website, it needs to integrate many systems, which are maintained by different teams, have different styles of code, and have various technical stacks. In order to aggregate, it can only take the form of iframe or MPA for aggregation</li></ul><h2 id="Why-do-you-need-a-sandbox"><a href="#Why-do-you-need-a-sandbox" class="headerlink" title="Why do you need a sandbox"></a>Why do you need a sandbox</h2><p>In the micro frontend scenario, since multiple independent applications are organized together, conflicts are bound to occur without native isolation like iframe, such as global variable conflicts and style conflicts, which may lead to abnormal application styles and even functions. Unavailable. Therefore, in order to make the micro frontend available for production, a sandbox mechanism that allows each sub-application to achieve a certain degree of isolation is essential.</p><h2 id="How-to-create-a-sandbox"><a href="#How-to-create-a-sandbox" class="headerlink" title="How to create a sandbox"></a>How to create a sandbox</h2><h3 id="Manual-executable-code"><a href="#Manual-executable-code" class="headerlink" title="Manual executable code"></a>Manual executable code</h3><p>Conventional script loading is executed through script tags. To achieve sandboxing, because we need to control the opening and closing of the sandbox, we need to accurately grasp the execution timing of the script, so we need to find a suitable method for manually executing code</p><p>First of all, we think of eval. Since eval has security, performance and other issues, and is not conducive to debugging, what we have heard before is that the API of eval is not recommended.</p><p>But in the sandbox scenario of micro frontend, eval is indeed a better solution. For example, qiankun uses eval as a code executor.</p><p>New Function returns a new function by passing in a string as the body of the function, which can be used as a substitute for eval</p><p>Compared to eval, there are two more important differences:</p><ul><li>Cannot access variables of the current environment, but can access global variables, which is more secure</li><li>You only need to process the incoming string once, and the subsequent repeated execution is the same function, while eval needs to be processed every time, with higher performance</li></ul><h3 id="Snapshot-Sandbox"><a href="#Snapshot-Sandbox" class="headerlink" title="Snapshot Sandbox"></a>Snapshot Sandbox</h3><p>As the name suggests, that is, at a certain stage to the current operating environment to take a snapshot, and then when needed to restore the snapshot, so as to achieve isolation.</p><p>The principle of this thing is very similar to the CPU process switching in the operating system. When each process obtains the CPU usage right, it loads the context in the PCB (Process Control Block) into the corresponding register, and then the CPU starts to continue execution, waiting until the usage right is lost. Then save the information in the current register back to the PCB. The same is true of the snapshot sandbox. For each sub-application, the runtime loads the context saved internally into the corresponding variable, and saves the values of each variable in the current browser environment to the snapshot when it is destroyed.</p><p>Let’s take a look at the source code of the snapshot sandbox in qiankun, and my comments have been added to the source code.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> <span class="variable">Hydrogen</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-3-8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> type &#123; <span class="title class_">SandBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../interfaces&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SandBoxType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../interfaces&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">iter</span>(<span class="params">obj: <span class="keyword">typeof</span> <span class="variable language_">window</span>, callbackFn: (prop: any) =&gt; <span class="keyword">void</span></span>) &#123;</span><br><span class="line">  <span class="comment">// eslint-disable-next-line guard-for-in, no-restricted-syntax</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">    <span class="comment">// patch for clearInterval for compatible reason, see #1490</span></span><br><span class="line">    <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(prop) || prop = <span class="string">&#x27;clearInterval&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">callbackFn</span>(prop);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Sandbox based on diff method, used for low version browsers that do not support proxy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">SnapshotSandbox</span> implements <span class="title class_">SandBox</span> &#123;</span><br><span class="line">  <span class="attr">proxy</span>: <span class="title class_">WindowProxy</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">name</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">SandBoxType</span>;</span><br><span class="line"></span><br><span class="line">  sandboxRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Snapshot of the windows object, used to save the state of the window object before the current sandbox active</span></span><br><span class="line">  private windowSnapshot!: <span class="title class_">Window</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//The value of the current sandbox modified on the window object between active and inactive</span></span><br><span class="line">  private <span class="attr">modifyPropsMap</span>: <span class="title class_">Record</span>&lt;any, any&gt; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name: string</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">proxy</span> = <span class="variable language_">window</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = <span class="title class_">SandBoxType</span>.<span class="property">Snapshot</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">active</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Record</span> the current snapshot to compare which properties have changed when inactive</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">windowSnapshot</span> = &#123;&#125; <span class="keyword">as</span> <span class="title class_">Window</span>;</span><br><span class="line">    <span class="title function_">iter</span>(<span class="variable language_">window</span>, <span class="function">(<span class="params">prop</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">windowSnapshot</span>[prop] = <span class="variable language_">window</span>[prop];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Restore</span> the previous changes, that is, the variables modified between active and inactive last time</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">modifyPropsMap</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">p: any</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>[p] = <span class="variable language_">this</span>.<span class="property">modifyPropsMap</span>[p];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sandboxRunning</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">inactive</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">modifyPropsMap</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//Compare the properties on the current window object with the properties on the window object before active. If there is any difference, record it in modifyPropsMap, and reassign it back to window when active next time.</span></span><br><span class="line">    <span class="title function_">iter</span>(<span class="variable language_">window</span>, <span class="function">(<span class="params">prop</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">window</span>[prop] ! <span class="variable language_">this</span>.<span class="property">windowSnapshot</span>[prop]) &#123;</span><br><span class="line">        <span class="title class_">Record</span> changes and restore the environment</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">modifyPropsMap</span>[prop] = <span class="variable language_">window</span>[prop];</span><br><span class="line">        <span class="variable language_">window</span>[prop] = <span class="variable language_">this</span>.<span class="property">windowSnapshot</span>[prop];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`[qiankun:sandbox] <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> origin window restore...`</span>, <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">modifyPropsMap</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sandboxRunning</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Agent-sandbox"><a href="#Agent-sandbox" class="headerlink" title="Agent sandbox"></a>Agent sandbox</h3><p>The proxy sandbox mainly creates a fakeWindow for each sandbox, then sets the proxy for the fakeWindow, and accesses the fakeWindow through the proxy, so its source code is mainly divided into two parts:</p><ul><li>Create a fakeWindow with the’createFakeWindow ‘function, which clones only the modifiable properties of the window object</li><li>Create ProxySandbox class, internally using fakeWindow created by’createFakeWindow’</li></ul><p>Let’s take a look at’createFakeWindow ‘first. Speaking of which, what this function does is what it says in the comment:’ copy the non-configurable property of global to fakeWindow ‘</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createFakeWindow</span>(<span class="params">globalContext: Window</span>) &#123;</span><br><span class="line">  <span class="comment">// map always has the fastest performance in has check scenario</span></span><br><span class="line">  <span class="comment">// see https://jsperf.com/array-indexof-vs-set-has/23</span></span><br><span class="line">  <span class="keyword">const</span> propertiesWithGetter = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">PropertyKey</span>, boolean&gt;();</span><br><span class="line">  <span class="keyword">const</span> fakeWindow = &#123;&#125; <span class="keyword">as</span> <span class="title class_">FakeWindow</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   copy the non-configurable property of global to fakeWindow</span></span><br><span class="line"><span class="comment">   see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor</span></span><br><span class="line"><span class="comment">   &gt; A property cannot be reported as non-configurable, if it does not exist as an own property of the target object or if it exists as a configurable own property of the target object.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(globalContext)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> descriptor = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalContext, p);</span><br><span class="line">      <span class="keyword">return</span> !descriptor?.<span class="property">configurable</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> descriptor = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalContext, p);</span><br><span class="line">      <span class="keyword">if</span> (descriptor) &#123;</span><br><span class="line">        <span class="keyword">const</span> hasGetter = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(descriptor, <span class="string">&#x27;get&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         make top/self/window property configurable and writable, otherwise it will cause TypeError while get trap return.</span></span><br><span class="line"><span class="comment">         see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/get</span></span><br><span class="line"><span class="comment">         &gt; The value reported for a property must be the same as the value of the corresponding target object property if the target object property is a non-writable, non-configurable data property.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          p = <span class="string">&#x27;top&#x27;</span> ||</span><br><span class="line">          p = <span class="string">&#x27;parent&#x27;</span> ||</span><br><span class="line">          p = <span class="string">&#x27;self&#x27;</span> ||</span><br><span class="line">          p = <span class="string">&#x27;window&#x27;</span> ||</span><br><span class="line">          (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;test&#x27;</span> &amp;&amp; (p = <span class="string">&#x27;mockTop&#x27;</span> || p = <span class="string">&#x27;mockSafariTop&#x27;</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">          descriptor.<span class="property">configurable</span> = <span class="literal">true</span>;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           The descriptor of window.window/window.top/window.self in Safari/FF are accessor descriptors, we need to avoid adding a data descriptor while it was</span></span><br><span class="line"><span class="comment">           Example:</span></span><br><span class="line"><span class="comment">            Safari/FF: Object.getOwnPropertyDescriptor(window, &#x27;top&#x27;) -&gt; &#123;get: function, set: undefined, enumerable: true, configurable: false&#125;</span></span><br><span class="line"><span class="comment">            Chrome: Object.getOwnPropertyDescriptor(window, &#x27;top&#x27;) -&gt; &#123;value: Window, writable: false, enumerable: true, configurable: false&#125;</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (!hasGetter) &#123;</span><br><span class="line">            descriptor.<span class="property">writable</span> = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasGetter) propertiesWithGetter.<span class="title function_">set</span>(p, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// freeze the descriptor to avoid being modified by zone.js</span></span><br><span class="line">        <span class="comment">// see https://github.com/angular/zone.js/blob/a5fe09b0fac27ac5df1fa746042f96f05ccb6a00/lib/browser/define-property.ts#L71</span></span><br><span class="line">        <span class="title function_">rawObjectDefineProperty</span>(fakeWindow, p, <span class="title class_">Object</span>.<span class="title function_">freeze</span>(descriptor));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    fakeWindow,</span><br><span class="line">    propertiesWithGetter,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then there is the implementation of ProxySandbox, the key is that its constructor hijacked the set method of fakeWindow through proxy, and then in this way to count those properties have changed, and if it is a member of’globalVariableWhiteList ‘, then its descriptor is stored in’globalWhitelistPrevDescriptor’ and restored when inactive</p><p>Let’s first take a look at what this’globalVariableWhiteList ‘is</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> variableWhiteListInDev =</span><br><span class="line">  process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;test&#x27;</span> || process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span> || <span class="variable language_">window</span>.<span class="property">__QIANKUN_DEVELOPMENT__</span></span><br><span class="line">    ? [</span><br><span class="line">        <span class="comment">// for react hot reload</span></span><br><span class="line">        <span class="comment">// see https://github.com/facebook/create-react-app/blob/66bf7dfc43350249e2f09d138a20840dae8a0a4a/packages/react-error-overlay/src/index.js#L180</span></span><br><span class="line">        <span class="string">&#x27;__REACT_ERROR_OVERLAY_GLOBAL_HOOK__&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">    : [];</span><br><span class="line"><span class="comment">// who could escape the sandbox</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">globalVariableWhiteList</span>: string[] = [</span><br><span class="line">  <span class="comment">// FIXME System.js used a indirect call with eval, which would make it scope escape to global</span></span><br><span class="line">  <span class="comment">// To make System.js works well, we write it back to global window temporary</span></span><br><span class="line">  <span class="comment">// see https://github.com/systemjs/systemjs/blob/457f5b7e8af6bd120a279540477552a07d5de086/src/evaluate.js#L106</span></span><br><span class="line">  <span class="string">&#x27;System&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// see https://github.com/systemjs/systemjs/blob/457f5b7e8af6bd120a279540477552a07d5de086/src/instantiate.js#L357</span></span><br><span class="line">  <span class="string">&#x27;__cjsWrapper&#x27;</span>,</span><br><span class="line">  ...variableWhiteListInDev,</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>Then take a look at the general structure of ProxySandbox, where I first hide the Proxy, and then introduce it one by one:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ProxySandbox</span> <span class="keyword">implements</span> <span class="title class_">SandBox</span> &#123;</span><br><span class="line">  <span class="comment">/** window value change record */</span></span><br><span class="line">  <span class="keyword">private</span> updatedValueSet = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">PropertyKey</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">SandBoxType</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attr">proxy</span>: <span class="title class_">WindowProxy</span>;</span><br><span class="line">  sandboxRunning = <span class="literal">true</span>;</span><br><span class="line">  <span class="attr">latestSetProp</span>: <span class="title class_">PropertyKey</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">active</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">sandboxRunning</span>) activeSandboxCount++;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sandboxRunning</span> = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">inactive</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`[qiankun:sandbox] <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> modified global properties restore...`</span>, [</span><br><span class="line">        ...<span class="variable language_">this</span>.<span class="property">updatedValueSet</span>.<span class="title function_">keys</span>(),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;test&#x27;</span> || --activeSandboxCount = <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// reset the global value to the prev value</span></span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">globalWhitelistPrevDescriptor</span>).<span class="title function_">forEach</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> descriptor = <span class="variable language_">this</span>.<span class="property">globalWhitelistPrevDescriptor</span>[p];</span><br><span class="line">        <span class="keyword">if</span> (descriptor) &#123;</span><br><span class="line">          <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>.<span class="property">globalContext</span>, p, descriptor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// @ts-ignore</span></span><br><span class="line">          <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">globalContext</span>[p];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sandboxRunning</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the descriptor of global variables in whitelist before it been modified</span></span><br><span class="line">  <span class="attr">globalWhitelistPrevDescriptor</span>: &#123; [p <span class="keyword">in</span> <span class="keyword">typeof</span> globalVariableWhiteList[<span class="built_in">number</span>]]: <span class="title class_">PropertyDescriptor</span> | <span class="literal">undefined</span> &#125; = &#123;&#125;;</span><br><span class="line">  <span class="attr">globalContext</span>: <span class="keyword">typeof</span> <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name: <span class="built_in">string</span>, globalContext = <span class="variable language_">window</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">globalContext</span> = globalContext;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = <span class="title class_">SandBoxType</span>.<span class="property">Proxy</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; updatedValueSet &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; fakeWindow, propertiesWithGetter &#125; = <span class="title function_">createFakeWindow</span>(globalContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> descriptorTargetMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">PropertyKey</span>, <span class="title class_">SymbolTarget</span>&gt;();</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">hasOwnProperty</span> = (<span class="params">key: PropertyKey</span>) =&gt; fakeWindow.<span class="title function_">hasOwnProperty</span>(key) || globalContext.<span class="title function_">hasOwnProperty</span>(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(fakeWindow, &#123;</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">proxy</span> = proxy;</span><br><span class="line"></span><br><span class="line">    activeSandboxCount++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">registerRunningApp</span>(<span class="params">name: <span class="built_in">string</span>, proxy: Window</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sandboxRunning</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> currentRunningApp = <span class="title function_">getCurrentRunningApp</span>();</span><br><span class="line">      <span class="keyword">if</span> (!currentRunningApp || currentRunningApp.<span class="property">name</span> ! name) &#123;</span><br><span class="line">        <span class="title function_">setCurrentRunningApp</span>(&#123; name, <span class="attr">window</span>: proxy &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// FIXME if you have any other good ideas</span></span><br><span class="line">      <span class="comment">// remove the mark in next tick, thus we can identify whether it in micro app or not</span></span><br><span class="line">      <span class="comment">// this approach is just a workaround, it could not cover all complex cases, such as the micro app runs in the same task context with master in some case</span></span><br><span class="line">      <span class="title function_">nextTask</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setCurrentRunningApp</span>(<span class="literal">null</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here we temporarily do not see the role of the’latestSetProp, globalWhitelistPrevDescriptor ‘several variables, we continue to look at the various configurations in the Proxy:</p><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p>Set interception which will detect whether fakeWindow and globalContext have the current property to be modified, if so, then directly to fakeWindow on the property assignment, if not, only on globalContext, see if this property is writable or set method, only these two have one, it shows that the property itself can be modified, we add this property to fakeWindow and modify it is meaningful</p><p>At the same time, the set method will also check whether the currently modified property is one of the globalVariableWhiteList, and if so, add its descriptor to the globalWhitelistPrevDescriptor</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">set</span>: (<span class="attr">target</span>: <span class="title class_">FakeWindow</span>, <span class="attr">p</span>: <span class="title class_">PropertyKey</span>, <span class="attr">value</span>: <span class="built_in">any</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sandboxRunning</span>) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="title function_">registerRunningApp</span>(name, proxy);</span><br><span class="line">		<span class="comment">// We must keep its description while the property existed in globalContext before</span></span><br><span class="line">		<span class="keyword">if</span> (!target.<span class="title function_">hasOwnProperty</span>(p) &amp;&amp; globalContext.<span class="title function_">hasOwnProperty</span>(p)) &#123;</span><br><span class="line">			<span class="keyword">const</span> descriptor = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalContext, p);</span><br><span class="line">			<span class="keyword">const</span> &#123; writable, configurable, enumerable, set &#125; = descriptor!;</span><br><span class="line">			<span class="comment">// only writable property can be overwritten</span></span><br><span class="line">			<span class="comment">// here we ignored accessor descriptor of globalContext as it makes no sense to trigger its logic(which might make sandbox escaping instead)</span></span><br><span class="line">			<span class="comment">// we force to set value by data descriptor</span></span><br><span class="line">			<span class="keyword">if</span> (writable || set) &#123;</span><br><span class="line">				<span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, p, &#123; configurable, enumerable, <span class="attr">writable</span>: <span class="literal">true</span>, value &#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			target[p] = value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// sync the property to globalContext</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> p = <span class="string">&#x27;string&#x27;</span> &amp;&amp; globalVariableWhiteList.<span class="title function_">indexOf</span>(p) ! -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">globalWhitelistPrevDescriptor</span>[p] = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalContext, p);</span><br><span class="line">			<span class="comment">// @ts-ignore</span></span><br><span class="line">			globalContext[p] = value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		updatedValueSet.<span class="title function_">add</span>(p);</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">latestSetProp</span> = p;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`[qiankun] Set window.<span class="subst">$&#123;p.toString()&#125;</span> while sandbox destroyed or inactive in <span class="subst">$&#123;name&#125;</span>!`</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//In strict-mode, the handler.set of Proxy will throw a TypeError if it returns false, which should be ignored in the case of sandbox uninstallation</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>This get actually does a lot of testing. For example, if the property to be obtained is window or self, it returns the proxy itself. You can take a look at the following code for many specific branches</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">get</span>: (<span class="attr">target</span>: <span class="title class_">FakeWindow</span>, <span class="attr">p</span>: <span class="title class_">PropertyKey</span>): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="title function_">registerRunningApp</span>(name, proxy);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="title class_">Symbol</span>.<span class="property">unscopables</span>) <span class="keyword">return</span> unscopables;</span><br><span class="line">	<span class="comment">// avoid who using window.window or window.self to escape the sandbox environment to touch the really window</span></span><br><span class="line">	<span class="comment">// see https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13</span></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="string">&#x27;window&#x27;</span> || p = <span class="string">&#x27;self&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// hijack globalWindow accessing with globalThis keyword</span></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="string">&#x27;globalThis&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> proxy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (</span><br><span class="line">		p = <span class="string">&#x27;top&#x27;</span> ||</span><br><span class="line">		p = <span class="string">&#x27;parent&#x27;</span> ||</span><br><span class="line">		(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;test&#x27;</span> &amp;&amp; (p = <span class="string">&#x27;mockTop&#x27;</span> || p = <span class="string">&#x27;mockSafariTop&#x27;</span>))</span><br><span class="line">	) &#123;</span><br><span class="line">		<span class="comment">// if your master app in an iframe context, allow these props escape the sandbox</span></span><br><span class="line">		<span class="keyword">if</span> (globalContext = globalContext.<span class="property">parent</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> proxy;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (globalContext <span class="keyword">as</span> <span class="built_in">any</span>)[p];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proxy.hasOwnProperty would invoke getter firstly, then its value represented as globalContext.hasOwnProperty</span></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="string">&#x27;hasOwnProperty&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> hasOwnProperty;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="string">&#x27;document&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">document</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p = <span class="string">&#x27;eval&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">eval</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> actualTarget = propertiesWithGetter.<span class="title function_">has</span>(p) ? globalContext : p <span class="keyword">in</span> target ? target : globalContext;</span><br><span class="line">	<span class="keyword">const</span> value = actualTarget[p];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// frozen value should return directly, see https://github.com/umijs/qiankun/issues/2015</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_">isPropertyFrozen</span>(actualTarget, p)) &#123;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Some dom api must be bound to native window, otherwise it would cause exception like &#x27;TypeError: Failed to execute &#x27;fetch&#x27; on &#x27;Window&#x27;: Illegal invocation&#x27;</span></span><br><span class="line"><span class="comment">			See this code:</span></span><br><span class="line"><span class="comment">				const proxy = new Proxy(window, &#123;&#125;);</span></span><br><span class="line"><span class="comment">				const proxyFetch = fetch.bind(proxy);</span></span><br><span class="line"><span class="comment">				proxyFetch(&#x27;https://qiankun.com&#x27;);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">const</span> boundTarget = useNativeWindowForBindingsProps.<span class="title function_">get</span>(p) ? nativeGlobal : globalContext;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">getTargetValue</span>(boundTarget, value);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h4 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">has</span>(<span class="attr">target</span>: <span class="title class_">FakeWindow</span>, <span class="attr">p</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> p <span class="keyword">in</span> unscopables || p <span class="keyword">in</span> target || p <span class="keyword">in</span> globalContext;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="title function_">getOwnPropertyDescriptor</span>(<span class="attr">target</span>: <span class="title class_">FakeWindow</span>, <span class="attr">p</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span>): <span class="title class_">PropertyDescriptor</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		as the descriptor of top/self/window/mockTop in raw window are configurable but not in proxy target, we need to get it from target to avoid TypeError</span></span><br><span class="line"><span class="comment">		see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/getOwnPropertyDescriptor</span></span><br><span class="line"><span class="comment">		&gt; A property cannot be reported as non-configurable, if it does not exists as an own property of the target object or if it exists as a configurable own property of the target object.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">if</span> (target.<span class="title function_">hasOwnProperty</span>(p)) &#123;</span><br><span class="line">		<span class="keyword">const</span> descriptor = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(target, p);</span><br><span class="line">		descriptorTargetMap.<span class="title function_">set</span>(p, <span class="string">&#x27;target&#x27;</span>);</span><br><span class="line">		<span class="keyword">return</span> descriptor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (globalContext.<span class="title function_">hasOwnProperty</span>(p)) &#123;</span><br><span class="line">		<span class="keyword">const</span> descriptor = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(globalContext, p);</span><br><span class="line">		descriptorTargetMap.<span class="title function_">set</span>(p, <span class="string">&#x27;globalContext&#x27;</span>);</span><br><span class="line">		<span class="comment">// A property cannot be reported as non-configurable, if it does not exists as an own property of the target object</span></span><br><span class="line">		<span class="keyword">if</span> (descriptor &amp;&amp; !descriptor.<span class="property">configurable</span>) &#123;</span><br><span class="line">			descriptor.<span class="property">configurable</span> = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> descriptor;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// trap to support iterator with sandbox</span></span><br><span class="line"><span class="title function_">ownKeys</span>(<span class="attr">target</span>: <span class="title class_">FakeWindow</span>): <span class="title class_">ArrayLike</span>&lt;<span class="built_in">string</span> | <span class="built_in">symbol</span>&gt; &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_">uniq</span>(<span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(globalContext).<span class="title function_">concat</span>(<span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(target)));</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="title function_">defineProperty</span>(<span class="attr">target</span>: <span class="title class_">Window</span>, <span class="attr">p</span>: <span class="title class_">PropertyKey</span>, <span class="attr">attributes</span>: <span class="title class_">PropertyDescriptor</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">from</span> = descriptorTargetMap.<span class="title function_">get</span>(p);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">		Descriptor must be defined to native window while it comes from native window via Object.getOwnPropertyDescriptor(window, p),</span></span><br><span class="line"><span class="comment">		otherwise it would cause a TypeError with illegal invocation.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">	<span class="keyword">switch</span> (<span class="keyword">from</span>) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;globalContext&#x27;</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">defineProperty</span>(globalContext, p, attributes);</span><br><span class="line">		<span class="attr">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">defineProperty</span>(target, p, attributes);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="attr">deleteProperty</span>: (<span class="attr">target</span>: <span class="title class_">FakeWindow</span>, <span class="attr">p</span>: <span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">symbol</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="title function_">registerRunningApp</span>(name, proxy);</span><br><span class="line">	<span class="keyword">if</span> (target.<span class="title function_">hasOwnProperty</span>(p)) &#123;</span><br><span class="line">		<span class="comment">// @ts-ignore</span></span><br><span class="line">		<span class="keyword">delete</span> target[p];</span><br><span class="line">		updatedValueSet.<span class="title function_">delete</span>(p);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// makes sure `window instanceof Window` returns truthy in micro app</span></span><br><span class="line"><span class="title function_">getPrototypeOf</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">getPrototypeOf</span>(globalContext);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h3 id="patchers"><a href="#patchers" class="headerlink" title="patchers"></a>patchers</h3><h4 id="Hijacking-interval"><a href="#Hijacking-interval" class="headerlink" title="Hijacking interval"></a>Hijacking interval</h4><p>This part of the function is mainly used to intercept the timers during the running of the sandbox, collect which timers, and be able to clear all timers when the sandbox exits</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rawWindowInterval = <span class="variable language_">window</span>.<span class="property">setInterval</span>;</span><br><span class="line"><span class="keyword">const</span> rawWindowClearInterval = <span class="variable language_">window</span>.<span class="property">clearInterval</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params"><span class="variable language_">global</span>: Window</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">intervals</span>: <span class="built_in">number</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">global</span>.<span class="property">clearInterval</span> = <span class="function">(<span class="params">intervalId: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    intervals = intervals.<span class="title function_">filter</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> id ! intervalId);</span><br><span class="line">    <span class="keyword">return</span> rawWindowClearInterval.<span class="title function_">call</span>(<span class="variable language_">window</span>, intervalId <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">global</span>.<span class="property">setInterval</span> = <span class="function">(<span class="params">handler: CallableFunction, timeout?: <span class="built_in">number</span>, ...args: <span class="built_in">any</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> intervalId = <span class="title function_">rawWindowInterval</span>(handler, timeout, ...args);</span><br><span class="line">    intervals = [...intervals, intervalId];</span><br><span class="line">    <span class="keyword">return</span> intervalId;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">free</span>(<span class="params"></span>) &#123;</span><br><span class="line">    intervals.<span class="title function_">forEach</span>(<span class="function">(<span class="params">id</span>) =&gt;</span> <span class="variable language_">global</span>.<span class="built_in">clearInterval</span>(id));</span><br><span class="line">    <span class="variable language_">global</span>.<span class="property">setInterval</span> = rawWindowInterval;</span><br><span class="line">    <span class="variable language_">global</span>.<span class="property">clearInterval</span> = rawWindowClearInterval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> noop;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Hijacking-eventListener"><a href="#Hijacking-eventListener" class="headerlink" title="Hijacking eventListener"></a>Hijacking eventListener</h4><p>This function is the same as hijacking interval, hijacking all eventListeners, collecting all event listeners, and providing a function to clear all event listeners when the sandbox exits</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rawAddEventListener = <span class="variable language_">window</span>.<span class="property">addEventListener</span>;</span><br><span class="line"><span class="keyword">const</span> rawRemoveEventListener = <span class="variable language_">window</span>.<span class="property">removeEventListener</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params"><span class="variable language_">global</span>: WindowProxy</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> listenerMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">EventListenerOrEventListenerObject</span>[]&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">global</span>.<span class="property">addEventListener</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">type</span>: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    listener: EventListenerOrEventListenerObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    options?: <span class="built_in">boolean</span> | AddEventListenerOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = listenerMap.<span class="title function_">get</span>(<span class="keyword">type</span>) || [];</span><br><span class="line">    listenerMap.<span class="title function_">set</span>(<span class="keyword">type</span>, [...listeners, listener]);</span><br><span class="line">    <span class="keyword">return</span> rawAddEventListener.<span class="title function_">call</span>(<span class="variable language_">window</span>, <span class="keyword">type</span>, listener, options);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">global</span>.<span class="property">removeEventListener</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">type</span>: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    listener: EventListenerOrEventListenerObject,</span></span></span><br><span class="line"><span class="params"><span class="function">    options?: <span class="built_in">boolean</span> | AddEventListenerOptions,</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> storedTypeListeners = listenerMap.<span class="title function_">get</span>(<span class="keyword">type</span>);</span><br><span class="line">    <span class="keyword">if</span> (storedTypeListeners &amp;&amp; storedTypeListeners.<span class="property">length</span> &amp;&amp; storedTypeListeners.<span class="title function_">indexOf</span>(listener) ! -<span class="number">1</span>) &#123;</span><br><span class="line">      storedTypeListeners.<span class="title function_">splice</span>(storedTypeListeners.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rawRemoveEventListener.<span class="title function_">call</span>(<span class="variable language_">window</span>, <span class="keyword">type</span>, listener, options);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">free</span>(<span class="params"></span>) &#123;</span><br><span class="line">    listenerMap.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listeners, <span class="keyword">type</span></span>) =&gt;</span></span><br><span class="line">      [...listeners].<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> <span class="variable language_">global</span>.<span class="title function_">removeEventListener</span>(<span class="keyword">type</span>, listener)),</span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">global</span>.<span class="property">addEventListener</span> = rawAddEventListener;</span><br><span class="line">    <span class="variable language_">global</span>.<span class="property">removeEventListener</span> = rawRemoveEventListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> noop;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Hijacking-historyListener-against-umi-framework"><a href="#Hijacking-historyListener-against-umi-framework" class="headerlink" title="Hijacking historyListener (against umi framework)"></a>Hijacking historyListener (against umi framework)</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isFunction, noop &#125; <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// FIXME umi unmount feature request</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span></span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">rawHistoryListen</span> = (<span class="params">_: <span class="built_in">any</span></span>) =&gt; noop;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">historyListeners</span>: <span class="title class_">Array</span>&lt;<span class="keyword">typeof</span> noop&gt; = [];</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">historyUnListens</span>: <span class="title class_">Array</span>&lt;<span class="keyword">typeof</span> noop&gt; = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span> &amp;&amp; <span class="title function_">isFunction</span>((<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="property">listen</span>)) &#123;</span><br><span class="line">    rawHistoryListen = (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="property">listen</span>.<span class="title function_">bind</span>((<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>);</span><br><span class="line"></span><br><span class="line">    (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="property">listen</span> = <span class="function">(<span class="params">listener: <span class="keyword">typeof</span> noop</span>) =&gt;</span> &#123;</span><br><span class="line">      historyListeners.<span class="title function_">push</span>(listener);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> unListen = <span class="title function_">rawHistoryListen</span>(listener);</span><br><span class="line">      historyUnListens.<span class="title function_">push</span>(unListen);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">unListen</span>();</span><br><span class="line">        historyUnListens.<span class="title function_">splice</span>(historyUnListens.<span class="title function_">indexOf</span>(unListen), <span class="number">1</span>);</span><br><span class="line">        historyListeners.<span class="title function_">splice</span>(historyListeners.<span class="title function_">indexOf</span>(listener), <span class="number">1</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">free</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> rebuild = noop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     There is also a margin for the listener to indicate that it has not been unloaded, there are two cases</span></span><br><span class="line"><span class="comment">     1. App does not properly uninstall listener when unmout</span></span><br><span class="line"><span class="comment">     2. listener is bound before applying mount.</span></span><br><span class="line"><span class="comment">     In the second case, the application needs to rebind the listener before the next mount.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (historyListeners.<span class="property">length</span>) &#123;</span><br><span class="line">      rebuild = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//The listener must be rebound using window.g_history listen to ensure that the rebuild part can also be captured, otherwise this part of the side effect cannot be properly removed after the application is uninstalled</span></span><br><span class="line">        historyListeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">listener</span>) =&gt;</span> (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="title function_">listen</span>(listener));</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//uninstall the remaining listeners</span></span><br><span class="line">    historyUnListens.<span class="title function_">forEach</span>(<span class="function">(<span class="params">unListen</span>) =&gt;</span> <span class="title function_">unListen</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restore</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span> &amp;&amp; <span class="title function_">isFunction</span>((<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="property">listen</span>)) &#123;</span><br><span class="line">      (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">g_history</span>.<span class="property">listen</span> = rawHistoryListen;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rebuild;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">patchLooseSandbox</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  appWrapperGetter: () =&gt; HTMLElement | ShadowRoot,</span></span><br><span class="line"><span class="params">  proxy: Window,</span></span><br><span class="line"><span class="params">  mounting = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">  scopedCSS = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Freer</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">dynamicStyleSheetElements</span>: <span class="title class_">Array</span>&lt;<span class="title class_">HTMLLinkElement</span> | <span class="title class_">HTMLStyleElement</span>&gt; = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDynamicAppendPrototypeFunctions = <span class="title function_">patchHTMLDynamicAppendPrototypeFunctions</span>(</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      check if the currently specified application is active</span></span><br><span class="line"><span class="comment">      While we switch page from qiankun app to a normal react routing page, the normal one may load stylesheet dynamically while page rendering,</span></span><br><span class="line"><span class="comment">      but the url change listener must to wait until the current call stack is flushed.</span></span><br><span class="line"><span class="comment">      This scenario may cause we record the stylesheet from react routing page dynamic injection,</span></span><br><span class="line"><span class="comment">      and remove them after the url change triggered and qiankun app is unmouting</span></span><br><span class="line"><span class="comment">      see https://github.com/ReactTraining/history/blob/master/modules/createHashHistory.js#L222-L230</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">checkActivityFunctions</span>(<span class="variable language_">window</span>.<span class="property">location</span>).<span class="title function_">some</span>(<span class="function">(<span class="params">name</span>) =&gt;</span> name = appName),</span><br><span class="line">    <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">      appName,</span><br><span class="line">      appWrapperGetter,</span><br><span class="line">      proxy,</span><br><span class="line">      <span class="attr">strictGlobal</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">speedySandbox</span>: <span class="literal">false</span>,</span><br><span class="line">      scopedCSS,</span><br><span class="line">      dynamicStyleSheetElements,</span><br><span class="line">      excludeAssetFilter,</span><br><span class="line">    &#125;),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;increase&#x27;</span>, <span class="string">&#x27;bootstrapping&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;increase&#x27;</span>, <span class="string">&#x27;mounting&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">free</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;decrease&#x27;</span>, <span class="string">&#x27;bootstrapping&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;decrease&#x27;</span>, <span class="string">&#x27;mounting&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the overwrite prototype after all the micro apps unmounted</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isAllAppsUnmounted</span>()) <span class="title function_">unpatchDynamicAppendPrototypeFunctions</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordStyledComponentsCSSRules</span>(dynamicStyleSheetElements);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// As now the sub app content all wrapped with a special id container,</span></span><br><span class="line">    <span class="comment">// the dynamic style sheet would be removed automatically while unmoutting</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">rebuild</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">rebuildCSSRules</span>(dynamicStyleSheetElements, <span class="function">(<span class="params">stylesheetElement</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> appWrapper = <span class="title function_">appWrapperGetter</span>();</span><br><span class="line">        <span class="keyword">if</span> (!appWrapper.<span class="title function_">contains</span>(stylesheetElement)) &#123;</span><br><span class="line">          <span class="comment">// Using document.head.appendChild ensures that appendChild invocation can also directly use the HTMLHeadElement.prototype.appendChild method which is overwritten at mounting phase</span></span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">head</span>.<span class="property">appendChild</span>.<span class="title function_">call</span>(appWrapper, stylesheetElement);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// As the patcher will be invoked every mounting phase, we could release the cache for gc after rebuilding</span></span><br><span class="line">      <span class="keyword">if</span> (mounting) &#123;</span><br><span class="line">        dynamicStyleSheetElements = [];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Get native global window with a sandbox disgusted way, thus we could share it between qiankun instances🤪</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(nativeGlobal, <span class="string">&#x27;__proxyAttachContainerConfigMap__&#x27;</span>, &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">writable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Share proxyAttachContainerConfigMap between multiple qiankun instance, thus they could access the same record</span></span><br><span class="line">nativeGlobal.<span class="property">__proxyAttachContainerConfigMap__</span> =</span><br><span class="line">  nativeGlobal.<span class="property">__proxyAttachContainerConfigMap__</span> || <span class="keyword">new</span> <span class="title class_">WeakMap</span>&lt;<span class="title class_">WindowProxy</span>, <span class="title class_">ContainerConfig</span>&gt;();</span><br><span class="line"><span class="keyword">const</span> <span class="attr">proxyAttachContainerConfigMap</span>: <span class="title class_">WeakMap</span>&lt;<span class="title class_">WindowProxy</span>, <span class="title class_">ContainerConfig</span>&gt; =</span><br><span class="line">  nativeGlobal.<span class="property">__proxyAttachContainerConfigMap__</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> elementAttachContainerConfigMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>&lt;<span class="title class_">HTMLElement</span>, <span class="title class_">ContainerConfig</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> docCreatePatchedMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>&lt;<span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">createElement</span>, <span class="keyword">typeof</span> <span class="variable language_">document</span>.<span class="property">createElement</span>&gt;();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchDocumentCreateElement</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> docCreateElementFnBeforeOverwrite = docCreatePatchedMap.<span class="title function_">get</span>(<span class="variable language_">document</span>.<span class="property">createElement</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!docCreateElementFnBeforeOverwrite) &#123;</span><br><span class="line">    <span class="keyword">const</span> rawDocumentCreateElement = <span class="variable language_">document</span>.<span class="property">createElement</span>;</span><br><span class="line">    <span class="title class_">Document</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">createElement</span> = <span class="keyword">function</span> createElement&lt;K <span class="keyword">extends</span> keyof <span class="title class_">HTMLElementTagNameMap</span>&gt;(</span><br><span class="line">      <span class="attr">this</span>: <span class="title class_">Document</span>,</span><br><span class="line">      <span class="attr">tagName</span>: K,</span><br><span class="line">      options?: <span class="title class_">ElementCreationOptions</span>,</span><br><span class="line">    ): <span class="title class_">HTMLElement</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> element = rawDocumentCreateElement.<span class="title function_">call</span>(<span class="variable language_">this</span>, tagName, options);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isHijackingTag</span>(tagName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">window</span>: currentRunningSandboxProxy &#125; = <span class="title function_">getCurrentRunningApp</span>() || &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span> (currentRunningSandboxProxy) &#123;</span><br><span class="line">          <span class="keyword">const</span> proxyContainerConfig = proxyAttachContainerConfigMap.<span class="title function_">get</span>(currentRunningSandboxProxy);</span><br><span class="line">          <span class="keyword">if</span> (proxyContainerConfig) &#123;</span><br><span class="line">            elementAttachContainerConfigMap.<span class="title function_">set</span>(element, proxyContainerConfig);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> element;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It means it have been overwritten while createElement is an own property of document</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;createElement&#x27;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">createElement</span> = <span class="title class_">Document</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">createElement</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    docCreatePatchedMap.<span class="title function_">set</span>(<span class="title class_">Document</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">createElement</span>, rawDocumentCreateElement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unpatch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (docCreateElementFnBeforeOverwrite) &#123;</span><br><span class="line">      <span class="title class_">Document</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">createElement</span> = docCreateElementFnBeforeOverwrite;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="property">createElement</span> = docCreateElementFnBeforeOverwrite;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">patchStrictSandbox</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  appWrapperGetter: () =&gt; HTMLElement | ShadowRoot,</span></span><br><span class="line"><span class="params">  proxy: Window,</span></span><br><span class="line"><span class="params">  mounting = <span class="literal">true</span>,</span></span><br><span class="line"><span class="params">  scopedCSS = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span><br><span class="line"><span class="params">  speedySandbox = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Freer</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> containerConfig = proxyAttachContainerConfigMap.<span class="title function_">get</span>(proxy);</span><br><span class="line">  <span class="keyword">if</span> (!containerConfig) &#123;</span><br><span class="line">    containerConfig = &#123;</span><br><span class="line">      appName,</span><br><span class="line">      proxy,</span><br><span class="line">      appWrapperGetter,</span><br><span class="line">      <span class="attr">dynamicStyleSheetElements</span>: [],</span><br><span class="line">      <span class="attr">strictGlobal</span>: <span class="literal">true</span>,</span><br><span class="line">      speedySandbox,</span><br><span class="line">      excludeAssetFilter,</span><br><span class="line">      scopedCSS,</span><br><span class="line">    &#125;;</span><br><span class="line">    proxyAttachContainerConfigMap.<span class="title function_">set</span>(proxy, containerConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// all dynamic style sheets are stored in proxy container</span></span><br><span class="line">  <span class="keyword">const</span> &#123; dynamicStyleSheetElements &#125; = containerConfig;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDocumentCreate = <span class="title function_">patchDocumentCreateElement</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> unpatchDynamicAppendPrototypeFunctions = <span class="title function_">patchHTMLDynamicAppendPrototypeFunctions</span>(</span><br><span class="line">    <span class="function">(<span class="params">element</span>) =&gt;</span> elementAttachContainerConfigMap.<span class="title function_">has</span>(element),</span><br><span class="line">    <span class="function">(<span class="params">element</span>) =&gt;</span> elementAttachContainerConfigMap.<span class="title function_">get</span>(element)!,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;increase&#x27;</span>, <span class="string">&#x27;bootstrapping&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;increase&#x27;</span>, <span class="string">&#x27;mounting&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">free</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;decrease&#x27;</span>, <span class="string">&#x27;bootstrapping&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mounting) <span class="title function_">calcAppCount</span>(appName, <span class="string">&#x27;decrease&#x27;</span>, <span class="string">&#x27;mounting&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the overwritten prototype after all the micro apps unmounted</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isAllAppsUnmounted</span>()) &#123;</span><br><span class="line">      <span class="title function_">unpatchDynamicAppendPrototypeFunctions</span>();</span><br><span class="line">      <span class="title function_">unpatchDocumentCreate</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">recordStyledComponentsCSSRules</span>(dynamicStyleSheetElements);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// As now the sub app content all wrapped with a special id container,</span></span><br><span class="line">    <span class="comment">// the dynamic style sheet would be removed automatically while unmoutting</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">rebuild</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="title function_">rebuildCSSRules</span>(dynamicStyleSheetElements, <span class="function">(<span class="params">stylesheetElement</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> appWrapper = <span class="title function_">appWrapperGetter</span>();</span><br><span class="line">        <span class="keyword">if</span> (!appWrapper.<span class="title function_">contains</span>(stylesheetElement)) &#123;</span><br><span class="line">          <span class="keyword">const</span> mountDom =</span><br><span class="line">            stylesheetElement[styleElementTargetSymbol] = <span class="string">&#x27;head&#x27;</span> ? <span class="title function_">getAppWrapperHeadElement</span>(appWrapper) : appWrapper;</span><br><span class="line">          rawHeadAppendChild.<span class="title function_">call</span>(mountDom, stylesheetElement);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="patchers-1"><a href="#patchers-1" class="headerlink" title="patchers"></a>patchers</h4><p>Briefly summarize what Patcher does:</p><ul><li>During execution, some global timers or listeners or some global variables will be intercepted and counted, which we collectively refer to as side effects, and then return the free function to be called when the sub-application is unmounted (ie unmount)</li><li>The free function will clear the side effects counted in the previous part internally. At the same time, if some side effects need to be restarted when the next sub-application is reactivated, put them into the rebuild returned by the free function, and finally call rebuild when mount.</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Freer</span>, <span class="title class_">SandBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../interfaces&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">SandBoxType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../interfaces&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> css <span class="keyword">from</span> <span class="string">&#x27;./css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; patchLooseSandbox, patchStrictSandbox &#125; <span class="keyword">from</span> <span class="string">&#x27;./dynamicAppend&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> patchHistoryListener <span class="keyword">from</span> <span class="string">&#x27;./historyListener&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> patchInterval <span class="keyword">from</span> <span class="string">&#x27;./interval&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> patchWindowListener <span class="keyword">from</span> <span class="string">&#x27;./windowListener&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">patchAtMounting</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span><br><span class="line"><span class="params">  sandbox: SandBox,</span></span><br><span class="line"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span><br><span class="line"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Freer</span>[] &#123;</span><br><span class="line">  <span class="keyword">const</span> basePatchers = [</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">patchInterval</span>(sandbox.<span class="property">proxy</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">patchWindowListener</span>(sandbox.<span class="property">proxy</span>),</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">patchHistoryListener</span>(),</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> patchersInSandbox = &#123;</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">LegacyProxy</span>]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">patchLooseSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">true</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">Proxy</span>]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      <span class="function">() =&gt;</span></span><br><span class="line">        <span class="title function_">patchStrictSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">true</span>, scopedCSS, excludeAssetFilter, speedySandBox),</span><br><span class="line">    ],</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">Snapshot</span>]: [</span><br><span class="line">      ...basePatchers,</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">patchLooseSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">true</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> patchersInSandbox[sandbox.<span class="property">type</span>]?.<span class="title function_">map</span>(<span class="function">(<span class="params">patch</span>) =&gt;</span> <span class="title function_">patch</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">patchAtBootstrapping</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span><br><span class="line"><span class="params">  sandbox: SandBox,</span></span><br><span class="line"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  excludeAssetFilter?: CallableFunction,</span></span><br><span class="line"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Freer</span>[] &#123;</span><br><span class="line">  <span class="keyword">const</span> patchersInSandbox = &#123;</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">LegacyProxy</span>]: [</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">patchLooseSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">false</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">Proxy</span>]: [</span><br><span class="line">      <span class="function">() =&gt;</span></span><br><span class="line">        <span class="title function_">patchStrictSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">false</span>, scopedCSS, excludeAssetFilter, speedySandBox),</span><br><span class="line">    ],</span><br><span class="line">    [<span class="title class_">SandBoxType</span>.<span class="property">Snapshot</span>]: [</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">patchLooseSandbox</span>(appName, elementGetter, sandbox.<span class="property">proxy</span>, <span class="literal">false</span>, scopedCSS, excludeAssetFilter),</span><br><span class="line">    ],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> patchersInSandbox[sandbox.<span class="property">type</span>]?.<span class="title function_">map</span>(<span class="function">(<span class="params">patch</span>) =&gt;</span> <span class="title function_">patch</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; css &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Sandbox-collection"><a href="#Sandbox-collection" class="headerlink" title="Sandbox collection"></a>Sandbox collection</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Freer</span>, <span class="title class_">Rebuilder</span>, <span class="title class_">SandBox</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../interfaces&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">LegacySandbox</span> <span class="keyword">from</span> <span class="string">&#x27;./legacy/sandbox&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; patchAtBootstrapping, patchAtMounting &#125; <span class="keyword">from</span> <span class="string">&#x27;./patchers&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ProxySandbox</span> <span class="keyword">from</span> <span class="string">&#x27;./proxySandbox&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SnapshotSandbox</span> <span class="keyword">from</span> <span class="string">&#x27;./snapshotSandbox&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; getCurrentRunningApp &#125; <span class="keyword">from</span> <span class="string">&#x27;./common&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; css &#125; <span class="keyword">from</span> <span class="string">&#x27;./patchers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generate application runtime sandbox</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are two types of sandboxes:</span></span><br><span class="line"><span class="comment"> * 1. app environment sandbox</span></span><br><span class="line"><span class="comment"> * The app environment sandbox refers to the context in which the application will run after initialization. The environment sandbox of each application will only be initialized once, because the child application will only trigger bootstrap once.</span></span><br><span class="line"><span class="comment"> When switching sub-applications, what is actually switched is the app environment sandbox.</span></span><br><span class="line"><span class="comment"> * 2. render sandbox</span></span><br><span class="line"><span class="comment"> * The sub-application generates a sandbox before the app mount starts. After each sub-application switch, the render sandbox will reproduce and initialize.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> The purpose of this design is to ensure that each sub-application can run in the environment after applying bootstrap after switching back.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">appName</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">elementGetter</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">scopedCSS</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">useLooseSandbox</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">excludeAssetFilter</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">globalContext</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">speedySandBox</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createSandboxContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  appName: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  elementGetter: () =&gt; HTMLElement | ShadowRoot,</span></span><br><span class="line"><span class="params">  scopedCSS: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  useLooseSandbox?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  excludeAssetFilter?: (url: <span class="built_in">string</span>) =&gt; <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  globalContext?: <span class="keyword">typeof</span> <span class="variable language_">window</span>,</span></span><br><span class="line"><span class="params">  speedySandBox?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">sandbox</span>: <span class="title class_">SandBox</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Proxy</span>) &#123;</span><br><span class="line">    sandbox = useLooseSandbox ? <span class="keyword">new</span> <span class="title class_">LegacySandbox</span>(appName, globalContext) : <span class="keyword">new</span> <span class="title class_">ProxySandbox</span>(appName, globalContext);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sandbox = <span class="keyword">new</span> <span class="title class_">SnapshotSandbox</span>(appName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// some side effect could be be invoked while bootstrapping, such as dynamic stylesheet injection with style-loader, especially during the development phase</span></span><br><span class="line">  <span class="keyword">const</span> bootstrappingFreers = <span class="title function_">patchAtBootstrapping</span>(</span><br><span class="line">    appName,</span><br><span class="line">    elementGetter,</span><br><span class="line">    sandbox,</span><br><span class="line">    scopedCSS,</span><br><span class="line">    excludeAssetFilter,</span><br><span class="line">    speedySandBox,</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// mounting freers are one-off and should be re-init at every mounting time</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">mountingFreers</span>: <span class="title class_">Freer</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">sideEffectsRebuilders</span>: <span class="title class_">Rebuilder</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">instance</span>: sandbox,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sandbox is mounted</span></span><br><span class="line"><span class="comment">     * Possibly mount entered from bootstrap state</span></span><br><span class="line"><span class="comment">     It may also wake up from unmount and enter mount again.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">mount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">/* ------------------------------------------ because of the context dependency (window), the following code execution order cannot be changed ------------------------------------------ */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 1. Start/Restore, Sandbox ------------------------------------------ */</span></span><br><span class="line">      sandbox.<span class="title function_">active</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtBootstrapping = sideEffectsRebuilders.<span class="title function_">slice</span>(<span class="number">0</span>, bootstrappingFreers.<span class="property">length</span>);</span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtMounting = sideEffectsRebuilders.<span class="title function_">slice</span>(bootstrappingFreers.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// must rebuild the side effects which added at bootstrapping firstly to recovery to nature state</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtBootstrapping.<span class="property">length</span>) &#123;</span><br><span class="line">        sideEffectsRebuildersAtBootstrapping.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rebuild</span>) =&gt;</span> <span class="title function_">rebuild</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 2. Enable global variable patch ------------------------------------------*/</span></span><br><span class="line">      <span class="comment">//When the render sandbox starts, it starts hijacking various global listeners. Try not to have side effects such as event listeners/timers during the application initialization phase</span></span><br><span class="line">      mountingFreers = <span class="title function_">patchAtMounting</span>(appName, elementGetter, sandbox, scopedCSS, excludeAssetFilter, speedySandBox);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------------------------------------------ 3. Reset some initialization side effects ------------------------------------------*/</span></span><br><span class="line">      <span class="comment">//The presence of a rebuilder indicates that some side effects need to be rebuilt</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtMounting.<span class="property">length</span>) &#123;</span><br><span class="line">        sideEffectsRebuildersAtMounting.<span class="title function_">forEach</span>(<span class="function">(<span class="params">rebuild</span>) =&gt;</span> <span class="title function_">rebuild</span>());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// clean up rebuilders</span></span><br><span class="line">      sideEffectsRebuilders = [];</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     Restore the global state so that it can return to the state before the application loaded</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// record the rebuilders of window side effects (event listeners or timers)</span></span><br><span class="line">      <span class="comment">// note that the frees of mounting phase are one-off as it will be re-init at next mounting</span></span><br><span class="line">      sideEffectsRebuilders = [...bootstrappingFreers, ...mountingFreers].<span class="title function_">map</span>(<span class="function">(<span class="params">free</span>) =&gt;</span> <span class="title function_">free</span>());</span><br><span class="line"></span><br><span class="line">      sandbox.<span class="title function_">inactive</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/" title="micro frontend Qiankun sandbox principle">https://sunra.top/en/2022/11/22/micro-frontend-qiankun-sandbox/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2022/11/19/javascript-design-parttern-1/" rel="prev" title="JavaScript Design pattern learning and practice (1)"><i class="fa fa-chevron-left"></i> JavaScript Design pattern learning and practice (1)</a></div><div class="post-nav-item"> <a href="/en/2022/11/24/micro-frontend-qiankun-code/" rel="next" title="micro frontend framework Qiankun source code analysis">micro frontend framework Qiankun source code analysis<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2022/11/22/micro-frontend-qiankun-sandbox/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>