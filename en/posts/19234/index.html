<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="At present, there are more and more web IDE products running on the browser side. According to their functional characteristics, the current web IDE can be divided into two types. One is to migrate th"><meta property="og:type" content="article"><meta property="og:title" content="How codesandbox runs the npm module in the browser"><meta property="og:url" content="https://sunra.top/en/posts/19234/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="At present, there are more and more web IDE products running on the browser side. According to their functional characteristics, the current web IDE can be divided into two types. One is to migrate th"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621126841/origin-of-ray/1574822062018-7c62e623-e99b-43c1-80a4-a0eba2c3dfdb_ikivwp.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621468814/origin-of-ray/packager1_qabrps.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621128800/origin-of-ray/codesandbox-arch_b64xm7.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469497/origin-of-ray/packager2_pk7goe.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469683/origin-of-ray/editor-vs-compiler_m9eo6p.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469733/origin-of-ray/compiler_cgbsyb.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621470036/origin-of-ray/evaluation_gseiqz.png"><meta property="article:published_time" content="2021-05-14T00:01:33.000Z"><meta property="article:modified_time" content="2024-05-03T00:22:12.472Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621126841/origin-of-ray/1574822062018-7c62e623-e99b-43c1-80a4-a0eba2c3dfdb_ikivwp.png"><link rel="canonical" href="https://sunra.top/en/posts/19234/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/19234/","path":"posts/19234/","title":"How codesandbox runs the npm module in the browser"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>How codesandbox runs the npm module in the browser | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Content-organization"><span class="nav-number">1.</span> <span class="nav-text">Content organization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#First-version"><span class="nav-number">2.</span> <span class="nav-text">First version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webpack-version"><span class="nav-number">3.</span> <span class="nav-text">Webpack version</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webpack-with-entrance"><span class="nav-number">4.</span> <span class="nav-text">Webpack with entrance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-Serverless"><span class="nav-number">5.</span> <span class="nav-text">Access Serverless</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#What-is-Serverless"><span class="nav-number">5.1.</span> <span class="nav-text">What is Serverless?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-to-combine-serverless"><span class="nav-number">5.2.</span> <span class="nav-text">How to combine serverless</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Join-browser-cache"><span class="nav-number">6.</span> <span class="nav-text">Join browser cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final-version"><span class="nav-number">7.</span> <span class="nav-text">Final version</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-build-process"><span class="nav-number">7.1.</span> <span class="nav-text">Project build process</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Packer"><span class="nav-number">7.1.1.</span> <span class="nav-text">Packer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Transpilation"><span class="nav-number">7.1.2.</span> <span class="nav-text">Transpilation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Evaluation"><span class="nav-number">7.1.3.</span> <span class="nav-text">Evaluation</span></a></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/19234/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="How codesandbox runs the npm module in the browser | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> How codesandbox runs the npm module in the browser</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-05-14 08:01:33" itemprop="dateCreated datePublished" datetime="2021-05-14T08:01:33+08:00">2021-05-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-05-03 08:22:12" itemprop="dateModified" datetime="2024-05-03T08:22:12+08:00">2024-05-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/19234/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/19234/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>At present, there are more and more web IDE products running on the browser side. According to their functional characteristics, the current web IDE can be divided into two types. One is to migrate the functions of the local IDE basically intact. To the IDE on the web side, such as the most popular front-end IDE VS Code, with the help of cloud + containerization capabilities, VS Code has almost exactly the same functions as the local IDE on the browser side; there is also a web IDE that is more Focus on the presentation of’page development and real-time code parsing, compiling, and previewing ‘, and the implementation of code packaging and construction It is not limited to the implementation at the server level (such as based on Docker containers, etc.). Some products implement the functions of’compile, package, build, and run ‘based on browser-side code, and all of this is only based on our original development system.’ Local IDE + Node local build, local service + browser access preview ‘has the ability. Representatives of such products are CodeSandbox, codepen, StackBlitz, JSFiddle, etc.</p><p>That is to say, the former just puts the code editing on the web segment. In fact, it uses the cloud to store the code, compile the project, package and run it, etc. In this way, what we finally get is no different from local development. The difference is that we don’t have to specially download an editor.</p><p>The latter is a part of the compile packaging function and the final run in the browser, and due to the limitations of the browser, the size of the application it can support is limited (PS: recently encountered a problem, see the error should be Code size exceeds 500K, leave a pit, leave it to be solved later, hehe)</p><span id="more"></span><p>Can be’similar to the ability to build based on local webpack packaging ‘migrated to the browser side seems to be a very incredible thing, the above has also been mentioned, there are often two ways to achieve, one is based on the server side of the webpack packaging build, after the build will build the code and then transferred to the browser side parsing execution, related practices such as:<a target="_blank" rel="external nofollow noopener noreferrer" href="https://juejin.im/entry/5a372e6a6fb9a0450f220711">基于webpack打造前端在线编译器</a>Another implementation is to provide the code of the dependent package (pulled from the npm installation) at the server level and return it to the Client. The packaging build is completely implemented on the browser side, implementing the’webpack ‘on the browser side. For example, CodeSandbox is the implementation of this pattern. Today we will take a look at the introduction of this article by the author of CodeSandbox, how all this is achieved.</p><blockquote><p>Note here that the implementation of codesandbox has gone through multiple iterations, but only how the server level provides dependencies has changed. After loading dependencies from the server level, they are returned to the client for use.</p></blockquote><h2 id="Content-organization"><a href="#Content-organization" class="headerlink" title="Content organization"></a>Content organization</h2><p>Because many of the contents below are translated from the original text of the codesandbox author, some places are difficult to understand, I will sort out the whole process first</p><ul><li>In the first version, you need to download the dependencies to the local in advance, analyze the required dependencies dynamically at runtime, and then require the required dependencies to be downloaded by the stub local implementation, not only can not support all dependencies, but also the recursion analysis performance has a bottleneck</li><li>With the idea of webpack DllPlugin, first send the dependency to the background, according to the hash of the dependency, find whether there is a cache in the background, if not, analyze the dependency, download it through yarn, and then package it into a dll and send it back to the caller. One problem with this version is that if it is not clearly defined in the dependency relationship, it cannot be packaged, and the cache is based on the dependency relationship. If there is the same package in two different dependency trees, it will not be reused</li><li>In order to solve the first problem of the above version, the author implemented a webpack packer that can add its own entrance</li><li>In order to solve the second problem, the author combines serverless and splits the dependencies. The server caches independent dependencies one by one. The server just returns the downloaded dependencies to the front end. The real responsibility for packaging is the front end, so that the front end can achieve on-demand packaging, which cannot be achieved on the back end because there is no actual code on the back end, so there is no such “need”.</li><li>Then in order to achieve the offline version, the author made another layer of caching on the front end</li><li>At this point, the codesandbox we are currently using is implemented</li></ul><h2 id="First-version"><a href="#First-version" class="headerlink" title="First version"></a>First version</h2><p>This version of codesandbox just implements an algorithm by itself, using a loading method similar to require to load dependencies one by one to the local (I personally think this local should refer to the user’s personal browser). The author of codesandbox personally believes that the first version cannot be regarded as full support for npm.</p><p>That is to say, this version does not load dependencies from the npm repository in real time according to the dependencies in the code, but downloads the dependencies to the local in advance, and then stubs the require in the code, so the author says that this version does not support all npm dependencies.</p><p>And this version should be specifically require a time to analyze what a depends on, and then layer by layer recursion, this kind of recursion if the project depends on complex, performance also has a big bottleneck.</p><blockquote><p>This</p><p>Even</p></blockquote><h2 id="Webpack-version"><a href="#Webpack-version" class="headerlink" title="Webpack version"></a>Webpack version</h2><p>The first version authors thought that full support for npm was impossible until someone actually implemented it.</p><p>So the author is considering how to achieve the general, he began to design an algorithm, but this algorithm is more complex, and ultimately there is no actual use, I will not repeat, interested can see the reference link at the end of the article.</p><p>Then, the author refers to the implementation of the DLLPlugin plugin of webpack.</p><p>Simply put, what DllPlugin does is to package a project into a dll dependency, wrap the dependencies in the project in the dll, and then expose the interface to the outside world. This is the official doc address:<a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.docschina.org/plugins/dll-plugin/#root">DllPlugin文档</a></p><p>Webpack’s<a target="_blank" rel="external nofollow noopener noreferrer" href="https://webpack.js.org/plugins/dll-plugin/">DLLPlugin</a>Dependencies can be packaged, and a manifest list is used to mark which dependencies are included in the typed js package. The list looks like this:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dll_bundle&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/fbjs/lib/emptyFunction.js&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/fbjs/lib/invariant.js&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/fbjs/lib/warning.js&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/react&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/fbjs/lib/emptyObject.js&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/object-assign/index.js&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/prop-types/checkPropTypes.js&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/prop-types/lib/ReactPropTypesSecret.js&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;./node_modules/react/cjs/react.development.js&quot;</span><span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Each path maps a module id. If I wanted to introduce React, I’d just call dll_bundle (3) and I’d have React! This is perfect for requirements,</p><p>So the author started to act, based on the idea of Webpack DllPlugin, and came up with the following system:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621126841/origin-of-ray/1574822062018-7c62e623-e99b-43c1-80a4-a0eba2c3dfdb_ikivwp.png" alt></p><p>For each request that is packaged, I will create a new directory under’tmp/: hash ‘, then run’yarn add ${dependencyList}’, and then let’webpack ‘do the packaging process. At the same time, as a caching solution, I will save the new package to gcloud. This looks much simpler than the scheme diagram above, more because I use yarn to install dependencies and use’webpack’ for packaging as an alternative to the previous implementation.</p><blockquote><p>It may be a little difficult to understand here. Let me tell you my opinion. In the previous version, that is, the first version, codesandbox needs to download the dependencies to the local in advance, and then when it really runs to require, it will analyze the dependencies recursively., and then require to stub to the local downloaded dependencies</p><p>And this version, with the help of webpack</p></blockquote><p>However, this system still has a very big limitation, it does not support the introduction of files that are not in the webpack dependency diagram. This means something like the following example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;react-icons/lib/fa/fa-beer&#x27;</span>)</span><br></pre></td></tr></table></figure><p>Will not work properly, because it is not needed from the beginning to the end of the dependency entry, and will not be packaged in it. (The packaging of webpack is based on the dependent modules in package.json and the dependencies of each dependent module. Files that are not included in this system will not be packaged)</p><h2 id="Webpack-with-entrance"><a href="#Webpack-with-entrance" class="headerlink" title="Webpack with entrance"></a>Webpack with entrance</h2><p>In order to solve the limitation just mentioned, that is, files that are not in the webpack dependency cannot be packaged into the final dll.</p><p>Manually added the entry configuration to ensure that’webpack ‘can also pack these files into it. After a lot of adjustments to this scheme, the system can now support any (? Translator’s Note: The author added a question mark here, indicating that he is not sure about supporting any) combination of packaging requirements. So you can also load react-icons, css files are also possible.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621468814/origin-of-ray/packager1_qabrps.png" alt></p><h2 id="Access-Serverless"><a href="#Access-Serverless" class="headerlink" title="Access Serverless"></a>Access Serverless</h2><h3 id="What-is-Serverless"><a href="#What-is-Serverless" class="headerlink" title="What is Serverless?"></a>What is Serverless?</h3><p>Based on serverless, you can define a function that will trigger execution when the server is requested: the function will be started first, then process the request, and kill and release itself after a period of time. This also means that you will have very high scalability: if your server has 1000 requests coming at the same time, you can start 1000 services immediately. This also means that you only need to pay for the actual running time.</p><h3 id="How-to-combine-serverless"><a href="#How-to-combine-serverless" class="headerlink" title="How to combine serverless"></a>How to combine serverless</h3><p>Serverless sounds perfect for our service: the service is not always running, and if there are multiple requests at the same time, we need high concurrency. So I started very eagerly using something called<a target="_blank" rel="external nofollow noopener noreferrer" href="https://serverless.com/">Serverless</a>The framework.</p><p>Thanks to Serverless, our service migration was very smooth, and I had a working version within two days. I created three serverless functions:</p><p>A source data parser: This service is used to parse versions and peerDependencies, and request packaging functions;</p><ul><li><ol><li>A packer: This service is used for the installation and packaging of actual dependencies;</li></ol></li><li><ol><li>An uglifier (compression &amp; obfuscation): responsible for asynchronously uglifying packages generated by packaging.</li></ol></li></ul><p>A few days later I found a limitation: a lambda function can only have a maximum of 500M disk space, which means that some combined dependencies cannot be installed (Translator’s Note: The backend needs to pack all the dependencies when doing the build. The code is loaded into memory). This was really a devastating limitation, and I had to switch the service back to the original implementation.</p><p>A few months later, I released a new builder for CodeSandbox.<a target="_blank" rel="external nofollow noopener noreferrer" href="https://hackernoon.com/how-i-created-a-parallel-offline-extensible-browser-based-bundler-886db508cc31">I released a new bundler for CodeSandbox</a>). This builder is very powerful and can easily allow us to support more frameworks like Preact or Vue. By supporting these frameworks, our service has received some very interesting requests. For example: If you want to use React in Preact, you need to rename’require (‘react’) ‘to:’ require (‘preact-compat’) ‘. For Vue, you might include’ @/components/App.vue ‘as your sandbox file. Our server-side packager doesn’t handle this kind of thing, but our browser-side bundler does.</p><p>That’s when I started thinking that we might be able to get the browser-side builder to do the actual packaging. If the server level just sends the relevant files to the browser (without doing the server-level packaging and building), and then we use the browser-side builder to actually package the dependencies, this should be faster because we are not handling the entire large package, only part of the package.</p><p>The server level packaged build based on webpack DLLPLugin will recursion traverse all dependencies from the dependency entry and then perform the packaged build, while the packaged build of the browser is only packaged on demand. So there are two reasons for it to be faster. First, the browser-side packaging construction does not require the server level to do the packaging construction. The server level is just a pure recursion acquisition of dependencies, and then sent to the browser side, which saves the server level. The time of packaging and building also saves server overhead; the second is that the packaging and building on the browser side is built on demand rather than in full.</p><p>This solution has a very big advantage: <strong>We can achieve separate installation and caching of dependencies</strong> (remember what the webpack version said, from that version, we cached not one dependency, but all the dependencies in the dependency combination), and then we implement the merge of dependencies on the end. This means that if you request a new dependency on top of all existing dependencies, you only need to collect files for the new dependency! This will solve the limitation of AWS Lambda500M memory limit well, because we will only install a dependent module at the server level. We can also drop’webpack ‘in the packer, because now the packer is solely responsible for finding the relevant files that are dependent and sending them to the browser side.</p><h2 id="Join-browser-cache"><a href="#Join-browser-cache" class="headerlink" title="Join browser cache"></a>Join browser cache</h2><p>The author said that he did not take the scheme of dynamically requesting files directly from the unpkg.com because he wanted to support the offline scheme, that is, even if you do not have a network, you can also implement the compile packaging build preview on the browser side, provided that you have already done the relevant files on the browser side. Based on the server level single dependency packaging implemented by the author, the scheme caches all the files of the entire dependency module in the local browser, while the dynamic request file from the unpkg.com is a single request for a single file in a dependency module, which is prone to A dependency file does not exist.</p><p>That is to say, every time you go to request a separate dependency, you will first check if there is a local cache before going to the background to get the dependency.</p><h2 id="Final-version"><a href="#Final-version" class="headerlink" title="Final version"></a>Final version</h2><p> <strong>CodeSandbox packaging and running does not depend on the server, just if you need to rely on the client without caching, you need to go to the server to request</strong></p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621128800/origin-of-ray/codesandbox-arch_b64xm7.png" alt></p><ul><li> <strong>Editor</strong> : Editor. Mainly used to modify files, CodeSandbox integrates’VsCode ‘here, and notifies’Sandbox’ for translation after file changes.</li><li> <strong>Sandbox</strong> : Code Runner. <strong>Sandbox runs in a separate iframe, responsible for code translation (Transpiler) and run (Evalation)</strong> . As shown in the top picture, the left side is Editor, the right side is Sandbox</li><li>Packager. Similar to yarn and npm, responsible for pulling and caching npm dependencies</li></ul><p>Author of CodeSandbox <a target="_blank" rel="external nofollow noopener noreferrer" href="https://twitter.com/CompuIves">Ives van Hoorne</a> I have also tried to port Webpack to the browser to run, because almost all CLIs are now built using Webpack. If you can port Webpack to the browser, you can take advantage of Webpack’s powerful ecosystem and translation mechanism (loader/plugin), low cost compatible with various CLIs.</p><p>However, Webpack is too heavy 😱, and the compressed size is 3.5MB, which is barely acceptable; the bigger problem is to simulate the Node runtime environment on the browser side, which costs too much and outweighs the gains.</p><p>So CodeSandbox decided to build its own packager, which is lighter and optimized for the CodeSandbox platform. For example, CodeSandbox only cares about the code building of the Development Environment, and the goal is to run it. Compared with Webpack, the following features have been cut out:</p><ul><li>Production mode. CodeSandbox only considers the development mode, and does not need to consider some features of production, such as<ul><li>Code compression, optimization</li><li>Tree-shaking</li><li>Performance optimization</li><li>Code Splitting</li></ul></li><li>File output. No need to pack into chunks</li><li>Server communication. Sandbox translates and runs directly in situ, while Webpack needs to establish a long connection with the development server to receive instructions, such as HMR.</li><li>Static file processing (such as images). These images need to be uploaded to CodeSandbox’s server</li><li>Plugin mechanisms and more.</li></ul><p>So it can be considered that CodeSandbox is a simplified version of Webpack, and optimized for the browser environment, such as using workers for parallel translation.</p><h3 id="Project-build-process"><a href="#Project-build-process" class="headerlink" title="Project build process"></a>Project build process</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">packager -&gt; transpilation -&gt; evaluation</span><br></pre></td></tr></table></figure><p>Sandbox construction is divided into three stages:</p><p>Packager loading phase, download and handle all npm module dependencies</p><ul><li> <strong>Transpilation</strong> Transpilation phase, translates all changed code, constructs modeling block dependencies</li><li> <strong>Evaluation</strong> Execution phase, run module code with’eval ‘for preview</li></ul><h4 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h4><p>Since CodeSandbox already covers the code building part, we don’t need’devDependencies’, that is to say <strong>in CodeSandbox we only need to install all the dependencies needed for the actual code to run, which can reduce hundreds of dependency downloads. So don’t worry about the browser being overwhelmed for the time being</strong> .</p><p>Before Packer downloads dependencies, it actually goes through the Transpilation transfer phase to analyze dependencies on demand, and then takes the analysis product to Packer.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469497/origin-of-ray/packager2_pk7goe.png" alt></p><h4 id="Transpilation"><a href="#Transpilation" class="headerlink" title="Transpilation"></a>Transpilation</h4><p> This stage starts from the application’s entry file, translates the source code, parses the AST, finds the subordinate dependency modules, and then recursion translation, and finally forms a’dependency graph ‘.</p><p>The entire transpiler of CodeSandbox runs in a separate iframe.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469683/origin-of-ray/editor-vs-compiler_m9eo6p.png" alt="img"></p><p>The Editor is responsible for changing the source code. The source code changes will be passed to the Compiler through postmessage, which will carry’Module + template ‘.</p><ul><li> <strong>Module</strong> contains all source code content and module path, which also contains package.json, Compiler will read npm dependencies according to package.json;</li><li> <strong>template</strong> represents the Preset of the Compiler, such as’create-react-app ‘,’ vue-cli ‘, which defines some loader rules for translating different types of files, and the preset also determines the template and entry file of the application. From the above we know that these templates are currently predefined.</li></ul><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621469733/origin-of-ray/compiler_cgbsyb.png" alt></p><p>The overall situation can be basically divided into the following four stages:</p><ul><li> <strong>Configuration phase</strong> : The configuration phase creates Preset objects, determines entry files, etc. CodeSandbox currently only supports limited application templates, such as vue-cli and create-react-app. The directory structure convention between different templates is different, such as entry files and html template files. In addition, the rules for file processing are different, for example, vue-cli needs to handle ‘.vue’ files.</li><li> <strong>Dependency download phase</strong> : Packager phase, download all dependencies of the project and generate Manifest objects</li><li> <strong>Change calculation stage</strong> : Calculate the added, updated, and removed modules according to the source code passed by the Editor.</li><li> <strong>The translation stage</strong> : When the translation really starts, first re-translate the modules that need to be updated calculated in the previous stage. Then from the entry file as a starting point, translate and build a new dependency graph. Modules and their submodules that have not changed will not be translated repeatedly here</li></ul><h4 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h4><p>Although it is called a bundler, CodeSandbox does not package, which means it does not package all modules into chunks files like Webpack.</p><p>Transpilation starts from the entry file, then analyzes the module import rules of the file, and recursion translates the dependent modules. By the Evaluation stage, CodeSandbox has built a complete dependency graph. Now it’s time to run the application</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1621470036/origin-of-ray/evaluation_gseiqz.png" alt></p><p>Reference link:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.yuque.com/wangxiangzhong/aob8up/uf99c5?language=en-us">https://www.yuque.com/wangxiangzhong/aob8up/uf99c5?language=en-us</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://hackernoon.com/how-we-make-npm-packages-work-in-the-browser-announcing-the-new-packager-6ce16aa4cee6">codesandbox作者解读</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000019679430">https://segmentfault.com/a/1190000019679430</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/19234/" title="How codesandbox runs the npm module in the browser">https://sunra.top/en/posts/19234/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/25327/" rel="prev" title="History of React Hook and Pits in Actual Combat"><i class="fa fa-chevron-left"></i> History of React Hook and Pits in Actual Combat</a></div><div class="post-nav-item"> <a href="/en/posts/15279/" rel="next" title="Summary of the process of developing a new npm package in Monorepo">Summary of the process of developing a new npm package in Monorepo<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/19234/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>