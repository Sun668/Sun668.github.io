<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="The last blog talked about the workflow of babel-parser, there are two main components, one is the Tokenizer to split the code string into Token arrays, and the other is the parser to convert the Toke"><meta property="og:type" content="article"><meta property="og:title" content="In-depth Babel Principles Series (3) Tokenizer"><meta property="og:url" content="https://sunra.top/en/posts/43883/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="The last blog talked about the workflow of babel-parser, there are two main components, one is the Tokenizer to split the code string into Token arrays, and the other is the parser to convert the Toke"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-07-03T07:14:13.000Z"><meta property="article:modified_time" content="2023-09-25T13:21:34.448Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/43883/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/43883/","path":"posts/43883/","title":"In-depth Babel Principles Series (3) Tokenizer"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>In-depth Babel Principles Series (3) Tokenizer | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Type"><span class="nav-number">1.</span> <span class="nav-text">Type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Context"><span class="nav-number">2.</span> <span class="nav-text">Context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#State"><span class="nav-number">3.</span> <span class="nav-text">State</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-number">3.1.</span> <span class="nav-text">init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#clone"><span class="nav-number">3.2.</span> <span class="nav-text">clone</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Other-properties"><span class="nav-number">3.3.</span> <span class="nav-text">Other properties</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#index"><span class="nav-number">4.</span> <span class="nav-text">index</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/43883/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="In-depth Babel Principles Series (3) Tokenizer | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> In-depth Babel Principles Series (3) Tokenizer</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-07-03 15:14:13" itemprop="dateCreated datePublished" datetime="2021-07-03T15:14:13+08:00">2021-07-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-09-25 21:21:34" itemprop="dateModified" datetime="2023-09-25T21:21:34+08:00">2023-09-25</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Babel/" itemprop="url" rel="index"><span itemprop="name">Babel</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/43883/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/43883/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>The last blog talked about the workflow of babel-parser, there are two main components, one is the Tokenizer to split the code string into Token arrays, and the other is the parser to convert the Token arrays into AST trees.</p><p>This time, let’s take a closer look at the logic of Tokenizer.</p><span id="more"></span><p>There are only four files in the Tokenizer source code, context.js, index.js, state.js, and type.js, so let’s analyze them one by one.</p><h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>First is type.js, as the name implies, this file defines the type of all Tokens</p><p>Let’s look at the definition of TokenType first. Note that the official comments are important to facilitate our understanding of the meaning of the existence of these variables:</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The `beforeExpr` property is used to disambiguate between 1) binary</span></span><br><span class="line"><span class="comment">// expression (&lt;) and JSX Tag start (&lt;name&gt;); 2) object literal and JSX // texts.</span></span><br><span class="line"><span class="comment">// texts. It is set on the `updateContext` function in the JSX plugin.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The `startsExpr` property is used to determine whether an expression</span></span><br><span class="line"><span class="comment">// may be the &quot;argument&quot; subexpression of a `yield` expression or</span></span><br><span class="line"><span class="comment">// It is set on all token types that may be at the</span></span><br><span class="line"><span class="comment">// start of a subexpression.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// `isLoop` marks a keyword as starting a loop, which is important</span></span><br><span class="line"><span class="comment">// to know when parsing a label, in order to allow or disallow</span></span><br><span class="line"><span class="comment">// continue jumps to that label.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> beforeExpr = <span class="literal">true</span>.</span><br><span class="line"><span class="keyword">const</span> startsExpr = <span class="literal">true</span>.</span><br><span class="line"><span class="keyword">const</span> isLoop = <span class="literal">true</span>.</span><br><span class="line"><span class="keyword">const</span> isAssign = <span class="literal">true</span>; <span class="comment">// Whether the Token can signify an assignment, e.g. =</span></span><br><span class="line"><span class="keyword">const</span> prefix = <span class="literal">true</span>; <span class="comment">// whether the Token can be a prefix of a unary expression, e.g. !</span></span><br><span class="line"><span class="keyword">const</span> postfix = <span class="literal">true</span>; <span class="comment">// whether the Token can be a postfix of a unary expression, e.g. ++</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TokenOptions</span> = &#123;</span><br><span class="line">  keyword?: <span class="built_in">string</span>.</span><br><span class="line">  beforeExpr?: <span class="built_in">boolean</span>.</span><br><span class="line">  startsExpr?: <span class="built_in">boolean</span>.</span><br><span class="line">  rightAssociative?: <span class="built_in">boolean</span>.</span><br><span class="line">  isLoop?: <span class="built_in">boolean</span>.</span><br><span class="line">  isAssign?: <span class="built_in">boolean</span>.</span><br><span class="line">  prefix?: <span class="built_in">boolean</span>.</span><br><span class="line">  postfix?: <span class="built_in">boolean</span>.</span><br><span class="line">  binop?: ?<span class="built_in">number</span>.</span><br><span class="line">&#125;.</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TokenType</span> &#123;</span><br><span class="line">  <span class="attr">label</span>: <span class="built_in">string</span>.</span><br><span class="line">  <span class="attr">keyword</span>: ?<span class="built_in">string</span>.</span><br><span class="line">  <span class="attr">beforeExpr</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">startsExpr</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">rightAssociative</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">isLoop</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">isAssign</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">prefix</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">postfix</span>: <span class="built_in">boolean</span>.</span><br><span class="line">  <span class="attr">binop</span>: ?<span class="built_in">number</span>.</span><br><span class="line">  <span class="attr">updateContext</span>: ? <span class="function">(<span class="params">context: <span class="built_in">Array</span>&lt;TokContext&gt;</span>) =&gt;</span> <span class="built_in">void</span>.</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">label: <span class="built_in">string</span>, conf: TokenOptions = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = label.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyword</span> = conf.<span class="property">keyword</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">beforeExpr</span> = !!conf.<span class="property">beforeExpr</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">starsExpr</span> = !!conf.<span class="property">starsExpr</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rightAssociative</span> = !!conf.<span class="property">rightAssociative</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoop</span> = !!conf.<span class="property">isLoop</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAssign</span> = !!conf.<span class="property">isAssign</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">prefix</span> = !!conf.<span class="property">prefix</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">postfix</span> = !!conf.<span class="property">postfix</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">binop</span> = conf.<span class="property">binop</span> != <span class="literal">null</span> ? conf.<span class="property">binop</span> : <span class="literal">null</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">updateContext</span> = <span class="literal">null</span>.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This structure is relatively speaking not very complicated, but these parameters may not see all the intention for a while, it does not matter, we look at a few specific examples to analyze:</p><p>Before analyzing specific examples, we can look at two tool methods</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> keywords = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;string, <span class="title class_">TokenType</span>&gt;().</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createKeyword</span>(<span class="params">name: string, options: TokenOptions = &#123;&#125;</span>): <span class="title class_">TokenType</span> &#123;</span><br><span class="line">  options.<span class="property">keyword</span> = name.</span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> <span class="title class_">TokenType</span>(name, options).</span><br><span class="line">  keywords.<span class="title function_">set</span>(name, token).</span><br><span class="line">  <span class="keyword">return</span> token.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createBinop</span>(<span class="params">name: string, binop: number</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TokenType</span>(name, &#123; beforeExpr, binop &#125;).</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This createKeyword is to create a TokenType of keyword type. Combined with the above code, we can see that a special feature of the TokenType of keyword type is that its keyword variable has a value, and the value is the same as label.</p><p>The role of createBinop is to create a binary expression type, which is characterized by the fact that beforeExpr is true, and binop has a specific value</p><p>Well, after reading this, let’s take a look at a few concrete examples</p><p>First is the basic variable type Type, e.g:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">num</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;num&quot;</span>, &#123; startsExpr &#125;).</span><br><span class="line"><span class="attr">bigint</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;bigint&quot;</span>, &#123; startsExpr &#125;).</span><br></pre></td></tr></table></figure><p>Then there are the symbolic types of Type</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bracketL</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;[&quot;</span>, &#123; beforeExpr, startsExpr &#125;).</span><br><span class="line"><span class="attr">bracketR</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;]&quot;</span>).</span><br><span class="line"><span class="attr">question</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;?&quot;</span> , &#123; beforeExpr &#125;).</span><br></pre></td></tr></table></figure><p>Operator type:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eq</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;=&quot;</span>, &#123; beforeExpr, isAssign &#125;).</span><br><span class="line"><span class="attr">incDec</span>: <span class="keyword">new</span> <span class="title class_">TokenType</span>(<span class="string">&quot;++/--&quot;</span>, &#123; prefix, postfix, startsExpr &#125;).</span><br><span class="line"><span class="attr">pipeline</span>: <span class="title function_">createBinop</span>(<span class="string">&quot;|&gt;&quot;</span>, <span class="number">0</span>).</span><br><span class="line"><span class="attr">nullishCoalescing</span>: <span class="title function_">createBinop</span>(<span class="string">&quot;???&quot;</span> , <span class="number">1</span>).</span><br></pre></td></tr></table></figure><p>Keyword type</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">_break</span>: <span class="title function_">createKeyword</span>(<span class="string">&quot;break&quot;</span>).</span><br><span class="line"><span class="attr">_case</span>: <span class="title function_">createKeyword</span>(<span class="string">&quot;case&quot;</span>, &#123; beforeExpr &#125;).</span><br><span class="line"><span class="attr">_default</span>: <span class="title function_">createKeyword</span>(<span class="string">&quot;default&quot;</span>, &#123; beforeExpr &#125;).</span><br><span class="line"><span class="attr">_do</span>: <span class="title function_">createKeyword</span>(<span class="string">&quot;do&quot;</span>, &#123; isLoop, beforeExpr &#125;).</span><br></pre></td></tr></table></figure><h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Just now Type there is an updateContext did not speak, this function is related to context.js, to JSX plug-ins used. Let’s look at it together</p><p>At the beginning, the comments say what context does</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The token context is used to track whether the apostrophe &quot;`&quot;</span></span><br><span class="line"><span class="comment">// starts or ends a string template</span></span><br></pre></td></tr></table></figure><p>is used to parse the template string, and its type definition is even simpler: the</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TokContext</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">token: string, preserveSpace?: boolean</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">token</span> = token.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preserveSpace</span> = !!preserveSpace.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">token</span>: string.</span><br><span class="line">  <span class="attr">preserveSpace</span>: boolean.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The types refers to the template strings that can be nested during the analysis of the template strings, so there is a context stack that is used to check if all the template strings are closed, there are only two types of data in this stack, one is brackets and one is backquotes</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">types</span>: &#123;</span><br><span class="line">  [<span class="attr">key</span>: string]: <span class="title class_">TokContext</span>.</span><br><span class="line">&#125; = &#123;</span><br><span class="line">  <span class="attr">brace</span>: <span class="keyword">new</span> <span class="title class_">TokContext</span>(<span class="string">&quot;&#123;&quot;</span>).</span><br><span class="line">  <span class="attr">template</span>: <span class="keyword">new</span> <span class="title class_">TokContext</span>(<span class="string">&quot;`&quot;</span>, <span class="literal">true</span>).</span><br><span class="line">&#125;.</span><br></pre></td></tr></table></figure><p>Then all that’s left is to add updateContext methods to all the types that will be related to the template string to maintain the contexts stack during parsing</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">backQuote: new TokenType(&quot;`&quot;, &#123; startsExpr &#125;).</span></span><br><span class="line"><span class="comment">braceL: new TokenType(&quot;&#123;&quot;, &#123; beforeExpr, startsExpr &#125;).</span></span><br><span class="line"><span class="comment">braceHashL: new TokenType(&quot;#&#123;&quot;, &#123; beforeExpr, startsExpr &#125;).</span></span><br><span class="line"><span class="comment">dollarBraceL: new TokenType(&quot;$&#123;&quot;, &#123; beforeExpr, startsExpr &#125;).</span></span><br><span class="line"><span class="comment">braceR: new TokenType(&quot;&#125;&quot;, &#123; beforeExpr &#125;).</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">tt.<span class="property">braceR</span>.<span class="property">updateContext</span> = <span class="function"><span class="params">context</span> =&gt;</span> &#123;</span><br><span class="line">  context.<span class="title function_">pop</span>().</span><br><span class="line">&#125;.</span><br><span class="line"></span><br><span class="line"><span class="comment">// we don&#x27;t need to update context for tt.braceBarL because we do not pop context for tt.braceBarR</span></span><br><span class="line"><span class="comment">// ideally only dollarBraceL &quot;$&#123;&quot; needs a non-template context</span></span><br><span class="line"><span class="comment">// in order to indicate that the last &quot;`&quot; in `$&#123;`&quot; starts a new string template</span></span><br><span class="line"><span class="comment">// inside a template element within outer string template.</span></span><br><span class="line"><span class="comment">// but when we popped such context in `&#125;`, we lost track of whether this</span></span><br><span class="line"><span class="comment">// `&#125;` matches a `$&#123;` or other tokens matching `&#125;`, so we have to push</span></span><br><span class="line"><span class="comment">// such context in every token that `&#125;` will match.</span></span><br><span class="line">tt.<span class="property">braceL</span>.<span class="property">updateContext</span> =</span><br><span class="line">  tt.<span class="property">braceHashL</span>.<span class="property">updateContext</span> =</span><br><span class="line">  tt.<span class="property">dollarBraceL</span>.<span class="property">updateContext</span> =</span><br><span class="line">    <span class="function"><span class="params">context</span> =&gt;</span> &#123;</span><br><span class="line">      context.<span class="title function_">push</span>(types.<span class="property">brace</span>).</span><br><span class="line">    &#125;.</span><br><span class="line"></span><br><span class="line">tt.<span class="property">backQuote</span>.<span class="property">updateContext</span> = <span class="function"><span class="params">context</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// When the backquote is parsed, see if the current top of the stack is a template type, if so, it means that the last backquote has already been on the stack, that is, it has gone through the else logic once, so then pop out the template that was on the stack last time.</span></span><br><span class="line">  <span class="keyword">if</span> (context[context.<span class="property">length</span> - <span class="number">1</span>] === types.<span class="property">template</span>) &#123;</span><br><span class="line">    context.<span class="title function_">pop</span>().</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    context.<span class="title function_">push</span>(types.<span class="property">template</span>).</span><br><span class="line">  &#125;</span><br><span class="line">&#125;.</span><br></pre></td></tr></table></figure><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>This file defines the state of the parsing process, including where it is, which line, which column, how many characters, etc.</p><p>All the content of this file is in the class that declares the state, so all the code that follows is in this class.</p><p>First is the initialization function, this class does not have a constructor, but an initialization function, which needs to be called by the caller himself.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">strict</span>: boolean.</span><br><span class="line"><span class="attr">curLine</span>: number.</span><br><span class="line"></span><br><span class="line"><span class="comment">// And, if locations are used, the &#123;line, column&#125; object</span></span><br><span class="line"><span class="comment">// corresponding to those offsets</span></span><br><span class="line"><span class="attr">startLoc</span>: <span class="title class_">Position</span>.</span><br><span class="line"><span class="attr">endLoc</span>: <span class="title class_">Position</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">// The current position of the tokenizer in the input.</span></span><br><span class="line"><span class="attr">pos</span>: number = <span class="number">0.</span></span><br><span class="line"><span class="attr">lineStart</span>: number = <span class="number">0.</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">init</span>(<span class="attr">options</span>: <span class="title class_">Options</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">strict</span> =</span><br><span class="line">    options.<span class="property">strictMode</span> === <span class="literal">false</span> ? <span class="literal">false</span> : options.<span class="property">sourceType</span> === <span class="string">&quot;module&quot;</span>.</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">curLine</span> = options.<span class="property">startLine</span>.</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">startLoc</span> = <span class="variable language_">this</span>.<span class="property">endLoc</span> = <span class="variable language_">this</span>.<span class="title function_">curPosition</span>().</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As you can see this initialization function does a simple thing, first of all it is a determination and preservation of the strict pattern</p><p>The other is to initialize the curLine to the beginning of the incoming line, which will change later in the parsing process</p><p>The last is to initialize startLoc and endLoc, these two values will not change later, at least in the state class there is no way to change it, in the future to continue to look at the time if you see where the change, I will come back to update.</p><p>And this curPosition function is also very simple</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">curPosition</span>(): <span class="title class_">Position</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Position</span>(<span class="variable language_">this</span>.<span class="property">curLine</span>, <span class="variable language_">this</span>.<span class="property">pos</span> - <span class="variable language_">this</span>.<span class="property">lineStart</span>).</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The first parameter of Position is the number of rows, the second parameter is the number of columns</p><p>The curLine has just been initialized to startLine before, while pos and lineStart have not been assigned before, so they are both 0</p><h3 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h3><p>In addition to the above two functions, there is a clone function, used to deep copy the state, nothing special logic, put here, interested can see.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">clone</span>(skipArrays?: boolean): <span class="title class_">State</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> state = <span class="keyword">new</span> <span class="title class_">State</span>().</span><br><span class="line">   <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>).</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, length = keys.<span class="property">length</span>; i &lt; length; i++) &#123;</span><br><span class="line">     <span class="keyword">const</span> key = keys[i].</span><br><span class="line">     <span class="comment">// $FlowIgnore</span></span><br><span class="line">     <span class="keyword">let</span> val = <span class="variable language_">this</span>[key].</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!skipArrays &amp;&amp; <span class="title class_">Array</span>.<span class="title function_">isArray</span>(val)) &#123;</span><br><span class="line">       val = val.<span class="title function_">slice</span>().</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// $FlowIgnore</span></span><br><span class="line">     state[key] = val.</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> state.</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="Other-properties"><a href="#Other-properties" class="headerlink" title="Other properties"></a>Other properties</h3><p>State has a large number of properties, are used to save the parsing state, and generate AST, many properties directly, do not feel useful, add a few properties to know what to do at a glance</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The current position of the tokenizer in the input.</span></span><br><span class="line"> <span class="attr">pos</span>: number = <span class="number">0.</span></span><br><span class="line"> <span class="attr">lineStart</span>: number = <span class="number">0.</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// Properties of the current token.</span></span><br><span class="line"> <span class="comment">// Its type</span></span><br><span class="line"> <span class="attr">type</span>: <span class="title class_">TokenType</span> = tt.<span class="property">eof</span>.</span><br><span class="line"></span><br><span class="line"> <span class="comment">// For tokens that include more information than their type, the value</span></span><br><span class="line"> <span class="attr">value</span>: any = <span class="literal">null</span>.</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Its start and end offset</span></span><br><span class="line"> <span class="attr">start</span>: number = <span class="number">0.</span></span><br><span class="line"> <span class="attr">end</span>: number = <span class="number">0.</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// Position information for the previous token</span></span><br><span class="line"> <span class="comment">// $FlowIgnore this is initialized when generating the second token.</span></span><br><span class="line"> <span class="attr">lastTokEndLoc</span>: <span class="title class_">Position</span> = <span class="literal">null</span>.</span><br><span class="line"> <span class="comment">// $FlowIgnore this is initialized when generating the second token.</span></span><br><span class="line"> <span class="attr">lastTokStartLoc</span>: <span class="title class_">Position</span> = <span class="literal">null</span>. <span class="attr">lastTokStartLoc</span>: <span class="title class_">Position</span> = <span class="literal">null</span>.</span><br><span class="line"> <span class="attr">lastTokStart</span>: number = <span class="number">0.</span></span><br><span class="line"> <span class="attr">lastTokEnd</span>: number = <span class="number">0</span>; <span class="attr">lastTokEnd</span>: number = <span class="number">0.</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// The context stack is used to track whether the apostrophe &quot;`&quot; starts</span></span><br><span class="line"> <span class="comment">// or ends a string template</span></span><br><span class="line"> <span class="attr">context</span>: <span class="title class_">Array</span>&lt;<span class="title class_">TokContext</span>&gt; = [ct.<span class="property">brace</span>].</span><br><span class="line"> <span class="comment">// Used to track whether a JSX element is allowed to form</span></span><br><span class="line"> <span class="attr">exprAllowed</span>: boolean = <span class="literal">true</span>.</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Used to signal to callers of `readWord1` whether the word</span></span><br><span class="line"> <span class="comment">// This is needed because words with</span></span><br><span class="line"> <span class="comment">// escape sequences must not be interpreted as keywords.</span></span><br><span class="line"> <span class="attr">containsEsc</span>: boolean = <span class="literal">false</span>.</span><br><span class="line"></span><br><span class="line"> <span class="comment">// This property is used to track the following errors</span></span><br><span class="line"> <span class="comment">// - StrictNumericEscape</span></span><br><span class="line"> <span class="comment">// - StrictOctalLiteral</span></span><br><span class="line"> <span class="comment">// in a literal that occurs</span></span><br><span class="line"> <span class="comment">// in a literal that occurs prior to/immediately after a &quot;use strict&quot; directive.</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// todo(JLHwung): set strictErrors to null and avoid recording string errors</span></span><br><span class="line"> <span class="comment">// after a non-directive is parsed</span></span><br><span class="line"> <span class="attr">strictErrors</span>: <span class="title class_">Map</span>&lt;number, <span class="title class_">ErrorTemplate</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>().</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Tokens length in token store</span></span><br><span class="line"> <span class="attr">tokensLength</span>: number = <span class="number">0.</span></span><br></pre></td></tr></table></figure><h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><p>Finally there is the main logic of Tokenizer, close to 1600 lines, let’s analyze it slowly.</p><p>In fact, although there is a lot of code, but the core idea is not complicated, first is the constructor</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">isLookahead</span>: boolean.</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Token store.</span></span><br><span class="line"><span class="attr">tokens</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Token</span> | N.<span class="property">Comment</span>&gt; = [].</span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">options: Options, input: string</span>) &#123;</span><br><span class="line">  <span class="variable language_">super</span>().</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span> = <span class="keyword">new</span> <span class="title class_">State</span>().</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">state</span>.<span class="title function_">init</span>(options).</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">input</span> = input.</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">length</span> = input.<span class="property">length</span>.</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isLookahead</span> = <span class="literal">false</span>.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here is where the State is initialized and the init function is called.</p><p>Then there are several entry functions for parsing, that is, those that are called by the outside world, such as next, etc.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">pushToken</span>(<span class="params">token: Token | N.Comment</span>) &#123;</span><br><span class="line">    <span class="comment">// Pop out invalid tokens trapped by try-catch parsing.</span></span><br><span class="line">    <span class="comment">// Those parsing branches are mainly created by typescript and flow plugins.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tokens</span>.<span class="property">length</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">tokensLength</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tokens</span>.<span class="title function_">push</span>(token).</span><br><span class="line">    ++<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">tokensLength</span>.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Move to the next token</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">next</span>(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">checkKeywordEscapes</span>().</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">tokens</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">pushToken</span>(<span class="keyword">new</span> <span class="title class_">Token</span>(<span class="variable language_">this</span>.<span class="property">state</span>)).</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">lastTokEnd</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">end</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">lastTokStart</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">start</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">lastTokEndLoc</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">endLoc</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">lastTokStartLoc</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startLoc</span>.</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">nextToken</span>().</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">eat</span>(<span class="attr">type</span>: <span class="title class_">TokenType</span>): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">match</span>(type)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">next</span>().</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>.</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>.</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">match</span>(<span class="attr">type</span>: <span class="title class_">TokenType</span>): boolean &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">type</span> === type.</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>nextToken we talked about in the last blog, the main is two, one is to analyze the template string, one is getTokenFromCode, the main is this getTokenFromCode, judged a variety of cases, and then call different methods, such as:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Anything else beginning with a digit is an integer, octal</span></span><br><span class="line"><span class="comment">// number, or float. (fall through)</span></span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit1</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit2</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit3</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit4</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit5</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit6</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit7</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit8</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">digit9</span>.</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">readNumber</span>(<span class="literal">false</span>).</span><br><span class="line">  <span class="keyword">return</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">// Quotes produce strings.</span></span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">quotationMark</span>.</span><br><span class="line"><span class="keyword">case</span> charCodes.<span class="property">apostrophe</span>.</span><br><span class="line">  <span class="title class_">This</span>.<span class="title function_">readString</span>(code).</span><br><span class="line">  <span class="keyword">return</span>.</span><br></pre></td></tr></table></figure><p>There are tons of other functions like readRegexp read RegExp, readEscapedChar, etc. Most of the code is of this kind, each internally a small state machine like the one I talked about in my last blog about reading template strings.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/43883/" title="In-depth Babel Principles Series (3) Tokenizer">https://sunra.top/en/posts/43883/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/5517/" rel="prev" title="In-depth Babel Principle Series (II) Parser Code Structure Introduction"><i class="fa fa-chevron-left"></i> In-depth Babel Principle Series (II) Parser Code Structure Introduction</a></div><div class="post-nav-item"> <a href="/en/posts/10113/" rel="next" title="React Hook Practical Summary - How to Write Less Complex Projects with React Hook">React Hook Practical Summary - How to Write Less Complex Projects with React Hook<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/43883/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>