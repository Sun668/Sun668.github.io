<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="In上一篇关于作用域的文章We talk about scope through the call stack. Whenever we call a function, we create an execution context for that function in the call stack. So far we know that there is a variable enviro"><meta property="og:type" content="article"><meta property="og:title" content="JavaScript Execution Mechanisms (3) Scope Chains and Closures"><meta property="og:url" content="https://sunra.top/en/posts/25c6b127/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="In上一篇关于作用域的文章We talk about scope through the call stack. Whenever we call a function, we create an execution context for that function in the call stack. So far we know that there is a variable enviro"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615206801/origin-of-ray/微信截图_20210308203206_ik52ug.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615206965/origin-of-ray/微信截图_20210308203554_ww6kdz.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615207688/origin-of-ray/微信截图_20210308204757_sxwhgi.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615207902/origin-of-ray/微信截图_20210308205133_amqnac.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615208011/origin-of-ray/微信截图_20210308205319_qlouxj.png"><meta property="article:published_time" content="2020-12-07T13:33:14.000Z"><meta property="article:modified_time" content="2024-04-27T11:31:30.687Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615206801/origin-of-ray/微信截图_20210308203206_ik52ug.png"><link rel="canonical" href="https://sunra.top/en/posts/25c6b127/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/25c6b127/","path":"posts/25c6b127/","title":"JavaScript Execution Mechanisms (3) Scope Chains and Closures"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>JavaScript Execution Mechanisms (3) Scope Chains and Closures | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Scope-chain"><span class="nav-number">1.</span> <span class="nav-text">Scope chain</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Outer-pointer"><span class="nav-number">1.1.</span> <span class="nav-text">Outer pointer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Variable-lookup-in-block-level-scope"><span class="nav-number">1.2.</span> <span class="nav-text">Variable lookup in block-level scope</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Closure"><span class="nav-number">2.</span> <span class="nav-text">Closure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Closure-recycling"><span class="nav-number">2.1.</span> <span class="nav-text">Closure recycling</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/25c6b127/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="JavaScript Execution Mechanisms (3) Scope Chains and Closures | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> JavaScript Execution Mechanisms (3) Scope Chains and Closures</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-12-07 21:33:14" itemprop="dateCreated datePublished" datetime="2020-12-07T21:33:14+08:00">2020-12-07</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-04-27 19:31:30" itemprop="dateModified" datetime="2024-04-27T19:31:30+08:00">2024-04-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/25c6b127/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/25c6b127/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>In<a href="https://sunra.top/posts/&#39;48445981&#39;/">上一篇关于作用域的文章</a>We talk about scope through the call stack.</p><p>Whenever we call a function, we create an execution context for that function in the call stack. So far we know that there is a variable environment for storing variables declared through var, and a lexical environment. The lexical environment, in turn, is a stack that places the variables in the function declared through let and const in different levels of block-level scope **.</p><p>Based on the above variable environment and lexical environment, we can understand how to find the correct variable in the execution context of a function.</p><p>What if the variable we need is not actually in the current execution context, but in the execution context at the previous level? How do we determine which execution context is at the previous level?</p><p>This question touches on our topic today: scope chains.</p><p>Understanding scope chain is the basis for understanding closures, which are almost ubiquitous in JavaScript. At the same time, scope and scope chain are the foundation of all programming languages. Therefore, if you want to learn a language thoroughly, scope and scope chain must be inseparable.</p><span id="more"></span><h2 id="Scope-chain"><a href="#Scope-chain" class="headerlink" title="Scope chain"></a>Scope chain</h2><p>First, let’s take a look at the following code:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(myName)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Var</span> myName = <span class="string">&quot;big tree&quot;</span></span><br><span class="line">    <span class="title function_">bar</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myName = <span class="string">&quot;bigTree&quot;</span></span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure><p>What do you think the bar function and foo function in this code print out?</p><p>So when this code executes inside the bar function, the state diagram of its call stack is as follows:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615206801/origin-of-ray/微信截图_20210308203206_ik52ug.png" alt="函数调用栈"></p><p>As can be seen from the figure, both the global execution context and the execution context of foo function contain the variable myName. Which one should be selected for the value of myName in the bar function?</p><p>Perhaps your first reaction is to search for variables in the order of the call stack, as follows:</p><ol><li>First find if there is a myName variable in the stack top, but there is none here, so then go down and look for the variable in the foo function.</li><li>The myName variable is found in the foo function, and myName in the foo function is used at this time.</li></ol><p>If you look for variables in this way, the final result printed by executing the bar function should be “big tree”. But this is not the case. If you try to execute the above code, you will find that the printed result is “bigTree”. Why is this the case? To explain this problem, then you need to figure out the scope chain first.</p><h3 id="Outer-pointer"><a href="#Outer-pointer" class="headerlink" title="Outer pointer"></a>Outer pointer</h3><p>In fact, in the variable environment of each execution context, there is an external reference used to point to the external execution context. We call this external reference outer.</p><p>When a piece of code uses a variable, the JavaScript engine will first look for the variable in the “current execution context”.</p><p>For example, when the code above searches for the myName variable, if it is not found in the current variable environment, the JavaScript engine will continue to search in the execution context pointed to by outer. For an intuitive understanding, you can see the following picture:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615206965/origin-of-ray/微信截图_20210308203554_ww6kdz.png" alt="函数调用栈及outer指针"></p><p>It can be seen from the figure that the outer of bar function and foo function both point to the global context, which means that if an external variable is used in bar function or foo function, the JavaScript engine will look for it in the global execution context.</p><p>We call this search chain the scope chain. Now you know that variables are searched through the scope chain, but there is still a question that has not been solved. The bar function called by foo function, why is the external reference of bar function the global execution context instead of the execution context of foo function?</p><p>To answer this question, you also need to know what lexical scope is. This is because during JavaScript execution, its scope chain is determined by lexical scope.</p><blockquote><p>Lexical scope means that the scope is determined by the position of the function declaration in the code, so the lexical scope is a static scope, through which it is possible to predict how the code will look up identifiers during execution.</p><p>In other words, lexical scope is determined during the compile stage of the code, and has nothing to do with how the function is called.</p></blockquote><h3 id="Variable-lookup-in-block-level-scope"><a href="#Variable-lookup-in-block-level-scope" class="headerlink" title="Variable lookup in block-level scope"></a>Variable lookup in block-level scope</h3><p>Previously, we analyzed the scope chain through the global scope and function-level scope. Next, let’s take a look at how variables are found in the block-level scope? When writing code, if you use a variable that does not exist in the current scope, the JavaScript engine needs to search for the variable in other scopes according to the scope chain. If you do not understand the process, there will be a high probability of writing unstable code.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myName = <span class="string">&quot;bigTree2&quot;</span></span><br><span class="line">    <span class="keyword">let</span> test1 = <span class="number">100</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="title class_">Let</span> myName = <span class="string">&quot;Chrome Browser&quot;</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(test)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Var</span> myName = <span class="string">&quot;big tree&quot;</span></span><br><span class="line">    <span class="keyword">let</span> test = <span class="number">2</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> test = <span class="number">3</span></span><br><span class="line">        <span class="title function_">bar</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myName = <span class="string">&quot;bigTree&quot;</span></span><br><span class="line"><span class="keyword">let</span> myAge = <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> test = <span class="number">1</span></span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure><p>You can first analyze the execution process of this code by yourself to see if you can analyze the execution result. To get the execution result, then we have to analyze the execution process from the perspective of the scope chain and the lexical environment.</p><p>ES6 supports block-level scope. When executing to the Code Block, if there is a variable declared by let or const in the Code Block, the variable will be stored in the lexical environment of the function. For the above code, when executing to the if statement block inside the bar function, the call stack is shown in the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615207688/origin-of-ray/微信截图_20210308204757_sxwhgi.png" alt="函数作用域链查找顺序"></p><h2 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h2><p>First, let’s talk about what closure is.</p><p>The first and most essential statement is that a closure is a function with its own runtime environment, that is, the function has its own execution context.</p><p>The other is a popular, more representational explanation in terms of usage: first, it is closed, that is, the outside world cannot directly access the variables in it, and second, it is a package, so it exposes Some methods allow the outside world to manipulate its internal data.</p><p>Here you can combine the following code to understand what a closure is:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> myName = <span class="string">&quot;bigTree&quot;</span></span><br><span class="line">    <span class="keyword">let</span> test1 = <span class="number">1</span></span><br><span class="line">    <span class="keyword">const</span> test2 = <span class="number">2</span></span><br><span class="line">    <span class="keyword">var</span> innerBar = &#123;</span><br><span class="line">        <span class="attr">getName</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(test1)</span><br><span class="line">            <span class="keyword">return</span> myName</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">setName</span>:<span class="keyword">function</span>(<span class="params">newName</span>)&#123;</span><br><span class="line">            myName = newName</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> innerBar</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="title function_">foo</span>()</span><br><span class="line"><span class="title class_">Bar</span>.<span class="property">setName</span> (<span class="string">&quot;big tree&quot;</span>)</span><br><span class="line">bar.<span class="title function_">getName</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">getName</span>())</span><br></pre></td></tr></table></figure><p>First, let’s take a look at the stack when executing the return innerBar line of code inside the foo function. You can refer to the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615207902/origin-of-ray/微信截图_20210308205133_amqnac.png" alt="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615207902/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210308205133_amqnac.png"></p><p>As you can see from the above code, innerBar is an object that contains two methods of getName and setName (usually we call the function inside the object a method). You can see that both methods are defined inside foo function, and both methods use two variables, myName and test1.</p><p> <strong>According to the rules of lexical scope, the inner function getName and setName can always access the variables in their outer function foo</strong> , so when the innerBar object returns to the global variable bar, although the foo function has finished executing, getName and setName function can still use the variables myName and test1 in the foo function. So when the foo function is executed, the state of its entire call stack is shown in the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1615208011/origin-of-ray/微信截图_20210308205319_qlouxj.png" alt="闭包原理"></p><p>As can be seen from the above figure, after the execution of foo function is completed, its execution context pops up from the stack top, but because the returned setName and getName methods use the variables myName and test1 inside foo function, these two variables are still saved in memory. This is very much like a dedicated backpack behind the setName and getName methods. No matter where the setName and getName methods are called, they will carry the exclusive backpack of this foo function.</p><p>The reason why it is a dedicated backpack is that the backpack cannot be accessed anywhere except for the setName and getName functions. We can call this backpack the closure of the foo function.</p><p>Okay, now we can finally give a formal definition of closure. <strong>In JavaScript, according to the rules of lexical scope, the inner function can always access the variables declared in its outer function. When an inner function is returned by calling an outer function, even if the outer function has finished executing, but the variables that the inner function refers to the outer function are still stored in memory, we call the collection of these variables closure. For example, if the outer function is foo, then the set of variables is called the closure</strong> of the foo function.</p><h3 id="Closure-recycling"><a href="#Closure-recycling" class="headerlink" title="Closure recycling"></a>Closure recycling</h3><p>After understanding what a closure is, let’s briefly talk about when a closure is destroyed. Because if the closure is used incorrectly, it can easily cause memory leaks. Paying attention to how the closure is reclaimed can make you use the closure correctly.</p><p>Usually, if the function referencing the closure is a global variable, the closure will exist until the page is closed; but if the closure is no longer used in the future, it will cause a memory leak.</p><p>If the function that references closure is a local variable, after the function is destroyed, the next time the JavaScript engine executes garbage collection, if the closure is no longer used, the JavaScript engine’s garbage collector will reclaim this memory.</p><p>So when using closures, you should try to pay attention to a principle: if the closure will be used all the time, then it can exist as a global variable; but if the frequency of use is not high, and the memory footprint is relatively large, then try to make it a local variable.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/25c6b127/" title="JavaScript Execution Mechanisms (3) Scope Chains and Closures">https://sunra.top/en/posts/25c6b127/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/bbe10e1c/" rel="prev" title="Browser Architecture"><i class="fa fa-chevron-left"></i> Browser Architecture</a></div><div class="post-nav-item"> <a href="/en/posts/5f6c244e/" rel="next" title="JavaScript Execution Mechanism (4) What does this point to?">JavaScript Execution Mechanism (4) What does this point to?<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/25c6b127/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>