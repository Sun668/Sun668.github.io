<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="A previous blog talked about the update process of React, but in that blog, task scheduling uses the browser’s requestIdleCallback, and in fact React uses a task scheduler implemented by itself. We wi"><meta property="og:type" content="article"><meta property="og:title" content="React Scheduler Source Code Analysis"><meta property="og:url" content="https://sunra.top/en/posts/28722/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="A previous blog talked about the update process of React, but in that blog, task scheduling uses the browser’s requestIdleCallback, and in fact React uses a task scheduler implemented by itself. We wi"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1672979542/origin-of-ray/screenshot-20230106-123045_zosxud.png"><meta property="article:published_time" content="2023-01-05T12:31:36.000Z"><meta property="article:modified_time" content="2024-11-23T04:57:12.130Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1672979542/origin-of-ray/screenshot-20230106-123045_zosxud.png"><link rel="canonical" href="https://sunra.top/en/posts/28722/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/28722/","path":"posts/28722/","title":"React Scheduler Source Code Analysis"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>React Scheduler Source Code Analysis | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#task-execution-method"><span class="nav-number">1.</span> <span class="nav-text">Task execution method</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mock-environment"><span class="nav-number">1.1.</span> <span class="nav-text">Mock environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#non-browsing-environment-or-when-messagechannel-is-not-supported"><span class="nav-number">1.2.</span> <span class="nav-text">Non-browsing environment or when MessageChannel is not supported</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#browser-environment-and-messagechannel-support"><span class="nav-number">1.3.</span> <span class="nav-text">Browser environment and MessageChannel support</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#use-the-three-functions-defined-above-to-achieve-scheduling-tasks-according-to-priority"><span class="nav-number">2.</span> <span class="nav-text">Use the three functions defined above to achieve scheduling tasks according to priority</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#flushfirstcallback"><span class="nav-number">2.1.</span> <span class="nav-text">flushFirstCallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ensurehostcallbackisscheduled"><span class="nav-number">2.2.</span> <span class="nav-text">ensureHostCallbackIsScheduled</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flushwork"><span class="nav-number">2.3.</span> <span class="nav-text">flushWork</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flushimmediatework"><span class="nav-number">2.4.</span> <span class="nav-text">flushImmediateWork</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#methods-of-external-exposure"><span class="nav-number">3.</span> <span class="nav-text">Methods of external exposure</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#unstable_schedulecallback"><span class="nav-number">3.1.</span> <span class="nav-text">unstable_scheduleCallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unstable_cancelcallback"><span class="nav-number">3.2.</span> <span class="nav-text">unstable_cancelCallback</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/28722/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="React Scheduler Source Code Analysis | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> React Scheduler Source Code Analysis</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2023-01-05 20:31:36" itemprop="dateCreated datePublished" datetime="2023-01-05T20:31:36+08:00">2023-01-05</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-11-23 12:57:12" itemprop="dateModified" datetime="2024-11-23T12:57:12+08:00">2024-11-23</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/28722/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/28722/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>A previous blog talked about the update process of React, but in that blog, task scheduling uses the browser’s requestIdleCallback, and in fact React uses a task scheduler implemented by itself. We will analyze its source this time. Code, and why React implements the task scheduler itself.</p><p>This article is based on the 16.18.6 branch in the React repository.</p><span id="more"></span><p>Scheduler’s source code is not much, probably more than 700 lines, which can be divided into three parts:</p><ul><li>Define the three functions of requestHostCallback, cancelHostCallback and shouldYieldToHost according to the actual running environment differences to implement task execution and cancellation.</li><li>Use the three functions defined above to achieve priority scheduling tasks</li><li>Expose some interfaces to the outside world to add, delete, and insert some tasks</li></ul><h1 id="task-execution-method"><a class="markdownIt-Anchor" href="#task-execution-method"></a> Task execution method</h1><p>About the role of this code, in the comments inside the source code said more clearly, if you do not want to know what is done, you can take a look at its comments:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The remaining code is essentially a polyfill for requestIdleCallback. It</span></span><br><span class="line"><span class="comment">// works by scheduling a requestAnimationFrame, storing the time for the start</span></span><br><span class="line"><span class="comment">// of the frame, then scheduling a postMessage which gets scheduled after paint.</span></span><br><span class="line"><span class="comment">// Within the postMessage handler do as much work as possible until time + frame</span></span><br><span class="line"><span class="comment">// rate. By separating the idle call into a separate event tick we ensure that</span></span><br><span class="line"><span class="comment">// layout, paint and other browser work is counted against the available time.</span></span><br><span class="line"><span class="comment">// The frame rate is dynamically adjusted.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We capture a local reference to any global, in case it gets polyfilled after</span></span><br><span class="line"><span class="comment">// this module is initially evaluated. We want to be using a</span></span><br><span class="line"><span class="comment">// consistent implementation.</span></span><br></pre></td></tr></table></figure><p>The translation is: The rest of the code is essentially the padding of the requestIdleCallback. It works by scheduling the requestAnimationFrame, storing the time when the frame started, and then scheduling the postMessage scheduled after drawing. Do as much work as possible in the postMessage handler until time + frame rate. By separating the idle calls into a separate event marker, we ensure that layout, drawing, and other browser work are counted in the available time. The frame rate is adjusted dynamically. We capture local references to any global variable in case it is populated after the initial calculation of this module. We want to use a consistent implementation.</p><p>Next, let’s take a formal look at the code. First, several methods such as setTimeout are assigned according to the results of the current environment judgment:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> localDate = <span class="title class_">Date</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This initialization code may run even on server environments if a component</span></span><br><span class="line"><span class="comment">// just imports ReactDOM (e.g. for findDOMNode). Some environments might not</span></span><br><span class="line"><span class="comment">// have setTimeout or clearTimeout. However, we always expect them to be defined</span></span><br><span class="line"><span class="comment">// on the client. https://github.com/facebook/react/pull/13088</span></span><br><span class="line"><span class="keyword">var</span> localSetTimeout = <span class="keyword">typeof</span> <span class="built_in">setTimeout</span> = <span class="string">&#x27;function&#x27;</span> ? <span class="built_in">setTimeout</span> : <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> localClearTimeout =</span><br><span class="line">  <span class="keyword">typeof</span> <span class="built_in">clearTimeout</span> = <span class="string">&#x27;function&#x27;</span> ? <span class="built_in">clearTimeout</span> : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We don&#x27;t expect either of these to necessarily be defined, but we will error</span></span><br><span class="line"><span class="comment">// later if they are missing on the client.</span></span><br><span class="line"><span class="keyword">var</span> localRequestAnimationFrame =</span><br><span class="line">  <span class="keyword">typeof</span> requestAnimationFrame = <span class="string">&#x27;function&#x27;</span></span><br><span class="line">    ? requestAnimationFrame</span><br><span class="line">    : <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">var</span> localCancelAnimationFrame =</span><br><span class="line">  <span class="keyword">typeof</span> cancelAnimationFrame = <span class="string">&#x27;function&#x27;</span> ? cancelAnimationFrame : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> getCurrentTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">// requestAnimationFrame does not run when the tab is in the background. If</span></span><br><span class="line"><span class="comment">// we&#x27;re backgrounded we prefer for that work to happen so that the page</span></span><br><span class="line"><span class="comment">// continues to load in the background. So we also schedule a &#x27;setTimeout&#x27; as</span></span><br><span class="line"><span class="comment">// a fallback.</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Need a better heuristic for backgrounded work.</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ANIMATION_FRAME_TIMEOUT</span> = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">var</span> rAFID;</span><br><span class="line"><span class="keyword">var</span> rAFTimeoutID;</span><br><span class="line"><span class="keyword">var</span> requestAnimationFrameWithTimeout = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="comment">// schedule rAF and also a setTimeout</span></span><br><span class="line">  rAFID = <span class="title function_">localRequestAnimationFrame</span>(<span class="keyword">function</span>(<span class="params">timestamp</span>) &#123;</span><br><span class="line">    <span class="comment">// cancel the setTimeout</span></span><br><span class="line">    <span class="title function_">localClearTimeout</span>(rAFTimeoutID);</span><br><span class="line">    <span class="title function_">callback</span>(timestamp);</span><br><span class="line">  &#125;);</span><br><span class="line">  rAFTimeoutID = <span class="title function_">localSetTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// cancel the requestAnimationFrame</span></span><br><span class="line">    <span class="title function_">localCancelAnimationFrame</span>(rAFID);</span><br><span class="line">    <span class="title function_">callback</span>(<span class="title function_">getCurrentTime</span>());</span><br><span class="line">  &#125;, <span class="variable constant_">ANIMATION_FRAME_TIMEOUT</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasNativePerformanceNow) &#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="title class_">Performance</span> = performance;</span><br><span class="line">  getCurrentTime = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Performance</span>.<span class="title function_">now</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  getCurrentTime = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> localDate.<span class="title function_">now</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then according to the different operating environment, define’requestHostCallback ‘,’ cancelHostCallback ‘,’ shouldYieldToHost 'three functions</p><h2 id="mock-environment"><a class="markdownIt-Anchor" href="#mock-environment"></a> Mock environment</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestHostCallback;</span><br><span class="line"><span class="keyword">var</span> cancelHostCallback;</span><br><span class="line"><span class="keyword">var</span> shouldYieldToHost;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> globalValue = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> ! <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  globalValue = <span class="variable language_">window</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">global</span> ! <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  globalValue = <span class="variable language_">global</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (globalValue &amp;&amp; globalValue.<span class="property">_schedMock</span>) &#123;</span><br><span class="line">  <span class="comment">// Dynamic injection, only for testing purposes.</span></span><br><span class="line">  <span class="keyword">var</span> globalImpl = globalValue.<span class="property">_schedMock</span>;</span><br><span class="line">  requestHostCallback = globalImpl[<span class="number">0</span>];</span><br><span class="line">  cancelHostCallback = globalImpl[<span class="number">1</span>];</span><br><span class="line">  shouldYieldToHost = globalImpl[<span class="number">2</span>];</span><br><span class="line">  getCurrentTime = globalImpl[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>That is to say, when we mount the _schedMock object to the global object, we will enter the mock judgment, and then use the methods we pass in to define several functions needed for task execution.</p><h2 id="non-browsing-environment-or-when-messagechannel-is-not-supported"><a class="markdownIt-Anchor" href="#non-browsing-environment-or-when-messagechannel-is-not-supported"></a> Non-browsing environment or when MessageChannel is not supported</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">  <span class="comment">// If Scheduler runs in a non-DOM environment, it falls back to a naive</span></span><br><span class="line">  <span class="comment">// implementation using setTimeout.</span></span><br><span class="line">  <span class="keyword">typeof</span> <span class="variable language_">window</span> = <span class="string">&#x27;undefined&#x27;</span> ||</span><br><span class="line">  <span class="comment">// Check if MessageChannel is supported, too.</span></span><br><span class="line">  <span class="keyword">typeof</span> <span class="title class_">MessageChannel</span> ! <span class="string">&#x27;function&#x27;</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="comment">// If this accidentally gets imported in a non-browser environment, e.g. JavaScriptCore,</span></span><br><span class="line">  <span class="comment">// fallback to a naive implementation.</span></span><br><span class="line">  <span class="keyword">var</span> _callback = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">var</span> _flushCallback = <span class="keyword">function</span>(<span class="params">didTimeout</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_callback ! <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">_callback</span>(didTimeout);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _callback = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  requestHostCallback = <span class="keyword">function</span>(<span class="params">cb, ms</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_callback ! <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Protect against re-entrancy.</span></span><br><span class="line">      <span class="built_in">setTimeout</span>(requestHostCallback, <span class="number">0</span>, cb);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _callback = cb;</span><br><span class="line">      <span class="built_in">setTimeout</span>(_flushCallback, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  cancelHostCallback = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    _callback = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  shouldYieldToHost = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code does the following things:</p><p>Declares a new variable _callback to store the currently executing callback</p><ul><li>_flushCallback function, when the _callback is not empty, execute the _callback, and then say _callback set to empty, indicating that there is no currently executing task, you can perform other tasks</li><li>‘requestHostCallback’ function, first determines whether _callback is null, if not null, indicating that there is currently a task being executed, then use setTimeout to add a macro task and continue to execute’requestHostCallback 'itself, although it looks like a recursion call here, but because of the use of setTimeout, the call stack does not actually grow. If _callback is null, indicating that there is no current task being executed, then assign the value _callback first, and then add a macro task to execute _flushCallback.</li><li>‘cancelHostCallback’ function is the _callback is empty, cancel the current task. In fact, if the current task has been added to the macro task queue, in this way can not be canceled, but note that our macro task queue is added to the _flushCallback function, if the _callback is empty, in fact, nothing will be done.</li><li>‘shouldYieldToHost’ must return false in this case.</li></ul><p>In general, ‘requestHostCallback’ is to determine whether there is currently a _callback in the execution, if there is, etc. (this is also achieved by the macro task callback itself), if not, add a macro task, and eventually add a macro task to execute the _flushCallback, that is, in theory, when there is a _callback in execution, the other’requestHostCallback ‘are queued through the macro task, and the final execution order is also the order of’requestHostCallback’.</p><p>However, if you call cancelHostCallback when clearing the microtask queue before executing the added macro task after the’requestHostCallback 'successfully adds the macro task, then in fact, nothing will be done when the _flushCallback is executed. Take a look at the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1672979542/origin-of-ray/screenshot-20230106-123045_zosxud.png" alt></p><p>Each box in the above figure represents a macro task. There are two pieces of information in the box, one is the function executed by the current macro task, and the other is the value of the current _callback.</p><p>The first line indicates the normal situation, we requested two tasks, and then executed them one by one. The second line is the special case, what happens if you cancel before executing _flushCallback</p><h2 id="browser-environment-and-messagechannel-support"><a class="markdownIt-Anchor" href="#browser-environment-and-messagechannel-support"></a> Browser environment and MessageChannel support</h2><p>The first is to print the error message. If the current environment does not support requestAnimationFrame, the error message will be printed, but it is only to print the error message.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">console</span> ! <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Remove fb.me link</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> localRequestAnimationFrame ! <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">      <span class="string">&quot;This browser doesn&#x27;t support requestAnimationFrame. &quot;</span> +</span><br><span class="line">        <span class="string">&#x27;Make sure that you load a &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;polyfill in older browsers. https://fb.me/react-polyfills&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> localCancelAnimationFrame ! <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(</span><br><span class="line">      <span class="string">&quot;This browser doesn&#x27;t support cancelAnimationFrame. &quot;</span> +</span><br><span class="line">        <span class="string">&#x27;Make sure that you load a &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;polyfill in older browsers. https://fb.me/react-polyfills&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then there are several variables. Understanding the role of these variables is important for understanding the following code.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Var</span> scheduledHostCallback = <span class="literal">null</span>;<span class="comment">//The currently executing task can be compared to the above _callback</span></span><br><span class="line"><span class="title class_">Var</span> isMessageEventScheduled = <span class="literal">false</span>;<span class="comment">//whether there is a MessageChannel message being processed</span></span><br><span class="line"><span class="title class_">Var</span> timeoutTime = -<span class="number">1</span>;<span class="comment">//of course the timeout of the task</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Var</span> isAnimationFrameScheduled = <span class="literal">false</span>;<span class="comment">//Is there a task added to the macro task by requestAnimationFrame</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Var</span> isFlushingHostCallback = <span class="literal">false</span>;<span class="comment">//whether there is a task being executed</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Var</span> frameDeadline = <span class="number">0</span>;<span class="comment">//Record the expiration time of the current frame, which is equal to rafTime + activeFrameTime, which is the time passed in by the requestAnimationFrame callback, plus the time of one frame</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We start out assuming that we run at 30fps but then the heuristic tracking</span></span><br><span class="line"><span class="comment">// will adjust this value to a faster fps if we get more frequent animation</span></span><br><span class="line"><span class="comment">// frames.</span></span><br><span class="line"><span class="keyword">var</span> previousFrameTime = <span class="number">33</span>;</span><br><span class="line"><span class="keyword">var</span> activeFrameTime = <span class="number">33</span>;</span><br></pre></td></tr></table></figure><p>After understanding these variables, let’s take a look at several tool functions.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animationTick = <span class="keyword">function</span>(<span class="params">rafTime</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (scheduledHostCallback ! <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Eagerly schedule the next animation callback at the beginning of the</span></span><br><span class="line">    <span class="comment">// frame. If the scheduler queue is not empty at the end of the frame, it</span></span><br><span class="line">    <span class="comment">// will continue flushing inside that callback. If the queue *is* empty,</span></span><br><span class="line">    <span class="comment">// then it will exit immediately. Posting the callback at the start of the</span></span><br><span class="line">    <span class="comment">// frame ensures it&#x27;s fired within the earliest possible frame. If we</span></span><br><span class="line">    <span class="comment">// waited until the end of the frame to post the callback, we risk the</span></span><br><span class="line">    <span class="comment">// browser skipping a frame and not firing the callback until the frame</span></span><br><span class="line">    <span class="comment">// after that.</span></span><br><span class="line">    <span class="title function_">requestAnimationFrameWithTimeout</span>(animationTick);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No pending work. Exit.</span></span><br><span class="line">    isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    nextFrameTime &lt; activeFrameTime &amp;&amp;</span><br><span class="line">    previousFrameTime &lt; activeFrameTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFrameTime &lt; <span class="number">8</span>) &#123;</span><br><span class="line">      <span class="comment">// Defensive coding. We don&#x27;t support higher frame rates than 120hz.</span></span><br><span class="line">      <span class="comment">// If the calculated frame time gets lower than 8, it is probably a bug.</span></span><br><span class="line">      nextFrameTime = <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If one frame goes long, then the next one can be short to catch up.</span></span><br><span class="line">    <span class="comment">// If two frames are short in a row, then that&#x27;s an indication that we</span></span><br><span class="line">    <span class="comment">// actually have a higher frame rate than what we&#x27;re currently optimizing.</span></span><br><span class="line">    <span class="comment">// We adjust our heuristic dynamically accordingly. For example, if we&#x27;re</span></span><br><span class="line">    <span class="comment">// running on 120hz display or 90hz VR display.</span></span><br><span class="line">    <span class="comment">// Take the max of the two in case one of them was an anomaly due to</span></span><br><span class="line">    <span class="comment">// missed frame deadlines.</span></span><br><span class="line">    activeFrameTime =</span><br><span class="line">      nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    previousFrameTime = nextFrameTime;</span><br><span class="line">  &#125;</span><br><span class="line">  frameDeadline = rafTime + activeFrameTime;</span><br><span class="line">  <span class="keyword">if</span> (!isMessageEventScheduled) &#123;</span><br><span class="line">    isMessageEventScheduled = <span class="literal">true</span>;</span><br><span class="line">    port.<span class="title function_">postMessage</span>(<span class="literal">undefined</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>This method mainly does two things:</p><ul><li>As long as’scheduledHostCallback ‘is not empty, it means that there is currently a task being executed, and it continues to call itself through’requestAnimationFrameWithTimeout’ to recalculate the time used for each frame, that is, update’previousFrameTime ‘and’activeFrameTime’. If the current’scheduledHostCallback 'is empty, then return directly, that is, stop updating the time used for each frame.</li><li>At the same time, if’isMessageEventScheduled 'is false during each execution, a MessageChannel message will be triggered.</li></ul><p>Then there is the MessageChannel’s method of processing messages.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">channel.<span class="property">port1</span>.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prevScheduledCallback = scheduledHostCallback;</span><br><span class="line">  <span class="keyword">var</span> prevTimeoutTime = timeoutTime;</span><br><span class="line">  scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">  timeoutTime = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> currentTime = <span class="title function_">getCurrentTime</span> ();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> didTimeout = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (frameDeadline - currentTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s no time left in this idle period. Check if the callback has</span></span><br><span class="line">    <span class="comment">// a timeout and whether it&#x27;s been exceeded.</span></span><br><span class="line">    <span class="keyword">if</span> (prevTimeoutTime ! -<span class="number">1</span> &amp;&amp; prevTimeoutTime &lt;= currentTime) &#123;</span><br><span class="line">      <span class="comment">// Exceeded the timeout. Invoke the callback even though there&#x27;s no</span></span><br><span class="line">      <span class="comment">// time left.</span></span><br><span class="line">      didTimeout = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// No timeout.</span></span><br><span class="line">      <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">        <span class="comment">// Schedule another animation callback so we retry later.</span></span><br><span class="line">        isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">requestAnimationFrameWithTimeout</span>(animationTick);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Exit without invoking the callback.</span></span><br><span class="line">      scheduledHostCallback = prevScheduledCallback;</span><br><span class="line">      timeoutTime = prevTimeoutTime;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevScheduledCallback ! <span class="literal">null</span>) &#123;</span><br><span class="line">    isFlushingHostCallback = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">prevScheduledCallback</span>(didTimeout);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isFlushingHostCallback = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The main things this processing function does are:</p><ul><li>Determine if the current time has exceeded our specified end time for this frame<ul><li>If it exceeds, determine whether the current task has a timeout and has already started execution<ul><li>If there is and it starts executing, then continue to execute it</li><li>If not, perform the next task in the next frame</li></ul></li></ul></li></ul><p>Now we can look at the task execution function under this condition.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">requestHostCallback = <span class="keyword">function</span>(<span class="params">callback, absoluteTimeout</span>) &#123;</span><br><span class="line">  scheduledHostCallback = callback;</span><br><span class="line">  timeoutTime = absoluteTimeout;</span><br><span class="line">  <span class="keyword">if</span> (isFlushingHostCallback || absoluteTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t wait for the next frame. Continue working ASAP, in a new event.</span></span><br><span class="line">    port.<span class="title function_">postMessage</span>(<span class="literal">undefined</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">    <span class="comment">// If rAF didn&#x27;t already schedule one, we need to schedule a frame.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If this rAF doesn&#x27;t materialize because the browser throttles, we</span></span><br><span class="line">    <span class="comment">// might want to still have setTimeout trigger rIC as a backup to ensure</span></span><br><span class="line">    <span class="comment">// that we keep performing work.</span></span><br><span class="line">    isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">requestAnimationFrameWithTimeout</span>(animationTick);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">cancelHostCallback = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">  isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line">  timeoutTime = -<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="use-the-three-functions-defined-above-to-achieve-scheduling-tasks-according-to-priority"><a class="markdownIt-Anchor" href="#use-the-three-functions-defined-above-to-achieve-scheduling-tasks-according-to-priority"></a> Use the three functions defined above to achieve scheduling tasks according to priority</h1><p>The first is to declare some variables</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">ImmediatePriority</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">UserBlockingPriority</span> = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">NormalPriority</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">LowPriority</span> = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">IdlePriority</span> = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Max 31 bit integer. The max integer size in V8 for 32-bit systems.</span></span><br><span class="line"><span class="comment">// Math.pow(2, 30) - 1</span></span><br><span class="line"><span class="comment">// 0b111111111111111111111111111111</span></span><br><span class="line"><span class="keyword">var</span> maxSigned31BitInt = <span class="number">1073741823</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Times out immediately</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">IMMEDIATE_PRIORITY_TIMEOUT</span> = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// Eventually times out</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">USER_BLOCKING_PRIORITY</span> = <span class="number">250</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">NORMAL_PRIORITY_TIMEOUT</span> = <span class="number">5000</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">LOW_PRIORITY_TIMEOUT</span> = <span class="number">10000</span>;</span><br><span class="line"><span class="comment">// Never times out</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">IDLE_PRIORITY</span> = maxSigned31BitInt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callbacks are stored as a circular, doubly linked list.</span></span><br><span class="line"><span class="keyword">var</span> firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentDidTimeout = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// Pausing the scheduler is useful for debugging.</span></span><br><span class="line"><span class="keyword">var</span> isSchedulerPaused = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> currentPriorityLevel = <span class="title class_">NormalPriority</span>;</span><br><span class="line"><span class="keyword">var</span> currentEventStartTime = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> currentExpirationTime = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is set when a callback is being executed, to prevent re-entrancy.</span></span><br><span class="line"><span class="keyword">var</span> isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hasNativePerformanceNow =</span><br><span class="line">  <span class="keyword">typeof</span> performance = <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> performance.<span class="property">now</span> = <span class="string">&#x27;function&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="flushfirstcallback"><a class="markdownIt-Anchor" href="#flushfirstcallback"></a> flushFirstCallback</h2><p>First of all, understand that all callbackNodes form a bidirectional ring, that is, each node has previous and next, and the next of the last node is the first node, and the previous of the first node is the last node.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushFirstCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//Save firstCallbackNode as flushedNode and it will be used later</span></span><br><span class="line">  <span class="keyword">var</span> flushedNode = firstCallbackNode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove the node from the list before calling the callback. That way the</span></span><br><span class="line">  <span class="comment">// list is in a consistent state even if the callback throws.</span></span><br><span class="line">  <span class="keyword">var</span> next = firstCallbackNode.<span class="property">next</span>;</span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode = next) &#123;</span><br><span class="line">    <span class="comment">// This is the last callback in the list.</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">    next = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//Remove firstCallbackNode from the task ring by making the previous of firstCallbackNode point to the next of firstCallbackNode</span></span><br><span class="line">    <span class="comment">//also make firstCallbackNode point to the next node</span></span><br><span class="line">    <span class="keyword">var</span> lastCallbackNode = firstCallbackNode.<span class="property">previous</span>;</span><br><span class="line">    firstCallbackNode = lastCallbackNode.<span class="property">next</span> = next;</span><br><span class="line">    next.<span class="property">previous</span> = lastCallbackNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//flushedNode is the current task node to be executed</span></span><br><span class="line">  flushedNode.<span class="property">next</span> = flushedNode.<span class="property">previous</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now it&#x27;s safe to call the callback.</span></span><br><span class="line">  <span class="comment">//Execute the callback of the current node</span></span><br><span class="line">  <span class="keyword">var</span> callback = flushedNode.<span class="property">callback</span>;</span><br><span class="line">  <span class="keyword">var</span> expirationTime = flushedNode.<span class="property">expirationTime</span>;</span><br><span class="line">  <span class="keyword">var</span> priorityLevel = flushedNode.<span class="property">priorityLevel</span>;</span><br><span class="line">  <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">  <span class="keyword">var</span> previousExpirationTime = currentExpirationTime;</span><br><span class="line">  currentPriorityLevel = priorityLevel;</span><br><span class="line">  currentExpirationTime = expirationTime;</span><br><span class="line">  <span class="keyword">var</span> continuationCallback;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    continuationCallback = <span class="title function_">callback</span>();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">    currentExpirationTime = previousExpirationTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A callback may return a continuation. The continuation should be scheduled</span></span><br><span class="line">  <span class="comment">// with the same priority and expiration as the just-finished callback.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> continuationCallback = <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">continuationNode</span>: <span class="title class_">CallbackNode</span> = &#123;</span><br><span class="line">      <span class="attr">callback</span>: continuationCallback,</span><br><span class="line">      priorityLevel,</span><br><span class="line">      expirationTime,</span><br><span class="line">      <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">previous</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Insert the new callback into the list, sorted by its expiration. This is</span></span><br><span class="line">    <span class="comment">// almost the same as the code in `scheduleCallback`, except the callback</span></span><br><span class="line">    <span class="comment">// is inserted into the list *before* callbacks of equal expiration instead</span></span><br><span class="line">    <span class="comment">// of after.</span></span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode = <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first callback in the list.</span></span><br><span class="line">      firstCallbackNode = continuationNode.<span class="property">next</span> = continuationNode.<span class="property">previous</span> = continuationNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> nextAfterContinuation = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.<span class="property">expirationTime</span> &gt;= expirationTime) &#123;</span><br><span class="line">          <span class="comment">// This callback expires at or after the continuation. We will insert</span></span><br><span class="line">          <span class="comment">// the continuation *before* this callback.</span></span><br><span class="line">          nextAfterContinuation = node;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.<span class="property">next</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (node ! firstCallbackNode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextAfterContinuation = <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No equal or lower priority callback was found, which means the new</span></span><br><span class="line">        <span class="comment">// callback is the lowest priority callback in the list.</span></span><br><span class="line">        nextAfterContinuation = firstCallbackNode;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextAfterContinuation = firstCallbackNode) &#123;</span><br><span class="line">        <span class="comment">// The new callback is the highest priority callback in the list.</span></span><br><span class="line">        firstCallbackNode = continuationNode;</span><br><span class="line">        <span class="title function_">ensureHostCallbackIsScheduled</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> previous = nextAfterContinuation.<span class="property">previous</span>;</span><br><span class="line">      previous.<span class="property">next</span> = nextAfterContinuation.<span class="property">previous</span> = continuationNode;</span><br><span class="line">      continuationNode.<span class="property">next</span> = nextAfterContinuation;</span><br><span class="line">      continuationNode.<span class="property">previous</span> = previous;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code mainly does the following things:</p><ul><li>Find the node pointed to by’firstCallbackNode 'from the bidirectional ring of task nodes, take it out of the ring and execute</li><li>If the result of the execution is still a function, that is, the callback returns a function, then create a callbackNode with the returned function, and then insert it into the ring. The specific location is before the’nextAfterContinuation ‘node in the code. How to get the’nextAfterContinuation’ can be seen in the above source code<ul><li>One thing to note here is that if’nextAfterContinuation ‘is’firstCallbackNode’, that is to say, when the new task node created by the function returned by the current callback needs to be inserted before’firstCallbackNode ‘, it needs to execute’ensureHostCallbackIsScheduled’</li></ul></li></ul><h2 id="ensurehostcallbackisscheduled"><a class="markdownIt-Anchor" href="#ensurehostcallbackisscheduled"></a> ensureHostCallbackIsScheduled</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ensureHostCallbackIsScheduled</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isExecutingCallback) &#123;</span><br><span class="line">    <span class="comment">// Don&#x27;t schedule work yet; wait until the next time we yield.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Schedule the host callback using the earliest expiration in the list.</span></span><br><span class="line">  <span class="keyword">var</span> expirationTime = firstCallbackNode.<span class="property">expirationTime</span>;</span><br><span class="line">  <span class="keyword">if</span> (!isHostCallbackScheduled) &#123;</span><br><span class="line">    isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Cancel the existing host callback.</span></span><br><span class="line">    <span class="title function_">cancelHostCallback</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">requestHostCallback</span>(flushWork, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This function is to do nothing if a callback is currently being executed, that is, ‘isExecutingCallback’ is true. Otherwise, cancel the current hostcallback and add flushWork to the task queue</p><h2 id="flushwork"><a class="markdownIt-Anchor" href="#flushwork"></a> flushWork</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushWork</span>(<span class="params">didTimeout</span>) &#123;</span><br><span class="line">  <span class="comment">// Exit right away if we&#x27;re currently paused</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isExecutingCallback = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> previousDidTimeout = currentDidTimeout;</span><br><span class="line">  currentDidTimeout = didTimeout;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (didTimeout) &#123;</span><br><span class="line">      <span class="comment">// Flush all the expired callbacks without yielding.</span></span><br><span class="line">      <span class="keyword">while</span> (</span><br><span class="line">        firstCallbackNode ! <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// TODO Wrap in feature flag</span></span><br><span class="line">        <span class="comment">// Read the current time. Flush all the callbacks that expire at or</span></span><br><span class="line">        <span class="comment">// earlier than that time. Then read the current time again and repeat.</span></span><br><span class="line">        <span class="comment">// This optimizes for as few performance.now calls as possible.</span></span><br><span class="line">        <span class="keyword">var</span> currentTime = <span class="title function_">getCurrentTime</span> ();</span><br><span class="line">        <span class="keyword">if</span> (firstCallbackNode.<span class="property">expirationTime</span> &lt;= currentTime) &#123;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="title function_">flushFirstCallback</span>();</span><br><span class="line">          &#125; <span class="keyword">while</span> (</span><br><span class="line">            firstCallbackNode ! <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            firstCallbackNode.<span class="property">expirationTime</span> &lt;= currentTime &amp;&amp;</span><br><span class="line">            !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Keep flushing callbacks until we run out of time in the frame.</span></span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode ! <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">flushFirstCallback</span>();</span><br><span class="line">        &#125; <span class="keyword">while</span> (firstCallbackNode ! <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYieldToHost</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line">    currentDidTimeout = previousDidTimeout;</span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode ! <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// There&#x27;s still work remaining. Request another callback.</span></span><br><span class="line">      <span class="title function_">ensureHostCallbackIsScheduled</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Before exiting, flush all the immediate work that was scheduled.</span></span><br><span class="line">    <span class="title function_">flushImmediateWork</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code directly looks at the comments, and the role of’flushImmediateWork 'is actually mentioned in the comments, running all tasks with immediate priority</p><h2 id="flushimmediatework"><a class="markdownIt-Anchor" href="#flushimmediatework"></a> flushImmediateWork</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushImmediateWork</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// Confirm we&#x27;ve exited the outer most event handler</span></span><br><span class="line">    currentEventStartTime = -<span class="number">1</span> &amp;&amp;</span><br><span class="line">    firstCallbackNode ! <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    firstCallbackNode.<span class="property">priorityLevel</span> = <span class="title class_">ImmediatePriority</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    isExecutingCallback = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="title function_">flushFirstCallback</span>();</span><br><span class="line">      &#125; <span class="keyword">while</span> (</span><br><span class="line">        <span class="comment">// Keep flushing until there are no more immediate callbacks</span></span><br><span class="line">        firstCallbackNode ! <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        firstCallbackNode.<span class="property">priorityLevel</span> = <span class="title class_">ImmediatePriority</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode ! <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There&#x27;s still work remaining. Request another callback.</span></span><br><span class="line">        <span class="title function_">ensureHostCallbackIsScheduled</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="methods-of-external-exposure"><a class="markdownIt-Anchor" href="#methods-of-external-exposure"></a> Methods of external exposure</h1><p>Here we mainly talk about two methods, one is unstable_scheduleCallback, one is unstable_cancelCallback</p><h2 id="unstable_schedulecallback"><a class="markdownIt-Anchor" href="#unstable_schedulecallback"></a> unstable_scheduleCallback</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unstable_scheduleCallback</span>(<span class="params">callback, deprecated_options</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> startTime =</span><br><span class="line">    currentEventStartTime ! -<span class="number">1</span> ? currentEventStartTime : <span class="title function_">getCurrentTime</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options = <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">    deprecated_options ! <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options.<span class="property">timeout</span> = <span class="string">&#x27;number&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> Remove this branch once we lift expiration times out of React.</span></span><br><span class="line">    expirationTime = startTime + deprecated_options.<span class="property">timeout</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPriorityLevel) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ImmediatePriority</span>:</span><br><span class="line">        expirationTime = startTime + <span class="variable constant_">IMMEDIATE_PRIORITY_TIMEOUT</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">UserBlockingPriority</span>:</span><br><span class="line">        expirationTime = startTime + <span class="variable constant_">USER_BLOCKING_PRIORITY</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">IdlePriority</span>:</span><br><span class="line">        expirationTime = startTime + <span class="variable constant_">IDLE_PRIORITY</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">LowPriority</span>:</span><br><span class="line">        expirationTime = startTime + <span class="variable constant_">LOW_PRIORITY_TIMEOUT</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">NormalPriority</span>:</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        expirationTime = startTime + <span class="variable constant_">NORMAL_PRIORITY_TIMEOUT</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newNode = &#123;</span><br><span class="line">    callback,</span><br><span class="line">    <span class="attr">priorityLevel</span>: currentPriorityLevel,</span><br><span class="line">    expirationTime,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">previous</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Insert the new callback into the list, ordered first by expiration, then</span></span><br><span class="line">  <span class="comment">// by insertion. So the new callback is inserted any other callback with</span></span><br><span class="line">  <span class="comment">// equal expiration.</span></span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode = <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first callback in the list.</span></span><br><span class="line">    firstCallbackNode = newNode.<span class="property">next</span> = newNode.<span class="property">previous</span> = newNode;</span><br><span class="line">    <span class="title function_">ensureHostCallbackIsScheduled</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> next = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">expirationTime</span> &gt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// The new callback expires before this one.</span></span><br><span class="line">        next = node;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (node ! firstCallbackNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next = <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// No callback with a later expiration was found, which means the new</span></span><br><span class="line">      <span class="comment">// callback has the latest expiration in the list.</span></span><br><span class="line">      next = firstCallbackNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next = firstCallbackNode) &#123;</span><br><span class="line">      <span class="comment">// The new callback has the earliest expiration in the entire list.</span></span><br><span class="line">      firstCallbackNode = newNode;</span><br><span class="line">      <span class="title function_">ensureHostCallbackIsScheduled</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previous = next.<span class="property">previous</span>;</span><br><span class="line">    previous.<span class="property">next</span> = next.<span class="property">previous</span> = newNode;</span><br><span class="line">    newNode.<span class="property">next</span> = next;</span><br><span class="line">    newNode.<span class="property">previous</span> = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code looks very long, but it actually does two things:</p><ul><li>Create a new callbackNode</li><li>Add new callbackNode to callbackNode’s bidirectional ring based on time and priority</li></ul><h2 id="unstable_cancelcallback"><a class="markdownIt-Anchor" href="#unstable_cancelcallback"></a> unstable_cancelCallback</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unstable_cancelCallback</span>(<span class="params">callbackNode</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> next = callbackNode.<span class="property">next</span>;</span><br><span class="line">  <span class="keyword">if</span> (next = <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Already cancelled.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (next = callbackNode) &#123;</span><br><span class="line">    <span class="comment">// This is the only scheduled callback. Clear the list.</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Remove the callback from its position in the list.</span></span><br><span class="line">    <span class="keyword">if</span> (callbackNode = firstCallbackNode) &#123;</span><br><span class="line">      firstCallbackNode = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> previous = callbackNode.<span class="property">previous</span>;</span><br><span class="line">    previous.<span class="property">next</span> = next;</span><br><span class="line">    next.<span class="property">previous</span> = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  callbackNode.<span class="property">next</span> = callbackNode.<span class="property">previous</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This is also relatively simple, which is to find the task to cancel from the two-way loop of callbackNode, and then remove it from the loop.</p><blockquote><p>The main changes in the latest version of Scheduler are: instead of using doubly linked list to store all tasks, two minimum heaps are used, called timerQueue and taskQueue respectively. The task will be placed in the timerQueue first. After the task in the taskQueue is completed, check if there are any expired tasks in the timerQueue. If there are, put them in the taskQueue, and then start traversing the tasks in the taskQueue again. If you need to yield during the traversal process, you will temporarily exit, and then open the setting macro task to continue execution next time</p></blockquote></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/28722/" title="React Scheduler Source Code Analysis">https://sunra.top/en/posts/28722/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/32270/" rel="prev" title="Dichotomy Method for Solving the Optimum Problem of Bounded Interval"><i class="fa fa-chevron-left"></i> Dichotomy Method for Solving the Optimum Problem of Bounded Interval</a></div><div class="post-nav-item"> <a href="/en/posts/5352/" rel="next" title="Hungary algorithm">Hungary algorithm<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/28722/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>