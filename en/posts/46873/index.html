<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="After introducing a new plugin into the project this week, local debugging is normal, but some files will be lost when a large package comes out. After checking for a long time, I found that it is bec"><meta property="og:type" content="article"><meta property="og:title" content="Unity Managed Code Stripping with Linker"><meta property="og:url" content="https://sunra.top/en/posts/46873/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="After introducing a new plugin into the project this week, local debugging is normal, but some files will be lost when a large package comes out. After checking for a long time, I found that it is bec"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-07-27T07:27:13.000Z"><meta property="article:modified_time" content="2023-07-03T02:07:12.436Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/46873/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/46873/","path":"posts/46873/","title":"Unity Managed Code Stripping with Linker"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Unity Managed Code Stripping with Linker | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Managed-code-stripping"><span class="nav-number">1.</span> <span class="nav-text">Managed code stripping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-code-clipping"><span class="nav-number">1.1.</span> <span class="nav-text">Configure code clipping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Preserve-code-through-annotations"><span class="nav-number">1.2.</span> <span class="nav-text">Preserve code through annotations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Root"><span class="nav-number">1.3.</span> <span class="nav-text">Root</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Use-the-Preserve-attribute-to-mark-the-root"><span class="nav-number">1.3.1.</span> <span class="nav-text">Use the Preserve attribute to mark the root</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Use-XML-files-to-mark"><span class="nav-number">1.3.2.</span> <span class="nav-text">Use XML files to mark</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Properties-of-XML"><span class="nav-number">1.3.3.</span> <span class="nav-text">Properties of XML</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dependency"><span class="nav-number">1.4.</span> <span class="nav-text">Dependency</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Annotation"><span class="nav-number">1.4.1.</span> <span class="nav-text">Annotation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AlwaysLinkAssembly"><span class="nav-number">1.4.2.</span> <span class="nav-text">AlwaysLinkAssembly</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unity"><span class="nav-number">2.</span> <span class="nav-text">Unity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#How-the-linker-works"><span class="nav-number">2.1.</span> <span class="nav-text">How the linker works</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Link-xml-file-features"><span class="nav-number">2.2.</span> <span class="nav-text">Link.xml file features</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Modify-the-code-of-Method"><span class="nav-number">2.3.</span> <span class="nav-text">Modify the code of Method</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/46873/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Unity Managed Code Stripping with Linker | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Unity Managed Code Stripping with Linker</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-07-27 15:27:13" itemprop="dateCreated datePublished" datetime="2022-07-27T15:27:13+08:00">2022-07-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-07-03 10:07:12" itemprop="dateModified" datetime="2023-07-03T10:07:12+08:00">2023-07-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/46873/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/46873/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>After introducing a new plugin into the project this week, local debugging is normal, but some files will be lost when a large package comes out. After checking for a long time, I found that it is because the file is not directly referenced, and it is through’ScriptableObject. CreateInstance (typeName) ‘This form was dynamically created, so it was finally packed and removed by the code clipping process.</p><p>The solution is also relatively simple, add a link.xml in the Assets directory, and then declare that the assembly cannot be trimmed.</p><p>But looking back, we still need to take a look at the logic of this code clipping and why link.xml can avoid code clipping.</p><span id="more"></span><h2 id="Managed-code-stripping"><a href="#Managed-code-stripping" class="headerlink" title="Managed code stripping"></a>Managed code stripping</h2><p>During the build process, Unity removes unused or inaccessible code through managed code stripping, which can significantly reduce the size of the final product. Managed code stripping removes code from a managed assembly, which includes the assembly where the C #code in the project is located, the assembly where the plugin or third-party package is located, and the assembly where the .NET Framework is located.</p><p>Unity uses a tool called Unity Linker to perform static code inspection. Static analysis can identify any class, part of a class, part of a function, or part of a function that cannot be reached during execution. This inspection will only be performed on code that exists at build time, and code generated dynamically at runtime will not be detected.</p><h3 id="Configure-code-clipping"><a href="#Configure-code-clipping" class="headerlink" title="Configure code clipping"></a>Configure code clipping</h3><p>We can control the degree of tailoring of Unity executable code by using’Managed Stripping Level ‘. In order to avoid Unity removing certain parts of the code we specifically specify, we can use some kind of comment to declare which parts should be retained by Unity Linker.</p><p>We can modify the level of code clipping in Player Settings. The optional values are as follows:</p><ul><li>Disabled: Unity does not do any code clipping. This configuration can only be selected when we use Mono, and is the default configuration</li><li>Minimal: Unity will only detect UnityEngine and .NET code. No user code will be removed. This configuration is least likely to cause unexpected runtime performance. This configuration is mostly used in products where usability priority is higher than package size. This configuration is the default configuration for IL2CPP</li><li>Low: Unity searches for some user assemblies and all UnityEngine and .NET code. This setting applies a set of rules that remove some unused code, but minimizes the possibility of unintended consequences, such as changes in the behavior of runtime code that uses reflection.</li><li>Medium: Unity partially searches all assemblies for inaccessible code. This setting applies a set of rules that remove more types of code patterns to reduce build size. Although Unity does not remove all possible inaccessible code, this setting does increase the risk of unwanted or unexpected behavior changes.</li><li>High: Unity performs the most extensive inspection of all assemblies, Unity prioritizes reducing code size over code stability, and removes as much code as possible.</li></ul><h3 id="Preserve-code-through-annotations"><a href="#Preserve-code-through-annotations" class="headerlink" title="Preserve code through annotations"></a>Preserve code through annotations</h3><p>We can use annotations to prevent the Unity Linker from tailoring parts of the code we make. This is useful when our application generates runtime code, such as when we use reflection in our code. Comments either provide general guidance to the Unity linker, telling it which code patterns should not be removed, or telling it not to remove specific, defined code segments</p><p>There are two main ways to annotate code to save it during the managed code stripping process:</p><ul><li>Root annotations identify parts of the code as root. The Unity linker does not remove any code marked as root. Root annotations are less complicated to use, but also cause the Unity linker to keep some code that should be removed</li><li>Annotations define the connections between code elements. Compared to root annotations, dependency annotations can reduce the amount of oversaved code</li></ul><p>Each of these techniques provides more control over the amount of code the Unity linker strips at higher stripping levels and reduces the chance of important code being stripped. Comments are especially useful when your code references other code through reflection, as the Unity linker cannot always detect the use of reflection.</p><h3 id="Root"><a href="#Root" class="headerlink" title="Root"></a>Root</h3><p>Root comments force Unity Linker to treat the code element as the root element, so that code changes will not be cut.</p><p>There are two ways to mark a piece of code as a root element, and the choice of two ways depends on whether you want to keep the constructor function of the assembly or a single type</p><ul><li>Preserve Attribute: Preserve a single type as the root element</li><li>Link.xml: holds the entire assembly as root, as well as other assemblies referenced by the modified assembly</li></ul><h4 id="Use-the-Preserve-attribute-to-mark-the-root"><a href="#Use-the-Preserve-attribute-to-mark-the-root" class="headerlink" title="Use the Preserve attribute to mark the root"></a>Use the Preserve attribute to mark the root</h4><p>Use the Preserve property to individually exclude specific parts of code from the static analysis of the Unity linker. To annotate code snippets with this property, add [Preserve] immediately before the first part of the code you want to keep. The following list describes the entities that the Unity linker keeps when you annotate different code elements with the [Preserve] property</p><ul><li>Assembly: Preserves all types that are used and defined in the assembly. To assign the [Preserve] attribute to an assembly, place the attribute declaration in any C# file included in the assembly, before any namespace declarations.</li><li>Type: Preserves a class or type and its default constructor.</li><li>Method: Preserves the method, the type that declares the method, the type the method returns, and the types of all of its arguments.</li><li>Property: Preserves the property, the type that declares the property, the value type of the property, and methods that get and set the property value.</li><li>Field: Preserves the field, the field type, and the type that declares the field.</li><li>Event: Preserves the event, the type that declares the event, type, the type the event returns, the [add] accessor, and the [remove] accessor.</li><li>Delegate: Preserves the delegate type and all methods that the delegate invokes.</li></ul><p>If you want to keep both a type and its default constructor, you can use the [Preserve] property. If you want to keep one of them, but not both, use the link.xml file</p><h4 id="Use-XML-files-to-mark"><a href="#Use-XML-files-to-mark" class="headerlink" title="Use XML files to mark"></a>Use XML files to mark</h4><p>An xml file named link.xml can be used in a project to keep a list of specific assemblies or parts of assemblies. The Xml file must appear in the Assets folder or a subdirectory of the Assets folder in the project and must include the ‘&lt; linker &gt;’ tag in the file. The Unity linker treats any assemblies, types, or members saved in the link.xml file as root types.</p><p>You can use any number of link.xml files in your project. Therefore, you can provide a separate save declaration for each plug-in. You cannot include a link.xml file in a Package, but you can reference a Package assembly from a non-Package link.xml file.</p><p>Below is an official example</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">linker</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--Preserve types and members in an assembly--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Preserve an entire type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span> <span class="attr">preserve</span>=<span class="string">&quot;all&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--No &quot;preserve&quot; attribute and no members specified means preserve all members--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve all fields on a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span> <span class="attr">preserve</span>=<span class="string">&quot;fields&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve all fields on a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span> <span class="attr">preserve</span>=<span class="string">&quot;methods&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserve the type only--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span> <span class="attr">preserve</span>=<span class="string">&quot;nothing&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--Preserving only specific members of a type--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;AssemblyName.MethodName&quot;</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">      <span class="comment">&lt;!--Fields--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">signature</span>=<span class="string">&quot;System.Int32 FieldName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a field by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;FieldName&quot;</span> /&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">&lt;!--Methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">&quot;System.Void MethodName()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a method with parameters--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">&quot;System.Void MethodName(System.Int32,System.String)&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a method by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">method</span> <span class="attr">name</span>=<span class="string">&quot;MethodName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Properties--&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it&#x27;s backing field (if present), </span></span><br><span class="line"><span class="comment">          getter, and setter methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">&quot;System.Int32 PropertyName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">&quot;System.Int32 PropertyName&quot;</span> <span class="attr">accessors</span>=<span class="string">&quot;all&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it&#x27;s backing field (if present), and getter method--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">&quot;System.Int32 PropertyName&quot;</span> <span class="attr">accessors</span>=<span class="string">&quot;get&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property, it&#x27;s backing field (if present), and setter method--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">signature</span>=<span class="string">&quot;System.Int32 PropertyName&quot;</span> <span class="attr">accessors</span>=<span class="string">&quot;set&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve a property by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;PropertyName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Events--&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve an event, it&#x27;s backing field (if present), add, and remove methods--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">event</span> <span class="attr">signature</span>=<span class="string">&quot;System.EventHandler EventName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!--Preserve an event by name rather than signature--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">event</span> <span class="attr">name</span>=<span class="string">&quot;EventName&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">linker</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Properties-of-XML"><a href="#Properties-of-XML" class="headerlink" title="Properties of XML"></a>Properties of XML</h4><p>The ‘&lt; assembly &gt;’ tag of the link.xml file has three attributes that allow us to control the code tailoring more finely</p><ul><li>ignoreIfMissing: Use this attribute if you need to declare preservations for an assembly that doesn’t exist during all Player builds.</li><li>ignoreIfUnreferenced: In some cases, you might want to preserve entities in an assembly only when that assembly is referenced by another assembly. Use this attribute to preserve the entities in an assembly only when at least one type is referenced in an assembly.</li><li>windowsruntime: When you define preservations for a Windows Runtime Metadata (.winmd) assembly, you must add the windowsruntime attribute to the <code>&lt;assembly&gt;</code>element in the link.xml file:</li></ul><h3 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h3><p>Dependency comments define the dependencies between different code elements. These comments are useful for preserving code patterns (such as reflection) that the Unity linker cannot statically analyze. These comments also ensure that these code elements are not mistakenly retained when no root element is used. There are two methods that can be used to change the way the Unity linker handles code elements:</p><ul><li>Annotation attributes: These attributes indicate that the Unity linker should retain specific code patterns, such as any type derived from an annotation type.</li><li>AlwaysLinkAssemblyAttribute: Use this attribute to indicate that the Unity linker should process an assembly, even if it is not referenced by any other assemblies in the project.</li></ul><h4 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h4><p>[ Preserve ]属性对于总是需要 API 的情况非常有用。其他属性可以用于更一般的保存。例如，您可以通过使用 RequreComplementorsAttribute 对接口进行注释来保留实现特定接口的所有类型。</p><p>To annotate a specific encoding mode, please use one or more of the following attributes:</p><ul><li>RequireImplementorsAttribute: marks all types that implement this interface as dependencies.</li><li>RequireDerivedAttribute: marks all types that derive from this type as dependencies.</li><li>RequiredInterfaceAttribute: marks interface implementations on types as dependencies.</li><li>RequiredMemberAttribute: marks all members of a type as dependencies.</li><li>RequireAttributeUsagesAttribute: marks custom attributes as dependencies.</li></ul><h4 id="AlwaysLinkAssembly"><a href="#AlwaysLinkAssembly" class="headerlink" title="AlwaysLinkAssembly"></a>AlwaysLinkAssembly</h4><p>[ AlwaysLinkAssembly ]属性强制 Unity 链接器搜索程序集，而不管该程序集是否被生成中包含的另一个程序集引用。只能将 AlwaysLinkAssembly 属性应用于程序集。</p><p>This property does not directly save the code within the assembly. Instead, this property instructs the Unity linker to apply the root markup rules to the assembly. <strong>If no code element matches the assembly’s root markup rules, the Unity linker will still remove the assembly from the build</strong> .</p><p>Use this property for precompiled or package assemblies that contain one or more types that have the RuntimeInitializeOnLoadMethod property, but may not contain types that are used directly or indirectly in any scenario</p><h2 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h2><p>The Unity build process uses a tool called the Unity linker to strip away managed code. The Unity linker is a version of the IL linker customized for Unity. Specific parts of the Unity linker for the custom Unity engine are not publicly available.</p><p>The Unity linker is responsible for part of the managed code stripping and engine code stripping processes, which are a separate process provided through IL2CPP.</p><h3 id="How-the-linker-works"><a href="#How-the-linker-works" class="headerlink" title="How the linker works"></a>How the linker works</h3><p>The Unity linker analyzes all assemblies in the project. First, it marks the root type, methods, properties, and fields. For example, a MonoBehavior derived class added to GameObjects is the root type in one scenario. The Unity linker then analyzes the roots it marks for identification, and marks any managed code that those roots depend on. After completing this static analysis, any remaining unmarked code cannot be accessed through any execution path of the application code, and the Unity linker removes it from the assembly.</p><p>The Unity editor creates a list of assemblies with the types used in any scene of the Unity project and passes that list to the Unity linker. The Unity linker then processes those assemblies, any references to those assemblies, any assemblies declared in the link.xml file, and any assemblies with the AlwaysLinkAssembly property. Typically, the Unity linker does not process assemblies included in the project that do not fall into those categories and excludes them from the player build.</p><p>For each assembly processed by the Unity linker, it follows a set of rules based on the assembly classification, whether the assembly contains the type used in the scene, and the level of managed stripping selected for the build.</p><p>For the purposes of this rule, assemblies fall into the following categories:</p><ul><li>.NET Class Library assemblies — Includes the Mono class libraries such as mscorlib.dll and System.dll, as well as .NET class library facade assemblies like netstandard.dll.</li><li>Platform SDK assemblies — Includes the managed assemblies specific to a platform SDK. For example, the windows.winmd assembly that is part of the Universal Windows Platform SDK.</li><li>Unity Engine Module assemblies — Includes the managed assemblies that make up the Unity Engine, such as UnityEngine.Core.dll.</li><li>Project assemblies — Includes the assemblies specific to a project such as:<ul><li>Script assemblies such as Assembly-CSharp.dll</li><li>Precompiled assemblies</li><li>Assembly Definition Assemblies</li><li>Package assemblies</li></ul></li></ul><p>When you build a project in Unity, the build process compiles your C # code into the .NET bytecode format, called the Common Intermediate Language (CIL). Unity packages this CIL bytecode into a file called an assembly. The .NET Framework libraries and any C # libraries used in plug-ins in the project are also pre-packaged as assemblies of CIL bytecode.</p><p>When the Unity linker performs its static analysis, it follows a set of rules to determine which parts of the CIL bytecode are marked by the Unity linker as necessary for a build. Root Annotations rules determine how the Unity linker identifies and preserves top-level assemblies in a build. Dependency Annotations rules determine how the Unity linker identifies and preserves any code that the root assembly depends on.</p><p>The specific code will be used as root and which code will be used as dependencies can be seen in the official doc: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.unity3d.com/Manual/unity-linker.html">https://docs.unity3d.com/Manual/unity-linker.html</a></p><h3 id="Link-xml-file-features"><a href="#Link-xml-file-features" class="headerlink" title="Link.xml file features"></a>Link.xml file features</h3><p>XML files support a less commonly used “attribute” XML attribute. In this case, the mscolib.xml file embedded in mscolib.dll uses this attribute, but you can use it in any link.xml file when appropriate.</p><p>When you use the advanced stripping level, the Unity linker excludes the retention of features that are not supported based on the current version settings.</p><ul><li>Remoting - Excluding when targeting IL2CPP script backend</li><li>Sre-exclude when targeting IL2CPP script backend.</li><li>COM - Exclude when targeting platforms that do not support COM.<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">linker</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">assembly</span> <span class="attr">fullname</span>=<span class="string">&quot;Foo&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span> <span class="attr">fullname</span>=<span class="string">&quot;Type1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--Preserve FeatureOne on platforms that support COM--&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">&quot;System.Void FeatureOne()&quot;</span> <span class="attr">feature</span>=<span class="string">&quot;com&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--Preserve FeatureTwo on all platforms--&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">method</span> <span class="attr">signature</span>=<span class="string">&quot;System.Void FeatureTwo()&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">assembly</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">linker</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="Modify-the-code-of-Method"><a href="#Modify-the-code-of-Method" class="headerlink" title="Modify the code of Method"></a>Modify the code of Method</h3><p>When you use the High stripping level, the Unity linker edits the method body to further reduce the code size. This section summarizes some of the noteworthy edits that the Unity linker makes to the method body.</p><p>Unity Linker only edits the method body in the .NET library assembly. After editing the method body, the source code of the assembly no longer matches the compiled code in the assembly, which can increase the difficulty of debugging.</p><p>The following list describes what the Unity linker can do to edit a method body:</p><ul><li>Remove unreachable branches - Unity linker removes the If statement block that checks System. environment. platform, and the current target platform is inaccessible.</li><li>Internal connection methods that only access the field - The Unity linker replaces calls to methods that get or set the field, which have direct access to the field. This often makes it possible to remove the method completely. When you use a Mono backend, the Unity linker only makes this change if it allows the caller of the method to directly access the field based on its visibility. For IL2CPP, the visibility rules do not apply, so the Unity linker makes this change where appropriate.</li><li>internal connection method that returns constant values - joint debugging within the Unity linker uses a method that only returns constant values.</li><li>Remove empty methods that do not return calls - The Unity linker removes calls to empty methods that return type void.</li><li>Remove empty scope - The Unity linker deletes the Try/Finally block when the Last block is empty. Deleting the air conditioner creates an empty Finally block. If this happens during method editing, the Unity linker will delete the entire Try/Finally block. One scenario where this could happen is if the compiler generates a Try/Finally block in a foreach loop in order to call Dispose ().</li></ul></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/46873/" title="Unity Managed Code Stripping with Linker">https://sunra.top/en/posts/46873/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/16699/" rel="prev" title="Unity Rendering Principle (12) Transparency Effects and Rendering Queues"><i class="fa fa-chevron-left"></i> Unity Rendering Principle (12) Transparency Effects and Rendering Queues</a></div><div class="post-nav-item"> <a href="/en/posts/29980/" rel="next" title="Git command line scam notes">Git command line scam notes<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/46873/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>