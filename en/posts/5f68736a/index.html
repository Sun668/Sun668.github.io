<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="The two major features of’nodejs’, namely’asynchronous IO ‘and’event-driven’. Through the  “easy to understand nodejs”\  and several blog reading, have a general understanding, summarize.  Note that t"><meta property="og:type" content="article"><meta property="og:title" content="Nodejs Asynchronous IO and Event Driven"><meta property="og:url" content="https://sunra.top/en/posts/5f68736a/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="The two major features of’nodejs’, namely’asynchronous IO ‘and’event-driven’. Through the  “easy to understand nodejs”\  and several blog reading, have a general understanding, summarize.  Note that t"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://segmentfault.com/img/remote/1460000005173228"><meta property="og:image" content="https://segmentfault.com/img/remote/1460000006792647"><meta property="article:published_time" content="2020-05-30T00:07:24.000Z"><meta property="article:modified_time" content="2023-10-21T13:23:10.966Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://segmentfault.com/img/remote/1460000005173228"><link rel="canonical" href="https://sunra.top/en/posts/5f68736a/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/5f68736a/","path":"posts/5f68736a/","title":"Nodejs Asynchronous IO and Event Driven"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Nodejs Asynchronous IO and Event Driven | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Synchronous-and-asynchronous-blocking-and-non-blocking"><span class="nav-number">1.</span> <span class="nav-text">Synchronous and asynchronous, blocking and non-blocking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#A-few-examples"><span class="nav-number">2.</span> <span class="nav-text">A few examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#example"><span class="nav-number">2.1.</span> <span class="nav-text">example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example-1"><span class="nav-number">2.2.</span> <span class="nav-text">example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example-2"><span class="nav-number">2.3.</span> <span class="nav-text">example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example-3"><span class="nav-number">2.4.</span> <span class="nav-text">example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example-4"><span class="nav-number">2.5.</span> <span class="nav-text">example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IO-asynchronous"><span class="nav-number">3.</span> <span class="nav-text">IO (asynchronous)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Blocking-I-O"><span class="nav-number">3.1.</span> <span class="nav-text">Blocking I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Synchronous-I-O"><span class="nav-number">3.2.</span> <span class="nav-text">Synchronous I&#x2F;O</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Event-driven"><span class="nav-number">4.</span> <span class="nav-text">Event driven</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Thread-driven-and-event-driven"><span class="nav-number">4.1.</span> <span class="nav-text">Thread-driven and event-driven</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Event-Driven-and-Asynchronous-I-O-for-NodeJS"><span class="nav-number">5.</span> <span class="nav-text">Event-Driven and Asynchronous I&#x2F;O for NodeJS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Event-driven-model"><span class="nav-number">5.1.</span> <span class="nav-text">Event-driven model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-does-the-JS-event-loop-work"><span class="nav-number">5.2.</span> <span class="nav-text">How does the JS event loop work?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Question-answer"><span class="nav-number">6.</span> <span class="nav-text">Question answer</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/5f68736a/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Nodejs Asynchronous IO and Event Driven | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Nodejs Asynchronous IO and Event Driven</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-05-30 08:07:24" itemprop="dateCreated datePublished" datetime="2020-05-30T08:07:24+08:00">2020-05-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-10-21 21:23:10" itemprop="dateModified" datetime="2023-10-21T21:23:10+08:00">2023-10-21</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/5f68736a/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/5f68736a/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>The two major features of’nodejs’, namely’asynchronous IO ‘and’event-driven’. Through the <strong><em>“easy to understand nodejs”\</em></strong> and several blog reading, have a general understanding, summarize.</p><p> <strong>Note that the content of this article is based on node11 above.</strong></p><h2 id="Synchronous-and-asynchronous-blocking-and-non-blocking"><a href="#Synchronous-and-asynchronous-blocking-and-non-blocking" class="headerlink" title="Synchronous and asynchronous, blocking and non-blocking"></a>Synchronous and asynchronous, blocking and non-blocking</h2><p>“Blocking” and “non-blocking” and “synchronous” and “asynchronous” cannot be simply taken literally, providing an answer from a distributed system perspective.<br> <strong>1. Synchronous and Asynchronous</strong><br>Synchronous and asynchronous focus on <strong>message communication mechanism</strong> (synchronous communication/asynchronous communication)<br>The so-called synchronization is that when a <em>call</em> is issued, the <em>call</em> does not return until the result is obtained. But once the call returns, the return value is obtained.<br>In other words, the <em>caller</em> actively waits for the result of this <em>call</em> .</p><p>Asynchronous is the opposite. After the <strong><em>call\</em> is issued, the call returns directly, so no result is returned</strong> . In other words, when an asynchronous procedure call is issued, the caller does not get the result immediately. Instead, after the <em>call</em> is issued, the <em>callee</em> informs the caller through status, notification, or handling the call through a callback function.</p><span id="more"></span><p>Typical asynchronous programming model such as Node.js.</p><p>Take a popular example:<br>You call the bookstore owner and ask if there is a book “Distributed Systems”. If it is a synchronous communication mechanism, the bookstore owner will say, wait a minute, “I’ll check it”, and then start checking and checking, and wait until the check is done (it may be 5 seconds, it may also be a day) to tell you the result (return result).<br>As for the asynchronous communication mechanism, the bookstore owner directly tells you that I will check it out, call you after checking it out, and then hang up the phone directly (no results are returned). Then after checking, he will take the initiative to call you. Here the boss calls back by “calling back”.</p><p>Blocking and non-blocking<br>Blocking and non-blocking focus on the state of the program while waiting for the result (message, return value) of the call.</p><p>A blocking call means that the current thread is suspended until the result of the call returns. The calling thread does not return until the result is obtained.<br>Non-blocking call means that the call does not block the current thread until the result cannot be obtained immediately.</p><p>Or the example above,<br>You call and ask the bookstore owner if there is a book “Distributed Systems”. If you are a blocking call, you will keep “hanging” yourself until you get the result of this book. If it is a non-blocking call, you don’t care if the boss tells you or not, you go play by yourself first. Of course, you should occasionally check for a few minutes to see if the boss has returned the result.<br>Blocking and non-blocking here have nothing to do with whether it is synchronous and asynchronous. It has nothing to do with how the boss answers your results.</p><h2 id="A-few-examples"><a href="#A-few-examples" class="headerlink" title="A few examples"></a>A few examples</h2><p>Before we start, let’s look at a few simple examples, which are also some of the more confusing examples I encountered when using’nodejs’.</p><hr><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example1&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout1&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">debug(&#x27;end&#x27;);</span><br><span class="line">/** Run result</span><br><span class="line">Sat, 21 May 2016 08:41:09 GMT example1 begin</span><br><span class="line">Sat, 21 May 2016 08:41:09 GMT example1 end</span><br><span class="line">Sat, 21 May 2016 08:41:09 GMT example1 timeout1</span><br><span class="line">Sat, 21 May 2016 08:41:09 GMT example1 timeout2</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>question 1</strong></p><blockquote><p>Why are the results of’timeout1 ‘and’timeout2’ after’end ‘?</p></blockquote><hr><h3 id="example-1"><a href="#example-1" class="headerlink" title="example"></a>example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example2&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout1&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">debug(&#x27;end&#x27;);</span><br><span class="line"></span><br><span class="line">while(true);</span><br><span class="line">/** Run result</span><br><span class="line">Sat, 21 May 2016 08:45:47 GMT example2 begin</span><br><span class="line">Sat, 21 May 2016 08:45:47 GMT example2 end</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>question 2</strong></p><blockquote><p>Why are’timeout1 ‘and’timeout2’ not output to end point? What exactly is’while (true) ‘blocking?</p></blockquote><hr><h3 id="example-2"><a href="#example-2" class="headerlink" title="example"></a>example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example3&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout1&quot;);</span><br><span class="line">    while (true);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">debug(&#x27;end&#x27;);</span><br><span class="line">/** Run result</span><br><span class="line">Sat, 21 May 2016 08:49:12 GMT example3 begin</span><br><span class="line">Sat, 21 May 2016 08:49:12 GMT example3 end</span><br><span class="line">Sat, 21 May 2016 08:49:12 GMT example3 timeout1</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>question 3</strong></p><blockquote><p>Why does the callback function in timeout1 block the execution of the callback function in timeout2?</p></blockquote><hr><h3 id="example-3"><a href="#example-3" class="headerlink" title="example"></a>example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example4&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout1&quot;);</span><br><span class="line">    /**</span><br><span class="line">     * Simulation is computationally intensive</span><br><span class="line">     */</span><br><span class="line">    for(var i = 0 ; i &lt; 1000000 ; ++i)&#123;</span><br><span class="line">        for(var j = 0 ; j &lt; 100000 ; ++j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">debug(&#x27;end&#x27;);</span><br><span class="line">/**</span><br><span class="line">Sat, 21 May 2016 08:53:27 GMT example4 begin</span><br><span class="line">Sat, 21 May 2016 08:53:27 GMT example4 end</span><br><span class="line">Sat, 21 May 2016 08:53:27 GMT example4 timeout1</span><br><span class="line">Sat, 21 May 2016 08:54:09 GMT example4 timeout2//Note that the time here is a long time late</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>question 4</strong></p><blockquote><p>As in the question above, why would the computationally intensive work of timeout1 block the callback function of timeout2?</p></blockquote><hr><h3 id="example-4"><a href="#example-4" class="headerlink" title="example"></a>example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example5&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">fs.readFile(&#x27;package.json&#x27;,&#x27;utf-8&#x27;,function(err,data)&#123;</span><br><span class="line">    if(err)  </span><br><span class="line">        debug(err);</span><br><span class="line">    else</span><br><span class="line">        debug(&quot;get file content&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">debug(&#x27;end&#x27;);</span><br><span class="line">/** Run result</span><br><span class="line">Sat, 21 May 2016 08:59:14 GMT example5 begin</span><br><span class="line">Sat, 21 May 2016 08:59:14 GMT example5 end</span><br><span class="line">Sat, 21 May 2016 08:59:14 GMT example5 timeout2</span><br><span class="line">Sat, 21 May 2016 08:59:14 GMT example5 get file content</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><p><strong>question 5</strong></p><blockquote><p>Why does the’IO ‘operation of reading a file not block the execution of’timeout2’?</p></blockquote><hr><p>Next, we will take the above doubts to understand how asynchronous IO and event-driven work in nodejs.</p><h2 id="IO-asynchronous"><a href="#IO-asynchronous" class="headerlink" title="IO (asynchronous)"></a>IO (asynchronous)</h2><p>First, let’s understand a few confusing concepts, ‘blocking IO (blocking I/O) ‘ and’non-blocking IO (non-blocking I/O) ‘,’ synchronous IO (synchronous I/O) and asynchronous IO (synchronous I/O) ‘.</p><p>Bloggers have been naive to think that’non-blocking I/O ‘is’asynchronous I/O’ T_T, ‘apue’ has not understood.</p><h3 id="Blocking-I-O"><a href="#Blocking-I-O" class="headerlink" title="Blocking I/O"></a>Blocking I/O</h3><p>In simple terms, blocking I/O means that when the user sends an operation to read the file Descriptor, the process will be blocked until all the data to be read is ready to be returned to the user, at which time the process will not be released from the’block ‘state.</p><p>What about <strong>non-blocking I/O</strong> , in contrast to the above situation, when the user initiates a file descriptor operation, the function returns immediately, without any waiting, and the process continues to execute. But how does the program know that the data to be read is ready? The easiest way is polling.</p><p>In addition, there is also a mode called’IO multiplex to reuse ‘, which is to use a blocking function to listen to multiple file descriptors at the same time. When one of the file descriptors is ready, it will return immediately. Under’linux’, ‘select’, ‘poll’, ‘epoll’ all provide the function of’IO multiplex to reuse ‘.</p><h3 id="Synchronous-I-O"><a href="#Synchronous-I-O" class="headerlink" title="Synchronous I/O"></a>Synchronous I/O</h3><p>So what is the difference between’synchronous I/O ‘and’asynchronous I/O’? Can’asynchronous I/O ‘be achieved as long as’non-blocking IO’ is achieved?</p><p>Actually not.</p><ul><li>‘Synchronous I/O (synchronous I/O) ‘ will block the process when doing ‘I/O operation’, so ‘blocking I/O’, ‘non-blocking I/O’, ‘IO multiplexing to reuse I/O’ are all’synchronous I/O ‘.</li><li>‘Asynchronous I/O (asynchronous I/O) ‘ will not cause any blocking when doing’I/O opertaion ‘.</li></ul><p>‘Non-blocking I/O ‘does not block. Why not’asynchronous I/O’? In fact, when’non-blocking I/O ‘is ready for data, it still blocks the process to get data from the kernel. So it is not’asynchronous I/O’.</p><p>Borrow a picture here (picture from<a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000003063859?utm_source=Weibo&amp;utm_medium=shareLink&amp;utm_campaign=socialShare">这里</a>To explain the difference between them</p><p><img src="https://segmentfault.com/img/remote/1460000005173228" alt></p><h2 id="Event-driven"><a href="#Event-driven" class="headerlink" title="Event driven"></a>Event driven</h2><p>Event-driven is the second biggest feature of nodejs. What is event-driven? Simply put, it is to make corresponding operations by listening to the state changes of events. For example, if a file is read, the file is read, or the file is read incorrectly, then the corresponding state is triggered, and then the corresponding callback function is called to process it.</p><h3 id="Thread-driven-and-event-driven"><a href="#Thread-driven-and-event-driven" class="headerlink" title="Thread-driven and event-driven"></a>Thread-driven and event-driven</h3><p>So what is the difference between’thread-driven ‘programming and’event-driven’ programming?</p><ul><li>‘Thread-driven’ means that when a request is received, a new thread will be opened for the request to process the request. Generally, there is a thread pool. There are idle threads in the thread pool, and threads will be taken from the thread pool for processing. If there are no idle threads in the thread pool, the new request will be queued until there are idle threads in the thread pool.</li><li>‘Event-driven’ means that when a new request comes in, the request will be pushed into the queue, and then through a loop to detect the event state change in the queue. If an event with a state change is detected, then the event will be executed. The corresponding processing code is usually a callback function.</li></ul><p>For event-driven programming, if the callback function at a certain time is’computationally intensive ‘or’blocking I/O’, then this callback function will block the execution of all subsequent event callback functions. This is particularly important.</p><h2 id="Event-Driven-and-Asynchronous-I-O-for-NodeJS"><a href="#Event-Driven-and-Asynchronous-I-O-for-NodeJS" class="headerlink" title="Event-Driven and Asynchronous I/O for NodeJS"></a>Event-Driven and Asynchronous I/O for NodeJS</h2><h3 id="Event-driven-model"><a href="#Event-driven-model" class="headerlink" title="Event-driven model"></a>Event-driven model</h3><p>So many concepts have been introduced above, now let’s take a look at how event-driven and asynchronous I/O are implemented in nodejs.</p><p>‘Nodejs’ is <strong>single thread (single thread)</strong> running, through an event loop (event-loop) <strong>to loop out the message in the message queue (event-queue)</strong> for processing, the process is basically to call the callback function corresponding to the message. Message queue is when an event state changes, a message is pushed into the queue.</p><p>The time-driven model of’nodejs’ generally pays attention to the following points:</p><ul><li>Because it is <strong>single-threaded</strong> , the <strong>event loop</strong> is suspended when executing the code in the’js’ file sequentially.</li><li>When the js file is finished executing, the event loop starts running and retrieves the message from the message queue to execute the callback function</li><li>because it is <strong>single-threaded</strong> , the <strong>event loop</strong> is suspended when the callback function is executed</li><li>When it comes to I/O operations, ‘nodejs’ will open a separate thread for’asynchronous I/O ‘operations, and push the message into the <strong>message queue</strong> after the operation is over.</li></ul><p>Let’s start with a simple’js’ file to see how’nodejs’ is executed.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;);</span><br><span class="line">var debug = require(&#x27;debug&#x27;)(&#x27;example1&#x27;);</span><br><span class="line"></span><br><span class="line">debug(&quot;begin&quot;);</span><br><span class="line"></span><br><span class="line">fs.readFile(&#x27;package.json&#x27;,&#x27;utf-8&#x27;,function(err,data)&#123;</span><br><span class="line">    if(err)  </span><br><span class="line">        debug(err);</span><br><span class="line">    else</span><br><span class="line">        debug(&quot;get file content&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">    debug(&quot;timeout2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Debug (&#x27;end &#x27;); // The event loop is paused until this point</span><br></pre></td></tr></table></figure><ol><li>Execute’debug (“begin”) ‘synchronously</li><li>Call’fs.readFile () ‘asynchronously, at this time a new thread will be opened for’asynchronous I/O’ operation</li><li>Call’setTimeout () ‘asynchronously and immediately push the timeout information into the <strong>message queue</strong></li><li>Call’debug (“end”) ‘synchronously</li><li>Open the event loop and pop up the message queue (currently timeout).</li><li>Then execute the callback function corresponding to the information ( <strong>event loop</strong> is suspended again)</li><li> <strong>Callback function</strong> After execution, start the <strong>event loop</strong> (currently there is nothing in the <strong>message queue</strong> , the file has not been read)</li><li>‘Asynchronous I/O’ reads the file, and pushes the message into the <strong>message queue (the</strong> message contains the file content or an error message)</li><li> <strong>Event loop</strong> Get message, execute callback</li><li>Program withdrawal.</li></ol><p>Here is a picture to illustrate the event-driven model of’nodejs’ (the picture comes from<a target="_blank" rel="external nofollow noopener noreferrer" href="http://blog.carbonfive.com/2013/10/27/the-javascript-event-loop-explained/">这里</a>）<br><img src="https://segmentfault.com/img/remote/1460000006792647" alt></p><h3 id="How-does-the-JS-event-loop-work"><a href="#How-does-the-JS-event-loop-work" class="headerlink" title="How does the JS event loop work?"></a>How does the JS event loop work?</h3><p>There is actually no problem with the understanding of “perform synchronous operations first and asynchronous operations are in the event queue”, but if we go deeper, it will lead to many other concepts, such as event table and event queue. Let’s take a look at the running process:</p><ol><li>First determine whether the JS is synchronous or asynchronous, the synchronization will enter the main thread to run, and the asynchronous will enter the event table.</li><li>Asynchronous Tasks registers events in the event table. When the trigger condition is met (the trigger condition may be a delay or an ajax callback), it is pushed into the event queue.</li><li>After the synchronization task enters the main thread, it has been executed. When the main thread is idle, it will go to the event queue to see if there are executable Asynchronous Tasks. If there are, it will be pushed into the main thread.</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;2 seconds up&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure><p>We use the second above to analyze this script. SetTimeout is an asynchronous operation that first enters the event table, the registered event is its callback, and the trigger condition is 2 seconds later. When the condition is met, the callback is pushed into the event queue. When the main thread is idle, go to the event queue to see if there is an executable task.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Console</span>.<span class="property">log</span> (<span class="number">1</span>)<span class="comment">//Sync task into main thread</span></span><br><span class="line"><span class="built_in">setTimeout</span> (fun (), <span class="number">0</span>)<span class="comment">//Asynchronous Tasks, placed in the event table, pushed into the event queue after 0 seconds</span></span><br><span class="line"><span class="title class_">Console</span>.<span class="property">log</span> (<span class="number">3</span>)<span class="comment">//Sync task into main thread</span></span><br></pre></td></tr></table></figure><p>1 and 3 is that the synchronous task will be executed immediately. After the execution is completed, the main thread is free to go to the event queue (event queue) to see if there is a task waiting to be executed. This is why the delay time of setTimeout is 0 milliseconds but it is executed at the end.</p><p>One thing to note about setTimeout is that the delay time is sometimes not so accurate.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;2 seconds up&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br><span class="line"><span class="title function_">wait</span>(<span class="number">9999999999</span>)</span><br></pre></td></tr></table></figure><p>Analyze the running process:</p><ol><li>console enter the Event Table and register, the timer starts.<br>Execute the sleep function. Although the sleep method is a synchronous task, the sleep method performs a lot of logical operations, which takes more than 2 seconds.<br>3.2 seconds is up, the timing event timeout is completed, the console enters the Event Queue, but sleep has not been executed, the main thread is still occupied, and can only wait.</li><li>sleep finally finished executing, the console finally entered the main thread execution from the Event Queue, this time has been far more than 2 seconds.</li></ol><p>In fact, a delay of 2 seconds only means that after 2 seconds, the function in setTimeout will be pushed into the event queue, and the tasks in the event queue (event queue) will only be executed when the main thread is idle. After the above process is completed, we know that the setTimeout function adds the task to be executed (console in this case) to the Event Queue after a specified time, and because it is a single-threaded task to be executed one by one, if the previous task takes too long, then can only wait, resulting in a real delay time far greater than 2 seconds. We also often encounter code like setTimeout (fn, 0), which means that a task is specified to be executed at the earliest idle time of the main thread, which means that there is no need to wait for many seconds. As long as all the synchronous tasks in the main thread execution stack are executed, the stack will be executed immediately if it is empty. But even if the main thread is empty, 0 milliseconds is actually not reached. According to HTML standards, the minimum is 4 milliseconds.</p><p>About setInterval: Taking setInterval (fn, ms) as an example, setInterval is executed in a loop. setInterval will place the registered function into the Event Queue every specified time. It will not execute fn every ms seconds, but every ms seconds. Fn enters the Event Queue. It should be noted that once the execution time of the setInterval callback function fn exceeds the delay time ms, there is no time interval at all.</p><p>The above concept is very basic and easy to understand but unfortunately the news is that everything above is not absolutely correct, because it involves Promise, async/await, process.nextTick (node) so there is a more refined definition of the task:</p><p> <strong>We refer to the tasks initiated by the host as macro tasks, and the tasks initiated by the JavaScript engine as micro tasks.</strong></p><p>Macro-task: including the overall code script, setTimeout, setInterval, MessageChannel, postMessage, setImmediate.<br> 微任务(micro-task)：Promise、process.nextTick、MutationObsever。</p><p>When dividing macro tasks and microtasks, async/await is not mentioned because the essence of async/await is a Promise.</p><p> <strong>What is the event loop mechanism? * Different types of tasks will enter the corresponding Event Queue, such as setTimeout and setInterval will enter the same (macro task) Event Queue. Promise and process.nextTick will enter the same (microtask) Event Queue</strong> . *</p><ol><li>“Macro task” and “micro task” are both queues. When a piece of code is executed, the synchronization code in the macro task will be executed first.</li><li>During the first round of the event loop, all js scripts will be run as a macro task.</li><li>If you encounter a macro task such as setTimeout during execution, then push the function inside the setTimeout into the “queue of macro tasks” and call it when the next macro task is executed.</li><li>If a microtask such as promise.then () is encountered during execution, it will be pushed into the “ <strong>microtask queue of the current macro task</strong> “ (that is to say, these microtasks still belong to the current macro task), After the synchronization code of this round of macro tasks is completed, all microtasks are executed in turn.</li><li>In the first round of the event loop, when all the synchronization scripts and events in the microtask queue are executed, this round of event loop ends and the second round of event loop begins.</li><li>The second round of event loops is the same. <strong>First, execute the synchronization script in the macro task.</strong> If you encounter other macro tasks, the Code Block will continue to be added to the “Macro Task Queue”. If you encounter a microtask, it will be pushed into the “Current macro task microtask queue”. After the synchronous code execution of this round of macro tasks is completed, all current microtasks will be executed in turn.</li><li>Start the third round and repeat…</li></ol><p>The following code is used to deeply understand the above mechanism.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve</span>) &#123;</span><br><span class="line">    <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;1&#x27;</span>)<span class="comment">//sync task</span></span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>)</span><br></pre></td></tr></table></figure><ol><li>This code enters the main thread as a macro task.</li><li>Encounter setTimeout first, then register its callback function and distribute it to the macro task Event Queue.</li><li>Next the Promise is encountered, the new Promise is executed immediately, then the function is distributed to the microtask Event Queue.</li><li>Encountered console.log (), executed immediately.</li><li>The overall code script ends as the first macro task execution. Check if there is currently an executable microtask and execute the then callback. (The first round of event loop is over, we start the second round of loop.)</li><li>Start from the macro task Event Queue. We found the callback function corresponding to setTimeout in the macro task Event Queue, and executed immediately. Execution result: ‘1 - 2 - 3 - 4</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; </span><br><span class="line">    <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;1&#x27;</span>)<span class="comment">//macro task one</span></span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;3&#x27;</span>)<span class="comment">//Microtasks for macro task one</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 5</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8&#x27;</span>)</span><br><span class="line">            <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;10&#x27;</span>)</span><br><span class="line">            <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 7</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 3</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 4</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 6</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;11&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;2&#x27;</span>)<span class="comment">//macro task one</span></span><br></pre></td></tr></table></figure><ol><li>All code enters the main thread for execution as the first macro task.</li><li>First output 1, which is the synchronization code. Then the callback enters the microtask queue of macro task 1 as a microtask.</li><li>The three outermost setTimeouts below are macro task two, macro task three, and macro task four in sequence into the macro task queue.</li><li>Output 2, now the synchronization code of macro task 1 has been executed. Next, execute micro task output 3 of macro task 1. The first round of event loop is completed</li><li>Now execute macro task 2 output 4, and the subsequent setTimeout is placed in the macro task queue as macro task 5.</li><li>Execute macro task three output 5, execute macro task four output 6, macro task four inside the setTimeout as macro task six.</li><li>Execute macro task five output 7, 8. Then callback as macro task five microtasks into macro task five microtask queue.</li><li>Output the synchronization code 9, the synchronization code of macro task 5 has been executed, and now the micro task of macro task 5 is executed.</li><li>Output 10, followed by setTimeout as macro task seven into the macro task queue. Macro task five execution is complete.</li><li>Execute macro task six output 11, and execute macro task seven output 12.</li></ol><p><em>*-^-\</em>， this case is a bit disgusting, the purpose is to let everyone understand the order of execution between macro tasks and the execution relationship between macro tasks and micro tasks. *</p><p>We call the content in the main thread (execution queue) from the beginning to the end of the execution a tick. Once the content of the main thread is executed, go back to the head of the macro task queue and take a new tick to join the main thread. If there are other methods to register a new microtask or the macro task itself registers a microtask, then take out all the microtasks and complete them before the end of this tick.</p><ol><li>The microtasks added in the current tick will not be left to the next tick, but will be triggered at the end of the tick</li><li>In an event loop, after the task in the tick is executed, there will be a separate step called Perform a microtask checkpoint, that is, execute the microtask checkpoint. This operation is to check whether there are microtasks. If there are, the microtask queue will also be treated as an execution queue to continue execution, and the execution queue will be empty after completion.</li><li><p>The microtask generated by the same tick will always be executed before the macro task, because the microtask registered before the end of this tick will be executed at the microtask checkpoint, but the macro task will wait until the next tick.</p><p>(Note that all macro tasks and microtasks discussed here are already tasks that enter the event loop, that is, the state of entering the event queue from the event table after the asynchronous condition is reached).</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123; </span><br><span class="line">    <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;1&#x27;</span>)<span class="comment">//macro task one</span></span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;3&#x27;</span>)<span class="comment">//Microtasks for macro task one</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 2</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 5</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8&#x27;</span>)</span><br><span class="line">            <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;10&#x27;</span>)</span><br><span class="line">            <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 7</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 3</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"><span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 4</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    <span class="built_in">setTimeout</span> (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// macro task 6</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;11&#x27;</span>)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">Console</span>.<span class="property">log</span> (<span class="string">&#x27;2&#x27;</span>)<span class="comment">//macro task one</span></span><br></pre></td></tr></table></figure><p>If you further add a delay time to the timeout, so that their callback function does not immediately enter the macro task queue, what is the print order?</p><p>Give the answer first: 1, 2, 3, 6, 5, 4, 7, 8, 9, 10, 11, 12 (or 1, 2, 3, 6, 5, 4, 11, 7, 8, 9, 10, 12)</p><blockquote><p>In fact, according to the logic we just talked about, the order should be 1, 2, 3, 6, 5, 4, 11,</p><p>Why are there two different possibilities?</p><p>Because Chrome based on</p></blockquote><p>The difference between this example and the one above is that by setting different timeouts, the callback functions are pushed into the macro task queue in a different order.</p><h2 id="Question-answer"><a href="#Question-answer" class="headerlink" title="Question answer"></a>Question answer</h2><p>Okay, so far, I can answer the above questions</p><hr><p><strong>question 1</strong></p><blockquote><p>Why are the results of’timeout1 ‘and’timeout2’ after end?</p></blockquote><p><strong>answer 1</strong></p><blockquote><p>Because at this time’timeout1 ‘and’timeout2’ are only pushed into the queue by the asynchronous function, the event loop is still suspended</p></blockquote><hr><p><strong>question 2</strong></p><blockquote><p>Why are’timeout1 ‘and’timeout2’ not output to end point? What exactly is’while (true) ‘blocking?</p></blockquote><p><strong>answer 2</strong></p><blockquote><p>Because the event loop is directly blocked here, it has already been blocked before it has started</p></blockquote><hr><p><strong>question 3,4</strong></p><blockquote><p>1.<br>2.</p></blockquote><p><strong>answer 3,4</strong></p><blockquote><p>Because the callback function execution returns to the event loop, it will continue to execute, and the callback function will block the operation of the event loop</p></blockquote><hr><p><strong>question 5</strong></p><blockquote><p>Why does the IO operation of reading the file not block the execution of’timeout2 ‘?</p></blockquote><p><strong>answer 5</strong></p><blockquote><p>Because the’IO ‘operation is asynchronous, it will start a new thread and will not block until the event loop.</p></blockquote><p>Reference link:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.zhihu.com/question/19732473">https://www.zhihu.com/question/19732473</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000005173218">https://segmentfault.com/a/1190000005173218</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://juejin.im/post/5c148ec8e51d4576e83fd836">https://juejin.im/post/5c148ec8e51d4576e83fd836</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/5f68736a/" title="Nodejs Asynchronous IO and Event Driven">https://sunra.top/en/posts/5f68736a/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/6b3a9e14/" rel="prev" title="Docker Introduction Notes"><i class="fa fa-chevron-left"></i> Docker Introduction Notes</a></div><div class="post-nav-item"> <a href="/en/posts/2552a57d/" rel="next" title="JavaScript Asynchronous Programming Syntax">JavaScript Asynchronous Programming Syntax<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/5f68736a/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>