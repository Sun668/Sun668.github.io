<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Recently, in the background of building our own WeChat official account robot, after the user sends a small message to the official account, it will be forwarded to the server set by the WeChat server"><meta property="og:type" content="article"><meta property="og:title" content="WeChat custom robot background express message decoding plugin"><meta property="og:url" content="https://sunra.top/en/posts/20445/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Recently, in the background of building our own WeChat official account robot, after the user sends a small message to the official account, it will be forwarded to the server set by the WeChat server"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2023-02-18T04:54:40.000Z"><meta property="article:modified_time" content="2025-01-24T05:50:52.451Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/20445/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/20445/","path":"posts/20445/","title":"WeChat custom robot background express message decoding plugin"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>WeChat custom robot background express message decoding plugin | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#wechat-official-account-message-decryption-plugin"><span class="nav-number">1.</span> <span class="nav-text">WeChat official account message decryption plugin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#code"><span class="nav-number">1.1.</span> <span class="nav-text">Code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#use"><span class="nav-number">1.2.</span> <span class="nav-text">Use</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/20445/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="WeChat custom robot background express message decoding plugin | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> WeChat custom robot background express message decoding plugin</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2023-02-18 12:54:40" itemprop="dateCreated datePublished" datetime="2023-02-18T12:54:40+08:00">2023-02-18</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2025-01-24 13:50:52" itemprop="dateModified" datetime="2025-01-24T13:50:52+08:00">2025-01-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Sundry/" itemprop="url" rel="index"><span itemprop="name">Sundry</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/20445/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/20445/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Recently, in the background of building our own WeChat official account robot, after the user sends a small message to the official account, it will be forwarded to the server set by the WeChat server level. At the beginning, we can choose the plaintext mode, but for safety reasons, we will still turn on Safe mode, in this mode, all messages will be encrypted as a whole, we need to decrypt them at the server level, and the WeChat official doc is not well written, and there is no example code for the nodejs version, so I combined the example code to make a version of express plug-in, record it:</p><span id="more"></span><h1 id="wechat-official-account-message-decryption-plugin"><a class="markdownIt-Anchor" href="#wechat-official-account-message-decryption-plugin"></a> WeChat official account message decryption plugin</h1><h2 id="code"><a class="markdownIt-Anchor" href="#code"></a> Code</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getConfig &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../utils/getConfig&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; includes &#125; = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parseString = <span class="built_in">require</span>(<span class="string">&#x27;xml2js&#x27;</span>).<span class="property">parseString</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PKCS7</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete replacement</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; text The decrypted plaintext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">decode</span>(<span class="params">text</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> pad = text[text.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> (pad &lt; <span class="number">1</span> || pad &gt; <span class="number">32</span>) &#123;</span><br><span class="line">        pad = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> text.<span class="title function_">slice</span>(<span class="number">0</span>, text.<span class="property">length</span> - pad)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fill and fill</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; text The plaintext that needs to be filled with padding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">encode</span>(<span class="params">text</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> blockSize = <span class="number">32</span></span><br><span class="line">        <span class="keyword">const</span> textLength = text.<span class="property">length</span></span><br><span class="line">        <span class="comment">//Calculate the number of bits to be filled</span></span><br><span class="line">        <span class="keyword">const</span> amountToPad = blockSize - (textLength % blockSize)</span><br><span class="line">        <span class="keyword">const</span> result = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(amountToPad)</span><br><span class="line">        result.<span class="title function_">fill</span>(amountToPad)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([text, result])</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WeChat official account message encryption and decryption</span></span><br><span class="line"><span class="comment">     * Official doc (badly written): https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/Message_Encryption/Technical_Plan.html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WXMsgCrypto</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The following information in the official account - development - basic configuration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; token          令牌(Token)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; encodingAESKey message encryption and decryption key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; appId AppId of official account</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">token, encodingAESKey, appId</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!token || !encodingAESKey || !appId) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;please check arguments&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = token</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">appId</span> = appId</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">AESKey</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(encodingAESKey + <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">AESKey</span>.<span class="property">length</span> ! <span class="number">32</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;encodingAESKey invalid&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">key</span> = <span class="title class_">AESKey</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">iv</span> = <span class="title class_">AESKey</span>.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">16</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">pkcs7</span> = <span class="keyword">new</span> <span class="title class_">PKCS7</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Obtain signatures</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; timestamp timestamp</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; nonce random number</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; encrypt text</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">getSignature</span>(<span class="params">timestamp, nonce, encrypt</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> sha = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> arr = [<span class="variable language_">this</span>.<span class="property">token</span>, timestamp, nonce, encrypt].<span class="title function_">sort</span>()</span><br><span class="line">        sha.<span class="title function_">update</span>(arr.<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> sha.<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decrypt the ciphertext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; text The ciphertext to be decrypted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">decrypt</span>(<span class="params">text</span>) &#123;</span><br><span class="line">        <span class="comment">//Create decryption object, AES uses CBC model, data is filled with PKCS #7; IV initial vector size is 16 bytes, take the first 16 bytes of AESKey</span></span><br><span class="line">        <span class="keyword">const</span> decipher = crypto.<span class="title function_">createDecipheriv</span>(<span class="string">&#x27;aes-256-cbc&#x27;</span>, <span class="variable language_">this</span>.<span class="property">key</span>, <span class="variable language_">this</span>.<span class="property">iv</span>)</span><br><span class="line">        decipher.<span class="title function_">setAutoPadding</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> deciphered = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([decipher.<span class="title function_">update</span>(text, <span class="string">&#x27;base64&#x27;</span>), decipher.<span class="title function_">final</span>()])</span><br><span class="line"></span><br><span class="line">        deciphered = <span class="variable language_">this</span>.<span class="property">pkcs7</span>.<span class="title function_">decode</span>(deciphered)</span><br><span class="line">        <span class="comment">// 算法：AES_Encrypt[random(16B) + msg_len(4B) + msg + $CorpID]</span></span><br><span class="line">        <span class="comment">//remove 16-bit random numbers</span></span><br><span class="line">        <span class="keyword">const</span> content = deciphered.<span class="title function_">slice</span>(<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">const</span> length = content.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">4</span>).<span class="title function_">readUInt32BE</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">message</span>: content.<span class="title function_">slice</span>(<span class="number">4</span>, length + <span class="number">4</span>).<span class="title function_">toString</span>(),</span><br><span class="line">            <span class="attr">appId</span>: content.<span class="title function_">slice</span>(length + <span class="number">4</span>).<span class="title function_">toString</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encrypt plaintext</span></span><br><span class="line"><span class="comment">     * 算法：Base64_Encode(AES_Encrypt[random(16B) + msg_len(4B) + msg + $appId])</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; text Plain text to be encrypted</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">encrypt</span>(<span class="params">text</span>) &#123;</span><br><span class="line">        <span class="comment">//16B random string</span></span><br><span class="line">        <span class="keyword">const</span> randomString = crypto.<span class="title function_">pseudoRandomBytes</span>(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> msg = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(text)</span><br><span class="line">        <span class="comment">//Get the network byte order of the content length of 4B</span></span><br><span class="line">        <span class="keyword">const</span> msgLength = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">4</span>)</span><br><span class="line">        msgLength.<span class="title function_">writeUInt32BE</span>(msg.<span class="property">length</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> id = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">appId</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> bufMsg = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([randomString, msgLength, msg, id])</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Patch the plaintext</span></span><br><span class="line">        <span class="keyword">const</span> encoded = <span class="variable language_">this</span>.<span class="property">pkcs7</span>.<span class="title function_">encode</span>(bufMsg)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Create an encrypted object, AES uses the CBC model, and the data is filled with PKCS #7; IV initial vector size is 16 bytes, and the first 16 bytes of AESKey are taken</span></span><br><span class="line">        <span class="keyword">const</span> cipher = crypto.<span class="title function_">createCipheriv</span>(<span class="string">&#x27;aes-256-cbc&#x27;</span>, <span class="variable language_">this</span>.<span class="property">key</span>, <span class="variable language_">this</span>.<span class="property">iv</span>)</span><br><span class="line">        cipher.<span class="title function_">setAutoPadding</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> cipheredMsg = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([cipher.<span class="title function_">update</span>(encoded), cipher.<span class="title function_">final</span>()])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cipheredMsg.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; token, <span class="title class_">WechatAppID</span>, <span class="title class_">EncodingAESKey</span> &#125; = <span class="title function_">getConfig</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wxmc = <span class="keyword">new</span> <span class="title class_">WXMsgCrypto</span>(token, <span class="title class_">EncodingAESKey</span>, <span class="title class_">WechatAppID</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">WXMsgCryptoMiddleware</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">includes</span>(req.<span class="property">path</span>, <span class="string">&#x27;/wechatAccess&#x27;</span>) &amp;&amp; req.<span class="property">method</span>.<span class="title function_">toLowerCase</span>() = <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> query = req.<span class="property">query</span></span><br><span class="line">        <span class="keyword">let</span> xml = req.<span class="property">body</span>.<span class="property">xml</span></span><br><span class="line">        <span class="comment">//verification</span></span><br><span class="line">        <span class="keyword">let</span> msgSignature = wxmc.<span class="title function_">getSignature</span>(query.<span class="property">timestamp</span>, query.<span class="property">nonce</span>, xml.<span class="property">encrypt</span>)</span><br><span class="line">        <span class="keyword">if</span> (msgSignature ! query.<span class="property">msg_signature</span>) &#123;</span><br><span class="line">            <span class="title class_">Res</span>.<span class="property">send</span> (<span class="string">&#x27;Server error, please try again later!&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">parseString</span>(wxmc.<span class="title function_">decrypt</span>(xml.<span class="property">encrypt</span>).<span class="property">message</span>, &#123;</span><br><span class="line">                <span class="attr">explicitArray</span>: <span class="literal">false</span></span><br><span class="line">            &#125;, <span class="keyword">function</span>(<span class="params">err, res</span>) &#123;</span><br><span class="line">                req.<span class="property">body</span>.<span class="property">xml</span> = res.<span class="property">xml</span></span><br><span class="line">                <span class="title function_">next</span>()</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">WXMsgCryptoMiddleware</span>;</span><br></pre></td></tr></table></figure><h2 id="use"><a class="markdownIt-Anchor" href="#use"></a> Use</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">WXMsgCryptoMiddleware</span> = <span class="built_in">require</span>(<span class="string">&#x27;./middlewares/WXMsgCrypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">WXMsgCryptoMiddleware</span>)</span><br></pre></td></tr></table></figure><p>Then in the code, you can get the decrypted message through’req.body.xml’</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/20445/" title="WeChat custom robot background express message decoding plugin">https://sunra.top/en/posts/20445/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/37760/" rel="prev" title="10 times programmer work method"><i class="fa fa-chevron-left"></i> 10 times programmer work method</a></div><div class="post-nav-item"> <a href="/en/posts/62967/" rel="next" title="Force-oriented algorithm">Force-oriented algorithm<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2025</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/20445/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>