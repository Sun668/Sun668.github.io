<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Problem descriptionPassport-azure-ad is a plug-in that we need to use when we use node express as the server, passport to verify login, and azure third-party authentication login. But in the use of th"><meta property="og:type" content="article"><meta property="og:title" content="passport-azure-ad_ infinite refresh problem"><meta property="og:url" content="https://sunra.top/en/posts/a8bec924/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Problem descriptionPassport-azure-ad is a plug-in that we need to use when we use node express as the server, passport to verify login, and azure third-party authentication login. But in the use of th"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2019-11-22T12:45:49.000Z"><meta property="article:modified_time" content="2024-06-08T06:59:19.631Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/a8bec924/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/a8bec924/","path":"posts/a8bec924/","title":"passport-azure-ad_ infinite refresh problem"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>passport-azure-ad_ infinite refresh problem | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Problem-description"><span class="nav-number">1.</span> <span class="nav-text">Problem description</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution"><span class="nav-number">2.</span> <span class="nav-text">Solution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Source-code-parsing"><span class="nav-number">3.</span> <span class="nav-text">Source code parsing</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Summary"><span class="nav-number">3.1.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#Updated-on-2020-02-08"><span class="nav-number"></span> <span class="nav-text">Updated on 2020-02-08</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/a8bec924/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="passport-azure-ad_ infinite refresh problem | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> passport-azure-ad_ infinite refresh problem</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-11-22 20:45:49" itemprop="dateCreated datePublished" datetime="2019-11-22T20:45:49+08:00">2019-11-22</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-06-08 14:59:19" itemprop="dateModified" datetime="2024-06-08T14:59:19+08:00">2024-06-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/a8bec924/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/a8bec924/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><h3 id="Problem-description"><a href="#Problem-description" class="headerlink" title="Problem description"></a>Problem description</h3><p>Passport-azure-ad is a plug-in that we need to use when we use node express as the server, passport to verify login, and azure third-party authentication login.</p><p>But in the use of the process we may encounter such a situation, that is, clearly all our configuration has been configured, but will encounter unlimited, callback situation, the specific form is that we use the Microsoft account login success, the page will continue to refresh, and finally prompt us can not successfully log in.</p><p>This constantly refresh process is actually to send an authentication request in the OAuth login process first. After the authentication is successful, the redirectURL that you configured in advance will be called back. This url is generally a request that our own server needs to handle. In this request, you need to Use the authenticate of passport to authenticate whether the login is successful. If the id-token is empty in this authentication, the request will be initiated again. Once the authentication is successful, the redirectURL will be called.</p><p>During this process, if you do authenticate successfully with Microsoft, but do not get the id-token when calling back your server request, there will be an infinite callback situation.</p><span id="more"></span><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>Generally, this situation occurs because the bodyparser plugin is not added to the project, but it cannot parse the body returned by the Microsoft authentication request, so we cannot obtain the id-token, so we need to join the bodyparser.</p><h3 id="Source-code-parsing"><a href="#Source-code-parsing" class="headerlink" title="Source code parsing"></a>Source code parsing</h3><p>Suppose our redirectURL looks like this</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:8080/auth/auth/openid/return</span><br></pre></td></tr></table></figure><p>Its processing function is like this</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">passport.<span class="title function_">authenticate</span>(<span class="string">&#x27;azuread-openidconnect&#x27;</span>, &#123; <span class="attr">failureRedirect</span>: <span class="string">&#x27;/&#x27;</span> &#125;),</span><br><span class="line">  <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    log.<span class="title function_">info</span>(<span class="string">&#x27;Login was called in the Sample&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>);</span><br></pre></td></tr></table></figure><p>So let’s take a look at why this function will trigger the certification to Microsoft again.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Strategy</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">authenticate</span> = <span class="keyword">function</span> <span class="title function_">authenticateStrategy</span>(<span class="params">req, options</span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * We should be careful using &#x27;this&#x27;. Avoid the usage like `this.xxx = ...`</span></span><br><span class="line"><span class="comment">   * unless you know what you are doing.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * In the passport source code</span></span><br><span class="line"><span class="comment">   * (https://github.com/jaredhanson/passport/blob/master/lib/middleware/authenticate.js)</span></span><br><span class="line"><span class="comment">   * when it attempts to call the `oidcstrategy.authenticate` function, passport</span></span><br><span class="line"><span class="comment">   * creates an instance inherting oidcstrategy and then calls `instance.authenticate`.</span></span><br><span class="line"><span class="comment">   * Therefore, when we come here, `this` is the instance, its prototype is the</span></span><br><span class="line"><span class="comment">   * actual oidcstrategy, i.e. the `Strategy`. This means:</span></span><br><span class="line"><span class="comment">   * (1) `this._options = `, `this._verify = `, etc only adds new fields to the</span></span><br><span class="line"><span class="comment">   *      instance, it doesn&#x27;t change the values in oidcstrategy, i.e. `Strategy`.</span></span><br><span class="line"><span class="comment">   * (2) `this._options`, `this._verify`, etc returns the field in the instance,</span></span><br><span class="line"><span class="comment">   *     and if there is none, returns the field in oidcstrategy, i.e. `strategy`.</span></span><br><span class="line"><span class="comment">   * (3) each time we call `authenticate`, we will get a brand new instance</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * If you want to change the values in `Strategy`, use</span></span><br><span class="line"><span class="comment">   *      const oidcstrategy = Object.getPrototypeOf(self);</span></span><br><span class="line"><span class="comment">   * to get the strategy first.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Note: Simply do `const self = Object.getPrototypeOf(this)` and use `self`</span></span><br><span class="line"><span class="comment">   * won&#x27;t work, since the `this` instance has a couple of functions like</span></span><br><span class="line"><span class="comment">   * success/fail/error... which `authenticate` will call. The following is the</span></span><br><span class="line"><span class="comment">   * structure of `this`:</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *   this</span></span><br><span class="line"><span class="comment">   *   | --  success:  function(user, info)</span></span><br><span class="line"><span class="comment">   *   | --  fail:     function(challenge, status)</span></span><br><span class="line"><span class="comment">   *   | --  redirect: function(url, status)</span></span><br><span class="line"><span class="comment">   *   | --  pass:     function()</span></span><br><span class="line"><span class="comment">   *   | --  __proto__:  Strategy</span></span><br><span class="line"><span class="comment">   *                 | --  _verify</span></span><br><span class="line"><span class="comment">   *                 | --  _options</span></span><br><span class="line"><span class="comment">   *                 | --  ...</span></span><br><span class="line"><span class="comment">   *                 | --  __proto__:</span></span><br><span class="line"><span class="comment">   *                              | --  authenticate:  function(req, options)</span></span><br><span class="line"><span class="comment">   *                              | --  ...</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> resource = options &amp;&amp; options.<span class="property">resourceURL</span>;</span><br><span class="line">  <span class="keyword">var</span> customState = options &amp;&amp; options.<span class="property">customState</span>;</span><br><span class="line">  <span class="keyword">var</span> tenantIdOrName = options &amp;&amp; options.<span class="property">tenantIdOrName</span>;</span><br><span class="line">  <span class="keyword">var</span> login_hint = options &amp;&amp; options.<span class="property">login_hint</span>;</span><br><span class="line">  <span class="keyword">var</span> domain_hint = options &amp;&amp; options.<span class="property">domain_hint</span>;</span><br><span class="line">  <span class="keyword">var</span> prompt = options &amp;&amp; options.<span class="property">prompt</span>;</span><br><span class="line">  <span class="keyword">var</span> extraAuthReqQueryParams = options &amp;&amp; options.<span class="property">extraAuthReqQueryParams</span>;</span><br><span class="line">  <span class="keyword">var</span> extraTokenReqQueryParams = options &amp;&amp; options.<span class="property">extraTokenReqQueryParams</span>;</span><br><span class="line">  <span class="keyword">var</span> response = options &amp;&amp; options.<span class="property">response</span> || req.<span class="property">res</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &#x27;params&#x27;: items we get from the request or metadata, such as id_token, code, policy, metadata, cacheKey, etc</span></span><br><span class="line">  <span class="keyword">var</span> params = &#123; <span class="string">&#x27;tenantIdOrName&#x27;</span>: tenantIdOrName, <span class="string">&#x27;extraAuthReqQueryParams&#x27;</span>: extraAuthReqQueryParams, <span class="string">&#x27;extraTokenReqQueryParams&#x27;</span>: extraTokenReqQueryParams &#125;;</span><br><span class="line">  <span class="comment">// &#x27;oauthConfig&#x27;: items needed for oauth flow (like redirection, code redemption), such as token_endpoint, userinfo_endpoint, etc</span></span><br><span class="line">  <span class="keyword">var</span> oauthConfig = &#123; <span class="string">&#x27;resource&#x27;</span>: resource, <span class="string">&#x27;customState&#x27;</span>: customState, <span class="string">&#x27;domain_hint&#x27;</span>: domain_hint, <span class="string">&#x27;login_hint&#x27;</span>: login_hint, <span class="string">&#x27;prompt&#x27;</span>: prompt, <span class="string">&#x27;response&#x27;</span>: response &#125;;</span><br><span class="line">  <span class="comment">// &#x27;optionsToValidate&#x27;: items we need to validate id_token against, such as issuer, audience, etc</span></span><br><span class="line">  <span class="keyword">var</span> optionsToValidate = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span>.<span class="title function_">waterfall</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment">       * Step 1. Collect information from the req and save the info into params</span></span><br><span class="line"><span class="comment">       ****************************************************************************/</span></span><br><span class="line">      <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> self.<span class="title function_">collectInfoFromReq</span>(params, req, next, response);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment">       * Step 2. Load metadata, use the information from &#x27;params&#x27; and &#x27;self._options&#x27;</span></span><br><span class="line"><span class="comment">       * to configure &#x27;oauthConfig&#x27; and &#x27;optionsToValidate&#x27;</span></span><br><span class="line"><span class="comment">       ****************************************************************************/</span></span><br><span class="line">      <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> self.<span class="title function_">setOptions</span>(params, oauthConfig, optionsToValidate, next);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*****************************************************************************</span></span><br><span class="line"><span class="comment">       * Step 3. Handle the flows</span></span><br><span class="line"><span class="comment">       *----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">       * (1) implicit flow (response_type = &#x27;id_token&#x27;)</span></span><br><span class="line"><span class="comment">       *     This case we get a &#x27;id_token&#x27;</span></span><br><span class="line"><span class="comment">       * (2) hybrid flow (response_type = &#x27;id_token code&#x27;)</span></span><br><span class="line"><span class="comment">       *     This case we get both &#x27;id_token&#x27; and &#x27;code&#x27;</span></span><br><span class="line"><span class="comment">       * (3) authorization code flow (response_type = &#x27;code&#x27;)</span></span><br><span class="line"><span class="comment">       *     This case we get a &#x27;code&#x27;, we will use it to get &#x27;access_token&#x27; and &#x27;id_token&#x27;</span></span><br><span class="line"><span class="comment">       * (4) for any other request, we will ask for authorization and initialize</span></span><br><span class="line"><span class="comment">       *     the authorization process</span></span><br><span class="line"><span class="comment">       ****************************************************************************/</span></span><br><span class="line">      <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (params.<span class="property">err</span>) &#123;</span><br><span class="line">          <span class="comment">// handle the error</span></span><br><span class="line">          <span class="keyword">return</span> self.<span class="title function_">_errorResponseHandler</span>(params.<span class="property">err</span>, params.<span class="property">err_description</span>, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!params.<span class="property">id_token</span> &amp;&amp; !params.<span class="property">code</span>) &#123;</span><br><span class="line">          <span class="comment">// ask for authorization, initialize the authorization process</span></span><br><span class="line">          <span class="keyword">return</span> self.<span class="title function_">_flowInitializationHandler</span>(oauthConfig, req, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.<span class="property">id_token</span> &amp;&amp; params.<span class="property">code</span>) &#123;</span><br><span class="line">          <span class="comment">// handle hybrid flow</span></span><br><span class="line">          <span class="keyword">return</span> self.<span class="title function_">_hybridFlowHandler</span>(params, oauthConfig, optionsToValidate, req, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.<span class="property">id_token</span>) &#123;</span><br><span class="line">          <span class="comment">// handle implicit flow</span></span><br><span class="line">          <span class="keyword">return</span> self.<span class="title function_">_implicitFlowHandler</span>(params, optionsToValidate, req, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// handle authorization code flow</span></span><br><span class="line">          <span class="keyword">return</span> self.<span class="title function_">_authCodeFlowHandler</span>(params, oauthConfig, optionsToValidate, req, next);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="function">(<span class="params">waterfallError</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// this code gets called after the three steps above are done</span></span><br><span class="line">      <span class="keyword">if</span> (waterfallError) &#123;</span><br><span class="line">        <span class="keyword">return</span> self.<span class="title function_">failWithLog</span>(<span class="string">`<span class="subst">$&#123;aadutils.getErrorMessage(waterfallError)&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>By breaking the dots in this function, we can see that it keeps calling <strong>_flowInitializationHandler</strong> function repeatedly.</p><p>First, let’s take a look at what _flowInitializationHandler function does</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Strategy</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_flowInitializationHandler</span> = <span class="keyword">function</span> <span class="title function_">flowInitializationHandler</span>(<span class="params">oauthConfig, req, next</span>) &#123;</span><br><span class="line">  <span class="comment">// The request being authenticated is initiating OpenID Connect</span></span><br><span class="line">  <span class="comment">// authentication. Prior to redirecting to the provider, configuration will</span></span><br><span class="line">  <span class="comment">// be loaded. The configuration is typically either pre-configured or</span></span><br><span class="line">  <span class="comment">// discovered dynamically. When using dynamic discovery, a user supplies</span></span><br><span class="line">  <span class="comment">// their identifer as input.</span></span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> location = aadutils.<span class="title function_">concatUrl</span>(oauthConfig.<span class="property">authorization_endpoint</span>, querystring.<span class="title function_">stringify</span>(params));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> self.<span class="title function_">redirect</span>(location);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>So why do you keep entering this function?</p><p>Let’s take a look at his judgment condition, because there is no id-token and no code (you can see what these two parameters do in my previous article).</p><p>So why not? Where should these two parameters be set?</p><p>In fact, if we look forward, we will find that he first executes a function called <strong>collectInfoFromReq</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Strategy</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">collectInfoFromReq</span> = <span class="keyword">function</span>(<span class="params">params, req, next, response</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// the things we will put into &#x27;params&#x27;:</span></span><br><span class="line">  <span class="comment">// err, err_description, id_token, code, policy, state, nonce, cachekey, metadata</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// we shouldn&#x27;t get any access_token or refresh_token from the request</span></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">if</span> ((req.<span class="property">query</span> &amp;&amp; (req.<span class="property">query</span>.<span class="property">access_token</span> || req.<span class="property">query</span>.<span class="property">refresh_token</span>)) ||</span><br><span class="line">    (req.<span class="property">body</span> &amp;&amp; (req.<span class="property">body</span>.<span class="property">access_token</span> || req.<span class="property">body</span>.<span class="property">refresh_token</span>)))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: neither access token nor refresh token is expected in the incoming request&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// we might get err, id_token, code, state from the request</span></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">var</span> source = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">query</span> &amp;&amp; (req.<span class="property">query</span>.<span class="property">error</span> || req.<span class="property">query</span>.<span class="property">id_token</span> || req.<span class="property">query</span>.<span class="property">code</span>))</span><br><span class="line">    source = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="property">body</span> &amp;&amp; (req.<span class="property">body</span>.<span class="property">error</span> || req.<span class="property">body</span>.<span class="property">id_token</span> || req.<span class="property">body</span>.<span class="property">code</span>))</span><br><span class="line">    source = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (source) &#123;</span><br><span class="line">    params.<span class="property">err</span> = source.<span class="property">error</span>;</span><br><span class="line">    params.<span class="property">err_description</span> = source.<span class="property">error_description</span>;</span><br><span class="line">    params.<span class="property">id_token</span> = source.<span class="property">id_token</span>;</span><br><span class="line">    params.<span class="property">code</span> = source.<span class="property">code</span>;</span><br><span class="line">    params.<span class="property">state</span> = source.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">if</span> (source.<span class="property">state</span> &amp;&amp; source.<span class="property">state</span>.<span class="property">length</span> &gt;= <span class="number">38</span>) &#123;</span><br><span class="line">      <span class="comment">// the random generated state always has 32 characters. This state is longer than 32</span></span><br><span class="line">      <span class="comment">// so it must be a custom state. We added &#x27;CUSTOM&#x27; prefix and a random 32 byte long</span></span><br><span class="line">      <span class="comment">// string in front of the original custom state, now we change it back.</span></span><br><span class="line">      <span class="keyword">if</span> (!source.<span class="property">state</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;CUSTOM&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`In collectInfoFromReq: invalid custom state <span class="subst">$&#123;state&#125;</span>`</span>));</span><br><span class="line"></span><br><span class="line">      source.<span class="property">state</span> = source.<span class="property">state</span>.<span class="title function_">substring</span>(<span class="number">38</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// If we received code, id_token or err, we must have received state, now we</span></span><br><span class="line">  <span class="comment">// find the state/nonce/policy tuple from session.</span></span><br><span class="line">  <span class="comment">// If we received none of them, find policy in query</span></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">if</span> (params.<span class="property">id_token</span> || params.<span class="property">code</span> || params.<span class="property">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!params.<span class="property">state</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: missing state in the request&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> tuple;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!self.<span class="property">_useCookieInsteadOfSession</span>)</span><br><span class="line">      tuple = self.<span class="property">_sessionContentHandler</span>.<span class="title function_">findAndDeleteTupleByState</span>(req, self.<span class="property">_key</span>, params.<span class="property">state</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      tuple = self.<span class="property">_cookieContentHandler</span>.<span class="title function_">findAndDeleteTupleByState</span>(req, response, params.<span class="property">state</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!tuple)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: invalid state received in the request&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    params.<span class="property">nonce</span> = tuple[<span class="string">&#x27;nonce&#x27;</span>];</span><br><span class="line">    params.<span class="property">policy</span> = tuple[<span class="string">&#x27;policy&#x27;</span>];</span><br><span class="line">    params.<span class="property">resource</span> = tuple[<span class="string">&#x27;resource&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// user provided tenantIdOrName will be ignored for redirectUrl, since we saved the one we used in session</span></span><br><span class="line">    <span class="keyword">if</span> (params.<span class="property">tenantIdOrName</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">loggingNoPII</span>)</span><br><span class="line">        log.<span class="title function_">info</span>(<span class="string">&#x27;user provided tenantIdOrName is ignored for redirectUrl, we will use the one stored in session&#x27;</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        log.<span class="title function_">info</span>(<span class="string">`user provided tenantIdOrName &#x27;<span class="subst">$&#123;params.tenantIdOrName&#125;</span>&#x27; is ignored for redirectUrl, we will use the one stored in session`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    params.<span class="property">tenantIdOrName</span> = tuple[<span class="string">&#x27;tenantIdOrName&#x27;</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    params.<span class="property">policy</span> = req.<span class="property">query</span>.<span class="property">p</span> ? req.<span class="property">query</span>.<span class="property">p</span>.<span class="title function_">toLowerCase</span>() : <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if we are not using the common endpoint, but we have tenantIdOrName, just ignore it</span></span><br><span class="line">  <span class="keyword">if</span> (!self.<span class="property">_options</span>.<span class="property">isCommonEndpoint</span> &amp;&amp; params.<span class="property">tenantIdOrName</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">loggingNoPII</span>)</span><br><span class="line">      log.<span class="title function_">info</span>(<span class="string">&#x27;identityMetadata is tenant-specific, so we ignore the tenantIdOrName provided&#x27;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      log.<span class="title function_">info</span>(<span class="string">`identityMetadata is tenant-specific, so we ignore the tenantIdOrName &#x27;<span class="subst">$&#123;params.tenantIdOrName&#125;</span>&#x27;`</span>);</span><br><span class="line">    params.<span class="property">tenantIdOrName</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if we are using the common endpoint and we want to validate issuer, then user has to</span></span><br><span class="line">  <span class="comment">// provide issuer in config, or provide tenant id or name using tenantIdOrName option in</span></span><br><span class="line">  <span class="comment">// passport.authenticate. Otherwise we won&#x27;t know the issuer.</span></span><br><span class="line">  <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">isCommonEndpoint</span> &amp;&amp; self.<span class="property">_options</span>.<span class="property">validateIssuer</span> &amp;&amp;</span><br><span class="line">    (!self.<span class="property">_options</span>.<span class="property">issuer</span> &amp;&amp; !params.<span class="property">tenantIdOrName</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: issuer or tenantIdOrName must be provided in order to validate issuer on common endpoint&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for B2C, we must have policy</span></span><br><span class="line">  <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">isB2C</span> &amp;&amp; !params.<span class="property">policy</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: policy is missing&#x27;</span>));</span><br><span class="line">  <span class="comment">// for B2C, if we are using common endpoint, we must have tenantIdOrName provided</span></span><br><span class="line">  <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">isB2C</span> &amp;&amp; self.<span class="property">_options</span>.<span class="property">isCommonEndpoint</span> &amp;&amp; !params.<span class="property">tenantIdOrName</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;In collectInfoFromReq: we are using common endpoint for B2C but tenantIdOrName is not provided&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// calculate metadataUrl, create a cachekey and an Metadata object instance</span></span><br><span class="line">  <span class="comment">// we will fetch the metadata, save it into the object using the cachekey</span></span><br><span class="line">  <span class="comment">// -------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">var</span> metadataUrl = self.<span class="property">_options</span>.<span class="property">identityMetadata</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if we are using common endpoint and we are given the tenantIdOrName, let&#x27;s replace it</span></span><br><span class="line">  <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">isCommonEndpoint</span> &amp;&amp; params.<span class="property">tenantIdOrName</span>) &#123;</span><br><span class="line">    metadataUrl = metadataUrl.<span class="title function_">replace</span>(<span class="string">&#x27;/common/&#x27;</span>, <span class="string">`/<span class="subst">$&#123;params.tenantIdOrName&#125;</span>/`</span>);</span><br><span class="line">    <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">loggingNoPII</span>)</span><br><span class="line">      log.<span class="title function_">info</span>(<span class="string">`we are replacing &#x27;common&#x27; with the tenantIdOrName provided`</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      log.<span class="title function_">info</span>(<span class="string">`we are replacing &#x27;common&#x27; with the tenantIdOrName <span class="subst">$&#123;params.tenantIdOrName&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add policy for B2C</span></span><br><span class="line">  <span class="keyword">if</span> (self.<span class="property">_options</span>.<span class="property">isB2C</span>)</span><br><span class="line">    metadataUrl = metadataUrl.<span class="title function_">concat</span>(<span class="string">`&amp;p=<span class="subst">$&#123;params.policy&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we use the metadataUrl as the cachekey</span></span><br><span class="line">  params.<span class="property">cachekey</span> = metadataUrl;</span><br><span class="line">  params.<span class="property">metadata</span> = <span class="keyword">new</span> <span class="title class_">Metadata</span>(metadataUrl, <span class="string">&#x27;oidc&#x27;</span>, self.<span class="property">_options</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!self.<span class="property">_options</span>.<span class="property">loggingNoPII</span>) &#123;</span><br><span class="line">    log.<span class="title function_">info</span>(<span class="string">`metadataUrl is: <span class="subst">$&#123;metadataUrl&#125;</span>`</span>);</span><br><span class="line">    log.<span class="title function_">info</span>(<span class="string">`received the following items in params: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(params)&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>This function will get the id-token from the request at the beginning. If it cannot be obtained here, the next function will not be able to obtain it.</p><h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>To sum up, the process of infinite callback is to first go to Microsoft to verify successfully and return the id-token, and then call our/auth/openid/return, which is passport.authenciate. In this function, because the body cannot be parsed, the id-token cannot be obtained, resulting in a re-request to Microsoft, a successful return of the request, a call to passport.authenciate, again unable to obtain the id-token, re-authentication, infinite loop.</p><h2 id="Updated-on-2020-02-08"><a href="#Updated-on-2020-02-08" class="headerlink" title="Updated on 2020-02-08"></a>Updated on 2020-02-08</h2><p>This week’s work encountered another reason that will cause the login failure of passport-azure-ad. Although it will not lead to an infinite loop, the root cause is the internal cause of passport-azure-ad. The form of performance is that the login to azure is successful., but passport just thinks that the login was not successful.</p><p>Take a look at the log and find that he will prompt.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params.metadata.generateOidcPEM is not a function</span><br></pre></td></tr></table></figure><p>So where does this params.metadata.generateOidcPEM come from?</p><p>Take a closer look at the source code of passport-azure-ad and find that if the data is successfully returned from azure, passport still needs to check the legitimacy of the data. This function is used to check the legitimacy. Without this function, the verification will result. If it does not pass, passport believes that the returned data is illegal.</p><p>So why is this suddenly causing this problem?</p><p>The reason is that passport-azure-ad itself relies on a package called cache-manager, and the version requirement for this package is “^ 2.0.0”. Recently, the package called cache-manager has been upgraded, and the version above 2.11.0 The method of deep cloning has changed from lodash’s deepClone to deepmerge, resulting in the loss of some data in the parameters.</p><p>So we just need to specify the cache-manager version in package.json as 2.10.0 or 2.10.2.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/a8bec924/" title="passport-azure-ad_ infinite refresh problem">https://sunra.top/en/posts/a8bec924/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/46cef286/" rel="prev" title="OAuth and OIDC"><i class="fa fa-chevron-left"></i> OAuth and OIDC</a></div><div class="post-nav-item"> <a href="/en/posts/dfbc1109/" rel="next" title="Azure Key Vault">Azure Key Vault<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/a8bec924/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>