<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="In recent days, I encountered a requirement, that is, when the project starts, I need to dynamically generate some code and introduce the generated code. At the beginning, my approach was to write the"><meta property="og:type" content="article"><meta property="og:title" content="require-from-string"><meta property="og:url" content="https://sunra.top/en/posts/3a9e8388/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="In recent days, I encountered a requirement, that is, when the project starts, I need to dynamically generate some code and introduce the generated code. At the beginning, my approach was to write the"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-03-07T04:14:55.000Z"><meta property="article:modified_time" content="2023-08-02T03:24:18.120Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/3a9e8388/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/3a9e8388/","path":"posts/3a9e8388/","title":"require-from-string"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>require-from-string | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#require-from-string"><span class="nav-number">1.</span> <span class="nav-text">require-from-string</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">1.1.</span> <span class="nav-text">API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#requireFromString-code"><span class="nav-number">1.2.</span> <span class="nav-text">requireFromString(code,</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#code"><span class="nav-number">1.2.1.</span> <span class="nav-text">code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filename"><span class="nav-number">1.2.2.</span> <span class="nav-text">filename</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#options"><span class="nav-number">1.2.3.</span> <span class="nav-text">options</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#appendPaths"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">appendPaths</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#prependPaths"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">prependPaths</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Principle"><span class="nav-number">2.</span> <span class="nav-text">Principle</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link"><span class="nav-number">2.1.</span><span class="nav-text"></span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#module-compile"><span class="nav-number">2.2.</span> <span class="nav-text">module._compile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Required-principle"><span class="nav-number">3.</span> <span class="nav-text">Required principle</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/3a9e8388/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="require-from-string | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> require-from-string</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-03-07 12:14:55" itemprop="dateCreated datePublished" datetime="2020-03-07T12:14:55+08:00">2020-03-07</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-08-02 11:24:18" itemprop="dateModified" datetime="2023-08-02T11:24:18+08:00">2023-08-02</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/3a9e8388/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/3a9e8388/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>In recent days, I encountered a requirement, that is, when the project starts, I need to dynamically generate some code and introduce the generated code. At the beginning, my approach was to write the generated code into a file, then require these files, and then succeed. Then delete the file. After doing it, I found out that these files are not necessary to create, can they be directly imported from memory, which reduces the number of files io twice, and require is actually reading the file into memory and then parsing it, so from There is also a theoretical possibility of direct introduction in memory.</p><span id="more"></span><p>Here is a record of the specific approach and the principle behind the analysis.</p><h2 id="require-from-string"><a href="#require-from-string" class="headerlink" title="require-from-string"></a>require-from-string</h2><p>In fact, this function was developed a long time ago. You just need to download the package “require-from-string” from the npm repository, and then you can directly pass the code string to the function.</p><p>One thing to note here is that if you introduce other modules through require-from-string in the code, the relative paths of these modules will be relative to where you call require-from-string.</p><p>Here is a simple official example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requireFromString = <span class="built_in">require</span>(<span class="string">&#x27;require-from-string&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">requireFromString(<span class="string">&#x27;module.exports = 1&#x27;</span>);</span><br><span class="line"><span class="comment">//=&gt; 1</span></span><br></pre></td></tr></table></figure><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h3 id="requireFromString-code"><a href="#requireFromString-code" class="headerlink" title="requireFromString(code,"></a>requireFromString(code,</h3><h4 id="code"><a href="#code" class="headerlink" title="code"></a>code</h4><p><em>Required</em><br>Type: <code>string</code></p><p>Module code.</p><h4 id="filename"><a href="#filename" class="headerlink" title="filename"></a>filename</h4><p>Type: <code>string</code><br>Default: <code>&#39;&#39;</code></p><p>Optional filename.</p><h4 id="options"><a href="#options" class="headerlink" title="options"></a>options</h4><p>Type: <code>object</code></p><h5 id="appendPaths"><a href="#appendPaths" class="headerlink" title="appendPaths"></a>appendPaths</h5><p>Type: <code>Array</code></p><p>List of <code>paths</code>, that will be appended to module <code>paths</code>. Useful, when you want to be able require modules from these paths.</p><h5 id="prependPaths"><a href="#prependPaths" class="headerlink" title="prependPaths"></a>prependPaths</h5><p>Type: <code>Array</code></p><p>Same as <code>appendPaths</code>, but paths will be prepended.</p><h2 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h2><p>This package is very simple to use. After using it, let’s take a look at his<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/floatdrop/require-from-string#readme">源码</a>。</p><p>The source code is also very simple, with only one index.js file</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Module</span> = <span class="built_in">require</span>(<span class="string">&#x27;module&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">requireFromString</span>(<span class="params">code, filename, opts</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> filename = <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">		opts = filename;</span><br><span class="line">		filename = <span class="literal">undefined</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	opts = opts || &#123;&#125;;</span><br><span class="line">	filename = filename || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	opts.<span class="property">appendPaths</span> = opts.<span class="property">appendPaths</span> || [];</span><br><span class="line">	opts.<span class="property">prependPaths</span> = opts.<span class="property">prependPaths</span> || [];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> code ! <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;code must be a string, not &#x27;</span> + <span class="keyword">typeof</span> code);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> paths = <span class="title class_">Module</span>.<span class="title function_">_nodeModulePaths</span>(path.<span class="title function_">dirname</span>(filename));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> parent = <span class="variable language_">module</span>.<span class="property">parent</span>;</span><br><span class="line">	<span class="keyword">var</span> m = <span class="keyword">new</span> <span class="title class_">Module</span>(filename, parent);</span><br><span class="line">	m.<span class="property">filename</span> = filename;</span><br><span class="line">	m.<span class="property">paths</span> = [].<span class="title function_">concat</span>(opts.<span class="property">prependPaths</span>).<span class="title function_">concat</span>(paths).<span class="title function_">concat</span>(opts.<span class="property">appendPaths</span>);</span><br><span class="line">	m.<span class="title function_">_compile</span>(code, filename);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> <span class="built_in">exports</span> = m.<span class="property">exports</span>;</span><br><span class="line">	parent &amp;&amp; parent.<span class="property">children</span> &amp;&amp; parent.<span class="property">children</span>.<span class="title function_">splice</span>(parent.<span class="property">children</span>.<span class="title function_">indexOf</span>(m), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">exports</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The most important thing in this code is the reference to the Nodejs module core module.</p><p>Several variables and methods of the Module module are used here.</p><div class="table-container"><table><thead><tr><th>properties/methods</th><th>desc</th></tr></thead><tbody><tr><td>module.children</td><td>are the modules required by this module</td></tr><tr><td>module.exports</td><td>is what the module exposes to the referencer</td></tr><tr><td>module.filename</td><td>filename</td></tr><tr><td>Module.loaded</td><td>load is completed, such as in the previous circular reference example, when the load is not completed</td></tr><tr><td>module.parent</td><td>The first module that requires this module</td></tr><tr><td>module.require (id)</td><td>is the real body of require. I haven’t used it much. It seems that it can be required after the load is completed, but only exports can be seen in other modules, so the module itself needs to be exported.</td></tr></tbody></table></div><h3 id><a href="#" class="headerlink" title=" "></a></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Module</span>(<span class="params">id, parent</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">exports</span> = &#123;&#125;;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">parent</span> = parent;</span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; parent.<span class="property">children</span>) &#123;</span><br><span class="line">    parent.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">filename</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">loaded</span> = <span class="literal">false</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">children</span> = [];</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Module</span>;</span><br></pre></td></tr></table></figure><h3 id="module-compile"><a href="#module-compile" class="headerlink" title="module._compile"></a>module._compile</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run the file contents in the correct scope or sandbox. Expose</span></span><br><span class="line"><span class="comment">// the correct helper variables (require, module, exports) to</span></span><br><span class="line"><span class="comment">// the file.</span></span><br><span class="line"><span class="comment">// Returns exception, if any.</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_compile</span> = <span class="keyword">function</span>(<span class="params">content, filename</span>) &#123;</span><br><span class="line">  ...(omit here)...</span><br><span class="line">  <span class="comment">// create wrapper function</span></span><br><span class="line">  <span class="keyword">var</span> wrapper = <span class="title class_">Module</span>.<span class="title function_">wrap</span>(content);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> compiledWrapper = vm.<span class="title function_">runInThisContext</span>(wrapper, &#123;</span><br><span class="line">    <span class="attr">filename</span>: filename,</span><br><span class="line">    <span class="attr">lineOffset</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">displayErrors</span>: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">_debugWaitConnect</span> &amp;&amp; process.<span class="property">_eval</span>  <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!resolvedArgv) &#123;</span><br><span class="line">      <span class="comment">// we enter the repl if we&#x27;re not given a filename argument.</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">argv</span>[<span class="number">1</span>]) &#123;</span><br><span class="line">        resolvedArgv = <span class="title class_">Module</span>.<span class="title function_">_resolveFilename</span>(process.<span class="property">argv</span>[<span class="number">1</span>], <span class="literal">null</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolvedArgv = <span class="string">&#x27;repl&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set breakpoint on module start</span></span><br><span class="line">    <span class="keyword">if</span> (filename = resolvedArgv) &#123;</span><br><span class="line">      <span class="keyword">delete</span> process.<span class="property">_debugWaitConnect</span>;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Debug</span> = vm.<span class="title function_">runInDebugContext</span>(<span class="string">&#x27;Debug&#x27;</span>);</span><br><span class="line">      <span class="title class_">Debug</span>.<span class="title function_">setBreakPoint</span>(compiledWrapper, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> dirname = path.<span class="title function_">dirname</span>(filename);</span><br><span class="line">  <span class="keyword">var</span> <span class="built_in">require</span> = internalModule.<span class="property">makeRequireFunction</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="keyword">var</span> args = [<span class="variable language_">this</span>.<span class="property">exports</span>, <span class="built_in">require</span>, <span class="variable language_">this</span>, filename, dirname];</span><br><span class="line">  <span class="keyword">var</span> depth = internalModule.<span class="property">requireDepth</span>;</span><br><span class="line">  <span class="keyword">if</span> (depth = <span class="number">0</span>) stat.<span class="property">cache</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="keyword">var</span> result = compiledWrapper.<span class="title function_">apply</span>(<span class="variable language_">this</span>.<span class="property">exports</span>, args);</span><br><span class="line">  <span class="keyword">if</span> (depth = <span class="number">0</span>) stat.<span class="property">cache</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Required-principle"><a href="#Required-principle" class="headerlink" title="Required principle"></a>Required principle</h2><p>If the understanding of the above code is not enough, you can take a look at the source code of require. In fact, require-from-string is to intercept the processing of js files in the require source code, and omit some details of the results, eliminating the need for file type judgment, module cache, paths generation, etc.</p><p>The specific principle analysis can be seen.<a target="_blank" rel="external nofollow noopener noreferrer" href="http://tech.colla.me/zh/show/further_reading_on_node.js_modules">这里</a>。</p><p>To sum up, it is</p><ul><li><p>require actually calls the _load method of the module. This method will first generate the absolute path of the file according to the imported parameter, and then use this absolute path as a key to check the cache (in fact, it is an object). If found, return directly, if not found Continue to compile.</p></li><li><p>compile will first find whether it is the core module, if so, return the require result of the core module, if not, continue.</p></li><li><p>Next is the step in require-from-string, new Module (filename, parent).</p></li><li><p>Next is the assignment of some variables, such as isMain. If the node command runs this file, it is the entry file, and process.mainModule is the current module.</p></li><li><p>The next step is to save this module to the cache.</p></li><li><p>Call tryModuleLoad (module, filename), this method will call module.load, if the call fails, the current module will be removed from the cache.</p></li><li><p>So what does module.load do? The Module._nodeModulePaths (path.dirname (filename)) method generates the path, then gets the extension according to the path, and then calls different methods for different file types, json uses JSON.parse, js calls the module._compile method</p></li><li><p>This _compile parses the module</p></li><li><p>The end is to call NativeModule.wrapper to put the packaged module into the closure</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">NativeModule</span>.<span class="property">wrap</span> = <span class="keyword">function</span>(<span class="params">script</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NativeModule</span>.<span class="property">wrapper</span>[<span class="number">0</span>] + script + <span class="title class_">NativeModule</span>.<span class="property">wrapper</span>[<span class="number">1</span>];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">NativeModule</span>.<span class="property">wrapper</span> = [</span><br><span class="line">    <span class="string">&#x27;(function (exports, require, module, __filename, __dirname) &#123; &#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;\n&#125;);&#x27;</span></span><br><span class="line">  ];</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/3a9e8388/" title="require-from-string">https://sunra.top/en/posts/3a9e8388/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/22dc037c/" rel="prev" title="spring-boot-mongodb-transaction"><i class="fa fa-chevron-left"></i> spring-boot-mongodb-transaction</a></div><div class="post-nav-item"> <a href="/en/posts/d0e5ee76/" rel="next" title="v-charts">v-charts<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/3a9e8388/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>