<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Overview of Same Origin PolicyMeaningIn 1995, the same origin policy was introduced into browsers by Netscape. Currently, all browsers implement this policy.Originally, it meant that the cookie set by"><meta property="og:type" content="article"><meta property="og:title" content="Thinking about Same Origin Strategy and Cross-domain Method"><meta property="og:url" content="https://sunra.top/en/posts/cd718394/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Overview of Same Origin PolicyMeaningIn 1995, the same origin policy was introduced into browsers by Netscape. Currently, all browsers implement this policy.Originally, it meant that the cookie set by"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2019-08-10T02:41:36.000Z"><meta property="article:modified_time" content="2023-11-19T00:05:39.264Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/cd718394/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/cd718394/","path":"posts/cd718394/","title":"Thinking about Same Origin Strategy and Cross-domain Method"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Thinking about Same Origin Strategy and Cross-domain Method | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview-of-Same-Origin-Policy"><span class="nav-number">1.</span> <span class="nav-text">Overview of Same Origin Policy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Meaning"><span class="nav-number">1.1.</span> <span class="nav-text">Meaning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Purpose"><span class="nav-number">1.2.</span> <span class="nav-text">Purpose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scenario-examples"><span class="nav-number">1.3.</span> <span class="nav-text">Scenario examples</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Steal-cookies"><span class="nav-number">1.3.1.</span> <span class="nav-text">Steal cookies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stealing-pages"><span class="nav-number">1.3.2.</span> <span class="nav-text">Stealing pages</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Restricted-range"><span class="nav-number">1.4.</span> <span class="nav-text">Restricted range</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Two-common-ways-of-AJAX-cross-domain"><span class="nav-number">2.</span> <span class="nav-text">Two common ways of AJAX cross-domain</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CORS"><span class="nav-number">2.1.</span> <span class="nav-text">CORS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Introduction"><span class="nav-number">2.1.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Simple-requests-and-non-simple-requests"><span class="nav-number">2.1.2.</span> <span class="nav-text">Simple requests and non-simple requests</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Simple-request"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">Simple request</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Non-simple-request"><span class="nav-number">2.1.2.2.</span> <span class="nav-text">Non-simple request</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-reverse-proxy"><span class="nav-number">2.2.</span> <span class="nav-text">Nginx reverse proxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Same-Origin-Policy-Thinking-Triggered-by-Retargeting-Request"><span class="nav-number">3.</span> <span class="nav-text">Same-Origin Policy Thinking Triggered by Retargeting Request</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">4.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Security-Issues-of-Same-Origin-Policy"><span class="nav-number">5.</span> <span class="nav-text">Security Issues of Same Origin Policy</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/cd718394/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Thinking about Same Origin Strategy and Cross-domain Method | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Thinking about Same Origin Strategy and Cross-domain Method</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-08-10 10:41:36" itemprop="dateCreated datePublished" datetime="2019-08-10T10:41:36+08:00">2019-08-10</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-11-19 08:05:39" itemprop="dateModified" datetime="2023-11-19T08:05:39+08:00">2023-11-19</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/cd718394/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/cd718394/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="Overview-of-Same-Origin-Policy"><a href="#Overview-of-Same-Origin-Policy" class="headerlink" title="Overview of Same Origin Policy"></a>Overview of Same Origin Policy</h2><h3 id="Meaning"><a href="#Meaning" class="headerlink" title="Meaning"></a>Meaning</h3><p>In 1995, the same origin policy was introduced into browsers by Netscape. Currently, all browsers implement this policy.<br>Originally, it meant that the cookie set by A webpage and B webpage cannot be opened unless the two webpages are “of the same origin”. The so-called “same origin” means “three are the same”. The protocol is the same, the domain name is the same, and the port is the same.</p><span id="more"></span><h3 id="Purpose"><a href="#Purpose" class="headerlink" title="Purpose"></a>Purpose</h3><p>The purpose of the same origin policy is to ensure the security of user information and prevent malicious websites from stealing data.</p><h3 id="Scenario-examples"><a href="#Scenario-examples" class="headerlink" title="Scenario examples"></a>Scenario examples</h3><h4 id="Steal-cookies"><a href="#Steal-cookies" class="headerlink" title="Steal cookies"></a>Steal cookies</h4><p>Imagine a situation like this: Website A is a bank, and after the user logs in, he goes to another website. What would happen if other websites could read the cookies of Website A?<br>Obviously, if the cookie contains privacy (such as the total amount of deposits), this information will be leaked. Even more frightening is that cookies are often used to save the user’s login status. If the user does not log out, other websites can impersonate the user and do whatever they want. Because the browser also stipulates that submitting forms is not subject to the same origin policy.</p><h4 id="Stealing-pages"><a href="#Stealing-pages" class="headerlink" title="Stealing pages"></a>Stealing pages</h4><ol><li>One day you just woke up and received an email saying that your bank account was at risk, so you quickly clicked on the www.yinghang.com to change the password. You are scared to pee, so you quickly click on it, or the familiar bank login interface, you decisively enter your account password and log in to see if the money is missing.</li><li>You didn’t see it clearly, the bank website you usually visit is www.yinhang.com, and now you are visiting www.yinghang.com, what does this phishing website do?<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// HTML</span><br><span class="line">&lt;iframe name=&quot;yinhang&quot; src=&quot;www.yinhang.com&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">// JS</span><br><span class="line">//Since there is no restriction of the same origin strategy, phishing websites can directly get the Dom of other websites.</span><br><span class="line">const iframe = window.frames[&#x27;yinhang&#x27;]</span><br><span class="line">Const node = iframe.document.getElementById (&#x27;Input for your account password&#x27;)</span><br><span class="line">Console.log (&#x27;I got this $&#123;node&#125;, can&#x27;t I get the account password you just entered&#x27;)</span><br></pre></td></tr></table></figure></li></ol><p>It can be seen that the “same origin policy” is necessary, otherwise cookies can be shared and the Internet is not safe at all.</p><h3 id="Restricted-range"><a href="#Restricted-range" class="headerlink" title="Restricted range"></a>Restricted range</h3><ol><li>Cookie，LocalStorage和IndexDB。</li><li>DOM cannot be obtained.</li><li>AJAX request cannot be sent</li></ol><h2 id="Two-common-ways-of-AJAX-cross-domain"><a href="#Two-common-ways-of-AJAX-cross-domain" class="headerlink" title="Two common ways of AJAX cross-domain"></a>Two common ways of AJAX cross-domain</h2><h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>CORS is a W3C standard, the full name is “Cross-Origin Resource Sharing” (Cross-origin resource sharing).<br>It allows browsers to make XMLHttpRequest requests to cross-origin servers, thus overcoming the limitation that AJAX can only be used from the same origin.</p><h4 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h4><p>CORS requires both browser and server support. Currently, all browsers support this feature, and IE browsers cannot be lower than IE10.</p><p>The entire CORS communication process is automatically completed by the browser and does not require customer engagement. For developers, CORS communication is no different from AJAX communication of the same origin, and the code is exactly the same. Once the browser finds that the AJAX request is cross-origin, it will automatically add some additional header information, and sometimes there will be an additional request, but the user will not feel it.</p><p>Therefore, the key to achieving CORS communication is the server. As long as the server implements the CORS interface, it can communicate across origins.</p><h4 id="Simple-requests-and-non-simple-requests"><a href="#Simple-requests-and-non-simple-requests" class="headerlink" title="Simple requests and non-simple requests"></a>Simple requests and non-simple requests</h4><p>Browsers divide CORS requests into two categories: simple requests and not-so-simple requests.</p><h5 id="Simple-request"><a href="#Simple-request" class="headerlink" title="Simple request"></a>Simple request</h5><p>As long as the following two conditions are met at the same time, it is a simple request.</p><blockquote><p>（1)<br>HEAD<br>GET<br>POST<br>(2) HTTP header information does not exceed the following fields:</p><p>Accept<br>Accept-Language<br>Content-Language<br>Last-Event-ID<br>Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</p></blockquote><p>For simple requests, the browser issues a CORS request directly. Specifically, an Origin field is added to the header information.</p><p>The following is an example. The browser finds that this cross-origin AJAX request is a simple request, and automatically adds an Origin field to the header information</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /cors HTTP/1.1</span><br><span class="line">Origin: http://api.bob.com</span><br><span class="line">Host: api.alice.com</span><br><span class="line">Accept-Language: en-US</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0...</span><br></pre></td></tr></table></figure><p>In the header information above, the’Origin ‘field is used to indicate which source this request comes from (protocol + domain name + port). Based on this value, the server decides whether to agree to the request.</p><p>If the source specified by’Origin ‘is not within the permission scope, the server will return a normal HTTP response. The browser detects that the header information of this response does not contain the’Access-Control-Allow-Origin’ field (see below for details), knows that an error has occurred, and throws an error, which is caught by the’onerror ‘callback function of’XMLHttpRequest’. Note that this error cannot be identified by a status code, as the status code of an HTTP response may be 200.</p><p>If the domain name specified by Origin is within the permission scope, the response returned by the server will have several more header information fields.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://api.bob.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Expose-Headers: FooBar</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br></pre></td></tr></table></figure><p><strong>（1）Access-Control-Allow-Origin</strong></p><p>This field is required. Its value is either the value of the’Origin ‘field at the time of the request, or a’ * ‘indicating acceptance of the request for any domain name.</p><p><strong>（2）Access-Control-Allow-Credentials</strong></p><p>This field is optional. Its value is a Boolean value indicating whether to allow sending cookies. By default, cookies are not included in CORS requests. Set’true ‘to indicate that the server explicitly allows cookies to be included in the request and sent to the server. This value can only be set to’true’. If the server does not want the browser to send cookies, delete this field.</p><p><strong>（3）Access-Control-Expose-Headers</strong></p><p>This field is optional. When requesting CORS, the getResponseHeader () method of the XMLHttpRequest object can only get 6 basic fields: Cache-Control, Content-Language, Content-Type, Expires, Last-Modified, Pragma. If you want to get other fields, you must specify them in Access-Control-Exposure-Headers. The above example specifies that getResponseHeader (FooBar) can return the value of the FooBar field.</p><p>As mentioned above, CORS requests do not send cookies and HTTP authentication information by default. If you want to send cookies to the server, on the one hand, the server agrees, specify the’Access-Control-Allow-Credentials’ field.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials:</span><br></pre></td></tr></table></figure></blockquote><p>On the other hand, the developer must turn on the’withCredentials’ property in the AJAX request.</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">xhr.<span class="property">withCredentials</span></span><br></pre></td></tr></table></figure></blockquote><p>Otherwise, even if the server agrees to send cookies, the browser will not send them. Alternatively, if the server requests to set cookies, the browser will not process them.</p><p>However, if the’withCredentials’ setting is omitted, some browsers will still send cookies together. At this time, you can explicitly turn off’withCredentials’.</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xhr.<span class="property">withCredentials</span></span><br></pre></td></tr></table></figure></blockquote><p>It should be noted that if you want to send cookies, ‘Access-Control-Allow-Origin’ cannot be set to an asterisk, and a clear domain name that is consistent with the requested web page must be specified. At the same time, cookies still follow the same origin policy, only cookies set with the server domain name will be uploaded, cookies with other domain names will not be uploaded, and the’document.cookie ‘in the (cross-origin) original web page code cannot read the server domain name Cookie.</p><h5 id="Non-simple-request"><a href="#Non-simple-request" class="headerlink" title="Non-simple request"></a>Non-simple request</h5><ol><li>Preflight requests</li></ol><p>Non-simple requests are those that have special requirements for the server, such as the request method being’PUT ‘or’DELETE’, or the type of the’Content-Type ‘field being’application/json’.</p><p>CORS requests that are not simple requests will add an HTTP query request before formal communication, called a “preflight” request.</p><p>The browser first asks the server whether the domain name where the current webpage is located is in the server’s permission list, and which HTTP verbs and header information fields can be used. Only when a positive answer is received, the browser will issue an official’XMLHttpRequest ‘request, otherwise an error will be reported.</p><p>Below is a JavaScript script for the browser.</p><blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;PUT&#x27;</span>,</span><br><span class="line">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;X-Custom-Header&#x27;</span>,</span><br><span class="line">xhr.<span class="title function_">send</span>();</span><br></pre></td></tr></table></figure></blockquote><p>In the above code, the HTTP request method is’PUT ‘and sends a custom header information’X-Custom-Header’.</p><p>The browser finds that this is a non-simple request and automatically issues a “preflight” request, asking the server to confirm that such a request can be made. Below is the HTTP header information of this “preflight” request.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS</span><br><span class="line"><span class="attribute">Origin</span>:</span><br><span class="line"><span class="attribute">Access-Control-Request-Method</span>:</span><br><span class="line"><span class="attribute">Access-Control-Request-Headers</span>:</span><br><span class="line"><span class="attribute">Host</span>:</span><br><span class="line"><span class="attribute">Accept-Language</span>:</span><br><span class="line"><span class="attribute">Connection</span>:</span><br><span class="line">User-Agent:</span><br></pre></td></tr></table></figure></blockquote><p>The request method used for the “preflight” request is’OPTIONS ‘, indicating that the request is used for inquiry. In the header information, the keyword field is’Origin’, indicating which source the request comes from.</p><p>In addition to the’Origin ‘field, the header information of the “preflight” request includes two special fields.</p><p><strong>（1）Access-Control-Request-Method</strong></p><p>This field is required to list which HTTP methods will be used in the browser’s CORS request. The above example is’PUT ‘.</p><p><strong>（2）Access-Control-Request-Headers</strong></p><p>This field is a comma-separated string that specifies the additional header information field that the browser CORS request will send. The above example is’X-Custom-Header ‘.</p><ol><li>Return of preflight request</li></ol><p>After the server receives the “preflight” request, checks the’Origin ‘,’ Access-Control-Request-Method ‘, and’Access-Control-Request-Headers’ fields, and confirms that cross-origin requests are allowed, it can respond.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1</span><br><span class="line"><span class="attribute">Date</span>:</span><br><span class="line"><span class="attribute">Server</span>:</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>:</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>:</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>:</span><br><span class="line"><span class="attribute">Content-Type</span>:</span><br><span class="line"><span class="attribute">Content-Encoding</span>:</span><br><span class="line"><span class="attribute">Content-Length</span>:</span><br><span class="line"><span class="attribute">Keep-Alive</span>:</span><br><span class="line"><span class="attribute">Connection</span>:</span><br><span class="line">Content-Type:</span><br></pre></td></tr></table></figure></blockquote><p>In the HTTP response above, the key is the Access-Control-Allow-Origin field, indicating that <a target="_blank" rel="external nofollow noopener noreferrer" href="http://api.bob.com">http://api.bob.com</a> can request data. This field can also be set to an asterisk to indicate consent to any cross-origin request.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin:</span><br></pre></td></tr></table></figure></blockquote><p>If the browser rejects the “preflight” request, it will return a normal HTTP response, but without any CORS-related header information fields. At this time, the browser will determine that the server does not agree with the preflight request, so an error is triggered, which is caught by the “onerror” callback function of the “XMLHttpRequest” object. The Console will print the following error message.</p><blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XMLHttpRequest</span><br><span class="line">Origin</span><br></pre></td></tr></table></figure></blockquote><p>Other CORS related fields of the server response are as follows.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Methods</span>:</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span>:</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span>:</span><br><span class="line">Access-Control-Max-Age:</span><br></pre></td></tr></table></figure></blockquote><p><strong>（1）Access-Control-Allow-Methods</strong></p><p>This field is required. Its value is a comma-separated string indicating all methods supported by the server for cross-origin requests. Note that all supported methods are returned, not just the one requested by the browser. This is to avoid multiple “preflight” requests.</p><p><strong>（2）Access-Control-Allow-Headers</strong></p><p>The Access-Control-Request-Headers field is required if the browser request includes the Access-Control-Request-Headers field. It is also a comma-separated string indicating all header information fields supported by the server, not limited to the fields requested by the browser in the “preflight”.</p><p><strong>（3）Access-Control-Allow-Credentials</strong></p><p>This field has the same meaning as a simple request.</p><p><strong>（4）Access-Control-Max-Age</strong></p><p>This field is optional and specifies the valid period of this preflight request in seconds. In the above result, the valid period is 20 days (1728000 seconds), which allows the response to be cached for 1728000 seconds (ie 20 days). During this period, another preflight request does not need to be issued.</p><ol><li>Normal requests after the preflight request is successful.</li></ol><p>Once the server passes the “preflight” request, every normal CORS request from the browser in the future will have an’Origin ‘header information field like a simple request. The server’s response will also have an’Access-Control-Allow-Origin’ header information field.</p><p>The following is the normal CORS request of the browser after the “preflight” request.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT</span><br><span class="line"><span class="attribute">Origin</span>:</span><br><span class="line"><span class="attribute">Host</span>:</span><br><span class="line"><span class="attribute">X-Custom-Header</span>:</span><br><span class="line"><span class="attribute">Accept-Language</span>:</span><br><span class="line"><span class="attribute">Connection</span>:</span><br><span class="line">User-Agent:</span><br></pre></td></tr></table></figure></blockquote><p>The’Origin ‘field of the above header information is automatically added by the browser.</p><p>Below is the normal response from the server.</p><blockquote><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>:</span><br><span class="line">Content-Type:</span><br></pre></td></tr></table></figure></blockquote><p>In the above information, the’Access-Control-Allow-Origin ‘field must be included in each response.</p><h3 id="Nginx-reverse-proxy"><a href="#Nginx-reverse-proxy" class="headerlink" title="Nginx reverse proxy"></a>Nginx reverse proxy</h3><p>Think about it, if we still use the front-end domain name when we request, and then something helps us forward the request to the real back-end domain name, won’t cross-domain be avoided? At this time, Nginx appeared.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    #  listening on port 9099</span><br><span class="line">    listen 9099;</span><br><span class="line">    #  domain name is localhost</span><br><span class="line">    server_name localhost;</span><br><span class="line">    Everything that localhost:9099/api like this is forwarded to the real server level address http://localhost:9871 </span><br><span class="line">    location ^~ /api &#123;</span><br><span class="line">    proxy_pass http://localhost:9871;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Same-Origin-Policy-Thinking-Triggered-by-Retargeting-Request"><a href="#Same-Origin-Policy-Thinking-Triggered-by-Retargeting-Request" class="headerlink" title="Same-Origin Policy Thinking Triggered by Retargeting Request"></a>Same-Origin Policy Thinking Triggered by Retargeting Request</h2><p>Encountered such a situation today, the front end is written in vue, the home page of the routing guard will modify the current url to call the background of the express interface.</p><p>In the middle of the processing key in this interface, the authentication interface of passport-azure will be called, and this process can be executed smoothly.</p><p>However, if I find that the session expires in the middle key of ajax request processing, I will automatically help the user go to Azure again, but an error will be thrown at this time.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//middle key</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loginMiddleware</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&#x27;azuread-openidconnect&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">response</span>: res, <span class="comment">// required</span></span><br><span class="line">      <span class="attr">customState</span>: <span class="string">&#x27;my_state&#x27;</span>, <span class="comment">// optional. Provide a value if you want to provide custom state value.</span></span><br><span class="line">      <span class="attr">failureRedirect</span>: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  )(req, res, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//call by url</span></span><br><span class="line">app.<span class="title function_">route</span>(<span class="string">&#x27;/api/auth/user/login&#x27;</span>).<span class="title function_">get</span>(aadController.<span class="property">loginMiddleware</span>);</span><br><span class="line"><span class="comment">//ajax request  </span></span><br><span class="line">app.<span class="title function_">all</span>(<span class="string">&#x27;/api/*&#x27;</span>, aadController.<span class="property">ensureAuthenticatedWithSkipPath</span>);</span><br></pre></td></tr></table></figure><p>The above code can run normally in the first route, which is the way the url is called, but if it takes the second route, an error will be thrown.</p><p>Assuming my request is A, if the identity verification is passed, it will be executed normally. If it is not, I will automatically call the authentication request of passport-azure for the user, assuming it is B. At this time, the Console will report an error, saying that I Retargeting the request B from A cross-domain.</p><p>There are two issues involved here</p><ul><li><p>Why is request B sent by backend code restricted by the browser’s same origin policy.</p></li><li><p>Why is it said that my request B is from A Retargeting.</p></li><li>Why does B request cross-domain at this time, but I call this B through the url but not cross-domain.</li></ul><p>First of all, let’s talk about the answers to the first two questions. The first two questions can actually be explained together, because the req used in the whole passport is actually passed from the front end, so it has always been a request, but the passport is Retargeting this request. That’s it.</p><p>The second question is why the url will not be cross-domain, while ajax will. This problem can be understood in two ways. You can think that the browser’s same-origin policy has no restrictions on the url method, or you can think that calling a request directly through the url is in a domain from beginning to end, that is, the domain where your request is located, so there is no cross-domain.</p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>First of all, the main purpose of the same origin policy is to limit the random call of resources between different websites and ensure the security of the network. His identification relies on the origin field in the request header, and the origin field is determined when requesting a page. For example, if you are requesting a www.baidu.com, then the origin field of any request sent from this page is www.baidu.com. Baidu’s server detects that the origin field of these requests is the same as itself. If it is the same, it will not trigger cross-domain issues. Reject the request.</p><p>However, due to the same origin policy is too strict, when my backend is composed of many servers together, it is inevitable to encounter cross-domain problems, so you need some cross-domain way to make my backend servers can access each other.</p><h2 id="Security-Issues-of-Same-Origin-Policy"><a href="#Security-Issues-of-Same-Origin-Policy" class="headerlink" title="Security Issues of Same Origin Policy"></a>Security Issues of Same Origin Policy</h2><p>Assuming that there is mutual trust between A and B websites, if a hacker controls A through XSS, this time to request some resources of B as A, it will not be limited by the same-origin policy.</p><p>Reference article:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000015597029">https://segmentfault.com/a/1190000015597029</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.ruanyifeng.com/blog/2016/04/cors.html">http://www.ruanyifeng.com/blog/2016/04/cors.html</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/cd718394/" title="Thinking about Same Origin Strategy and Cross-domain Method">https://sunra.top/en/posts/cd718394/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/45898d51/" rel="prev" title="nginx understanding and cross-domain solution"><i class="fa fa-chevron-left"></i> nginx understanding and cross-domain solution</a></div><div class="post-nav-item"> <a href="/en/posts/a4ef0309/" rel="next" title="Spring Boot Annotations Simple Summary (Continuous Supplementation)">Spring Boot Annotations Simple Summary (Continuous Supplementation)<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/cd718394/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>