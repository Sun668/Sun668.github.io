<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="In the last blog we talked about the overall execution process of V8, and this time I will continue to summarize how V8 implements fast lookup of properties on objects. Note that this part of the cont"><meta property="og:type" content="article"><meta property="og:title" content="JavaScript Execution Mechanism (7) How to quickly find properties on objects"><meta property="og:url" content="https://sunra.top/en/posts/37711/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="In the last blog we talked about the overall execution process of V8, and this time I will continue to summarize how V8 implements fast lookup of properties on objects. Note that this part of the cont"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627345375/origin-of-ray/af2654db3d3a2e0b9a9eaa25e862cc75_cpbshg.jpg"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627345848/origin-of-ray/f12b4c6f6e631ce51d5b4f288dbfb13e_r3pqv1.jpg"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627346039/origin-of-ray/e8ce990dce53295a414ce79e38149917_geaimq.jpg"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075159_fidca2.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075332_bpvmeg.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075404_mnr0oh.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430731/origin-of-ray/205a2fa05c6aba57ade25f3a1df2bad7_rl8g2x.jpg"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430911/origin-of-ray/51f5034a7f80e4e5684d5a301178c2f8_w760bb.jpg"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627516476/origin-of-ray/0f49d225b1ed71aaccd3cca2d1226dd3_tol5ss.jpg"><meta property="article:published_time" content="2021-07-27T00:07:16.000Z"><meta property="article:modified_time" content="2024-06-26T23:33:43.592Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627345375/origin-of-ray/af2654db3d3a2e0b9a9eaa25e862cc75_cpbshg.jpg"><link rel="canonical" href="https://sunra.top/en/posts/37711/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/37711/","path":"posts/37711/","title":"JavaScript Execution Mechanism (7) How to quickly find properties on objects"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>JavaScript Execution Mechanism (7) How to quickly find properties on objects | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#fast-and-slow-attributes"><span class="nav-number">1.</span> <span class="nav-text">Fast and Slow Attributes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#general-and-sorting-properties"><span class="nav-number">1.1.</span> <span class="nav-text">General and sorting properties</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#speed-attribute"><span class="nav-number">1.2.</span> <span class="nav-text">Speed attribute</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#examples-illustrate"><span class="nav-number">1.3.</span> <span class="nav-text">Examples illustrate</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hidden-classes"><span class="nav-number">2.</span> <span class="nav-text">Hidden classes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#why-is-static-language-more-efficient"><span class="nav-number">2.1.</span> <span class="nav-text">Why is static language more efficient?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-a-hidden-class"><span class="nav-number">2.2.</span> <span class="nav-text">What is a hidden class</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rebuild-hidden-classes"><span class="nav-number">2.3.</span> <span class="nav-text">Rebuild hidden classes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#best-practices"><span class="nav-number">2.4.</span> <span class="nav-text">Best practices</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#internal-connection-cache"><span class="nav-number">3.</span> <span class="nav-text">Internal connection cache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-internal-connection-cache"><span class="nav-number">3.1.</span> <span class="nav-text">What is internal connection cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#polymorphism-and-metamorphism"><span class="nav-number">3.2.</span> <span class="nav-text">Polymorphism and metamorphism</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/37711/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="JavaScript Execution Mechanism (7) How to quickly find properties on objects | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> JavaScript Execution Mechanism (7) How to quickly find properties on objects</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-07-27 08:07:16" itemprop="dateCreated datePublished" datetime="2021-07-27T08:07:16+08:00">2021-07-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-06-27 07:33:43" itemprop="dateModified" datetime="2024-06-27T07:33:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/37711/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/37711/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>In the last blog we talked about the overall execution process of V8, and this time I will continue to summarize how V8 implements fast lookup of properties on objects.</p><p>Note that this part of the content is not a scope chain, nor a prototype chain. The scope chain is used to find objects, such as obj. The prototype chain is to go to its prototype if there is no attribute a on obj, and the topic of this article is how to quickly find a on obj.</p><span id="more"></span><h2 id="fast-and-slow-attributes"><a class="markdownIt-Anchor" href="#fast-and-slow-attributes"></a> Fast and Slow Attributes</h2><p>An object in JavaScript is a collection of group properties and values. From the perspective of the JavaScript language, a JavaScript object is like a dictionary, with a string as the key name, and any object can be used as a key value, which can be read and written by the key name.</p><p>However, when implementing object storage in V8, the dictionary storage method was not completely adopted, mainly due to performance considerations. Because dictionaries are non-linear data structures, query efficiency will be lower than linear data structures. In order to improve storage and search efficiency, V8 adopts a complex storage strategy.</p><h3 id="general-and-sorting-properties"><a class="markdownIt-Anchor" href="#general-and-sorting-properties"></a> General and sorting properties</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">100</span>] = <span class="string">&#x27;test-100&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">1</span>] = <span class="string">&#x27;test-1&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="string">&quot;B&quot;</span>] = <span class="string">&#x27;bar-B&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">50</span>] = <span class="string">&#x27;test-50&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">9</span>] =  <span class="string">&#x27;test-9&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">8</span>] = <span class="string">&#x27;test-8&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">3</span>] = <span class="string">&#x27;test-3&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="number">5</span>] = <span class="string">&#x27;test-5&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="string">&quot;A&quot;</span>] = <span class="string">&#x27;bar-A&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>[<span class="string">&quot;C&quot;</span>] = <span class="string">&#x27;bar-C&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="keyword">new</span> <span class="title class_">Foo</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(key <span class="keyword">in</span> bar)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`index:<span class="subst">$&#123;key&#125;</span>  value:<span class="subst">$&#123;bar[key]&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the above code, we use the constructor function Foo to create a bar object. In the constructor function, we set a lot of properties to the bar object, including numerical properties and string properties, and then we enumerate all the properties in the bar object. Properties, and print them one by one, the following is the result of executing this code:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">index:1  value:test-1</span><br><span class="line">index:3  value:test-3</span><br><span class="line">index:5  value:test-5</span><br><span class="line">index:8  value:test-8</span><br><span class="line">index:9  value:test-9</span><br><span class="line">index:50  value:test-50</span><br><span class="line">index:100  value:test-100</span><br><span class="line">index:B  value:bar-B</span><br><span class="line">index:A  value:bar-A</span><br><span class="line">index:C  value:bar-C</span><br></pre></td></tr></table></figure><p>Observing the printed data, we found that the printed attribute order is not the order we set. When we set the attributes, we set them out of order. For example, we set 100 first, and then set 1, but the output content is very regular. In general, it is reflected in the following two points:</p><ul><li><p>The set number properties are printed first, and they are printed in the order of number size;</p></li><li><p>The set string property is still printed in the previous setting order. For example, we set it in the order of B, A, and C, and it is still printed in this order.</p></li></ul><p>The reason for this result is that the ECMAScript specification defines that numeric properties should be sorted in ascending order according to the size of the index value, and string properties should be sorted in ascending order according to the order in which they were created. Here we refer to numeric properties in objects as sorted properties, elements in V8, string properties as regular properties, and properties ** in V8.</p><p>In V8, in order to effectively improve the performance of storing and accessing these two attributes, two linear data structures are used to save the sorted attributes and the general attributes respectively. The specific structures are shown in the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627345375/origin-of-ray/af2654db3d3a2e0b9a9eaa25e862cc75_cpbshg.jpg" alt></p><p>Through the above figure, we can find that the bar object contains two hidden properties: the elements property and the properties property. The elements property points to the elements object. In the elements object, the sorted properties are stored in order, and the properties property points to the properties object. In the properties object, the regular properties are saved in the order in which they were created.</p><p>After decomposing into these two linear data structures, if an indexing operation is performed, V8 will first read all the elements in order from the elements attribute, and then read all the elements in the properties attribute, thus completing an indexing operation.</p><h3 id="speed-attribute"><a class="markdownIt-Anchor" href="#speed-attribute"></a> Speed attribute</h3><p>Save different properties to the elements property and properties property respectively, which undoubtedly simplifies the complexity of the program, but when searching for elements, there is one more step, such as executing the statement bar. B to find the property value of B, then in V8 It will first find the object properties pointed to by the properties property, and then find the B property in the properties object. This method adds a step to the search process, so it will affect the search efficiency of the element.</p><p>For this reason, V8 has adopted a trade-off strategy to speed up the efficiency of finding properties. This strategy is to store some regular properties directly to the object itself, which we call in-object properties. You can see the following image for the representation of objects in memory:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627345848/origin-of-ray/f12b4c6f6e631ce51d5b4f288dbfb13e_r3pqv1.jpg" alt></p><p>After using the properties within the object, the regular properties are saved to the bar object itself, so that when using bar. B again to find the property value of B, V8 can directly obtain the value from the bar object itself. This method Reduce the steps of finding property values and increase search efficiency.</p><p>However, the number of properties in the object is fixed, 10 by default. If the added properties exceed the space allocated by the object, they will be saved in the regular property storage. Although the property storage has an extra layer of indirection, it can be expanded freely.</p><p>Usually, we call the properties saved in the linear data structure “fast properties”, because the properties can be accessed only through the index in the linear data structure. Although the speed of accessing the linear structure is fast, if a large number of properties are added or deleted from the linear structure, the execution efficiency will be very low, mainly because of the large amount of time and memory overhead.</p><p>Therefore, if an object has too many attributes, V8 will adopt another storage strategy, that is, the “slow attribute” strategy, but the slow attribute object will have an independent nonlinear data structure (dictionary) as the attribute storage container. All attribute meta-information is no longer stored linearly, but is directly stored in the attribute dictionary.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627346039/origin-of-ray/e8ce990dce53295a414ce79e38149917_geaimq.jpg" alt></p><h3 id="examples-illustrate"><a class="markdownIt-Anchor" href="#examples-illustrate"></a> Examples illustrate</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Foo</span>(<span class="params">property_num,element_num</span>) &#123;</span><br><span class="line">    <span class="comment">//Add indexable properties</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; element_num; i++) &#123;</span><br><span class="line">        <span class="variable language_">this</span>[i] = <span class="string">`element<span class="subst">$&#123;i&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Add general properties</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; property_num; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> ppt = <span class="string">`property<span class="subst">$&#123;i&#125;</span>`</span></span><br><span class="line">        <span class="variable language_">this</span>[ppt] = ppt</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="number">10</span>,<span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> bar2 = <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="number">20</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> bar3 = <span class="keyword">new</span> <span class="title class_">Foo</span>(<span class="number">100</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>We can run this code in the browser console and use the snapshot function of Memory to see the properties in these three objects.</p><p>First of all, you can see that all the sorted properties are in elements, while the regular properties are directly on the object, not on properties</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075159_fidca2.png" alt></p><p>Then the second one, with the properties property on the object, has 10 regular properties sorted by key inside.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075332_bpvmeg.png" alt></p><p>Finally, there is the third one. We can see that the properties in the properties at this time are already out of order, it is a map.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430095/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210728075404_mnr0oh.png" alt></p><h2 id="hidden-classes"><a class="markdownIt-Anchor" href="#hidden-classes"></a> Hidden classes</h2><p>In the last part, when talking about the speed attribute, there is another attribute in the snapshot of chrome, called map, also known as hidden class, what does this map do?</p><p>We know that JavaScript is a dynamic language, and its execution efficiency is lower than that of static languages. In order to improve the execution speed of JavaScript, V8 draws on many features of static languages, such as the implementation of the JIT mechanism, and the introduction of hidden objects in order to improve the property access speed of objects. Class, in order to speed up the operation and introduce the internal connection cache. Today we will focus on analyzing the hidden class in V8 to see how it improves the speed of accessing object property values.</p><h3 id="why-is-static-language-more-efficient"><a class="markdownIt-Anchor" href="#why-is-static-language-more-efficient"></a> Why is static language more efficient?</h3><p>Since hidden classes borrow some of the features of static languages, to explain this problem, let’s first analyze why static languages are more efficient than dynamic languages.</p><p>We through the following two pieces of code, to compare the dynamic language and static language at runtime some features, a dynamic language is JavaScript, another static language C++ source code, specific source code you can refer to the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430731/origin-of-ray/205a2fa05c6aba57ade25f3a1df2bad7_rl8g2x.jpg" alt></p><p>So at runtime, what is the difference between the execution process of these two pieces of code?</p><p>We know that the properties of objects can be modified at runtime in JavaScript, so when V8 uses an object, such as start.x, it does not know whether there is x in the object, nor does it know whether x is relative to x. What is the offset of the object, and it can be said that V8 does not know the specific shape of the object.</p><p>So, when you want to query the x property in the object start in JavaScript, V8 will query step by step according to the specific rules, which is very slow and time-consuming</p><p>This dynamic way of querying object properties is different from C++ static language. C++ the structure of an object needs to be defined before declaring it. We can also call it a shape. For example, the Point structure is a shape. We can use this shape to Define specific objects. C++ code needs to be compiled before execution. When compiling, the shape of each object is fixed, that is to say, the shape of Point cannot be changed during the execution of the code. So when accessing the property of an object in the C++, it is natural to know the offset value of the property relative to the address of the object. For example, when using start.x in the C++, the compiler will directly write the address of x relative to the start. In the assembly instruction, then when the x property in the object start is used, the CPU can directly go to the memory address to remove the content, without any intermediate search links. Because in static languages, the property values of objects can be queried directly through offset queries, which is one reason for the high execution efficiency of static languages.</p><h3 id="what-is-a-hidden-class"><a class="markdownIt-Anchor" href="#what-is-a-hidden-class"></a> What is a hidden class</h3><p>Since the query efficiency of static language is so high, can this static feature be introduced into V8?</p><p>The answer is feasible. One of the current ideas is to make objects in JavaScript static, that is, V8 will assume that objects in JavaScript are static during the running of JavaScript. Specifically, V8 makes the following two assumptions for each object:</p><ul><li><p>No new properties will be added after the object is created;</p></li><li><p>Attributes will not be deleted after the object is created.</p></li></ul><p>After meeting these two assumptions, V8 can do deep optimization of objects in JavaScript, so how to optimize it?</p><p>Specifically, V8 will create a hidden class for each object. The hidden class of the object records some basic layout information of the object, including the following two points:</p><ul><li>all properties contained in the object;</li></ul><p>The offset of each property relative to the object.</p><p>After having a hidden class, then when V8 accesses a property in an object, it will first go to the hidden class to find the offset of the property relative to its object. With the offset and property type, V8 You can directly go to memory to retrieve the property value without going through a series of search processes, which greatly improves the efficiency of finding objects in V8.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> point = &#123;<span class="attr">x</span>:<span class="number">100</span>,<span class="attr">y</span>:<span class="number">200</span>&#125;</span><br></pre></td></tr></table></figure><p>The hidden class describes the property layout of the object, which mainly includes the property name and the offset corresponding to each property. For example, the hidden class of the point object includes the x and y properties, the offset of x is 4, and the offset of y is 4. The offset is 8.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627430911/origin-of-ray/51f5034a7f80e4e5684d5a301178c2f8_w760bb.jpg" alt></p><p>After having the map, when you use point.x to access the x property again, V8 will query the offset of the x property in the map of the point relative to the point object, and then add the offset to the starting position of the point object to get the x The value of the property is located in the memory, and with this location, the value of x is obtained, so we save a more complicated search process.</p><p>Multiple objects share a hidden class Now we know that in V8, each object has a map property whose value points to the hidden class of the object.</p><p>However, if the shape of two objects is the same, V8 will be able to reuse the same hidden class for them, which has two advantages:</p><ul><li><p>Reduce the number of hidden classes created and indirectly speed up code execution;</p></li><li><p>Reduced storage space for hidden classes.</p></li></ul><p>So, when the shape of two objects is the same, the following two points must be met:</p><ul><li><p>the same property name;</p></li><li><p>Equal number of attributes.</p></li></ul><h3 id="rebuild-hidden-classes"><a class="markdownIt-Anchor" href="#rebuild-hidden-classes"></a> Rebuild hidden classes</h3><p>Regarding hidden classes, there is one more issue you need to pay attention to. At the beginning of this lesson, we mentioned that in order to implement hidden classes in V8, two assumptions are required:</p><ul><li><p>No new properties will be added after the object is created;</p></li><li><p>Attributes will not be deleted after the object is created.</p></li></ul><p>However, JavaScript is still a dynamic language. During execution, the shape of an object can be changed. If the shape of an object changes, the hidden class will also change, which means that V8 has to rebuild the newly changed object. Build a new hidden class, which is a big overhead for V8’s execution efficiency. It is commonly understood that adding new properties to an object, deleting new properties, or changing the data type of a property will change the shape of the object, which will inevitably trigger V8 to rebuild a new hidden class for the object after changing shape.</p><h3 id="best-practices"><a class="markdownIt-Anchor" href="#best-practices"></a> Best practices</h3><p>Okay, now we know that V8 will assign a hidden class to each object during execution.</p><p>If the shape of the object has not changed, then the object will always use the hidden class.</p><ul><li>If the shape of the object changes, V8 will rebuild a new hidden class for the object.</li></ul><p>We certainly hope that the hidden class in the object will not be changed casually, because this will trigger V8 to refactor the hidden class of the object, which directly affects the execution performance of the program. Then in actual work, we should try to pay attention to the following points:</p><ul><li><p>When initializing objects with literals, ensure that the order of properties is consistent</p></li><li><p>Try to use literals to initialize complete object properties at once</p></li><li><p>Try to avoid using the delete method</p></li></ul><h2 id="internal-connection-cache"><a class="markdownIt-Anchor" href="#internal-connection-cache"></a> Internal connection cache</h2><p>First look at a piece of code</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadX</span>(<span class="params">o</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span> o.<span class="property">x</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">x</span>: <span class="number">1</span>,<span class="attr">y</span>:<span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">var</span> o1 = &#123; <span class="attr">x</span>: <span class="number">3</span> ,<span class="attr">y</span>:<span class="number">6</span>&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">90000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">loadX</span>(o)</span><br><span class="line">    <span class="title function_">loadX</span>(o1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Usually the process of obtaining o.x in V8 is like this: find the hidden class of object o, then find the offset of x attribute through the hidden class, and then obtain the attribute value according to the offset. In this code, the loadX function will be executed repeatedly, so the process of obtaining o.x also needs to be executed repeatedly. Is there a way to simplify this search process again, it is best to find the attribute value of x in one step? The answer is, yes.</p><p>In fact, this is a question about internal connection caching. We can see that the function loadX is repeatedly executed many times in a for loop, so V8 will do everything possible to compress the search process to improve the efficiency of object search. The strategy to speed up the execution of this function is the internal connection cache (Inline Cache), referred to as IC.</p><h3 id="what-is-internal-connection-cache"><a class="markdownIt-Anchor" href="#what-is-internal-connection-cache"></a> What is internal connection cache</h3><p>To answer this question, we need to know the working principle of IC. In fact, the principle of IC is very simple, intuitively understood, that is, in the process of executing function in V8, it will observe the key intermediate data on some call points (CallSite) in function, and then cache these data. When the function is executed again, V8 can directly use these intermediate data, saving the process of obtaining these data again. Therefore, V8 can effectively improve the execution efficiency of some repetitive codes by using IC.</p><p>The IC maintains a FeedBack Vector for each function, which records some key intermediate data during the execution of the function. For the relationship between function and feedback vector, you can refer to the following figure:</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1627516476/origin-of-ray/0f49d225b1ed71aaccd3cca2d1226dd3_tol5ss.jpg" alt></p><p>The feedback vector is actually a table structure, which consists of many items, each of which is called a slot (Slot). V8 will write the intermediate data of the loadX function into the slot of the feedback vector in turn. For example, the following function:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadX</span>(<span class="params">o</span>) &#123; </span><br><span class="line"> o.<span class="property">y</span> = <span class="number">4</span></span><br><span class="line"> <span class="keyword">return</span> o.<span class="property">x</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When V8 executes this function, it will determine that o.y = 4 and return o.x are CallSites because they use objects and properties, then V8 will assign each call in the feedback vector of the loadX function. Point is assigned a slot. Each slot includes the slot index (slot index), the type of slot (type), the state of the slot (state), the address of the hidden class (map), and the offset of the attribute. For example, the above function Both call points use the object o, then the map attribute in the two slots of the feedback vector also points to the same hidden class, so the map address of the two slots is the same.</p><h3 id="polymorphism-and-metamorphism"><a class="markdownIt-Anchor" href="#polymorphism-and-metamorphism"></a> Polymorphism and metamorphism</h3><p>Well, by caching the basic information in the execution process, we can improve the efficiency of the next execution of the function, but there is a premise, that is, when executed multiple times, the shape of the object is fixed, if the shape of the object is not fixed, then how will V8 handle it? Let’s adjust the above loadX function code, the adjusted code is as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadX</span>(<span class="params">o</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span> o.<span class="property">x</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">x</span>: <span class="number">1</span>,<span class="attr">y</span>:<span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">var</span> o1 = &#123; <span class="attr">x</span>: <span class="number">3</span>, <span class="attr">y</span>:<span class="number">6</span>,<span class="attr">z</span>:<span class="number">4</span>&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">90000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">loadX</span>(o)</span><br><span class="line">    <span class="title function_">loadX</span>(o1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When loadX is executed for the first time, V8 will record the hidden class of o in the feedback vector and record the offset of the attribute x. Then when the loadX function is called again, V8 will take out the hidden class recorded in the feedback vector and compare it with the hidden class of the new o1 and find that it is not a hidden class, so V8 cannot use the offset recorded in the feedback vector at this time. amount information. Faced with this situation, V8 will choose to record the new hidden class in the feedback vector as well, and at the same time record the offset of the attribute value. At this time, the first slot in the feedback vector contains the two hidden classes and offset.</p><p>Now that we know that a slot in a feedback vector can contain information about multiple hidden classes, then:</p><p>If a slot contains only one hidden class, then we call this state monomorphic.</p><p>If a slot contains 2-4 hidden classes, we call this state polymorphic.</p><ul><li>If there are more than 4 hidden classes in a slot, we call this state a magamorphic.</li></ul><p>In general, we only need to remember one thing, which is that monomorphic performance is better than polymorphic and supermorphic, so we need to slightly avoid polymorphic and supermorphic situations.</p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/37711/" title="JavaScript Execution Mechanism (7) How to quickly find properties on objects">https://sunra.top/en/posts/37711/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/15903/" rel="prev" title="JavaScript Execution Mechanism (6) How V8 executes JavaScript code"><i class="fa fa-chevron-left"></i> JavaScript Execution Mechanism (6) How V8 executes JavaScript code</a></div><div class="post-nav-item"> <a href="/en/posts/29695/" rel="next" title="JavaScript Execution Mechanism (8) Garbage Collection Mechanism">JavaScript Execution Mechanism (8) Garbage Collection Mechanism<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/37711/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>