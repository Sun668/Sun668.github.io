<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="I have encountered a problem these days, that is, when the vue-router nests subroutes, if the deep router-view component does not declare a key, and the component in the route configuration is a funct"><meta property="og:type" content="article"><meta property="og:title" content="Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration"><meta property="og:url" content="https://sunra.top/en/posts/20273/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="I have encountered a problem these days, that is, when the vue-router nests subroutes, if the deep router-view component does not declare a key, and the component in the route configuration is a funct"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2022-12-10T02:07:58.000Z"><meta property="article:modified_time" content="2024-11-13T13:46:22.420Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/20273/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/20273/","path":"posts/20273/","title":"Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#simple-example"><span class="nav-number">1.</span> <span class="nav-text">Simple example</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#internal-type"><span class="nav-number">2.</span> <span class="nav-text">Internal type</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#installjs"><span class="nav-number">3.</span> <span class="nav-text">install.js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#routerjs"><span class="nav-number">4.</span> <span class="nav-text">router.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#constructor"><span class="nav-number">4.1.</span> <span class="nav-text">constructor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-number">4.2.</span> <span class="nav-text">init</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-matcherjs"><span class="nav-number">5.</span> <span class="nav-text">create-matcher.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create-route-mapjs"><span class="nav-number">5.1.</span> <span class="nav-text">create-route-map.js</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/20273/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-12-10 10:07:58" itemprop="dateCreated datePublished" datetime="2022-12-10T10:07:58+08:00">2022-12-10</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-11-13 21:46:22" itemprop="dateModified" datetime="2024-11-13T21:46:22+08:00">2024-11-13</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/20273/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/20273/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>I have encountered a problem these days, that is, when the vue-router nests subroutes, if the deep router-view component does not declare a key, and the component in the route configuration is a function-style component, it will cause the router.push to fail to update.</p><p>For function-based components and function-based programming, if you need it, remember my previous one.<a href="https://sunra.top/posts/9244/">相关博客</a>;</p><p>This article mainly analyzes the source code of vue-router. The source code of vue-router is mainly in two parts. The first part is to do route matching, and the second part is to do route jumping. This article mainly focuses on the first part</p><span id="more"></span><p>Let’s talk about it with version 3.6.5 of vue-router.</p><p>First, let’s take a look at the directory structure of src.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">The two components provided by vue-router, namely router-view and router-link</span><br><span class="line">│   ├── link.js</span><br><span class="line">│   └── view.js</span><br><span class="line">- Composables//I don&#x27;t need to care about this directory for now</span><br><span class="line">│   ├── globals.js</span><br><span class="line">│   ├── guards.js</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   ├── useLink.js</span><br><span class="line">│   └── utils.js</span><br><span class="line">🥰 ─ ─ Create-matcher.js//When initializing the route, create a matcher for subsequent route matching</span><br><span class="line">- create-route-map.js//Create route-map for matcher when initializing route</span><br><span class="line">- entries//package entry file</span><br><span class="line">│   ├── cjs.js</span><br><span class="line">│   └── esm.js</span><br><span class="line">Hui ─ ─ history//Routing handover implementation in different routing modes</span><br><span class="line">│ │ ─ ─ abstract.js//Routing switching in non-browser environment</span><br><span class="line">│ │ ─ ─ base.js//The base class for route switching</span><br><span class="line">│ │ ─ ─ hash.js//hash routing mode</span><br><span class="line">│ │ ─ ─ html5.js//HTML5 mode</span><br><span class="line">├── index.js</span><br><span class="line">The file called by install.js//Vue.use</span><br><span class="line">- router.js//Vue-router externally exposed api</span><br><span class="line">└── util</span><br><span class="line">    ├── async.js</span><br><span class="line">    ├── dom.js</span><br><span class="line">    ├── errors.js</span><br><span class="line">    ├── location.js</span><br><span class="line">    ├── misc.js</span><br><span class="line">    ├── params.js</span><br><span class="line">    ├── path.js</span><br><span class="line">    ├── push-state.js</span><br><span class="line">    ├── query.js</span><br><span class="line">    ├── resolve-components.js</span><br><span class="line">    ├── route.js</span><br><span class="line">    ├── scroll.js</span><br><span class="line">    ├── state-key.js</span><br><span class="line">    └── warn.js</span><br></pre></td></tr></table></figure><h2 id="simple-example"><a class="markdownIt-Anchor" href="#simple-example"></a> Simple example</h2><p>Our following code explanation gives this simple example.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0. If using the Modularization mechanism to program, import Vue and VueRouter, to call Vue.use (VueRouter)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//1. Define (route) components.</span></span><br><span class="line"><span class="title class_">Can</span> be imported <span class="keyword">from</span> other files</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Foo</span> = &#123; <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;foo&lt;/div&gt;&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Bar</span> = &#123; <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;bar&lt;/div&gt;&#x27;</span> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//2. Define routes</span></span><br><span class="line"><span class="comment">//Each route should map a component. Where &quot;component&quot; can be</span></span><br><span class="line"><span class="comment">//component constructor created by Vue.extend (),</span></span><br><span class="line"><span class="comment">//Or, just a component configuration object.</span></span><br><span class="line"><span class="title class_">We</span> will discuss nested routing later.</span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/foo&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Foo</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/bar&#x27;</span>, <span class="attr">component</span>: <span class="title class_">Bar</span> &#125;</span><br><span class="line">]</span><br><span class="line"> </span><br><span class="line"><span class="comment">//3. Create a router instance and pass the routes configuration</span></span><br><span class="line"><span class="comment">//You can also pass other configuration parameters, but let&#x27;s make it simple for now.</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">  <span class="title class_">Routes</span><span class="comment">//(abbreviation) Equivalent to routes: routes</span></span><br><span class="line">&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="title class_">Create</span> and mount the root instance.</span><br><span class="line"><span class="comment">//Remember to inject routes through router configuration parameters.</span></span><br><span class="line"><span class="comment">//so that the entire application has routing functions</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  router</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="internal-type"><a class="markdownIt-Anchor" href="#internal-type"></a> Internal type</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">var</span> <span class="attr">document</span>: <span class="title class_">Document</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">class</span> <span class="title class_">RouteRegExp</span> <span class="keyword">extends</span> <span class="title class_ inherited__">RegExp</span> &#123;</span><br><span class="line">  <span class="attr">keys</span>: <span class="title class_">Array</span>&lt;&#123; <span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">optional</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">PathToRegexpOptions</span> = &#123;</span><br><span class="line">  sensitive?: <span class="built_in">boolean</span>,</span><br><span class="line">  strict?: <span class="built_in">boolean</span>,</span><br><span class="line">  end?: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;path-to-regexp&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">declare</span> <span class="variable language_">module</span>.<span class="property">exports</span>: &#123;</span><br><span class="line">    (<span class="attr">path</span>: <span class="built_in">string</span>, keys?: <span class="title class_">Array</span>&lt;?&#123; <span class="attr">name</span>: <span class="built_in">string</span> &#125;&gt;, options?: <span class="title class_">PathToRegexpOptions</span>): <span class="title class_">RouteRegExp</span>;</span><br><span class="line">    <span class="attr">compile</span>: <span class="function">(<span class="params"><span class="attr">path</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="function">(<span class="params"><span class="attr">params</span>: <span class="title class_">Object</span></span>) =&gt;</span> <span class="built_in">string</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">Dictionary</span>&lt;T&gt; = &#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: T &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">NavigationGuard</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">to</span>: <span class="title class_">Route</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">from</span>: <span class="title class_">Route</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">next</span>: (to?: RawLocation | <span class="literal">false</span> | <span class="built_in">Function</span> | <span class="built_in">void</span>) =&gt; <span class="built_in">void</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">AfterNavigationHook</span> = <span class="function">(<span class="params"><span class="attr">to</span>: <span class="title class_">Route</span>, <span class="attr">from</span>: <span class="title class_">Route</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Position</span> = &#123; <span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span> &#125;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">PositionResult</span> = <span class="title class_">Position</span> | &#123; <span class="attr">selector</span>: <span class="built_in">string</span>, offset?: <span class="title class_">Position</span> &#125; | <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">RouterOptions</span> = &#123;</span><br><span class="line">  routes?: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;;</span><br><span class="line">  mode?: <span class="built_in">string</span>;</span><br><span class="line">  fallback?: <span class="built_in">boolean</span>;</span><br><span class="line">  base?: <span class="built_in">string</span>;</span><br><span class="line">  linkActiveClass?: <span class="built_in">string</span>;</span><br><span class="line">  linkExactActiveClass?: <span class="built_in">string</span>;</span><br><span class="line">  parseQuery?: <span class="function">(<span class="params"><span class="attr">query</span>: <span class="built_in">string</span></span>) =&gt;</span> <span class="title class_">Object</span>;</span><br><span class="line">  stringifyQuery?: <span class="function">(<span class="params"><span class="attr">query</span>: <span class="title class_">Object</span></span>) =&gt;</span> <span class="built_in">string</span>;</span><br><span class="line">  scrollBehavior?: <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">to</span>: <span class="title class_">Route</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">from</span>: <span class="title class_">Route</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">savedPosition</span>: ?<span class="title class_">Position</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> <span class="title class_">PositionResult</span> | <span class="title class_">Promise</span>&lt;<span class="title class_">PositionResult</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">RedirectOption</span> = <span class="title class_">RawLocation</span> | (<span class="function">(<span class="params"><span class="attr">to</span>: <span class="title class_">Route</span></span>) =&gt;</span> <span class="title class_">RawLocation</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">RouteConfig</span> = &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="built_in">string</span>;</span><br><span class="line">  name?: <span class="built_in">string</span>;</span><br><span class="line">  component?: <span class="built_in">any</span>;</span><br><span class="line">  components?: <span class="title class_">Dictionary</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  redirect?: <span class="title class_">RedirectOption</span>;</span><br><span class="line">  alias?: <span class="built_in">string</span> | <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  children?: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;;</span><br><span class="line">  beforeEnter?: <span class="title class_">NavigationGuard</span>;</span><br><span class="line">  meta?: <span class="built_in">any</span>;</span><br><span class="line">  props?: <span class="built_in">boolean</span> | <span class="title class_">Object</span> | <span class="title class_">Function</span>;</span><br><span class="line">  caseSensitive?: <span class="built_in">boolean</span>;</span><br><span class="line">  pathToRegexpOptions?: <span class="title class_">PathToRegexpOptions</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">RouteRecord</span> = &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">alias</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="attr">regex</span>: <span class="title class_">RouteRegExp</span>;</span><br><span class="line">  <span class="attr">components</span>: <span class="title class_">Dictionary</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="attr">instances</span>: <span class="title class_">Dictionary</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="attr">enteredCbs</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;&gt;;</span><br><span class="line">  <span class="attr">name</span>: ?<span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">parent</span>: ?<span class="title class_">RouteRecord</span>;</span><br><span class="line">  <span class="attr">redirect</span>: ?<span class="title class_">RedirectOption</span>;</span><br><span class="line">  <span class="attr">matchAs</span>: ?<span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">beforeEnter</span>: ?<span class="title class_">NavigationGuard</span>;</span><br><span class="line">  <span class="attr">meta</span>: <span class="built_in">any</span>;</span><br><span class="line">  <span class="attr">props</span>: <span class="built_in">boolean</span> | <span class="title class_">Object</span> | <span class="title class_">Function</span> | <span class="title class_">Dictionary</span>&lt;<span class="built_in">boolean</span> | <span class="title class_">Object</span> | <span class="title class_">Function</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">Location</span> = &#123;</span><br><span class="line">  _normalized?: <span class="built_in">boolean</span>;</span><br><span class="line">  name?: <span class="built_in">string</span>;</span><br><span class="line">  path?: <span class="built_in">string</span>;</span><br><span class="line">  hash?: <span class="built_in">string</span>;</span><br><span class="line">  query?: <span class="title class_">Dictionary</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  params?: <span class="title class_">Dictionary</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  append?: <span class="built_in">boolean</span>;</span><br><span class="line">  replace?: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">RawLocation</span> = <span class="built_in">string</span> | <span class="title class_">Location</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">type</span> <span class="title class_">Route</span> = &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">name</span>: ?<span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">query</span>: <span class="title class_">Dictionary</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="attr">params</span>: <span class="title class_">Dictionary</span>&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line">  <span class="attr">fullPath</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">matched</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;;</span><br><span class="line">  redirectedFrom?: <span class="built_in">string</span>;</span><br><span class="line">  meta?: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="installjs"><a class="markdownIt-Anchor" href="#installjs"></a> install.js</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">View</span> <span class="keyword">from</span> <span class="string">&#x27;./components/view&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Link</span> <span class="keyword">from</span> <span class="string">&#x27;./components/link&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> _Vue</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">install</span> (<span class="params">Vue</span>) &#123;</span><br><span class="line">	<span class="title class_">Prevent</span> repeated installation</span><br><span class="line">  <span class="keyword">if</span> (install.<span class="property">installed</span> &amp;&amp; _Vue = <span class="title class_">Vue</span>) <span class="keyword">return</span></span><br><span class="line">  install.<span class="property">installed</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="title class_">Save</span> the <span class="title class_">Vue</span> instance and <span class="keyword">export</span> it <span class="keyword">for</span> internal use</span><br><span class="line">  _Vue = <span class="title class_">Vue</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isDef</span> = v =&gt; v ! <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">registerInstance</span> = (<span class="params">vm, callVal</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> i = vm.<span class="property">$options</span>.<span class="property">_parentVnode</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">data</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">registerRouteInstance</span>)) &#123;</span><br><span class="line">      <span class="title function_">i</span>(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Global mix configuration, add hook function for each vue component</span></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">mixin</span>(&#123;</span><br><span class="line">    <span class="title function_">beforeCreate</span> () &#123;</span><br><span class="line">			<span class="comment">//If the router parameter is defined by itself, it will only appear in the case of the component, because the parameter we passed in when new Vue was mounted to #app</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(<span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span>)) &#123;</span><br><span class="line">				<span class="comment">//_routerRoot point to the root component</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_routerRoot</span> = <span class="variable language_">this</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span> = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">router</span></span><br><span class="line">				<span class="comment">//Defined in router.js, see the analysis later</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_router</span>.<span class="title function_">init</span>(<span class="variable language_">this</span>)</span><br><span class="line">				<span class="comment">//When entering here, this is the root vue instance, and this._route points to _router history.current</span></span><br><span class="line">        <span class="title class_">Vue</span>.<span class="property">util</span>.<span class="title function_">defineReactive</span>(<span class="variable language_">this</span>, <span class="string">&#x27;_route&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_router</span>.<span class="property">history</span>.<span class="property">current</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//Enter here to explain that it is not the root Vue component, then the _routerRoot of the subcomponent is the _routerRoot on the subcomponent</span></span><br><span class="line">				<span class="comment">//There is no need for recursion to look up here because the construction of the Vue component tree is top-down, so you only need to look up one layer</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_routerRoot</span> = (<span class="variable language_">this</span>.<span class="property">$parent</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">$parent</span>.<span class="property">_routerRoot</span>) || <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">destroyed</span> () &#123;</span><br><span class="line">      <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//_routerRoot point to the root Vue instance, this._routerRoot _router point to the vue-router instance passed in when new Vue</span></span><br><span class="line">	<span class="comment">//So this. $router in each Vue component will find Vue.prototype. $router through the prototype chain, and will find the vue-router instance passed in when new Vue</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$router&#x27;</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span> () &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_routerRoot</span>.<span class="property">_router</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//_routerRoot point to the root Vue instance, then this._routerRoot _route points to _router history.current</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;$route&#x27;</span>, &#123;</span><br><span class="line">    <span class="title function_">get</span> () &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_routerRoot</span>.<span class="property">_route</span> &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;RouterView&#x27;</span>, <span class="title class_">View</span>)</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;RouterLink&#x27;</span>, <span class="title class_">Link</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> strats = <span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">optionMergeStrategies</span></span><br><span class="line">  <span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">  strats.<span class="property">beforeRouteEnter</span> = strats.<span class="property">beforeRouteLeave</span> = strats.<span class="property">beforeRouteUpdate</span> = strats.<span class="property">created</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="routerjs"><a class="markdownIt-Anchor" href="#routerjs"></a> router.js</h2><p>Above we mounted VueRouter through install.js. Let’s take a look at what this VueRouter is.</p><p>This VueRouter is imported via index.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;./entries/cjs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">VueRouter</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>‘./entries/cj’ reads as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;../router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">VueRouter</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Then there is the content of router.js:</p><h3 id="constructor"><a class="markdownIt-Anchor" href="#constructor"></a> constructor</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span> (<span class="params"><span class="attr">options</span>: <span class="title class_">RouterOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">		<span class="title function_">warn</span>(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">VueRouter</span>, <span class="string">`Router must be called with the new operator.`</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">app</span> = <span class="literal">null</span></span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">apps</span> = []</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">beforeHooks</span> = []</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">resolveHooks</span> = []</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">afterHooks</span> = []</span><br><span class="line">	<span class="comment">//This is very important. The matcher constructs a route matcher based on the routes passed in when we new Router. We will talk about it later</span></span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">matcher</span> = <span class="title function_">createMatcher</span>(options.<span class="property">routes</span> || [], <span class="variable language_">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">//The mode passed in, the default is hash, the mode</span></span><br><span class="line">	<span class="keyword">let</span> mode = options.<span class="property">mode</span> || <span class="string">&#x27;hash&#x27;</span></span><br><span class="line">	<span class="comment">//supportsPushState indicates whether the current router supports the pushstate method, and only when it is supported can the history api be used.</span></span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">fallback</span> =</span><br><span class="line">		mode = <span class="string">&#x27;history&#x27;</span> &amp;&amp; !supportsPushState &amp;&amp; options.<span class="property">fallback</span> ! <span class="literal">false</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">fallback</span>) &#123;</span><br><span class="line">		mode = <span class="string">&#x27;hash&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!inBrowser) &#123;</span><br><span class="line">		mode = <span class="string">&#x27;abstract&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">mode</span> = mode</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Take different routing history according to different modes</span></span><br><span class="line">	<span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;history&#x27;</span>:</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">HTML5History</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">HashHistory</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>, <span class="variable language_">this</span>.<span class="property">fallback</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;abstract&#x27;</span>:</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">history</span> = <span class="keyword">new</span> <span class="title class_">AbstractHistory</span>(<span class="variable language_">this</span>, options.<span class="property">base</span>)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="attr">default</span>:</span><br><span class="line">			<span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">				<span class="title function_">assert</span>(<span class="literal">false</span>, <span class="string">`invalid mode: <span class="subst">$&#123;mode&#125;</span>`</span>)</span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="init"><a class="markdownIt-Anchor" href="#init"></a> init</h3><p>This function is actually the init method called in install.js</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">init</span> (<span class="attr">app</span>: <span class="built_in">any</span> <span class="comment">/* Vue component instance */</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      <span class="title function_">assert</span>(</span><br><span class="line">        install.<span class="property">installed</span>,</span><br><span class="line">        <span class="string">`not installed. Make sure to call \`Vue.use(VueRouter)\` `</span> +</span><br><span class="line">          <span class="string">`before creating root instance.`</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">		<span class="comment">//vue-router actually supports multi-instance mode, but it is generally not used</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">push</span>(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set up app destroyed handler</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-router/issues/2639</span></span><br><span class="line">    app.$once(<span class="string">&#x27;hook:destroyed&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// clean out app from this.apps array once destroyed</span></span><br><span class="line">      <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">indexOf</span>(app)</span><br><span class="line">      <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">splice</span>(index, <span class="number">1</span>)</span><br><span class="line">      <span class="comment">// ensure we still have a main app or null if no apps</span></span><br><span class="line">      <span class="comment">// we do not release the router so it can be reused</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">app</span> = app) <span class="variable language_">this</span>.<span class="property">app</span> = <span class="variable language_">this</span>.<span class="property">apps</span>[<span class="number">0</span>] || <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">app</span>) <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">teardown</span>()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main app previously initialized</span></span><br><span class="line">    <span class="comment">// return as we don&#x27;t need to set up new history listener</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">app</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">app</span> = app</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> history = <span class="variable language_">this</span>.<span class="property">history</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//If it is HTML5History or HashHistory, call setupListeners of both</span></span><br><span class="line">    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> <span class="title class_">HTML5History</span> || history <span class="keyword">instanceof</span> <span class="title class_">HashHistory</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">handleInitialScroll</span> = routeOrError =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">from</span> = history.<span class="property">current</span></span><br><span class="line">        <span class="keyword">const</span> expectScroll = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">scrollBehavior</span></span><br><span class="line">        <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (supportsScroll &amp;&amp; <span class="string">&#x27;fullPath&#x27;</span> <span class="keyword">in</span> routeOrError) &#123;</span><br><span class="line">          <span class="title function_">handleScroll</span>(<span class="variable language_">this</span>, routeOrError, <span class="keyword">from</span>, <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">setupListeners</span> = routeOrError =&gt; &#123;</span><br><span class="line">        history.<span class="title function_">setupListeners</span>()</span><br><span class="line">        <span class="title function_">handleInitialScroll</span>(routeOrError)</span><br><span class="line">      &#125;</span><br><span class="line">      history.<span class="title function_">transitionTo</span>(</span><br><span class="line">        history.<span class="title function_">getCurrentLocation</span>(),</span><br><span class="line">        setupListeners,</span><br><span class="line">        setupListeners</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    history.<span class="title function_">listen</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">apps</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">        app.<span class="property">_route</span> = route</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="create-matcherjs"><a class="markdownIt-Anchor" href="#create-matcherjs"></a> create-matcher.js</h2><p>This function returns a Matcher with the following type declaration:</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Matcher</span> = &#123;</span><br><span class="line">  <span class="attr">match</span>: <span class="function">(<span class="params"><span class="attr">raw</span>: <span class="title class_">RawLocation</span>, current?: <span class="title class_">Route</span>, redirectedFrom?: <span class="title class_">Location</span></span>) =&gt;</span> <span class="title class_">Route</span>;</span><br><span class="line">  <span class="attr">addRoutes</span>: <span class="function">(<span class="params"><span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">addRoute</span>: <span class="function">(<span class="params"><span class="attr">parentNameOrRoute</span>: <span class="built_in">string</span> | <span class="title class_">RouteConfig</span>, route?: <span class="title class_">RouteConfig</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  <span class="attr">getRoutes</span>: <span class="function">() =&gt;</span> <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The first line of code: 'const {pathList, pathMap, nameMap} = createRouteMap (routes) ’</p><h3 id="create-route-mapjs"><a class="markdownIt-Anchor" href="#create-route-mapjs"></a> create-route-map.js</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRouteMap</span> (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;,</span></span><br><span class="line"><span class="params">  oldPathList?: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;,</span></span><br><span class="line"><span class="params">  oldPathMap?: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span></span><br><span class="line"><span class="params">  oldNameMap?: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span></span><br><span class="line"><span class="params">  parentRoute?: <span class="title class_">RouteRecord</span></span></span><br><span class="line"><span class="params"></span>): &#123;</span><br><span class="line">  <span class="attr">pathList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;,</span><br><span class="line">  <span class="attr">pathMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">nameMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="comment">// the path list is used to control path matching priority</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">pathList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt; = oldPathList || []</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">pathMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt; = oldPathMap || <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">nameMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt; = oldNameMap || <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//traverse the incoming routes, here only need to traverse the first layer because addRouteRecord itself will perform recursion</span></span><br><span class="line">	<span class="comment">//This code is a multi-source DFS traversal route configuration, and then generate a record for each route configuration, stored in pathList, pathMap, nameMap</span></span><br><span class="line">  routes.<span class="title function_">forEach</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">addRouteRecord</span>(pathList, pathMap, nameMap, route, parentRoute)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//put the route of * at the end</span></span><br><span class="line">  <span class="comment">// ensure wildcard routes are always at the end</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = pathList.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pathList[i] = <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">      pathList.<span class="title function_">push</span>(pathList.<span class="title function_">splice</span>(i, <span class="number">1</span>)[<span class="number">0</span>])</span><br><span class="line">      l--</span><br><span class="line">      i--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> = <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// warn if routes do not include leading slashes</span></span><br><span class="line">    <span class="keyword">const</span> found = pathList</span><br><span class="line">    <span class="comment">// check for missing leading slash</span></span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">path</span> =&gt;</span> path &amp;&amp; path.<span class="title function_">charAt</span>(<span class="number">0</span>) ! <span class="string">&#x27;*&#x27;</span> &amp;&amp; path.<span class="title function_">charAt</span>(<span class="number">0</span>) ! <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> pathNames = found.<span class="title function_">map</span>(<span class="function"><span class="params">path</span> =&gt;</span> <span class="string">`- <span class="subst">$&#123;path&#125;</span>`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="title function_">warn</span>(<span class="literal">false</span>, <span class="string">`Non-nested routes must include a leading slash character. Fix the following routes: \n<span class="subst">$&#123;pathNames&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    pathList,</span><br><span class="line">    pathMap,</span><br><span class="line">    nameMap</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addRouteRecord</span> (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">pathList</span>: <span class="title class_">Array</span>&lt;<span class="built_in">string</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">pathMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">nameMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="attr">route</span>: <span class="title class_">RouteConfig</span>,</span></span><br><span class="line"><span class="params">  parent?: <span class="title class_">RouteRecord</span>,</span></span><br><span class="line"><span class="params">  matchAs?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; path, name &#125; = route</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">assert</span>(path != <span class="literal">null</span>, <span class="string">`&quot;path&quot; is required in a route configuration.`</span>)</span><br><span class="line">    <span class="title function_">assert</span>(</span><br><span class="line">      <span class="keyword">typeof</span> route.<span class="property">component</span> ! <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">      <span class="string">`route config &quot;component&quot; for path: <span class="subst">$&#123;<span class="built_in">String</span>(</span></span></span><br><span class="line"><span class="subst"><span class="string">        path || name</span></span></span><br><span class="line"><span class="subst"><span class="string">      )&#125;</span> cannot be a `</span> + <span class="string">`string id. Use an actual component instead.`</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="title function_">warn</span>(</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-control-regex</span></span><br><span class="line">      !<span class="regexp">/[^\u0000-\u007F]+/</span>.<span class="title function_">test</span>(path),</span><br><span class="line">      <span class="string">`Route with path &quot;<span class="subst">$&#123;path&#125;</span>&quot; contains unencoded characters, make sure `</span> +</span><br><span class="line">        <span class="string">`your path is correctly encoded before passing it to the router. Use `</span> +</span><br><span class="line">        <span class="string">`encodeURI to encode static segments of your path.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//The above content is mainly parameter detection, you can ignore it.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">pathToRegexpOptions</span>: <span class="title class_">PathToRegexpOptions</span> =</span><br><span class="line">    route.<span class="property">pathToRegexpOptions</span> || &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//format the path and concatenate the path of the child route with its parent route, such as/foo and/bar</span></span><br><span class="line">  <span class="keyword">const</span> normalizedPath = <span class="title function_">normalizePath</span>(path, parent, pathToRegexpOptions.<span class="property">strict</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route.<span class="property">caseSensitive</span> = <span class="string">&#x27;boolean&#x27;</span>) &#123;</span><br><span class="line">    pathToRegexpOptions.<span class="property">sensitive</span> = route.<span class="property">caseSensitive</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">record</span>: <span class="title class_">RouteRecord</span> = &#123;</span><br><span class="line">    <span class="attr">path</span>: normalizedPath,</span><br><span class="line">    <span class="attr">regex</span>: <span class="title function_">compileRouteRegex</span>(normalizedPath, pathToRegexpOptions),</span><br><span class="line">    <span class="attr">components</span>: route.<span class="property">components</span> || &#123; <span class="attr">default</span>: route.<span class="property">component</span> &#125;,</span><br><span class="line">    <span class="attr">alias</span>: route.<span class="property">alias</span></span><br><span class="line">      ? <span class="keyword">typeof</span> route.<span class="property">alias</span> = <span class="string">&#x27;string&#x27;</span></span><br><span class="line">        ? [route.<span class="property">alias</span>]</span><br><span class="line">        : route.<span class="property">alias</span></span><br><span class="line">      : [],</span><br><span class="line">    <span class="attr">instances</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">enteredCbs</span>: &#123;&#125;,</span><br><span class="line">    name,</span><br><span class="line">    parent,</span><br><span class="line">    matchAs,</span><br><span class="line">    <span class="attr">redirect</span>: route.<span class="property">redirect</span>,</span><br><span class="line">    <span class="attr">beforeEnter</span>: route.<span class="property">beforeEnter</span>,</span><br><span class="line">    <span class="attr">meta</span>: route.<span class="property">meta</span> || &#123;&#125;,</span><br><span class="line">    <span class="attr">props</span>:</span><br><span class="line">      route.<span class="property">props</span>  <span class="literal">null</span></span><br><span class="line">        ? &#123;&#125;</span><br><span class="line">        : route.<span class="property">components</span></span><br><span class="line">          ? route.<span class="property">props</span></span><br><span class="line">          : &#123; <span class="attr">default</span>: route.<span class="property">props</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//if there are children nested routes, recursion calls itself</span></span><br><span class="line">  <span class="keyword">if</span> (route.<span class="property">children</span>) &#123;</span><br><span class="line">    <span class="comment">// Warn if route is named, does not redirect and has a default child route.</span></span><br><span class="line">    <span class="comment">// If users navigate to this route by name, the default child will</span></span><br><span class="line">    <span class="comment">// not be rendered (GH Issue #629)</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        route.<span class="property">name</span> &amp;&amp;</span><br><span class="line">        !route.<span class="property">redirect</span> &amp;&amp;</span><br><span class="line">        route.<span class="property">children</span>.<span class="title function_">some</span>(<span class="function"><span class="params">child</span> =&gt;</span> <span class="regexp">/^\/?$/</span>.<span class="title function_">test</span>(child.<span class="property">path</span>))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">`Named Route &#x27;<span class="subst">$&#123;route.name&#125;</span>&#x27; has a default child route. `</span> +</span><br><span class="line">            <span class="string">`When navigating to this named route (:to=&quot;&#123;name: &#x27;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">              route.name</span></span></span><br><span class="line"><span class="subst"><span class="string">            &#125;</span>&#x27;&#125;&quot;), `</span> +</span><br><span class="line">            <span class="string">`the default child route will not be rendered. Remove the name from `</span> +</span><br><span class="line">            <span class="string">`this route and use the name of the default child route for named `</span> +</span><br><span class="line">            <span class="string">`links instead.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    route.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> childMatchAs = matchAs</span><br><span class="line">        ? <span class="title function_">cleanPath</span>(<span class="string">`<span class="subst">$&#123;matchAs&#125;</span>/<span class="subst">$&#123;child.path&#125;</span>`</span>)</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line">      <span class="title function_">addRouteRecord</span>(pathList, pathMap, nameMap, child, record, childMatchAs)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Store the calculated record in pathList and pathMap</span></span><br><span class="line">  <span class="keyword">if</span> (!pathMap[record.<span class="property">path</span>]) &#123;</span><br><span class="line">    pathList.<span class="title function_">push</span>(record.<span class="property">path</span>)</span><br><span class="line">    pathMap[record.<span class="property">path</span>] = record</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (route.<span class="property">alias</span> ! <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> aliases = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(route.<span class="property">alias</span>) ? route.<span class="property">alias</span> : [route.<span class="property">alias</span>]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; aliases.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">      <span class="keyword">const</span> alias = aliases[i]</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; alias = path) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">`Found an alias with the same value as the path: &quot;<span class="subst">$&#123;path&#125;</span>&quot;. You have to remove that alias. It will be ignored in development.`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment">// skip in dev to make it work</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> aliasRoute = &#123;</span><br><span class="line">        <span class="attr">path</span>: alias,</span><br><span class="line">        <span class="attr">children</span>: route.<span class="property">children</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">addRouteRecord</span>(</span><br><span class="line">        pathList,</span><br><span class="line">        pathMap,</span><br><span class="line">        nameMap,</span><br><span class="line">        aliasRoute,</span><br><span class="line">        parent,</span><br><span class="line">        record.<span class="property">path</span> || <span class="string">&#x27;/&#x27;</span> <span class="comment">// matchAs</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//If there is a name attribute in the route configuration, add a mapping of name and routeConfig</span></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!nameMap[name]) &#123;</span><br><span class="line">      nameMap[name] = record</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; !matchAs) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        <span class="string">`Duplicate named routes definition: `</span> +</span><br><span class="line">          <span class="string">`&#123; name: &quot;<span class="subst">$&#123;name&#125;</span>&quot;, path: &quot;<span class="subst">$&#123;record.path&#125;</span>&quot; &#125;`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/20273/" title="Vue Router Source Code Analysis (1) Generation of Internal Routing Configuration">https://sunra.top/en/posts/20273/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/9244/" rel="prev" title="function components and function programming"><i class="fa fa-chevron-left"></i> function components and function programming</a></div><div class="post-nav-item"> <a href="/en/posts/37273/" rel="next" title="Vue Router Source Code Parsing (2) Jump of Internal Router">Vue Router Source Code Parsing (2) Jump of Internal Router<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/20273/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>