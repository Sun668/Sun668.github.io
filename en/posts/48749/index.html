<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Recently, I have been developing an SDK for Unity character images. The goal is that the SDK can dynamically download the latest models of characters and clothing without having to be built into the S"><meta property="og:type" content="article"><meta property="og:title" content="Use and source code analysis of TriLib remote loading FBX under Unity"><meta property="og:url" content="https://sunra.top/en/posts/48749/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Recently, I have been developing an SDK for Unity character images. The goal is that the SDK can dynamically download the latest models of characters and clothing without having to be built into the S"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png"><meta property="article:published_time" content="2022-06-02T22:31:34.000Z"><meta property="article:modified_time" content="2023-09-25T13:21:34.468Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png"><link rel="canonical" href="https://sunra.top/en/posts/48749/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/48749/","path":"posts/48749/","title":"Use and source code analysis of TriLib remote loading FBX under Unity"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Use and source code analysis of TriLib remote loading FBX under Unity | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Usage"><span class="nav-number">1.</span> <span class="nav-text">Usage</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-attention"><span class="nav-number">2.</span> <span class="nav-text">Use attention</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unable-to-find-the-corresponding-MaterailMapper-v2-0-6"><span class="nav-number">2.1.</span> <span class="nav-text">Unable to find the corresponding MaterailMapper (v2.0.6)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#The-material-is-wrong-and-there-is-one-more-material-v2-0-6"><span class="nav-number">2.2.</span> <span class="nav-text">The material is wrong, and there is one more material (v2.0.6)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateDefaultLoaderOptions"><span class="nav-number">2.2.1.</span> <span class="nav-text">CreateDefaultLoaderOptions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateWebRequest-modelUrl"><span class="nav-number">2.2.2.</span> <span class="nav-text">CreateWebRequest(modelUrl);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LoadModelFromUri"><span class="nav-number">2.2.3.</span> <span class="nav-text">LoadModelFromUri</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Summary-and-solution"><span class="nav-number">2.2.4.</span> <span class="nav-text">Summary and solution</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loadFbxFromZipFile%E4%B8%A2%E5%A4%B1%E8%B4%B4%E5%9B%BE%EF%BC%88v2-1-6%EF%BC%89"><span class="nav-number">2.3.</span> <span class="nav-text">loadFbxFromZipFile丢失贴图（v2.1.6）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IsReadable-for-textures-is-false-v2-1-6"><span class="nav-number">2.4.</span> <span class="nav-text">IsReadable for textures is false (v2.1.6)</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/48749/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Use and source code analysis of TriLib remote loading FBX under Unity | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Use and source code analysis of TriLib remote loading FBX under Unity</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-06-03 06:31:34" itemprop="dateCreated datePublished" datetime="2022-06-03T06:31:34+08:00">2022-06-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-09-25 21:21:34" itemprop="dateModified" datetime="2023-09-25T21:21:34+08:00">2023-09-25</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/48749/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/48749/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Recently, I have been developing an SDK for Unity character images. The goal is that the SDK can dynamically download the latest models of characters and clothing without having to be built into the SDK in advance.</p><p>At the beginning, the solution I plan to use is the traditional and mature Addressables way to package bundles, but the division of bundles is a problem, and this method needs to import the model into unity every time, then release the package, and then update the catalog. The whole process is relatively tedious.</p><p>So I was wondering if I could load FBX and textures directly from remote, and then load them directly using FBX, so that the whole release process would be much simpler.</p><p>After some searching, he found the TriLib repository, which was very convenient for him to load models remotely. However, there were also some problems. In order to locate these problems, I specially read the source code.</p><span id="more"></span><h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>In fact, the usage of TriLib is very simple. It does not have the ability to open many configurations in total. After you import it, it is very clear to take a look at its example, but it is still simply displayed here</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> TriLibCore.General;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TriLibCore.Samples</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Represents a sample that loads a compressed (Zipped) Model.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LoadModelFromURLSample</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> modelUrl;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Creates the AssetLoaderOptions instance, configures the Web Request, and downloads the Model.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> You can create the AssetLoaderOptions by right clicking on the Assets Explorer and selecting &quot;TriLib-&gt;Create-&gt;AssetLoaderOptions-&gt;Pre-Built AssetLoaderOptions&quot;.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assetLoaderOptions = AssetLoader.CreateDefaultLoaderOptions();</span><br><span class="line">            <span class="keyword">var</span> webRequest = AssetDownloader.CreateWebRequest(modelUrl);</span><br><span class="line">            AssetDownloader.LoadModelFromUri(webRequest, OnLoad, OnMaterialsLoad, OnProgress, OnError, <span class="literal">null</span>, assetLoaderOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when any error occurs.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;obj&quot;&gt;</span>The contextualized error, containing the original exception and the context passed to the method where the error was thrown.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnError</span>(<span class="params">IContextualizedError obj</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogError(<span class="string">$&quot;An error ocurred while loading your Model: <span class="subst">&#123;obj.GetInnerException()&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model loading progress changes.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;progress&quot;&gt;</span>The loading progress.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnProgress</span>(<span class="params">AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">$&quot;Loading Model. Progress: <span class="subst">&#123;progress:P&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model (including Textures and Materials) has been fully loaded, or after any error occurs.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span>The loaded GameObject is available on the assetLoaderContext.RootGameObject field.<span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnMaterialsLoad</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Materials loaded. Model fully loaded.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Called when the Model Meshes and hierarchy are loaded.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span>The loaded GameObject is available on the assetLoaderContext.RootGameObject field.<span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assetLoaderContext&quot;&gt;</span>The context used to load the Model.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnLoad</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(<span class="string">&quot;Model loaded. Loading materials.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code is very simple. It should be noted that the content downloaded from the corresponding download link needs to be a zip file, which contains the model and the materials, textures, etc. referenced by the model.</p><h2 id="Use-attention"><a href="#Use-attention" class="headerlink" title="Use attention"></a>Use attention</h2><p>Does the above code look simple, but you may find it useless? I encountered two problems</p><h3 id="Unable-to-find-the-corresponding-MaterailMapper-v2-0-6"><a href="#Unable-to-find-the-corresponding-MaterailMapper-v2-0-6" class="headerlink" title="Unable to find the corresponding MaterailMapper (v2.0.6)"></a>Unable to find the corresponding MaterailMapper (v2.0.6)</h3><p>If there is a waring in your console, which probably means that MaterialMapper cannot be found, don’t ignore this error, because if you can’t find this thing, the result is that the model cannot be loaded correctly.</p><p>I have this problem because my project is part of the URP rendering pipeline.</p><p>Then the code will determine whether you are a normal rendering pipeline, URP or HDRP, and then find a suitable Material to render the model based on this.</p><p>The judgment logic of the URP is as follows:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsCompatible</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> GraphicsSettingsUtils.IsUsingUniversalPipeline;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> IsUsingUniversalPipeline =&gt; GraphicsSettings.renderPipelineAsset != <span class="literal">null</span> &amp;&amp; GraphicsSettings.renderPipelineAsset.name.StartsWith(<span class="string">&quot;UniversalRP&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>So this thing is judged to be successful. The file name used by the URP Settings you configured must be “UniversalRP”, and the URP generated by default is called “UniversalRenderPipeline”, and then he can’t recognize it, so he can’t add materials to your FBX</p><h3 id="The-material-is-wrong-and-there-is-one-more-material-v2-0-6"><a href="#The-material-is-wrong-and-there-is-one-more-material-v2-0-6" class="headerlink" title="The material is wrong, and there is one more material (v2.0.6)"></a>The material is wrong, and there is one more material (v2.0.6)</h3><p>So far, the author still encountered a problem, that is, in addition to the name of the material, the other is wrong, not only the property is wrong, but also one more material. For this reason, the author specially studied the source code and found that this thing is intentional.</p><p>Let me first explain why this is:</p><h4 id="CreateDefaultLoaderOptions"><a href="#CreateDefaultLoaderOptions" class="headerlink" title="CreateDefaultLoaderOptions"></a>CreateDefaultLoaderOptions</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderOptions <span class="title">CreateDefaultLoaderOptions</span>(<span class="params"><span class="built_in">bool</span> generateAssets = <span class="literal">false</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> assetLoaderOptions = ScriptableObject.CreateInstance&lt;AssetLoaderOptions&gt;();</span><br><span class="line">    ByNameRootBoneMapper byNameRootBoneMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="keyword">if</span> (generateAssets) &#123;</span><br><span class="line">        byNameRootBoneMapper = (ByNameRootBoneMapper)LoadOrCreateScriptableObject(<span class="string">&quot;ByNameRootBoneMapper&quot;</span>, <span class="string">&quot;RootBone&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        byNameRootBoneMapper = ScriptableObject.CreateInstance&lt;ByNameRootBoneMapper&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">    byNameRootBoneMapper = ScriptableObject.CreateInstance&lt;ByNameRootBoneMapper&gt;();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">    byNameRootBoneMapper.name = <span class="string">&quot;ByNameRootBoneMapper&quot;</span>;</span><br><span class="line">    assetLoaderOptions.RootBoneMapper = byNameRootBoneMapper;</span><br><span class="line">    <span class="keyword">if</span> (MaterialMapper.RegisteredMappers.Count  <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Please add at least one MaterialMapper name to the MaterialMapper.RegisteredMappers static field to create the right MaterialMapper for the Render Pipeline you are using.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> materialMappers = <span class="keyword">new</span> List&lt;MaterialMapper&gt;();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> materialMapperName <span class="keyword">in</span> MaterialMapper.RegisteredMappers)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (materialMapperName  <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            MaterialMapper materialMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">            <span class="keyword">if</span> (generateAssets)</span><br><span class="line">            &#123;</span><br><span class="line">                materialMapper = (MaterialMapper)LoadOrCreateScriptableObject(materialMapperName, <span class="string">&quot;Material&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                materialMapper = (MaterialMapper)ScriptableObject.CreateInstance(materialMapperName);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">            materialMapper = ScriptableObject.CreateInstance(materialMapperName) <span class="keyword">as</span> MaterialMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">            <span class="keyword">if</span> (materialMapper != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                materialMapper.name = materialMapperName;</span><br><span class="line">                <span class="keyword">if</span> (materialMapper.IsCompatible(<span class="literal">null</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    materialMappers.Add(materialMapper);</span><br><span class="line">                    assetLoaderOptions.FixedAllocations.Add(materialMapper);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">                    <span class="keyword">var</span> assetPath = AssetDatabase.GetAssetPath(materialMapper);</span><br><span class="line">                    <span class="keyword">if</span> (assetPath  <span class="literal">null</span>) &#123;</span><br><span class="line">                        Object.DestroyImmediate(materialMapper);</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">                    Object.Destroy(materialMapper);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (materialMappers.Count  <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.LogWarning(<span class="string">&quot;TriLib could not find any suitable MaterialMapper on the project.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderOptions.MaterialMappers = materialMappers.ToArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//These two animation clip mappers are used to convert legacy to humanoid animations and add a simple generic animation playback component to the model, which will be disabled by default.</span></span><br><span class="line">    LegacyToHumanoidAnimationClipMapper legacyToHumanoidAnimationClipMapper;</span><br><span class="line">    SimpleAnimationPlayerAnimationClipMapper simpleAnimationPlayerAnimationClipMapper;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_EDITOR</span></span><br><span class="line">    <span class="keyword">if</span> (generateAssets)</span><br><span class="line">    &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper = (LegacyToHumanoidAnimationClipMapper)LoadOrCreateScriptableObject(<span class="string">&quot;LegacyToHumanoidAnimationClipMapper&quot;</span>, <span class="string">&quot;AnimationClip&quot;</span>);</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper = (SimpleAnimationPlayerAnimationClipMapper)LoadOrCreateScriptableObject(<span class="string">&quot;SimpleAnimationPlayerAnimationClipMapper&quot;</span>, <span class="string">&quot;AnimationClip&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper = ScriptableObject.CreateInstance&lt;LegacyToHumanoidAnimationClipMapper&gt;();</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper = ScriptableObject.CreateInstance&lt;SimpleAnimationPlayerAnimationClipMapper&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">    legacyToHumanoidAnimationClipMapper = ScriptableObject.CreateInstance&lt;LegacyToHumanoidAnimationClipMapper&gt;();</span><br><span class="line">    simpleAnimationPlayerAnimationClipMapper = ScriptableObject.CreateInstance&lt;SimpleAnimationPlayerAnimationClipMapper&gt;();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">    legacyToHumanoidAnimationClipMapper.name = <span class="string">&quot;LegacyToHumanoidAnimationClipMapper&quot;</span>;</span><br><span class="line">    simpleAnimationPlayerAnimationClipMapper.name = <span class="string">&quot;SimpleAnimationPlayerAnimationClipMapper&quot;</span>;</span><br><span class="line">    assetLoaderOptions.AnimationClipMappers = <span class="keyword">new</span> AnimationClipMapper[]</span><br><span class="line">    &#123;</span><br><span class="line">        legacyToHumanoidAnimationClipMapper,</span><br><span class="line">        simpleAnimationPlayerAnimationClipMapper</span><br><span class="line">    &#125;;</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(assetLoaderOptions);</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(legacyToHumanoidAnimationClipMapper);</span><br><span class="line">    assetLoaderOptions.FixedAllocations.Add(simpleAnimationPlayerAnimationClipMapper);</span><br><span class="line">    <span class="keyword">return</span> assetLoaderOptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code first does three main things, namely to find the appropriate’RootBoneMapper ‘,’ MaterialMapper ‘,’ AnimationPlayerAninamtionClipMapper ‘.</p><p>We take MaterialMapper as an example. When the model imported by this tool is not imported into Material, then the tool is needed to help create a Material. So how does Trilib determine what Material to use? This is what was said in the question just now.</p><p>For example, if we use a URP, the final MaterialMapper selected is’UniversalRPMaterialMapper ‘.</p><p>The code is as follows:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UniversalRPMaterialMapper</span> : <span class="title">MaterialMapper</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">UniversalRPMaterialMapper</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        AddToRegisteredMappers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">RuntimeInitializeOnLoadMethod</span>]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddToRegisteredMappers</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (RegisteredMappers.Contains(<span class="string">&quot;UniversalRPMaterialMapper&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        RegisteredMappers.Add(<span class="string">&quot;UniversalRPMaterialMapper&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material MaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material AlphaMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaCutout&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material AlphaMaterialPreset2 =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlpha&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularAlphaMaterialPreset =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaCutoutSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material SpecularAlphaMaterialPreset2 =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPAlphaSpecular&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> Material LoadingMaterial =&gt; Resources.Load&lt;Material&gt;(<span class="string">&quot;Materials/UniversalRP/TriLibUniversalRPLoading&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsCompatible</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GraphicsSettingsUtils.IsUsingUniversalPipeline;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span><span class="doctag">&lt;inheritdoc /&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Map</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial = <span class="keyword">new</span> VirtualMaterial();</span><br><span class="line">        CheckDiffuseMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckDiffuseMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> diffuseTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.DiffuseTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(diffuseTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Diffuse, materialMapperContext.Material.GetTextureValue(diffuseTexturePropertyName), ApplyDiffuseMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyDiffuseMapTexture(materialMapperContext, TextureType.Diffuse, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyDiffuseMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseMap&quot;</span>, texture);</span><br><span class="line">        CheckGlossinessValue(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckGlossinessValue</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.Glossiness, materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.Glossiness));</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_Glossiness&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        CheckMetallicValue(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckMetallicValue</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.Metallic);</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_Metallic&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        CheckEmissionMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckEmissionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> emissionTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.EmissionTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(emissionTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Emission, materialMapperContext.Material.GetTextureValue(emissionTexturePropertyName), ApplyEmissionMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyEmissionMapTexture(materialMapperContext, TextureType.Emission, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyEmissionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_EmissionMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.RealtimeEmissive;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.EmissiveIsBlack;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckNormalMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckNormalMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> normalMapTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.NormalTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(normalMapTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.NormalMap, materialMapperContext.Material.GetTextureValue(normalMapTexturePropertyName), ApplyNormalMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyNormalMapTexture(materialMapperContext, TextureType.NormalMap, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyNormalMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BumpMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_NORMALMAP&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_NormalScale&quot;</span>, materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.NormalTexture, <span class="number">1f</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_NORMALMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSpecularTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckSpecularTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> specularTexturePropertyName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.SpecularTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(specularTexturePropertyName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Specular, materialMapperContext.Material.GetTextureValue(specularTexturePropertyName), ApplySpecGlossMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplySpecGlossMapTexture(materialMapperContext, TextureType.Specular, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplySpecGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_SpecGlossMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_METALLICSPECGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_METALLICSPECGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckOcclusionMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckOcclusionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> occlusionMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.OcclusionTexture);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(occlusionMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Occlusion, materialMapperContext.Material.GetTextureValue(occlusionMapTextureName), ApplyOcclusionMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyOcclusionMapTexture(materialMapperContext, TextureType.Occlusion, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyOcclusionMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_OcclusionMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_OCCLUSIONMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_OCCLUSIONMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckParallaxMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckParallaxMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> parallaxMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.ParallaxMap);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(parallaxMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Parallax, materialMapperContext.Material.GetTextureValue(parallaxMapTextureName), ApplyParallaxMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyParallaxMapTexture(materialMapperContext, TextureType.Parallax, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyParallaxMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_ParallaxMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_PARALLAXMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_PARALLAXMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckMetallicGlossMapTexture(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckMetallicGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> metallicGlossMapTextureName = materialMapperContext.Material.GetGenericPropertyName(GenericMaterialProperty.MetallicGlossMap);</span><br><span class="line">        <span class="keyword">if</span> (materialMapperContext.Material.HasProperty(metallicGlossMapTextureName))</span><br><span class="line">        &#123;</span><br><span class="line">            LoadTexture(materialMapperContext, TextureType.Metalness, materialMapperContext.Material.GetTextureValue(metallicGlossMapTextureName), ApplyMetallicGlossMapTexture);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ApplyMetallicGlossMapTexture(materialMapperContext, TextureType.Metalness, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyMetallicGlossMapTexture</span>(<span class="params">MaterialMapperContext materialMapperContext, TextureType textureType, Texture texture</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_MetallicGlossMap&quot;</span>, texture);</span><br><span class="line">        <span class="keyword">if</span> (texture != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_METALLICGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_METALLICGLOSSMAP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CheckEmissionColor(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckEmissionColor</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericColorValue(GenericMaterialProperty.EmissionColor) * materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.EmissionColor, <span class="number">1f</span>);</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_EmissionColor&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">value</span> != Color.black)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.EnableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.RealtimeEmissive;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.DisableKeyword(<span class="string">&quot;_EMISSION&quot;</span>);</span><br><span class="line">            materialMapperContext.VirtualMaterial.GlobalIlluminationFlags = MaterialGlobalIlluminationFlags.EmissiveIsBlack;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckDiffuseColor(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CheckDiffuseColor</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="keyword">value</span> = materialMapperContext.Material.GetGenericColorValue(GenericMaterialProperty.DiffuseColor) * materialMapperContext.Material.GetGenericPropertyValueMultiplied(GenericMaterialProperty.DiffuseColor, <span class="number">1f</span>);</span><br><span class="line">        <span class="keyword">value</span>.a *= materialMapperContext.Material.GetGenericFloatValue(GenericMaterialProperty.AlphaValue);</span><br><span class="line">        <span class="keyword">if</span> (!materialMapperContext.VirtualMaterial.HasAlpha &amp;&amp; <span class="keyword">value</span>.a &lt; <span class="number">1f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            materialMapperContext.VirtualMaterial.HasAlpha = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        materialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseColor&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">        BuildMaterial(materialMapperContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The corresponding presets in the code can be seen directly in the folder.</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1654240809/origin-of-ray/screenshot-20220603-151953_fuledj.png" alt></p><p>Each Mapper first constructs the function and adds its own to’MaterialMapper. RegisteredMappers’. Only in this variable will it enter the list to be selected</p><p>And each Mapper exposes only two methods, one is’IsCompatible ‘, that is, using the variables involved in the first question, and the other is’Map’. In this function, all private functions will be called in sequence., each function checks a property in the FBX file, and then sets the property of the final material used.</p><p>Finally, the’BuildMaterial ‘method will be called. The definition of this method is very simple.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">BuildMaterial</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span> =&gt; materialMapperContext.UnityMaterial = <span class="keyword">this</span>.InstantiateSuitableMaterial(materialMapperContext);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Material <span class="title">InstantiateSuitableMaterial</span>(<span class="params">MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Material material;</span><br><span class="line">    <span class="keyword">if</span> (!materialMapperContext.Context.LoadedMaterials.TryGetValue(materialMapperContext.Material, <span class="keyword">out</span> material))</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">bool</span> flag = materialMapperContext.Context.Options.UseAlphaMaterials &amp;&amp; materialMapperContext.VirtualMaterial.HasAlpha &amp;&amp; !<span class="keyword">this</span>.ForceStandardMaterial;</span><br><span class="line">    <span class="keyword">if</span> (materialMapperContext.Material.MaterialShadingSetup  MaterialShadingSetup.Specular)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((UnityEngine.Object) <span class="keyword">this</span>.SpecularAlphaMaterialPreset != (UnityEngine.Object) <span class="literal">null</span> &amp; flag)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(<span class="keyword">this</span>.SpecularAlphaMaterialPreset);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((UnityEngine.Object) <span class="keyword">this</span>.SpecularMaterialPreset != (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(<span class="keyword">this</span>.SpecularMaterialPreset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((UnityEngine.Object) material  (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">        material = UnityEngine.Object.Instantiate&lt;Material&gt;(flag ? <span class="keyword">this</span>.AlphaMaterialPreset : <span class="keyword">this</span>.MaterialPreset);</span><br><span class="line">    MaterialMapper.ApplyMaterialProperties(materialMapperContext, material);</span><br><span class="line">    materialMapperContext.Context.LoadedMaterials.Add(materialMapperContext.Material, material);</span><br><span class="line">    materialMapperContext.Context.Allocations.Add((UnityEngine.Object) material);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> material;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If when we load FBX, we also load material, that is, it can be directly obtained from the’LoadedMaterials’ variable, then use it directly. If not, choose a material from the preset.</p><p>This is how the first material in our final model came about. As for when this method is called, we will talk about it below.</p><h4 id="CreateWebRequest-modelUrl"><a href="#CreateWebRequest-modelUrl" class="headerlink" title="CreateWebRequest(modelUrl);"></a>CreateWebRequest(modelUrl);</h4><p>There is nothing to say about this method, it is to create UnityWebRequest.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UnityWebRequest <span class="title">CreateWebRequest</span>(<span class="params"><span class="built_in">string</span> uri, HttpRequestMethod httpRequestMethod = HttpRequestMethod.Get, <span class="built_in">string</span> data = <span class="literal">null</span>, <span class="built_in">int</span> timeout = <span class="number">2000</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    UnityWebRequest unityWebRequest;</span><br><span class="line">    <span class="keyword">switch</span> (httpRequestMethod)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Post:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Post(uri, data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Put:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Put(uri, data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Delete:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Delete(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> HttpRequestMethod.Head:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Head(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            unityWebRequest = UnityWebRequest.Get(<span class="string">$&quot;<span class="subst">&#123;uri&#125;</span>?<span class="subst">&#123;data&#125;</span>&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    unityWebRequest.timeout = timeout;</span><br><span class="line">    <span class="keyword">return</span> unityWebRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="LoadModelFromUri"><a href="#LoadModelFromUri" class="headerlink" title="LoadModelFromUri"></a>LoadModelFromUri</h4><p>This method is the core and is defined as:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Coroutine <span class="title">LoadModelFromUri</span>(<span class="params">UnityWebRequest unityWebRequest, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span>, <span class="built_in">bool</span>? isZipFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> assetDownloader = <span class="keyword">new</span> GameObject(<span class="string">&quot;Asset Downloader&quot;</span>).AddComponent&lt;AssetDownloaderBehaviour&gt;();</span><br><span class="line">    <span class="keyword">return</span> assetDownloader.StartCoroutine(assetDownloader.DownloadAsset(unityWebRequest, onLoad, onMaterialsLoad, onProgress, wrapperGameObject, onError, assetLoaderOptions, customContextData, fileExtension, isZipFile));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>This method mainly calls DownloadAsset.<br></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IEnumerator <span class="title">DownloadAsset</span>(<span class="params">UnityWebRequest unityWebRequest, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, GameObject wrapperGameObject, Action&lt;IContextualizedError&gt; onError, AssetLoaderOptions assetLoaderOptions, <span class="built_in">object</span> customContextData, <span class="built_in">string</span> fileExtension, <span class="built_in">bool</span>? isZipFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _unityWebRequest = unityWebRequest;</span><br><span class="line">    _onProgress = onProgress;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> unityWebRequest.SendWebRequest();</span><br><span class="line">    <span class="keyword">if</span> (unityWebRequest.responseCode &lt; <span class="number">400</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> memoryStream = <span class="keyword">new</span> MemoryStream(_unityWebRequest.downloadHandler.data);</span><br><span class="line">        <span class="keyword">var</span> uriLoadCustomContextData = <span class="keyword">new</span> UriLoadCustomContextData</span><br><span class="line">        &#123;</span><br><span class="line">            UnityWebRequest = _unityWebRequest,</span><br><span class="line">            CustomData = customContextData</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">var</span> contentType = unityWebRequest.GetResponseHeader(<span class="string">&quot;Content-Type&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (contentType != <span class="literal">null</span> &amp;&amp; isZipFile  <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            isZipFile = contentType.Contains(<span class="string">&quot;application/zip&quot;</span>) || contentType.Contains(<span class="string">&quot;application/x-zip-compressed&quot;</span>) || contentType.Contains(<span class="string">&quot;multipart/x-zip&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isZipFile.GetValueOrDefault())</span><br><span class="line">        &#123;</span><br><span class="line">            _assetLoaderContext = AssetLoaderZip.LoadModelFromZipStream(memoryStream, onLoad, onMaterialsLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress) &#123; onProgress?.Invoke(assetLoaderContext, <span class="number">0.5f</span> + progress * <span class="number">0.5f</span>); &#125;, onError, wrapperGameObject, assetLoaderOptions, uriLoadCustomContextData, fileExtension);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _assetLoaderContext = AssetLoader.LoadModelFromStream(memoryStream, <span class="literal">null</span>, fileExtension, onLoad, onMaterialsLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext, <span class="built_in">float</span> progress) &#123; onProgress?.Invoke(assetLoaderContext, <span class="number">0.5f</span> + progress * <span class="number">0.5f</span>); &#125;, onError, wrapperGameObject, assetLoaderOptions, uriLoadCustomContextData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> exception = <span class="keyword">new</span> Exception(<span class="string">$&quot;UnityWebRequest error:<span class="subst">&#123;unityWebRequest.error&#125;</span>, code:<span class="subst">&#123;unityWebRequest.responseCode&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (onError != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> contextualizedError = exception <span class="keyword">as</span> IContextualizedError;</span><br><span class="line">            onError(contextualizedError ?? <span class="keyword">new</span> ContextualizedError&lt;AssetLoaderContext&gt;(exception, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Destroy(gameObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>Because ours is a zip file, so go into the logic:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderContext <span class="title">LoadModelFromZipStream</span>(<span class="params">Stream stream, Action&lt;AssetLoaderContext&gt; onLoad, Action&lt;AssetLoaderContext&gt; onMaterialsLoad, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> memoryStream = SetupZipModelLoading(<span class="keyword">ref</span> stream, <span class="literal">null</span>, onError, assetLoaderOptions, <span class="keyword">ref</span> fileExtension, <span class="keyword">out</span> <span class="keyword">var</span> zipFile);</span><br><span class="line">    <span class="keyword">return</span> AssetLoader.LoadModelFromStream(memoryStream, <span class="literal">null</span>, fileExtension, onLoad, <span class="built_in">delegate</span> (AssetLoaderContext assetLoaderContext)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> zipLoadCustomContextData = assetLoaderContext.CustomData <span class="keyword">as</span> ZipLoadCustomContextData;</span><br><span class="line">        zipLoadCustomContextData?.Stream.Close();</span><br><span class="line">        onMaterialsLoad?.Invoke(assetLoaderContext);</span><br><span class="line">    &#125;, onProgress, OnError, wrapperGameObject, assetLoaderOptions, <span class="keyword">new</span> ZipLoadCustomContextData</span><br><span class="line">    &#123;</span><br><span class="line">        ZipFile = zipFile,</span><br><span class="line">        Stream = stream,</span><br><span class="line">        CustomData = customContextData</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Continue calling’LoadModelFromStream ‘:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AssetLoaderContext <span class="title">LoadModelFromStream</span>(<span class="params">Stream stream, <span class="built_in">string</span> filename = <span class="literal">null</span>, <span class="built_in">string</span> fileExtension = <span class="literal">null</span>, Action&lt;AssetLoaderContext&gt; onLoad = <span class="literal">null</span>, Action&lt;AssetLoaderContext&gt; onMaterialsLoad = <span class="literal">null</span>, Action&lt;AssetLoaderContext, <span class="built_in">float</span>&gt; onProgress = <span class="literal">null</span>, Action&lt;IContextualizedError&gt; onError = <span class="literal">null</span>, GameObject wrapperGameObject = <span class="literal">null</span>, AssetLoaderOptions assetLoaderOptions = <span class="literal">null</span>, <span class="built_in">object</span> customContextData = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UNITY_WEBGL</span></span><br><span class="line">    AssetLoaderContext assetLoaderContext = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        assetLoaderContext = LoadModelFromStreamNoThread(stream, filename, fileExtension, onError, wrapperGameObject, assetLoaderOptions, customContextData);</span><br><span class="line">        onLoad(assetLoaderContext);</span><br><span class="line">        onMaterialsLoad(assetLoaderContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception exception)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (exception <span class="keyword">is</span> IContextualizedError contextualizedError)</span><br><span class="line">        &#123;</span><br><span class="line">            HandleError(contextualizedError);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            HandleError(<span class="keyword">new</span> ContextualizedError&lt;AssetLoaderContext&gt;(exception, <span class="literal">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> assetLoaderContext;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> </span></span><br><span class="line">    <span class="keyword">var</span> assetLoaderContext = <span class="keyword">new</span> AssetLoaderContext</span><br><span class="line">    &#123;</span><br><span class="line">        Options = assetLoaderOptions  <span class="literal">null</span> ? CreateDefaultLoaderOptions() : assetLoaderOptions,</span><br><span class="line">        Stream = stream,</span><br><span class="line">        FileExtension = fileExtension ?? FileUtils.GetFileExtension(filename, <span class="literal">false</span>),</span><br><span class="line">        BasePath = FileUtils.GetFileDirectory(filename),</span><br><span class="line">        WrapperGameObject = wrapperGameObject,</span><br><span class="line">        OnMaterialsLoad = onMaterialsLoad,</span><br><span class="line">        OnLoad = onLoad,</span><br><span class="line">        HandleError = HandleError,</span><br><span class="line">        OnError = onError,</span><br><span class="line">        CustomData = customContextData</span><br><span class="line">    &#125;;</span><br><span class="line">    assetLoaderContext.Tasks.Add(ThreadUtils.RunThread(assetLoaderContext, <span class="keyword">ref</span> assetLoaderContext.CancellationToken, LoadModel, ProcessRootModel, HandleError, assetLoaderContext.Options.Timeout));</span><br><span class="line">    <span class="keyword">return</span> assetLoaderContext;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here is mainly to open a Thread to call LoadModel and ProcessRootModel respectively</p><p>LoadModel content is relatively easy to understand, is to read the FBX content, but this step reads out a lot of properties have a great impact on the subsequent processing, but also why I have a second material, and determines my second material is How to choose</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadModel</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Options.MaterialMappers != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Array.Sort(assetLoaderContext.Options.MaterialMappers, (a, b) =&gt; a.CheckingOrder &gt; b.CheckingOrder ? <span class="number">-1</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (assetLoaderContext.Options.ShowLoadingWarnings)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;Your AssetLoaderOptions instance has no MaterialMappers. TriLib can&#x27;t process materials without them.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRILIB_DRACO</span></span><br><span class="line">    GltfReader.DracoDecompressorCallback = DracoMeshLoader.DracoDecompressorCallback;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">    <span class="keyword">var</span> fileExtension = assetLoaderContext.FileExtension ?? FileUtils.GetFileExtension(assetLoaderContext.Filename, <span class="literal">false</span>).ToLowerInvariant();</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Stream  <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> fileStream = <span class="keyword">new</span> FileStream(assetLoaderContext.Filename, FileMode.Open);</span><br><span class="line">        assetLoaderContext.Stream = fileStream;</span><br><span class="line">        <span class="keyword">var</span> reader = Readers.FindReaderForExtension(fileExtension);</span><br><span class="line">        <span class="keyword">if</span> (reader != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderContext.RootModel = reader.ReadStream(fileStream, assetLoaderContext, assetLoaderContext.Filename, assetLoaderContext.OnProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> reader = Readers.FindReaderForExtension(fileExtension);</span><br><span class="line">        <span class="keyword">if</span> (reader != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            assetLoaderContext.RootModel = reader.ReadStream(assetLoaderContext.Stream, assetLoaderContext, <span class="literal">null</span>, assetLoaderContext.OnProgress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then there is ProcessRootModel, which first calls ProcessModel recursion to introduce the Model, and then ProcessTextures to process the map</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessRootModel</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ProcessModel(assetLoaderContext);</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Async)</span><br><span class="line">    &#123;</span><br><span class="line">        ThreadUtils.RunThread(assetLoaderContext, <span class="keyword">ref</span> assetLoaderContext.CancellationToken, ProcessTextures, <span class="literal">null</span>, assetLoaderContext.HandleError ?? assetLoaderContext.OnError, assetLoaderContext.Options.Timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ProcessTextures(assetLoaderContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The last step of the ProcessTextures is the ProcessMaterial, which calls the Map method of the MaterialMapper we selected earlier:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ProcessMaterials</span>(<span class="params">AssetLoaderContext assetLoaderContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (assetLoaderContext.Options.MaterialMappers != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> material <span class="keyword">in</span> assetLoaderContext.RootModel.AllMaterials)</span><br><span class="line">        &#123;</span><br><span class="line">            MaterialMapper usedMaterialMapper = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> materialMapperContext = <span class="keyword">new</span> MaterialMapperContext</span><br><span class="line">            &#123;</span><br><span class="line">                Context = assetLoaderContext,</span><br><span class="line">                Material = material</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> materialMapper <span class="keyword">in</span> assetLoaderContext.Options.MaterialMappers)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (materialMapper  <span class="literal">null</span> || !materialMapper.IsCompatible(materialMapperContext))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                materialMapper.Map(materialMapperContext);</span><br><span class="line">                usedMaterialMapper = materialMapper;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (usedMaterialMapper != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (assetLoaderContext.MaterialRenderers.TryGetValue(material, <span class="keyword">out</span> <span class="keyword">var</span> materialRendererList))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> materialRendererContext <span class="keyword">in</span> materialRendererList)</span><br><span class="line">                    &#123;</span><br><span class="line">                        usedMaterialMapper.ApplyMaterialToRenderer(materialRendererContext, materialMapperContext);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (assetLoaderContext.Options.ShowLoadingWarnings)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.LogWarning(<span class="string">&quot;The given AssetLoaderOptions contains no MaterialMapper. Materials will not be created.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Also note that the’ApplyMaterialToRenderer ‘method is also called here, which creates a new Material:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ApplyMaterialToRenderer</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      MaterialRendererContext materialRendererContext,</span></span></span><br><span class="line"><span class="params"><span class="function">      MaterialMapperContext materialMapperContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Material[] sharedMaterials = materialRendererContext.Renderer.sharedMaterials;</span><br><span class="line">    sharedMaterials[materialRendererContext.MaterialIndex] = materialMapperContext.UnityMaterial;</span><br><span class="line">    materialRendererContext.Renderer.sharedMaterials = sharedMaterials;</span><br><span class="line">    <span class="keyword">if</span> ((!materialMapperContext.Context.Options.UseAlphaMaterials || !materialMapperContext.VirtualMaterial.HasAlpha ? <span class="number">0</span> : (!<span class="keyword">this</span>.ForceStandardMaterial ? <span class="number">1</span> : <span class="number">0</span>))  <span class="number">0</span> || !materialMapperContext.Context.Options.AddSecondAlphaMaterial)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    MeshFilter componentInChildren1 = materialRendererContext.Renderer.GetComponentInChildren&lt;MeshFilter&gt;();</span><br><span class="line">    SkinnedMeshRenderer componentInChildren2 = materialRendererContext.Renderer.GetComponentInChildren&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">    Mesh mesh = (UnityEngine.Object) componentInChildren1 != (UnityEngine.Object) <span class="literal">null</span> ? componentInChildren1.sharedMesh : componentInChildren2?.sharedMesh;</span><br><span class="line">    <span class="keyword">if</span> (!((UnityEngine.Object) mesh != (UnityEngine.Object) <span class="literal">null</span>))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    Material material = <span class="keyword">this</span>.InstantiateSuitableSecondPassMaterial(materialMapperContext);</span><br><span class="line">    <span class="keyword">if</span> ((UnityEngine.Object) material  (UnityEngine.Object) <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">int</span>[] triangles = mesh.GetTriangles(materialRendererContext.MaterialIndex);</span><br><span class="line">    ++mesh.subMeshCount;</span><br><span class="line">    mesh.SetTriangles(triangles, mesh.subMeshCount - <span class="number">1</span>);</span><br><span class="line">    List&lt;Material&gt; m = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line">    materialRendererContext.Renderer.GetSharedMaterials(m);</span><br><span class="line">    m.Add(material);</span><br><span class="line">    materialRendererContext.Renderer.materials = m.ToArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The last three lines add sharedMaterilas to m, then add a created Material, and finally assign it together to Render.materials.</p><h4 id="Summary-and-solution"><a href="#Summary-and-solution" class="headerlink" title="Summary and solution"></a>Summary and solution</h4><p>The simple call flow of the two materials can be summarized as follows:</p><ul><li>CreateDefaultLoaderOptions的时候选择了一个MaterialMapper</li><li>After the model is downloaded successfully, import it through the LoadModel method</li><li>After LoadModel succeeds, ProcessRootModel calls ProcessModel to process the properties of the Model, and ProcessTexture is used to process the texture</li><li>ProcessTextures最终会调用ProcessMaterial</li><li>ProcessMaterial will first call the Map method of the MaterialMapper selected in the first step to create a material, and then call the ApplyMaterialToRenderer of the MaterialMapper to create another material. The materials created in these two steps are selected according to one of the templates set in advance, and the selection is based on the configuration that comes with the LoadModel import.</li></ul><p>The solution is to set the useAlpha property to false (the default is true) when creating assetOptions in the first step.</p><h3 id="loadFbxFromZipFile丢失贴图（v2-1-6）"><a href="#loadFbxFromZipFile丢失贴图（v2-1-6）" class="headerlink" title="loadFbxFromZipFile丢失贴图（v2.1.6）"></a>loadFbxFromZipFile丢失贴图（v2.1.6）</h3><p>When you successfully import fbx, you will find that there may be no textures in your material. At this time, you need to check whether the texture name in the zip package is correct, that is, what is the texture name specified in your fbx, and what is your actual texture name. What is the name, trilib is mapped by file name.</p><h3 id="IsReadable-for-textures-is-false-v2-1-6"><a href="#IsReadable-for-textures-is-false-v2-1-6" class="headerlink" title="IsReadable for textures is false (v2.1.6)"></a>IsReadable for textures is false (v2.1.6)</h3><p>After upgrading to version 2.1.6, the textures in the imported material of trilib cannot be read, that is, ‘Read/Write Enable’ is not checked.</p><p>This can be seen on the official doc that this is intentional, and there is no option to modify this configuration, so we can only modify its underlying code.</p><p>In the end, I chose to change the’ApplyDiffuseMapTexture ‘method in MaterialMapper, because my project is a URP project, so I modified UniversalUniversalRPMaterialMapper</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ApplyDiffuseMapTexture</span>(<span class="params">TextureLoadingContext textureLoadingContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (textureLoadingContext.UnityTexture != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Texture2D unityTexture = <span class="keyword">new</span> Texture2D(textureLoadingContext.UnityTexture.width, textureLoadingContext.UnityTexture.height, textureLoadingContext.UnityTexture.graphicsFormat, textureLoadingContext.UnityTexture.mipmapCount, TextureCreationFlags.None);</span><br><span class="line"></span><br><span class="line">        Graphics.CopyTexture(textureLoadingContext.UnityTexture, unityTexture);</span><br><span class="line">        DestroyImmediate(textureLoadingContext.UnityTexture);</span><br><span class="line">        textureLoadingContext.UnityTexture = unityTexture;</span><br><span class="line">        textureLoadingContext.Context.AddUsedTexture(textureLoadingContext.UnityTexture);</span><br><span class="line">    &#125;</span><br><span class="line">    textureLoadingContext.MaterialMapperContext.VirtualMaterial.SetProperty(<span class="string">&quot;_BaseMap&quot;</span>, textureLoadingContext.UnityTexture, GenericMaterialProperty.DiffuseMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/48749/" title="Use and source code analysis of TriLib remote loading FBX under Unity">https://sunra.top/en/posts/48749/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/58398/" rel="prev" title="Principles of Unity Rendering (9) Unity Lighting Model"><i class="fa fa-chevron-left"></i> Principles of Unity Rendering (9) Unity Lighting Model</a></div><div class="post-nav-item"> <a href="/en/posts/13197/" rel="next" title="Operating System Learning Notes (3) Process Scheduling, Synchronization/mutual exclusion and Deadlock">Operating System Learning Notes (3) Process Scheduling, Synchronization/mutual exclusion and Deadlock<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/48749/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>