<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="The previous six blogs have helped us basically understand the concepts and principles of the responsive principle of vue, Data drive, component and component update, and the part about component and"><meta property="og:type" content="article"><meta property="og:title" content="Vue Source Learning (7) Compiler Principle"><meta property="og:url" content="https://sunra.top/en/posts/90452f87/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="The previous six blogs have helped us basically understand the concepts and principles of the responsive principle of vue, Data drive, component and component update, and the part about component and"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-10-31T07:02:02.000Z"><meta property="article:modified_time" content="2024-06-20T08:56:35.602Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/posts/90452f87/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/posts/90452f87/","path":"posts/90452f87/","title":"Vue Source Learning (7) Compiler Principle"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Vue Source Learning (7) Compiler Principle | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#compiler-entry"><span class="nav-number">1.</span> <span class="nav-text">Compiler entry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#currying"><span class="nav-number">1.1.</span> <span class="nav-text">Currying</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#basecompile"><span class="nav-number">1.2.</span> <span class="nav-text">baseCompile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lets-see-the-compile-process-through-an-example"><span class="nav-number">2.</span> <span class="nav-text">Let’s see the compile process through an example</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#parse"><span class="nav-number">2.1.</span> <span class="nav-text">parse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#optimize"><span class="nav-number">2.2.</span> <span class="nav-text">optimize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#codegen"><span class="nav-number">2.3.</span> <span class="nav-text">codegen</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#source-code-analysis"><span class="nav-number">3.</span> <span class="nav-text">Source code analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#parse-2"><span class="nav-number">3.1.</span> <span class="nav-text">parse</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#from"><span class="nav-number">3.1.1.</span> <span class="nav-text">From</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#analysis"><span class="nav-number">3.1.2.</span> <span class="nav-text">Analysis</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#optimize-2"><span class="nav-number">3.2.</span> <span class="nav-text">optimize</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mark-static-node"><span class="nav-number">3.2.1.</span> <span class="nav-text">Mark static node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mark-static-root"><span class="nav-number">3.2.2.</span> <span class="nav-text">Mark static root</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#codegen-2"><span class="nav-number">3.3.</span> <span class="nav-text">codegen</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slot"><span class="nav-number">4.</span> <span class="nav-text">slot</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/posts/90452f87/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Vue Source Learning (7) Compiler Principle | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Vue Source Learning (7) Compiler Principle</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2020-10-31 15:02:02" itemprop="dateCreated datePublished" datetime="2020-10-31T15:02:02+08:00">2020-10-31</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-06-20 16:56:35" itemprop="dateModified" datetime="2024-06-20T16:56:35+08:00">2024-06-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/posts/90452f87/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/posts/90452f87/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>The previous six blogs have helped us basically understand the concepts and principles of the responsive principle of vue, Data drive, component and component update, and the part about component and component update, we are based on the existing render function, that is to say, we already have vnode, and then discuss how vnode renders and updates.</p><p>In this blog, we will go back and see how the compiler of vue turns template into render function.</p><p>** What are the benefits of understanding the compile process? I personally think it can help us have a better understanding of the principles of some of vue’s own syntactic sugar. **</p><p>Since there are many details of Compiler, there is probably a conclusion and impression. Many of them will not go into detail about the syntax processing of vue itself, but will only use slot as an example.</p><span id="more"></span><h2 id="compiler-entry"><a class="markdownIt-Anchor" href="#compiler-entry"></a> Compiler entry</h2><p>For the compiler entry point, vue does a series of currying to finally return the compile function.</p><p>This process is to pre-process the configuration related to the platform. For example, the compile of web compile and ssr will have some different configurations, and the platform will not change during the compile process, so these differences are first curried. Encapsulated in function closures, so that there is no need to judge the platform again and again when different components execute the compiler.</p><h3 id="currying"><a class="markdownIt-Anchor" href="#currying"></a> Currying</h3><p>If you want to see how it is curried, you can take a look at this section. Not looking at it will not affect our understanding of the compile process.</p><p>When we use Vue.js with Runtime + Compiler, its entry is src/platforms/web/entry-runtime-with-compiler.js, take a look at its definition of the $mount function:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (el = <span class="variable language_">document</span>.<span class="property">body</span> || el = <span class="variable language_">document</span>.<span class="property">documentElement</span>) &#123;</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; <span class="title function_">warn</span>(</span><br><span class="line">      <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = <span class="variable language_">this</span>.<span class="property">$options</span></span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> template = options.<span class="property">template</span></span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> template = <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (template.<span class="title function_">charAt</span>(<span class="number">0</span>) = <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">          template = <span class="title function_">idToTemplate</span>(template)</span><br><span class="line">          <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">          <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; !template) &#123;</span><br><span class="line">            <span class="title function_">warn</span>(</span><br><span class="line">              <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">              <span class="variable language_">this</span></span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (template.<span class="property">nodeType</span>) &#123;</span><br><span class="line">        template = template.<span class="property">innerHTML</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(<span class="string">&#x27;invalid template option:&#x27;</span> + template, <span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; render, staticRenderFns &#125; = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        shouldDecodeNewlines,</span><br><span class="line">        shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>)</span><br><span class="line">      options.<span class="property">render</span> = render</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">        <span class="title function_">mark</span>(<span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">        <span class="title function_">measure</span>(<span class="string">`vue <span class="subst">$&#123;<span class="variable language_">this</span>._name&#125;</span> compile`</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;compile end&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This function logic has been analyzed before, and the entry point for compile is here:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; render, staticRenderFns &#125; =  <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">    shouldDecodeNewlines,</span><br><span class="line">    shouldDecodeNewlinesForHref,</span><br><span class="line">    <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">    <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">  &#125;, <span class="variable language_">this</span>)</span><br><span class="line">options.<span class="property">render</span> = render</span><br><span class="line">options.<span class="property">staticRenderFns</span> = staticRenderFns</span><br></pre></td></tr></table></figure><p>The compileToFunctions method is to compile the template template to generate render and staticRenderFns, which are defined in src/platforms/web/compiler/index.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; baseOptions &#125; <span class="keyword">from</span> <span class="string">&#x27;./options&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createCompiler &#125; <span class="keyword">from</span> <span class="string">&#x27;compiler/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; compile, compileToFunctions &#125; = <span class="title function_">createCompiler</span>(baseOptions)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; compile, compileToFunctions &#125;</span><br></pre></td></tr></table></figure><p>You can see that the’compileToFunctions’ method is actually the return value of the’createCompiler ‘method, which receives a compile configuration parameter. Next, let’s look at the definition of the’createCompiler’ method, in’src/compiler/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `createCompilerCreator` allows creating compilers that use alternative</span></span><br><span class="line"><span class="comment">// parser/optimizer/codegen, e.g the SSR optimizing compiler.</span></span><br><span class="line"><span class="comment">// Here we just export a default compiler using the default parts.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> ! <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>The createCompiler method is actually returned by calling the createCompilerCreator method. The parameter passed by this method is a function. The real compile process is executed in this baseCompile function. Then what is the createCompilerCreator? Its definition is in src/compiler/create-compiler.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompilerCreator</span> (<span class="attr">baseCompile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">createCompiler</span> (<span class="attr">baseOptions</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">compile</span> (</span><br><span class="line">      <span class="attr">template</span>: string,</span><br><span class="line">      options?: <span class="title class_">CompilerOptions</span></span><br><span class="line">    ): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">      <span class="keyword">const</span> errors = []</span><br><span class="line">      <span class="keyword">const</span> tips = []</span><br><span class="line">      finalOptions.<span class="property">warn</span> = <span class="function">(<span class="params">msg, tip</span>) =&gt;</span> &#123;</span><br><span class="line">        (tip ? tips : errors).<span class="title function_">push</span>(msg)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options) &#123;</span><br><span class="line">        <span class="comment">// merge custom modules</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">modules</span>) &#123;</span><br><span class="line">          finalOptions.<span class="property">modules</span> =</span><br><span class="line">            (baseOptions.<span class="property">modules</span> || []).<span class="title function_">concat</span>(options.<span class="property">modules</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// merge custom directives</span></span><br><span class="line">        <span class="keyword">if</span> (options.<span class="property">directives</span>) &#123;</span><br><span class="line">          finalOptions.<span class="property">directives</span> = <span class="title function_">extend</span>(</span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions.<span class="property">directives</span> || <span class="literal">null</span>),</span><br><span class="line">            options.<span class="property">directives</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// copy other options</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> options) &#123;</span><br><span class="line">          <span class="keyword">if</span> (key ! <span class="string">&#x27;modules&#x27;</span> &amp;&amp; key ! <span class="string">&#x27;directives&#x27;</span>) &#123;</span><br><span class="line">            finalOptions[key] = options[key]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template, finalOptions)</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        errors.<span class="property">push</span>.<span class="title function_">apply</span>(errors, <span class="title function_">detectErrors</span>(compiled.<span class="property">ast</span>))</span><br><span class="line">      &#125;</span><br><span class="line">      compiled.<span class="property">errors</span> = errors</span><br><span class="line">      compiled.<span class="property">tips</span> = tips</span><br><span class="line">      <span class="keyword">return</span> compiled</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      compile,</span><br><span class="line">      <span class="attr">compileToFunctions</span>: <span class="title function_">createCompileToFunctionFn</span>(compile)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You can see that the method returns a’createCompiler ‘function, which receives a’baseOptions’ parameter, returns an object, including the’compile ‘method properties and’compileToFunctions’ properties, this’compileToFunctions’ corresponds to the’compileToFunctions’ method called by the ‘$mount’ function, which is the return value of the call to the’createCompileToFunctionFn ‘method. Let’s take a look at the’createCompileToFunctionFn’ method, which is defined in’src/compiler/to-function/js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createCompileToFunctionFn</span> (<span class="attr">compile</span>: <span class="title class_">Function</span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cache = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">compileToFunctions</span> (</span><br><span class="line">    <span class="attr">template</span>: string,</span><br><span class="line">    options?: <span class="title class_">CompilerOptions</span>,</span><br><span class="line">    vm?: <span class="title class_">Component</span></span><br><span class="line">  ): <span class="title class_">CompiledFunctionResult</span> &#123;</span><br><span class="line">    options = <span class="title function_">extend</span>(&#123;&#125;, options)</span><br><span class="line">    <span class="keyword">const</span> warn = options.<span class="property">warn</span> || baseWarn</span><br><span class="line">    <span class="keyword">delete</span> options.<span class="property">warn</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// detect possible CSP restriction</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="string">&#x27;return 1&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="regexp">/unsafe-eval|CSP/</span>)) &#123;</span><br><span class="line">          <span class="title function_">warn</span>(</span><br><span class="line">            <span class="string">&#x27;It seems you are using the standalone build of Vue.js in an &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;environment with Content Security Policy that prohibits unsafe-eval. &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;The template compiler cannot work in this environment. Consider &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;relaxing the policy to allow unsafe-eval or pre-compiling your &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;templates into render functions.&#x27;</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check cache</span></span><br><span class="line">    <span class="keyword">const</span> key = options.<span class="property">delimiters</span></span><br><span class="line">      ? <span class="title class_">String</span>(options.<span class="property">delimiters</span>) + template</span><br><span class="line">      : template</span><br><span class="line">    <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compile</span></span><br><span class="line">    <span class="keyword">const</span> compiled = <span class="title function_">compile</span>(template, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check compilation errors/tips</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (compiled.<span class="property">errors</span> &amp;&amp; compiled.<span class="property">errors</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Error compiling template:\n\n<span class="subst">$&#123;template&#125;</span>\n\n`</span> +</span><br><span class="line">          compiled.<span class="property">errors</span>.<span class="title function_">map</span>(<span class="function"><span class="params">e</span> =&gt;</span> <span class="string">`- <span class="subst">$&#123;e&#125;</span>`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (compiled.<span class="property">tips</span> &amp;&amp; compiled.<span class="property">tips</span>.<span class="property">length</span>) &#123;</span><br><span class="line">        compiled.<span class="property">tips</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">msg</span> =&gt;</span> <span class="title function_">tip</span>(msg, vm))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// turn code into functions</span></span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> fnGenErrors = []</span><br><span class="line">    res.<span class="property">render</span> = <span class="title function_">createFunction</span>(compiled.<span class="property">render</span>, fnGenErrors)</span><br><span class="line">    res.<span class="property">staticRenderFns</span> = compiled.<span class="property">staticRenderFns</span>.<span class="title function_">map</span>(<span class="function"><span class="params">code</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createFunction</span>(code, fnGenErrors)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check function generation errors.</span></span><br><span class="line">    <span class="comment">// this should only happen if there is a bug in the compiler itself.</span></span><br><span class="line">    <span class="comment">// mostly for codegen development use</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((!compiled.<span class="property">errors</span> || !compiled.<span class="property">errors</span>.<span class="property">length</span>) &amp;&amp; fnGenErrors.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Failed to generate render function:\n\n`</span> +</span><br><span class="line">          fnGenErrors.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; err, code &#125;</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;err.toString()&#125;</span> in\n\n<span class="subst">$&#123;code&#125;</span>\n`</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>),</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (cache[key] = res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So far we have finally found the final definition of’compileToFunctions’, which takes 3 parameters, compile template template, compile configuration options and Vue instance vm. The core compile process is just one line of code:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = <span class="title function_">compile</span>(template, options)</span><br></pre></td></tr></table></figure><p>The’compile ‘function is passed as a parameter when executing’createCompileToFunctionFn’. It is the’compile ‘function defined in the’createCompiler’ function, as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  options?: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">  <span class="keyword">const</span> errors = []</span><br><span class="line">  <span class="keyword">const</span> tips = []</span><br><span class="line">  finalOptions.<span class="property">warn</span> = <span class="function">(<span class="params">msg, tip</span>) =&gt;</span> &#123;</span><br><span class="line">    (tip ? tips : errors).<span class="title function_">push</span>(msg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options) &#123;</span><br><span class="line">    <span class="comment">// merge custom modules</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">modules</span>) &#123;</span><br><span class="line">      finalOptions.<span class="property">modules</span> =</span><br><span class="line">        (baseOptions.<span class="property">modules</span> || []).<span class="title function_">concat</span>(options.<span class="property">modules</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// merge custom directives</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">directives</span>) &#123;</span><br><span class="line">      finalOptions.<span class="property">directives</span> = <span class="title function_">extend</span>(</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions.<span class="property">directives</span> || <span class="literal">null</span>),</span><br><span class="line">        options.<span class="property">directives</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// copy other options</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> options) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key ! <span class="string">&#x27;modules&#x27;</span> &amp;&amp; key ! <span class="string">&#x27;directives&#x27;</span>) &#123;</span><br><span class="line">        finalOptions[key] = options[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template, finalOptions)</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    errors.<span class="property">push</span>.<span class="title function_">apply</span>(errors, <span class="title function_">detectErrors</span>(compiled.<span class="property">ast</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  compiled.<span class="property">errors</span> = errors</span><br><span class="line">  compiled.<span class="property">tips</span> = tips</span><br><span class="line">  <span class="keyword">return</span> compiled</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The logic of the’compile 'function is to process the configuration parameters first, and the actual execution of the compile process is one line of code:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template, finalOptions)</span><br></pre></td></tr></table></figure><p>'BaseCompile ‘is passed as a parameter when executing the’createCompilerCreator’ method</p><h3 id="basecompile"><a class="markdownIt-Anchor" href="#basecompile"></a> baseCompile</h3><p>This function is the function that we actually compile to convert the template into render.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CompiledResult</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>It is divided into three steps:</p><ul><li>Convert template to ast tree</li><li>Optimize the ast tree, add some properties for some nodes for later rendering optimization, such as some nodes that will definitely not change plus a property indicating that it is a static node.</li><li>Generate code based on the optimized ast tree, which can be used to generate vnode</li></ul><h2 id="lets-see-the-compile-process-through-an-example"><a class="markdownIt-Anchor" href="#lets-see-the-compile-process-through-an-example"></a> Let’s see the compile process through an example</h2><h3 id="parse"><a class="markdownIt-Anchor" href="#parse"></a> parse</h3><p>The compile process first parses the template and generates an AST. It is a Syntax Tree, which is a tree representation of the abstract syntax structure of the source code. In many compile technologies, such as babel compile ES6 code, it will be generated as AST.</p><p>This process is more complex, it will use a lot of Regular Expression to parse the string, if the regular is not very understanding, it is recommended to go to the knowledge of Regular Expression. In order to visually demonstrate the process of’parse ', let’s look at an example:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">:class</span>=<span class="string">&quot;bindCls&quot;</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in data&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;clickItem(index)&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><p>After the’parse 'process, the generated AST is as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;ul&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;attrsList&#x27;</span>: [],</span><br><span class="line">  <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;:class&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v-if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;ifConditions&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;exp&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">&#x27;parent&#x27;</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticClass&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;classBinding&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;children&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;attrsList&#x27;</span>: [&#123;</span><br><span class="line">      <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;@click&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@click&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;v-for&#x27;</span>: <span class="string">&#x27;(item,index) in data&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">&#x27;parent&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;events&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;click&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hasBindings&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;for&#x27;</span>: <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;alias&#x27;</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iterator1&#x27;</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">      <span class="string">&#x27;type&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">&#x27;expression&#x27;</span>: <span class="string">&#x27;_s(item)+&quot;:&quot;+_s(index)&#x27;</span></span><br><span class="line">      <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;tokens&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;item&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;index&#x27;</span>&#125;</span><br><span class="line">      ]</span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>It can be seen that the generated AST is a tree structure, and each node is an’ast element ‘. In addition to some of its own properties, it also maintains its parent-child relationship, such as’parent’ pointing to its parent node, and’children 'pointing to its All sub-nodes. First, we have some intuitive impressions of the AST, so let’s analyze how this AST is obtained.</p><h3 id="optimize"><a class="markdownIt-Anchor" href="#optimize"></a> optimize</h3><p>When our template template after the parse process, the output will generate AST tree, then we need to optimize the tree, optimize the logic is far simpler than the parse logic, so it will be much easier to understand.</p><p>Why should there be an optimization process, because we know that Vue is Data driven and responsive, but not all of our templates are responsive, and there are many data that will never change after the first render, so this part The DOM generated by the data will not change, and we can skip their comparison in the’patch 'process.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">ast = &#123;</span><br><span class="line">  <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;ul&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;attrsList&#x27;</span>: [],</span><br><span class="line">  <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;:class&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v-if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;if&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;ifConditions&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;exp&#x27;</span>: <span class="string">&#x27;isShow&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;block&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">&#x27;parent&#x27;</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticClass&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;classBinding&#x27;</span>: <span class="string">&#x27;bindCls&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;staticRoot&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&#x27;children&#x27;</span>: [&#123;</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;attrsList&#x27;</span>: [&#123;</span><br><span class="line">      <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;@click&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&#x27;attrsMap&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@click&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;v-for&#x27;</span>: <span class="string">&#x27;(item,index) in data&#x27;</span></span><br><span class="line">     &#125;,</span><br><span class="line">    <span class="string">&#x27;parent&#x27;</span>: <span class="comment">// ul ast element</span></span><br><span class="line">    <span class="string">&#x27;plain&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;events&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;click&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;clickItem(index)&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;hasBindings&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;for&#x27;</span>: <span class="string">&#x27;data&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;alias&#x27;</span>: <span class="string">&#x27;item&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iterator1&#x27;</span>: <span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;staticRoot&#x27;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;children&#x27;</span>: [</span><br><span class="line">      <span class="string">&#x27;type&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="string">&#x27;expression&#x27;</span>: <span class="string">&#x27;_s(item)+&quot;:&quot;+_s(index)&#x27;</span></span><br><span class="line">      <span class="string">&#x27;text&#x27;</span>: <span class="string">&#x27;&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;tokens&#x27;</span>: [</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;item&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;:&#x27;</span>,</span><br><span class="line">        &#123;<span class="string">&#x27;@binding&#x27;</span>:<span class="string">&#x27;index&#x27;</span>&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&#x27;static&#x27;</span>: <span class="literal">false</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="codegen"><a class="markdownIt-Anchor" href="#codegen"></a> codegen</h3><p>The final step of compile is to convert the optimized AST tree into executable code.</p><p>For ease of understanding, let’s use the previous example:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">:class</span>=<span class="string">&quot;bindCls&quot;</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in data&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;clickItem(index)&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;:&#123;&#123;index&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><p>It compiles, executes’const code = generate (ast, options) ‘, and the generated’render’ code string is as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> (isShow) ?</span><br><span class="line">    <span class="title function_">_c</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">staticClass</span>: <span class="string">&quot;list&quot;</span>,</span><br><span class="line">        <span class="attr">class</span>: bindCls</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">_l</span>((data), <span class="keyword">function</span>(<span class="params">item, index</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_c</span>(<span class="string">&#x27;li&#x27;</span>, &#123;</span><br><span class="line">          <span class="attr">on</span>: &#123;</span><br><span class="line">            <span class="string">&quot;click&quot;</span>: <span class="keyword">function</span>(<span class="params">$event</span>) &#123;</span><br><span class="line">              <span class="title function_">clickItem</span>(index)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        [<span class="title function_">_v</span>(<span class="title function_">_s</span>(item) + <span class="string">&quot;:&quot;</span> + <span class="title function_">_s</span>(index))])</span><br><span class="line">      &#125;)</span><br><span class="line">    ) : <span class="title function_">_e</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The _c function is defined in src/core/instance/render.js.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.<span class="property">_c</span> = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> <span class="title function_">createElement</span>(vm, a, b, c, d, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure><p>而 <code>_l</code>、<code>_v</code> 定义在 <code>src/core/instance/render-helpers/index.js</code> 中：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">installRenderHelpers</span> (<span class="attr">target</span>: any) &#123;</span><br><span class="line">  target. _ o = markOnce</span><br><span class="line">  target.<span class="property">_n</span> = toNumber</span><br><span class="line">  target.<span class="property">_s</span> = toString</span><br><span class="line">  target.<span class="property">_l</span> = renderList</span><br><span class="line">  target.<span class="property">_t</span> = renderSlot</span><br><span class="line">  target.<span class="property">_q</span> = looseEqual</span><br><span class="line">  target.<span class="property">_i</span> = looseIndexOf</span><br><span class="line">  target.<span class="property">_m</span> = renderStatic</span><br><span class="line">  target.<span class="property">_f</span> = resolveFilter</span><br><span class="line">  target.<span class="property">_k</span> = checkKeyCodes</span><br><span class="line">  target.<span class="property">_b</span> = bindObjectProps</span><br><span class="line">  target.<span class="property">_v</span> = createTextVNode</span><br><span class="line">  target.<span class="property">_e</span> = createEmptyVNode</span><br><span class="line">  target.<span class="property">_u</span> = resolveScopedSlots</span><br><span class="line">  target.<span class="property">_g</span> = bindObjectListeners</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As the name implies, _c executes createElement to create a VNode, while _l renderList renders a list; _v createTextVNode creates a text VNode; _e creates an empty VNode for createEmptyVNode.</p><h2 id="source-code-analysis"><a class="markdownIt-Anchor" href="#source-code-analysis"></a> Source code analysis</h2><p>Through the example just now, we can have a preliminary understanding of the entire compile process and the results of each step.</p><p>If you are interested, you can take a look at the source code of vue. Since there is a lot of source code, here is just a brief analysis.</p><h3 id="parse-2"><a class="markdownIt-Anchor" href="#parse-2"></a> parse</h3><p>First, let’s take a look at the definition of’parse ‘, in’src/compiler/parser/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  <span class="attr">template</span>: string,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">ASTElement</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="title function_">getFnsAndConfigFromOptions</span>(options)</span><br><span class="line"></span><br><span class="line">  <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    <span class="comment">// options ...</span></span><br><span class="line">    start (tag, attrs, unary) &#123;</span><br><span class="line">      <span class="keyword">let</span> element = <span class="title function_">createASTElement</span>(tag, attrs)</span><br><span class="line">      <span class="title function_">processElement</span>(element)</span><br><span class="line">      <span class="title function_">treeManagement</span>()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    end () &#123;</span><br><span class="line">      <span class="title function_">treeManagement</span>()</span><br><span class="line">      <span class="title function_">closeElement</span>()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    chars (<span class="attr">text</span>: string) &#123;</span><br><span class="line">      <span class="title function_">handleText</span>()</span><br><span class="line">      <span class="title function_">createChildrenASTOfText</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    comment (<span class="attr">text</span>: string) &#123;</span><br><span class="line">      <span class="title function_">createChildrenASTOfComment</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> astRootElement</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The code of’parse 'function is very long, and it is not good to post it again to understand colleagues. I will first split it into pseudocode so that colleagues can have a general understanding of the overall process. Next, we will decompose and analyze the role of each pseudocode.</p><h4 id="from"><a class="markdownIt-Anchor" href="#from"></a> From</h4><p>Corresponding pseudocode:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getFnsAndConfigFromOptions</span>(options)</span><br></pre></td></tr></table></figure><p>The input of’parse ‘function is’template’ and’options’, and the output is the root node of AST. ‘template’ is our template string, and’options’ are actually some platform-related configurations, which are defined in’src/platforms/web/compiler/options’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  isPreTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> modules <span class="keyword">from</span> <span class="string">&#x27;./modules/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> directives <span class="keyword">from</span> <span class="string">&#x27;./directives/index&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; genStaticKeys &#125; <span class="keyword">from</span> <span class="string">&#x27;shared/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; isUnaryTag, canBeLeftOpenTag &#125; <span class="keyword">from</span> <span class="string">&#x27;./util&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">baseOptions</span>: <span class="title class_">CompilerOptions</span> = &#123;</span><br><span class="line">  <span class="attr">expectHTML</span>: <span class="literal">true</span>,</span><br><span class="line">  modules,</span><br><span class="line">  directives,</span><br><span class="line">  isPreTag,</span><br><span class="line">  isUnaryTag,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  canBeLeftOpenTag,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  <span class="attr">staticKeys</span>: <span class="title function_">genStaticKeys</span>(modules)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>These properties and methods are placed in the’platforms’ directory because they are implemented differently on different platforms (web and weex).</p><p>We represent this process with the pseudocode getFnsAndConfigFromOptions, whose actual code is as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">warn = options.<span class="property">warn</span> || baseWarn</span><br><span class="line"></span><br><span class="line">platformIsPreTag = options.<span class="property">isPreTag</span> || no</span><br><span class="line">platformMustUseProp = options.<span class="property">mustUseProp</span> || no</span><br><span class="line">platformGetTagNamespace = options.<span class="property">getTagNamespace</span> || no</span><br><span class="line"></span><br><span class="line">transforms = <span class="title function_">pluckModuleFunction</span>(options.<span class="property">modules</span>, <span class="string">&#x27;transformNode&#x27;</span>)</span><br><span class="line">preTransforms = <span class="title function_">pluckModuleFunction</span>(options.<span class="property">modules</span>, <span class="string">&#x27;preTransformNode&#x27;</span>)</span><br><span class="line">postTransforms = <span class="title function_">pluckModuleFunction</span>(options.<span class="property">modules</span>, <span class="string">&#x27;postTransformNode&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delimiters = options.<span class="property">delimiters</span></span><br></pre></td></tr></table></figure><p>These methods and configurations are required for subsequent analysis, and we don’t need to care about their specific functions. Let’s look back first.</p><h4 id="analysis"><a class="markdownIt-Anchor" href="#analysis"></a> Analysis</h4><p>Corresponding pseudocode:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseHTML</span>(template, options)</span><br></pre></td></tr></table></figure><p>The parsing of the template is mainly through the parseHTML function, which is defined in src/compiler/parser/html-parser:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parseHTML</span> (html, options) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastTag</span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !<span class="title function_">isPlainTextElement</span>(lastTag))&#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.<span class="title function_">indexOf</span>(<span class="string">&#x27;&lt;&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> (textEnd = <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span>(matchComment) &#123;</span><br><span class="line">           <span class="title function_">advance</span>(commentLength)</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(matchDoctype) &#123;</span><br><span class="line">           <span class="title function_">advance</span>(doctypeLength)</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(matchEndTag) &#123;</span><br><span class="line">           <span class="title function_">advance</span>(endTagLength)</span><br><span class="line">           <span class="title function_">parseEndTag</span>()</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span>(matchStartTag) &#123;</span><br><span class="line">           <span class="title function_">parseStartTag</span>()</span><br><span class="line">           <span class="title function_">handleStartTag</span>()</span><br><span class="line">           <span class="keyword">continue</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">handleText</span>()</span><br><span class="line">      <span class="title function_">advance</span>(textLength)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="title function_">handlePlainTextElement</span>()</span><br><span class="line">       <span class="title function_">parseEndTag</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Since the logic of’parseHTML ‘is also very complex, so I also used the pseudocode way of expression, the overall logic is to loop parsing’template’, using regular to do a variety of matching, for different cases were treated differently, until the entire template is parsed.<br> During the matching process, the’advance 'function will be used to continuously advance the entire template string until the end of the string.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">advance</span> (n) &#123;</span><br><span class="line">  index += n</span><br><span class="line">  html = html.<span class="title function_">substring</span>(n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The entire matching process is divided into the following steps:</p><ul><li>Find the position of the first left angle bracket. If it is 0, it indicates that it is a label and enters the processing flow of the label. If not, it indicates that the angle bracket is in a certain string and enters the handlePlainTextElement () process</li><li>If it is a label, determine whether it is a comment node, if it is a comment node, skip the comment part</li><li>if it is doctype, skip</li><li>if it is a closing tag, i.e.</li></ul></div>, advance the tag length and process the closing tag<li>If it is the start label, the forward label length, perform handleStartTag (), this function first creates a ast node out, the second is to push the current label and assign it to lastTag, why push the stack? It is to show that all labels are closed if the same label pops up from the stack when the closed label is processed in the previous step, and finally the stack is empty after the html compile is completed.</li><p>Of course, this process is a very simple introduction, which hides a lot of details. If you are interested, you can take a look at the source code for yourself.</p><h3 id="optimize-2"><a class="markdownIt-Anchor" href="#optimize-2"></a> optimize</h3><p>Take a look at the definition of the’optimize ‘method, in’src/compiler/optimizer.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Goal of the optimizer: walk the generated template AST tree</span></span><br><span class="line"><span class="comment"> * and detect sub-trees that are purely static, i.e. parts of</span></span><br><span class="line"><span class="comment"> * the DOM that never needs to change.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Once we detect these sub-trees, we can:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Hoist them into constants, so that we no longer need to</span></span><br><span class="line"><span class="comment"> *    create fresh nodes for them on each re-render;</span></span><br><span class="line"><span class="comment"> * 2. Completely skip them in the patching process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">optimize</span> (<span class="attr">root</span>: ?<span class="title class_">ASTElement</span>, <span class="attr">options</span>: <span class="title class_">CompilerOptions</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!root) <span class="keyword">return</span></span><br><span class="line">  isStaticKey = <span class="title function_">genStaticKeysCached</span>(options.<span class="property">staticKeys</span> || <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  isPlatformReservedTag = options.<span class="property">isReservedTag</span> || no</span><br><span class="line">  <span class="comment">// first pass: mark all non-static nodes.</span></span><br><span class="line">  <span class="title function_">markStatic</span>(root)</span><br><span class="line">  <span class="comment">// second pass: mark static roots.</span></span><br><span class="line">  <span class="title function_">markStaticRoots</span>(root, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">genStaticKeys</span> (<span class="attr">keys</span>: string): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">makeMap</span>(</span><br><span class="line">    <span class="string">&#x27;type,tag,attrsList,attrsMap,plain,parent,children,attrs&#x27;</span> +</span><br><span class="line">    (keys ? <span class="string">&#x27;,&#x27;</span> + keys : <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>We can optimize some AST nodes into static nodes in the compile stage, so the whole process of’optimize ‘actually does two things,’ markStatic (root) ‘marks the static node,’ markStaticRoots (root, false) 'marks the static root.</p><h4 id="mark-static-node"><a class="markdownIt-Anchor" href="#mark-static-node"></a> Mark static node</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markStatic</span> (<span class="attr">node</span>: <span class="title class_">ASTNode</span>) &#123;</span><br><span class="line">  node.<span class="property">static</span> = <span class="title function_">isStatic</span>(node)</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> = <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// do not make component slot content static. this avoids</span></span><br><span class="line">    <span class="comment">// 1. components not able to mutate slot nodes</span></span><br><span class="line">    <span class="comment">// 2. static slot content fails for hot-reloading</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !<span class="title function_">isPlatformReservedTag</span>(node.<span class="property">tag</span>) &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> ! <span class="string">&#x27;slot&#x27;</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">attrsMap</span>[<span class="string">&#x27;inline-template&#x27;</span>]  <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = node.<span class="property">children</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> child = node.<span class="property">children</span>[i]</span><br><span class="line">      <span class="title function_">markStatic</span>(child)</span><br><span class="line">      <span class="keyword">if</span> (!child.<span class="property">static</span>) &#123;</span><br><span class="line">        node.<span class="property">static</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">ifConditions</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, l = node.<span class="property">ifConditions</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> block = node.<span class="property">ifConditions</span>[i].<span class="property">block</span></span><br><span class="line">        <span class="title function_">markStatic</span>(block)</span><br><span class="line">        <span class="keyword">if</span> (!block.<span class="property">static</span>) &#123;</span><br><span class="line">          node.<span class="property">static</span> = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isStatic</span> (<span class="attr">node</span>: <span class="title class_">ASTNode</span>): boolean &#123;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> = <span class="number">2</span>) &#123; <span class="comment">// expression</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> = <span class="number">3</span>) &#123; <span class="comment">// text</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !!(node.<span class="property">pre</span> || (</span><br><span class="line">    !node.<span class="property">hasBindings</span> &amp;&amp; <span class="comment">// no dynamic bindings</span></span><br><span class="line">    !node.<span class="property">if</span> &amp;&amp; !node.<span class="property">for</span> &amp;&amp; <span class="comment">// not v-if or v-for or v-else</span></span><br><span class="line">    !<span class="title function_">isBuiltInTag</span>(node.<span class="property">tag</span>) &amp;&amp; <span class="comment">// not a built-in</span></span><br><span class="line">    <span class="title function_">isPlatformReservedTag</span>(node.<span class="property">tag</span>) &amp;&amp; <span class="comment">// not a component</span></span><br><span class="line">    !<span class="title function_">isDirectChildOfTemplateFor</span>(node) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(node).<span class="title function_">every</span>(isStaticKey)</span><br><span class="line">  ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>First execute node.static = isStatic (node)</p><p>'isStatic ‘is a judgment on whether an AST element node is static. If it is an expression, it is non-static; if it is plain text, it is static; for an ordinary element, if it has a pre attribute, then it uses the’v-pre’ directive, which is static, otherwise the following conditions must be met at the same time: no’v-if ‘,’ v-for ‘, no other directives (excluding’v-once’), non-built-in components, platform-reserved labels, non-template tags with’v-for ’ Direct sub-node, the’key 'of all attributes of the node satisfies the static key; if these are satisfied, then this AST node is a static node.</p><p>If this node is an ordinary element, then traverse all its children and recursion executes markStatic. Because all elseif and else nodes are not in children, if the ifConditions of the node is not null, then traverse ifConditions to get the block in all conditions, which is their corresponding AST node, and recursion executes markStatic. During these recursions, whenever a sub-node is not static, the static of its parent becomes false.</p><h4 id="mark-static-root"><a class="markdownIt-Anchor" href="#mark-static-root"></a> Mark static root</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markStaticRoots</span> (<span class="attr">node</span>: <span class="title class_">ASTNode</span>, <span class="attr">isInFor</span>: boolean) &#123;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> = <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">static</span> || node.<span class="property">once</span>) &#123;</span><br><span class="line">      node.<span class="property">staticInFor</span> = isInFor</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// For a node to qualify as a static root, it should have children that</span></span><br><span class="line">    <span class="comment">// are not just static text. Otherwise the cost of hoisting out will</span></span><br><span class="line">    <span class="comment">// outweigh the benefits and it&#x27;s better off to just always render it fresh.</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">static</span> &amp;&amp; node.<span class="property">children</span>.<span class="property">length</span> &amp;&amp; !(</span><br><span class="line">      node.<span class="property">children</span>.<span class="property">length</span> = <span class="number">1</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">children</span>[<span class="number">0</span>].<span class="property">type</span> = <span class="number">3</span></span><br><span class="line">    )) &#123;</span><br><span class="line">      node.<span class="property">staticRoot</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      node.<span class="property">staticRoot</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = node.<span class="property">children</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="title function_">markStaticRoots</span>(node.<span class="property">children</span>[i], isInFor || !!node.<span class="property">for</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">ifConditions</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, l = node.<span class="property">ifConditions</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="title function_">markStaticRoots</span>(node.<span class="property">ifConditions</span>[i].<span class="property">block</span>, isInFor)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The second parameter of markStaticRoots is isInFor. For nodes that are already static or v-once, node.staticInFor = isInFor.<br> Then there is the judgment logic for’staticRoot ‘. From the comments, we can see that for nodes eligible to be’staticRoot’, in addition to being a static node themselves, they must satisfy the need to have’children ‘, and’children’ cannot be just a text node, otherwise the benefits of marking it as a static root node are very small.</p><p>Next, as with the logic for marking static nodes, iterate over’children ‘and’ifConditions’, and recursion executes’markStaticRoots’.</p><h3 id="codegen-2"><a class="markdownIt-Anchor" href="#codegen-2"></a> codegen</h3><p>The’generate ‘function is defined in’src/compiler/codegen/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generate</span> (</span><br><span class="line">  <span class="attr">ast</span>: <span class="title class_">ASTElement</span> | <span class="keyword">void</span>,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">CompilerOptions</span></span><br><span class="line">): <span class="title class_">CodegenResult</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="keyword">new</span> <span class="title class_">CodegenState</span>(options)</span><br><span class="line">  <span class="keyword">const</span> code = ast ? <span class="title function_">genElement</span>(ast, state) : <span class="string">&#x27;_c(&quot;div&quot;)&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">render</span>: <span class="string">`with(this)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: state.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The’generate ‘function first generates’code’ with’genElement (ast, state) ‘, and then wraps’code’ with’with (this) {return ${code}}} ‘. Here’state’ is an instance of’CodegenState ‘, which we will introduce later when we use it. Let’s take a look at’genElement’ first:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">genElement</span> (<span class="attr">el</span>: <span class="title class_">ASTElement</span>, <span class="attr">state</span>: <span class="title class_">CodegenState</span>): string &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">staticRoot</span> &amp;&amp; !el.<span class="property">staticProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genStatic</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">once</span> &amp;&amp; !el.<span class="property">onceProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genOnce</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">for</span> &amp;&amp; !el.<span class="property">forProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genFor</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">if</span> &amp;&amp; !el.<span class="property">ifProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genIf</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> = <span class="string">&#x27;template&#x27;</span> &amp;&amp; !el.<span class="property">slotTarget</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genChildren</span>(el, state) || <span class="string">&#x27;void 0&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> = <span class="string">&#x27;slot&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genSlot</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// component or element</span></span><br><span class="line">    <span class="keyword">let</span> code</span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">component</span>) &#123;</span><br><span class="line">      code = <span class="title function_">genComponent</span>(el.<span class="property">component</span>, el, state)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = el.<span class="property">plain</span> ? <span class="literal">undefined</span> : <span class="title function_">genData</span>(el, state)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> children = el.<span class="property">inlineTemplate</span> ? <span class="literal">null</span> : <span class="title function_">genChildren</span>(el, state, <span class="literal">true</span>)</span><br><span class="line">      code = <span class="string">`_c(&#x27;<span class="subst">$&#123;el.tag&#125;</span>&#x27;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // data</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // children</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>)`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// module transforms</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.<span class="property">transforms</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      code = state.<span class="property">transforms</span>[i](el, code)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Basically, it is to determine the attributes of the current AST element node to perform different code generation functions.</p><h2 id="slot"><a class="markdownIt-Anchor" href="#slot"></a> slot</h2><p>The above source code analysis part omits a lot of details, some are related to html parsing, such as parseHTML function only writes pseudo-code, some are related to vue syntax sugar processing, such as codegen only writes genIF, genSlot, what exactly does not say, here we use slot as an example, others need you can see for yourself.</p><p>Let’s start with compile. We know that compile occurs when’vm. $mount 'is called, so the order of compile is to compile the parent component first, and then compile the child components.</p><p>First compile the parent component. In the’parse ‘stage, the’processSlot’ will be executed to process the’slot ‘, which is defined in’src/compiler/parser/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processSlot</span> (el) &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">tag</span> = <span class="string">&#x27;slot&#x27;</span>) &#123;</span><br><span class="line">    el.<span class="property">slotName</span> = <span class="title function_">getBindingAttr</span>(el, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; el.<span class="property">key</span>) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">`\`key\` does not work on &lt;slot&gt; because slots are abstract outlets `</span> +</span><br><span class="line">        <span class="string">`and can possibly expand into multiple elements. `</span> +</span><br><span class="line">        <span class="string">`Use the key on a wrapping element instead.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> slotScope</span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">tag</span> = <span class="string">&#x27;template&#x27;</span>) &#123;</span><br><span class="line">      slotScope = <span class="title function_">getAndRemoveAttr</span>(el, <span class="string">&#x27;scope&#x27;</span>)</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; slotScope) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`the &quot;scope&quot; attribute for scoped slots have been deprecated and `</span> +</span><br><span class="line">          <span class="string">`replaced by &quot;slot-scope&quot; since 2.5. The new &quot;slot-scope&quot; attribute `</span> +</span><br><span class="line">          <span class="string">`can also be used on plain elements in addition to &lt;template&gt; to `</span> +</span><br><span class="line">          <span class="string">`denote scoped slots.`</span>,</span><br><span class="line">          <span class="literal">true</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      el.<span class="property">slotScope</span> = slotScope || <span class="title function_">getAndRemoveAttr</span>(el, <span class="string">&#x27;slot-scope&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((slotScope = <span class="title function_">getAndRemoveAttr</span>(el, <span class="string">&#x27;slot-scope&#x27;</span>))) &#123;</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; el.<span class="property">attrsMap</span>[<span class="string">&#x27;v-for&#x27;</span>]) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Ambiguous combined usage of slot-scope and v-for on &lt;<span class="subst">$&#123;el.tag&#125;</span>&gt; `</span> +</span><br><span class="line">          <span class="string">`(v-for takes higher priority). Use a wrapper &lt;template&gt; for the `</span> +</span><br><span class="line">          <span class="string">`scoped slot to make it clearer.`</span>,</span><br><span class="line">          <span class="literal">true</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      el.<span class="property">slotScope</span> = slotScope</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> slotTarget = <span class="title function_">getBindingAttr</span>(el, <span class="string">&#x27;slot&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (slotTarget) &#123;</span><br><span class="line">      el.<span class="property">slotTarget</span> = slotTarget = <span class="string">&#x27;&quot;&quot;&#x27;</span> ? <span class="string">&#x27;&quot;default&quot;&#x27;</span> : slotTarget</span><br><span class="line">      <span class="comment">// preserve slot as an attribute for native shadow DOM compat</span></span><br><span class="line">      <span class="comment">// only for non-scoped slots.</span></span><br><span class="line">      <span class="keyword">if</span> (el.<span class="property">tag</span> ! <span class="string">&#x27;template&#x27;</span> &amp;&amp; !el.<span class="property">slotScope</span>) &#123;</span><br><span class="line">        addAttr (el, <span class="string">&#x27;slot&#x27;</span>, slotTarget)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When it parses to the’slot ‘attribute on the label, the corresponding AST will be given.<br> The element node adds the’slotTarget ‘attribute, and then in the’codegen’ stage, the’slotTarget ‘will be processed in’genData’, and the relevant code is in’src/compiler/codegen/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.<span class="property">slotTarget</span> &amp;&amp; !el.<span class="property">slotScope</span>) &#123;</span><br><span class="line">  data += <span class="string">`slot:<span class="subst">$&#123;el.slotTarget&#125;</span>,`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Will add a’slot ‘property to’data’ and point to’slotTarget ', which will be used later. In our example, the code generated by the parent component is as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_c</span>(<span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">    [<span class="title function_">_c</span>(<span class="string">&#x27;app-layout&#x27;</span>,</span><br><span class="line">      [<span class="title function_">_c</span>(<span class="string">&#x27;h1&#x27;</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">&quot;slot&quot;</span>:<span class="string">&quot;header&quot;</span>&#125;,<span class="attr">slot</span>:<span class="string">&quot;header&quot;</span>&#125;,</span><br><span class="line">         [<span class="title function_">_v</span>(<span class="title function_">_s</span>(title))]),</span><br><span class="line">       <span class="title function_">_c</span>(<span class="string">&#x27;p&#x27;</span>,[<span class="title function_">_v</span>(<span class="title function_">_s</span>(msg))]),</span><br><span class="line">       <span class="title function_">_c</span>(<span class="string">&#x27;p&#x27;</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">&quot;slot&quot;</span>:<span class="string">&quot;footer&quot;</span>&#125;,<span class="attr">slot</span>:<span class="string">&quot;footer&quot;</span>&#125;,</span><br><span class="line">         [<span class="title function_">_v</span>(<span class="title function_">_s</span>(desc))]</span><br><span class="line">         )</span><br><span class="line">       ])</span><br><span class="line">     ],</span><br><span class="line">   <span class="number">1</span>)&#125;</span><br></pre></td></tr></table></figure><p>Next compile subcomponent, also in the’parser ‘stage will execute the’processSlot’ processing function, which is defined in’src/compiler/parser/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processSlot</span> (el) &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">tag</span> = <span class="string">&#x27;slot&#x27;</span>) &#123;</span><br><span class="line">    el.<span class="property">slotName</span> = <span class="title function_">getBindingAttr</span>(el, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When the’slot ‘tag is encountered, the’slotName’ attribute will be added to the corresponding AST element node, and then in the’codegen ‘phase, it will determine if the current AST element node is a’slot’ tag, then execute the’genSlot ‘function, which is defined in’src/compiler/codegen/index.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genSlot</span> (<span class="attr">el</span>: <span class="title class_">ASTElement</span>, <span class="attr">state</span>: <span class="title class_">CodegenState</span>): string &#123;</span><br><span class="line">  <span class="keyword">const</span> slotName = el.<span class="property">slotName</span> || <span class="string">&#x27;&quot;default&quot;&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> children = <span class="title function_">genChildren</span>(el, state)</span><br><span class="line">  <span class="keyword">let</span> res = <span class="string">`_t(<span class="subst">$&#123;slotName&#125;</span><span class="subst">$&#123;children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span></span><br><span class="line">  <span class="keyword">const</span> attrs = el.<span class="property">attrs</span> &amp;&amp; <span class="string">`&#123;<span class="subst">$&#123;el.attrs.map(a =&gt; <span class="string">`<span class="subst">$&#123;camelize(a.name)&#125;</span>:<span class="subst">$&#123;a.value&#125;</span>`</span>).join(<span class="string">&#x27;,&#x27;</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">const</span> bind = el.<span class="property">attrsMap</span>[<span class="string">&#x27;v-bind&#x27;</span>]</span><br><span class="line">  <span class="keyword">if</span> ((attrs || bind) &amp;&amp; !children) &#123;</span><br><span class="line">    res += <span class="string">`,null`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (attrs) &#123;</span><br><span class="line">    res += <span class="string">`,<span class="subst">$&#123;attrs&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (bind) &#123;</span><br><span class="line">    res += <span class="string">&#x27;$&#123;attrs ? &quot; : &#x27;</span>,<span class="literal">null</span><span class="string">&#x27;&#125;,$&#123;bind&#125;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res + <span class="string">&#x27;)&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let’s not consider the case of’attrs’ and’v-bind ‘on the’slot’ tag for now, so the code it generates is actually only:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> slotName = el.<span class="property">slotName</span> || <span class="string">&#x27;&quot;default&quot;&#x27;</span></span><br><span class="line"><span class="keyword">const</span> children = <span class="title function_">genChildren</span>(el, state)</span><br><span class="line"><span class="keyword">let</span> res = <span class="string">`_t(<span class="subst">$&#123;slotName&#125;</span><span class="subst">$&#123;children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span></span><br></pre></td></tr></table></figure><p>The’slotName ‘here is taken from the property corresponding to the AST element node, the default is’default’, and’children ‘corresponds to the content wrapped in the beginning and closing tags of the’slot’. Take a look at the code finally generated by the subcomponent of our example, as follows:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">with</span>(<span class="params"><span class="variable language_">this</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_c</span>(<span class="string">&#x27;div&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">staticClass</span>:<span class="string">&quot;container&quot;</span></span><br><span class="line">    &#125;,[</span><br><span class="line">      <span class="title function_">_c</span>(<span class="string">&#x27;header&#x27;</span>,[<span class="title function_">_t</span>(<span class="string">&quot;header&quot;</span>)],<span class="number">2</span>),</span><br><span class="line">      _c (<span class="string">&#x27;main&#x27;</span>, [_t (<span class="string">&quot;default&quot;</span>, [_v (<span class="string">&quot;default content&quot;</span>) ]) ], <span class="number">2</span>),</span><br><span class="line">      <span class="title function_">_c</span>(<span class="string">&#x27;footer&#x27;</span>,[<span class="title function_">_t</span>(<span class="string">&quot;footer&quot;</span>)],<span class="number">2</span>)</span><br><span class="line">      ]</span><br><span class="line">   )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the compile section, we learned that the _t function corresponds to the renderSlot method, which is defined in src/core/instance/render-heplpers/render-slot.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for rendering &lt;slot&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">renderSlot</span> (</span><br><span class="line">  <span class="attr">name</span>: string,</span><br><span class="line">  <span class="attr">fallback</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">  <span class="attr">props</span>: ?<span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">bindObject</span>: ?<span class="title class_">Object</span></span><br><span class="line">): ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> scopedSlotFn = <span class="variable language_">this</span>.<span class="property">$scopedSlots</span>[name]</span><br><span class="line">  <span class="keyword">let</span> nodes</span><br><span class="line">  <span class="keyword">if</span> (scopedSlotFn) &#123; <span class="comment">// scoped slot</span></span><br><span class="line">    props = props || &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (bindObject) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; !<span class="title function_">isObject</span>(bindObject)) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">&#x27;slot v-bind without argument expects an Object&#x27;</span>,</span><br><span class="line">          <span class="variable language_">this</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      props = <span class="title function_">extend</span>(<span class="title function_">extend</span>(&#123;&#125;, bindObject), props)</span><br><span class="line">    &#125;</span><br><span class="line">    nodes = <span class="title function_">scopedSlotFn</span>(props) || fallback</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> slotNodes = <span class="variable language_">this</span>.<span class="property">$slots</span>[name]</span><br><span class="line">    <span class="comment">// warn duplicate slot usage</span></span><br><span class="line">    <span class="keyword">if</span> (slotNodes) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> ! <span class="string">&#x27;production&#x27;</span> &amp;&amp; slotNodes.<span class="property">_rendered</span>) &#123;</span><br><span class="line">        <span class="title function_">warn</span>(</span><br><span class="line">          <span class="string">`Duplicate presence of slot &quot;<span class="subst">$&#123;name&#125;</span>&quot; found in the same render tree `</span> +</span><br><span class="line">          <span class="string">`- this will likely cause render errors.`</span>,</span><br><span class="line">          <span class="variable language_">this</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      slotNodes.<span class="property">_rendered</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    nodes = slotNodes || fallback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> target = props &amp;&amp; props.<span class="property">slot</span></span><br><span class="line">  <span class="keyword">if</span> (target) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.$createElement(<span class="string">&#x27;template&#x27;</span>, &#123; <span class="attr">slot</span>: target &#125;, nodes)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nodes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The parameter “name” of “render-slot” represents the slot name “slotName”, and “fallback” represents the “vnode” array generated by the default content of the slot. Ignore “scoped-slot” for now, and only look at the default slot logic. If “this. $slot [name]” has a value, return its corresponding “vnode” array, otherwise return “fallback”. So where did this. $slot &quot;come from? We know that the’init ‘timing of the subcomponent is when the parent component executes the’patch’ process, and the parent component has already compiled at this time. And the subcomponent will execute the’initRender ‘function during the’init’ process, and get the’vm. $slot ‘when the’initRender’ is performed, and the relevant code is in’src/core/instance/render.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initRender</span> (<span class="attr">vm</span>: <span class="title class_">Component</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> parentVnode = vm.<span class="property">$vnode</span> = options.<span class="property">_parentVnode</span> <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">const</span> renderContext = parentVnode &amp;&amp; parentVnode.<span class="property">context</span></span><br><span class="line">  vm.<span class="property">$slots</span> = <span class="title function_">resolveSlots</span>(options.<span class="property">_renderChildren</span>, renderContext)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>‘Vm. $slots’ is returned by executing’resolveSlots (options._renderChildren, renderContext) ‘, which is defined in’src/core/instance/render-helpers/resolve-slots.js’:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Runtime helper for resolving raw children VNodes into a slot object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveSlots</span> (</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">  <span class="attr">context</span>: ?<span class="title class_">Component</span></span><br><span class="line">): &#123; [<span class="attr">key</span>: string]: <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#125; &#123;</span><br><span class="line">  <span class="keyword">const</span> slots = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (!children) &#123;</span><br><span class="line">    <span class="keyword">return</span> slots</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = children.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> child = children[i]</span><br><span class="line">    <span class="keyword">const</span> data = child.<span class="property">data</span></span><br><span class="line">    <span class="comment">// remove slot attribute if the node is resolved as a Vue slot node</span></span><br><span class="line">    <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">attrs</span> &amp;&amp; data.<span class="property">attrs</span>.<span class="property">slot</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> data.<span class="property">attrs</span>.<span class="property">slot</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// named slots should only be respected if the vnode was rendered in the</span></span><br><span class="line">    <span class="comment">// same context.</span></span><br><span class="line">    <span class="keyword">if</span> ((child.<span class="property">context</span> = context || child.<span class="property">fnContext</span> = context) &amp;&amp;</span><br><span class="line">      data &amp;&amp; data.<span class="property">slot</span> != <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = data.<span class="property">slot</span></span><br><span class="line">      <span class="keyword">const</span> slot = (slots[name] || (slots[name] = []))</span><br><span class="line">      <span class="keyword">if</span> (child.<span class="property">tag</span> = <span class="string">&#x27;template&#x27;</span>) &#123;</span><br><span class="line">        slot.<span class="property">push</span>.<span class="title function_">apply</span>(slot, child.<span class="property">children</span> || [])</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        slot.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      (slots.<span class="property">default</span> || (slots.<span class="property">default</span> = [])).<span class="title function_">push</span>(child)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ignore slots that contains only whitespace</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> slots) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slots[name].<span class="title function_">every</span>(isWhitespace)) &#123;</span><br><span class="line">      <span class="keyword">delete</span> slots[name]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> slots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The resolveSlots method takes 2 parameters. The first parameter chilren corresponds to the children of the parent vnode, which in our case is the contents of the wraps &lt; app-layout &gt; and . The second parameter context is the context of the parent vnode, which is the vm instance of the parent component.</p><p>The logic of the resolveSlots function is to traverse the chilren, get the data of each child, and then get the slot name through data.slot, which is the data.slot set by the compile parent component in the codegen stage. Then add’child ‘to’slots’ with the slot name’key ‘. If’data.slot’ does not exist, it is the content of the default slot, and add the corresponding’child ‘to’slots.defaults’. This gets the entire’slots’, which is an object, ‘key’ is the slot name, and’value ‘is an array of type’vnode’, because it can have multiple slots with the same name.</p><p>In this way, we get the’vm. $slots’, return to the’renderSlot ‘function,’ const slotNodes = this. $slots [name] ‘, and we can also get the corresponding’vnode’ array according to the slot name. The’vnode 'in this array is created in the parent component, so that the content of the child component slot is replaced in the parent group.</p><p>The corresponding’slot ‘is rendered as’vnodes’, and the’children ‘of the’vnode’ are rendered as the current component. The subsequent rendering process has been analyzed before and will not be repeated.</p></article></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/posts/90452f87/" title="Vue Source Learning (7) Compiler Principle">https://sunra.top/en/posts/90452f87/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/posts/f7e2a78f/" rel="prev" title="Four basic algorithm ideas"><i class="fa fa-chevron-left"></i> Four basic algorithm ideas</a></div><div class="post-nav-item"> <a href="/en/posts/7a981791/" rel="next" title="Element UI Table tree component lazy loading problem fix">Element UI Table tree component lazy loading problem fix<i class="fa fa-chevron-right"></i></a></div></div></footer></div><div class="comments" id="waline"></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/posts/90452f87/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>