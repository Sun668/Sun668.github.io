<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="In the previous article, when analyzing the Babel compilation process, we mentioned that Babel converts JS code into ASTs (Abstract Syntax Trees). This behavior is a generic one, no matter what progra"><meta property="og:type" content="article"><meta property="og:title" content="In-depth Babel Principle Series (II) Parser Code Structure Introduction"><meta property="og:url" content="https://sunra.top/en/2021/06/28/babel-parser-introduction/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="In the previous article, when analyzing the Babel compilation process, we mentioned that Babel converts JS code into ASTs (Abstract Syntax Trees). This behavior is a generic one, no matter what progra"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625014272/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210630085034_nq6abs.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625100732/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210701085141_jdhpvd.png"><meta property="og:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625101028/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210701085657_sxvzrs.png"><meta property="article:published_time" content="2021-06-28T00:09:12.000Z"><meta property="article:modified_time" content="2024-12-06T04:55:07.459Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625014272/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210630085034_nq6abs.png"><link rel="canonical" href="https://sunra.top/en/2021/06/28/babel-parser-introduction/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2021/06/28/babel-parser-introduction/","path":"2021/06/28/babel-parser-introduction/","title":"In-depth Babel Principle Series (II) Parser Code Structure Introduction"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>In-depth Babel Principle Series (II) Parser Code Structure Introduction | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#entrance"><span class="nav-number">1.</span> <span class="nav-text">Entrance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parser-parsing-process"><span class="nav-number">2.</span> <span class="nav-text">Parser parsing process</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1enterinitialscopes"><span class="nav-number">2.1.</span> <span class="nav-text">1.enterInitialScopes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-startnode"><span class="nav-number">2.2.</span> <span class="nav-text">2. startNode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-nexttoken"><span class="nav-number">2.3.</span> <span class="nav-text">3. nextToken</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-parsetoplevel"><span class="nav-number">2.4.</span> <span class="nav-text">4. parseTopLevel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#summary"><span class="nav-number">2.5.</span> <span class="nav-text">Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nexttoken-method-analysis"><span class="nav-number">3.</span> <span class="nav-text">nextToken method analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#readtmpltoken-reads-the-template-string"><span class="nav-number">3.1.</span> <span class="nav-text">readTmplToken reads the template string</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gettokenfromcode"><span class="nav-number">3.2.</span> <span class="nav-text">getTokenFromCode</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#charcodes"><span class="nav-number">3.2.1.</span> <span class="nav-text">charcodes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tokentype"><span class="nav-number">3.2.2.</span> <span class="nav-text">TokenType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function-logic"><span class="nav-number">3.2.3.</span> <span class="nav-text">Function Logic</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parsetoplevel-method-analysis"><span class="nav-number">4.</span> <span class="nav-text">parseTopLevel method analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#parsestatement"><span class="nav-number">4.1.</span> <span class="nav-text">parseStatement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parsestatementcontent"><span class="nav-number">4.2.</span> <span class="nav-text">parseStatementContent</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2021/06/28/babel-parser-introduction/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="In-depth Babel Principle Series (II) Parser Code Structure Introduction | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> In-depth Babel Principle Series (II) Parser Code Structure Introduction</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-06-28 08:09:12" itemprop="dateCreated datePublished" datetime="2021-06-28T08:09:12+08:00">2021-06-28</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-12-06 12:55:07" itemprop="dateModified" datetime="2024-12-06T12:55:07+08:00">2024-12-06</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Babel/" itemprop="url" rel="index"><span itemprop="name">Babel</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2021/06/28/babel-parser-introduction/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2021/06/28/babel-parser-introduction/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>In the previous article, when analyzing the Babel compilation process, we mentioned that Babel converts JS code into ASTs (Abstract Syntax Trees). This behavior is a generic one, no matter what programming language parses the source code into an AST, <strong>AST is not specific to Babel, let alone to JS</strong>.</p><p>Why do we need to do this? The original JS file is incomprehensible to the computer, and it is difficult for the computer to modify the JS code directly, but by converting it to an AST, which is essentially a set of objects that represent the structure of the program, we can indirectly modify the code by modifying the objects. AST to generate bytecode.</p><p>Parser’s process is divided into two steps, the first step, lexical analysis, which is the finite state machine in the compilation principle, to split a piece of code into individual Tokens, and the second step, syntax analysis, to convert the Token array, into an AST tree.</p><p>This time I’ll look at<a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/babel/babel/tree/main/packages/babel-parser">源码</a>The process is briefly analyzed.</p><span id="more"></span><p>First, take a look at the directory structure of Babel-Parser</p><p>There are four main folders, util, plugins, tokeinzer, parser</p><h2 id="entrance"><a class="markdownIt-Anchor" href="#entrance"></a> Entrance</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">input: string, options?: Options</span>): <span class="title class_">File</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (options?.<span class="property">sourceType</span>= <span class="string">&quot;unambiguous&quot;</span>) &#123;</span><br><span class="line">    options = &#123;</span><br><span class="line">      ...options,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      options.<span class="property">sourceType</span> = <span class="string">&quot;module&quot;</span>;</span><br><span class="line">      <span class="keyword">const</span> parser = <span class="title function_">getParser</span>(options, input);</span><br><span class="line">      <span class="keyword">const</span> ast = parser.<span class="title function_">parse</span>();</span><br><span class="line">        </span><br><span class="line">      <span class="comment">//Omit some other codes</span></span><br><span class="line">        </span><br><span class="line">      <span class="keyword">return</span> ast;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (moduleError) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        options.<span class="property">sourceType</span> = <span class="string">&quot;script&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getParser</span>(options, input).<span class="title function_">parse</span>();</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> moduleError;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getParser</span>(options, input).<span class="title function_">parse</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The core of this code is to get a parser through the <code>getParser</code> method, and then use the obtained parser to parse.</p><p>Let’s look at this <code>getParser</code> again:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getParser</span>(<span class="params">options: ?Options, input: string</span>): <span class="title class_">Parser</span> &#123;</span><br><span class="line">  <span class="comment">// Get Parser</span></span><br><span class="line">  <span class="keyword">let</span> cls = <span class="title class_">Parser</span>;</span><br><span class="line">  <span class="comment">// If a plugin is declared in options, first check whether the way the plugin is declared is reasonable, and if so, enable the plugin function</span></span><br><span class="line">  <span class="comment">// Yes, enable the plug-in function, Parser&#x27;s plug-ins are built-in, and you can only choose whether to enable them through the configuration</span></span><br><span class="line">  <span class="keyword">if</span> (options?.<span class="property">plugins</span>) &#123;</span><br><span class="line">    <span class="title function_">validatePlugins</span>(options.<span class="property">plugins</span>);</span><br><span class="line">    cls = <span class="title function_">getParserClass</span>(options.<span class="property">plugins</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">cls</span>(options, input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">parserClassCache</span>: &#123; [<span class="attr">key</span>: string]: <span class="title class_">Class</span>&lt;<span class="title class_">Parser</span>&gt; &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Get a Parser class with plugins applied. */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getParserClass</span>(<span class="params">pluginsFromOptions: PluginList</span>): <span class="title class_">Class</span>&lt;<span class="title class_">Parser</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// mixinPluginNames is the name of all built-in plugins</span></span><br><span class="line">  <span class="keyword">const</span> pluginList = mixinPluginNames.<span class="title function_">filter</span>(<span class="function"><span class="params">name</span> =&gt;</span></span><br><span class="line">    <span class="title function_">hasPlugin</span>(pluginsFromOptions, name),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cache the current portfolio of plugins</span></span><br><span class="line">  <span class="keyword">const</span> key = pluginList.<span class="title function_">join</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> cls = parserClassCache[key];</span><br><span class="line">  <span class="keyword">if</span> (!cls) &#123;</span><br><span class="line">    cls = parser;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> pluginList) &#123;</span><br><span class="line">      cls = mixinPlugins[plugin](cls);</span><br><span class="line">    &#125;</span><br><span class="line">    parserClassCache[key] = cls;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="parser-parsing-process"><a class="markdownIt-Anchor" href="#parser-parsing-process"></a> Parser parsing process</h2><p>By now, we figured out the logic of the entry file, which is mainly two parts, the first part declares the Parser, and the second part, if the plug-in is configured, opens the plug-in function for the Parser.</p><p>Then let’s continue to look at Parser’s logic</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Parser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">StatementParser</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options: ?Options, input: string</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">parse</span>(): <span class="title class_">File</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">enterInitialScopes</span>();</span><br><span class="line">    <span class="keyword">const</span> file = <span class="variable language_">this</span>.<span class="title function_">startNode</span>();</span><br><span class="line">    <span class="keyword">const</span> program = <span class="variable language_">this</span>.<span class="title function_">startNode</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">nextToken</span>();</span><br><span class="line">    file.<span class="property">errors</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">parseTopLevel</span>(file, program);</span><br><span class="line">    file.<span class="property">errors</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">errors</span>;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The constructor is all about preparatory work, so don’t pay attention to it first, the main logic is still in this parse function</p><h3 id="1enterinitialscopes"><a class="markdownIt-Anchor" href="#1enterinitialscopes"></a> 1.enterInitialScopes</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">enterInitialScopes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> paramFlags = <span class="variable constant_">PARAM</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">hasPlugin</span>(<span class="string">&quot;topLevelAwait&quot;</span>) &amp;&amp; <span class="variable language_">this</span>.<span class="property">inModule</span>) &#123;</span><br><span class="line">      paramFlags |= <span class="variable constant_">PARAM_AWAIT</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">scope</span>.<span class="title function_">enter</span>(<span class="variable constant_">SCOPE_PROGRAM</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">prodParam</span>.<span class="title function_">enter</span>(paramFlags);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>This step is to initialize the root node at the beginning, along with the corresponding parameters and scopes</p><h3 id="2-startnode"><a class="markdownIt-Anchor" href="#2-startnode"></a> 2. startNode</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">startNode&lt;<span class="attr">T</span>: <span class="title class_">NodeType</span>&gt;(): T &#123;</span><br><span class="line">    <span class="comment">// $FlowIgnore</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">start</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startLoc</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="3-nexttoken"><a class="markdownIt-Anchor" href="#3-nexttoken"></a> 3. nextToken</h3><p>This part is the focus of the parsing, this part of the code will be more complex, the parsing process will have to parse backwards one character at a time, the use of finite state machine state transfer to determine the different states, and finally in reaching a certain state, to produce a token.</p><p>If the number 123456 is read as a 6, a numeric token is generated if it is followed by a space or a semicolon.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">nextToken</span>(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="comment">// curContext = this.state.context[this.state.context.length - 1];</span></span><br><span class="line">    <span class="keyword">const</span> curContext = <span class="variable language_">this</span>.<span class="title function_">curContext</span>();</span><br><span class="line">    <span class="comment">// The internal loop will keep skipping all spaces, such as spaces, tabs, etc.</span></span><br><span class="line">    <span class="keyword">if</span> (!curContext.<span class="property">preserveSpace</span>) <span class="variable language_">this</span>.<span class="title function_">skipSpace</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">start</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isLookahead</span>) <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startLoc</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="title function_">curPosition</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span> &gt;= <span class="variable language_">this</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">finishToken</span>(tt.<span class="property">eof</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (curContext= ct.<span class="property">template</span>) &#123;</span><br><span class="line">      <span class="comment">// Read the template string Token</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">readTmplToken</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Read a normal Token, codePointAtPos returns the ASCII code of the character at the pos position</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">getTokenFromCode</span>(<span class="variable language_">this</span>.<span class="title function_">codePointAtPos</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-parsetoplevel"><a class="markdownIt-Anchor" href="#4-parsetoplevel"></a> 4. parseTopLevel</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseTopLevel</span>(<span class="attr">file</span>: N.<span class="property">File</span>, <span class="attr">program</span>: N.<span class="property">Program</span>): N.<span class="property">File</span> &#123;</span><br><span class="line">    file.<span class="property">program</span> = <span class="variable language_">this</span>.<span class="title function_">parseProgram</span>(program);</span><br><span class="line">    file.<span class="property">comments</span> = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">comments</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">tokens</span>) file.<span class="property">tokens</span> = <span class="title function_">babel7CompatTokens</span>(<span class="variable language_">this</span>.<span class="property">tokens</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">finishNode</span>(file, <span class="string">&quot;File&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Here the call to <code>parseProgram</code> will continue</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseProgram</span>(</span><br><span class="line">    <span class="title class_">Program</span>,</span><br><span class="line">    <span class="attr">end</span>:<span class="title class_">TokenType</span> = tt.<span class="property">eof</span>,</span><br><span class="line">    <span class="attr">sourceType</span>: <span class="title class_">SourceType</span> = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">sourceType</span>,</span><br><span class="line">  ): N.<span class="property">Program</span> &#123;</span><br><span class="line">    program.<span class="property">sourceType</span> = sourceType;</span><br><span class="line">    program.<span class="property">interpreter</span> = <span class="variable language_">this</span>.<span class="title function_">parseInterpreterDirective</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">parseBlockBody</span>(program, <span class="literal">true</span>, <span class="literal">true</span>, end);</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">inModule</span> &amp;&amp;</span><br><span class="line">      !<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">allowUndeclaredExports</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">scope</span>.<span class="property">undefinedExports</span>.<span class="property">size</span> &gt; <span class="number">0</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> [name] <span class="keyword">of</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">this</span>.<span class="property">scope</span>.<span class="property">undefinedExports</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> pos = <span class="variable language_">this</span>.<span class="property">scope</span>.<span class="property">undefinedExports</span>.<span class="title function_">get</span>(name);</span><br><span class="line">        <span class="comment">// $FlowIssue</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">raise</span>(pos, <span class="title class_">Errors</span>.<span class="property">ModuleExportUndefined</span>, name);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">finishNode</span>&lt;N.<span class="property">Program</span>&gt;(program, <span class="string">&quot;Program&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Call <code>parseBlockBody</code> again</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseBlockBody</span>(</span><br><span class="line">    <span class="attr">node</span>: N.<span class="property">BlockStatementLike</span>,</span><br><span class="line">    <span class="attr">allowDirectives</span>: ?boolean,</span><br><span class="line">    <span class="attr">topLevel</span>: boolean,</span><br><span class="line">    <span class="attr">end</span>:<span class="title class_">TokenType</span>,</span><br><span class="line">    afterBlockParse?: <span class="function">(<span class="params">hasStrictModeDirective: boolean</span>) =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">  ): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> body = (node.<span class="property">body</span> = []);</span><br><span class="line">    <span class="keyword">const</span> directives = (node.<span class="property">directives</span> = []);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">parseBlockOrModuleBlockBody</span>(</span><br><span class="line">      body,</span><br><span class="line">      allowDirectives ? directives : <span class="literal">undefined</span>,</span><br><span class="line">      topLevel,</span><br><span class="line">      end,</span><br><span class="line">      afterBlockParse,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Continue to call <code>parseBlockOrModuleBlockBody</code> and eventually enter recursion, calling nextToken recursively through the parserStatement, next and other functions until the string passed in by the parser method at the beginning is completely parsed.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseBlockOrModuleBlockBody</span>(</span><br><span class="line">    <span class="attr">body</span>: N.<span class="property">Statement</span>[],</span><br><span class="line">    <span class="attr">directives</span>: ?(N.<span class="property">Directive</span>[]),</span><br><span class="line">    <span class="attr">topLevel</span>: boolean,</span><br><span class="line">    <span class="attr">end</span>:<span class="title class_">TokenType</span>,</span><br><span class="line">    afterBlockParse?: <span class="function">(<span class="params">hasStrictModeDirective: boolean</span>) =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">  ): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldStrict = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">strict</span>;</span><br><span class="line">    <span class="keyword">let</span> hasStrictModeDirective = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> parsedNonDirective = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="variable language_">this</span>.<span class="title function_">match</span>(end)) &#123;</span><br><span class="line">      <span class="keyword">const</span> stmt = <span class="variable language_">this</span>.<span class="title function_">parseStatement</span>(<span class="literal">null</span>, topLevel);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (directives &amp;&amp; !parsedNonDirective) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isValidDirective</span>(stmt)) &#123;</span><br><span class="line">          <span class="keyword">const</span> directive = <span class="variable language_">this</span>.<span class="title function_">stmtToDirective</span>(stmt);</span><br><span class="line">          directives.<span class="title function_">push</span>(directive);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            !hasStrictModeDirective &amp;&amp;</span><br><span class="line">            directive.<span class="property">value</span>.<span class="property">value</span>= <span class="string">&quot;use strict&quot;</span></span><br><span class="line">          ) &#123;</span><br><span class="line">            hasStrictModeDirective = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setStrict</span>(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parsedNonDirective = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// clear strict errors since the strict mode will not change within the block</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">strictErrors</span>.<span class="title function_">clear</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      body.<span class="title function_">push</span>(stmt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (afterBlockParse) &#123;</span><br><span class="line">      afterBlockParse.<span class="title function_">call</span>(<span class="variable language_">this</span>, hasStrictModeDirective);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!oldStrict) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setStrict</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="summary"><a class="markdownIt-Anchor" href="#summary"></a> Summary</h3><p>A simple diagram to represent, roughly, is this, omitting many details</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625014272/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210630085034_nq6abs.png" alt></p><h2 id="nexttoken-method-analysis"><a class="markdownIt-Anchor" href="#nexttoken-method-analysis"></a> nextToken method analysis</h2><h3 id="readtmpltoken-reads-the-template-string"><a class="markdownIt-Anchor" href="#readtmpltoken-reads-the-template-string"></a> readTmplToken reads the template string</h3><p>This is the state machine I analyzed from the code</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625100732/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210701085141_jdhpvd.png" alt></p><p>Let’s try it and see the results</p><p><img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1625101028/origin-of-ray/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210701085657_sxvzrs.png" alt></p><h3 id="gettokenfromcode"><a class="markdownIt-Anchor" href="#gettokenfromcode"></a> getTokenFromCode</h3><p>This function is not complex in terms of logic, but the conditions are particularly divided, because it is necessary to adapt a variety of different characters to determine, simply show the following:</p><h4 id="charcodes"><a class="markdownIt-Anchor" href="#charcodes"></a> charcodes</h4><p>The various charCodes used in the code are the contents of another repository, here is the link: <a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/xtuc/charcodes/blob/master/packages/charcodes/src/index.js">https://github.com/xtuc/charcodes/blob/master/packages/charcodes/src/index.js</a></p><h4 id="tokentype"><a class="markdownIt-Anchor" href="#tokentype"></a> TokenType</h4><p>And the parameters of finishToken are actually a built-in good TokenType, such as <code>tt.parentL</code> which is actually <code>parenL: new TokenType(&quot;(&quot;, &#123; beforeExpr, startsExpr &#125;),</code></p><p>These TokenTypes are all of babel’s built-in token types, and there are two sources of TokenTypes, one is built into the Tokenizer and the other is provided by the parser plugin, but as we said, the parser plugin is just an on/off switch for the user, so essentially, all of the TokenType is essentially built into babel-praser to begin with.</p><p>There are four main categories, one is the variable type, such as number, string, one is the symbol, such as brackets, colon and so on, one is the expression, such as equal to, greater than, and finally is the keyword, such as switch, case, etc.</p><h4 id="function-logic"><a class="markdownIt-Anchor" href="#function-logic"></a> Function Logic</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getTokenFromCode</span>(<span class="attr">code</span>: number): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">      <span class="comment">// The interpretation of a dot depends on whether it is followed</span></span><br><span class="line">      <span class="comment">// by a digit or another two dots.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> charCodes.<span class="property">dot</span>:</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">readToken_dot</span>();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Punctuation tokens.</span></span><br><span class="line">      <span class="keyword">case</span> charCodes.<span class="property">leftParenthesis</span>:</span><br><span class="line">        ++<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finishToken</span>(tt.<span class="property">parenL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> charCodes.<span class="property">rightParenthesis</span>:</span><br><span class="line">        ++<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finishToken</span>(tt.<span class="property">parenR</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> charCodes.<span class="property">semicolon</span>:</span><br><span class="line">        ++<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finishToken</span>(tt.<span class="property">semi</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> charCodes.<span class="property">comma</span>:</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Dozens of conditions are omitted here</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isIdentifierStart</span>(code)) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">readWord</span>(code);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="variable language_">this</span>.<span class="title function_">raise</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">pos</span>,</span><br><span class="line">      <span class="title class_">Errors</span>.<span class="property">InvalidOrUnexpectedToken</span>,</span><br><span class="line">      <span class="title class_">String</span>.<span class="title function_">fromCodePoint</span>(code),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="parsetoplevel-method-analysis"><a class="markdownIt-Anchor" href="#parsetoplevel-method-analysis"></a> parseTopLevel method analysis</h2><p>At the beginning of the process analysis, we are going to see that the main logic of this function is in the <code>parseBlockOrModuleBlockBody</code> function, so let’s take a look at this function first</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseBlockOrModuleBlockBody</span>(</span><br><span class="line">    <span class="attr">body</span>: N.<span class="property">Statement</span>[],</span><br><span class="line">    <span class="attr">directives</span>: ?(N.<span class="property">Directive</span>[]),</span><br><span class="line">    <span class="attr">topLevel</span>: boolean,</span><br><span class="line">    <span class="attr">end</span>:<span class="title class_">TokenType</span>,</span><br><span class="line">    afterBlockParse?: <span class="function">(<span class="params">hasStrictModeDirective: boolean</span>) =&gt;</span> <span class="keyword">void</span>,</span><br><span class="line">  ): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldStrict = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">strict</span>;</span><br><span class="line">    <span class="keyword">let</span> hasStrictModeDirective = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> parsedNonDirective = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="variable language_">this</span>.<span class="title function_">match</span>(end)) &#123;</span><br><span class="line">      <span class="keyword">const</span> stmt = <span class="variable language_">this</span>.<span class="title function_">parseStatement</span>(<span class="literal">null</span>, topLevel);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (directives &amp;&amp; !parsedNonDirective) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isValidDirective</span>(stmt)) &#123;</span><br><span class="line">          <span class="keyword">const</span> directive = <span class="variable language_">this</span>.<span class="title function_">stmtToDirective</span>(stmt);</span><br><span class="line">          directives.<span class="title function_">push</span>(directive);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            !hasStrictModeDirective &amp;&amp;</span><br><span class="line">            directive.<span class="property">value</span>.<span class="property">value</span>= <span class="string">&quot;use strict&quot;</span></span><br><span class="line">          ) &#123;</span><br><span class="line">            hasStrictModeDirective = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setStrict</span>(<span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        parsedNonDirective = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// clear strict errors since the strict mode will not change within the block</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">strictErrors</span>.<span class="title function_">clear</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      body.<span class="title function_">push</span>(stmt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (afterBlockParse) &#123;</span><br><span class="line">      afterBlockParse.<span class="title function_">call</span>(<span class="variable language_">this</span>, hasStrictModeDirective);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!oldStrict) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setStrict</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>This function does not look short, but the main logic is the while loop, as long as it meets <code>!this.match(end)</code> will always parse, this end is actually tt.eof, that is, we just TokenType in a kind of, said the end of the file.</p><p>loop body The main content is two <code>const stmt = this.parseStatement(null, topLevel);</code> and <code>body.push(stmt);</code>, this stmt is a Node of AST</p><h3 id="parsestatement"><a class="markdownIt-Anchor" href="#parsestatement"></a> parseStatement</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseStatement</span>(<span class="attr">context</span>: ?string, topLevel?: boolean): N.<span class="property">Statement</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">match</span>(tt.<span class="property">at</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">parseDecorators</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">parseStatementContent</span>(context, topLevel);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>The first line is to determine whether the current is @, if so, that is the decorator, this temporarily regardless of</p><p>Let’s look at this <code>parseStatementContent</code></p><h3 id="parsestatementcontent"><a class="markdownIt-Anchor" href="#parsestatementcontent"></a> parseStatementContent</h3><p>This function is very much like <code>getTokenFromCode</code> in the Tokenizer just now. <code>getTokenFromCode</code> generates various types of tokens based on code, while <code>parseStatementContent</code> generates AST Node based on different types of tokens.</p><p>Then, during the parsing process, there are some special cases where the nextToken of the Tokenizer will be called again to continue to generate a new token, such as parsing to import</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">parseStatementContent</span>(<span class="attr">context</span>: ?string, <span class="attr">topLevel</span>: ?boolean): N.<span class="property">Statement</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> starttype = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">type</span>;</span><br><span class="line">    <span class="keyword">const</span> node = <span class="variable language_">this</span>.<span class="title function_">startNode</span>();</span><br><span class="line">    watch child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isLet</span>(context)) &#123;</span><br><span class="line">      starttype = tt.<span class="property">_var</span>;</span><br><span class="line">      kind = <span class="string">&quot;let</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Most types of statements are recognized by the keyword they</span></span><br><span class="line"><span class="string">    // start with. Many are trivial to parse, some require a bit of</span></span><br><span class="line"><span class="string">    // complexity.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    switch (starttype) &#123;</span></span><br><span class="line"><span class="string">      case tt._break:</span></span><br><span class="line"><span class="string">      case tt._continue:</span></span><br><span class="line"><span class="string">        // $FlowFixMe</span></span><br><span class="line"><span class="string">        return this.parseBreakContinueStatement(node, starttype.keyword);</span></span><br><span class="line"><span class="string">      case tt._debugger:</span></span><br><span class="line"><span class="string">        return this.parseDebuggerStatement(node);</span></span><br><span class="line"><span class="string">      case tt._do:</span></span><br><span class="line"><span class="string">        return this.parseDoStatement(node);</span></span><br><span class="line"><span class="string">      case tt._for:</span></span><br><span class="line"><span class="string">        return this.parseForStatement(node);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      // Omit the various tokenType judgments</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      default: &#123;</span></span><br><span class="line"><span class="string">        if (this.isAsyncFunction()) &#123;</span></span><br><span class="line"><span class="string">          if (context) &#123;</span></span><br><span class="line"><span class="string">            this.raise(</span></span><br><span class="line"><span class="string">              this.state.start,</span></span><br><span class="line"><span class="string">              Errors.AsyncFunctionInSingleStatementContext,</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">          this.next(); // Here again, the nextToken method of the Tokenizer is called</span></span><br><span class="line"><span class="string">          return this.parseFunctionStatement(node, true, !context);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // If the statement does not start with a statement keyword or a</span></span><br><span class="line"><span class="string">    // brace, it&#x27;s an ExpressionStatement or LabeledStatement. We</span></span><br><span class="line"><span class="string">    // simply start parsing an expression, and afterwards, if the</span></span><br><span class="line"><span class="string">    // next token is a colon and the expression was a simple</span></span><br><span class="line"><span class="string">    // Identifier node, we switch to interpreting it as a label.</span></span><br><span class="line"><span class="string">    const maybeName = this.state.value;</span></span><br><span class="line"><span class="string">    const expr = this.parseExpression();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    if (</span></span><br><span class="line"><span class="string">      start type= tt.name &amp;&amp;</span></span><br><span class="line"><span class="string">      expr.type= &quot;</span><span class="title class_">Identifier</span><span class="string">&quot; &amp;&amp;</span></span><br><span class="line"><span class="string">      this.eat(tt.colon)</span></span><br><span class="line"><span class="string">    ) &#123;</span></span><br><span class="line"><span class="string">      return this.parseLabeledStatement(node, maybeName, expr, context);</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">      return this.parseExpressionStatement(node, expr);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2021/06/28/babel-parser-introduction/" title="In-depth Babel Principle Series (II) Parser Code Structure Introduction">https://sunra.top/en/2021/06/28/babel-parser-introduction/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2021/06/22/babel-1/" rel="prev" title="In-depth Babel Principles Series (I) Introduction to Babel Workflow and Project Structure"><i class="fa fa-chevron-left"></i> In-depth Babel Principles Series (I) Introduction to Babel Workflow and Project Structure</a></div><div class="post-nav-item"> <a href="/en/2021/07/03/babel-tokenizer/" rel="next" title="In-depth Babel Principles Series (3) Tokenizer">In-depth Babel Principles Series (3) Tokenizer<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2021/06/28/babel-parser-introduction/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>