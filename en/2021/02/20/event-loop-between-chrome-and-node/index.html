<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.17.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="After using JavaScript for so long, I realized that I have always misunderstood the event loop mechanism of JavaScript. First, the event loop mechanism is not implemented in V8. The V8 engine is only"><meta property="og:type" content="article"><meta property="og:title" content="Chrome and the Node Event Loop"><meta property="og:url" content="https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="After using JavaScript for so long, I realized that I have always misunderstood the event loop mechanism of JavaScript. First, the event loop mechanism is not implemented in V8. The V8 engine is only"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/13734601-6a8e67d55c966687.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/1/11/1683d81674f076eb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/1/12/16841bd9860c1ee9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><meta property="article:published_time" content="2021-02-20T01:06:49.000Z"><meta property="article:modified_time" content="2023-07-03T02:07:12.420Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/13734601-6a8e67d55c966687.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp"><link rel="canonical" href="https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/","path":"2021/02/20/event-loop-between-chrome-and-node/","title":"Chrome and the Node Event Loop"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Chrome and the Node Event Loop | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chrome-Browser-with-Node11"><span class="nav-number">1.</span> <span class="nav-text">Chrome Browser with Node11 +</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Browser"><span class="nav-number">1.1.</span> <span class="nav-text">Browser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node11"><span class="nav-number">1.2.</span> <span class="nav-text">Node11+</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Node10-Take-Node8-as-an-example"><span class="nav-number">2.</span> <span class="nav-text">Node10- (Take Node8 as an example)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Introduction-to-Node"><span class="nav-number">2.1.</span> <span class="nav-text">1. Introduction to Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Six-stages"><span class="nav-number">2.2.</span> <span class="nav-text">2. Six stages</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1"><span class="nav-number">2.2.1.</span> <span class="nav-text">(1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2"><span class="nav-number">2.2.2.</span> <span class="nav-text">(2)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3"><span class="nav-number">2.2.3.</span> <span class="nav-text">(3)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Micro-Task"><span class="nav-number">2.3.</span> <span class="nav-text">3.Micro-Task</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-4-Pay-attention"><span class="nav-number">2.4.</span> <span class="nav-text">Step 4 Pay attention</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1"><span class="nav-number">2.4.1.</span> <span class="nav-text">(1)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">(2)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Comparison-with-browsers"><span class="nav-number">2.5.</span> <span class="nav-text">5. Comparison with browsers</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Chrome and the Node Event Loop | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Chrome and the Node Event Loop</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-02-20 09:06:49" itemprop="dateCreated datePublished" datetime="2021-02-20T09:06:49+08:00">2021-02-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2023-07-03 10:07:12" itemprop="dateModified" datetime="2023-07-03T10:07:12+08:00">2023-07-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2021/02/20/event-loop-between-chrome-and-node/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2021/02/20/event-loop-between-chrome-and-node/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>After using JavaScript for so long, I realized that I have always misunderstood the event loop mechanism of JavaScript.</p><p>First, the event loop mechanism is not implemented in V8. The V8 engine is only responsible for compiling JavaScript code, memory allocation, etc.</p><p>Second, Chrome event loop mechanism is implemented through the web API, while Node is libuv.</p><p>Third, before Node11, the principle of Node’s event loop was different from Chrome.</p><span id="more"></span><p>In response to these misunderstandings, I relearned the event loop of JavaScript.</p><p>Javascript is a single-threaded, non-blocking, asynchronous, interpreted scripting language. The concurrency model of js is based on the event loop, which is implemented by the js host environment such as the browser. v8 is the javascript runtime environment in the Chrome. There is no setTimeout/DOM/HTTP requests in the V8 source code. These asynchronous requests are handled by the webAPI in the browser, which is a thread created by the C++ implemented browser.</p><h2 id="Chrome-Browser-with-Node11"><a href="#Chrome-Browser-with-Node11" class="headerlink" title="Chrome Browser with Node11 +"></a>Chrome Browser with Node11 +</h2><h3 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h3><p>The following is a flowchart of the event loop mechanism in the browser. As long as there is no code executing in the execution stack, the microtask will be executed immediately after the callback.</p><p><img src="https://upload-images.jianshu.io/upload_images/13734601-6a8e67d55c966687.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp" alt></p><h3 id="Node11"><a href="#Node11" class="headerlink" title="Node11+"></a>Node11+</h3><p>You can read this on my other blog: <a href="https://sunra.top/posts/5f68736a/">https://sunra.top/posts/5f68736a/</a></p><h2 id="Node10-Take-Node8-as-an-example"><a href="#Node10-Take-Node8-as-an-example" class="headerlink" title="Node10- (Take Node8 as an example)"></a>Node10- (Take Node8 as an example)</h2><h3 id="1-Introduction-to-Node"><a href="#1-Introduction-to-Node" class="headerlink" title="1. Introduction to Node"></a>1. Introduction to Node</h3><p>The Event Loop in Node is completely different from that in the browser. Node.js uses V8 as the parsing engine of js, and uses its own libuv for I/O processing. Libuv is an event-driven cross-platform abstraction layer that encapsulates some underlying features of different operating systems and provides a unified API to the outside world. The event loop mechanism is also implemented in it (described in detail below).</p><p><img src="https://user-gold-cdn.xitu.io/2019/1/11/1683d81674f076eb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p><p>The operating mechanism of Node.js is as follows:</p><ul><li>V8 engine parses JavaScript scripts.</li><li>After parsing the code, call the Node API.</li><li>The libuv library is responsible for the execution of the Node API. It assigns different tasks to different threads, forming an Event Loop that asynchronously returns the execution results of the tasks to the V8 engine.</li><li>The V8 engine then returns the results to the user.</li></ul><h3 id="2-Six-stages"><a href="#2-Six-stages" class="headerlink" title="2. Six stages"></a>2. Six stages</h3><p>The event loop in the libuv engine is divided into 6 stages, which will be run repeatedly in order. Whenever you enter a certain stage, the function will be removed from the corresponding callback queue to execute. When the queue is empty or the number of callback functions executed reaches the threshold set by the system, it will enter the next stage.</p><p><img src="https://user-gold-cdn.xitu.io/2019/1/12/16841bd9860c1ee9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p><p>In the above figure, you can roughly see the order of the event loop in node.</p><p>External input data — &gt; polling phase (poll) — &gt; check phase (check) — &gt; close callback phase (close callback) — &gt; timer detection phase (timer) — &gt; I/O event callback phase (I/O callbacks) — &gt; idle phase (idle, prepare) — &gt; polling phase (run repeatedly in this order)…</p><ul><li>timers phase: This phase executes callbacks for timers (setTimeout, setInterval)</li><li>I/O callbacks phase: handles a few unexecuted I/O callbacks from some previous loop</li><li>idle, prepare phase: only used internally by nodes</li><li>poll phase: fetch new I/O events, where node will block under appropriate conditions</li><li>check phase: Callback for executing setImmediate ()</li><li>close callbacks stage: perform the close event callback of the socket</li></ul><p>Note: <strong>None of the above six stages include process.nextTick ()</strong> (described below)</p><p>Next, we will introduce the three stages of’timers’, ‘poll’, and’check ‘in detail, because most of the Asynchronous Tasks in daily development are processed in these three stages.</p><h4 id="1"><a href="#1" class="headerlink" title="(1)"></a>(1)</h4><p>The timers phase executes setTimeout and setInterval callbacks and is controlled by the poll phase. Similarly, the time specified by the timer in Node is not an exact time and can only be executed as soon as possible.</p><h4 id="2"><a href="#2" class="headerlink" title="(2)"></a>(2)</h4><p>Polling is a crucial phase, and in this phase, the system does two things</p><ol><li><p>Go back to the timer phase and execute the callback</p></li><li><p>Perform I/O callbacks</p></li></ol><p>And if the timer is not set when entering this stage, the following two things will happen</p><ul><li>If the poll queue is not empty, the callback queue is traversed and executed synchronously until the queue is empty or the system limit is reached<br>If the poll queue is empty, two things happen<ul><li>If there is a setImmediate callback that needs to be executed, the poll phase will stop and enter the check phase to execute the callback</li><li>If there is no setImmediate callback to execute, it will wait for the callback to be added to the queue and execute the callback immediately. There will also be a timeout setting to prevent waiting forever</li></ul></li></ul><p>Of course, if the timer is set and the poll queue is empty, it will determine whether there is a timer timeout, and if so, it will return to the timer stage to perform the callback.</p><h4 id="3"><a href="#3" class="headerlink" title="(3)"></a>(3)</h4><p>The callback of setImmediate () will be added to the check queue. As you can see from the phase diagram of the event loop, the execution order of the check phase is after the poll phase. Let’s take a look at an example first:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer1&#x27;</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise1&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer2&#x27;</span>)</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise2&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise3&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"><span class="comment">//start=&gt;end=&gt;promise3=&gt;timer1=&gt;timer2=&gt;promise1=&gt;promise2</span></span><br><span class="line"><span class="title class_">Copy</span> the code</span><br></pre></td></tr></table></figure><ul><li>After the synchronization task (which belongs to the macro task) that starts the stack is executed (print start end in turn, and put 2 timers in the timer queue in turn), the microtask will be executed first (** This is the same as the browser side), so print promise3</li><li>Then enter the timers stage, execute the callback function of timer1, print timer1, and put the promise.then callback into the microtask queue, execute timer2 in the same step, print timer2; this is quite different from the browser side, ** timers stage There are several setTimeout/setInterval will be executed in turn, unlike the browser side, which executes a microtask after each macro task (the difference between Node and the browser’s Event Loop will be described in detail below).</li></ul><h3 id="3-Micro-Task"><a href="#3-Micro-Task" class="headerlink" title="3.Micro-Task"></a>3.Micro-Task</h3><p>The asynchronous queues in the Node side event loop are also of these two types: macro (macro task) queues and micro (micro task) queues.</p><ul><li>Common macro-tasks such as: setTimeout, setInterval, setImmediate, script (overall code), I/O operations, etc.</li><li>Common micro-tasks such as: process.nextTick, new Promise ().then (callback), etc.</li></ul><h3 id="Step-4-Pay-attention"><a href="#Step-4-Pay-attention" class="headerlink" title="Step 4 Pay attention"></a>Step 4 Pay attention</h3><h4 id="1-1"><a href="#1-1" class="headerlink" title="(1)"></a>(1)</h4><p>The two are very similar, the difference is mainly in the timing of the call.</p><ul><li>setImmediate design is executed when the poll stage is completed, that is, the check stage;</li><li>setTimeout is designed to be executed when the poll phase is idle and the set time is reached, but it is executed in the timer phase</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timeout</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">&#125;,<span class="number">0</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span> <span class="title function_">immediate</span> () &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Copy</span> the code</span><br></pre></td></tr></table></figure><ul><li>For the above code, setTimeout may be executed before or after.</li><li>first setTimeout (fn, 0) = setTimeout(fn, 1)，这是由源码决定的 进入事件循环也是需要成本的，如果在准备时候花费了大于 1ms 的时间，那么在 timer 阶段就会直接执行 setTimeout 回调</li><li>If the preparation time is less than 1ms, then the setImmediate callback is executed first</li></ul><p>However, when both are called inside the asynchronous i/o callback, setImmediate is always executed first, followed by setTimeout.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">fs.<span class="title function_">readFile</span>(__filename, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">0</span>)</span><br><span class="line">    <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// immediate</span></span><br><span class="line"><span class="comment">// timeout</span></span><br><span class="line"><span class="title class_">Copy</span> the code</span><br></pre></td></tr></table></figure><p>In the above code, setImmediate is always executed first. Because the two codes are written in the IO callback, the IO callback is executed in the poll stage. When the callback is executed, the queue is empty, and it is found that there is a setImmediate callback, so it jumps directly to the check stage to execute the callback.</p><h4 id="2-1"><a href="#2-1" class="headerlink" title="(2)"></a>(2)</h4><p>This function is actually independent of the Event Loop. It has its own queue. When each stage is completed, if there is a nextTick queue, all callback functions in the queue will be cleared and executed before other microtasks.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer1&#x27;</span>)</span><br><span class="line"> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise1&#x27;</span>)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line"> process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">   process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">     process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// nextTick=&gt;nextTick=&gt;nextTick=&gt;nextTick=&gt;timer1=&gt;promise1</span></span><br></pre></td></tr></table></figure><h3 id="5-Comparison-with-browsers"><a href="#5-Comparison-with-browsers" class="headerlink" title="5. Comparison with browsers"></a>5. Comparison with browsers</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer1&#x27;</span>)</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise1&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timer2&#x27;</span>)</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise2&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Browser side running result: ‘timer1 = &gt; promise1 = &gt; timer2 = &gt; promise2’</p><p>The running results on the Node side are divided into two cases:</p><ul><li>If the node11 version executes a macro task (setTimeout, setInterval and setImmediate) in a phase, it immediately executes the microtask queue, which is consistent with the browser run, and the final result is’ timer1 = &gt; promise1 = &gt; timer2 = &gt; promise2 ‘</li><li>If it is node10 and previous versions: depends on whether the first timer has finished executing and whether the second timer is in the completion queue.<ul><li>If the second timer is not yet in the completion queue, the final result is’ timer1 = &gt; promise1 = &gt; timer2 = &gt; promise2 ‘</li><li>If the second timer is already in the completion queue, the final result is’ timer1 = &gt; timer2 = &gt; promise1 = &gt; promise2 ‘ (the following procedure is explained based on this case)</li></ul></li></ul><p>Reference link:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.jianshu.com/p/054cb77adadd">https://www.jianshu.com/p/054cb77adadd</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://juejin.cn/post/6844903761949753352">https://juejin.cn/post/6844903761949753352</a></p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#what-is-the-event-loop">https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#what-is-the-event-loop</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/" title="Chrome and the Node Event Loop">https://sunra.top/en/2021/02/20/event-loop-between-chrome-and-node/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2021/02/16/javascript-inherit/" rel="prev" title="JavaScript Inheritance"><i class="fa fa-chevron-left"></i> JavaScript Inheritance</a></div><div class="post-nav-item"> <a href="/en/2021/02/27/leetcode-1178/" rel="next" title="Leetcode Puzzle">Leetcode Puzzle<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/en/js/third-party/math/mathjax.js"></script><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2021/02/20/event-loop-between-chrome-and-node/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>