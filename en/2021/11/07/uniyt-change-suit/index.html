<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/en/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/en/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/en/images/favicon-16x16-next.png"><link rel="mask-icon" href="/en/images/logo.svg" color="#222"><meta name="google-site-verification" content="7yRqtT6cCpC-_R-rzM9gUoQGmheV9OZAUKIXrbAsyqE"><link rel="stylesheet" href="/en/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"sunra.top","root":"/en/","images":"/en/images","scheme":"Muse","darkmode":false,"version":"8.16.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/en/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/en/js/config.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8623125811074939" crossorigin="anonymous"></script><script>!function(e,p,s,r){if(void 0===e.webpushr){e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var d,t=p.getElementsByTagName(s)[0];(d=p.createElement(s)).id="webpushr-jssdk",d.async=1,d.src="https://cdn.webpushr.com/app.min.js",t.parentNode.appendChild(d)}}(window,document,"script"),webpushr("setup",{key:"BEQjc-0d1Q1CubrYZ2e2XXv5Is0ZCd3CtrNLet06owkUWK68qkxHpho2mKdnj2vpGdxddRDxRYthLuMwrTqfSB4"})</script><meta name="description" content="Recently, I have developed a certain interest in the way and principle of Unity’s dressing, so I went to the Internet to search for some docs and realized a simple version of the dressing system. Here"><meta property="og:type" content="article"><meta property="og:title" content="Unity Character Dress Up Implementation"><meta property="og:url" content="https://sunra.top/en/2021/11/07/uniyt-change-suit/index.html"><meta property="og:site_name" content="Origin of Ray"><meta property="og:description" content="Recently, I have developed a certain interest in the way and principle of Unity’s dressing, so I went to the Internet to search for some docs and realized a simple version of the dressing system. Here"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2021-11-07T09:52:32.000Z"><meta property="article:modified_time" content="2024-06-20T08:56:35.598Z"><meta property="article:author" content="Ray Sun"><meta property="article:tag" content="Technology Sharing Using Tutorials Principles Front End Computer Graphics"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://sunra.top/en/2021/11/07/uniyt-change-suit/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://sunra.top/en/2021/11/07/uniyt-change-suit/","path":"2021/11/07/uniyt-change-suit/","title":"Unity Character Dress Up Implementation"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Unity Character Dress Up Implementation | Origin of Ray</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-KEJ1L66CKC"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KEJ1L66CKC","only_pageview":false}</script><script src="/en/js/third-party/analytics/google-analytics.js"></script><script src="/en/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?cc2e15dfd66849cf1d7843d0d532438e"></script><link rel="dns-prefetch" href="https://blog-comments-3w44.vercel.app/"><noscript><link rel="stylesheet" href="/en/css/noscript.css"></noscript><link rel="alternate" href="/en/atom.xml" title="Origin of Ray" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/en/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">Origin of Ray</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Lift the fog of the Internet together</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/en/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/en/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/en/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-english"><a href="https://sunra.top/en" rel="section"><i class="fa fa-language fa-fw"></i>English</a></li><li class="menu-item menu-item-中文"><a href="https://sunra.top/" rel="section"><i class="fa fa-language fa-fw"></i>中文</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#skeleton-skin-and-animation"><span class="nav-number">1.</span> <span class="nav-text">Skeleton, Skin and Animation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-bone"><span class="nav-number">1.1.</span> <span class="nav-text">What is bone?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-skin"><span class="nav-number">1.2.</span> <span class="nav-text">What is skin?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-needed-in-skins"><span class="nav-number">1.3.</span> <span class="nav-text">Data needed in skins</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#two-ways-to-dress-up"><span class="nav-number">2.</span> <span class="nav-text">Two ways to dress up</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-replace-skinnedmeshrender"><span class="nav-number">2.1.</span> <span class="nav-text">How to replace SkinnedMeshRender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-nodes-are-mounted"><span class="nav-number">2.2.</span> <span class="nav-text">How nodes are mounted</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#specific-implementation-examples"><span class="nav-number">3.</span> <span class="nav-text">Specific implementation examples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#code-process-analysis"><span class="nav-number">3.1.</span> <span class="nav-text">Code process analysis</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Ray Sun" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><p class="site-author-name" itemprop="name">Ray Sun</p><div class="site-description" itemprop="description">Lift the fog of the Internet together</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/en/archives/"><span class="site-state-item-count">268</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/en/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">categories</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/Sun668" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Sun668" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:947692259@qq.com" title="E-Mail → mailto:947692259@qq.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span></div><div class="cc-license animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="external nofollow noopener noreferrer" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div></div></div></div><div class="wechat_channel" style="width:50%;margin-left:25%;margin-bottom:5px"><br> <img src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="wechat_channel" style="width:50%;margin-left:25%"><br> <span>一站式程序员工具平台</span> <img src="https://origin-of-ray.oss-cn-shenzhen.aliyuncs.com/rannie_share.png"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://sunra.top/en/2021/11/07/uniyt-change-suit/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1592617514/avatar_rpap6c.jpg"><meta itemprop="name" content="Ray Sun"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Origin of Ray"><meta itemprop="description" content="Lift the fog of the Internet together"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Unity Character Dress Up Implementation | Origin of Ray"><meta itemprop="description" content></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> Unity Character Dress Up Implementation</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-11-07 17:52:32" itemprop="dateCreated datePublished" datetime="2021-11-07T17:52:32+08:00">2021-11-07</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">Edited on</span> <time title="Modified: 2024-06-20 16:56:35" itemprop="dateModified" datetime="2024-06-20T16:56:35+08:00">2024-06-20</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/en/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline:</span><a title="waline" href="/en/2021/11/07/uniyt-change-suit/#waline" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" data-path="/en/2021/11/07/uniyt-change-suit/" itemprop="commentCount"></span></a></span></div></div></header><div class="post-body" itemprop="articleBody"><p>Recently, I have developed a certain interest in the way and principle of Unity’s dressing, so I went to the Internet to search for some docs and realized a simple version of the dressing system. Here is a brief summary.</p><span id="more"></span><p>There are a few concepts we need to understand before we can formally understand how to do a makeover.</p><h2 id="skeleton-skin-and-animation"><a class="markdownIt-Anchor" href="#skeleton-skin-and-animation"></a> Skeleton, Skin and Animation</h2><p>There are two commonly used animations in game development: vertex animation and skin animation</p><ol><li><p>Vertex animation<br> It is realized by directly modifying the position of the mesh vertices in the animation frame. It is usually used when the number of mesh vertices is small and the animation is simple, such as the swing of grass, the swing of trees, the fluctuation of water, etc</p></li><li><p>Skin animation<br> By directly modifying the position of the bone in the animation, the vertex of the mesh changes with the change of the bone, which is usually used for humanoid animation, such as the running and jumping of characters</p></li></ol><h3 id="what-is-bone"><a class="markdownIt-Anchor" href="#what-is-bone"></a> What is bone?</h3><p>When we pour in the Model with bones, we can find a nested GameObject in it. This GamoeObject and all its child GameObjects have only one property, which is the coordinate information of the transforms, which make up the skeleton information of the model.</p><h3 id="what-is-skin"><a class="markdownIt-Anchor" href="#what-is-skin"></a> What is skin?</h3><p>We know that the mesh is composed of vertices and faces. If the skin data is not bound, it is called a static mesh, which does not have animation effects, such as houses, floors, bridges, roads, etc. in the game;</p><p>For the mesh of binding skin, we call it SkinMesh. In SkinMesh, the vertex of each mesh will be affected by several bones and matched with a certain weight ratio;</p><p>Just like our real people, the first support and determine the position and movement is a group of bones, head + body + limbs, and the muscles on the body are affected by the bones to produce movement, and the movement of each muscle may be affected by multiple The influence of bones;</p><h3 id="data-needed-in-skins"><a class="markdownIt-Anchor" href="#data-needed-in-skins"></a> Data needed in skins</h3><p>In unity, the calculation of skin animation is mainly realized through the SkinnedMeshRenderer component</p><p>Data required to calculate skinning animation:</p><p>SkinnedMeshRenderer.bones: a list of all references to bone, note that the order is determined, the index of bone in the BoneWeight of subsequent vertices is based on the index of this array order<br> SkinnedMeshRenderer.sharedMesh: Mesh data required for rendering, note that compared to the vertex and surface data required by ordinary MeshRender, there will be some additional computational skinning related data<br> Mesh.boneWeights: The index and weight of which bones are affected by each vertex (each vertex is affected by up to four bones, see the definition of structure BoneWeight for details)<br> Mesh.bindposes: The transformation matrix of each bone from mesh space to its own bone space, that is, the Inverse Matrix of the transformation matrix from bone space to mesh space of the predefined bone. Note that the transformation made by the vertex affected by bone is based on Transformation done in bone space</p><p>According to the Unity doc, the algorithm of BindPose in Unity is as follows:</p><p>OneBoneBindPose = bone.worldToLocalMatrix * transform.localToWorldMatrix;<br> The world-to-local coordinate system matrix of the skeleton multiplied by the local-to-world matrix of the mesh</p><p>Note: Art is generally in the binding skin, the bones will be put into a Tpose style, this time the bone transform into a matrix that is bindpose, all bone animation is relatively transformed on this basis, and eventually as the mesh itself The static data is saved.</p><blockquote><p>SkinnedMeshRenderer is a different mesh<br> This information comes with the import of the model, and the modeling tool will determine how each point is affected by the information of each bone, that is, how the corresponding mesh changes when the position of a certain point in the bone changes.</p></blockquote><h2 id="two-ways-to-dress-up"><a class="markdownIt-Anchor" href="#two-ways-to-dress-up"></a> Two ways to dress up</h2><h3 id="how-to-replace-skinnedmeshrender"><a class="markdownIt-Anchor" href="#how-to-replace-skinnedmeshrender"></a> How to replace SkinnedMeshRender</h3><p>Mainly suitable for clothes, pants, hairstyles, etc</p><p>Replacement steps:</p><p>1: Generally, according to whether a separate part can be changed, a single part or a whole set of models can be made into a Prefab.</p><p>Load prefab and instantiate it as a GameObject</p><p>3: Find the original SkinnedMeshRender corresponding to the newly instantiated SkinnedMeshRender.</p><p>4: Replace bones</p><p>5: Replace the mesh</p><p>6: Replacement of materials</p><p>7: Replace completed, destroy the newly instantiated Prefab</p><h3 id="how-nodes-are-mounted"><a class="markdownIt-Anchor" href="#how-nodes-are-mounted"></a> How nodes are mounted</h3><p>Mainly suitable for weapons, wings, tails, etc</p><p>Replacement steps:</p><p>1: Generally, a single set of models is made into a Prefab</p><p>Load prefab and instantiate it as a GameObject</p><p>3: Find hangpoints (for example, weapons are usually mounted on the skeleton node of the hand)</p><p>4: Destroy the original equipment</p><p>5: Set the parent node of the instantiated GameObject as a hang point</p><p>6: Set the offset, scaling, rotation of the GameObject (usually 0)</p><h2 id="specific-implementation-examples"><a class="markdownIt-Anchor" href="#specific-implementation-examples"></a> Specific implementation examples</h2><p>The first is a simple way to take out the SkinnedMeshRenderer of all clothes and add them all to the bone root node</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SkinnedMeshRenderer <span class="title">CombineSuitsToSkeleton</span>(<span class="params">GameObject skeleton, SkinnedMeshRenderer[] meshes</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> transforms = <span class="keyword">new</span> List&lt;Transform&gt;(skeleton.GetComponentsInChildren&lt;Transform&gt;(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> materials = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> combineInstances = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bones = <span class="keyword">new</span> List&lt;Transform&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (SkinnedMeshRenderer smr <span class="keyword">in</span> meshes)</span><br><span class="line">    &#123;</span><br><span class="line">        materials.AddRange(smr.materials);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> sub = <span class="number">0</span>; sub &lt; smr.sharedMesh.subMeshCount; sub++)</span><br><span class="line">        &#123;</span><br><span class="line">            CombineInstance ci = <span class="keyword">new</span> CombineInstance();</span><br><span class="line">            ci.mesh = smr.sharedMesh;</span><br><span class="line">            ci.subMeshIndex = sub;</span><br><span class="line">            combineInstances.Add(ci);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (Transform b <span class="keyword">in</span> smr.bones)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> t = transforms.Find(t =&gt; b.name.Equals(t.name));</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                bones.Add(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r = skeleton.AddComponent&lt;SkinnedMeshRenderer&gt;() ?? skeleton.GetComponent&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">    r.bones = bones.ToArray();</span><br><span class="line">    r.sharedMesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">    r.sharedMesh.CombineMeshes(combineInstances.ToArray(), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    r.materials = materials.ToArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the above way, we will add multiple Materials to the root node of the bone, so that the performance is not optimal, we can optimize it, merge all the materials of the clothes, and then add them to the bone as a whole.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SkinnedMeshRenderer <span class="title">CombineSuitsToSkeleton</span>(<span class="params">GameObject skeleton, SkinnedMeshRenderer[] meshes</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> transforms = <span class="keyword">new</span> List&lt;Transform&gt;(skeleton.GetComponentsInChildren&lt;Transform&gt;(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> materials = <span class="keyword">new</span> List&lt;Material&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> combineInstances = <span class="keyword">new</span> List&lt;CombineInstance&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bones = <span class="keyword">new</span> List&lt;Transform&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (SkinnedMeshRenderer smr <span class="keyword">in</span> meshes)</span><br><span class="line">    &#123;</span><br><span class="line">        materials.AddRange(smr.materials);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> sub = <span class="number">0</span>; sub &lt; smr.sharedMesh.subMeshCount; sub++)</span><br><span class="line">        &#123;</span><br><span class="line">            CombineInstance ci = <span class="keyword">new</span> CombineInstance();</span><br><span class="line">            ci.mesh = smr.sharedMesh;</span><br><span class="line">            ci.subMeshIndex = sub;</span><br><span class="line">            combineInstances.Add(ci);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">foreach</span> (Transform b <span class="keyword">in</span> smr.bones)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> t = transforms.Find(t =&gt; b.name.Equals(t.name));</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                bones.Add(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newMaterial = <span class="keyword">new</span> Material(Shader.Find(<span class="string">&quot;Standard&quot;</span>));</span><br><span class="line">    <span class="keyword">var</span> oldUV = <span class="keyword">new</span> List&lt;Vector2[]&gt;();</span><br><span class="line">    <span class="comment">// merge the texture</span></span><br><span class="line">    <span class="keyword">var</span> Textures = <span class="keyword">new</span> List&lt;Texture2D&gt;();</span><br><span class="line">    <span class="keyword">foreach</span> (Material m <span class="keyword">in</span> materials)</span><br><span class="line">    &#123;</span><br><span class="line">        Textures.Add(m.GetTexture(<span class="string">&quot;_MainTex&quot;</span>) <span class="keyword">as</span> Texture2D);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Texture2D newDiffuseTex = <span class="keyword">new</span> Texture2D(<span class="number">1024</span>, <span class="number">1024</span>, TextureFormat.RGBA32, <span class="literal">true</span>);</span><br><span class="line">    Rect[] uvs = newDiffuseTex.PackTextures(Textures.ToArray(), <span class="number">0</span>);</span><br><span class="line">    newMaterial.mainTexture = newDiffuseTex;</span><br><span class="line">    newMaterial.EnableKeyword(<span class="string">&quot;_SPECULARHIGHLIGHTS_OFF&quot;</span>);</span><br><span class="line">    newMaterial.SetFloat(<span class="string">&quot;_SpecularHighlights&quot;</span>, <span class="number">0f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reset uv</span></span><br><span class="line">    Vector2[] uva, uvb;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; combineInstances.Count; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        uva = (Vector2[])(combineInstances[j].mesh.uv);</span><br><span class="line">        uvb = <span class="keyword">new</span> Vector2[uva.Length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; uva.Length; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            uvb[k] = <span class="keyword">new</span> Vector2((uva[k].x * uvs[j].width) + uvs[j].x, (uva[k].y * uvs[j].height) + uvs[j].y);</span><br><span class="line">        &#125;</span><br><span class="line">        oldUV.Add(combineInstances[j].mesh.uv);</span><br><span class="line">        combineInstances[j].mesh.uv = uvb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r = skeleton.AddComponent&lt;SkinnedMeshRenderer&gt;() ?? skeleton.GetComponent&lt;SkinnedMeshRenderer&gt;();</span><br><span class="line">    r.bones = bones.ToArray();</span><br><span class="line">    r.sharedMesh = <span class="keyword">new</span> Mesh();</span><br><span class="line">    r.sharedMesh.CombineMeshes(combineInstances.ToArray(), <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    r.material = newMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="code-process-analysis"><a class="markdownIt-Anchor" href="#code-process-analysis"></a> Code process analysis</h3><ul><li>first get all the bones information (bones are actually an array of transforms): var transforms = new List &lt; Transform &gt; (skeleton. GetComponentsInChildren &lt; Transform &gt; (true));<br> Declare a new array of materials: var materials = new List &lt; Material &gt; ();</li><li>声明一个CombineInstance（Struct used to describe meshes to be combined using Mesh.CombineMeshes）的数组：var combineInstances = new List<combineinstance>();<br> Declare an array of all bones: var bones = new List &lt; Transform &gt; ();</combineinstance></li><li>Then there is a loop to the meshs array, the role is to save the material of each mesh into the materials array, then save the information of each mesh into the combineInstances array, and finally obtain the same name as the mesh’s bone information from the bone information of the body according to the name Save the bones with the same name.</li><li>In this loop, the material information of the clothes is saved in combineInstances, and the bone information is saved in bones.</li><li>Get the SkinnedMeshRenderer of the character body, bind its bone information to all bones, and its mesh to a new mesh</li><li>Create a new material with its shader as the default standard shader</li><li>Save old UV information: var oldUV = new List &lt; Vector2 [] &gt; ();</li><li>Save old sticker information:</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Textures = <span class="keyword">new</span> List&lt;Texture2D&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (Material m <span class="keyword">in</span> materials)</span><br><span class="line">&#123;</span><br><span class="line">    Textures.Add(m.GetTexture(<span class="string">&quot;_MainTex&quot;</span>) <span class="keyword">as</span> Texture2D);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Create new texture: Texture2D newDiffuseTex = new Texture2D (1024, 1024, TextureFormat. RGBA32, true);</li><li>Generate UV information for the new texture based on the old texture array: Rect [] uvs = newDiffuseTex. PackTextures (Textures. ToArray (), 0);</li><li>Set the texture of the new material as the new texture.</li><li>Recalculate the UV information of the new texture after merging the clothes map based on the new UV information just generated.</li></ul><p>Reference article:</p><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/87583171">https://zhuanlan.zhihu.com/p/87583171</a><br> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://zhuanlan.zhihu.com/p/94134459">https://zhuanlan.zhihu.com/p/94134459</a><br> <a target="_blank" rel="external nofollow noopener noreferrer" href="https://gameinstitute.qq.com/community/detail/126729">https://gameinstitute.qq.com/community/detail/126729</a></p></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"> <strong>Post author:</strong> Ray Sun</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://sunra.top/en/2021/11/07/uniyt-change-suit/" title="Unity Character Dress Up Implementation">https://sunra.top/en/2021/11/07/uniyt-change-suit/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="followme"> <span>Welcome to my other publishing channels</span><div class="social-list"><div class="social-item"><span class="social-link"><span class="icon"><i class="fab fa-weixin"></i></span> <span class="label">WeChat</span></span> <img class="social-item-img" src="https://res.cloudinary.com/dvtfhjxi4/image/upload/v1685836114/origin-of-ray/wechat_channel_zmg0hw.jpg"></div><div class="social-item"><a target="_blank" class="social-link" href="/en/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/en/2021/10/21/unity-addressable/" rel="prev" title="Unity Addressable Plugin"><i class="fa fa-chevron-left"></i> Unity Addressable Plugin</a></div><div class="post-nav-item"> <a href="/en/2021/11/12/unity-addressable-preload/" rel="next" title="Unity Addressable Preload Scheme">Unity Addressable Preload Scheme<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Ray Sun</span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="external nofollow noopener noreferrer" target="_blank">NexT.Muse</a></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/en/js/comments.js"></script><script src="/en/js/utils.js"></script><script src="/en/js/motion.js"></script><script src="/en/js/schemes/muse.js"></script><script src="/en/js/next-boot.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/en/js/third-party/search/local-search.js"></script><script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" integrity="sha256-hLTCMFlKxdNgPXyWlSSxYN0ykJmxxq9Yt3MNfdRGWeA=" crossorigin="anonymous"><script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://blog-comments-3w44.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"欢迎大家交流学习","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/en/2021/11/07/uniyt-change-suit/"}</script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"><script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script></body></html>